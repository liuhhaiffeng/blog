<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\bin\pg_basebackup\receivelog.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\bin\pg_basebackup\receivelog.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:59 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
</span><span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * receivelog.c - receive WAL files using the streaming 
 *                replication protocol. 
 * 
 * Author: Magnus Hagander &LT;magnus@hagander.net&GT; 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * 
 * IDENTIFICATION 
 *        src/bin/pg_basebackup/receivelog.c 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres_fe.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/stat.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
<span class='Directive'>#ifdef</span> HAVE_SYS_SELECT_H 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/select.h&GT;</span> 
<span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* local includes */ 
</span><span class='Keyword'>#include </span><span class='String'>"receivelog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"streamutil.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"libpq-fe.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xlog_internal.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"common/file_utils.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* fd and filename for currently open WAL file */ 
</span><a name="LN32"></a><span class='Keyword'>static </span><a href="walmethods.h.html#LN12"><span class='Ref_to_Typedef'>Walfile</span></a> <span class='Operator'>*</span><span class='Declare_Var'>walfile</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN33"></a><span class='Keyword'>static char </span><span class='Declare_Var'>current_walfile_name</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>""</span><span class='Delimiter'>; 
</span><a name="LN34"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>reportFlushPosition</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN35"></a><span class='Keyword'>static </span><a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Var'>lastFlushPosition</span> <span class='Operator'>= </span><a href="../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>; 
</span> 
<a name="LN37"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>still_sending</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* feedback still needs to be sent? */ 
</span> 
<a name="LN39"></a><span class='Keyword'>static </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>HandleCopyStream</span><span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><a href="receivelog.h.html#LN29"><span class='Ref_to_Struct'>StreamCtl</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stream</span><span class='Delimiter'>, 
</span><a name="LN40"></a>                 <a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stoppos</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN41"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>CopyStreamPoll</span><span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Keyword'>long </span><span class='Declare_Parameter'>timeout_ms</span><span class='Delimiter'>, </span><a href="../../include/port.h.html#LN25"><span class='Ref_to_Typedef'>pgsocket</span></a> <span class='Declare_Parameter'>stop_socket</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN42"></a><span class='Keyword'>static int </span><span class='Declare_Prototype'>CopyStreamReceive</span><span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Keyword'>long </span><span class='Declare_Parameter'>timeout</span><span class='Delimiter'>, </span><a href="../../include/port.h.html#LN25"><span class='Ref_to_Typedef'>pgsocket</span></a> <span class='Declare_Parameter'>stop_socket</span><span class='Delimiter'>, 
</span><a name="LN43"></a>                  <span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>buffer</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN44"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>ProcessKeepaliveMsg</span><span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><a href="receivelog.h.html#LN29"><span class='Ref_to_Struct'>StreamCtl</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stream</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>copybuf</span><span class='Delimiter'>, 
</span><a name="LN45"></a>                    <span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Delimiter'>, </span><a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>blockpos</span><span class='Delimiter'>, </span><a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>last_status</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN46"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>ProcessXLogDataMsg</span><span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><a href="receivelog.h.html#LN29"><span class='Ref_to_Struct'>StreamCtl</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stream</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>copybuf</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Delimiter'>, 
</span><a name="LN47"></a>                   <a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>blockpos</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN48"></a><span class='Keyword'>static </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>HandleEndOfCopyStream</span><span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><a href="receivelog.h.html#LN29"><span class='Ref_to_Struct'>StreamCtl</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stream</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>copybuf</span><span class='Delimiter'>, 
</span><a name="LN49"></a>                      <a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>blockpos</span><span class='Delimiter'>, </span><a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stoppos</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN50"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>CheckCopyStreamStop</span><span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><a href="receivelog.h.html#LN29"><span class='Ref_to_Struct'>StreamCtl</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stream</span><span class='Delimiter'>, </span><a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>blockpos</span><span class='Delimiter'>, 
</span><a name="LN51"></a>                    <a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stoppos</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN52"></a><span class='Keyword'>static long </span><span class='Declare_Prototype'>CalculateCopyStreamSleeptime</span><span class='Parentheses'>(</span><a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Parameter'>now</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>standby_message_timeout</span><span class='Delimiter'>, 
</span><a name="LN53"></a>                             <a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Parameter'>last_status</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN55"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>ReadEndOfStreamingResult</span><span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>res</span><span class='Delimiter'>, </span><a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>startpos</span><span class='Delimiter'>, 
</span><a name="LN56"></a>                         <a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>timeline</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Keyword'>static bool 
</span><a name="LN59"></a><span class='Declare_Function'>mark_file_as_archived</span><span class='Parentheses'>(</span><a href="receivelog.h.html#LN29"><span class='Ref_to_Struct'>StreamCtl</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stream</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>fname</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN61"></a>    <a href="walmethods.h.html#LN12"><span class='Ref_to_Typedef'>Walfile</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>f</span><span class='Delimiter'>; 
</span><a name="LN62"></a>    <span class='Keyword'>static char </span><span class='Declare_Local'>tmppath</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span> 
    <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN62"><span class='Ref_To_Local'>tmppath</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="receivelog.c.html#LN62"><span class='Ref_To_Local'>tmppath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"archive_status/%s.done"</span><span class='Delimiter'>, 
</span>             <a href="receivelog.c.html#LN59"><span class='Ref_to_Parameter'>fname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="receivelog.c.html#LN61"><span class='Ref_To_Local'>f</span></a> <span class='Operator'>= </span><a href="receivelog.c.html#LN59"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN40"><span class='Ref_to_Member'>open_for_write</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN62"><span class='Ref_To_Local'>tmppath</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN61"><span class='Ref_To_Local'>f</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not create archive status file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN62"><span class='Ref_To_Local'>tmppath</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN59"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span>getlasterror<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="receivelog.c.html#LN59"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN46"><span class='Ref_to_Member'>close</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN61"><span class='Ref_To_Local'>f</span></a><span class='Delimiter'>, </span><a href="walmethods.h.html#LN16"><span class='Ref_to_EnumConst'>CLOSE_NORMAL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end mark_file_as_archived &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Open a new WAL file in the specified directory. 
 * 
 * Returns true if OK; on failure, returns false after printing an error msg. 
 * On success, 'walfile' is set to the FD for the file, and the base filename 
 * (without partial_suffix) is stored in 'current_walfile_name'. 
 * 
 * The file will be padded to 16Mb with zeroes. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN90"></a><span class='Declare_Function'>open_walfile</span><span class='Parentheses'>(</span><a href="receivelog.h.html#LN29"><span class='Ref_to_Struct'>StreamCtl</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stream</span><span class='Delimiter'>, </span><a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>startpoint</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN92"></a>    <a href="walmethods.h.html#LN12"><span class='Ref_to_Typedef'>Walfile</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>f</span><span class='Delimiter'>; 
</span><a name="LN93"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>fn</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN94"></a>    <a href="../../include/port/win32.h.html#LN419"><span class='Ref_to_Typedef'>ssize_t</span></a>     <span class='Declare_Local'>size</span><span class='Delimiter'>; 
</span><a name="LN95"></a>    <a href="../../include/access/xlogdefs.h.html#LN33"><span class='Ref_to_Typedef'>XLogSegNo</span></a>   <span class='Declare_Local'>segno</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/xlog_internal.h.html#LN105"><span class='Ref_to_Macro'>XLByteToSeg</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN90"><span class='Ref_to_Parameter'>startpoint</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN95"><span class='Ref_To_Local'>segno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/xlog_internal.h.html#LN142"><span class='Ref_to_Macro'>XLogFileName</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN33"><span class='Ref_to_Global_Var'>current_walfile_name</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN90"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN32"><span class='Ref_to_Member'>timeline</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN95"><span class='Ref_To_Local'>segno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN93"><span class='Ref_To_Local'>fn</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="receivelog.c.html#LN93"><span class='Ref_To_Local'>fn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s%s"</span><span class='Delimiter'>, </span><a href="receivelog.c.html#LN33"><span class='Ref_to_Global_Var'>current_walfile_name</span></a><span class='Delimiter'>, 
</span>             <a href="receivelog.c.html#LN90"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN48"><span class='Ref_to_Member'>partial_suffix</span></a> <span class='Operator'>? </span><a href="receivelog.c.html#LN90"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN48"><span class='Ref_to_Member'>partial_suffix</span></a> <span class='Operator'>: </span><span class='String'>""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * When streaming to files, if an existing file exists we verify that it's 
     * either empty (just created), or a complete XLogSegSize segment (in 
     * which case it has been created and padded). Anything else indicates a 
     * corrupt file. 
     * 
     * When streaming to tar, no file with this name will exist before, so we 
     * never have to verify a size. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN90"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN49"><span class='Ref_to_Member'>existsfile</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN93"><span class='Ref_To_Local'>fn</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="receivelog.c.html#LN94"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="receivelog.c.html#LN90"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN52"><span class='Ref_to_Member'>get_file_size</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN93"><span class='Ref_To_Local'>fn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN94"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>            _<span class='Parentheses'>(</span><span class='String'>"%s: could not get size of write-ahead log file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN93"><span class='Ref_To_Local'>fn</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN90"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span>getlasterror<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN94"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>== </span><a href="../../include/access/xlog_internal.h.html#LN91"><span class='Ref_to_Const'>XLogSegSize</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Already padded file. Open it for use */ 
</span>            <a href="receivelog.c.html#LN92"><span class='Ref_To_Local'>f</span></a> <span class='Operator'>= </span><a href="receivelog.c.html#LN90"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN40"><span class='Ref_to_Member'>open_for_write</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN33"><span class='Ref_to_Global_Var'>current_walfile_name</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN90"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN48"><span class='Ref_to_Member'>partial_suffix</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN92"><span class='Ref_To_Local'>f</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                        _<span class='Parentheses'>(</span><span class='String'>"%s: could not open existing write-ahead log file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN93"><span class='Ref_To_Local'>fn</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN90"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span>getlasterror<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* fsync file in case of a previous crash */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN90"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN66"><span class='Ref_to_Member'>sync</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN92"><span class='Ref_To_Local'>f</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                        _<span class='Parentheses'>(</span><span class='String'>"%s: could not sync existing write-ahead log file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN93"><span class='Ref_To_Local'>fn</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN90"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span>getlasterror<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>                <a href="receivelog.c.html#LN90"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN46"><span class='Ref_to_Member'>close</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN92"><span class='Ref_To_Local'>f</span></a><span class='Delimiter'>, </span><a href="walmethods.h.html#LN17"><span class='Ref_to_EnumConst'>CLOSE_UNLINK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="receivelog.c.html#LN32"><span class='Ref_to_Global_Var'>walfile</span></a> <span class='Operator'>= </span><a href="receivelog.c.html#LN92"><span class='Ref_To_Local'>f</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if size==XLogSegSize &raquo; </span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN94"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* if write didn't set errno, assume problem is no disk space */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                errno <span class='Operator'>= </span>ENOSPC<span class='Delimiter'>; 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                    _<span class='Parentheses'>(</span><span class='String'>"%s: write-ahead log file \"%s\" has %d bytes, should be 0 or %d\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN93"><span class='Ref_To_Local'>fn</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="receivelog.c.html#LN94"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../include/access/xlog_internal.h.html#LN91"><span class='Ref_to_Const'>XLogSegSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Comment_Multi_Line'>/* File existed and was empty, so fall through and open */ 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if stream-&GT;walmethod-&GT;ex... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* No file existed, so create one */ 
</span> 
    <a href="receivelog.c.html#LN92"><span class='Ref_To_Local'>f</span></a> <span class='Operator'>= </span><a href="receivelog.c.html#LN90"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN40"><span class='Ref_to_Member'>open_for_write</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN33"><span class='Ref_to_Global_Var'>current_walfile_name</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN90"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN48"><span class='Ref_to_Member'>partial_suffix</span></a><span class='Delimiter'>, </span><a href="../../include/access/xlog_internal.h.html#LN91"><span class='Ref_to_Const'>XLogSegSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN92"><span class='Ref_To_Local'>f</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                _<span class='Parentheses'>(</span><span class='String'>"%s: could not open write-ahead log file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN93"><span class='Ref_To_Local'>fn</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN90"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span>getlasterror<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="receivelog.c.html#LN32"><span class='Ref_to_Global_Var'>walfile</span></a> <span class='Operator'>= </span><a href="receivelog.c.html#LN92"><span class='Ref_To_Local'>f</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end open_walfile &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Close the current WAL file (if open), and rename it to the correct 
 * filename if it's complete. On failure, prints an error message to stderr 
 * and returns false, otherwise returns true. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN181"></a><span class='Declare_Function'>close_walfile</span><span class='Parentheses'>(</span><a href="receivelog.h.html#LN29"><span class='Ref_to_Struct'>StreamCtl</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stream</span><span class='Delimiter'>, </span><a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>pos</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN183"></a>    off_t       <span class='Declare_Local'>currpos</span><span class='Delimiter'>; 
</span><a name="LN184"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>r</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN32"><span class='Ref_to_Global_Var'>walfile</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <a href="receivelog.c.html#LN183"><span class='Ref_To_Local'>currpos</span></a> <span class='Operator'>= </span><a href="receivelog.c.html#LN181"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN61"><span class='Ref_to_Member'>get_current_pos</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN32"><span class='Ref_to_Global_Var'>walfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN183"><span class='Ref_To_Local'>currpos</span></a> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>             _<span class='Parentheses'>(</span><span class='String'>"%s: could not determine seek position in file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>          <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN33"><span class='Ref_to_Global_Var'>current_walfile_name</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN181"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span>getlasterror<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="receivelog.c.html#LN181"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN46"><span class='Ref_to_Member'>close</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN32"><span class='Ref_to_Global_Var'>walfile</span></a><span class='Delimiter'>, </span><a href="walmethods.h.html#LN17"><span class='Ref_to_EnumConst'>CLOSE_UNLINK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="receivelog.c.html#LN32"><span class='Ref_to_Global_Var'>walfile</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN181"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN48"><span class='Ref_to_Member'>partial_suffix</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN183"><span class='Ref_To_Local'>currpos</span></a> <span class='Operator'>== </span>XLOG_SEG_SIZE<span class='Parentheses'>) 
</span>            <a href="receivelog.c.html#LN184"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="receivelog.c.html#LN181"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN46"><span class='Ref_to_Member'>close</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN32"><span class='Ref_to_Global_Var'>walfile</span></a><span class='Delimiter'>, </span><a href="walmethods.h.html#LN16"><span class='Ref_to_EnumConst'>CLOSE_NORMAL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                    _<span class='Parentheses'>(</span><span class='String'>"%s: not renaming \"%s%s\", segment is not complete\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN33"><span class='Ref_to_Global_Var'>current_walfile_name</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN181"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN48"><span class='Ref_to_Member'>partial_suffix</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="receivelog.c.html#LN184"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="receivelog.c.html#LN181"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN46"><span class='Ref_to_Member'>close</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN32"><span class='Ref_to_Global_Var'>walfile</span></a><span class='Delimiter'>, </span><a href="walmethods.h.html#LN18"><span class='Ref_to_EnumConst'>CLOSE_NO_RENAME</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="receivelog.c.html#LN184"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="receivelog.c.html#LN181"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN46"><span class='Ref_to_Member'>close</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN32"><span class='Ref_to_Global_Var'>walfile</span></a><span class='Delimiter'>, </span><a href="walmethods.h.html#LN16"><span class='Ref_to_EnumConst'>CLOSE_NORMAL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="receivelog.c.html#LN32"><span class='Ref_to_Global_Var'>walfile</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN184"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not close file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>          <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN33"><span class='Ref_to_Global_Var'>current_walfile_name</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN181"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span>getlasterror<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Mark file as archived if requested by the caller - pg_basebackup needs 
     * to do so as files can otherwise get archived again after promotion of a 
     * new node. This is in line with walreceiver.c always doing a 
     * XLogArchiveForceDone() after a complete segment. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN183"><span class='Ref_To_Local'>currpos</span></a> <span class='Operator'>== </span>XLOG_SEG_SIZE <span class='Operator'>&& </span><a href="receivelog.c.html#LN181"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN38"><span class='Ref_to_Member'>mark_done</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* writes error message if failed */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="receivelog.c.html#LN58"><span class='Ref_to_Func'>mark_file_as_archived</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN181"><span class='Ref_to_Parameter'>stream</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN33"><span class='Ref_to_Global_Var'>current_walfile_name</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="receivelog.c.html#LN35"><span class='Ref_to_Global_Var'>lastFlushPosition</span></a> <span class='Operator'>= </span><a href="receivelog.c.html#LN181"><span class='Ref_to_Parameter'>pos</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end close_walfile &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Check if a timeline history file exists. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN247"></a><span class='Declare_Function'>existsTimeLineHistoryFile</span><span class='Parentheses'>(</span><a href="receivelog.h.html#LN29"><span class='Ref_to_Struct'>StreamCtl</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stream</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN249"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>histfname</span><span class='Delimiter'>[</span><a href="../../include/access/xlog_internal.h.html#LN137"><span class='Ref_to_Const'>MAXFNAMELEN</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Timeline 1 never has a history file. We treat that as if it existed, 
     * since we never need to stream it. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN247"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN32"><span class='Ref_to_Member'>timeline</span></a> <span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/xlog_internal.h.html#LN177"><span class='Ref_to_Macro'>TLHistoryFileName</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN249"><span class='Ref_To_Local'>histfname</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN247"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN32"><span class='Ref_to_Member'>timeline</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="receivelog.c.html#LN247"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN49"><span class='Ref_to_Member'>existsfile</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN249"><span class='Ref_To_Local'>histfname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static bool 
</span><a name="LN264"></a><span class='Declare_Function'>writeTimeLineHistoryFile</span><span class='Parentheses'>(</span><a href="receivelog.h.html#LN29"><span class='Ref_to_Struct'>StreamCtl</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stream</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>filename</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>content</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN266"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>size</span> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="receivelog.c.html#LN264"><span class='Ref_to_Parameter'>content</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN267"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>histfname</span><span class='Delimiter'>[</span><a href="../../include/access/xlog_internal.h.html#LN137"><span class='Ref_to_Const'>MAXFNAMELEN</span></a><span class='Delimiter'>]; 
</span><a name="LN268"></a>    <a href="walmethods.h.html#LN12"><span class='Ref_to_Typedef'>Walfile</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>f</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check that the server's idea of how timeline history files should be 
     * named matches ours. 
     */ 
</span>    <a href="../../include/access/xlog_internal.h.html#LN177"><span class='Ref_to_Macro'>TLHistoryFileName</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN267"><span class='Ref_To_Local'>histfname</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN264"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN32"><span class='Ref_to_Member'>timeline</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="receivelog.c.html#LN267"><span class='Ref_To_Local'>histfname</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN264"><span class='Ref_to_Parameter'>filename</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: server reported unexpected history file name for timeline %u: %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN264"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN32"><span class='Ref_to_Member'>timeline</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN264"><span class='Ref_to_Parameter'>filename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="receivelog.c.html#LN268"><span class='Ref_To_Local'>f</span></a> <span class='Operator'>= </span><a href="receivelog.c.html#LN264"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN40"><span class='Ref_to_Member'>open_for_write</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN267"><span class='Ref_To_Local'>histfname</span></a><span class='Delimiter'>, </span><span class='String'>".tmp"</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN268"><span class='Ref_To_Local'>f</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not create timeline history file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN267"><span class='Ref_To_Local'>histfname</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN264"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span>getlasterror<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>((</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="receivelog.c.html#LN264"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN58"><span class='Ref_to_Member'>write</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN268"><span class='Ref_To_Local'>f</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN264"><span class='Ref_to_Parameter'>content</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN266"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="receivelog.c.html#LN266"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not write timeline history file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN267"><span class='Ref_To_Local'>histfname</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN264"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span>getlasterror<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If we fail to make the file, delete it to release disk space 
         */ 
</span>        <a href="receivelog.c.html#LN264"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN46"><span class='Ref_to_Member'>close</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN268"><span class='Ref_To_Local'>f</span></a><span class='Delimiter'>, </span><a href="walmethods.h.html#LN17"><span class='Ref_to_EnumConst'>CLOSE_UNLINK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN264"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN46"><span class='Ref_to_Member'>close</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN268"><span class='Ref_To_Local'>f</span></a><span class='Delimiter'>, </span><a href="walmethods.h.html#LN16"><span class='Ref_to_EnumConst'>CLOSE_NORMAL</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not close file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN267"><span class='Ref_To_Local'>histfname</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN264"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span>getlasterror<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Maintain archive_status, check close_walfile() for details. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN264"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN38"><span class='Ref_to_Member'>mark_done</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* writes error message if failed */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="receivelog.c.html#LN58"><span class='Ref_to_Func'>mark_file_as_archived</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN264"><span class='Ref_to_Parameter'>stream</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN267"><span class='Ref_To_Local'>histfname</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end writeTimeLineHistoryFile &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Send a Standby Status Update message to server. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN325"></a><span class='Declare_Function'>sendFeedback</span><span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>blockpos</span><span class='Delimiter'>, </span><a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Parameter'>now</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>replyRequested</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN327"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>replybuf</span><span class='Delimiter'>[</span><span class='Number'>1</span> <span class='Operator'>+ </span><span class='Number'>8</span> <span class='Operator'>+ </span><span class='Number'>8</span> <span class='Operator'>+ </span><span class='Number'>8</span> <span class='Operator'>+ </span><span class='Number'>8</span> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN328"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>len</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="receivelog.c.html#LN327"><span class='Ref_To_Local'>replybuf</span></a><span class='Delimiter'>[</span><a href="receivelog.c.html#LN328"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'r'</span><span class='Delimiter'>; 
</span>    <a href="receivelog.c.html#LN328"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>+= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="streamutil.h.html#LN47"><span class='Ref_to_Proto'>fe_sendint64</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN325"><span class='Ref_to_Parameter'>blockpos</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="receivelog.c.html#LN327"><span class='Ref_To_Local'>replybuf</span></a><span class='Delimiter'>[</span><a href="receivelog.c.html#LN328"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* write */ 
</span>    <a href="receivelog.c.html#LN328"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>+= </span><span class='Number'>8</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN34"><span class='Ref_to_Global_Var'>reportFlushPosition</span></a><span class='Parentheses'>) 
</span>        <a href="streamutil.h.html#LN47"><span class='Ref_to_Proto'>fe_sendint64</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN35"><span class='Ref_to_Global_Var'>lastFlushPosition</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="receivelog.c.html#LN327"><span class='Ref_To_Local'>replybuf</span></a><span class='Delimiter'>[</span><a href="receivelog.c.html#LN328"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* flush */ 
</span>    <span class='Control'>else</span> 
        <a href="streamutil.h.html#LN47"><span class='Ref_to_Proto'>fe_sendint64</span></a><span class='Parentheses'>(</span><a href="../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="receivelog.c.html#LN327"><span class='Ref_To_Local'>replybuf</span></a><span class='Delimiter'>[</span><a href="receivelog.c.html#LN328"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* flush */ 
</span>    <a href="receivelog.c.html#LN328"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>+= </span><span class='Number'>8</span><span class='Delimiter'>; 
</span>    <a href="streamutil.h.html#LN47"><span class='Ref_to_Proto'>fe_sendint64</span></a><span class='Parentheses'>(</span><a href="../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="receivelog.c.html#LN327"><span class='Ref_To_Local'>replybuf</span></a><span class='Delimiter'>[</span><a href="receivelog.c.html#LN328"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* apply */ 
</span>    <a href="receivelog.c.html#LN328"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>+= </span><span class='Number'>8</span><span class='Delimiter'>; 
</span>    <a href="streamutil.h.html#LN47"><span class='Ref_to_Proto'>fe_sendint64</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN325"><span class='Ref_to_Parameter'>now</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="receivelog.c.html#LN327"><span class='Ref_To_Local'>replybuf</span></a><span class='Delimiter'>[</span><a href="receivelog.c.html#LN328"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* sendTime */ 
</span>    <a href="receivelog.c.html#LN328"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>+= </span><span class='Number'>8</span><span class='Delimiter'>; 
</span>    <a href="receivelog.c.html#LN327"><span class='Ref_To_Local'>replybuf</span></a><span class='Delimiter'>[</span><a href="receivelog.c.html#LN328"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="receivelog.c.html#LN325"><span class='Ref_to_Parameter'>replyRequested</span></a> <span class='Operator'>? </span><span class='Number'>1</span> <span class='Operator'>: </span><span class='Number'>0</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* replyRequested */ 
</span>    <a href="receivelog.c.html#LN328"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>+= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN431"><span class='Ref_to_Proto'>PQputCopyData</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN325"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN327"><span class='Ref_To_Local'>replybuf</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN328"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT;= </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN451"><span class='Ref_to_Proto'>PQflush</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN325"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not send feedback packet: %s"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN325"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end sendFeedback &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Check that the server version we're connected to is supported by 
 * ReceiveXlogStream(). 
 * 
 * If it's not, an error message is printed to stderr, and false is returned. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN363"></a><span class='Declare_Function'>CheckServerVersionForStreaming</span><span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN365"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>minServerMajor</span><span class='Delimiter'>, 
</span><a name="LN366"></a>                <span class='Declare_Local'>maxServerMajor</span><span class='Delimiter'>; 
</span><a name="LN367"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>serverMajor</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The message format used in streaming replication changed in 9.3, so we 
     * cannot stream from older servers. And we don't support servers newer 
     * than the client; it might work, but we don't know, so err on the safe 
     * side. 
     */ 
</span>    <a href="receivelog.c.html#LN365"><span class='Ref_To_Local'>minServerMajor</span></a> <span class='Operator'>= </span><span class='Number'>903</span><span class='Delimiter'>; 
</span>    <a href="receivelog.c.html#LN366"><span class='Ref_To_Local'>maxServerMajor</span></a> <span class='Operator'>= </span>PG_VERSION_NUM <span class='Operator'>/ </span><span class='Number'>100</span><span class='Delimiter'>; 
</span>    <a href="receivelog.c.html#LN367"><span class='Ref_To_Local'>serverMajor</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN322"><span class='Ref_to_Proto'>PQserverVersion</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN363"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>) </span><span class='Operator'>/ </span><span class='Number'>100</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN367"><span class='Ref_To_Local'>serverMajor</span></a> <span class='Operator'>&LT; </span><a href="receivelog.c.html#LN365"><span class='Ref_To_Local'>minServerMajor</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN380"></a>        <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>serverver</span> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN319"><span class='Ref_to_Proto'>PQparameterStatus</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN363"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><span class='String'>"server_version"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: incompatible server version %s; client does not support streaming from server versions older than %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, 
</span>                <a href="receivelog.c.html#LN380"><span class='Ref_To_Local'>serverver</span></a> <span class='Operator'>? </span><a href="receivelog.c.html#LN380"><span class='Ref_To_Local'>serverver</span></a> <span class='Operator'>: </span><span class='String'>"'unknown'"</span><span class='Delimiter'>, 
</span>                <span class='String'>"9.3"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN367"><span class='Ref_To_Local'>serverMajor</span></a> <span class='Operator'>&GT; </span><a href="receivelog.c.html#LN366"><span class='Ref_To_Local'>maxServerMajor</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN390"></a>        <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>serverver</span> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN319"><span class='Ref_to_Proto'>PQparameterStatus</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN363"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><span class='String'>"server_version"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: incompatible server version %s; client does not support streaming from server versions newer than %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, 
</span>                <a href="receivelog.c.html#LN390"><span class='Ref_To_Local'>serverver</span></a> <span class='Operator'>? </span><a href="receivelog.c.html#LN390"><span class='Ref_To_Local'>serverver</span></a> <span class='Operator'>: </span><span class='String'>"'unknown'"</span><span class='Delimiter'>, 
</span>                PG_VERSION<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CheckServerVersionForStreaming &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Receive a log stream starting at the specified position. 
 * 
 * Individual parameters are passed through the StreamCtl structure. 
 * 
 * If sysidentifier is specified, validate that both the system 
 * identifier and the timeline matches the specified ones 
 * (by sending an extra IDENTIFY_SYSTEM command) 
 * 
 * All received segments will be written to the directory 
 * specified by basedir. This will also fetch any missing timeline history 
 * files. 
 * 
 * The stream_stop callback will be called every time data 
 * is received, and whenever a segment is completed. If it returns 
 * true, the streaming will stop and the function 
 * return. As long as it returns false, streaming will continue 
 * indefinitely. 
 * 
 * If stream_stop() checks for external input, stop_socket should be set to 
 * the FD it checks.  This will allow such input to be detected promptly 
 * rather than after standby_message_timeout (which might be indefinite). 
 * Note that signals will interrupt waits for input as well, but that is 
 * race-y since a signal received while busy won't interrupt the wait. 
 * 
 * standby_message_timeout controls how often we send a message 
 * back to the master letting it know our progress, in milliseconds. 
 * Zero means no messages are sent. 
 * This message will only contain the write location, and never 
 * flush or replay. 
 * 
 * If 'partial_suffix' is not NULL, files are initially created with the 
 * given suffix, and the suffix is removed once the file is finished. That 
 * allows you to tell the difference between partial and completed files, 
 * so that you can continue later where you left. 
 * 
 * If 'synchronous' is true, the received WAL is flushed as soon as written, 
 * otherwise only when the WAL file is closed. 
 * 
 * Note: The WAL location *must* be at a log segment start! 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN443"></a><span class='Declare_Function'>ReceiveXlogStream</span><span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><a href="receivelog.h.html#LN29"><span class='Ref_to_Struct'>StreamCtl</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stream</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN445"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>query</span><span class='Delimiter'>[</span><span class='Number'>128</span><span class='Delimiter'>]; 
</span><a name="LN446"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>slotcmd</span><span class='Delimiter'>[</span><span class='Number'>128</span><span class='Delimiter'>]; 
</span><a name="LN447"></a>    <a href="../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span><a name="LN448"></a>    <a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>stoppos</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The caller should've checked the server version already, but doesn't do 
     * any harm to check it here too. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="receivelog.h.html#LN55"><span class='Ref_to_Proto'>CheckServerVersionForStreaming</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Decide whether we want to report the flush position. If we report the 
     * flush position, the primary will know what WAL we'll possibly 
     * re-request, and it can then remove older WAL safely. We must always do 
     * that when we are using slots. 
     * 
     * Reporting the flush position makes one eligible as a synchronous 
     * replica. People shouldn't include generic names in 
     * synchronous_standby_names, but we've protected them against it so far, 
     * so let's continue to do so unless specifically requested. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN49"><span class='Ref_to_Member'>replication_slot</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="receivelog.c.html#LN34"><span class='Ref_to_Global_Var'>reportFlushPosition</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN446"><span class='Ref_To_Local'>slotcmd</span></a><span class='Delimiter'>, </span><span class='String'>"SLOT \"%s\" "</span><span class='Delimiter'>, </span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN49"><span class='Ref_to_Member'>replication_slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN37"><span class='Ref_to_Member'>synchronous</span></a><span class='Parentheses'>) 
</span>            <a href="receivelog.c.html#LN34"><span class='Ref_to_Global_Var'>reportFlushPosition</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="receivelog.c.html#LN34"><span class='Ref_to_Global_Var'>reportFlushPosition</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="receivelog.c.html#LN446"><span class='Ref_To_Local'>slotcmd</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN33"><span class='Ref_to_Member'>sysidentifier</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Validate system identifier hasn't changed */ 
</span>        <a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN380"><span class='Ref_to_Proto'>PQexec</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><span class='String'>"IDENTIFY_SYSTEM"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN87"><span class='Ref_to_EnumConst'>PGRES_TUPLES_OK</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                    _<span class='Parentheses'>(</span><span class='String'>"%s: could not send replication command \"%s\": %s"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><span class='String'>"IDENTIFY_SYSTEM"</span><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN473"><span class='Ref_to_Proto'>PQntuples</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span> <span class='Operator'>|| </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN474"><span class='Ref_to_Proto'>PQnfields</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>3</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                    _<span class='Parentheses'>(</span><span class='String'>"%s: could not identify system: got %d rows and %d fields, expected %d rows and %d or more fields\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN473"><span class='Ref_to_Proto'>PQntuples</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN474"><span class='Ref_to_Proto'>PQnfields</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN33"><span class='Ref_to_Member'>sysidentifier</span></a><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN488"><span class='Ref_to_Proto'>PQgetvalue</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                    _<span class='Parentheses'>(</span><span class='String'>"%s: system identifier does not match between base backup and streaming connection\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN32"><span class='Ref_to_Member'>timeline</span></a> <span class='Operator'>&GT; </span>atoi<span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN488"><span class='Ref_to_Proto'>PQgetvalue</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                _<span class='Parentheses'>(</span><span class='String'>"%s: starting timeline %u is not present in the server\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN32"><span class='Ref_to_Member'>timeline</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if stream-&GT;sysidentifier... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Create temporary replication slot if one is needed 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN50"><span class='Ref_to_Member'>temp_slot</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN445"><span class='Ref_To_Local'>query</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="receivelog.c.html#LN445"><span class='Ref_To_Local'>query</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <span class='String'>"CREATE_REPLICATION_SLOT \"%s\" TEMPORARY PHYSICAL RESERVE_WAL"</span><span class='Delimiter'>, 
</span>                 <a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN49"><span class='Ref_to_Member'>replication_slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN380"><span class='Ref_to_Proto'>PQexec</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN445"><span class='Ref_To_Local'>query</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN87"><span class='Ref_to_EnumConst'>PGRES_TUPLES_OK</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not create temporary replication slot \"%s\": %s"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN49"><span class='Ref_to_Member'>replication_slot</span></a><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * initialize flush position to starting point, it's the caller's 
     * responsibility that that's sane. 
     */ 
</span>    <a href="receivelog.c.html#LN35"><span class='Ref_to_Global_Var'>lastFlushPosition</span></a> <span class='Operator'>= </span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN31"><span class='Ref_to_Member'>startpos</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Fetch the timeline history file for this timeline, if we don't have 
         * it already. When streaming log to tar, this will always return 
         * false, as we are never streaming into an existing file and 
         * therefore there can be no pre-existing timeline history file. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="receivelog.c.html#LN246"><span class='Ref_to_Func'>existsTimeLineHistoryFile</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>stream</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN445"><span class='Ref_To_Local'>query</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="receivelog.c.html#LN445"><span class='Ref_To_Local'>query</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"TIMELINE_HISTORY %u"</span><span class='Delimiter'>, </span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN32"><span class='Ref_to_Member'>timeline</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN380"><span class='Ref_to_Proto'>PQexec</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN445"><span class='Ref_To_Local'>query</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN87"><span class='Ref_to_EnumConst'>PGRES_TUPLES_OK</span></a><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* FIXME: we might send it ok, but get an error */ 
</span>                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not send replication command \"%s\": %s"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><span class='String'>"TIMELINE_HISTORY"</span><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN468"><span class='Ref_to_Proto'>PQresultErrorMessage</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * The response to TIMELINE_HISTORY is a single row result set 
             * with two fields: filename and content 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN474"><span class='Ref_to_Proto'>PQnfields</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>2</span> <span class='Operator'>|| </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN473"><span class='Ref_to_Proto'>PQntuples</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                        _<span class='Parentheses'>(</span><span class='String'>"%s: unexpected response to TIMELINE_HISTORY command: got %d rows and %d fields, expected %d rows and %d fields\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN473"><span class='Ref_to_Proto'>PQntuples</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN474"><span class='Ref_to_Proto'>PQnfields</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* Write the history file to disk */ 
</span>            <a href="../../include/access/timeline.h.html#LN36"><span class='Ref_to_Proto'>writeTimeLineHistoryFile</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>stream</span></a><span class='Delimiter'>, 
</span>                                     <a href="../../interfaces/libpq/libpq-fe.h.html#LN488"><span class='Ref_to_Proto'>PQgetvalue</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                     <a href="../../interfaces/libpq/libpq-fe.h.html#LN488"><span class='Ref_to_Proto'>PQgetvalue</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <a href="../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !existsTimeLineHistor... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Before we start streaming from the requested location, check if the 
         * callback tells us to stop here. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN42"><span class='Ref_to_Member'>stream_stop</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN31"><span class='Ref_to_Member'>startpos</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN32"><span class='Ref_to_Member'>timeline</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Initiate the replication stream at specified location */ 
</span>        <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN445"><span class='Ref_To_Local'>query</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="receivelog.c.html#LN445"><span class='Ref_To_Local'>query</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"START_REPLICATION %s%X/%X TIMELINE %u"</span><span class='Delimiter'>, 
</span>                 <a href="receivelog.c.html#LN446"><span class='Ref_To_Local'>slotcmd</span></a><span class='Delimiter'>, 
</span>                 <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN31"><span class='Ref_to_Member'>startpos</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN31"><span class='Ref_to_Member'>startpos</span></a><span class='Delimiter'>, 
</span>                 <a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN32"><span class='Ref_to_Member'>timeline</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN380"><span class='Ref_to_Proto'>PQexec</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN445"><span class='Ref_To_Local'>query</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN96"><span class='Ref_to_EnumConst'>PGRES_COPY_BOTH</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not send replication command \"%s\": %s"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><span class='String'>"START_REPLICATION"</span><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN468"><span class='Ref_to_Proto'>PQresultErrorMessage</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Stream the WAL */ 
</span>        <a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="receivelog.c.html#LN39"><span class='Ref_to_Proto'>HandleCopyStream</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>stream</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="receivelog.c.html#LN448"><span class='Ref_To_Local'>stoppos</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="receivelog.c.html#LN709"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Streaming finished. 
         * 
         * There are two possible reasons for that: a controlled shutdown, or 
         * we reached the end of the current timeline. In case of 
         * end-of-timeline, the server sends a result set after Copy has 
         * finished, containing information about the next timeline. Read 
         * that, and restart streaming from the next timeline. In case of 
         * controlled shutdown, stop here. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN87"><span class='Ref_to_EnumConst'>PGRES_TUPLES_OK</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * End-of-timeline. Read the next timeline's ID and starting 
             * position. Usually, the starting position will match the end of 
             * the previous timeline, but there are corner cases like if the 
             * server had sent us half of a WAL record, when it was promoted. 
             * The new timeline will begin at the end of the last complete 
             * record in that case, overlapping the partial WAL record on the 
             * old timeline. 
             */ 
</span><a name="LN633"></a>            <a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>newtimeline</span><span class='Delimiter'>; 
</span><a name="LN634"></a>            <span class='Keyword'>bool</span>        <span class='Declare_Local'>parsed</span><span class='Delimiter'>; 
</span> 
            <a href="receivelog.c.html#LN634"><span class='Ref_To_Local'>parsed</span></a> <span class='Operator'>= </span><a href="receivelog.c.html#LN55"><span class='Ref_to_Proto'>ReadEndOfStreamingResult</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN31"><span class='Ref_to_Member'>startpos</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="receivelog.c.html#LN633"><span class='Ref_To_Local'>newtimeline</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="receivelog.c.html#LN634"><span class='Ref_To_Local'>parsed</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="receivelog.c.html#LN709"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Sanity check the values the server gave us */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN633"><span class='Ref_To_Local'>newtimeline</span></a> <span class='Operator'>&LT;= </span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN32"><span class='Ref_to_Member'>timeline</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                        _<span class='Parentheses'>(</span><span class='String'>"%s: server reported unexpected next timeline %u, following timeline %u\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN633"><span class='Ref_To_Local'>newtimeline</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN32"><span class='Ref_to_Member'>timeline</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="receivelog.c.html#LN709"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN31"><span class='Ref_to_Member'>startpos</span></a> <span class='Operator'>&GT; </span><a href="receivelog.c.html#LN448"><span class='Ref_To_Local'>stoppos</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                        _<span class='Parentheses'>(</span><span class='String'>"%s: server stopped streaming timeline %u at %X/%X, but reported next timeline %u to begin at %X/%X\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, 
</span>                <a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN32"><span class='Ref_to_Member'>timeline</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="receivelog.c.html#LN448"><span class='Ref_To_Local'>stoppos</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="receivelog.c.html#LN448"><span class='Ref_To_Local'>stoppos</span></a><span class='Delimiter'>, 
</span>                        <a href="receivelog.c.html#LN633"><span class='Ref_To_Local'>newtimeline</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN31"><span class='Ref_to_Member'>startpos</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN31"><span class='Ref_to_Member'>startpos</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="receivelog.c.html#LN709"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* Read the final result, which should be CommandComplete. */ 
</span>            <a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN421"><span class='Ref_to_Proto'>PQgetResult</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN84"><span class='Ref_to_EnumConst'>PGRES_COMMAND_OK</span></a><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                   _<span class='Parentheses'>(</span><span class='String'>"%s: unexpected termination of replication stream: %s"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN468"><span class='Ref_to_Proto'>PQresultErrorMessage</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="receivelog.c.html#LN709"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Loop back to start streaming from the new timeline. Always 
             * start streaming at the beginning of a segment. 
             */ 
</span>            <a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN32"><span class='Ref_to_Member'>timeline</span></a> <span class='Operator'>= </span><a href="receivelog.c.html#LN633"><span class='Ref_To_Local'>newtimeline</span></a><span class='Delimiter'>; 
</span>            <a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN31"><span class='Ref_to_Member'>startpos</span></a> <span class='Operator'>= </span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN31"><span class='Ref_to_Member'>startpos</span></a> <span class='Operator'>- </span><span class='Parentheses'>(</span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN31"><span class='Ref_to_Member'>startpos</span></a> <span class='Operator'>% </span>XLOG_SEG_SIZE<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if PQresultStatus(res)==... &raquo; </span> 
        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN84"><span class='Ref_to_EnumConst'>PGRES_COMMAND_OK</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * End of replication (ie. controlled shut down of the server). 
             * 
             * Check if the callback thinks it's OK to stop here. If not, 
             * complain. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN42"><span class='Ref_to_Member'>stream_stop</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN448"><span class='Ref_To_Local'>stoppos</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN32"><span class='Ref_to_Member'>timeline</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>))</span> 
                <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: replication stream was terminated before stop point\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="receivelog.c.html#LN709"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Server returned an error. */ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                    _<span class='Parentheses'>(</span><span class='String'>"%s: unexpected termination of replication stream: %s"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN468"><span class='Ref_to_Proto'>PQresultErrorMessage</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN447"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="receivelog.c.html#LN709"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while 1 &raquo; </span> 
 
<a name="LN709"></a><span class='Label'>error</span><span class='Operator'>: 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN32"><span class='Ref_to_Global_Var'>walfile</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN46"><span class='Ref_to_Member'>close</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN32"><span class='Ref_to_Global_Var'>walfile</span></a><span class='Delimiter'>, </span><a href="walmethods.h.html#LN18"><span class='Ref_to_EnumConst'>CLOSE_NO_RENAME</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not close file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>          <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN33"><span class='Ref_to_Global_Var'>current_walfile_name</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN443"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span>getlasterror<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>    <a href="receivelog.c.html#LN32"><span class='Ref_to_Global_Var'>walfile</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReceiveXlogStream &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Helper function to parse the result set returned by server after streaming 
 * has finished. On failure, prints an error to stderr and returns false. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN722"></a><span class='Declare_Function'>ReadEndOfStreamingResult</span><span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>res</span><span class='Delimiter'>, </span><a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>startpos</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>timeline</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN724"></a>    <a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>startpos_xlogid</span><span class='Delimiter'>, 
</span><a name="LN725"></a>                <span class='Declare_Local'>startpos_xrecoff</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/*---------- 
     * The result set consists of one row and two columns, e.g: 
     * 
     *  next_tli | next_tli_startpos 
     * ----------+------------------- 
     *         4 | 0/9949AE0 
     * 
     * next_tli is the timeline ID of the next timeline after the one that 
     * just finished streaming. next_tli_startpos is the WAL location where 
     * the server switched to it. 
     *---------- 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN474"><span class='Ref_to_Proto'>PQnfields</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN722"><span class='Ref_to_Parameter'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>2</span> <span class='Operator'>|| </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN473"><span class='Ref_to_Proto'>PQntuples</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN722"><span class='Ref_to_Parameter'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                _<span class='Parentheses'>(</span><span class='String'>"%s: unexpected result set after end-of-timeline: got %d rows and %d fields, expected %d rows and %d fields\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN473"><span class='Ref_to_Proto'>PQntuples</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN722"><span class='Ref_to_Parameter'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN474"><span class='Ref_to_Proto'>PQnfields</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN722"><span class='Ref_to_Parameter'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Operator'>*</span><a href="receivelog.c.html#LN722"><span class='Ref_to_Parameter'>timeline</span></a> <span class='Operator'>= </span>atoi<span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN488"><span class='Ref_to_Proto'>PQgetvalue</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN722"><span class='Ref_to_Parameter'>res</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>sscanf<span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN488"><span class='Ref_to_Proto'>PQgetvalue</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN722"><span class='Ref_to_Parameter'>res</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%X/%X"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="receivelog.c.html#LN724"><span class='Ref_To_Local'>startpos_xlogid</span></a><span class='Delimiter'>, 
</span>               <span class='Operator'>&</span><a href="receivelog.c.html#LN725"><span class='Ref_To_Local'>startpos_xrecoff</span></a><span class='Parentheses'>)</span> <span class='Operator'>!= </span><span class='Number'>2</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>            _<span class='Parentheses'>(</span><span class='String'>"%s: could not parse next timeline's starting point \"%s\"\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN488"><span class='Ref_to_Proto'>PQgetvalue</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN722"><span class='Ref_to_Parameter'>res</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Operator'>*</span><a href="receivelog.c.html#LN722"><span class='Ref_to_Parameter'>startpos</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a><span class='Parentheses'>) </span><a href="receivelog.c.html#LN724"><span class='Ref_To_Local'>startpos_xlogid</span></a> <span class='Operator'>&LT;&LT; </span><span class='Number'>32</span><span class='Parentheses'>)</span> <span class='Operator'>| </span><a href="receivelog.c.html#LN725"><span class='Ref_To_Local'>startpos_xrecoff</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReadEndOfStreamingResult &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * The main loop of ReceiveXlogStream. Handles the COPY stream after 
 * initiating streaming with the START_STREAMING command. 
 * 
 * If the COPY ends (not necessarily successfully) due a message from the 
 * server, returns a PGresult and sets *stoppos to the last byte written. 
 * On any other sort of error, returns NULL. 
 */ 
</span><span class='Keyword'>static </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a> <span class='Operator'>* 
</span><a name="LN770"></a><span class='Declare_Function'>HandleCopyStream</span><span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><a href="receivelog.h.html#LN29"><span class='Ref_to_Struct'>StreamCtl</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stream</span><span class='Delimiter'>, 
</span><a name="LN771"></a>                 <a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stoppos</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN773"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>copybuf</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN774"></a>    <a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>last_status</span> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span><a name="LN775"></a>    <a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>blockpos</span> <span class='Operator'>= </span><a href="receivelog.c.html#LN770"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN31"><span class='Ref_to_Member'>startpos</span></a><span class='Delimiter'>; 
</span> 
    <a href="receivelog.c.html#LN37"><span class='Ref_to_Global_Var'>still_sending</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN781"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>r</span><span class='Delimiter'>; 
</span><a name="LN782"></a>        <a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>now</span><span class='Delimiter'>; 
</span><a name="LN783"></a>        <span class='Keyword'>long</span>        <span class='Declare_Local'>sleeptime</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Check if we should continue streaming, or abort at this point. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="receivelog.c.html#LN50"><span class='Ref_to_Proto'>CheckCopyStreamStop</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN770"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN770"><span class='Ref_to_Parameter'>stream</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN775"><span class='Ref_To_Local'>blockpos</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN771"><span class='Ref_to_Parameter'>stoppos</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="receivelog.c.html#LN884"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span> 
        <a href="receivelog.c.html#LN782"><span class='Ref_To_Local'>now</span></a> <span class='Operator'>= </span><a href="streamutil.h.html#LN41"><span class='Ref_to_Proto'>feGetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If synchronous option is true, issue sync command as soon as there 
         * are WAL data which has not been flushed yet. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN770"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN37"><span class='Ref_to_Member'>synchronous</span></a> <span class='Operator'>&& </span><a href="receivelog.c.html#LN35"><span class='Ref_to_Global_Var'>lastFlushPosition</span></a> <span class='Operator'>&LT; </span><a href="receivelog.c.html#LN775"><span class='Ref_To_Local'>blockpos</span></a> <span class='Operator'>&& </span><a href="receivelog.c.html#LN32"><span class='Ref_to_Global_Var'>walfile</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN770"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN66"><span class='Ref_to_Member'>sync</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN32"><span class='Ref_to_Global_Var'>walfile</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not fsync file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN33"><span class='Ref_to_Global_Var'>current_walfile_name</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN770"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span>getlasterror<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>                <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="receivelog.c.html#LN884"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="receivelog.c.html#LN35"><span class='Ref_to_Global_Var'>lastFlushPosition</span></a> <span class='Operator'>= </span><a href="receivelog.c.html#LN775"><span class='Ref_To_Local'>blockpos</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Send feedback so that the server sees the latest WAL locations 
             * immediately. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_recvlogical.c.html#LN113"><span class='Ref_to_Func'>sendFeedback</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN770"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN775"><span class='Ref_To_Local'>blockpos</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN782"><span class='Ref_To_Local'>now</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>))</span> 
                <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="receivelog.c.html#LN884"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span>            <a href="receivelog.c.html#LN774"><span class='Ref_To_Local'>last_status</span></a> <span class='Operator'>= </span><a href="receivelog.c.html#LN782"><span class='Ref_To_Local'>now</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Potentially send a status message to the master 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN37"><span class='Ref_to_Global_Var'>still_sending</span></a> <span class='Operator'>&& </span><a href="receivelog.c.html#LN770"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN35"><span class='Ref_to_Member'>standby_message_timeout</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>            <a href="streamutil.h.html#LN45"><span class='Ref_to_Proto'>feTimestampDifferenceExceeds</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN774"><span class='Ref_To_Local'>last_status</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN782"><span class='Ref_To_Local'>now</span></a><span class='Delimiter'>, 
</span>                                         <a href="receivelog.c.html#LN770"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN35"><span class='Ref_to_Member'>standby_message_timeout</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Time to send feedback! */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_recvlogical.c.html#LN113"><span class='Ref_to_Func'>sendFeedback</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN770"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN775"><span class='Ref_To_Local'>blockpos</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN782"><span class='Ref_To_Local'>now</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>))</span> 
                <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="receivelog.c.html#LN884"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span>            <a href="receivelog.c.html#LN774"><span class='Ref_To_Local'>last_status</span></a> <span class='Operator'>= </span><a href="receivelog.c.html#LN782"><span class='Ref_To_Local'>now</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Calculate how long send/receive loops should sleep 
         */ 
</span>        <a href="receivelog.c.html#LN783"><span class='Ref_To_Local'>sleeptime</span></a> <span class='Operator'>= </span><a href="receivelog.c.html#LN52"><span class='Ref_to_Proto'>CalculateCopyStreamSleeptime</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN782"><span class='Ref_To_Local'>now</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN770"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN35"><span class='Ref_to_Member'>standby_message_timeout</span></a><span class='Delimiter'>, 
</span>                                                 <a href="receivelog.c.html#LN774"><span class='Ref_To_Local'>last_status</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="receivelog.c.html#LN781"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="receivelog.c.html#LN42"><span class='Ref_to_Proto'>CopyStreamReceive</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN770"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN783"><span class='Ref_To_Local'>sleeptime</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN770"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN44"><span class='Ref_to_Member'>stop_socket</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="receivelog.c.html#LN773"><span class='Ref_To_Local'>copybuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN781"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN781"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>                <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="receivelog.c.html#LN884"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN781"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>== -</span><span class='Number'>2</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN842"></a>                <a href="../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>res</span> <span class='Operator'>= </span><a href="receivelog.c.html#LN48"><span class='Ref_to_Proto'>HandleEndOfCopyStream</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN770"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN770"><span class='Ref_to_Parameter'>stream</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN773"><span class='Ref_To_Local'>copybuf</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN775"><span class='Ref_To_Local'>blockpos</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN771"><span class='Ref_to_Parameter'>stoppos</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN842"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                    <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="receivelog.c.html#LN884"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                    <span class='Control'>return</span> <a href="receivelog.c.html#LN842"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* Check the message type. */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN773"><span class='Ref_To_Local'>copybuf</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'k'</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="receivelog.c.html#LN44"><span class='Ref_to_Proto'>ProcessKeepaliveMsg</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN770"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN770"><span class='Ref_to_Parameter'>stream</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN773"><span class='Ref_To_Local'>copybuf</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN781"><span class='Ref_To_Local'>r</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN775"><span class='Ref_To_Local'>blockpos</span></a><span class='Delimiter'>, 
</span>                                         <span class='Operator'>&</span><a href="receivelog.c.html#LN774"><span class='Ref_To_Local'>last_status</span></a><span class='Parentheses'>))</span> 
                    <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="receivelog.c.html#LN884"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN773"><span class='Ref_To_Local'>copybuf</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'w'</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="receivelog.c.html#LN46"><span class='Ref_to_Proto'>ProcessXLogDataMsg</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN770"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN770"><span class='Ref_to_Parameter'>stream</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN773"><span class='Ref_To_Local'>copybuf</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN781"><span class='Ref_To_Local'>r</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="receivelog.c.html#LN775"><span class='Ref_To_Local'>blockpos</span></a><span class='Parentheses'>))</span> 
                    <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="receivelog.c.html#LN884"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * Check if we should continue streaming, or abort at this 
                 * point. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="receivelog.c.html#LN50"><span class='Ref_to_Proto'>CheckCopyStreamStop</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN770"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN770"><span class='Ref_to_Parameter'>stream</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN775"><span class='Ref_To_Local'>blockpos</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN771"><span class='Ref_to_Parameter'>stoppos</span></a><span class='Parentheses'>))</span> 
                    <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="receivelog.c.html#LN884"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: unrecognized streaming header: \"%c\"\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN773"><span class='Ref_To_Local'>copybuf</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="receivelog.c.html#LN884"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Process the received data, and any subsequent data we can read 
             * without blocking. 
             */ 
</span>            <a href="receivelog.c.html#LN781"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="receivelog.c.html#LN42"><span class='Ref_to_Proto'>CopyStreamReceive</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN770"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="receivelog.c.html#LN770"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN44"><span class='Ref_to_Member'>stop_socket</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="receivelog.c.html#LN773"><span class='Ref_To_Local'>copybuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while r!=0 &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while 1 &raquo; </span> 
 
<a name="LN884"></a><span class='Label'>error</span><span class='Operator'>: 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN773"><span class='Ref_To_Local'>copybuf</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../interfaces/libpq/libpq-fe.h.html#LN504"><span class='Ref_to_Proto'>PQfreemem</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN773"><span class='Ref_To_Local'>copybuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end HandleCopyStream &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Wait until we can read a CopyData message, 
 * or timeout, or occurrence of a signal or input on the stop_socket. 
 * (timeout_ms &LT; 0 means wait indefinitely; 0 means don't wait.) 
 * 
 * Returns 1 if data has become available for reading, 0 if timed out 
 * or interrupted by signal or stop_socket input, and -1 on an error. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN899"></a><span class='Declare_Function'>CopyStreamPoll</span><span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Keyword'>long </span><span class='Declare_Parameter'>timeout_ms</span><span class='Delimiter'>, </span><a href="../../include/port.h.html#LN25"><span class='Ref_to_Typedef'>pgsocket</span></a> <span class='Declare_Parameter'>stop_socket</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN901"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ret</span><span class='Delimiter'>; 
</span><a name="LN902"></a>    fd_set      <span class='Declare_Local'>input_mask</span><span class='Delimiter'>; 
</span><a name="LN903"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>connsocket</span><span class='Delimiter'>; 
</span><a name="LN904"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>maxfd</span><span class='Delimiter'>; 
</span><a name="LN905"></a>    <span class='Control'>struct</span> timeval <span class='Declare_Local'>timeout</span><span class='Delimiter'>; 
</span><a name="LN906"></a>    <span class='Control'>struct</span> timeval <span class='Operator'>*</span><span class='Declare_Local'>timeoutptr</span><span class='Delimiter'>; 
</span> 
    <a href="receivelog.c.html#LN903"><span class='Ref_To_Local'>connsocket</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN324"><span class='Ref_to_Proto'>PQsocket</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN899"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN903"><span class='Ref_To_Local'>connsocket</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: invalid socket: %s"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, 
</span>                <a href="../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN899"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    FD_ZERO<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="receivelog.c.html#LN902"><span class='Ref_To_Local'>input_mask</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    FD_SET<span class='Parentheses'>(</span><a href="receivelog.c.html#LN903"><span class='Ref_To_Local'>connsocket</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="receivelog.c.html#LN902"><span class='Ref_To_Local'>input_mask</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="receivelog.c.html#LN904"><span class='Ref_To_Local'>maxfd</span></a> <span class='Operator'>= </span><a href="receivelog.c.html#LN903"><span class='Ref_To_Local'>connsocket</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN899"><span class='Ref_to_Parameter'>stop_socket</span></a> <span class='Operator'>!= </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        FD_SET<span class='Parentheses'>(</span><a href="receivelog.c.html#LN899"><span class='Ref_to_Parameter'>stop_socket</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="receivelog.c.html#LN902"><span class='Ref_To_Local'>input_mask</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="receivelog.c.html#LN904"><span class='Ref_To_Local'>maxfd</span></a> <span class='Operator'>= </span><a href="../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN10"><span class='Ref_to_Macro'>Max</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN904"><span class='Ref_To_Local'>maxfd</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN899"><span class='Ref_to_Parameter'>stop_socket</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN899"><span class='Ref_to_Parameter'>timeout_ms</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="receivelog.c.html#LN906"><span class='Ref_To_Local'>timeoutptr</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="receivelog.c.html#LN905"><span class='Ref_To_Local'>timeout</span></a><span class='Operator'>.</span>tv_sec <span class='Operator'>= </span><a href="receivelog.c.html#LN899"><span class='Ref_to_Parameter'>timeout_ms</span></a> <span class='Operator'>/ </span><span class='Number'>1000L</span><span class='Delimiter'>; 
</span>        <a href="receivelog.c.html#LN905"><span class='Ref_To_Local'>timeout</span></a><span class='Operator'>.</span>tv_usec <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="receivelog.c.html#LN899"><span class='Ref_to_Parameter'>timeout_ms</span></a> <span class='Operator'>% </span><span class='Number'>1000L</span><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Number'>1000L</span><span class='Delimiter'>; 
</span>        <a href="receivelog.c.html#LN906"><span class='Ref_To_Local'>timeoutptr</span></a> <span class='Operator'>= &</span><a href="receivelog.c.html#LN905"><span class='Ref_To_Local'>timeout</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="receivelog.c.html#LN901"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><a href="../../include/port/win32.h.html#LN373"><span class='Ref_to_Macro'>select</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN904"><span class='Ref_To_Local'>maxfd</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="receivelog.c.html#LN902"><span class='Ref_To_Local'>input_mask</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="receivelog.c.html#LN906"><span class='Ref_To_Local'>timeoutptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN901"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span><a href="../../interfaces/libpq/win32.h.html#LN17"><span class='Ref_to_Const'>EINTR</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* Got a signal, so not an error */ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: select() failed: %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN901"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& </span>FD_ISSET<span class='Parentheses'>(</span><a href="receivelog.c.html#LN903"><span class='Ref_To_Local'>connsocket</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="receivelog.c.html#LN902"><span class='Ref_To_Local'>input_mask</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Number'>1</span><span class='Delimiter'>;</span>               <span class='Comment_Single_Line'>/* Got input on connection socket */ 
</span> 
    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>;</span>                   <span class='Comment_Single_Line'>/* Got timeout or input on stop_socket */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end CopyStreamPoll &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Receive CopyData message available from XLOG stream, blocking for 
 * maximum of 'timeout' ms. 
 * 
 * If data was received, returns the length of the data. *buffer is set to 
 * point to a buffer holding the received message. The buffer is only valid 
 * until the next CopyStreamReceive call. 
 * 
 * Returns 0 if no data was available within timeout, or if wait was 
 * interrupted by signal or stop_socket input. 
 * -1 on error. -2 if the server ended the COPY. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN963"></a><span class='Declare_Function'>CopyStreamReceive</span><span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Keyword'>long </span><span class='Declare_Parameter'>timeout</span><span class='Delimiter'>, </span><a href="../../include/port.h.html#LN25"><span class='Ref_to_Typedef'>pgsocket</span></a> <span class='Declare_Parameter'>stop_socket</span><span class='Delimiter'>, 
</span><a name="LN964"></a>                  <span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>buffer</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN966"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>copybuf</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN967"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>rawlen</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="receivelog.c.html#LN964"><span class='Ref_to_Parameter'>buffer</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../interfaces/libpq/libpq-fe.h.html#LN504"><span class='Ref_to_Proto'>PQfreemem</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="receivelog.c.html#LN964"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="receivelog.c.html#LN964"><span class='Ref_to_Parameter'>buffer</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Try to receive a CopyData message */ 
</span>    <a href="receivelog.c.html#LN967"><span class='Ref_To_Local'>rawlen</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN433"><span class='Ref_to_Proto'>PQgetCopyData</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN963"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="receivelog.c.html#LN966"><span class='Ref_To_Local'>copybuf</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN967"><span class='Ref_To_Local'>rawlen</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN977"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>ret</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * No data available.  Wait for some to appear, but not longer than 
         * the specified timeout, so that we can ping the server.  Also stop 
         * waiting if input appears on stop_socket. 
         */ 
</span>        <a href="receivelog.c.html#LN977"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><a href="receivelog.c.html#LN41"><span class='Ref_to_Proto'>CopyStreamPoll</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN963"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN963"><span class='Ref_to_Parameter'>timeout</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN963"><span class='Ref_to_Parameter'>stop_socket</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN977"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <a href="receivelog.c.html#LN977"><span class='Ref_To_Local'>ret</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Now there is actually data on the socket */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN425"><span class='Ref_to_Proto'>PQconsumeInput</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN963"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                    _<span class='Parentheses'>(</span><span class='String'>"%s: could not receive data from WAL stream: %s"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN963"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Now that we've consumed some input, try again */ 
</span>        <a href="receivelog.c.html#LN967"><span class='Ref_To_Local'>rawlen</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN433"><span class='Ref_to_Proto'>PQgetCopyData</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN963"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="receivelog.c.html#LN966"><span class='Ref_To_Local'>copybuf</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN967"><span class='Ref_To_Local'>rawlen</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if rawlen==0 &raquo; </span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN967"><span class='Ref_To_Local'>rawlen</span></a> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span>           <span class='Comment_Single_Line'>/* end-of-streaming or error */ 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>2</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN967"><span class='Ref_To_Local'>rawlen</span></a> <span class='Operator'>== -</span><span class='Number'>2</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not read COPY data: %s"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN963"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Return received messages to caller */ 
</span>    <span class='Operator'>*</span><a href="receivelog.c.html#LN964"><span class='Ref_to_Parameter'>buffer</span></a> <span class='Operator'>= </span><a href="receivelog.c.html#LN966"><span class='Ref_To_Local'>copybuf</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="receivelog.c.html#LN967"><span class='Ref_To_Local'>rawlen</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CopyStreamReceive &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Process the keepalive message. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1020"></a><span class='Declare_Function'>ProcessKeepaliveMsg</span><span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><a href="receivelog.h.html#LN29"><span class='Ref_to_Struct'>StreamCtl</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stream</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>copybuf</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Delimiter'>, 
</span><a name="LN1021"></a>                    <a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>blockpos</span><span class='Delimiter'>, </span><a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>last_status</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1023"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>pos</span><span class='Delimiter'>; 
</span><a name="LN1024"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>replyRequested</span><span class='Delimiter'>; 
</span><a name="LN1025"></a>    <a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>now</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Parse the keepalive message, enclosed in the CopyData message. We just 
     * check if the server requested a reply, and ignore the rest. 
     */ 
</span>    <a href="receivelog.c.html#LN1023"><span class='Ref_To_Local'>pos</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>;</span>                    <span class='Comment_Single_Line'>/* skip msgtype 'k' */ 
</span>    <a href="receivelog.c.html#LN1023"><span class='Ref_To_Local'>pos</span></a> <span class='Operator'>+= </span><span class='Number'>8</span><span class='Delimiter'>;</span>                   <span class='Comment_Single_Line'>/* skip walEnd */ 
</span>    <a href="receivelog.c.html#LN1023"><span class='Ref_To_Local'>pos</span></a> <span class='Operator'>+= </span><span class='Number'>8</span><span class='Delimiter'>;</span>                   <span class='Comment_Single_Line'>/* skip sendTime */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN1020"><span class='Ref_to_Parameter'>len</span></a> <span class='Operator'>&LT; </span><a href="receivelog.c.html#LN1023"><span class='Ref_To_Local'>pos</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: streaming header too small: %d\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN1020"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="receivelog.c.html#LN1024"><span class='Ref_To_Local'>replyRequested</span></a> <span class='Operator'>= </span><a href="receivelog.c.html#LN1020"><span class='Ref_to_Parameter'>copybuf</span></a><span class='Delimiter'>[</span><a href="receivelog.c.html#LN1023"><span class='Ref_To_Local'>pos</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* If the server requested an immediate reply, send one. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN1024"><span class='Ref_To_Local'>replyRequested</span></a> <span class='Operator'>&& </span><a href="receivelog.c.html#LN37"><span class='Ref_to_Global_Var'>still_sending</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN34"><span class='Ref_to_Global_Var'>reportFlushPosition</span></a> <span class='Operator'>&& </span><a href="receivelog.c.html#LN35"><span class='Ref_to_Global_Var'>lastFlushPosition</span></a> <span class='Operator'>&LT; </span><a href="receivelog.c.html#LN1021"><span class='Ref_to_Parameter'>blockpos</span></a> <span class='Operator'>&& 
</span>            <a href="receivelog.c.html#LN32"><span class='Ref_to_Global_Var'>walfile</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * If a valid flush location needs to be reported, flush the 
             * current WAL file so that the latest flush location is sent back 
             * to the server. This is necessary to see whether the last WAL 
             * data has been successfully replicated or not, at the normal 
             * shutdown of the server. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN1020"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN66"><span class='Ref_to_Member'>sync</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN32"><span class='Ref_to_Global_Var'>walfile</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not fsync file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN33"><span class='Ref_to_Global_Var'>current_walfile_name</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN1020"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span>getlasterror<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="receivelog.c.html#LN35"><span class='Ref_to_Global_Var'>lastFlushPosition</span></a> <span class='Operator'>= </span><a href="receivelog.c.html#LN1021"><span class='Ref_to_Parameter'>blockpos</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="receivelog.c.html#LN1025"><span class='Ref_To_Local'>now</span></a> <span class='Operator'>= </span><a href="streamutil.h.html#LN41"><span class='Ref_to_Proto'>feGetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_recvlogical.c.html#LN113"><span class='Ref_to_Func'>sendFeedback</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN1020"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN1021"><span class='Ref_to_Parameter'>blockpos</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN1025"><span class='Ref_To_Local'>now</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="receivelog.c.html#LN1021"><span class='Ref_to_Parameter'>last_status</span></a> <span class='Operator'>= </span><a href="receivelog.c.html#LN1025"><span class='Ref_To_Local'>now</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if replyRequested&&still... &raquo; </span> 
 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ProcessKeepaliveMsg &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Process XLogData message. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1078"></a><span class='Declare_Function'>ProcessXLogDataMsg</span><span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><a href="receivelog.h.html#LN29"><span class='Ref_to_Struct'>StreamCtl</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stream</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>copybuf</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Delimiter'>, 
</span><a name="LN1079"></a>                   <a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>blockpos</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1081"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>xlogoff</span><span class='Delimiter'>; 
</span><a name="LN1082"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>bytes_left</span><span class='Delimiter'>; 
</span><a name="LN1083"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>bytes_written</span><span class='Delimiter'>; 
</span><a name="LN1084"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>hdr_len</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Once we've decided we don't want to receive any more, just ignore any 
     * subsequent XLogData messages. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="receivelog.c.html#LN37"><span class='Ref_to_Global_Var'>still_sending</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Read the header of the XLogData message, enclosed in the CopyData 
     * message. We only need the WAL location field (dataStart), the rest of 
     * the header is ignored. 
     */ 
</span>    <a href="receivelog.c.html#LN1084"><span class='Ref_To_Local'>hdr_len</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>;</span>                <span class='Comment_Single_Line'>/* msgtype 'w' */ 
</span>    <a href="receivelog.c.html#LN1084"><span class='Ref_To_Local'>hdr_len</span></a> <span class='Operator'>+= </span><span class='Number'>8</span><span class='Delimiter'>;</span>               <span class='Comment_Single_Line'>/* dataStart */ 
</span>    <a href="receivelog.c.html#LN1084"><span class='Ref_To_Local'>hdr_len</span></a> <span class='Operator'>+= </span><span class='Number'>8</span><span class='Delimiter'>;</span>               <span class='Comment_Single_Line'>/* walEnd */ 
</span>    <a href="receivelog.c.html#LN1084"><span class='Ref_To_Local'>hdr_len</span></a> <span class='Operator'>+= </span><span class='Number'>8</span><span class='Delimiter'>;</span>               <span class='Comment_Single_Line'>/* sendTime */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN1078"><span class='Ref_to_Parameter'>len</span></a> <span class='Operator'>&LT; </span><a href="receivelog.c.html#LN1084"><span class='Ref_To_Local'>hdr_len</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: streaming header too small: %d\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN1078"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Operator'>*</span><a href="receivelog.c.html#LN1079"><span class='Ref_to_Parameter'>blockpos</span></a> <span class='Operator'>= </span><a href="streamutil.h.html#LN48"><span class='Ref_to_Proto'>fe_recvint64</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="receivelog.c.html#LN1078"><span class='Ref_to_Parameter'>copybuf</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Extract WAL location for this block */ 
</span>    <a href="receivelog.c.html#LN1081"><span class='Ref_To_Local'>xlogoff</span></a> <span class='Operator'>= *</span><a href="receivelog.c.html#LN1079"><span class='Ref_to_Parameter'>blockpos</span></a> <span class='Operator'>% </span>XLOG_SEG_SIZE<span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Verify that the initial location in the stream matches where we think 
     * we are. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN32"><span class='Ref_to_Global_Var'>walfile</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* No file open yet */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN1081"><span class='Ref_To_Local'>xlogoff</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                    _<span class='Parentheses'>(</span><span class='String'>"%s: received write-ahead log record for offset %u with no file open\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN1081"><span class='Ref_To_Local'>xlogoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* More data in existing segment */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN1078"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN61"><span class='Ref_to_Member'>get_current_pos</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN32"><span class='Ref_to_Global_Var'>walfile</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="receivelog.c.html#LN1081"><span class='Ref_To_Local'>xlogoff</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                    _<span class='Parentheses'>(</span><span class='String'>"%s: got WAL data offset %08x, expected %08x\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN1081"><span class='Ref_To_Local'>xlogoff</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="receivelog.c.html#LN1078"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN61"><span class='Ref_to_Member'>get_current_pos</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN32"><span class='Ref_to_Global_Var'>walfile</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="receivelog.c.html#LN1082"><span class='Ref_To_Local'>bytes_left</span></a> <span class='Operator'>= </span><a href="receivelog.c.html#LN1078"><span class='Ref_to_Parameter'>len</span></a> <span class='Operator'>- </span><a href="receivelog.c.html#LN1084"><span class='Ref_To_Local'>hdr_len</span></a><span class='Delimiter'>; 
</span>    <a href="receivelog.c.html#LN1083"><span class='Ref_To_Local'>bytes_written</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN1082"><span class='Ref_To_Local'>bytes_left</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1145"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>bytes_to_write</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If crossing a WAL boundary, only write up until we reach 
         * XLOG_SEG_SIZE. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN1081"><span class='Ref_To_Local'>xlogoff</span></a> <span class='Operator'>+ </span><a href="receivelog.c.html#LN1082"><span class='Ref_To_Local'>bytes_left</span></a> <span class='Operator'>&GT; </span>XLOG_SEG_SIZE<span class='Parentheses'>) 
</span>            <a href="receivelog.c.html#LN1145"><span class='Ref_To_Local'>bytes_to_write</span></a> <span class='Operator'>= </span>XLOG_SEG_SIZE <span class='Operator'>- </span><a href="receivelog.c.html#LN1081"><span class='Ref_To_Local'>xlogoff</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="receivelog.c.html#LN1145"><span class='Ref_To_Local'>bytes_to_write</span></a> <span class='Operator'>= </span><a href="receivelog.c.html#LN1082"><span class='Ref_To_Local'>bytes_left</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN32"><span class='Ref_to_Global_Var'>walfile</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="receivelog.c.html#LN89"><span class='Ref_to_Func'>open_walfile</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN1078"><span class='Ref_to_Parameter'>stream</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="receivelog.c.html#LN1079"><span class='Ref_to_Parameter'>blockpos</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Error logged by open_walfile */ 
</span>                <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN1078"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN58"><span class='Ref_to_Member'>write</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN32"><span class='Ref_to_Global_Var'>walfile</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN1078"><span class='Ref_to_Parameter'>copybuf</span></a> <span class='Operator'>+ </span><a href="receivelog.c.html#LN1084"><span class='Ref_To_Local'>hdr_len</span></a> <span class='Operator'>+ </span><a href="receivelog.c.html#LN1083"><span class='Ref_To_Local'>bytes_written</span></a><span class='Delimiter'>, 
</span>                                     <a href="receivelog.c.html#LN1145"><span class='Ref_To_Local'>bytes_to_write</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="receivelog.c.html#LN1145"><span class='Ref_To_Local'>bytes_to_write</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                  _<span class='Parentheses'>(</span><span class='String'>"%s: could not write %u bytes to WAL file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN1145"><span class='Ref_To_Local'>bytes_to_write</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN33"><span class='Ref_to_Global_Var'>current_walfile_name</span></a><span class='Delimiter'>, 
</span>                    <a href="receivelog.c.html#LN1078"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span>getlasterror<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Write was successful, advance our position */ 
</span>        <a href="receivelog.c.html#LN1083"><span class='Ref_To_Local'>bytes_written</span></a> <span class='Operator'>+= </span><a href="receivelog.c.html#LN1145"><span class='Ref_To_Local'>bytes_to_write</span></a><span class='Delimiter'>; 
</span>        <a href="receivelog.c.html#LN1082"><span class='Ref_To_Local'>bytes_left</span></a> <span class='Operator'>-= </span><a href="receivelog.c.html#LN1145"><span class='Ref_To_Local'>bytes_to_write</span></a><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="receivelog.c.html#LN1079"><span class='Ref_to_Parameter'>blockpos</span></a> <span class='Operator'>+= </span><a href="receivelog.c.html#LN1145"><span class='Ref_To_Local'>bytes_to_write</span></a><span class='Delimiter'>; 
</span>        <a href="receivelog.c.html#LN1081"><span class='Ref_To_Local'>xlogoff</span></a> <span class='Operator'>+= </span><a href="receivelog.c.html#LN1145"><span class='Ref_To_Local'>bytes_to_write</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Did we reach the end of a WAL segment? */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="receivelog.c.html#LN1079"><span class='Ref_to_Parameter'>blockpos</span></a> <span class='Operator'>% </span>XLOG_SEG_SIZE <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="receivelog.c.html#LN180"><span class='Ref_to_Func'>close_walfile</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN1078"><span class='Ref_to_Parameter'>stream</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="receivelog.c.html#LN1079"><span class='Ref_to_Parameter'>blockpos</span></a><span class='Parentheses'>))</span> 
                <span class='Comment_Multi_Line'>/* Error message written in close_walfile() */ 
</span>                <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
            <a href="receivelog.c.html#LN1081"><span class='Ref_To_Local'>xlogoff</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN37"><span class='Ref_to_Global_Var'>still_sending</span></a> <span class='Operator'>&& </span><a href="receivelog.c.html#LN1078"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN42"><span class='Ref_to_Member'>stream_stop</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="receivelog.c.html#LN1079"><span class='Ref_to_Parameter'>blockpos</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN1078"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN32"><span class='Ref_to_Member'>timeline</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN432"><span class='Ref_to_Proto'>PQputCopyEnd</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN1078"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) </span><span class='Operator'>&LT;= </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN451"><span class='Ref_to_Proto'>PQflush</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN1078"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not send copy-end packet: %s"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                            <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN1078"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <a href="receivelog.c.html#LN37"><span class='Ref_to_Global_Var'>still_sending</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* ignore the rest of this XLogData packet */ 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if *blockpos%XLOG_SEG_SI... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while bytes_left &raquo; </span> 
    <span class='Comment_Multi_Line'>/* No more data left to write, receive next copy packet */ 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ProcessXLogDataMsg &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Handle end of the copy stream. 
 */ 
</span><span class='Keyword'>static </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a> <span class='Operator'>* 
</span><a name="LN1212"></a><span class='Declare_Function'>HandleEndOfCopyStream</span><span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><a href="receivelog.h.html#LN29"><span class='Ref_to_Struct'>StreamCtl</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stream</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>copybuf</span><span class='Delimiter'>, 
</span><a name="LN1213"></a>                      <a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>blockpos</span><span class='Delimiter'>, </span><a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stoppos</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1215"></a>    <a href="../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>res</span> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN421"><span class='Ref_to_Proto'>PQgetResult</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN1212"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The server closed its end of the copy stream.  If we haven't closed 
     * ours already, we need to do so now, unless the server threw an error, 
     * in which case we don't. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN37"><span class='Ref_to_Global_Var'>still_sending</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="receivelog.c.html#LN180"><span class='Ref_to_Func'>close_walfile</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN1212"><span class='Ref_to_Parameter'>stream</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN1213"><span class='Ref_to_Parameter'>blockpos</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Error message written in close_walfile() */ 
</span>            <a href="../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN1215"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN1215"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN91"><span class='Ref_to_EnumConst'>PGRES_COPY_IN</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN432"><span class='Ref_to_Proto'>PQputCopyEnd</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN1212"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) </span><span class='Operator'>&LT;= </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN451"><span class='Ref_to_Proto'>PQflush</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN1212"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                        _<span class='Parentheses'>(</span><span class='String'>"%s: could not send copy-end packet: %s"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN1212"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN1215"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="receivelog.c.html#LN1215"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN421"><span class='Ref_to_Proto'>PQgetResult</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN1212"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="receivelog.c.html#LN37"><span class='Ref_to_Global_Var'>still_sending</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if still_sending &raquo; </span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN1212"><span class='Ref_to_Parameter'>copybuf</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../interfaces/libpq/libpq-fe.h.html#LN504"><span class='Ref_to_Proto'>PQfreemem</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN1212"><span class='Ref_to_Parameter'>copybuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="receivelog.c.html#LN1213"><span class='Ref_to_Parameter'>stoppos</span></a> <span class='Operator'>= </span><a href="receivelog.c.html#LN1213"><span class='Ref_to_Parameter'>blockpos</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="receivelog.c.html#LN1215"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end HandleEndOfCopyStream &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Check if we should continue streaming, or abort at this point. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1254"></a><span class='Declare_Function'>CheckCopyStreamStop</span><span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><a href="receivelog.h.html#LN29"><span class='Ref_to_Struct'>StreamCtl</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stream</span><span class='Delimiter'>, </span><a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>blockpos</span><span class='Delimiter'>, 
</span><a name="LN1255"></a>                    <a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stoppos</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN37"><span class='Ref_to_Global_Var'>still_sending</span></a> <span class='Operator'>&& </span><a href="receivelog.c.html#LN1254"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN42"><span class='Ref_to_Member'>stream_stop</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN1254"><span class='Ref_to_Parameter'>blockpos</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN1254"><span class='Ref_to_Parameter'>stream</span></a><span class='Operator'>-&GT;</span><a href="receivelog.h.html#LN32"><span class='Ref_to_Member'>timeline</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="receivelog.c.html#LN180"><span class='Ref_to_Func'>close_walfile</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN1254"><span class='Ref_to_Parameter'>stream</span></a><span class='Delimiter'>, </span><a href="receivelog.c.html#LN1254"><span class='Ref_to_Parameter'>blockpos</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Potential error message is written by close_walfile */ 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN432"><span class='Ref_to_Proto'>PQputCopyEnd</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN1254"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) </span><span class='Operator'>&LT;= </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN451"><span class='Ref_to_Proto'>PQflush</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN1254"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not send copy-end packet: %s"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN1254"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="receivelog.c.html#LN37"><span class='Ref_to_Global_Var'>still_sending</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CheckCopyStreamStop &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Calculate how long send/receive loops should sleep 
 */ 
</span><span class='Keyword'>static long 
</span><a name="LN1280"></a><span class='Declare_Function'>CalculateCopyStreamSleeptime</span><span class='Parentheses'>(</span><a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Parameter'>now</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>standby_message_timeout</span><span class='Delimiter'>, 
</span><a name="LN1281"></a>                             <a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Parameter'>last_status</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1283"></a>    <a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>status_targettime</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1284"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>sleeptime</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN1280"><span class='Ref_to_Parameter'>standby_message_timeout</span></a> <span class='Operator'>&& </span><a href="receivelog.c.html#LN37"><span class='Ref_to_Global_Var'>still_sending</span></a><span class='Parentheses'>) 
</span>        <a href="receivelog.c.html#LN1283"><span class='Ref_To_Local'>status_targettime</span></a> <span class='Operator'>= </span><a href="receivelog.c.html#LN1281"><span class='Ref_to_Parameter'>last_status</span></a> <span class='Operator'>+ 
</span>            <span class='Parentheses'>(</span><a href="receivelog.c.html#LN1280"><span class='Ref_to_Parameter'>standby_message_timeout</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Parentheses'>((</span><a href="../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a><span class='Parentheses'>) </span><span class='Number'>1000</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN1283"><span class='Ref_To_Local'>status_targettime</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1292"></a>        <span class='Keyword'>long</span>        <span class='Declare_Local'>secs</span><span class='Delimiter'>; 
</span><a name="LN1293"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>usecs</span><span class='Delimiter'>; 
</span> 
        <a href="streamutil.h.html#LN42"><span class='Ref_to_Proto'>feTimestampDifference</span></a><span class='Parentheses'>(</span><a href="receivelog.c.html#LN1280"><span class='Ref_to_Parameter'>now</span></a><span class='Delimiter'>, 
</span>                              <a href="receivelog.c.html#LN1283"><span class='Ref_To_Local'>status_targettime</span></a><span class='Delimiter'>, 
</span>                              <span class='Operator'>&</span><a href="receivelog.c.html#LN1292"><span class='Ref_To_Local'>secs</span></a><span class='Delimiter'>, 
</span>                              <span class='Operator'>&</span><a href="receivelog.c.html#LN1293"><span class='Ref_To_Local'>usecs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* Always sleep at least 1 sec */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="receivelog.c.html#LN1292"><span class='Ref_To_Local'>secs</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="receivelog.c.html#LN1292"><span class='Ref_To_Local'>secs</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <a href="receivelog.c.html#LN1293"><span class='Ref_To_Local'>usecs</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="receivelog.c.html#LN1284"><span class='Ref_To_Local'>sleeptime</span></a> <span class='Operator'>= </span><a href="receivelog.c.html#LN1292"><span class='Ref_To_Local'>secs</span></a> <span class='Operator'>* </span><span class='Number'>1000</span> <span class='Operator'>+ </span><a href="receivelog.c.html#LN1293"><span class='Ref_To_Local'>usecs</span></a> <span class='Operator'>/ </span><span class='Number'>1000</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="receivelog.c.html#LN1284"><span class='Ref_To_Local'>sleeptime</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="receivelog.c.html#LN1284"><span class='Ref_To_Local'>sleeptime</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CalculateCopyStreamSleeptime &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>