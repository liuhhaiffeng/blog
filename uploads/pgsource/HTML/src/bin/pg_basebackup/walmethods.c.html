<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\bin\pg_basebackup\walmethods.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\bin\pg_basebackup\walmethods.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:59 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
</span><span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * walmethods.c - implementations of different ways to write received wal 
 * 
 * NOTE! The caller must ensure that only one method is instantiated in 
 *       any given program, and that it's only instantiated once! 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * 
 * IDENTIFICATION 
 *        src/bin/pg_basebackup/walmethods.c 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres_fe.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/stat.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;time.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
<span class='Directive'>#ifdef</span> HAVE_LIBZ 
<span class='Keyword'>#include </span><span class='String'>&LT;zlib.h&GT;</span> 
<span class='Directive'>#endif</span> 
 
<span class='Keyword'>#include </span><span class='String'>"pgtar.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"common/file_utils.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"receivelog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"streamutil.h"</span> 
 
<span class='Comment_Multi_Line'>/* Size of zlib buffer for .tar.gz */ 
</span><a name="LN30"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>ZLIB_OUT_SIZE</span> <span class='Number'>4096</span> 
 
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * WalDirectoryMethod - write wal to a directory looking like pg_xlog 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Global static data for this method 
 */ 
</span><a name="LN40"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>DirectoryMethodData</span> 
<span class='Delimiter'>{ 
</span><a name="LN42"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Member'>basedir</span><span class='Delimiter'>; 
</span><a name="LN43"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>compression</span><span class='Delimiter'>; 
</span><a name="LN44"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>sync</span><span class='Delimiter'>; 
</span><a name="LN45"></a>} <span class='Declare_Typedef'>DirectoryMethodData</span><span class='Delimiter'>; 
</span><a name="LN46"></a><span class='Keyword'>static </span><a href="walmethods.c.html#LN40"><span class='Ref_to_Struct'>DirectoryMethodData</span></a> <span class='Operator'>*</span><span class='Declare_Var'>dir_data</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Local file handle 
 */ 
</span><a name="LN51"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>DirectoryMethodFile</span> 
<span class='Delimiter'>{ 
</span><a name="LN53"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>fd</span><span class='Delimiter'>; 
</span><a name="LN54"></a>    off_t       <span class='Declare_Member'>currpos</span><span class='Delimiter'>; 
</span><a name="LN55"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Member'>pathname</span><span class='Delimiter'>; 
</span><a name="LN56"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Member'>fullpath</span><span class='Delimiter'>; 
</span><a name="LN57"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Member'>temp_suffix</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> HAVE_LIBZ 
<a name="LN59"></a>    gzFile      <span class='Declare_Member'>gzfp</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<a name="LN61"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>DirectoryMethodFile</span><span class='Delimiter'>; 
</span> 
<span class='Keyword'>static const char </span><span class='Operator'>* 
</span><a name="LN64"></a><span class='Declare_Function'>dir_getlasterror</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Directory method always sets errno, so just use strerror */ 
</span>    <span class='Control'>return</span> <a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static </span><a href="walmethods.h.html#LN12"><span class='Ref_to_Typedef'>Walfile</span></a> 
<a name="LN71"></a><span class='Declare_Function'>dir_open_for_write</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>pathname</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>temp_suffix</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>pad_to_size</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN73"></a>    <span class='Keyword'>static char </span><span class='Declare_Local'>tmppath</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN74"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>fd</span><span class='Delimiter'>; 
</span><a name="LN75"></a>    <a href="walmethods.c.html#LN51"><span class='Ref_to_Struct'>DirectoryMethodFile</span></a> <span class='Operator'>*</span><span class='Declare_Local'>f</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> HAVE_LIBZ 
<a name="LN77"></a>    gzFile      <span class='Declare_Local'>gzfp</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN73"><span class='Ref_To_Local'>tmppath</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="walmethods.c.html#LN73"><span class='Ref_To_Local'>tmppath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/%s%s%s"</span><span class='Delimiter'>, 
</span>             <a href="walmethods.c.html#LN46"><span class='Ref_to_Global_Var'>dir_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN42"><span class='Ref_to_Member'>basedir</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN71"><span class='Ref_to_Parameter'>pathname</span></a><span class='Delimiter'>, 
</span>             <a href="walmethods.c.html#LN46"><span class='Ref_to_Global_Var'>dir_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN43"><span class='Ref_to_Member'>compression</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>? </span><span class='String'>".gz"</span> <span class='Operator'>: </span><span class='String'>""</span><span class='Delimiter'>, 
</span>             <a href="walmethods.c.html#LN71"><span class='Ref_to_Parameter'>temp_suffix</span></a> <span class='Operator'>? </span><a href="walmethods.c.html#LN71"><span class='Ref_to_Parameter'>temp_suffix</span></a> <span class='Operator'>: </span><span class='String'>""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Open a file for non-compressed as well as compressed files. Tracking 
     * the file descriptor is important for dir_sync() method as gzflush() 
     * does not do any system calls to fsync() to make changes permanent on 
     * disk. 
     */ 
</span>    <a href="walmethods.c.html#LN74"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN289"><span class='Ref_to_Macro'>open</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN73"><span class='Ref_To_Local'>tmppath</span></a><span class='Delimiter'>, </span>O_WRONLY <span class='Operator'>| </span>O_CREAT <span class='Operator'>| </span><a href="../../include/c.h.html#LN1032"><span class='Ref_to_Const'>PG_BINARY</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN424"><span class='Ref_to_Const'>S_IRUSR</span></a> <span class='Operator'>| </span><a href="../../include/port/win32.h.html#LN425"><span class='Ref_to_Const'>S_IWUSR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN74"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> HAVE_LIBZ 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN46"><span class='Ref_to_Global_Var'>dir_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN43"><span class='Ref_to_Member'>compression</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="walmethods.c.html#LN77"><span class='Ref_To_Local'>gzfp</span></a> <span class='Operator'>= </span>gzdopen<span class='Parentheses'>(</span><a href="walmethods.c.html#LN74"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><span class='String'>"wb"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN77"><span class='Ref_To_Local'>gzfp</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN74"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>gzsetparams<span class='Parentheses'>(</span><a href="walmethods.c.html#LN77"><span class='Ref_To_Local'>gzfp</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN46"><span class='Ref_to_Global_Var'>dir_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN43"><span class='Ref_to_Member'>compression</span></a><span class='Delimiter'>, 
</span>                        Z_DEFAULT_STRATEGY<span class='Parentheses'>) </span><span class='Operator'>!= </span>Z_OK<span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            gzclose<span class='Parentheses'>(</span><a href="walmethods.c.html#LN77"><span class='Ref_To_Local'>gzfp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* Do pre-padding on non-compressed files */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN71"><span class='Ref_to_Parameter'>pad_to_size</span></a> <span class='Operator'>&& </span><a href="walmethods.c.html#LN46"><span class='Ref_to_Global_Var'>dir_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN43"><span class='Ref_to_Member'>compression</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN117"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>zerobuf</span><span class='Delimiter'>; 
</span><a name="LN118"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>bytes</span><span class='Delimiter'>; 
</span> 
        <a href="walmethods.c.html#LN117"><span class='Ref_To_Local'>zerobuf</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN26"><span class='Ref_to_Proto'>pg_malloc0</span></a><span class='Parentheses'>(</span>XLOG_BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN118"><span class='Ref_To_Local'>bytes</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="walmethods.c.html#LN118"><span class='Ref_To_Local'>bytes</span></a> <span class='Operator'>&LT; </span><a href="walmethods.c.html#LN71"><span class='Ref_to_Parameter'>pad_to_size</span></a><span class='Delimiter'>; </span><a href="walmethods.c.html#LN118"><span class='Ref_To_Local'>bytes</span></a> <span class='Operator'>+= </span>XLOG_BLCKSZ<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/win32.h.html#LN13"><span class='Ref_to_Macro'>write</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN74"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN117"><span class='Ref_To_Local'>zerobuf</span></a><span class='Delimiter'>, </span>XLOG_BLCKSZ<span class='Parentheses'>) </span><span class='Operator'>!= </span>XLOG_BLCKSZ<span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span><a name="LN125"></a>                <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
                <a href="../../include/common/fe_memutils.h.html#LN29"><span class='Ref_to_Proto'>pg_free</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN117"><span class='Ref_To_Local'>zerobuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN74"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                errno <span class='Operator'>= </span><a href="walmethods.c.html#LN125"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../include/common/fe_memutils.h.html#LN29"><span class='Ref_to_Proto'>pg_free</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN117"><span class='Ref_To_Local'>zerobuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>lseek<span class='Parentheses'>(</span><a href="walmethods.c.html#LN74"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span>SEEK_SET<span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><a name="LN137"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
            <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN74"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            errno <span class='Operator'>= </span><a href="walmethods.c.html#LN137"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if pad_to_size&&dir_data... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * fsync WAL file and containing directory, to ensure the file is 
     * persistently created and zeroed (if padded). That's particularly 
     * important when using synchronous mode, where the file is modified and 
     * fsynced in-place, without a directory fsync. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN46"><span class='Ref_to_Global_Var'>dir_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN44"><span class='Ref_to_Member'>sync</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/common/file_utils.h.html#LN17"><span class='Ref_to_Proto'>fsync_fname</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN73"><span class='Ref_To_Local'>tmppath</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>            <a href="../../include/common/file_utils.h.html#LN24"><span class='Ref_to_Proto'>fsync_parent_path</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN73"><span class='Ref_To_Local'>tmppath</span></a><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> HAVE_LIBZ 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN46"><span class='Ref_to_Global_Var'>dir_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN43"><span class='Ref_to_Member'>compression</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                gzclose<span class='Parentheses'>(</span><a href="walmethods.c.html#LN77"><span class='Ref_To_Local'>gzfp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
<span class='Directive'>#endif</span> 
                <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN74"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="walmethods.c.html#LN75"><span class='Ref_To_Local'>f</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN26"><span class='Ref_to_Proto'>pg_malloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="walmethods.c.html#LN51"><span class='Ref_to_Struct'>DirectoryMethodFile</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> HAVE_LIBZ 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN46"><span class='Ref_to_Global_Var'>dir_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN43"><span class='Ref_to_Member'>compression</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="walmethods.c.html#LN75"><span class='Ref_To_Local'>f</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN59"><span class='Ref_to_Member'>gzfp</span></a> <span class='Operator'>= </span><a href="walmethods.c.html#LN77"><span class='Ref_To_Local'>gzfp</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <a href="walmethods.c.html#LN75"><span class='Ref_To_Local'>f</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN53"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>= </span><a href="walmethods.c.html#LN74"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>; 
</span>    <a href="walmethods.c.html#LN75"><span class='Ref_To_Local'>f</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN54"><span class='Ref_to_Member'>currpos</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="walmethods.c.html#LN75"><span class='Ref_To_Local'>f</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN55"><span class='Ref_to_Member'>pathname</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN24"><span class='Ref_to_Proto'>pg_strdup</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN71"><span class='Ref_to_Parameter'>pathname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="walmethods.c.html#LN75"><span class='Ref_To_Local'>f</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN56"><span class='Ref_to_Member'>fullpath</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN24"><span class='Ref_to_Proto'>pg_strdup</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN73"><span class='Ref_To_Local'>tmppath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN71"><span class='Ref_to_Parameter'>temp_suffix</span></a><span class='Parentheses'>) 
</span>        <a href="walmethods.c.html#LN75"><span class='Ref_To_Local'>f</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN57"><span class='Ref_to_Member'>temp_suffix</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN24"><span class='Ref_to_Proto'>pg_strdup</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN71"><span class='Ref_to_Parameter'>temp_suffix</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="walmethods.c.html#LN75"><span class='Ref_To_Local'>f</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dir_open_for_write &raquo; </span> 
 
<span class='Keyword'>static </span><a href="../../include/port/win32.h.html#LN419"><span class='Ref_to_Typedef'>ssize_t</span></a> 
<a name="LN182"></a><span class='Declare_Function'>dir_write</span><span class='Parentheses'>(</span><a href="walmethods.h.html#LN12"><span class='Ref_to_Typedef'>Walfile</span></a> <span class='Declare_Parameter'>f</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>count</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN184"></a>    <a href="../../include/port/win32.h.html#LN419"><span class='Ref_to_Typedef'>ssize_t</span></a>     <span class='Declare_Local'>r</span><span class='Delimiter'>; 
</span><a name="LN185"></a>    <a href="walmethods.c.html#LN51"><span class='Ref_to_Struct'>DirectoryMethodFile</span></a> <span class='Operator'>*</span><span class='Declare_Local'>df</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="walmethods.c.html#LN51"><span class='Ref_to_Struct'>DirectoryMethodFile</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="walmethods.c.html#LN182"><span class='Ref_to_Parameter'>f</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="walmethods.c.html#LN182"><span class='Ref_to_Parameter'>f</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> HAVE_LIBZ 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN46"><span class='Ref_to_Global_Var'>dir_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN43"><span class='Ref_to_Member'>compression</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="walmethods.c.html#LN184"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN419"><span class='Ref_to_Typedef'>ssize_t</span></a><span class='Parentheses'>) </span>gzwrite<span class='Parentheses'>(</span><a href="walmethods.c.html#LN185"><span class='Ref_To_Local'>df</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN59"><span class='Ref_to_Member'>gzfp</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN182"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN182"><span class='Ref_to_Parameter'>count</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
<span class='Directive'>#endif</span> 
        <a href="walmethods.c.html#LN184"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/win32.h.html#LN13"><span class='Ref_to_Macro'>write</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN185"><span class='Ref_To_Local'>df</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN53"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN182"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN182"><span class='Ref_to_Parameter'>count</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN184"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="walmethods.c.html#LN185"><span class='Ref_To_Local'>df</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN54"><span class='Ref_to_Member'>currpos</span></a> <span class='Operator'>+= </span><a href="walmethods.c.html#LN184"><span class='Ref_To_Local'>r</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="walmethods.c.html#LN184"><span class='Ref_To_Local'>r</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static </span>off_t 
<a name="LN201"></a><span class='Declare_Function'>dir_get_current_pos</span><span class='Parentheses'>(</span><a href="walmethods.h.html#LN12"><span class='Ref_to_Typedef'>Walfile</span></a> <span class='Declare_Parameter'>f</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="walmethods.c.html#LN201"><span class='Ref_to_Parameter'>f</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Use a cached value to prevent lots of reseeks */ 
</span>    <span class='Control'>return</span> <span class='Parentheses'>((</span><a href="walmethods.c.html#LN51"><span class='Ref_to_Struct'>DirectoryMethodFile</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="walmethods.c.html#LN201"><span class='Ref_to_Parameter'>f</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>currpos<span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static int 
</span><a name="LN210"></a><span class='Declare_Function'>dir_close</span><span class='Parentheses'>(</span><a href="walmethods.h.html#LN12"><span class='Ref_to_Typedef'>Walfile</span></a> <span class='Declare_Parameter'>f</span><span class='Delimiter'>, </span><a href="walmethods.h.html#LN14"><span class='Ref_to_Typedef'>WalCloseMethod</span></a> <span class='Declare_Parameter'>method</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN212"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>r</span><span class='Delimiter'>; 
</span><a name="LN213"></a>    <a href="walmethods.c.html#LN51"><span class='Ref_to_Struct'>DirectoryMethodFile</span></a> <span class='Operator'>*</span><span class='Declare_Local'>df</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="walmethods.c.html#LN51"><span class='Ref_to_Struct'>DirectoryMethodFile</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="walmethods.c.html#LN210"><span class='Ref_to_Parameter'>f</span></a><span class='Delimiter'>; 
</span><a name="LN214"></a>    <span class='Keyword'>static char </span><span class='Declare_Local'>tmppath</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN215"></a>    <span class='Keyword'>static char </span><span class='Declare_Local'>tmppath2</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="walmethods.c.html#LN210"><span class='Ref_to_Parameter'>f</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> HAVE_LIBZ 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN46"><span class='Ref_to_Global_Var'>dir_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN43"><span class='Ref_to_Member'>compression</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="walmethods.c.html#LN212"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span>gzclose<span class='Parentheses'>(</span><a href="walmethods.c.html#LN213"><span class='Ref_To_Local'>df</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN59"><span class='Ref_to_Member'>gzfp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
<span class='Directive'>#endif</span> 
        <a href="walmethods.c.html#LN212"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN213"><span class='Ref_To_Local'>df</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN53"><span class='Ref_to_Member'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN212"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Build path to the current version of the file */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN210"><span class='Ref_to_Parameter'>method</span></a> <span class='Operator'>== </span><a href="walmethods.h.html#LN16"><span class='Ref_to_EnumConst'>CLOSE_NORMAL</span></a> <span class='Operator'>&& </span><a href="walmethods.c.html#LN213"><span class='Ref_To_Local'>df</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN57"><span class='Ref_to_Member'>temp_suffix</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * If we have a temp prefix, normal operation is to rename the 
             * file. 
             */ 
</span>            <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN214"><span class='Ref_To_Local'>tmppath</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="walmethods.c.html#LN214"><span class='Ref_To_Local'>tmppath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/%s%s%s"</span><span class='Delimiter'>, 
</span>                     <a href="walmethods.c.html#LN46"><span class='Ref_to_Global_Var'>dir_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN42"><span class='Ref_to_Member'>basedir</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN213"><span class='Ref_To_Local'>df</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN55"><span class='Ref_to_Member'>pathname</span></a><span class='Delimiter'>, 
</span>                     <a href="walmethods.c.html#LN46"><span class='Ref_to_Global_Var'>dir_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN43"><span class='Ref_to_Member'>compression</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>? </span><span class='String'>".gz"</span> <span class='Operator'>: </span><span class='String'>""</span><span class='Delimiter'>, 
</span>                     <a href="walmethods.c.html#LN213"><span class='Ref_To_Local'>df</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN57"><span class='Ref_to_Member'>temp_suffix</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN215"><span class='Ref_To_Local'>tmppath2</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="walmethods.c.html#LN215"><span class='Ref_To_Local'>tmppath2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/%s%s"</span><span class='Delimiter'>, 
</span>                     <a href="walmethods.c.html#LN46"><span class='Ref_to_Global_Var'>dir_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN42"><span class='Ref_to_Member'>basedir</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN213"><span class='Ref_To_Local'>df</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN55"><span class='Ref_to_Member'>pathname</span></a><span class='Delimiter'>, 
</span>                     <a href="walmethods.c.html#LN46"><span class='Ref_to_Global_Var'>dir_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN43"><span class='Ref_to_Member'>compression</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>? </span><span class='String'>".gz"</span> <span class='Operator'>: </span><span class='String'>""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="walmethods.c.html#LN212"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="../../include/common/file_utils.h.html#LN22"><span class='Ref_to_Proto'>durable_rename</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN214"><span class='Ref_To_Local'>tmppath</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN215"><span class='Ref_To_Local'>tmppath2</span></a><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN210"><span class='Ref_to_Parameter'>method</span></a> <span class='Operator'>== </span><a href="walmethods.h.html#LN17"><span class='Ref_to_EnumConst'>CLOSE_UNLINK</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Unlink the file once it's closed */ 
</span>            <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN214"><span class='Ref_To_Local'>tmppath</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="walmethods.c.html#LN214"><span class='Ref_To_Local'>tmppath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/%s%s%s"</span><span class='Delimiter'>, 
</span>                     <a href="walmethods.c.html#LN46"><span class='Ref_to_Global_Var'>dir_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN42"><span class='Ref_to_Member'>basedir</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN213"><span class='Ref_To_Local'>df</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN55"><span class='Ref_to_Member'>pathname</span></a><span class='Delimiter'>, 
</span>                     <a href="walmethods.c.html#LN46"><span class='Ref_to_Global_Var'>dir_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN43"><span class='Ref_to_Member'>compression</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>? </span><span class='String'>".gz"</span> <span class='Operator'>: </span><span class='String'>""</span><span class='Delimiter'>, 
</span>                     <a href="walmethods.c.html#LN213"><span class='Ref_To_Local'>df</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN57"><span class='Ref_to_Member'>temp_suffix</span></a> <span class='Operator'>? </span><a href="walmethods.c.html#LN213"><span class='Ref_To_Local'>df</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN57"><span class='Ref_to_Member'>temp_suffix</span></a> <span class='Operator'>: </span><span class='String'>""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="walmethods.c.html#LN212"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN214"><span class='Ref_To_Local'>tmppath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Else either CLOSE_NORMAL and no temp suffix, or 
             * CLOSE_NO_RENAME. In this case, fsync the file and containing 
             * directory if sync mode is requested. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN46"><span class='Ref_to_Global_Var'>dir_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN44"><span class='Ref_to_Member'>sync</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="walmethods.c.html#LN212"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="../../include/common/file_utils.h.html#LN17"><span class='Ref_to_Proto'>fsync_fname</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN213"><span class='Ref_To_Local'>df</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN56"><span class='Ref_to_Member'>fullpath</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN212"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                    <a href="walmethods.c.html#LN212"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="../../include/common/file_utils.h.html#LN24"><span class='Ref_to_Proto'>fsync_parent_path</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN213"><span class='Ref_To_Local'>df</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN56"><span class='Ref_to_Member'>fullpath</span></a><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if r==0 &raquo; </span> 
 
    <a href="../../include/common/fe_memutils.h.html#LN29"><span class='Ref_to_Proto'>pg_free</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN213"><span class='Ref_To_Local'>df</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN55"><span class='Ref_to_Member'>pathname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/fe_memutils.h.html#LN29"><span class='Ref_to_Proto'>pg_free</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN213"><span class='Ref_To_Local'>df</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN56"><span class='Ref_to_Member'>fullpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN213"><span class='Ref_To_Local'>df</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN57"><span class='Ref_to_Member'>temp_suffix</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/common/fe_memutils.h.html#LN29"><span class='Ref_to_Proto'>pg_free</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN213"><span class='Ref_To_Local'>df</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN57"><span class='Ref_to_Member'>temp_suffix</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/fe_memutils.h.html#LN29"><span class='Ref_to_Proto'>pg_free</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN213"><span class='Ref_To_Local'>df</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="walmethods.c.html#LN212"><span class='Ref_To_Local'>r</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dir_close &raquo; </span> 
 
<span class='Keyword'>static int 
</span><a name="LN279"></a><span class='Declare_Function'>dir_sync</span><span class='Parentheses'>(</span><a href="walmethods.h.html#LN12"><span class='Ref_to_Typedef'>Walfile</span></a> <span class='Declare_Parameter'>f</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="walmethods.c.html#LN279"><span class='Ref_to_Parameter'>f</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="walmethods.c.html#LN46"><span class='Ref_to_Global_Var'>dir_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN44"><span class='Ref_to_Member'>sync</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> HAVE_LIBZ 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN46"><span class='Ref_to_Global_Var'>dir_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN43"><span class='Ref_to_Member'>compression</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>gzflush<span class='Parentheses'>(((</span><a href="walmethods.c.html#LN51"><span class='Ref_to_Struct'>DirectoryMethodFile</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="walmethods.c.html#LN279"><span class='Ref_to_Parameter'>f</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>gzfp<span class='Delimiter'>, </span>Z_SYNC_FLUSH<span class='Parentheses'>)</span> <span class='Operator'>!= </span>Z_OK<span class='Parentheses'>)</span> 
            <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
    <span class='Control'>return</span> <a href="../../include/port/win32.h.html#LN61"><span class='Ref_to_Macro'>fsync</span></a><span class='Parentheses'>(((</span><a href="walmethods.c.html#LN51"><span class='Ref_to_Struct'>DirectoryMethodFile</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="walmethods.c.html#LN279"><span class='Ref_to_Parameter'>f</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>fd<span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static </span><a href="../../include/port/win32.h.html#LN419"><span class='Ref_to_Typedef'>ssize_t</span></a> 
<a name="LN298"></a><span class='Declare_Function'>dir_get_file_size</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>pathname</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN300"></a>    <span class='Control'>struct</span> <a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>statbuf</span><span class='Delimiter'>; 
</span><a name="LN301"></a>    <span class='Keyword'>static char </span><span class='Declare_Local'>tmppath</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span> 
    <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN301"><span class='Ref_To_Local'>tmppath</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="walmethods.c.html#LN301"><span class='Ref_To_Local'>tmppath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/%s"</span><span class='Delimiter'>, 
</span>             <a href="walmethods.c.html#LN46"><span class='Ref_to_Global_Var'>dir_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN42"><span class='Ref_to_Member'>basedir</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN298"><span class='Ref_to_Parameter'>pathname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN301"><span class='Ref_To_Local'>tmppath</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="walmethods.c.html#LN300"><span class='Ref_To_Local'>statbuf</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="walmethods.c.html#LN300"><span class='Ref_To_Local'>statbuf</span></a><span class='Operator'>.</span>st_size<span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static bool 
</span><a name="LN313"></a><span class='Declare_Function'>dir_existsfile</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>pathname</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN315"></a>    <span class='Keyword'>static char </span><span class='Declare_Local'>tmppath</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN316"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>fd</span><span class='Delimiter'>; 
</span> 
    <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN315"><span class='Ref_To_Local'>tmppath</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="walmethods.c.html#LN315"><span class='Ref_To_Local'>tmppath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/%s"</span><span class='Delimiter'>, 
</span>             <a href="walmethods.c.html#LN46"><span class='Ref_to_Global_Var'>dir_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN42"><span class='Ref_to_Member'>basedir</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN313"><span class='Ref_to_Parameter'>pathname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="walmethods.c.html#LN316"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN289"><span class='Ref_to_Macro'>open</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN315"><span class='Ref_To_Local'>tmppath</span></a><span class='Delimiter'>, </span>O_RDONLY <span class='Operator'>| </span><a href="../../include/c.h.html#LN1032"><span class='Ref_to_Const'>PG_BINARY</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN316"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN316"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static bool 
</span><a name="LN329"></a><span class='Declare_Function'>dir_finish</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN46"><span class='Ref_to_Global_Var'>dir_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN44"><span class='Ref_to_Member'>sync</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Files are fsynced when they are closed, but we need to fsync the 
         * directory entry here as well. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/common/file_utils.h.html#LN17"><span class='Ref_to_Proto'>fsync_fname</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN46"><span class='Ref_to_Global_Var'>dir_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN42"><span class='Ref_to_Member'>basedir</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
} 
</span> 
 
<a href="walmethods.h.html#LN32"><span class='Ref_to_Struct'>WalWriteMethod</span></a> <span class='Operator'>* 
</span><a name="LN345"></a><span class='Declare_Function'>CreateWalDirectoryMethod</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>basedir</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>compression</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>sync</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN347"></a>    <a href="walmethods.h.html#LN32"><span class='Ref_to_Struct'>WalWriteMethod</span></a> <span class='Operator'>*</span><span class='Declare_Local'>method</span><span class='Delimiter'>; 
</span> 
    <a href="walmethods.c.html#LN347"><span class='Ref_To_Local'>method</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN26"><span class='Ref_to_Proto'>pg_malloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="walmethods.h.html#LN32"><span class='Ref_to_Struct'>WalWriteMethod</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="walmethods.c.html#LN347"><span class='Ref_To_Local'>method</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN40"><span class='Ref_to_Member'>open_for_write</span></a> <span class='Operator'>= </span><a href="walmethods.c.html#LN70"><span class='Ref_to_Func'>dir_open_for_write</span></a><span class='Delimiter'>; 
</span>    <a href="walmethods.c.html#LN347"><span class='Ref_To_Local'>method</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN58"><span class='Ref_to_Member'>write</span></a> <span class='Operator'>= </span><a href="walmethods.c.html#LN181"><span class='Ref_to_Func'>dir_write</span></a><span class='Delimiter'>; 
</span>    <a href="walmethods.c.html#LN347"><span class='Ref_To_Local'>method</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN61"><span class='Ref_to_Member'>get_current_pos</span></a> <span class='Operator'>= </span><a href="walmethods.c.html#LN200"><span class='Ref_to_Func'>dir_get_current_pos</span></a><span class='Delimiter'>; 
</span>    <a href="walmethods.c.html#LN347"><span class='Ref_To_Local'>method</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN52"><span class='Ref_to_Member'>get_file_size</span></a> <span class='Operator'>= </span><a href="walmethods.c.html#LN297"><span class='Ref_to_Func'>dir_get_file_size</span></a><span class='Delimiter'>; 
</span>    <a href="walmethods.c.html#LN347"><span class='Ref_To_Local'>method</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN46"><span class='Ref_to_Member'>close</span></a> <span class='Operator'>= </span><a href="walmethods.c.html#LN209"><span class='Ref_to_Func'>dir_close</span></a><span class='Delimiter'>; 
</span>    <a href="walmethods.c.html#LN347"><span class='Ref_To_Local'>method</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN66"><span class='Ref_to_Member'>sync</span></a> <span class='Operator'>= </span><a href="walmethods.c.html#LN278"><span class='Ref_to_Func'>dir_sync</span></a><span class='Delimiter'>; 
</span>    <a href="walmethods.c.html#LN347"><span class='Ref_To_Local'>method</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN49"><span class='Ref_to_Member'>existsfile</span></a> <span class='Operator'>= </span><a href="walmethods.c.html#LN312"><span class='Ref_to_Func'>dir_existsfile</span></a><span class='Delimiter'>; 
</span>    <a href="walmethods.c.html#LN347"><span class='Ref_To_Local'>method</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN74"><span class='Ref_to_Member'>finish</span></a> <span class='Operator'>= </span><a href="walmethods.c.html#LN328"><span class='Ref_to_Func'>dir_finish</span></a><span class='Delimiter'>; 
</span>    <a href="walmethods.c.html#LN347"><span class='Ref_To_Local'>method</span></a><span class='Operator'>-&GT;</span>getlasterror <span class='Operator'>= </span><a href="walmethods.c.html#LN63"><span class='Ref_to_Func'>dir_getlasterror</span></a><span class='Delimiter'>; 
</span> 
    <a href="walmethods.c.html#LN46"><span class='Ref_to_Global_Var'>dir_data</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN26"><span class='Ref_to_Proto'>pg_malloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="walmethods.c.html#LN40"><span class='Ref_to_Struct'>DirectoryMethodData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="walmethods.c.html#LN46"><span class='Ref_to_Global_Var'>dir_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN43"><span class='Ref_to_Member'>compression</span></a> <span class='Operator'>= </span><a href="walmethods.c.html#LN345"><span class='Ref_to_Parameter'>compression</span></a><span class='Delimiter'>; 
</span>    <a href="walmethods.c.html#LN46"><span class='Ref_to_Global_Var'>dir_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN42"><span class='Ref_to_Member'>basedir</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN24"><span class='Ref_to_Proto'>pg_strdup</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN345"><span class='Ref_to_Parameter'>basedir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="walmethods.c.html#LN46"><span class='Ref_to_Global_Var'>dir_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN44"><span class='Ref_to_Member'>sync</span></a> <span class='Operator'>= </span><a href="walmethods.c.html#LN345"><span class='Ref_to_Parameter'>sync</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="walmethods.c.html#LN347"><span class='Ref_To_Local'>method</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CreateWalDirectoryMethod &raquo; </span> 
 
<span class='Keyword'>void 
</span><a name="LN369"></a><span class='Declare_Function'>FreeWalDirectoryMethod</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../include/common/fe_memutils.h.html#LN29"><span class='Ref_to_Proto'>pg_free</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN46"><span class='Ref_to_Global_Var'>dir_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN42"><span class='Ref_to_Member'>basedir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/fe_memutils.h.html#LN29"><span class='Ref_to_Proto'>pg_free</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN46"><span class='Ref_to_Global_Var'>dir_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * WalTarMethod - write wal to a tar file containing pg_xlog contents 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<a name="LN381"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>TarMethodFile</span> 
<span class='Delimiter'>{ 
</span><a name="LN383"></a>    off_t       <span class='Declare_Member'>ofs_start</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* Where does the *header* for this file start */ 
</span><a name="LN384"></a>    off_t       <span class='Declare_Member'>currpos</span><span class='Delimiter'>; 
</span><a name="LN385"></a>    <span class='Keyword'>char</span>        <span class='Declare_Member'>header</span><span class='Delimiter'>[</span><span class='Number'>512</span><span class='Delimiter'>]; 
</span><a name="LN386"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Member'>pathname</span><span class='Delimiter'>; 
</span><a name="LN387"></a>    size_t      <span class='Declare_Member'>pad_to_size</span><span class='Delimiter'>; 
</span><a name="LN388"></a>} <span class='Declare_Typedef'>TarMethodFile</span><span class='Delimiter'>; 
</span> 
<a name="LN390"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>TarMethodData</span> 
<span class='Delimiter'>{ 
</span><a name="LN392"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Member'>tarfilename</span><span class='Delimiter'>; 
</span><a name="LN393"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>fd</span><span class='Delimiter'>; 
</span><a name="LN394"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>compression</span><span class='Delimiter'>; 
</span><a name="LN395"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>sync</span><span class='Delimiter'>; 
</span><a name="LN396"></a>    <a href="walmethods.c.html#LN381"><span class='Ref_to_Struct'>TarMethodFile</span></a> <span class='Operator'>*</span><span class='Declare_Member'>currentfile</span><span class='Delimiter'>; 
</span><a name="LN397"></a>    <span class='Keyword'>char</span>        <span class='Declare_Member'>lasterror</span><span class='Delimiter'>[</span><span class='Number'>1024</span><span class='Delimiter'>]; 
</span><span class='Directive'>#ifdef</span> HAVE_LIBZ 
<a name="LN399"></a>    <a href="../pg_dump/pg_backup_archiver.h.html#LN61"><span class='Ref_to_Typedef'>z_streamp</span></a>   <span class='Declare_Member'>zp</span><span class='Delimiter'>; 
</span><a name="LN400"></a>    <span class='Keyword'>void</span>       <span class='Operator'>*</span><span class='Declare_Member'>zlibOut</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<a name="LN402"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>TarMethodData</span><span class='Delimiter'>; 
</span><a name="LN403"></a><span class='Keyword'>static </span><a href="walmethods.c.html#LN390"><span class='Ref_to_Struct'>TarMethodData</span></a> <span class='Operator'>*</span><span class='Declare_Var'>tar_data</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<a name="LN405"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>tar_clear_error</span><span class='Parentheses'>() </span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN397"><span class='Ref_to_Member'>lasterror</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span> 
<a name="LN406"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>tar_set_error</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>msg</span><span class='Parentheses'>) </span><a href="../../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN397"><span class='Ref_to_Member'>lasterror</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN406"><span class='Ref_to_Parameter'>msg</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN397"><span class='Ref_to_Member'>lasterror</span></a><span class='Parentheses'>))</span> 
 
<span class='Keyword'>static const char </span><span class='Operator'>* 
</span><a name="LN409"></a><span class='Declare_Function'>tar_getlasterror</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * If a custom error is set, return that one. Otherwise, assume errno is 
     * set and return that one. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN397"><span class='Ref_to_Member'>lasterror</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN397"><span class='Ref_to_Member'>lasterror</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Directive'>#ifdef</span> HAVE_LIBZ 
<span class='Keyword'>static bool 
</span><a name="LN422"></a><span class='Declare_Function'>tar_write_compressed_data</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>count</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>flush</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN399"><span class='Ref_to_Member'>zp</span></a><span class='Operator'>-&GT;</span><a href="../pg_dump/pg_backup_archiver.h.html#LN56"><span class='Ref_to_Member'>next_in</span></a> <span class='Operator'>= </span><a href="walmethods.c.html#LN422"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>; 
</span>    <a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN399"><span class='Ref_to_Member'>zp</span></a><span class='Operator'>-&GT;</span><a href="../pg_dump/pg_backup_archiver.h.html#LN58"><span class='Ref_to_Member'>avail_in</span></a> <span class='Operator'>= </span><a href="walmethods.c.html#LN422"><span class='Ref_to_Parameter'>count</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN399"><span class='Ref_to_Member'>zp</span></a><span class='Operator'>-&GT;</span><a href="../pg_dump/pg_backup_archiver.h.html#LN58"><span class='Ref_to_Member'>avail_in</span></a> <span class='Operator'>|| </span><a href="walmethods.c.html#LN422"><span class='Ref_to_Parameter'>flush</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN429"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>r</span><span class='Delimiter'>; 
</span> 
        <a href="walmethods.c.html#LN429"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span>deflate<span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN399"><span class='Ref_to_Member'>zp</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN422"><span class='Ref_to_Parameter'>flush</span></a> <span class='Operator'>? </span>Z_FINISH <span class='Operator'>: </span>Z_NO_FLUSH<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN429"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>== </span>Z_STREAM_ERROR<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="walmethods.c.html#LN406"><span class='Ref_to_Macro'>tar_set_error</span></a><span class='Parentheses'>(</span><span class='String'>"deflate failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN399"><span class='Ref_to_Member'>zp</span></a><span class='Operator'>-&GT;</span><a href="../pg_dump/pg_backup_archiver.h.html#LN59"><span class='Ref_to_Member'>avail_out</span></a> <span class='Operator'>&LT; </span><a href="../pg_dump/compress_io.h.html#LN20"><span class='Ref_to_Const'>ZLIB_OUT_SIZE</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN440"></a>            size_t      <span class='Declare_Local'>len</span> <span class='Operator'>= </span><a href="../pg_dump/compress_io.h.html#LN20"><span class='Ref_to_Const'>ZLIB_OUT_SIZE</span></a> <span class='Operator'>- </span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN399"><span class='Ref_to_Member'>zp</span></a><span class='Operator'>-&GT;</span><a href="../pg_dump/pg_backup_archiver.h.html#LN59"><span class='Ref_to_Member'>avail_out</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/win32.h.html#LN13"><span class='Ref_to_Macro'>write</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN393"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN400"><span class='Ref_to_Member'>zlibOut</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN440"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="walmethods.c.html#LN440"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span> 
                <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
            <a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN399"><span class='Ref_to_Member'>zp</span></a><span class='Operator'>-&GT;</span><a href="../pg_dump/pg_backup_archiver.h.html#LN57"><span class='Ref_to_Member'>next_out</span></a> <span class='Operator'>= </span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN400"><span class='Ref_to_Member'>zlibOut</span></a><span class='Delimiter'>; 
</span>            <a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN399"><span class='Ref_to_Member'>zp</span></a><span class='Operator'>-&GT;</span><a href="../pg_dump/pg_backup_archiver.h.html#LN59"><span class='Ref_to_Member'>avail_out</span></a> <span class='Operator'>= </span><a href="../pg_dump/compress_io.h.html#LN20"><span class='Ref_to_Const'>ZLIB_OUT_SIZE</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN429"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>== </span>Z_STREAM_END<span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while tar_data-&GT;zp-&GT;avail_i... &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN422"><span class='Ref_to_Parameter'>flush</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Reset the stream for writing */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>deflateReset<span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN399"><span class='Ref_to_Member'>zp</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span>Z_OK<span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="walmethods.c.html#LN406"><span class='Ref_to_Macro'>tar_set_error</span></a><span class='Parentheses'>(</span><span class='String'>"deflateReset failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end tar_write_compressed_data &raquo; </span> 
<span class='Directive'>#endif</span> 
 
<span class='Keyword'>static </span><a href="../../include/port/win32.h.html#LN419"><span class='Ref_to_Typedef'>ssize_t</span></a> 
<a name="LN468"></a><span class='Declare_Function'>tar_write</span><span class='Parentheses'>(</span><a href="walmethods.h.html#LN12"><span class='Ref_to_Typedef'>Walfile</span></a> <span class='Declare_Parameter'>f</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>count</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN470"></a>    <a href="../../include/port/win32.h.html#LN419"><span class='Ref_to_Typedef'>ssize_t</span></a>     <span class='Declare_Local'>r</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="walmethods.c.html#LN468"><span class='Ref_to_Parameter'>f</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="walmethods.c.html#LN405"><span class='Ref_to_Macro'>tar_clear_error</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Tarfile will always be positioned at the end */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN394"><span class='Ref_to_Member'>compression</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="walmethods.c.html#LN470"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/win32.h.html#LN13"><span class='Ref_to_Macro'>write</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN393"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN468"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN468"><span class='Ref_to_Parameter'>count</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN470"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Parentheses'>((</span><a href="walmethods.c.html#LN381"><span class='Ref_to_Struct'>TarMethodFile</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="walmethods.c.html#LN468"><span class='Ref_to_Parameter'>f</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>currpos <span class='Operator'>+= </span><a href="walmethods.c.html#LN470"><span class='Ref_To_Local'>r</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="walmethods.c.html#LN470"><span class='Ref_To_Local'>r</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#ifdef</span> HAVE_LIBZ 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="walmethods.c.html#LN421"><span class='Ref_to_Func'>tar_write_compressed_data</span></a><span class='Parentheses'>((</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="walmethods.c.html#LN468"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN468"><span class='Ref_to_Parameter'>count</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Parentheses'>((</span><a href="walmethods.c.html#LN381"><span class='Ref_to_Struct'>TarMethodFile</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="walmethods.c.html#LN468"><span class='Ref_to_Parameter'>f</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>currpos <span class='Operator'>+= </span><a href="walmethods.c.html#LN468"><span class='Ref_to_Parameter'>count</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="walmethods.c.html#LN468"><span class='Ref_to_Parameter'>count</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#else</span> 
    <span class='Control'>else</span> 
        <span class='Comment_Multi_Line'>/* Can't happen - compression enabled with no libz */ 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end tar_write &raquo; </span> 
 
<span class='Keyword'>static bool 
</span><a name="LN499"></a><span class='Declare_Function'>tar_write_padding_data</span><span class='Parentheses'>(</span><a href="walmethods.c.html#LN381"><span class='Ref_to_Struct'>TarMethodFile</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>f</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>bytes</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN501"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>zerobuf</span> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN26"><span class='Ref_to_Proto'>pg_malloc0</span></a><span class='Parentheses'>(</span>XLOG_BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN502"></a>    size_t      <span class='Declare_Local'>bytesleft</span> <span class='Operator'>= </span><a href="walmethods.c.html#LN499"><span class='Ref_to_Parameter'>bytes</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN502"><span class='Ref_To_Local'>bytesleft</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN506"></a>        size_t      <span class='Declare_Local'>bytestowrite</span> <span class='Operator'>= </span><a href="walmethods.c.html#LN502"><span class='Ref_To_Local'>bytesleft</span></a> <span class='Operator'>&GT; </span>XLOG_BLCKSZ <span class='Operator'>? </span>XLOG_BLCKSZ <span class='Operator'>: </span><a href="walmethods.c.html#LN502"><span class='Ref_To_Local'>bytesleft</span></a><span class='Delimiter'>; 
</span> 
<a name="LN508"></a>        <a href="../../include/port/win32.h.html#LN419"><span class='Ref_to_Typedef'>ssize_t</span></a>     <span class='Declare_Local'>r</span> <span class='Operator'>= </span><a href="walmethods.c.html#LN467"><span class='Ref_to_Func'>tar_write</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN499"><span class='Ref_to_Parameter'>f</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN501"><span class='Ref_To_Local'>zerobuf</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN506"><span class='Ref_To_Local'>bytestowrite</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN508"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/common/fe_memutils.h.html#LN29"><span class='Ref_to_Proto'>pg_free</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN501"><span class='Ref_To_Local'>zerobuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="walmethods.c.html#LN502"><span class='Ref_To_Local'>bytesleft</span></a> <span class='Operator'>-= </span><a href="walmethods.c.html#LN508"><span class='Ref_To_Local'>r</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/common/fe_memutils.h.html#LN29"><span class='Ref_to_Proto'>pg_free</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN501"><span class='Ref_To_Local'>zerobuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end tar_write_padding_data &raquo; </span> 
 
<span class='Keyword'>static </span><a href="walmethods.h.html#LN12"><span class='Ref_to_Typedef'>Walfile</span></a> 
<a name="LN523"></a><span class='Declare_Function'>tar_open_for_write</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>pathname</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>temp_suffix</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>pad_to_size</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN525"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span><span class='Delimiter'>; 
</span><a name="LN526"></a>    <span class='Keyword'>static char </span><span class='Declare_Local'>tmppath</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span> 
    <a href="walmethods.c.html#LN405"><span class='Ref_to_Macro'>tar_clear_error</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN393"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * We open the tar file only when we first try to write to it. 
         */ 
</span>        <a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN393"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN289"><span class='Ref_to_Macro'>open</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN392"><span class='Ref_to_Member'>tarfilename</span></a><span class='Delimiter'>, 
</span>                          O_WRONLY <span class='Operator'>| </span>O_CREAT <span class='Operator'>| </span><a href="../../include/c.h.html#LN1032"><span class='Ref_to_Const'>PG_BINARY</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN424"><span class='Ref_to_Const'>S_IRUSR</span></a> <span class='Operator'>| </span><a href="../../include/port/win32.h.html#LN425"><span class='Ref_to_Const'>S_IWUSR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN393"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> HAVE_LIBZ 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN394"><span class='Ref_to_Member'>compression</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN399"><span class='Ref_to_Member'>zp</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../pg_dump/pg_backup_archiver.h.html#LN61"><span class='Ref_to_Typedef'>z_streamp</span></a><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN25"><span class='Ref_to_Proto'>pg_malloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../pg_dump/pg_backup_archiver.h.html#LN54"><span class='Ref_to_Typedef'>z_stream</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN399"><span class='Ref_to_Member'>zp</span></a><span class='Operator'>-&GT;</span>zalloc <span class='Operator'>= </span>Z_NULL<span class='Delimiter'>; 
</span>            <a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN399"><span class='Ref_to_Member'>zp</span></a><span class='Operator'>-&GT;</span>zfree <span class='Operator'>= </span>Z_NULL<span class='Delimiter'>; 
</span>            <a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN399"><span class='Ref_to_Member'>zp</span></a><span class='Operator'>-&GT;</span>opaque <span class='Operator'>= </span>Z_NULL<span class='Delimiter'>; 
</span>            <a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN399"><span class='Ref_to_Member'>zp</span></a><span class='Operator'>-&GT;</span><a href="../pg_dump/pg_backup_archiver.h.html#LN57"><span class='Ref_to_Member'>next_out</span></a> <span class='Operator'>= </span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN400"><span class='Ref_to_Member'>zlibOut</span></a><span class='Delimiter'>; 
</span>            <a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN399"><span class='Ref_to_Member'>zp</span></a><span class='Operator'>-&GT;</span><a href="../pg_dump/pg_backup_archiver.h.html#LN59"><span class='Ref_to_Member'>avail_out</span></a> <span class='Operator'>= </span><a href="../pg_dump/compress_io.h.html#LN20"><span class='Ref_to_Const'>ZLIB_OUT_SIZE</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Initialize deflation library. Adding the magic value 16 to the 
             * default 15 for the windowBits parameter makes the output be 
             * gzip instead of zlib. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>deflateInit2<span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN399"><span class='Ref_to_Member'>zp</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN394"><span class='Ref_to_Member'>compression</span></a><span class='Delimiter'>, </span>Z_DEFLATED<span class='Delimiter'>, </span><span class='Number'>15</span> <span class='Operator'>+ </span><span class='Number'>16</span><span class='Delimiter'>, </span><span class='Number'>8</span><span class='Delimiter'>, </span>Z_DEFAULT_STRATEGY<span class='Parentheses'>) </span><span class='Operator'>!= </span>Z_OK<span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../include/common/fe_memutils.h.html#LN29"><span class='Ref_to_Proto'>pg_free</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN399"><span class='Ref_to_Member'>zp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN399"><span class='Ref_to_Member'>zp</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                <a href="walmethods.c.html#LN406"><span class='Ref_to_Macro'>tar_set_error</span></a><span class='Parentheses'>(</span><span class='String'>"deflateInit2 failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if tar_data-&GT;compression &raquo; </span> 
<span class='Directive'>#endif</span> 
 
        <span class='Comment_Multi_Line'>/* There's no tar header itself, the file starts with regular files */ 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if tar_data-&GT;fd&LT;0 &raquo; </span> 
 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN396"><span class='Ref_to_Member'>currentfile</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN396"><span class='Ref_to_Member'>currentfile</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="walmethods.c.html#LN406"><span class='Ref_to_Macro'>tar_set_error</span></a><span class='Parentheses'>(</span><span class='String'>"implementation error: tar files can't have more than one open file\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN396"><span class='Ref_to_Member'>currentfile</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN26"><span class='Ref_to_Proto'>pg_malloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="walmethods.c.html#LN381"><span class='Ref_to_Struct'>TarMethodFile</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN526"><span class='Ref_To_Local'>tmppath</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="walmethods.c.html#LN526"><span class='Ref_To_Local'>tmppath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s%s"</span><span class='Delimiter'>, 
</span>             <a href="walmethods.c.html#LN523"><span class='Ref_to_Parameter'>pathname</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN523"><span class='Ref_to_Parameter'>temp_suffix</span></a> <span class='Operator'>? </span><a href="walmethods.c.html#LN523"><span class='Ref_to_Parameter'>temp_suffix</span></a> <span class='Operator'>: </span><span class='String'>""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Create a header with size set to 0 - we will fill out the size on close */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/pgtar.h.html#LN21"><span class='Ref_to_Proto'>tarCreateHeader</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN396"><span class='Ref_to_Member'>currentfile</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN385"><span class='Ref_to_Member'>header</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN526"><span class='Ref_To_Local'>tmppath</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN424"><span class='Ref_to_Const'>S_IRUSR</span></a> <span class='Operator'>| </span><a href="../../include/port/win32.h.html#LN425"><span class='Ref_to_Const'>S_IWUSR</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span>time<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> <span class='Operator'>!= </span><a href="../../include/pgtar.h.html#LN16"><span class='Ref_to_EnumConst'>TAR_OK</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/common/fe_memutils.h.html#LN29"><span class='Ref_to_Proto'>pg_free</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN396"><span class='Ref_to_Member'>currentfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN396"><span class='Ref_to_Member'>currentfile</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="walmethods.c.html#LN406"><span class='Ref_to_Macro'>tar_set_error</span></a><span class='Parentheses'>(</span><span class='String'>"could not create tar header"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
<span class='Directive'>#ifdef</span> HAVE_LIBZ 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN394"><span class='Ref_to_Member'>compression</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Flush existing data */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="walmethods.c.html#LN421"><span class='Ref_to_Func'>tar_write_compressed_data</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Turn off compression for header */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>deflateParams<span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN399"><span class='Ref_to_Member'>zp</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>!= </span>Z_OK<span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="walmethods.c.html#LN406"><span class='Ref_to_Macro'>tar_set_error</span></a><span class='Parentheses'>(</span><span class='String'>"deflateParams failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
    <a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN396"><span class='Ref_to_Member'>currentfile</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN383"><span class='Ref_to_Member'>ofs_start</span></a> <span class='Operator'>= </span>lseek<span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN393"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span>SEEK_CUR<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN396"><span class='Ref_to_Member'>currentfile</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN383"><span class='Ref_to_Member'>ofs_start</span></a> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="walmethods.c.html#LN525"><span class='Ref_To_Local'>save_errno</span></a> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span>        <a href="../../include/common/fe_memutils.h.html#LN29"><span class='Ref_to_Proto'>pg_free</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN396"><span class='Ref_to_Member'>currentfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN396"><span class='Ref_to_Member'>currentfile</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        errno <span class='Operator'>= </span><a href="walmethods.c.html#LN525"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN396"><span class='Ref_to_Member'>currentfile</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN384"><span class='Ref_to_Member'>currpos</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN394"><span class='Ref_to_Member'>compression</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/win32.h.html#LN13"><span class='Ref_to_Macro'>write</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN393"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN396"><span class='Ref_to_Member'>currentfile</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN385"><span class='Ref_to_Member'>header</span></a><span class='Delimiter'>, </span><span class='Number'>512</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>512</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="walmethods.c.html#LN525"><span class='Ref_To_Local'>save_errno</span></a> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span>            <a href="../../include/common/fe_memutils.h.html#LN29"><span class='Ref_to_Proto'>pg_free</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN396"><span class='Ref_to_Member'>currentfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN396"><span class='Ref_to_Member'>currentfile</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            errno <span class='Operator'>= </span><a href="walmethods.c.html#LN525"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#ifdef</span> HAVE_LIBZ 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Write header through the zlib APIs but with no compression */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="walmethods.c.html#LN421"><span class='Ref_to_Func'>tar_write_compressed_data</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN396"><span class='Ref_to_Member'>currentfile</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN385"><span class='Ref_to_Member'>header</span></a><span class='Delimiter'>, </span><span class='Number'>512</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Re-enable compression for the rest of the file */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>deflateParams<span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN399"><span class='Ref_to_Member'>zp</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN394"><span class='Ref_to_Member'>compression</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>!= </span>Z_OK<span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="walmethods.c.html#LN406"><span class='Ref_to_Macro'>tar_set_error</span></a><span class='Parentheses'>(</span><span class='String'>"deflateParams failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
    <a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN396"><span class='Ref_to_Member'>currentfile</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN386"><span class='Ref_to_Member'>pathname</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN24"><span class='Ref_to_Proto'>pg_strdup</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN523"><span class='Ref_to_Parameter'>pathname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Uncompressed files are padded on creation, but for compression we can't 
     * do that 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN523"><span class='Ref_to_Parameter'>pad_to_size</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN396"><span class='Ref_to_Member'>currentfile</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN387"><span class='Ref_to_Member'>pad_to_size</span></a> <span class='Operator'>= </span><a href="walmethods.c.html#LN523"><span class='Ref_to_Parameter'>pad_to_size</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN394"><span class='Ref_to_Member'>compression</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Uncompressed, so pad now */ 
</span>            <a href="walmethods.c.html#LN498"><span class='Ref_to_Func'>tar_write_padding_data</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN396"><span class='Ref_to_Member'>currentfile</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN523"><span class='Ref_to_Parameter'>pad_to_size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* Seek back to start */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>lseek<span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN393"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN396"><span class='Ref_to_Member'>currentfile</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN383"><span class='Ref_to_Member'>ofs_start</span></a> <span class='Operator'>+ </span><span class='Number'>512</span><span class='Delimiter'>, </span>SEEK_SET<span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN396"><span class='Ref_to_Member'>currentfile</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN383"><span class='Ref_to_Member'>ofs_start</span></a> <span class='Operator'>+ </span><span class='Number'>512</span><span class='Parentheses'>)</span> 
                <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
            <a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN396"><span class='Ref_to_Member'>currentfile</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN384"><span class='Ref_to_Member'>currpos</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN396"><span class='Ref_to_Member'>currentfile</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end tar_open_for_write &raquo; </span> 
 
<span class='Keyword'>static </span><a href="../../include/port/win32.h.html#LN419"><span class='Ref_to_Typedef'>ssize_t</span></a> 
<a name="LN668"></a><span class='Declare_Function'>tar_get_file_size</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>pathname</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="walmethods.c.html#LN405"><span class='Ref_to_Macro'>tar_clear_error</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Currently not used, so not supported */ 
</span>    errno <span class='Operator'>= </span>ENOSYS<span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static </span>off_t 
<a name="LN678"></a><span class='Declare_Function'>tar_get_current_pos</span><span class='Parentheses'>(</span><a href="walmethods.h.html#LN12"><span class='Ref_to_Typedef'>Walfile</span></a> <span class='Declare_Parameter'>f</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="walmethods.c.html#LN678"><span class='Ref_to_Parameter'>f</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="walmethods.c.html#LN405"><span class='Ref_to_Macro'>tar_clear_error</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>((</span><a href="walmethods.c.html#LN381"><span class='Ref_to_Struct'>TarMethodFile</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="walmethods.c.html#LN678"><span class='Ref_to_Parameter'>f</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>currpos<span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static int 
</span><a name="LN687"></a><span class='Declare_Function'>tar_sync</span><span class='Parentheses'>(</span><a href="walmethods.h.html#LN12"><span class='Ref_to_Typedef'>Walfile</span></a> <span class='Declare_Parameter'>f</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="walmethods.c.html#LN687"><span class='Ref_to_Parameter'>f</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="walmethods.c.html#LN405"><span class='Ref_to_Macro'>tar_clear_error</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN395"><span class='Ref_to_Member'>sync</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Always sync the whole tarfile, because that's all we can do. This makes 
     * no sense on compressed files, so just ignore those. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN394"><span class='Ref_to_Member'>compression</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../include/port/win32.h.html#LN61"><span class='Ref_to_Macro'>fsync</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN393"><span class='Ref_to_Member'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static int 
</span><a name="LN706"></a><span class='Declare_Function'>tar_close</span><span class='Parentheses'>(</span><a href="walmethods.h.html#LN12"><span class='Ref_to_Typedef'>Walfile</span></a> <span class='Declare_Parameter'>f</span><span class='Delimiter'>, </span><a href="walmethods.h.html#LN14"><span class='Ref_to_Typedef'>WalCloseMethod</span></a> <span class='Declare_Parameter'>method</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN708"></a>    <a href="../../include/port/win32.h.html#LN419"><span class='Ref_to_Typedef'>ssize_t</span></a>     <span class='Declare_Local'>filesize</span><span class='Delimiter'>; 
</span><a name="LN709"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>padding</span><span class='Delimiter'>; 
</span><a name="LN710"></a>    <a href="walmethods.c.html#LN381"><span class='Ref_to_Struct'>TarMethodFile</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tf</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="walmethods.c.html#LN381"><span class='Ref_to_Struct'>TarMethodFile</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="walmethods.c.html#LN706"><span class='Ref_to_Parameter'>f</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="walmethods.c.html#LN706"><span class='Ref_to_Parameter'>f</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="walmethods.c.html#LN405"><span class='Ref_to_Macro'>tar_clear_error</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN706"><span class='Ref_to_Parameter'>method</span></a> <span class='Operator'>== </span><a href="walmethods.h.html#LN17"><span class='Ref_to_EnumConst'>CLOSE_UNLINK</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN394"><span class='Ref_to_Member'>compression</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="walmethods.c.html#LN406"><span class='Ref_to_Macro'>tar_set_error</span></a><span class='Parentheses'>(</span><span class='String'>"unlink not supported with compression"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Unlink the file that we just wrote to the tar. We do this by 
         * truncating it to the start of the header. This is safe as we only 
         * allow writing of the very last file. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN58"><span class='Ref_to_Macro'>ftruncate</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN393"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN710"><span class='Ref_To_Local'>tf</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN383"><span class='Ref_to_Member'>ofs_start</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/common/fe_memutils.h.html#LN29"><span class='Ref_to_Proto'>pg_free</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN710"><span class='Ref_To_Local'>tf</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN386"><span class='Ref_to_Member'>pathname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/common/fe_memutils.h.html#LN29"><span class='Ref_to_Proto'>pg_free</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN710"><span class='Ref_To_Local'>tf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN396"><span class='Ref_to_Member'>currentfile</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if method==CLOSE_UNLINK &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Pad the file itself with zeroes if necessary. Note that this is 
     * different from the tar format padding -- this is the padding we asked 
     * for when the file was opened. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN710"><span class='Ref_To_Local'>tf</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN387"><span class='Ref_to_Member'>pad_to_size</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN394"><span class='Ref_to_Member'>compression</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * A compressed tarfile is padded on close since we cannot know 
             * the size of the compressed output until the end. 
             */ 
</span><a name="LN751"></a>            size_t      <span class='Declare_Local'>sizeleft</span> <span class='Operator'>= </span><a href="walmethods.c.html#LN710"><span class='Ref_To_Local'>tf</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN387"><span class='Ref_to_Member'>pad_to_size</span></a> <span class='Operator'>- </span><a href="walmethods.c.html#LN710"><span class='Ref_To_Local'>tf</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN384"><span class='Ref_to_Member'>currpos</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN751"><span class='Ref_To_Local'>sizeleft</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="walmethods.c.html#LN498"><span class='Ref_to_Func'>tar_write_padding_data</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN710"><span class='Ref_To_Local'>tf</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN751"><span class='Ref_To_Local'>sizeleft</span></a><span class='Parentheses'>))</span> 
                    <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * An uncompressed tarfile was padded on creation, so just adjust 
             * the current position as if we seeked to the end. 
             */ 
</span>            <a href="walmethods.c.html#LN710"><span class='Ref_To_Local'>tf</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN384"><span class='Ref_to_Member'>currpos</span></a> <span class='Operator'>= </span><a href="walmethods.c.html#LN710"><span class='Ref_To_Local'>tf</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN387"><span class='Ref_to_Member'>pad_to_size</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if tf-&GT;pad_to_size &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Get the size of the file, and pad the current data up to the nearest 
     * 512 byte boundary. 
     */ 
</span>    <a href="walmethods.c.html#LN708"><span class='Ref_To_Local'>filesize</span></a> <span class='Operator'>= </span><a href="walmethods.c.html#LN677"><span class='Ref_to_Func'>tar_get_current_pos</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN706"><span class='Ref_to_Parameter'>f</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="walmethods.c.html#LN709"><span class='Ref_To_Local'>padding</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="walmethods.c.html#LN708"><span class='Ref_To_Local'>filesize</span></a> <span class='Operator'>+ </span><span class='Number'>511</span><span class='Parentheses'>) </span><span class='Operator'>& ~</span><span class='Number'>511</span><span class='Parentheses'>)</span> <span class='Operator'>- </span><a href="walmethods.c.html#LN708"><span class='Ref_To_Local'>filesize</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN709"><span class='Ref_To_Local'>padding</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN777"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>zerobuf</span><span class='Delimiter'>[</span><span class='Number'>512</span><span class='Delimiter'>]; 
</span> 
        <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN777"><span class='Ref_To_Local'>zerobuf</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="walmethods.c.html#LN709"><span class='Ref_To_Local'>padding</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN467"><span class='Ref_to_Func'>tar_write</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN706"><span class='Ref_to_Parameter'>f</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN777"><span class='Ref_To_Local'>zerobuf</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN709"><span class='Ref_To_Local'>padding</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="walmethods.c.html#LN709"><span class='Ref_To_Local'>padding</span></a><span class='Parentheses'>)</span> 
            <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
 
<span class='Directive'>#ifdef</span> HAVE_LIBZ 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN394"><span class='Ref_to_Member'>compression</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Flush the current buffer */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="walmethods.c.html#LN421"><span class='Ref_to_Func'>tar_write_compressed_data</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            errno <span class='Operator'>= </span>EINVAL<span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Now go back and update the header with the correct filesize and 
     * possibly also renaming the file. We overwrite the entire current header 
     * when done, including the checksum. 
     */ 
</span>    <a href="../../port/tar.c.html#LN18"><span class='Ref_to_Func'>print_tar_number</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="walmethods.c.html#LN710"><span class='Ref_To_Local'>tf</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN385"><span class='Ref_to_Member'>header</span></a><span class='Delimiter'>[</span><span class='Number'>124</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>12</span><span class='Delimiter'>, </span><a href="walmethods.c.html#LN708"><span class='Ref_To_Local'>filesize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN706"><span class='Ref_to_Parameter'>method</span></a> <span class='Operator'>== </span><a href="walmethods.h.html#LN16"><span class='Ref_to_EnumConst'>CLOSE_NORMAL</span></a><span class='Parentheses'>) 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We overwrite it with what it was before if we have no tempname, 
         * since we're going to write the buffer anyway. 
         */ 
</span>        <a href="../../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="walmethods.c.html#LN710"><span class='Ref_To_Local'>tf</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN385"><span class='Ref_to_Member'>header</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="walmethods.c.html#LN710"><span class='Ref_To_Local'>tf</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN386"><span class='Ref_to_Member'>pathname</span></a><span class='Delimiter'>, </span><span class='Number'>100</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../port/tar.c.html#LN18"><span class='Ref_to_Func'>print_tar_number</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="walmethods.c.html#LN710"><span class='Ref_To_Local'>tf</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN385"><span class='Ref_to_Member'>header</span></a><span class='Delimiter'>[</span><span class='Number'>148</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>8</span><span class='Delimiter'>, </span><a href="../../include/pgtar.h.html#LN25"><span class='Ref_to_Proto'>tarChecksum</span></a><span class='Parentheses'>(((</span><a href="walmethods.c.html#LN381"><span class='Ref_to_Struct'>TarMethodFile</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="walmethods.c.html#LN706"><span class='Ref_to_Parameter'>f</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>header<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>lseek<span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN393"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN710"><span class='Ref_To_Local'>tf</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN383"><span class='Ref_to_Member'>ofs_start</span></a><span class='Delimiter'>, </span>SEEK_SET<span class='Parentheses'>)</span> <span class='Operator'>!= </span><span class='Parentheses'>((</span><a href="walmethods.c.html#LN381"><span class='Ref_to_Struct'>TarMethodFile</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="walmethods.c.html#LN706"><span class='Ref_to_Parameter'>f</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>ofs_start<span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN394"><span class='Ref_to_Member'>compression</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/win32.h.html#LN13"><span class='Ref_to_Macro'>write</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN393"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN710"><span class='Ref_To_Local'>tf</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN385"><span class='Ref_to_Member'>header</span></a><span class='Delimiter'>, </span><span class='Number'>512</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>512</span><span class='Parentheses'>)</span> 
            <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#ifdef</span> HAVE_LIBZ 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Turn off compression */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>deflateParams<span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN399"><span class='Ref_to_Member'>zp</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>!= </span>Z_OK<span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="walmethods.c.html#LN406"><span class='Ref_to_Macro'>tar_set_error</span></a><span class='Parentheses'>(</span><span class='String'>"deflateParams failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Overwrite the header, assuming the size will be the same */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="walmethods.c.html#LN421"><span class='Ref_to_Func'>tar_write_compressed_data</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN396"><span class='Ref_to_Member'>currentfile</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN385"><span class='Ref_to_Member'>header</span></a><span class='Delimiter'>, </span><span class='Number'>512</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Turn compression back on */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>deflateParams<span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN399"><span class='Ref_to_Member'>zp</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN394"><span class='Ref_to_Member'>compression</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>!= </span>Z_OK<span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="walmethods.c.html#LN406"><span class='Ref_to_Macro'>tar_set_error</span></a><span class='Parentheses'>(</span><span class='String'>"deflateParams failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
<span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* Move file pointer back down to end, so we can write the next file */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>lseek<span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN393"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span>SEEK_END<span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Always fsync on close, so the padding gets fsynced */ 
</span>    <a href="walmethods.c.html#LN686"><span class='Ref_to_Func'>tar_sync</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN706"><span class='Ref_to_Parameter'>f</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Clean up and done */ 
</span>    <a href="../../include/common/fe_memutils.h.html#LN29"><span class='Ref_to_Proto'>pg_free</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN710"><span class='Ref_To_Local'>tf</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN386"><span class='Ref_to_Member'>pathname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/fe_memutils.h.html#LN29"><span class='Ref_to_Proto'>pg_free</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN710"><span class='Ref_To_Local'>tf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN396"><span class='Ref_to_Member'>currentfile</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end tar_close &raquo; </span> 
 
<span class='Keyword'>static bool 
</span><a name="LN859"></a><span class='Declare_Function'>tar_existsfile</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>pathname</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="walmethods.c.html#LN405"><span class='Ref_to_Macro'>tar_clear_error</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* We only deal with new tarfiles, so nothing externally created exists */ 
</span>    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static bool 
</span><a name="LN867"></a><span class='Declare_Function'>tar_finish</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN869"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>zerobuf</span><span class='Delimiter'>[</span><span class='Number'>1024</span><span class='Delimiter'>]; 
</span> 
    <a href="walmethods.c.html#LN405"><span class='Ref_to_Macro'>tar_clear_error</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN396"><span class='Ref_to_Member'>currentfile</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN705"><span class='Ref_to_Func'>tar_close</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN396"><span class='Ref_to_Member'>currentfile</span></a><span class='Delimiter'>, </span><a href="walmethods.h.html#LN16"><span class='Ref_to_EnumConst'>CLOSE_NORMAL</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* A tarfile always ends with two empty  blocks */ 
</span>    <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN869"><span class='Ref_To_Local'>zerobuf</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="walmethods.c.html#LN869"><span class='Ref_To_Local'>zerobuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN394"><span class='Ref_to_Member'>compression</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/win32.h.html#LN13"><span class='Ref_to_Macro'>write</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN393"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN869"><span class='Ref_To_Local'>zerobuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="walmethods.c.html#LN869"><span class='Ref_To_Local'>zerobuf</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="walmethods.c.html#LN869"><span class='Ref_To_Local'>zerobuf</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#ifdef</span> HAVE_LIBZ 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="walmethods.c.html#LN421"><span class='Ref_to_Func'>tar_write_compressed_data</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN869"><span class='Ref_To_Local'>zerobuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="walmethods.c.html#LN869"><span class='Ref_To_Local'>zerobuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Also flush all data to make sure the gzip stream is finished */ 
</span>        <a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN399"><span class='Ref_to_Member'>zp</span></a><span class='Operator'>-&GT;</span><a href="../pg_dump/pg_backup_archiver.h.html#LN56"><span class='Ref_to_Member'>next_in</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN399"><span class='Ref_to_Member'>zp</span></a><span class='Operator'>-&GT;</span><a href="../pg_dump/pg_backup_archiver.h.html#LN58"><span class='Ref_to_Member'>avail_in</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN897"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>r</span><span class='Delimiter'>; 
</span> 
            <a href="walmethods.c.html#LN897"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span>deflate<span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN399"><span class='Ref_to_Member'>zp</span></a><span class='Delimiter'>, </span>Z_FINISH<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN897"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>== </span>Z_STREAM_ERROR<span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="walmethods.c.html#LN406"><span class='Ref_to_Macro'>tar_set_error</span></a><span class='Parentheses'>(</span><span class='String'>"deflate failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN399"><span class='Ref_to_Member'>zp</span></a><span class='Operator'>-&GT;</span><a href="../pg_dump/pg_backup_archiver.h.html#LN59"><span class='Ref_to_Member'>avail_out</span></a> <span class='Operator'>&LT; </span><a href="../pg_dump/compress_io.h.html#LN20"><span class='Ref_to_Const'>ZLIB_OUT_SIZE</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN908"></a>                size_t      <span class='Declare_Local'>len</span> <span class='Operator'>= </span><a href="../pg_dump/compress_io.h.html#LN20"><span class='Ref_to_Const'>ZLIB_OUT_SIZE</span></a> <span class='Operator'>- </span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN399"><span class='Ref_to_Member'>zp</span></a><span class='Operator'>-&GT;</span><a href="../pg_dump/pg_backup_archiver.h.html#LN59"><span class='Ref_to_Member'>avail_out</span></a><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/win32.h.html#LN13"><span class='Ref_to_Macro'>write</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN393"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN400"><span class='Ref_to_Member'>zlibOut</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN908"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="walmethods.c.html#LN908"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span> 
                    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN897"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>== </span>Z_STREAM_END<span class='Parentheses'>) 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while true &raquo; </span> 
 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>deflateEnd<span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN399"><span class='Ref_to_Member'>zp</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span>Z_OK<span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="walmethods.c.html#LN406"><span class='Ref_to_Macro'>tar_set_error</span></a><span class='Parentheses'>(</span><span class='String'>"deflateEnd failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
<span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* sync the empty blocks as well, since they're after the last file */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN395"><span class='Ref_to_Member'>sync</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/port/win32.h.html#LN61"><span class='Ref_to_Macro'>fsync</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN393"><span class='Ref_to_Member'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN393"><span class='Ref_to_Member'>fd</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN393"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN395"><span class='Ref_to_Member'>sync</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/common/file_utils.h.html#LN17"><span class='Ref_to_Proto'>fsync_fname</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN392"><span class='Ref_to_Member'>tarfilename</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/common/file_utils.h.html#LN24"><span class='Ref_to_Proto'>fsync_parent_path</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN392"><span class='Ref_to_Member'>tarfilename</span></a><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end tar_finish &raquo; </span> 
 
<a href="walmethods.h.html#LN32"><span class='Ref_to_Struct'>WalWriteMethod</span></a> <span class='Operator'>* 
</span><a name="LN946"></a><span class='Declare_Function'>CreateWalTarMethod</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>tarbase</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>compression</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>sync</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN948"></a>    <a href="walmethods.h.html#LN32"><span class='Ref_to_Struct'>WalWriteMethod</span></a> <span class='Operator'>*</span><span class='Declare_Local'>method</span><span class='Delimiter'>; 
</span><a name="LN949"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>suffix</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="walmethods.c.html#LN946"><span class='Ref_to_Parameter'>compression</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>? </span><span class='String'>".tar.gz"</span> <span class='Operator'>: </span><span class='String'>".tar"</span><span class='Delimiter'>; 
</span> 
    <a href="walmethods.c.html#LN948"><span class='Ref_To_Local'>method</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN26"><span class='Ref_to_Proto'>pg_malloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="walmethods.h.html#LN32"><span class='Ref_to_Struct'>WalWriteMethod</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="walmethods.c.html#LN948"><span class='Ref_To_Local'>method</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN40"><span class='Ref_to_Member'>open_for_write</span></a> <span class='Operator'>= </span><a href="walmethods.c.html#LN522"><span class='Ref_to_Func'>tar_open_for_write</span></a><span class='Delimiter'>; 
</span>    <a href="walmethods.c.html#LN948"><span class='Ref_To_Local'>method</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN58"><span class='Ref_to_Member'>write</span></a> <span class='Operator'>= </span><a href="walmethods.c.html#LN467"><span class='Ref_to_Func'>tar_write</span></a><span class='Delimiter'>; 
</span>    <a href="walmethods.c.html#LN948"><span class='Ref_To_Local'>method</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN61"><span class='Ref_to_Member'>get_current_pos</span></a> <span class='Operator'>= </span><a href="walmethods.c.html#LN677"><span class='Ref_to_Func'>tar_get_current_pos</span></a><span class='Delimiter'>; 
</span>    <a href="walmethods.c.html#LN948"><span class='Ref_To_Local'>method</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN52"><span class='Ref_to_Member'>get_file_size</span></a> <span class='Operator'>= </span><a href="walmethods.c.html#LN667"><span class='Ref_to_Func'>tar_get_file_size</span></a><span class='Delimiter'>; 
</span>    <a href="walmethods.c.html#LN948"><span class='Ref_To_Local'>method</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN46"><span class='Ref_to_Member'>close</span></a> <span class='Operator'>= </span><a href="walmethods.c.html#LN705"><span class='Ref_to_Func'>tar_close</span></a><span class='Delimiter'>; 
</span>    <a href="walmethods.c.html#LN948"><span class='Ref_To_Local'>method</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN66"><span class='Ref_to_Member'>sync</span></a> <span class='Operator'>= </span><a href="walmethods.c.html#LN686"><span class='Ref_to_Func'>tar_sync</span></a><span class='Delimiter'>; 
</span>    <a href="walmethods.c.html#LN948"><span class='Ref_To_Local'>method</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN49"><span class='Ref_to_Member'>existsfile</span></a> <span class='Operator'>= </span><a href="walmethods.c.html#LN858"><span class='Ref_to_Func'>tar_existsfile</span></a><span class='Delimiter'>; 
</span>    <a href="walmethods.c.html#LN948"><span class='Ref_To_Local'>method</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN74"><span class='Ref_to_Member'>finish</span></a> <span class='Operator'>= </span><a href="walmethods.c.html#LN866"><span class='Ref_to_Func'>tar_finish</span></a><span class='Delimiter'>; 
</span>    <a href="walmethods.c.html#LN948"><span class='Ref_To_Local'>method</span></a><span class='Operator'>-&GT;</span>getlasterror <span class='Operator'>= </span><a href="walmethods.c.html#LN408"><span class='Ref_to_Func'>tar_getlasterror</span></a><span class='Delimiter'>; 
</span> 
    <a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN26"><span class='Ref_to_Proto'>pg_malloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="walmethods.c.html#LN390"><span class='Ref_to_Struct'>TarMethodData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN392"><span class='Ref_to_Member'>tarfilename</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN26"><span class='Ref_to_Proto'>pg_malloc0</span></a><span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="walmethods.c.html#LN946"><span class='Ref_to_Parameter'>tarbase</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span>strlen<span class='Parentheses'>(</span><a href="walmethods.c.html#LN949"><span class='Ref_To_Local'>suffix</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN392"><span class='Ref_to_Member'>tarfilename</span></a><span class='Delimiter'>, </span><span class='String'>"%s%s"</span><span class='Delimiter'>, </span><a href="walmethods.c.html#LN946"><span class='Ref_to_Parameter'>tarbase</span></a><span class='Delimiter'>, </span><a href="walmethods.c.html#LN949"><span class='Ref_To_Local'>suffix</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN393"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN394"><span class='Ref_to_Member'>compression</span></a> <span class='Operator'>= </span><a href="walmethods.c.html#LN946"><span class='Ref_to_Parameter'>compression</span></a><span class='Delimiter'>; 
</span>    <a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN395"><span class='Ref_to_Member'>sync</span></a> <span class='Operator'>= </span><a href="walmethods.c.html#LN946"><span class='Ref_to_Parameter'>sync</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> HAVE_LIBZ 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN946"><span class='Ref_to_Parameter'>compression</span></a><span class='Parentheses'>) 
</span>        <a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN400"><span class='Ref_to_Member'>zlibOut</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN25"><span class='Ref_to_Proto'>pg_malloc</span></a><span class='Parentheses'>(</span><a href="../pg_dump/compress_io.h.html#LN20"><span class='Ref_to_Const'>ZLIB_OUT_SIZE</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Control'>return</span> <a href="walmethods.c.html#LN948"><span class='Ref_To_Local'>method</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CreateWalTarMethod &raquo; </span> 
 
<span class='Keyword'>void 
</span><a name="LN977"></a><span class='Declare_Function'>FreeWalTarMethod</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../include/common/fe_memutils.h.html#LN29"><span class='Ref_to_Proto'>pg_free</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN392"><span class='Ref_to_Member'>tarfilename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> HAVE_LIBZ 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN394"><span class='Ref_to_Member'>compression</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/common/fe_memutils.h.html#LN29"><span class='Ref_to_Proto'>pg_free</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Operator'>-&GT;</span><a href="walmethods.c.html#LN400"><span class='Ref_to_Member'>zlibOut</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <a href="../../include/common/fe_memutils.h.html#LN29"><span class='Ref_to_Proto'>pg_free</span></a><span class='Parentheses'>(</span><a href="walmethods.c.html#LN403"><span class='Ref_to_Global_Var'>tar_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>