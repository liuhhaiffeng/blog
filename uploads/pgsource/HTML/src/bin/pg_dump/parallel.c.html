<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\bin\pg_dump\parallel.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\bin\pg_dump\parallel.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:59 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * parallel.c 
 * 
 *  Parallel support for pg_dump and pg_restore 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * IDENTIFICATION 
 *      src/bin/pg_dump/parallel.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Parallel operation works like this: 
 * 
 * The original, master process calls ParallelBackupStart(), which forks off 
 * the desired number of worker processes, which each enter WaitForCommands(). 
 * 
 * The master process dispatches an individual work item to one of the worker 
 * processes in DispatchJobForTocEntry().  We send a command string such as 
 * "DUMP 1234" or "RESTORE 1234", where 1234 is the TocEntry ID. 
 * The worker process receives and decodes the command and passes it to the 
 * routine pointed to by AH-&GT;WorkerJobDumpPtr or AH-&GT;WorkerJobRestorePtr, 
 * which are routines of the current archive format.  That routine performs 
 * the required action (dump or restore) and returns an integer status code. 
 * This is passed back to the master where we pass it to the 
 * ParallelCompletionPtr callback function that was passed to 
 * DispatchJobForTocEntry().  The callback function does state updating 
 * for the master control logic in pg_backup_archiver.c. 
 * 
 * In principle additional archive-format-specific information might be needed 
 * in commands or worker status responses, but so far that hasn't proved 
 * necessary, since workers have full copies of the ArchiveHandle/TocEntry 
 * data structures.  Remember that we have forked off the workers only after 
 * we have read in the catalog.  That's why our worker processes can also 
 * access the catalog information.  (In the Windows case, the workers are 
 * threads in the same process.  To avoid problems, they work with cloned 
 * copies of the Archive data structure; see RunWorker().) 
 * 
 * In the master process, the workerStatus field for each worker has one of 
 * the following values: 
 *      WRKR_IDLE: it's waiting for a command 
 *      WRKR_WORKING: it's working on a command 
 *      WRKR_TERMINATED: process ended 
 * The pstate-&GT;te[] entry for each worker is valid when it's in WRKR_WORKING 
 * state, and must be NULL in other states. 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres_fe.h"</span> 
 
<span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/wait.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;signal.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;fcntl.h&GT;</span> 
<span class='Directive'>#endif</span> 
<span class='Directive'>#ifdef</span> HAVE_SYS_SELECT_H 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/select.h&GT;</span> 
<span class='Directive'>#endif</span> 
 
<span class='Keyword'>#include </span><span class='String'>"parallel.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pg_backup_utils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"fe_utils/string_utils.h"</span> 
 
<span class='Comment_Multi_Line'>/* Mnemonic macros for indexing the fd array returned by pipe(2) */ 
</span><a name="LN68"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PIPE_READ</span>                           <span class='Number'>0</span> 
<a name="LN69"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PIPE_WRITE</span>                          <span class='Number'>1</span> 
 
<a name="LN71"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>NO_SLOT</span> <span class='Parentheses'>(</span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>)</span>            <span class='Comment_Single_Line'>/* Failure result for GetIdleWorker() */ 
</span> 
<span class='Comment_Multi_Line'>/* Worker process statuses */ 
</span><span class='Control'>typedef</span> <span class='Control'>enum</span> 
<span class='Delimiter'>{ 
</span><a name="LN76"></a>    <span class='Declare_Enum_Const'>WRKR_IDLE</span><span class='Delimiter'>, 
</span><a name="LN77"></a>    <span class='Declare_Enum_Const'>WRKR_WORKING</span><span class='Delimiter'>, 
</span><a name="LN78"></a>    <span class='Declare_Enum_Const'>WRKR_TERMINATED</span> 
<a name="LN79"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>T_WorkerStatus</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Private per-parallel-worker state (typedef for this is in parallel.h). 
 * 
 * Much of this is valid only in the master process (or, on Windows, should 
 * be touched only by the master thread).  But the AH field should be touched 
 * only by workers.  The pipe descriptors are valid everywhere. 
 */ 
</span><a name="LN88"></a><span class='Control'>struct</span> <span class='Declare_Struct'>ParallelSlot</span> 
<span class='Delimiter'>{ 
</span><a name="LN90"></a>    <a href="parallel.c.html#LN74"><span class='Ref_to_Typedef'>T_WorkerStatus</span></a> <span class='Declare_Member'>workerStatus</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* see enum above */ 
</span> 
    <span class='Comment_Multi_Line'>/* These fields are valid if workerStatus == WRKR_WORKING: */ 
</span><a name="LN93"></a>    <a href="parallel.h.html#LN21"><span class='Ref_to_Typedef'>ParallelCompletionPtr</span></a> <span class='Declare_Member'>callback</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* function to call on completion */ 
</span><a name="LN94"></a>    <span class='Keyword'>void</span>       <span class='Operator'>*</span><span class='Declare_Member'>callback_data</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* passthrough data for it */ 
</span> 
<a name="LN96"></a>    <a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Member'>AH</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* Archive data worker is using */ 
</span> 
<a name="LN98"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>pipeRead</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* master's end of the pipes */ 
</span><a name="LN99"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>pipeWrite</span><span class='Delimiter'>; 
</span><a name="LN100"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>pipeRevRead</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* child's end of the pipes */ 
</span><a name="LN101"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>pipeRevWrite</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Child process/thread identity info: */ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN105"></a>    uintptr_t   <span class='Declare_Member'>hThread</span><span class='Delimiter'>; 
</span><a name="LN106"></a>    <span class='Keyword'>unsigned int </span><span class='Declare_Member'>threadId</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
<a name="LN108"></a>    <a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a>       <span class='Declare_Member'>pid</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end ParallelSlot &raquo; </span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
 
<span class='Comment_Multi_Line'>/* 
 * Structure to hold info passed by _beginthreadex() to the function it calls 
 * via its single allowed argument. 
 */ 
</span><span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN120"></a>    <a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Member'>AH</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* master database connection */ 
</span><a name="LN121"></a>    <a href="../scripts/vacuumdb.c.html#LN28"><span class='Ref_to_Struct'>ParallelSlot</span></a> <span class='Operator'>*</span><span class='Declare_Member'>slot</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* this worker's parallel slot */ 
</span><a name="LN122"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>WorkerInfo</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Windows implementation of pipe access */ 
</span><a name="LN125"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>pgpipe</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>handles</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN126"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>piperead</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>s</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN127"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>pipewrite</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>a</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>b</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>c</span><span class='Parentheses'>)</span>    <a href="../../include/port/win32.h.html#LN375"><span class='Ref_to_Macro'>send</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN127"><span class='Ref_to_Parameter'>a</span></a><span class='Delimiter'>,</span><a href="parallel.c.html#LN127"><span class='Ref_to_Parameter'>b</span></a><span class='Delimiter'>,</span><a href="parallel.c.html#LN127"><span class='Ref_to_Parameter'>c</span></a><span class='Delimiter'>,</span><span class='Number'>0</span><span class='Parentheses'>) 
</span> 
<span class='Directive'>#else</span>                           <span class='Comment_Single_Line'>/* !WIN32 */ 
</span> 
<span class='Comment_Multi_Line'>/* Non-Windows implementation of pipe access */ 
</span><a name="LN132"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>pgpipe</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>a</span><span class='Parentheses'>)</span>           pipe<span class='Parentheses'>(</span><a href="parallel.c.html#LN132"><span class='Ref_to_Parameter'>a</span></a><span class='Parentheses'>) 
</span><a name="LN133"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>piperead</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>a</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>b</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>c</span><span class='Parentheses'>)</span>     <a href="../../interfaces/libpq/win32.h.html#LN12"><span class='Ref_to_Macro'>read</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN133"><span class='Ref_to_Parameter'>a</span></a><span class='Delimiter'>,</span><a href="parallel.c.html#LN133"><span class='Ref_to_Parameter'>b</span></a><span class='Delimiter'>,</span><a href="parallel.c.html#LN133"><span class='Ref_to_Parameter'>c</span></a><span class='Parentheses'>) 
</span><a name="LN134"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>pipewrite</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>a</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>b</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>c</span><span class='Parentheses'>)</span>    <a href="../../interfaces/libpq/win32.h.html#LN13"><span class='Ref_to_Macro'>write</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN134"><span class='Ref_to_Parameter'>a</span></a><span class='Delimiter'>,</span><a href="parallel.c.html#LN134"><span class='Ref_to_Parameter'>b</span></a><span class='Delimiter'>,</span><a href="parallel.c.html#LN134"><span class='Ref_to_Parameter'>c</span></a><span class='Parentheses'>) 
</span> 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* WIN32 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * State info for archive_close_connection() shutdown callback. 
 */ 
</span><a name="LN141"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>ShutdownInformation</span> 
<span class='Delimiter'>{ 
</span><a name="LN143"></a>    <a href="parallel.h.html#LN39"><span class='Ref_to_Struct'>ParallelState</span></a> <span class='Operator'>*</span><span class='Declare_Member'>pstate</span><span class='Delimiter'>; 
</span><a name="LN144"></a>    <a href="pg_backup.h.html#LN177"><span class='Ref_to_Struct'>Archive</span></a>    <span class='Operator'>*</span><span class='Declare_Member'>AHX</span><span class='Delimiter'>; 
</span><a name="LN145"></a>} <span class='Declare_Typedef'>ShutdownInformation</span><span class='Delimiter'>; 
</span> 
<a name="LN147"></a><span class='Keyword'>static </span><a href="parallel.c.html#LN141"><span class='Ref_to_Struct'>ShutdownInformation</span></a> <span class='Declare_Var'>shutdown_info</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * State info for signal handling. 
 * We assume signal_info initializes to zeroes. 
 * 
 * On Unix, myAH is the master DB connection in the master process, and the 
 * worker's own connection in worker processes.  On Windows, we have only one 
 * instance of signal_info, so myAH is the master connection and the worker 
 * connections must be dug out of pstate-&GT;parallelSlot[]. 
 */ 
</span><a name="LN158"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>DumpSignalInformation</span> 
<span class='Delimiter'>{ 
</span><a name="LN160"></a>    <a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Member'>myAH</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* database connection to issue cancel for */ 
</span><a name="LN161"></a>    <a href="parallel.h.html#LN39"><span class='Ref_to_Struct'>ParallelState</span></a> <span class='Operator'>*</span><span class='Declare_Member'>pstate</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* parallel state, if any */ 
</span><a name="LN162"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>handler_set</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* signal handler set up in this process? */ 
</span><span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN164"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>am_worker</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* am I a worker process? */ 
</span><span class='Directive'>#endif</span> 
<a name="LN166"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>DumpSignalInformation</span><span class='Delimiter'>; 
</span> 
<a name="LN168"></a><span class='Keyword'>static volatile </span><a href="parallel.c.html#LN158"><span class='Ref_to_Struct'>DumpSignalInformation</span></a> <span class='Declare_Var'>signal_info</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN171"></a><span class='Keyword'>static </span>CRITICAL_SECTION <span class='Declare_Var'>signal_info_lock</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Write a simple string to stderr --- must be safe in a signal handler. 
 * We ignore the write() result since there's not much we could do about it. 
 * Certain compilers make that harder than it ought to be. 
 */ 
</span><a name="LN179"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>write_stderr</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>str</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Control'>do</span> <span class='Delimiter'>{ </span><span class='Operator'>\ 
</span>        <span class='Keyword'>const char </span><span class='Operator'>*</span>str_ <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="parallel.c.html#LN179"><span class='Ref_to_Parameter'>str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>        <span class='Keyword'>int</span>     rc_<span class='Delimiter'>; </span><span class='Operator'>\ 
</span>        rc_ <span class='Operator'>= </span><a href="../../interfaces/libpq/win32.h.html#LN13"><span class='Ref_to_Macro'>write</span></a><span class='Parentheses'>(</span>fileno<span class='Parentheses'>(</span>stderr<span class='Parentheses'>)</span><span class='Delimiter'>, </span>str_<span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span>str_<span class='Parentheses'>))</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span>rc_<span class='Delimiter'>; </span><span class='Operator'>\ 
</span>    <span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>) 
</span> 
 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<span class='Comment_Multi_Line'>/* file-scope variables */ 
</span><a name="LN190"></a><span class='Keyword'>static DWORD </span><span class='Declare_Var'>tls_index</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* globally visible variables (needed by exit_nicely) */ 
</span><a name="LN193"></a><span class='Keyword'>bool</span>        <span class='Declare_Var'>parallel_init_done</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN194"></a><span class='Keyword'>DWORD</span>       <span class='Declare_Var'>mainThreadId</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* WIN32 */ 
</span> 
<a name="LN197"></a><span class='Keyword'>static const char </span><span class='Operator'>*</span><span class='Declare_Var'>modulename</span> <span class='Operator'>= </span><a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"parallel archiver"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Local function prototypes */ 
</span><a name="LN200"></a><span class='Keyword'>static </span><a href="../scripts/vacuumdb.c.html#LN28"><span class='Ref_to_Struct'>ParallelSlot</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>GetMyPSlot</span><span class='Parentheses'>(</span><a href="parallel.h.html#LN39"><span class='Ref_to_Struct'>ParallelState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN201"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>archive_close_connection</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>code</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN202"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ShutdownWorkersHard</span><span class='Parentheses'>(</span><a href="parallel.h.html#LN39"><span class='Ref_to_Struct'>ParallelState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN203"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>WaitForTerminatingWorkers</span><span class='Parentheses'>(</span><a href="parallel.h.html#LN39"><span class='Ref_to_Struct'>ParallelState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN204"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>setup_cancel_handler</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN205"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>set_cancel_pstate</span><span class='Parentheses'>(</span><a href="parallel.h.html#LN39"><span class='Ref_to_Struct'>ParallelState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN206"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>set_cancel_slot_archive</span><span class='Parentheses'>(</span><a href="../scripts/vacuumdb.c.html#LN28"><span class='Ref_to_Struct'>ParallelSlot</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>slot</span><span class='Delimiter'>, </span><a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AH</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN207"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>RunWorker</span><span class='Parentheses'>(</span><a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AH</span><span class='Delimiter'>, </span><a href="../scripts/vacuumdb.c.html#LN28"><span class='Ref_to_Struct'>ParallelSlot</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>slot</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN208"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>GetIdleWorker</span><span class='Parentheses'>(</span><a href="parallel.h.html#LN39"><span class='Ref_to_Struct'>ParallelState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN209"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>HasEveryWorkerTerminated</span><span class='Parentheses'>(</span><a href="parallel.h.html#LN39"><span class='Ref_to_Struct'>ParallelState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN210"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>lockTableForWorker</span><span class='Parentheses'>(</span><a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AH</span><span class='Delimiter'>, </span><a href="pg_backup_archiver.h.html#LN120"><span class='Ref_to_Typedef'>TocEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>te</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN211"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>WaitForCommands</span><span class='Parentheses'>(</span><a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AH</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>pipefd</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN212"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>ListenToWorkers</span><span class='Parentheses'>(</span><a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AH</span><span class='Delimiter'>, </span><a href="parallel.h.html#LN39"><span class='Ref_to_Struct'>ParallelState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Delimiter'>, 
</span><a name="LN213"></a>                <span class='Keyword'>bool </span><span class='Declare_Parameter'>do_wait</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN214"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Prototype'>getMessageFromMaster</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>pipefd</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN215"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>sendMessageToMaster</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>pipefd</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>], </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>str</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN216"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>select_loop</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>maxFd</span><span class='Delimiter'>, </span>fd_set <span class='Operator'>*</span><span class='Declare_Parameter'>workerset</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN217"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Prototype'>getMessageFromWorker</span><span class='Parentheses'>(</span><a href="parallel.h.html#LN39"><span class='Ref_to_Struct'>ParallelState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Delimiter'>, 
</span><a name="LN218"></a>                     <span class='Keyword'>bool </span><span class='Declare_Parameter'>do_wait</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>worker</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN219"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>sendMessageToWorker</span><span class='Parentheses'>(</span><a href="parallel.h.html#LN39"><span class='Ref_to_Struct'>ParallelState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Delimiter'>, 
</span><a name="LN220"></a>                    <span class='Keyword'>int </span><span class='Declare_Parameter'>worker</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>str</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN221"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Prototype'>readMessageFromPipe</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>fd</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN223"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>messageStartsWith</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>prefix</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Parentheses'>(</span>strncmp<span class='Parentheses'>(</span><a href="parallel.c.html#LN223"><span class='Ref_to_Parameter'>msg</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN223"><span class='Ref_to_Parameter'>prefix</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="parallel.c.html#LN223"><span class='Ref_to_Parameter'>prefix</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
<a name="LN225"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>messageEquals</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>pattern</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="parallel.c.html#LN225"><span class='Ref_to_Parameter'>msg</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN225"><span class='Ref_to_Parameter'>pattern</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Shutdown callback to clean up socket access 
 */ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<span class='Keyword'>static void 
</span><a name="LN234"></a><span class='Declare_Function'>shutdown_parallel_dump_utils</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>code</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>unused</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Call the cleanup function only from the main thread */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN194"><span class='Ref_to_Global_Var'>mainThreadId</span></a> <span class='Operator'>== </span>GetCurrentThreadId<span class='Parentheses'>())</span> 
        WSACleanup<span class='Parentheses'>()</span><span class='Delimiter'>; 
} 
</span><span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Initialize parallel dump support --- should be called early in process 
 * startup.  (Currently, this is called whether or not we intend parallel 
 * activity.) 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN248"></a><span class='Declare_Function'>init_parallel_dump_utils</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="parallel.c.html#LN193"><span class='Ref_to_Global_Var'>parallel_init_done</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN253"></a>        WSADATA     <span class='Declare_Local'>wsaData</span><span class='Delimiter'>; 
</span><a name="LN254"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>err</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Prepare for threaded operation */ 
</span>        <a href="parallel.c.html#LN190"><span class='Ref_to_Global_Var'>tls_index</span></a> <span class='Operator'>= </span>TlsAlloc<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="parallel.c.html#LN194"><span class='Ref_to_Global_Var'>mainThreadId</span></a> <span class='Operator'>= </span>GetCurrentThreadId<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Initialize socket access */ 
</span>        <a href="parallel.c.html#LN254"><span class='Ref_To_Local'>err</span></a> <span class='Operator'>= </span>WSAStartup<span class='Parentheses'>(</span>MAKEWORD<span class='Parentheses'>(</span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="parallel.c.html#LN253"><span class='Ref_To_Local'>wsaData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN254"><span class='Ref_To_Local'>err</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: WSAStartup failed: %d\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN254"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../test/examples/testlibpq.c.html#LN12"><span class='Ref_to_Func'>exit_nicely</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Comment_Multi_Line'>/* ... and arrange to shut it down at exit */ 
</span>        <a href="pg_backup_utils.h.html#LN32"><span class='Ref_to_Proto'>on_exit_nicely</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN233"><span class='Ref_to_Func'>shutdown_parallel_dump_utils</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="parallel.c.html#LN193"><span class='Ref_to_Global_Var'>parallel_init_done</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !parallel_init_done &raquo; </span> 
<span class='Directive'>#endif</span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end init_parallel_dump_utils &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Find the ParallelSlot for the current worker process or thread. 
 * 
 * Returns NULL if no matching slot is found (this implies we're the master). 
 */ 
</span><span class='Keyword'>static </span><a href="../scripts/vacuumdb.c.html#LN28"><span class='Ref_to_Struct'>ParallelSlot</span></a> <span class='Operator'>* 
</span><a name="LN280"></a><span class='Declare_Function'>GetMyPSlot</span><span class='Parentheses'>(</span><a href="parallel.h.html#LN39"><span class='Ref_to_Struct'>ParallelState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN282"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN282"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="parallel.c.html#LN282"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="parallel.c.html#LN280"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN41"><span class='Ref_to_Member'>numWorkers</span></a><span class='Delimiter'>; </span><a href="parallel.c.html#LN282"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN280"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN44"><span class='Ref_to_Member'>parallelSlot</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN282"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="parallel.c.html#LN106"><span class='Ref_to_Member'>threadId</span></a> <span class='Operator'>== </span>GetCurrentThreadId<span class='Parentheses'>())</span> 
<span class='Directive'>#else</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN280"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN44"><span class='Ref_to_Member'>parallelSlot</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN282"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="parallel.c.html#LN108"><span class='Ref_to_Member'>pid</span></a> <span class='Operator'>== </span>getpid<span class='Parentheses'>())</span> 
<span class='Directive'>#endif</span> 
            <span class='Control'>return</span> <span class='Operator'>&</span><span class='Parentheses'>(</span><a href="parallel.c.html#LN280"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN44"><span class='Ref_to_Member'>parallelSlot</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN282"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * A thread-local version of getLocalPQExpBuffer(). 
 * 
 * Non-reentrant but reduces memory leakage: we'll consume one buffer per 
 * thread, which is much better than one per fmtId/fmtQualifiedId call. 
 */ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<span class='Keyword'>static </span><a href="../../interfaces/libpq/pqexpbuffer.h.html#LN50"><span class='Ref_to_Typedef'>PQExpBuffer</span></a> 
<a name="LN305"></a><span class='Declare_Function'>getThreadLocalPQExpBuffer</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * The Tls code goes awry if we use a static var, so we provide for both 
     * static and auto, and omit any use of the static var when using Tls. We 
     * rely on TlsGetValue() to return 0 if the value is not yet set. 
     */ 
</span><a name="LN312"></a>    <span class='Keyword'>static </span><a href="../../interfaces/libpq/pqexpbuffer.h.html#LN50"><span class='Ref_to_Typedef'>PQExpBuffer</span></a> <span class='Declare_Local'>s_id_return</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN313"></a>    <a href="../../interfaces/libpq/pqexpbuffer.h.html#LN50"><span class='Ref_to_Typedef'>PQExpBuffer</span></a> <span class='Declare_Local'>id_return</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN193"><span class='Ref_to_Global_Var'>parallel_init_done</span></a><span class='Parentheses'>) 
</span>        <a href="parallel.c.html#LN313"><span class='Ref_To_Local'>id_return</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../interfaces/libpq/pqexpbuffer.h.html#LN50"><span class='Ref_to_Typedef'>PQExpBuffer</span></a><span class='Parentheses'>) </span>TlsGetValue<span class='Parentheses'>(</span><a href="parallel.c.html#LN190"><span class='Ref_to_Global_Var'>tls_index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="parallel.c.html#LN313"><span class='Ref_To_Local'>id_return</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN312"><span class='Ref_To_Local'>s_id_return</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN313"><span class='Ref_To_Local'>id_return</span></a><span class='Parentheses'>)</span>              <span class='Comment_Single_Line'>/* first time through? */ 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* same buffer, just wipe contents */ 
</span>        <a href="../../interfaces/libpq/pqexpbuffer.h.html#LN129"><span class='Ref_to_Proto'>resetPQExpBuffer</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN313"><span class='Ref_To_Local'>id_return</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* new buffer */ 
</span>        <a href="parallel.c.html#LN313"><span class='Ref_To_Local'>id_return</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/pqexpbuffer.c.html#LN69"><span class='Ref_to_Func'>createPQExpBuffer</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN193"><span class='Ref_to_Global_Var'>parallel_init_done</span></a><span class='Parentheses'>) 
</span>            TlsSetValue<span class='Parentheses'>(</span><a href="parallel.c.html#LN190"><span class='Ref_to_Global_Var'>tls_index</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN313"><span class='Ref_To_Local'>id_return</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="parallel.c.html#LN312"><span class='Ref_To_Local'>s_id_return</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN313"><span class='Ref_To_Local'>id_return</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="parallel.c.html#LN313"><span class='Ref_To_Local'>id_return</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end getThreadLocalPQExpBuffer &raquo; </span> 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* WIN32 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * pg_dump and pg_restore call this to register the cleanup handler 
 * as soon as they've created the ArchiveHandle. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN344"></a><span class='Declare_Function'>on_exit_close_archive</span><span class='Parentheses'>(</span><a href="pg_backup.h.html#LN177"><span class='Ref_to_Struct'>Archive</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AHX</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="parallel.c.html#LN147"><span class='Ref_to_Global_Var'>shutdown_info</span></a><span class='Operator'>.</span><a href="parallel.c.html#LN144"><span class='Ref_to_Member'>AHX</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN344"><span class='Ref_to_Parameter'>AHX</span></a><span class='Delimiter'>; 
</span>    <a href="pg_backup_utils.h.html#LN32"><span class='Ref_to_Proto'>on_exit_nicely</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN201"><span class='Ref_to_Proto'>archive_close_connection</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="parallel.c.html#LN147"><span class='Ref_to_Global_Var'>shutdown_info</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * on_exit_nicely handler for shutting down database connections and 
 * worker processes cleanly. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN355"></a><span class='Declare_Function'>archive_close_connection</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>code</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN357"></a>    <a href="parallel.c.html#LN141"><span class='Ref_to_Struct'>ShutdownInformation</span></a> <span class='Operator'>*</span><span class='Declare_Local'>si</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="parallel.c.html#LN141"><span class='Ref_to_Struct'>ShutdownInformation</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="parallel.c.html#LN355"><span class='Ref_to_Parameter'>arg</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN357"><span class='Ref_To_Local'>si</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN143"><span class='Ref_to_Member'>pstate</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* In parallel mode, must figure out who we are */ 
</span><a name="LN362"></a>        <a href="../scripts/vacuumdb.c.html#LN28"><span class='Ref_to_Struct'>ParallelSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>slot</span> <span class='Operator'>= </span><a href="parallel.c.html#LN200"><span class='Ref_to_Proto'>GetMyPSlot</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN357"><span class='Ref_To_Local'>si</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN143"><span class='Ref_to_Member'>pstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="parallel.c.html#LN362"><span class='Ref_To_Local'>slot</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * We're the master.  Forcibly shut down workers, then close our 
             * own database connection, if any. 
             */ 
</span>            <a href="parallel.c.html#LN202"><span class='Ref_to_Proto'>ShutdownWorkersHard</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN357"><span class='Ref_To_Local'>si</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN143"><span class='Ref_to_Member'>pstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN357"><span class='Ref_To_Local'>si</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN144"><span class='Ref_to_Member'>AHX</span></a><span class='Parentheses'>) 
</span>                <a href="../scripts/vacuumdb.c.html#LN73"><span class='Ref_to_Proto'>DisconnectDatabase</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN357"><span class='Ref_To_Local'>si</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN144"><span class='Ref_to_Member'>AHX</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * We're a worker.  Shut down our own DB connection if any.  On 
             * Windows, we also have to close our communication sockets, to 
             * emulate what will happen on Unix when the worker process exits. 
             * (Without this, if this is a premature exit, the master would 
             * fail to detect it because there would be no EOF condition on 
             * the other end of the pipe.) 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN362"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN96"><span class='Ref_to_Member'>AH</span></a><span class='Parentheses'>) 
</span>                <a href="../scripts/vacuumdb.c.html#LN73"><span class='Ref_to_Proto'>DisconnectDatabase</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="parallel.c.html#LN362"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN96"><span class='Ref_to_Member'>AH</span></a><span class='Operator'>-&GT;</span><span class='Keyword'>public</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
            <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN362"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN100"><span class='Ref_to_Member'>pipeRevRead</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN362"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN101"><span class='Ref_to_Member'>pipeRevWrite</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if si-&GT;pstate &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Non-parallel operation: just kill the master DB connection */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN357"><span class='Ref_To_Local'>si</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN144"><span class='Ref_to_Member'>AHX</span></a><span class='Parentheses'>) 
</span>            <a href="../scripts/vacuumdb.c.html#LN73"><span class='Ref_to_Proto'>DisconnectDatabase</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN357"><span class='Ref_To_Local'>si</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN144"><span class='Ref_to_Member'>AHX</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end archive_close_connection &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Forcibly shut down any remaining workers, waiting for them to finish. 
 * 
 * Note that we don't expect to come here during normal exit (the workers 
 * should be long gone, and the ParallelState too).  We're only here in an 
 * exit_horribly() situation, so intervening to cancel active commands is 
 * appropriate. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN411"></a><span class='Declare_Function'>ShutdownWorkersHard</span><span class='Parentheses'>(</span><a href="parallel.h.html#LN39"><span class='Ref_to_Struct'>ParallelState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN413"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Close our write end of the sockets so that any workers waiting for 
     * commands know they can exit. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN413"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="parallel.c.html#LN413"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="parallel.c.html#LN411"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN41"><span class='Ref_to_Member'>numWorkers</span></a><span class='Delimiter'>; </span><a href="parallel.c.html#LN413"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN411"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN44"><span class='Ref_to_Member'>parallelSlot</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN413"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="parallel.c.html#LN99"><span class='Ref_to_Member'>pipeWrite</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Force early termination of any commands currently in progress. 
     */ 
</span><span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <span class='Comment_Multi_Line'>/* On non-Windows, send SIGTERM to each worker process. */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN413"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="parallel.c.html#LN413"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="parallel.c.html#LN411"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN41"><span class='Ref_to_Member'>numWorkers</span></a><span class='Delimiter'>; </span><a href="parallel.c.html#LN413"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN429"></a>        <a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a>       <span class='Declare_Local'>pid</span> <span class='Operator'>= </span><a href="parallel.c.html#LN411"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN44"><span class='Ref_to_Member'>parallelSlot</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN413"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="parallel.c.html#LN108"><span class='Ref_to_Member'>pid</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN429"><span class='Ref_To_Local'>pid</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="../../include/port.h.html#LN210"><span class='Ref_to_Macro'>kill</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN429"><span class='Ref_To_Local'>pid</span></a><span class='Delimiter'>, </span>SIGTERM<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#else</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * On Windows, send query cancels directly to the workers' backends.  Use 
     * a critical section to ensure worker threads don't change state. 
     */ 
</span>    EnterCriticalSection<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN171"><span class='Ref_to_Global_Var'>signal_info_lock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN413"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="parallel.c.html#LN413"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="parallel.c.html#LN411"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN41"><span class='Ref_to_Member'>numWorkers</span></a><span class='Delimiter'>; </span><a href="parallel.c.html#LN413"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN443"></a>        <a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Local'>AH</span> <span class='Operator'>= </span><a href="parallel.c.html#LN411"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN44"><span class='Ref_to_Member'>parallelSlot</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN413"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="parallel.c.html#LN96"><span class='Ref_to_Member'>AH</span></a><span class='Delimiter'>; 
</span><a name="LN444"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>errbuf</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN443"><span class='Ref_To_Local'>AH</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="parallel.c.html#LN443"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN286"><span class='Ref_to_Member'>connCancel</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN304"><span class='Ref_to_Proto'>PQcancel</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN443"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN286"><span class='Ref_to_Member'>connCancel</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN444"><span class='Ref_To_Local'>errbuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="parallel.c.html#LN444"><span class='Ref_To_Local'>errbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    LeaveCriticalSection<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN171"><span class='Ref_to_Global_Var'>signal_info_lock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* Now wait for them to terminate. */ 
</span>    <a href="parallel.c.html#LN203"><span class='Ref_to_Proto'>WaitForTerminatingWorkers</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN411"><span class='Ref_to_Parameter'>pstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ShutdownWorkersHard &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Wait for all workers to terminate. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN460"></a><span class='Declare_Function'>WaitForTerminatingWorkers</span><span class='Parentheses'>(</span><a href="parallel.h.html#LN39"><span class='Ref_to_Struct'>ParallelState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="parallel.c.html#LN209"><span class='Ref_to_Proto'>HasEveryWorkerTerminated</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN460"><span class='Ref_to_Parameter'>pstate</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN464"></a>        <a href="../scripts/vacuumdb.c.html#LN28"><span class='Ref_to_Struct'>ParallelSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>slot</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN465"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>j</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
        <span class='Comment_Multi_Line'>/* On non-Windows, use wait() to wait for next worker to end */ 
</span><a name="LN469"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>status</span><span class='Delimiter'>; 
</span><a name="LN470"></a>        <a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a>       <span class='Declare_Local'>pid</span> <span class='Operator'>= </span>wait<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN469"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Find dead worker's slot, and clear the PID field */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN465"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="parallel.c.html#LN465"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><a href="parallel.c.html#LN460"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN41"><span class='Ref_to_Member'>numWorkers</span></a><span class='Delimiter'>; </span><a href="parallel.c.html#LN465"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="parallel.c.html#LN464"><span class='Ref_To_Local'>slot</span></a> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="parallel.c.html#LN460"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN44"><span class='Ref_to_Member'>parallelSlot</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN465"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN464"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN108"><span class='Ref_to_Member'>pid</span></a> <span class='Operator'>== </span><a href="parallel.c.html#LN470"><span class='Ref_To_Local'>pid</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="parallel.c.html#LN464"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN108"><span class='Ref_to_Member'>pid</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span><span class='Directive'>#else</span>                           <span class='Comment_Single_Line'>/* WIN32 */ 
</span>        <span class='Comment_Multi_Line'>/* On Windows, we must use WaitForMultipleObjects() */ 
</span><a name="LN484"></a>        HANDLE     <span class='Operator'>*</span><span class='Declare_Local'>lpHandles</span> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN25"><span class='Ref_to_Proto'>pg_malloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span>HANDLE<span class='Parentheses'>) </span><span class='Operator'>* </span><a href="parallel.c.html#LN460"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN41"><span class='Ref_to_Member'>numWorkers</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN485"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>nrun</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN486"></a>        <span class='Keyword'>DWORD</span>       <span class='Declare_Local'>ret</span><span class='Delimiter'>; 
</span><a name="LN487"></a>        uintptr_t   <span class='Declare_Local'>hThread</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN465"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="parallel.c.html#LN465"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><a href="parallel.c.html#LN460"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN41"><span class='Ref_to_Member'>numWorkers</span></a><span class='Delimiter'>; </span><a href="parallel.c.html#LN465"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN460"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN44"><span class='Ref_to_Member'>parallelSlot</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN465"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="parallel.c.html#LN90"><span class='Ref_to_Member'>workerStatus</span></a> <span class='Operator'>!= </span><a href="parallel.c.html#LN78"><span class='Ref_to_EnumConst'>WRKR_TERMINATED</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="parallel.c.html#LN484"><span class='Ref_To_Local'>lpHandles</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN485"><span class='Ref_To_Local'>nrun</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Parentheses'>(</span>HANDLE<span class='Parentheses'>) </span><a href="parallel.c.html#LN460"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN44"><span class='Ref_to_Member'>parallelSlot</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN465"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="parallel.c.html#LN105"><span class='Ref_to_Member'>hThread</span></a><span class='Delimiter'>; 
</span>                <a href="parallel.c.html#LN485"><span class='Ref_To_Local'>nrun</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <a href="parallel.c.html#LN486"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span>WaitForMultipleObjects<span class='Parentheses'>(</span><a href="parallel.c.html#LN485"><span class='Ref_To_Local'>nrun</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN484"><span class='Ref_To_Local'>lpHandles</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span>INFINITE<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="parallel.c.html#LN486"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>!= </span>WAIT_FAILED<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="parallel.c.html#LN487"><span class='Ref_To_Local'>hThread</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span>uintptr_t<span class='Parentheses'>) </span><a href="parallel.c.html#LN484"><span class='Ref_To_Local'>lpHandles</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN486"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>- </span>WAIT_OBJECT_0<span class='Delimiter'>]; 
</span>        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN484"><span class='Ref_To_Local'>lpHandles</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Find dead worker's slot, and clear the hThread field */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN465"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="parallel.c.html#LN465"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><a href="parallel.c.html#LN460"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN41"><span class='Ref_to_Member'>numWorkers</span></a><span class='Delimiter'>; </span><a href="parallel.c.html#LN465"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="parallel.c.html#LN464"><span class='Ref_To_Local'>slot</span></a> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="parallel.c.html#LN460"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN44"><span class='Ref_to_Member'>parallelSlot</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN465"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN464"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN105"><span class='Ref_to_Member'>hThread</span></a> <span class='Operator'>== </span><a href="parallel.c.html#LN487"><span class='Ref_To_Local'>hThread</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* For cleanliness, close handles for dead threads */ 
</span>                CloseHandle<span class='Parentheses'>((</span>HANDLE<span class='Parentheses'>) </span><a href="parallel.c.html#LN464"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN105"><span class='Ref_to_Member'>hThread</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="parallel.c.html#LN464"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN105"><span class='Ref_to_Member'>hThread</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span>uintptr_t<span class='Parentheses'>) </span>INVALID_HANDLE_VALUE<span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* WIN32 */ 
</span> 
        <span class='Comment_Multi_Line'>/* On all platforms, update workerStatus and te[] as well */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="parallel.c.html#LN465"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><a href="parallel.c.html#LN460"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN41"><span class='Ref_to_Member'>numWorkers</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="parallel.c.html#LN464"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN90"><span class='Ref_to_Member'>workerStatus</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN78"><span class='Ref_to_EnumConst'>WRKR_TERMINATED</span></a><span class='Delimiter'>; 
</span>        <a href="parallel.c.html#LN460"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN43"><span class='Ref_to_Member'>te</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN465"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while !HasEveryWorkerTermin... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end WaitForTerminatingWorkers &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Code for responding to cancel interrupts (SIGINT, control-C, etc) 
 * 
 * This doesn't quite belong in this module, but it needs access to the 
 * ParallelState data, so there's not really a better place either. 
 * 
 * When we get a cancel interrupt, we could just die, but in pg_restore that 
 * could leave a SQL command (e.g., CREATE INDEX on a large table) running 
 * for a long time.  Instead, we try to send a cancel request and then die. 
 * pg_dump probably doesn't really need this, but we might as well use it 
 * there too.  Note that sending the cancel directly from the signal handler 
 * is safe because PQcancel() is written to make it so. 
 * 
 * In parallel operation on Unix, each process is responsible for canceling 
 * its own connection (this must be so because nobody else has access to it). 
 * Furthermore, the master process should attempt to forward its signal to 
 * each child.  In simple manual use of pg_dump/pg_restore, forwarding isn't 
 * needed because typing control-C at the console would deliver SIGINT to 
 * every member of the terminal process group --- but in other scenarios it 
 * might be that only the master gets signaled. 
 * 
 * On Windows, the cancel handler runs in a separate thread, because that's 
 * how SetConsoleCtrlHandler works.  We make it stop worker threads, send 
 * cancels on all active connections, and then return FALSE, which will allow 
 * the process to die.  For safety's sake, we use a critical section to 
 * protect the PGcancel structures against being changed while the signal 
 * thread runs. 
 */ 
</span> 
<span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
 
<span class='Comment_Multi_Line'>/* 
 * Signal handler (Unix only) 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN559"></a><span class='Declare_Function'>sigTermHandler</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1078"><span class='Ref_to_Const'>SIGNAL_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN561"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN562"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>errbuf</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Some platforms allow delivery of new signals to interrupt an active 
     * signal handler.  That could muck up our attempt to send PQcancel, so 
     * disable the signals that setup_cancel_handler enabled. 
     */ 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span>SIGINT<span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN184"><span class='Ref_to_Const'>SIG_IGN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span>SIGTERM<span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN184"><span class='Ref_to_Const'>SIG_IGN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN188"><span class='Ref_to_Const'>SIGQUIT</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN184"><span class='Ref_to_Const'>SIG_IGN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we're in the master, forward signal to all workers.  (It seems best 
     * to do this before PQcancel; killing the master transaction will result 
     * in invalid-snapshot errors from active workers, which maybe we can 
     * quiet by killing workers first.)  Ignore any errors. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN168"><span class='Ref_to_Global_Var'>signal_info</span></a><span class='Operator'>.</span><a href="parallel.c.html#LN161"><span class='Ref_to_Member'>pstate</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN561"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="parallel.c.html#LN561"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="parallel.c.html#LN168"><span class='Ref_to_Global_Var'>signal_info</span></a><span class='Operator'>.</span><a href="parallel.c.html#LN161"><span class='Ref_to_Member'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN41"><span class='Ref_to_Member'>numWorkers</span></a><span class='Delimiter'>; </span><a href="parallel.c.html#LN561"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN583"></a>            <a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a>       <span class='Declare_Local'>pid</span> <span class='Operator'>= </span><a href="parallel.c.html#LN168"><span class='Ref_to_Global_Var'>signal_info</span></a><span class='Operator'>.</span><a href="parallel.c.html#LN161"><span class='Ref_to_Member'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN44"><span class='Ref_to_Member'>parallelSlot</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN561"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="parallel.c.html#LN108"><span class='Ref_to_Member'>pid</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN583"><span class='Ref_To_Local'>pid</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="../../include/port.h.html#LN210"><span class='Ref_to_Macro'>kill</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN583"><span class='Ref_To_Local'>pid</span></a><span class='Delimiter'>, </span>SIGTERM<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Send QueryCancel if we have a connection to send to.  Ignore errors, 
     * there's not much we can do about them anyway. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN168"><span class='Ref_to_Global_Var'>signal_info</span></a><span class='Operator'>.</span><a href="parallel.c.html#LN160"><span class='Ref_to_Member'>myAH</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="parallel.c.html#LN168"><span class='Ref_to_Global_Var'>signal_info</span></a><span class='Operator'>.</span><a href="parallel.c.html#LN160"><span class='Ref_to_Member'>myAH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN286"><span class='Ref_to_Member'>connCancel</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN304"><span class='Ref_to_Proto'>PQcancel</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN168"><span class='Ref_to_Global_Var'>signal_info</span></a><span class='Operator'>.</span><a href="parallel.c.html#LN160"><span class='Ref_to_Member'>myAH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN286"><span class='Ref_to_Member'>connCancel</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN562"><span class='Ref_To_Local'>errbuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="parallel.c.html#LN562"><span class='Ref_To_Local'>errbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Report we're quitting, using nothing more complicated than write(2). 
     * When in parallel operation, only the master process should do this. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="parallel.c.html#LN168"><span class='Ref_to_Global_Var'>signal_info</span></a><span class='Operator'>.</span><a href="parallel.c.html#LN164"><span class='Ref_to_Member'>am_worker</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="parallel.c.html#LN179"><span class='Ref_to_Macro'>write_stderr</span></a><span class='Parentheses'>(</span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="parallel.c.html#LN179"><span class='Ref_to_Macro'>write_stderr</span></a><span class='Parentheses'>(</span><span class='String'>": "</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="parallel.c.html#LN179"><span class='Ref_to_Macro'>write_stderr</span></a><span class='Parentheses'>(</span><span class='String'>"terminated by user\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* And die. */ 
</span>    <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end sigTermHandler &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Enable cancel interrupt handler, if not already done. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN619"></a><span class='Declare_Function'>setup_cancel_handler</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * When forking, signal_info.handler_set will propagate into the new 
     * process, but that's fine because the signal handler state does too. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="parallel.c.html#LN168"><span class='Ref_to_Global_Var'>signal_info</span></a><span class='Operator'>.</span><a href="parallel.c.html#LN162"><span class='Ref_to_Member'>handler_set</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="parallel.c.html#LN168"><span class='Ref_to_Global_Var'>signal_info</span></a><span class='Operator'>.</span><a href="parallel.c.html#LN162"><span class='Ref_to_Member'>handler_set</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
        <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span>SIGINT<span class='Delimiter'>, </span><a href="parallel.c.html#LN558"><span class='Ref_to_Func'>sigTermHandler</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span>SIGTERM<span class='Delimiter'>, </span><a href="parallel.c.html#LN558"><span class='Ref_to_Func'>sigTermHandler</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN188"><span class='Ref_to_Const'>SIGQUIT</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN558"><span class='Ref_to_Func'>sigTermHandler</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
<span class='Directive'>#else</span>                           <span class='Comment_Single_Line'>/* WIN32 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Console interrupt handler --- runs in a newly-started thread. 
 * 
 * After stopping other threads and sending cancel requests on all open 
 * connections, we return FALSE which will allow the default ExitProcess() 
 * action to be taken. 
 */ 
</span><span class='Keyword'>static </span>BOOL WINAPI 
<a name="LN645"></a><span class='Declare_Function'>consoleHandler</span><span class='Parentheses'>(</span><span class='Keyword'>DWORD </span><span class='Declare_Parameter'>dwCtrlType</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN647"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN648"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>errbuf</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN645"><span class='Ref_to_Parameter'>dwCtrlType</span></a> <span class='Operator'>== </span>CTRL_C_EVENT <span class='Operator'>|| 
</span>        <a href="parallel.c.html#LN645"><span class='Ref_to_Parameter'>dwCtrlType</span></a> <span class='Operator'>== </span>CTRL_BREAK_EVENT<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Critical section prevents changing data we look at here */ 
</span>        EnterCriticalSection<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN171"><span class='Ref_to_Global_Var'>signal_info_lock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If in parallel mode, stop worker threads and send QueryCancel to 
         * their connected backends.  The main point of stopping the worker 
         * threads is to keep them from reporting the query cancels as errors, 
         * which would clutter the user's screen.  We needn't stop the master 
         * thread since it won't be doing much anyway.  Do this before 
         * canceling the main transaction, else we might get invalid-snapshot 
         * errors reported before we can stop the workers.  Ignore errors, 
         * there's not much we can do about them anyway. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN168"><span class='Ref_to_Global_Var'>signal_info</span></a><span class='Operator'>.</span><a href="parallel.c.html#LN161"><span class='Ref_to_Member'>pstate</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN647"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="parallel.c.html#LN647"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="parallel.c.html#LN168"><span class='Ref_to_Global_Var'>signal_info</span></a><span class='Operator'>.</span><a href="parallel.c.html#LN161"><span class='Ref_to_Member'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN41"><span class='Ref_to_Member'>numWorkers</span></a><span class='Delimiter'>; </span><a href="parallel.c.html#LN647"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN670"></a>                <a href="../scripts/vacuumdb.c.html#LN28"><span class='Ref_to_Struct'>ParallelSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>slot</span> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="parallel.c.html#LN168"><span class='Ref_to_Global_Var'>signal_info</span></a><span class='Operator'>.</span><a href="parallel.c.html#LN161"><span class='Ref_to_Member'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN44"><span class='Ref_to_Member'>parallelSlot</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN647"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN671"></a>                <a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Local'>AH</span> <span class='Operator'>= </span><a href="parallel.c.html#LN670"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN96"><span class='Ref_to_Member'>AH</span></a><span class='Delimiter'>; 
</span><a name="LN672"></a>                HANDLE      <span class='Declare_Local'>hThread</span> <span class='Operator'>= </span><span class='Parentheses'>(</span>HANDLE<span class='Parentheses'>) </span><a href="parallel.c.html#LN670"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN105"><span class='Ref_to_Member'>hThread</span></a><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * Using TerminateThread here may leave some resources leaked, 
                 * but it doesn't matter since we're about to end the whole 
                 * process. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN672"><span class='Ref_To_Local'>hThread</span></a> <span class='Operator'>!= </span>INVALID_HANDLE_VALUE<span class='Parentheses'>) 
</span>                    TerminateThread<span class='Parentheses'>(</span><a href="parallel.c.html#LN672"><span class='Ref_To_Local'>hThread</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN671"><span class='Ref_To_Local'>AH</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="parallel.c.html#LN671"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN286"><span class='Ref_to_Member'>connCancel</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN304"><span class='Ref_to_Proto'>PQcancel</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN671"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN286"><span class='Ref_to_Member'>connCancel</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN648"><span class='Ref_To_Local'>errbuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="parallel.c.html#LN648"><span class='Ref_To_Local'>errbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if signal_info.pstate!=N... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Send QueryCancel to master connection, if enabled.  Ignore errors, 
         * there's not much we can do about them anyway. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN168"><span class='Ref_to_Global_Var'>signal_info</span></a><span class='Operator'>.</span><a href="parallel.c.html#LN160"><span class='Ref_to_Member'>myAH</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="parallel.c.html#LN168"><span class='Ref_to_Global_Var'>signal_info</span></a><span class='Operator'>.</span><a href="parallel.c.html#LN160"><span class='Ref_to_Member'>myAH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN286"><span class='Ref_to_Member'>connCancel</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN304"><span class='Ref_to_Proto'>PQcancel</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN168"><span class='Ref_to_Global_Var'>signal_info</span></a><span class='Operator'>.</span><a href="parallel.c.html#LN160"><span class='Ref_to_Member'>myAH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN286"><span class='Ref_to_Member'>connCancel</span></a><span class='Delimiter'>, 
</span>                            <a href="parallel.c.html#LN648"><span class='Ref_To_Local'>errbuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="parallel.c.html#LN648"><span class='Ref_To_Local'>errbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        LeaveCriticalSection<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN171"><span class='Ref_to_Global_Var'>signal_info_lock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Report we're quitting, using nothing more complicated than 
         * write(2).  (We might be able to get away with using write_msg() 
         * here, but since we terminated other threads uncleanly above, it 
         * seems better to assume as little as possible.) 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="parallel.c.html#LN179"><span class='Ref_to_Macro'>write_stderr</span></a><span class='Parentheses'>(</span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="parallel.c.html#LN179"><span class='Ref_to_Macro'>write_stderr</span></a><span class='Parentheses'>(</span><span class='String'>": "</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="parallel.c.html#LN179"><span class='Ref_to_Macro'>write_stderr</span></a><span class='Parentheses'>(</span><span class='String'>"terminated by user\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if dwCtrlType==CTRL_C_EV... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Always return FALSE to allow signal handling to continue */ 
</span>    <span class='Control'>return</span> <span class='Boolean'>FALSE</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end consoleHandler &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Enable cancel interrupt handler, if not already done. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN719"></a><span class='Declare_Function'>setup_cancel_handler</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="parallel.c.html#LN168"><span class='Ref_to_Global_Var'>signal_info</span></a><span class='Operator'>.</span><a href="parallel.c.html#LN162"><span class='Ref_to_Member'>handler_set</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="parallel.c.html#LN168"><span class='Ref_to_Global_Var'>signal_info</span></a><span class='Operator'>.</span><a href="parallel.c.html#LN162"><span class='Ref_to_Member'>handler_set</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
        InitializeCriticalSection<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN171"><span class='Ref_to_Global_Var'>signal_info_lock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        SetConsoleCtrlHandler<span class='Parentheses'>(</span><a href="../psql/common.c.html#LN336"><span class='Ref_to_Func'>consoleHandler</span></a><span class='Delimiter'>, </span><span class='Boolean'>TRUE</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* WIN32 */ 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * set_archive_cancel_info 
 * 
 * Fill AH-&GT;connCancel with cancellation info for the specified database 
 * connection; or clear it if conn is NULL. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN741"></a><span class='Declare_Function'>set_archive_cancel_info</span><span class='Parentheses'>(</span><a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AH</span><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN743"></a>    <a href="../../interfaces/libpq/libpq-fe.h.html#LN152"><span class='Ref_to_Typedef'>PGcancel</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>oldConnCancel</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Activate the interrupt handler if we didn't yet in this process.  On 
     * Windows, this also initializes signal_info_lock; therefore it's 
     * important that this happen at least once before we fork off any 
     * threads. 
     */ 
</span>    <a href="../psql/common.h.html#LN30"><span class='Ref_to_Proto'>setup_cancel_handler</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * On Unix, we assume that storing a pointer value is atomic with respect 
     * to any possible signal interrupt.  On Windows, use a critical section. 
     */ 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    EnterCriticalSection<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN171"><span class='Ref_to_Global_Var'>signal_info_lock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* Free the old one if we have one */ 
</span>    <a href="parallel.c.html#LN743"><span class='Ref_To_Local'>oldConnCancel</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN741"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN286"><span class='Ref_to_Member'>connCancel</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* be sure interrupt handler doesn't use pointer while freeing */ 
</span>    <a href="parallel.c.html#LN741"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN286"><span class='Ref_to_Member'>connCancel</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN743"><span class='Ref_To_Local'>oldConnCancel</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../interfaces/libpq/libpq-fe.h.html#LN301"><span class='Ref_to_Proto'>PQfreeCancel</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN743"><span class='Ref_To_Local'>oldConnCancel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set the new one if specified */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN741"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>) 
</span>        <a href="parallel.c.html#LN741"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN286"><span class='Ref_to_Member'>connCancel</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN298"><span class='Ref_to_Proto'>PQgetCancel</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN741"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * On Unix, there's only ever one active ArchiveHandle per process, so we 
     * can just set signal_info.myAH unconditionally.  On Windows, do that 
     * only in the main thread; worker threads have to make sure their 
     * ArchiveHandle appears in the pstate data, which is dealt with in 
     * RunWorker(). 
     */ 
</span><span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <a href="parallel.c.html#LN168"><span class='Ref_to_Global_Var'>signal_info</span></a><span class='Operator'>.</span><a href="parallel.c.html#LN160"><span class='Ref_to_Member'>myAH</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN741"><span class='Ref_to_Parameter'>AH</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN194"><span class='Ref_to_Global_Var'>mainThreadId</span></a> <span class='Operator'>== </span>GetCurrentThreadId<span class='Parentheses'>())</span> 
        <a href="parallel.c.html#LN168"><span class='Ref_to_Global_Var'>signal_info</span></a><span class='Operator'>.</span><a href="parallel.c.html#LN160"><span class='Ref_to_Member'>myAH</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN741"><span class='Ref_to_Parameter'>AH</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    LeaveCriticalSection<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN171"><span class='Ref_to_Global_Var'>signal_info_lock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end set_archive_cancel_info &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * set_cancel_pstate 
 * 
 * Set signal_info.pstate to point to the specified ParallelState, if any. 
 * We need this mainly to have an interlock against Windows signal thread. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN800"></a><span class='Declare_Function'>set_cancel_pstate</span><span class='Parentheses'>(</span><a href="parallel.h.html#LN39"><span class='Ref_to_Struct'>ParallelState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    EnterCriticalSection<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN171"><span class='Ref_to_Global_Var'>signal_info_lock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <a href="parallel.c.html#LN168"><span class='Ref_to_Global_Var'>signal_info</span></a><span class='Operator'>.</span><a href="parallel.c.html#LN161"><span class='Ref_to_Member'>pstate</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN800"><span class='Ref_to_Parameter'>pstate</span></a><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    LeaveCriticalSection<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN171"><span class='Ref_to_Global_Var'>signal_info_lock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * set_cancel_slot_archive 
 * 
 * Set ParallelSlot's AH field to point to the specified archive, if any. 
 * We need this mainly to have an interlock against Windows signal thread. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN820"></a><span class='Declare_Function'>set_cancel_slot_archive</span><span class='Parentheses'>(</span><a href="../scripts/vacuumdb.c.html#LN28"><span class='Ref_to_Struct'>ParallelSlot</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>slot</span><span class='Delimiter'>, </span><a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AH</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    EnterCriticalSection<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN171"><span class='Ref_to_Global_Var'>signal_info_lock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <a href="parallel.c.html#LN820"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN96"><span class='Ref_to_Member'>AH</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN820"><span class='Ref_to_Parameter'>AH</span></a><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    LeaveCriticalSection<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN171"><span class='Ref_to_Global_Var'>signal_info_lock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * This function is called by both Unix and Windows variants to set up 
 * and run a worker process.  Caller should exit the process (or thread) 
 * upon return. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN840"></a><span class='Declare_Function'>RunWorker</span><span class='Parentheses'>(</span><a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AH</span><span class='Delimiter'>, </span><a href="../scripts/vacuumdb.c.html#LN28"><span class='Ref_to_Struct'>ParallelSlot</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>slot</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN842"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>pipefd</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* fetch child ends of pipes */ 
</span>    <a href="parallel.c.html#LN842"><span class='Ref_To_Local'>pipefd</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN68"><span class='Ref_to_Const'>PIPE_READ</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="parallel.c.html#LN840"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN100"><span class='Ref_to_Member'>pipeRevRead</span></a><span class='Delimiter'>; 
</span>    <a href="parallel.c.html#LN842"><span class='Ref_To_Local'>pipefd</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN69"><span class='Ref_to_Const'>PIPE_WRITE</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="parallel.c.html#LN840"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN101"><span class='Ref_to_Member'>pipeRevWrite</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Clone the archive so that we have our own state to work with, and in 
     * particular our own database connection. 
     * 
     * We clone on Unix as well as Windows, even though technically we don't 
     * need to because fork() gives us a copy in our own address space 
     * already.  But CloneArchive resets the state information and also clones 
     * the database connection which both seem kinda helpful. 
     */ 
</span>    <a href="parallel.c.html#LN840"><span class='Ref_to_Parameter'>AH</span></a> <span class='Operator'>= </span><a href="pg_backup_archiver.h.html#LN389"><span class='Ref_to_Proto'>CloneArchive</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN840"><span class='Ref_to_Parameter'>AH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Remember cloned archive where signal handler can find it */ 
</span>    <a href="parallel.c.html#LN206"><span class='Ref_to_Proto'>set_cancel_slot_archive</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN840"><span class='Ref_to_Parameter'>slot</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN840"><span class='Ref_to_Parameter'>AH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Call the setup worker function that's defined in the ArchiveHandle. 
     */ 
</span>    <span class='Parentheses'>(</span><a href="parallel.c.html#LN840"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN270"><span class='Ref_to_Member'>SetupWorkerPtr</span></a><span class='Parentheses'>) ((</span><a href="pg_backup.h.html#LN177"><span class='Ref_to_Struct'>Archive</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="parallel.c.html#LN840"><span class='Ref_to_Parameter'>AH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Execute commands until done. 
     */ 
</span>    <a href="parallel.c.html#LN211"><span class='Ref_to_Proto'>WaitForCommands</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN840"><span class='Ref_to_Parameter'>AH</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN842"><span class='Ref_To_Local'>pipefd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Disconnect from database and clean up. 
     */ 
</span>    <a href="parallel.c.html#LN206"><span class='Ref_to_Proto'>set_cancel_slot_archive</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN840"><span class='Ref_to_Parameter'>slot</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../scripts/vacuumdb.c.html#LN73"><span class='Ref_to_Proto'>DisconnectDatabase</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="parallel.c.html#LN840"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><span class='Keyword'>public</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="pg_backup_archiver.h.html#LN390"><span class='Ref_to_Proto'>DeCloneArchive</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN840"><span class='Ref_to_Parameter'>AH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RunWorker &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Thread base function for Windows 
 */ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<span class='Keyword'>static unsigned </span>__stdcall 
<a name="LN885"></a><span class='Declare_Function'>init_spawned_worker_win32</span><span class='Parentheses'>(</span><a href="../../backend/postmaster/autovacuum.c.html#LN232"><span class='Ref_to_Typedef'>WorkerInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>wi</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN887"></a>    <a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Local'>AH</span> <span class='Operator'>= </span><a href="parallel.c.html#LN885"><span class='Ref_to_Parameter'>wi</span></a><span class='Operator'>-&GT;</span>AH<span class='Delimiter'>; 
</span><a name="LN888"></a>    <a href="../scripts/vacuumdb.c.html#LN28"><span class='Ref_to_Struct'>ParallelSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>slot</span> <span class='Operator'>= </span><a href="parallel.c.html#LN885"><span class='Ref_to_Parameter'>wi</span></a><span class='Operator'>-&GT;</span>slot<span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Don't need WorkerInfo anymore */ 
</span>    <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN885"><span class='Ref_to_Parameter'>wi</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Run the worker ... */ 
</span>    <a href="parallel.c.html#LN207"><span class='Ref_to_Proto'>RunWorker</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN887"><span class='Ref_To_Local'>AH</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN888"><span class='Ref_To_Local'>slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Exit the thread */ 
</span>    _endthreadex<span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
} 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* WIN32 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * This function starts a parallel dump or restore by spawning off the worker 
 * processes.  For Windows, it creates a number of threads; on Unix the 
 * workers are created with fork(). 
 */ 
</span><a href="parallel.h.html#LN39"><span class='Ref_to_Struct'>ParallelState</span></a> <span class='Operator'>* 
</span><a name="LN908"></a><span class='Declare_Function'>ParallelBackupStart</span><span class='Parentheses'>(</span><a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AH</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN910"></a>    <a href="parallel.h.html#LN39"><span class='Ref_to_Struct'>ParallelState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>pstate</span><span class='Delimiter'>; 
</span><a name="LN911"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="parallel.c.html#LN908"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><span class='Keyword'>public</span><span class='Operator'>.</span><a href="pg_backup.h.html#LN190"><span class='Ref_to_Member'>numWorkers</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="parallel.c.html#LN910"><span class='Ref_To_Local'>pstate</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="parallel.h.html#LN39"><span class='Ref_to_Struct'>ParallelState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN25"><span class='Ref_to_Proto'>pg_malloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="parallel.h.html#LN39"><span class='Ref_to_Struct'>ParallelState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="parallel.c.html#LN910"><span class='Ref_To_Local'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN41"><span class='Ref_to_Member'>numWorkers</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN908"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><span class='Keyword'>public</span><span class='Operator'>.</span><a href="pg_backup.h.html#LN190"><span class='Ref_to_Member'>numWorkers</span></a><span class='Delimiter'>; 
</span>    <a href="parallel.c.html#LN910"><span class='Ref_To_Local'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN43"><span class='Ref_to_Member'>te</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="parallel.c.html#LN910"><span class='Ref_To_Local'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN44"><span class='Ref_to_Member'>parallelSlot</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN908"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><span class='Keyword'>public</span><span class='Operator'>.</span><a href="pg_backup.h.html#LN190"><span class='Ref_to_Member'>numWorkers</span></a> <span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="parallel.c.html#LN910"><span class='Ref_To_Local'>pstate</span></a><span class='Delimiter'>; 
</span> 
    <a href="parallel.c.html#LN910"><span class='Ref_To_Local'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN43"><span class='Ref_to_Member'>te</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pg_backup_archiver.h.html#LN120"><span class='Ref_to_Typedef'>TocEntry</span></a> <span class='Operator'>**</span><span class='Parentheses'>) 
</span>        <a href="../../include/common/fe_memutils.h.html#LN26"><span class='Ref_to_Proto'>pg_malloc0</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN910"><span class='Ref_To_Local'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN41"><span class='Ref_to_Member'>numWorkers</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_backup_archiver.h.html#LN120"><span class='Ref_to_Typedef'>TocEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="parallel.c.html#LN910"><span class='Ref_To_Local'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN44"><span class='Ref_to_Member'>parallelSlot</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../scripts/vacuumdb.c.html#LN28"><span class='Ref_to_Struct'>ParallelSlot</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../include/common/fe_memutils.h.html#LN26"><span class='Ref_to_Proto'>pg_malloc0</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN910"><span class='Ref_To_Local'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN41"><span class='Ref_to_Member'>numWorkers</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../scripts/vacuumdb.c.html#LN28"><span class='Ref_to_Struct'>ParallelSlot</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <span class='Comment_Multi_Line'>/* Make fmtId() and fmtQualifiedId() use thread-local storage */ 
</span>    <a href="../../fe_utils/string_utils.c.html#LN28"><span class='Ref_to_Global_Var'>getLocalPQExpBuffer</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN304"><span class='Ref_to_Func'>getThreadLocalPQExpBuffer</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Set the pstate in shutdown_info, to tell the exit handler that it must 
     * clean up workers as well as the main database connection.  But we don't 
     * set this in signal_info yet, because we don't want child processes to 
     * inherit non-NULL signal_info.pstate. 
     */ 
</span>    <a href="parallel.c.html#LN147"><span class='Ref_to_Global_Var'>shutdown_info</span></a><span class='Operator'>.</span><a href="parallel.c.html#LN143"><span class='Ref_to_Member'>pstate</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN910"><span class='Ref_To_Local'>pstate</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Temporarily disable query cancellation on the master connection.  This 
     * ensures that child processes won't inherit valid AH-&GT;connCancel 
     * settings and thus won't try to issue cancels against the master's 
     * connection.  No harm is done if we fail while it's disabled, because 
     * the master connection is idle at this point anyway. 
     */ 
</span>    <a href="parallel.h.html#LN67"><span class='Ref_to_Proto'>set_archive_cancel_info</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN908"><span class='Ref_to_Parameter'>AH</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Ensure stdio state is quiesced before forking */ 
</span>    fflush<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Create desired number of workers */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN911"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="parallel.c.html#LN911"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="parallel.c.html#LN910"><span class='Ref_To_Local'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN41"><span class='Ref_to_Member'>numWorkers</span></a><span class='Delimiter'>; </span><a href="parallel.c.html#LN911"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN958"></a>        <a href="../../backend/postmaster/autovacuum.c.html#LN232"><span class='Ref_to_Typedef'>WorkerInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>wi</span><span class='Delimiter'>; 
</span><a name="LN959"></a>        uintptr_t   <span class='Declare_Local'>handle</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
<a name="LN961"></a>        <a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a>       <span class='Declare_Local'>pid</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<a name="LN963"></a>        <a href="../scripts/vacuumdb.c.html#LN28"><span class='Ref_to_Struct'>ParallelSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>slot</span> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="parallel.c.html#LN910"><span class='Ref_To_Local'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN44"><span class='Ref_to_Member'>parallelSlot</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN911"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN964"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>pipeMW</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>], 
</span><a name="LN965"></a>                    <span class='Declare_Local'>pipeWM</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]; 
</span> 
        <span class='Comment_Multi_Line'>/* Create communication pipes for this worker */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN125"><span class='Ref_to_Proto'>pgpipe</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN964"><span class='Ref_To_Local'>pipeMW</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="parallel.c.html#LN125"><span class='Ref_to_Proto'>pgpipe</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN965"><span class='Ref_To_Local'>pipeWM</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="pg_backup_utils.c.html#LN100"><span class='Ref_to_Func'>exit_horribly</span></a><span class='Parentheses'>(</span><a href="pg_dump_sort.c.html#LN24"><span class='Ref_to_Global_Var'>modulename</span></a><span class='Delimiter'>, 
</span>                          <span class='String'>"could not create communication channels: %s\n"</span><span class='Delimiter'>, 
</span>                          <a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="parallel.c.html#LN910"><span class='Ref_To_Local'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN43"><span class='Ref_to_Member'>te</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN911"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* just for safety */ 
</span> 
        <a href="parallel.c.html#LN963"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN90"><span class='Ref_to_Member'>workerStatus</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN76"><span class='Ref_to_EnumConst'>WRKR_IDLE</span></a><span class='Delimiter'>; 
</span>        <a href="parallel.c.html#LN963"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN96"><span class='Ref_to_Member'>AH</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="parallel.c.html#LN963"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN93"><span class='Ref_to_Member'>callback</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="parallel.c.html#LN963"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN94"><span class='Ref_to_Member'>callback_data</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* master's ends of the pipes */ 
</span>        <a href="parallel.c.html#LN963"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN98"><span class='Ref_to_Member'>pipeRead</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN965"><span class='Ref_To_Local'>pipeWM</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN68"><span class='Ref_to_Const'>PIPE_READ</span></a><span class='Delimiter'>]; 
</span>        <a href="parallel.c.html#LN963"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN99"><span class='Ref_to_Member'>pipeWrite</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN964"><span class='Ref_To_Local'>pipeMW</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN69"><span class='Ref_to_Const'>PIPE_WRITE</span></a><span class='Delimiter'>]; 
</span>        <span class='Comment_Multi_Line'>/* child's ends of the pipes */ 
</span>        <a href="parallel.c.html#LN963"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN100"><span class='Ref_to_Member'>pipeRevRead</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN964"><span class='Ref_To_Local'>pipeMW</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN68"><span class='Ref_to_Const'>PIPE_READ</span></a><span class='Delimiter'>]; 
</span>        <a href="parallel.c.html#LN963"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN101"><span class='Ref_to_Member'>pipeRevWrite</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN965"><span class='Ref_To_Local'>pipeWM</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN69"><span class='Ref_to_Const'>PIPE_WRITE</span></a><span class='Delimiter'>]; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
        <span class='Comment_Multi_Line'>/* Create transient structure to pass args to worker function */ 
</span>        <a href="parallel.c.html#LN958"><span class='Ref_To_Local'>wi</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../backend/postmaster/autovacuum.c.html#LN232"><span class='Ref_to_Typedef'>WorkerInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN25"><span class='Ref_to_Proto'>pg_malloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../backend/postmaster/autovacuum.c.html#LN232"><span class='Ref_to_Typedef'>WorkerInfo</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="parallel.c.html#LN958"><span class='Ref_To_Local'>wi</span></a><span class='Operator'>-&GT;</span>AH <span class='Operator'>= </span><a href="parallel.c.html#LN908"><span class='Ref_to_Parameter'>AH</span></a><span class='Delimiter'>; 
</span>        <a href="parallel.c.html#LN958"><span class='Ref_To_Local'>wi</span></a><span class='Operator'>-&GT;</span>slot <span class='Operator'>= </span><a href="parallel.c.html#LN963"><span class='Ref_To_Local'>slot</span></a><span class='Delimiter'>; 
</span> 
        <a href="parallel.c.html#LN959"><span class='Ref_To_Local'>handle</span></a> <span class='Operator'>= </span>_beginthreadex<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="parallel.c.html#LN884"><span class='Ref_to_Func'>init_spawned_worker_win32</span></a><span class='Delimiter'>, 
</span>                                <a href="parallel.c.html#LN958"><span class='Ref_To_Local'>wi</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="parallel.c.html#LN963"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN106"><span class='Ref_to_Member'>threadId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="parallel.c.html#LN963"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN105"><span class='Ref_to_Member'>hThread</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN959"><span class='Ref_To_Local'>handle</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#else</span>                           <span class='Comment_Single_Line'>/* !WIN32 */ 
</span>        <a href="parallel.c.html#LN961"><span class='Ref_To_Local'>pid</span></a> <span class='Operator'>= </span>fork<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN961"><span class='Ref_To_Local'>pid</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* we are the worker */ 
</span><a name="LN1002"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>j</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* this is needed for GetMyPSlot() */ 
</span>            <a href="parallel.c.html#LN963"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN108"><span class='Ref_to_Member'>pid</span></a> <span class='Operator'>= </span>getpid<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* instruct signal handler that we're in a worker now */ 
</span>            <a href="parallel.c.html#LN168"><span class='Ref_to_Global_Var'>signal_info</span></a><span class='Operator'>.</span><a href="parallel.c.html#LN164"><span class='Ref_to_Member'>am_worker</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* close read end of Worker -&GT; Master */ 
</span>            <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN965"><span class='Ref_To_Local'>pipeWM</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN68"><span class='Ref_to_Const'>PIPE_READ</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* close write end of Master -&GT; Worker */ 
</span>            <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN964"><span class='Ref_To_Local'>pipeMW</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN69"><span class='Ref_to_Const'>PIPE_WRITE</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Close all inherited fds for communication of the master with 
             * previously-forked workers. 
             */ 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN1002"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="parallel.c.html#LN1002"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><a href="parallel.c.html#LN911"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; </span><a href="parallel.c.html#LN1002"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN910"><span class='Ref_To_Local'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN44"><span class='Ref_to_Member'>parallelSlot</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN1002"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="parallel.c.html#LN98"><span class='Ref_to_Member'>pipeRead</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN910"><span class='Ref_To_Local'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN44"><span class='Ref_to_Member'>parallelSlot</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN1002"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="parallel.c.html#LN99"><span class='Ref_to_Member'>pipeWrite</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* Run the worker ... */ 
</span>            <a href="parallel.c.html#LN207"><span class='Ref_to_Proto'>RunWorker</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN908"><span class='Ref_to_Parameter'>AH</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN963"><span class='Ref_To_Local'>slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* We can just exit(0) when done */ 
</span>            <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if pid==0 &raquo; </span> 
        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN961"><span class='Ref_To_Local'>pid</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* fork failed */ 
</span>            <a href="pg_backup_utils.c.html#LN100"><span class='Ref_to_Func'>exit_horribly</span></a><span class='Parentheses'>(</span><a href="pg_dump_sort.c.html#LN24"><span class='Ref_to_Global_Var'>modulename</span></a><span class='Delimiter'>, 
</span>                          <span class='String'>"could not create worker process: %s\n"</span><span class='Delimiter'>, 
</span>                          <a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* In Master after successful fork */ 
</span>        <a href="parallel.c.html#LN963"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN108"><span class='Ref_to_Member'>pid</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN961"><span class='Ref_To_Local'>pid</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* close read end of Master -&GT; Worker */ 
</span>        <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN964"><span class='Ref_To_Local'>pipeMW</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN68"><span class='Ref_to_Const'>PIPE_READ</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* close write end of Worker -&GT; Master */ 
</span>        <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN965"><span class='Ref_To_Local'>pipeWM</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN69"><span class='Ref_to_Const'>PIPE_WRITE</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* WIN32 */ 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;pstate-&GT;numWork... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Having forked off the workers, disable SIGPIPE so that master isn't 
     * killed if it tries to send a command to a dead worker.  We don't want 
     * the workers to inherit this setting, though. 
     */ 
</span><span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN192"><span class='Ref_to_Const'>SIGPIPE</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN184"><span class='Ref_to_Const'>SIG_IGN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Re-establish query cancellation on the master connection. 
     */ 
</span>    <a href="parallel.h.html#LN67"><span class='Ref_to_Proto'>set_archive_cancel_info</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN908"><span class='Ref_to_Parameter'>AH</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN908"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Tell the cancel signal handler to forward signals to worker processes, 
     * too.  (As with query cancel, we did not need this earlier because the 
     * workers have not yet been given anything to do; if we die before this 
     * point, any already-started workers will see EOF and quit promptly.) 
     */ 
</span>    <a href="parallel.c.html#LN205"><span class='Ref_to_Proto'>set_cancel_pstate</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN910"><span class='Ref_To_Local'>pstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="parallel.c.html#LN910"><span class='Ref_To_Local'>pstate</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ParallelBackupStart &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Close down a parallel dump or restore. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1078"></a><span class='Declare_Function'>ParallelBackupEnd</span><span class='Parentheses'>(</span><a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AH</span><span class='Delimiter'>, </span><a href="parallel.h.html#LN39"><span class='Ref_to_Struct'>ParallelState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1080"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* No work if non-parallel */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN1078"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN41"><span class='Ref_to_Member'>numWorkers</span></a> <span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* There should not be any unfinished jobs */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="parallel.h.html#LN54"><span class='Ref_to_Proto'>IsEveryWorkerIdle</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1078"><span class='Ref_to_Parameter'>pstate</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Close the sockets so that the workers know they can exit */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN1080"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="parallel.c.html#LN1080"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="parallel.c.html#LN1078"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN41"><span class='Ref_to_Member'>numWorkers</span></a><span class='Delimiter'>; </span><a href="parallel.c.html#LN1080"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1078"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN44"><span class='Ref_to_Member'>parallelSlot</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN1080"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="parallel.c.html#LN98"><span class='Ref_to_Member'>pipeRead</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1078"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN44"><span class='Ref_to_Member'>parallelSlot</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN1080"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="parallel.c.html#LN99"><span class='Ref_to_Member'>pipeWrite</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Wait for them to exit */ 
</span>    <a href="parallel.c.html#LN203"><span class='Ref_to_Proto'>WaitForTerminatingWorkers</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1078"><span class='Ref_to_Parameter'>pstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Unlink pstate from shutdown_info, so the exit handler will not try to 
     * use it; and likewise unlink from signal_info. 
     */ 
</span>    <a href="parallel.c.html#LN147"><span class='Ref_to_Global_Var'>shutdown_info</span></a><span class='Operator'>.</span><a href="parallel.c.html#LN143"><span class='Ref_to_Member'>pstate</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="parallel.c.html#LN205"><span class='Ref_to_Proto'>set_cancel_pstate</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Release state (mere neatnik-ism, since we're about to terminate) */ 
</span>    <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1078"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN43"><span class='Ref_to_Member'>te</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1078"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN44"><span class='Ref_to_Member'>parallelSlot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1078"><span class='Ref_to_Parameter'>pstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ParallelBackupEnd &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * These next four functions handle construction and parsing of the command 
 * strings and response strings for parallel workers. 
 * 
 * Currently, these can be the same regardless of which archive format we are 
 * processing.  In future, we might want to let format modules override these 
 * functions to add format-specific data to a command or response. 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * buildWorkerCommand: format a command string to send to a worker. 
 * 
 * The string is built in the caller-supplied buffer of size buflen. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1127"></a><span class='Declare_Function'>buildWorkerCommand</span><span class='Parentheses'>(</span><a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AH</span><span class='Delimiter'>, </span><a href="pg_backup_archiver.h.html#LN120"><span class='Ref_to_Typedef'>TocEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>te</span><span class='Delimiter'>, </span><a href="pg_backup_archiver.h.html#LN139"><span class='Ref_to_Enum'>T_Action</span></a> <span class='Declare_Parameter'>act</span><span class='Delimiter'>, 
</span><a name="LN1128"></a>                   <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>buflen</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN1127"><span class='Ref_to_Parameter'>act</span></a> <span class='Operator'>== </span><a href="pg_backup_archiver.h.html#LN141"><span class='Ref_to_EnumConst'>ACT_DUMP</span></a><span class='Parentheses'>) 
</span>        <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1128"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1128"><span class='Ref_to_Parameter'>buflen</span></a><span class='Delimiter'>, </span><span class='String'>"DUMP %d"</span><span class='Delimiter'>, </span><a href="parallel.c.html#LN1127"><span class='Ref_to_Parameter'>te</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN341"><span class='Ref_to_Member'>dumpId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN1127"><span class='Ref_to_Parameter'>act</span></a> <span class='Operator'>== </span><a href="pg_backup_archiver.h.html#LN142"><span class='Ref_to_EnumConst'>ACT_RESTORE</span></a><span class='Parentheses'>) 
</span>        <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1128"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1128"><span class='Ref_to_Parameter'>buflen</span></a><span class='Delimiter'>, </span><span class='String'>"RESTORE %d"</span><span class='Delimiter'>, </span><a href="parallel.c.html#LN1127"><span class='Ref_to_Parameter'>te</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN341"><span class='Ref_to_Member'>dumpId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * parseWorkerCommand: interpret a command string in a worker. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1142"></a><span class='Declare_Function'>parseWorkerCommand</span><span class='Parentheses'>(</span><a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AH</span><span class='Delimiter'>, </span><a href="pg_backup_archiver.h.html#LN120"><span class='Ref_to_Typedef'>TocEntry</span></a> <span class='Operator'>**</span><span class='Declare_Parameter'>te</span><span class='Delimiter'>, </span><a href="pg_backup_archiver.h.html#LN139"><span class='Ref_to_Enum'>T_Action</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>act</span><span class='Delimiter'>, 
</span><a name="LN1143"></a>                   <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1145"></a>    <a href="pg_backup.h.html#LN229"><span class='Ref_to_Typedef'>DumpId</span></a>      <span class='Declare_Local'>dumpId</span><span class='Delimiter'>; 
</span><a name="LN1146"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nBytes</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN223"><span class='Ref_to_Macro'>messageStartsWith</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1143"><span class='Ref_to_Parameter'>msg</span></a><span class='Delimiter'>, </span><span class='String'>"DUMP "</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Operator'>*</span><a href="parallel.c.html#LN1142"><span class='Ref_to_Parameter'>act</span></a> <span class='Operator'>= </span><a href="pg_backup_archiver.h.html#LN141"><span class='Ref_to_EnumConst'>ACT_DUMP</span></a><span class='Delimiter'>; 
</span>        sscanf<span class='Parentheses'>(</span><a href="parallel.c.html#LN1143"><span class='Ref_to_Parameter'>msg</span></a><span class='Delimiter'>, </span><span class='String'>"DUMP %d%n"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="parallel.c.html#LN1145"><span class='Ref_To_Local'>dumpId</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="parallel.c.html#LN1146"><span class='Ref_To_Local'>nBytes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="parallel.c.html#LN1146"><span class='Ref_To_Local'>nBytes</span></a> <span class='Operator'>== </span>strlen<span class='Parentheses'>(</span><a href="parallel.c.html#LN1143"><span class='Ref_to_Parameter'>msg</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="parallel.c.html#LN1142"><span class='Ref_to_Parameter'>te</span></a> <span class='Operator'>= </span><a href="pg_backup_archiver.h.html#LN393"><span class='Ref_to_Proto'>getTocEntryByDumpId</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1142"><span class='Ref_to_Parameter'>AH</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1145"><span class='Ref_To_Local'>dumpId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="parallel.c.html#LN1142"><span class='Ref_to_Parameter'>te</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN223"><span class='Ref_to_Macro'>messageStartsWith</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1143"><span class='Ref_to_Parameter'>msg</span></a><span class='Delimiter'>, </span><span class='String'>"RESTORE "</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Operator'>*</span><a href="parallel.c.html#LN1142"><span class='Ref_to_Parameter'>act</span></a> <span class='Operator'>= </span><a href="pg_backup_archiver.h.html#LN142"><span class='Ref_to_EnumConst'>ACT_RESTORE</span></a><span class='Delimiter'>; 
</span>        sscanf<span class='Parentheses'>(</span><a href="parallel.c.html#LN1143"><span class='Ref_to_Parameter'>msg</span></a><span class='Delimiter'>, </span><span class='String'>"RESTORE %d%n"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="parallel.c.html#LN1145"><span class='Ref_To_Local'>dumpId</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="parallel.c.html#LN1146"><span class='Ref_To_Local'>nBytes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="parallel.c.html#LN1146"><span class='Ref_To_Local'>nBytes</span></a> <span class='Operator'>== </span>strlen<span class='Parentheses'>(</span><a href="parallel.c.html#LN1143"><span class='Ref_to_Parameter'>msg</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="parallel.c.html#LN1142"><span class='Ref_to_Parameter'>te</span></a> <span class='Operator'>= </span><a href="pg_backup_archiver.h.html#LN393"><span class='Ref_to_Proto'>getTocEntryByDumpId</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1142"><span class='Ref_to_Parameter'>AH</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1145"><span class='Ref_To_Local'>dumpId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="parallel.c.html#LN1142"><span class='Ref_to_Parameter'>te</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="pg_backup_utils.c.html#LN100"><span class='Ref_to_Func'>exit_horribly</span></a><span class='Parentheses'>(</span><a href="pg_dump_sort.c.html#LN24"><span class='Ref_to_Global_Var'>modulename</span></a><span class='Delimiter'>, 
</span>                      <span class='String'>"unrecognized command received from master: \"%s\"\n"</span><span class='Delimiter'>, 
</span>                      <a href="parallel.c.html#LN1143"><span class='Ref_to_Parameter'>msg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end parseWorkerCommand &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * buildWorkerResponse: format a response string to send to the master. 
 * 
 * The string is built in the caller-supplied buffer of size buflen. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1176"></a><span class='Declare_Function'>buildWorkerResponse</span><span class='Parentheses'>(</span><a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AH</span><span class='Delimiter'>, </span><a href="pg_backup_archiver.h.html#LN120"><span class='Ref_to_Typedef'>TocEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>te</span><span class='Delimiter'>, </span><a href="pg_backup_archiver.h.html#LN139"><span class='Ref_to_Enum'>T_Action</span></a> <span class='Declare_Parameter'>act</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>status</span><span class='Delimiter'>, 
</span><a name="LN1177"></a>                    <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>buflen</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1177"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1177"><span class='Ref_to_Parameter'>buflen</span></a><span class='Delimiter'>, </span><span class='String'>"OK %d %d %d"</span><span class='Delimiter'>, 
</span>             <a href="parallel.c.html#LN1176"><span class='Ref_to_Parameter'>te</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN341"><span class='Ref_to_Member'>dumpId</span></a><span class='Delimiter'>, 
</span>             <a href="parallel.c.html#LN1176"><span class='Ref_to_Parameter'>status</span></a><span class='Delimiter'>, 
</span>             <a href="parallel.c.html#LN1176"><span class='Ref_to_Parameter'>status</span></a> <span class='Operator'>== </span><a href="pg_backup_archiver.h.html#LN117"><span class='Ref_to_Const'>WORKER_IGNORED_ERRORS</span></a> <span class='Operator'>? </span><a href="parallel.c.html#LN1176"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><span class='Keyword'>public</span><span class='Operator'>.</span><a href="pg_backup.h.html#LN201"><span class='Ref_to_Member'>n_errors</span></a> <span class='Operator'>: </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * parseWorkerResponse: parse the status message returned by a worker. 
 * 
 * Returns the integer status code, and may update fields of AH and/or te. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN1191"></a><span class='Declare_Function'>parseWorkerResponse</span><span class='Parentheses'>(</span><a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AH</span><span class='Delimiter'>, </span><a href="pg_backup_archiver.h.html#LN120"><span class='Ref_to_Typedef'>TocEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>te</span><span class='Delimiter'>, 
</span><a name="LN1192"></a>                    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1194"></a>    <a href="pg_backup.h.html#LN229"><span class='Ref_to_Typedef'>DumpId</span></a>      <span class='Declare_Local'>dumpId</span><span class='Delimiter'>; 
</span><a name="LN1195"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nBytes</span><span class='Delimiter'>, 
</span><a name="LN1196"></a>                <span class='Declare_Local'>n_errors</span><span class='Delimiter'>; 
</span><a name="LN1197"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>status</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN223"><span class='Ref_to_Macro'>messageStartsWith</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1192"><span class='Ref_to_Parameter'>msg</span></a><span class='Delimiter'>, </span><span class='String'>"OK "</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        sscanf<span class='Parentheses'>(</span><a href="parallel.c.html#LN1192"><span class='Ref_to_Parameter'>msg</span></a><span class='Delimiter'>, </span><span class='String'>"OK %d %d %d%n"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="parallel.c.html#LN1194"><span class='Ref_To_Local'>dumpId</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="parallel.c.html#LN1197"><span class='Ref_To_Local'>status</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="parallel.c.html#LN1196"><span class='Ref_To_Local'>n_errors</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="parallel.c.html#LN1195"><span class='Ref_To_Local'>nBytes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="parallel.c.html#LN1194"><span class='Ref_To_Local'>dumpId</span></a> <span class='Operator'>== </span><a href="parallel.c.html#LN1191"><span class='Ref_to_Parameter'>te</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN341"><span class='Ref_to_Member'>dumpId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="parallel.c.html#LN1195"><span class='Ref_To_Local'>nBytes</span></a> <span class='Operator'>== </span>strlen<span class='Parentheses'>(</span><a href="parallel.c.html#LN1192"><span class='Ref_to_Parameter'>msg</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="parallel.c.html#LN1191"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><span class='Keyword'>public</span><span class='Operator'>.</span><a href="pg_backup.h.html#LN201"><span class='Ref_to_Member'>n_errors</span></a> <span class='Operator'>+= </span><a href="parallel.c.html#LN1196"><span class='Ref_To_Local'>n_errors</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="pg_backup_utils.c.html#LN100"><span class='Ref_to_Func'>exit_horribly</span></a><span class='Parentheses'>(</span><a href="pg_dump_sort.c.html#LN24"><span class='Ref_to_Global_Var'>modulename</span></a><span class='Delimiter'>, 
</span>                      <span class='String'>"invalid message received from worker: \"%s\"\n"</span><span class='Delimiter'>, 
</span>                      <a href="parallel.c.html#LN1192"><span class='Ref_to_Parameter'>msg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="parallel.c.html#LN1197"><span class='Ref_To_Local'>status</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end parseWorkerResponse &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Dispatch a job to some free worker. 
 * 
 * te is the TocEntry to be processed, act is the action to be taken on it. 
 * callback is the function to call on completion of the job. 
 * 
 * If no worker is currently available, this will block, and previously 
 * registered callback functions may be called. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1226"></a><span class='Declare_Function'>DispatchJobForTocEntry</span><span class='Parentheses'>(</span><a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AH</span><span class='Delimiter'>, 
</span><a name="LN1227"></a>                       <a href="parallel.h.html#LN39"><span class='Ref_to_Struct'>ParallelState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Delimiter'>, 
</span><a name="LN1228"></a>                       <a href="pg_backup_archiver.h.html#LN120"><span class='Ref_to_Typedef'>TocEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>te</span><span class='Delimiter'>, 
</span><a name="LN1229"></a>                       <a href="pg_backup_archiver.h.html#LN139"><span class='Ref_to_Enum'>T_Action</span></a> <span class='Declare_Parameter'>act</span><span class='Delimiter'>, 
</span><a name="LN1230"></a>                       <a href="parallel.h.html#LN21"><span class='Ref_to_Typedef'>ParallelCompletionPtr</span></a> <span class='Declare_Parameter'>callback</span><span class='Delimiter'>, 
</span><a name="LN1231"></a>                       <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>callback_data</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1233"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>worker</span><span class='Delimiter'>; 
</span><a name="LN1234"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>buf</span><span class='Delimiter'>[</span><span class='Number'>256</span><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* Get a worker, waiting if none are idle */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="parallel.c.html#LN1233"><span class='Ref_To_Local'>worker</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN208"><span class='Ref_to_Proto'>GetIdleWorker</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1227"><span class='Ref_to_Parameter'>pstate</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><a href="parallel.c.html#LN71"><span class='Ref_to_Const'>NO_SLOT</span></a><span class='Parentheses'>)</span> 
        <a href="parallel.h.html#LN55"><span class='Ref_to_Proto'>WaitForWorkers</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1226"><span class='Ref_to_Parameter'>AH</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1227"><span class='Ref_to_Parameter'>pstate</span></a><span class='Delimiter'>, </span><a href="parallel.h.html#LN31"><span class='Ref_to_EnumConst'>WFW_ONE_IDLE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Construct and send command string */ 
</span>    <a href="parallel.c.html#LN1126"><span class='Ref_to_Func'>buildWorkerCommand</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1226"><span class='Ref_to_Parameter'>AH</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1228"><span class='Ref_to_Parameter'>te</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1229"><span class='Ref_to_Parameter'>act</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1234"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="parallel.c.html#LN1234"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="parallel.c.html#LN219"><span class='Ref_to_Proto'>sendMessageToWorker</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1227"><span class='Ref_to_Parameter'>pstate</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1233"><span class='Ref_To_Local'>worker</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1234"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Remember worker is busy, and which TocEntry it's working on */ 
</span>    <a href="parallel.c.html#LN1227"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN44"><span class='Ref_to_Member'>parallelSlot</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN1233"><span class='Ref_To_Local'>worker</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="parallel.c.html#LN90"><span class='Ref_to_Member'>workerStatus</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN77"><span class='Ref_to_EnumConst'>WRKR_WORKING</span></a><span class='Delimiter'>; 
</span>    <a href="parallel.c.html#LN1227"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN44"><span class='Ref_to_Member'>parallelSlot</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN1233"><span class='Ref_To_Local'>worker</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="parallel.c.html#LN93"><span class='Ref_to_Member'>callback</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN1230"><span class='Ref_to_Parameter'>callback</span></a><span class='Delimiter'>; 
</span>    <a href="parallel.c.html#LN1227"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN44"><span class='Ref_to_Member'>parallelSlot</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN1233"><span class='Ref_To_Local'>worker</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="parallel.c.html#LN94"><span class='Ref_to_Member'>callback_data</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN1231"><span class='Ref_to_Parameter'>callback_data</span></a><span class='Delimiter'>; 
</span>    <a href="parallel.c.html#LN1227"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN43"><span class='Ref_to_Member'>te</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN1233"><span class='Ref_To_Local'>worker</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="parallel.c.html#LN1228"><span class='Ref_to_Parameter'>te</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end DispatchJobForTocEntry &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Find an idle worker and return its slot number. 
 * Return NO_SLOT if none are idle. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN1257"></a><span class='Declare_Function'>GetIdleWorker</span><span class='Parentheses'>(</span><a href="parallel.h.html#LN39"><span class='Ref_to_Struct'>ParallelState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1259"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN1259"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="parallel.c.html#LN1259"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="parallel.c.html#LN1257"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN41"><span class='Ref_to_Member'>numWorkers</span></a><span class='Delimiter'>; </span><a href="parallel.c.html#LN1259"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN1257"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN44"><span class='Ref_to_Member'>parallelSlot</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN1259"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="parallel.c.html#LN90"><span class='Ref_to_Member'>workerStatus</span></a> <span class='Operator'>== </span><a href="parallel.c.html#LN76"><span class='Ref_to_EnumConst'>WRKR_IDLE</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <a href="parallel.c.html#LN1259"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <a href="parallel.c.html#LN71"><span class='Ref_to_Const'>NO_SLOT</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Return true iff every worker is in the WRKR_TERMINATED state. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1273"></a><span class='Declare_Function'>HasEveryWorkerTerminated</span><span class='Parentheses'>(</span><a href="parallel.h.html#LN39"><span class='Ref_to_Struct'>ParallelState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1275"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN1275"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="parallel.c.html#LN1275"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="parallel.c.html#LN1273"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN41"><span class='Ref_to_Member'>numWorkers</span></a><span class='Delimiter'>; </span><a href="parallel.c.html#LN1275"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN1273"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN44"><span class='Ref_to_Member'>parallelSlot</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN1275"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="parallel.c.html#LN90"><span class='Ref_to_Member'>workerStatus</span></a> <span class='Operator'>!= </span><a href="parallel.c.html#LN78"><span class='Ref_to_EnumConst'>WRKR_TERMINATED</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Return true iff every worker is in the WRKR_IDLE state. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN1289"></a><span class='Declare_Function'>IsEveryWorkerIdle</span><span class='Parentheses'>(</span><a href="parallel.h.html#LN39"><span class='Ref_to_Struct'>ParallelState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1291"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN1291"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="parallel.c.html#LN1291"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="parallel.c.html#LN1289"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN41"><span class='Ref_to_Member'>numWorkers</span></a><span class='Delimiter'>; </span><a href="parallel.c.html#LN1291"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN1289"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN44"><span class='Ref_to_Member'>parallelSlot</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN1291"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="parallel.c.html#LN90"><span class='Ref_to_Member'>workerStatus</span></a> <span class='Operator'>!= </span><a href="parallel.c.html#LN76"><span class='Ref_to_EnumConst'>WRKR_IDLE</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Acquire lock on a table to be dumped by a worker process. 
 * 
 * The master process is already holding an ACCESS SHARE lock.  Ordinarily 
 * it's no problem for a worker to get one too, but if anything else besides 
 * pg_dump is running, there's a possible deadlock: 
 * 
 * 1) Master dumps the schema and locks all tables in ACCESS SHARE mode. 
 * 2) Another process requests an ACCESS EXCLUSIVE lock (which is not granted 
 *    because the master holds a conflicting ACCESS SHARE lock). 
 * 3) A worker process also requests an ACCESS SHARE lock to read the table. 
 *    The worker is enqueued behind the ACCESS EXCLUSIVE lock request. 
 * 4) Now we have a deadlock, since the master is effectively waiting for 
 *    the worker.  The server cannot detect that, however. 
 * 
 * To prevent an infinite wait, prior to touching a table in a worker, request 
 * a lock in ACCESS SHARE mode but with NOWAIT.  If we don't get the lock, 
 * then we know that somebody else has requested an ACCESS EXCLUSIVE lock and 
 * so we have a deadlock.  We must fail the backup in that case. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1322"></a><span class='Declare_Function'>lockTableForWorker</span><span class='Parentheses'>(</span><a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AH</span><span class='Delimiter'>, </span><a href="pg_backup_archiver.h.html#LN120"><span class='Ref_to_Typedef'>TocEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>te</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1324"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>qualId</span><span class='Delimiter'>; 
</span><a name="LN1325"></a>    <a href="../../interfaces/libpq/pqexpbuffer.h.html#LN50"><span class='Ref_to_Typedef'>PQExpBuffer</span></a> <span class='Declare_Local'>query</span><span class='Delimiter'>; 
</span><a name="LN1326"></a>    <a href="../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Nothing to do for BLOBS */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="parallel.c.html#LN1322"><span class='Ref_to_Parameter'>te</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN351"><span class='Ref_to_Member'>desc</span></a><span class='Delimiter'>, </span><span class='String'>"BLOBS"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="parallel.c.html#LN1325"><span class='Ref_To_Local'>query</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/pqexpbuffer.c.html#LN69"><span class='Ref_to_Func'>createPQExpBuffer</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="parallel.c.html#LN1324"><span class='Ref_To_Local'>qualId</span></a> <span class='Operator'>= </span><a href="../../include/fe_utils/string_utils.h.html#LN27"><span class='Ref_to_Proto'>fmtQualifiedId</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1322"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><span class='Keyword'>public</span><span class='Operator'>.</span><a href="pg_backup.h.html#LN184"><span class='Ref_to_Member'>remoteVersion</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1322"><span class='Ref_to_Parameter'>te</span></a><span class='Operator'>-&GT;</span><span class='Control'>namespace</span><span class='Delimiter'>, </span><a href="parallel.c.html#LN1322"><span class='Ref_to_Parameter'>te</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN345"><span class='Ref_to_Member'>tag</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../interfaces/libpq/pqexpbuffer.c.html#LN260"><span class='Ref_to_Func'>appendPQExpBuffer</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1325"><span class='Ref_To_Local'>query</span></a><span class='Delimiter'>, </span><span class='String'>"LOCK TABLE %s IN ACCESS SHARE MODE NOWAIT"</span><span class='Delimiter'>, 
</span>                      <a href="parallel.c.html#LN1324"><span class='Ref_To_Local'>qualId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="parallel.c.html#LN1326"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN380"><span class='Ref_to_Proto'>PQexec</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1322"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1325"><span class='Ref_To_Local'>query</span></a><span class='Operator'>-&GT;</span><a href="../../interfaces/libpq/pqexpbuffer.h.html#LN45"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="parallel.c.html#LN1326"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>|| </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1326"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN84"><span class='Ref_to_EnumConst'>PGRES_COMMAND_OK</span></a><span class='Parentheses'>)</span> 
        <a href="pg_backup_utils.c.html#LN100"><span class='Ref_to_Func'>exit_horribly</span></a><span class='Parentheses'>(</span><a href="pg_dump_sort.c.html#LN24"><span class='Ref_to_Global_Var'>modulename</span></a><span class='Delimiter'>, 
</span>                      <span class='String'>"could not obtain lock on relation \"%s\"\n"</span> 
        <span class='String'>"This usually means that someone requested an ACCESS EXCLUSIVE lock "</span> 
              <span class='String'>"on the table after the pg_dump parent process had gotten the "</span> 
                      <span class='String'>"initial ACCESS SHARE lock on the table.\n"</span><span class='Delimiter'>, </span><a href="parallel.c.html#LN1324"><span class='Ref_To_Local'>qualId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1326"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../interfaces/libpq/pqexpbuffer.c.html#LN111"><span class='Ref_to_Func'>destroyPQExpBuffer</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1325"><span class='Ref_To_Local'>query</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end lockTableForWorker &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * WaitForCommands: main routine for a worker process. 
 * 
 * Read and execute commands from the master until we see EOF on the pipe. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1358"></a><span class='Declare_Function'>WaitForCommands</span><span class='Parentheses'>(</span><a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AH</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>pipefd</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1360"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>command</span><span class='Delimiter'>; 
</span><a name="LN1361"></a>    <a href="pg_backup_archiver.h.html#LN120"><span class='Ref_to_Typedef'>TocEntry</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>te</span><span class='Delimiter'>; 
</span><a name="LN1362"></a>    <a href="pg_backup_archiver.h.html#LN139"><span class='Ref_to_Enum'>T_Action</span></a>    <span class='Declare_Local'>act</span><span class='Delimiter'>; 
</span><a name="LN1363"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>status</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1364"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>buf</span><span class='Delimiter'>[</span><span class='Number'>256</span><span class='Delimiter'>]; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="parallel.c.html#LN1360"><span class='Ref_To_Local'>command</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN214"><span class='Ref_to_Proto'>getMessageFromMaster</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1358"><span class='Ref_to_Parameter'>pipefd</span></a><span class='Parentheses'>)))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* EOF, so done */ 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Decode the command */ 
</span>        <a href="parallel.c.html#LN1141"><span class='Ref_to_Func'>parseWorkerCommand</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1358"><span class='Ref_to_Parameter'>AH</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="parallel.c.html#LN1361"><span class='Ref_To_Local'>te</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="parallel.c.html#LN1362"><span class='Ref_To_Local'>act</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1360"><span class='Ref_To_Local'>command</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN1362"><span class='Ref_To_Local'>act</span></a> <span class='Operator'>== </span><a href="pg_backup_archiver.h.html#LN141"><span class='Ref_to_EnumConst'>ACT_DUMP</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Acquire lock on this table within the worker's session */ 
</span>            <a href="parallel.c.html#LN210"><span class='Ref_to_Proto'>lockTableForWorker</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1358"><span class='Ref_to_Parameter'>AH</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1361"><span class='Ref_To_Local'>te</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Perform the dump command */ 
</span>            <a href="parallel.c.html#LN1363"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="parallel.c.html#LN1358"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN271"><span class='Ref_to_Member'>WorkerJobDumpPtr</span></a><span class='Parentheses'>) (</span><a href="parallel.c.html#LN1358"><span class='Ref_to_Parameter'>AH</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1361"><span class='Ref_To_Local'>te</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN1362"><span class='Ref_To_Local'>act</span></a> <span class='Operator'>== </span><a href="pg_backup_archiver.h.html#LN142"><span class='Ref_to_EnumConst'>ACT_RESTORE</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Perform the restore command */ 
</span>            <a href="parallel.c.html#LN1363"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="parallel.c.html#LN1358"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN272"><span class='Ref_to_Member'>WorkerJobRestorePtr</span></a><span class='Parentheses'>) (</span><a href="parallel.c.html#LN1358"><span class='Ref_to_Parameter'>AH</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1361"><span class='Ref_To_Local'>te</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Return status to master */ 
</span>        <a href="parallel.c.html#LN1175"><span class='Ref_to_Func'>buildWorkerResponse</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1358"><span class='Ref_to_Parameter'>AH</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1361"><span class='Ref_To_Local'>te</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1362"><span class='Ref_To_Local'>act</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1363"><span class='Ref_To_Local'>status</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1364"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="parallel.c.html#LN1364"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="parallel.c.html#LN215"><span class='Ref_to_Proto'>sendMessageToMaster</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1358"><span class='Ref_to_Parameter'>pipefd</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1364"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* command was pg_malloc'd and we are responsible for free()ing it. */ 
</span>        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1360"><span class='Ref_To_Local'>command</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end WaitForCommands &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Check for status messages from workers. 
 * 
 * If do_wait is true, wait to get a status message; otherwise, just return 
 * immediately if there is none available. 
 * 
 * When we get a status message, we pass the status code to the callback 
 * function that was specified to DispatchJobForTocEntry, then reset the 
 * worker status to IDLE. 
 * 
 * Returns true if we collected a status message, else false. 
 * 
 * XXX is it worth checking for more than one status message per call? 
 * It seems somewhat unlikely that multiple workers would finish at exactly 
 * the same time. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1420"></a><span class='Declare_Function'>ListenToWorkers</span><span class='Parentheses'>(</span><a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AH</span><span class='Delimiter'>, </span><a href="parallel.h.html#LN39"><span class='Ref_to_Struct'>ParallelState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>do_wait</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1422"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>worker</span><span class='Delimiter'>; 
</span><a name="LN1423"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>msg</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Try to collect a status message */ 
</span>    <a href="parallel.c.html#LN1423"><span class='Ref_To_Local'>msg</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN217"><span class='Ref_to_Proto'>getMessageFromWorker</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1420"><span class='Ref_to_Parameter'>pstate</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1420"><span class='Ref_to_Parameter'>do_wait</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="parallel.c.html#LN1422"><span class='Ref_To_Local'>worker</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="parallel.c.html#LN1423"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* If do_wait is true, we must have detected EOF on some socket */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN1420"><span class='Ref_to_Parameter'>do_wait</span></a><span class='Parentheses'>) 
</span>            <a href="pg_backup_utils.c.html#LN100"><span class='Ref_to_Func'>exit_horribly</span></a><span class='Parentheses'>(</span><a href="pg_dump_sort.c.html#LN24"><span class='Ref_to_Global_Var'>modulename</span></a><span class='Delimiter'>, </span><span class='String'>"a worker process died unexpectedly\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Process it and update our idea of the worker's status */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN223"><span class='Ref_to_Macro'>messageStartsWith</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1423"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><span class='String'>"OK "</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1439"></a>        <a href="../scripts/vacuumdb.c.html#LN28"><span class='Ref_to_Struct'>ParallelSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>slot</span> <span class='Operator'>= &</span><a href="parallel.c.html#LN1420"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN44"><span class='Ref_to_Member'>parallelSlot</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN1422"><span class='Ref_To_Local'>worker</span></a><span class='Delimiter'>]; 
</span><a name="LN1440"></a>        <a href="pg_backup_archiver.h.html#LN120"><span class='Ref_to_Typedef'>TocEntry</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>te</span> <span class='Operator'>= </span><a href="parallel.c.html#LN1420"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN43"><span class='Ref_to_Member'>te</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN1422"><span class='Ref_To_Local'>worker</span></a><span class='Delimiter'>]; 
</span><a name="LN1441"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>status</span><span class='Delimiter'>; 
</span> 
        <a href="parallel.c.html#LN1441"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN1190"><span class='Ref_to_Func'>parseWorkerResponse</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1420"><span class='Ref_to_Parameter'>AH</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1440"><span class='Ref_To_Local'>te</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1423"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="parallel.c.html#LN1439"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN93"><span class='Ref_to_Member'>callback</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1420"><span class='Ref_to_Parameter'>AH</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1440"><span class='Ref_To_Local'>te</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1441"><span class='Ref_To_Local'>status</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1439"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN94"><span class='Ref_to_Member'>callback_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="parallel.c.html#LN1439"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN90"><span class='Ref_to_Member'>workerStatus</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN76"><span class='Ref_to_EnumConst'>WRKR_IDLE</span></a><span class='Delimiter'>; 
</span>        <a href="parallel.c.html#LN1420"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN43"><span class='Ref_to_Member'>te</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN1422"><span class='Ref_To_Local'>worker</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="pg_backup_utils.c.html#LN100"><span class='Ref_to_Func'>exit_horribly</span></a><span class='Parentheses'>(</span><a href="pg_dump_sort.c.html#LN24"><span class='Ref_to_Global_Var'>modulename</span></a><span class='Delimiter'>, 
</span>                      <span class='String'>"invalid message received from worker: \"%s\"\n"</span><span class='Delimiter'>, 
</span>                      <a href="parallel.c.html#LN1423"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Free the string returned from getMessageFromWorker */ 
</span>    <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1423"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ListenToWorkers &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Check for status results from workers, waiting if necessary. 
 * 
 * Available wait modes are: 
 * WFW_NO_WAIT: reap any available status, but don't block 
 * WFW_GOT_STATUS: wait for at least one more worker to finish 
 * WFW_ONE_IDLE: wait for at least one worker to be idle 
 * WFW_ALL_IDLE: wait for all workers to be idle 
 * 
 * Any received results are passed to the callback specified to 
 * DispatchJobForTocEntry. 
 * 
 * This function is executed in the master process. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1474"></a><span class='Declare_Function'>WaitForWorkers</span><span class='Parentheses'>(</span><a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AH</span><span class='Delimiter'>, </span><a href="parallel.h.html#LN39"><span class='Ref_to_Struct'>ParallelState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Delimiter'>, </span><a href="parallel.h.html#LN27"><span class='Ref_to_Typedef'>WFW_WaitOption</span></a> <span class='Declare_Parameter'>mode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1476"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>do_wait</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * In GOT_STATUS mode, always block waiting for a message, since we can't 
     * return till we get something.  In other modes, we don't block the first 
     * time through the loop. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN1474"><span class='Ref_to_Parameter'>mode</span></a> <span class='Operator'>== </span><a href="parallel.h.html#LN30"><span class='Ref_to_EnumConst'>WFW_GOT_STATUS</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Assert that caller knows what it's doing */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="parallel.h.html#LN54"><span class='Ref_to_Proto'>IsEveryWorkerIdle</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1474"><span class='Ref_to_Parameter'>pstate</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="parallel.c.html#LN1476"><span class='Ref_To_Local'>do_wait</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Check for status messages, even if we don't need to block.  We do 
         * not try very hard to reap all available messages, though, since 
         * there's unlikely to be more than one. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN212"><span class='Ref_to_Proto'>ListenToWorkers</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1474"><span class='Ref_to_Parameter'>AH</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1474"><span class='Ref_to_Parameter'>pstate</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1476"><span class='Ref_To_Local'>do_wait</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * If we got a message, we are done by definition for GOT_STATUS 
             * mode, and we can also be certain that there's at least one idle 
             * worker.  So we're done in all but ALL_IDLE mode. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN1474"><span class='Ref_to_Parameter'>mode</span></a> <span class='Operator'>!= </span><a href="parallel.h.html#LN32"><span class='Ref_to_EnumConst'>WFW_ALL_IDLE</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Check whether we must wait for new status messages */ 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN1474"><span class='Ref_to_Parameter'>mode</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <a href="parallel.h.html#LN29"><span class='Ref_to_EnumConst'>WFW_NO_WAIT</span></a><span class='Operator'>: 
</span>                <span class='Control'>return</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* never wait */ 
</span>            <span class='Control'>case</span> <a href="parallel.h.html#LN30"><span class='Ref_to_EnumConst'>WFW_GOT_STATUS</span></a><span class='Operator'>: 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* can't get here, because we waited */ 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="parallel.h.html#LN31"><span class='Ref_to_EnumConst'>WFW_ONE_IDLE</span></a><span class='Operator'>: 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN208"><span class='Ref_to_Proto'>GetIdleWorker</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1474"><span class='Ref_to_Parameter'>pstate</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="parallel.c.html#LN71"><span class='Ref_to_Const'>NO_SLOT</span></a><span class='Parentheses'>)</span> 
                    <span class='Control'>return</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="parallel.h.html#LN32"><span class='Ref_to_EnumConst'>WFW_ALL_IDLE</span></a><span class='Operator'>: 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.h.html#LN54"><span class='Ref_to_Proto'>IsEveryWorkerIdle</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1474"><span class='Ref_to_Parameter'>pstate</span></a><span class='Parentheses'>))</span> 
                    <span class='Control'>return</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Loop back, and this time wait for something to happen */ 
</span>        <a href="parallel.c.html#LN1476"><span class='Ref_To_Local'>do_wait</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end WaitForWorkers &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Read one command message from the master, blocking if necessary 
 * until one is available, and return it as a malloc'd string. 
 * On EOF, return NULL. 
 * 
 * This function is executed in worker processes. 
 */ 
</span><span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN1539"></a><span class='Declare_Function'>getMessageFromMaster</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>pipefd</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="parallel.c.html#LN221"><span class='Ref_to_Proto'>readMessageFromPipe</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1539"><span class='Ref_to_Parameter'>pipefd</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN68"><span class='Ref_to_Const'>PIPE_READ</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Send a status message to the master. 
 * 
 * This function is executed in worker processes. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1550"></a><span class='Declare_Function'>sendMessageToMaster</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>pipefd</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>], </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>str</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1552"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>len</span> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="parallel.c.html#LN1550"><span class='Ref_to_Parameter'>str</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN127"><span class='Ref_to_Macro'>pipewrite</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1550"><span class='Ref_to_Parameter'>pipefd</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN69"><span class='Ref_to_Const'>PIPE_WRITE</span></a><span class='Delimiter'>], </span><a href="parallel.c.html#LN1550"><span class='Ref_to_Parameter'>str</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1552"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="parallel.c.html#LN1552"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span> 
        <a href="pg_backup_utils.c.html#LN100"><span class='Ref_to_Func'>exit_horribly</span></a><span class='Parentheses'>(</span><a href="pg_dump_sort.c.html#LN24"><span class='Ref_to_Global_Var'>modulename</span></a><span class='Delimiter'>, 
</span>                      <span class='String'>"could not write to the communication channel: %s\n"</span><span class='Delimiter'>, 
</span>                      <a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Wait until some descriptor in "workerset" becomes readable. 
 * Returns -1 on error, else the number of readable descriptors. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN1565"></a><span class='Declare_Function'>select_loop</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>maxFd</span><span class='Delimiter'>, </span>fd_set <span class='Operator'>*</span><span class='Declare_Parameter'>workerset</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1567"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1568"></a>    fd_set      <span class='Declare_Local'>saveSet</span> <span class='Operator'>= *</span><a href="parallel.c.html#LN1565"><span class='Ref_to_Parameter'>workerset</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Operator'>*</span><a href="parallel.c.html#LN1565"><span class='Ref_to_Parameter'>workerset</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN1568"><span class='Ref_To_Local'>saveSet</span></a><span class='Delimiter'>; 
</span>        <a href="parallel.c.html#LN1567"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="../../include/port/win32.h.html#LN373"><span class='Ref_to_Macro'>select</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1565"><span class='Ref_to_Parameter'>maxFd</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="parallel.c.html#LN1565"><span class='Ref_to_Parameter'>workerset</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN1567"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>&& </span>errno <span class='Operator'>== </span><a href="../../interfaces/libpq/win32.h.html#LN17"><span class='Ref_to_Const'>EINTR</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN1567"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>== </span>SOCKET_ERROR <span class='Operator'>&& </span>WSAGetLastError<span class='Parentheses'>() </span><span class='Operator'>== </span>WSAEINTR<span class='Parentheses'>)</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
        <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="parallel.c.html#LN1567"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end select_loop &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Check for messages from worker processes. 
 * 
 * If a message is available, return it as a malloc'd string, and put the 
 * index of the sending worker in *worker. 
 * 
 * If nothing is available, wait if "do_wait" is true, else return NULL. 
 * 
 * If we detect EOF on any socket, we'll return NULL.  It's not great that 
 * that's hard to distinguish from the no-data-available case, but for now 
 * our one caller is okay with that. 
 * 
 * This function is executed in the master process. 
 */ 
</span><span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN1604"></a><span class='Declare_Function'>getMessageFromWorker</span><span class='Parentheses'>(</span><a href="parallel.h.html#LN39"><span class='Ref_to_Struct'>ParallelState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>do_wait</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>worker</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1606"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1607"></a>    fd_set      <span class='Declare_Local'>workerset</span><span class='Delimiter'>; 
</span><a name="LN1608"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>maxFd</span> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span><a name="LN1609"></a>    <span class='Control'>struct</span> timeval <span class='Declare_Local'>nowait</span> <span class='Operator'>= </span><span class='Delimiter'>{</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>}; 
</span> 
    <span class='Comment_Multi_Line'>/* construct bitmap of socket descriptors for select() */ 
</span>    FD_ZERO<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN1607"><span class='Ref_To_Local'>workerset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN1606"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="parallel.c.html#LN1606"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="parallel.c.html#LN1604"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN41"><span class='Ref_to_Member'>numWorkers</span></a><span class='Delimiter'>; </span><a href="parallel.c.html#LN1606"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN1604"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN44"><span class='Ref_to_Member'>parallelSlot</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN1606"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="parallel.c.html#LN90"><span class='Ref_to_Member'>workerStatus</span></a> <span class='Operator'>== </span><a href="parallel.c.html#LN78"><span class='Ref_to_EnumConst'>WRKR_TERMINATED</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        FD_SET<span class='Parentheses'>(</span><a href="parallel.c.html#LN1604"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN44"><span class='Ref_to_Member'>parallelSlot</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN1606"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="parallel.c.html#LN98"><span class='Ref_to_Member'>pipeRead</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="parallel.c.html#LN1607"><span class='Ref_To_Local'>workerset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN1604"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN44"><span class='Ref_to_Member'>parallelSlot</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN1606"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="parallel.c.html#LN98"><span class='Ref_to_Member'>pipeRead</span></a> <span class='Operator'>&GT; </span><a href="parallel.c.html#LN1608"><span class='Ref_To_Local'>maxFd</span></a><span class='Parentheses'>) 
</span>            <a href="parallel.c.html#LN1608"><span class='Ref_To_Local'>maxFd</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN1604"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN44"><span class='Ref_to_Member'>parallelSlot</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN1606"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="parallel.c.html#LN98"><span class='Ref_to_Member'>pipeRead</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN1604"><span class='Ref_to_Parameter'>do_wait</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="parallel.c.html#LN1606"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="../scripts/vacuumdb.c.html#LN75"><span class='Ref_to_Proto'>select_loop</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1608"><span class='Ref_To_Local'>maxFd</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="parallel.c.html#LN1607"><span class='Ref_To_Local'>workerset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="parallel.c.html#LN1606"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="parallel.c.html#LN1606"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="../../include/port/win32.h.html#LN373"><span class='Ref_to_Macro'>select</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1608"><span class='Ref_To_Local'>maxFd</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="parallel.c.html#LN1607"><span class='Ref_To_Local'>workerset</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="parallel.c.html#LN1609"><span class='Ref_To_Local'>nowait</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN1606"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="pg_backup_utils.c.html#LN100"><span class='Ref_to_Func'>exit_horribly</span></a><span class='Parentheses'>(</span><a href="pg_dump_sort.c.html#LN24"><span class='Ref_to_Global_Var'>modulename</span></a><span class='Delimiter'>, </span><span class='String'>"select() failed: %s\n"</span><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN1606"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="parallel.c.html#LN1606"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="parallel.c.html#LN1604"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN41"><span class='Ref_to_Member'>numWorkers</span></a><span class='Delimiter'>; </span><a href="parallel.c.html#LN1606"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1638"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>msg</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>FD_ISSET<span class='Parentheses'>(</span><a href="parallel.c.html#LN1604"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN44"><span class='Ref_to_Member'>parallelSlot</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN1606"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="parallel.c.html#LN98"><span class='Ref_to_Member'>pipeRead</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="parallel.c.html#LN1607"><span class='Ref_To_Local'>workerset</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Read the message if any.  If the socket is ready because of EOF, 
         * we'll return NULL instead (and the socket will stay ready, so the 
         * condition will persist). 
         * 
         * Note: because this is a blocking read, we'll wait if only part of 
         * the message is available.  Waiting a long time would be bad, but 
         * since worker status messages are short and are always sent in one 
         * operation, it shouldn't be a problem in practice. 
         */ 
</span>        <a href="parallel.c.html#LN1638"><span class='Ref_To_Local'>msg</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN221"><span class='Ref_to_Proto'>readMessageFromPipe</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1604"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN44"><span class='Ref_to_Member'>parallelSlot</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN1606"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="parallel.c.html#LN98"><span class='Ref_to_Member'>pipeRead</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="parallel.c.html#LN1604"><span class='Ref_to_Parameter'>worker</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN1606"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="parallel.c.html#LN1638"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;pstate-&GT;numWork... &raquo; </span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end getMessageFromWorker &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Send a command message to the specified worker process. 
 * 
 * This function is executed in the master process. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1667"></a><span class='Declare_Function'>sendMessageToWorker</span><span class='Parentheses'>(</span><a href="parallel.h.html#LN39"><span class='Ref_to_Struct'>ParallelState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>worker</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>str</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1669"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>len</span> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="parallel.c.html#LN1667"><span class='Ref_to_Parameter'>str</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN127"><span class='Ref_to_Macro'>pipewrite</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1667"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="parallel.h.html#LN44"><span class='Ref_to_Member'>parallelSlot</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN1667"><span class='Ref_to_Parameter'>worker</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="parallel.c.html#LN99"><span class='Ref_to_Member'>pipeWrite</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1667"><span class='Ref_to_Parameter'>str</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1669"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="parallel.c.html#LN1669"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="pg_backup_utils.c.html#LN100"><span class='Ref_to_Func'>exit_horribly</span></a><span class='Parentheses'>(</span><a href="pg_dump_sort.c.html#LN24"><span class='Ref_to_Global_Var'>modulename</span></a><span class='Delimiter'>, 
</span>                      <span class='String'>"could not write to the communication channel: %s\n"</span><span class='Delimiter'>, 
</span>                      <a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Read one message from the specified pipe (fd), blocking if necessary 
 * until one is available, and return it as a malloc'd string. 
 * On EOF, return NULL. 
 * 
 * A "message" on the channel is just a null-terminated string. 
 */ 
</span><span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN1687"></a><span class='Declare_Function'>readMessageFromPipe</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>fd</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1689"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>msg</span><span class='Delimiter'>; 
</span><a name="LN1690"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>msgsize</span><span class='Delimiter'>, 
</span><a name="LN1691"></a>                <span class='Declare_Local'>bufsize</span><span class='Delimiter'>; 
</span><a name="LN1692"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ret</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * In theory, if we let piperead() read multiple bytes, it might give us 
     * back fragments of multiple messages.  (That can't actually occur, since 
     * neither master nor workers send more than one message without waiting 
     * for a reply, but we don't wish to assume that here.)  For simplicity, 
     * read a byte at a time until we get the terminating '\0'.  This method 
     * is a bit inefficient, but since this is only used for relatively short 
     * command and status strings, it shouldn't matter. 
     */ 
</span>    <a href="parallel.c.html#LN1691"><span class='Ref_To_Local'>bufsize</span></a> <span class='Operator'>= </span><span class='Number'>64</span><span class='Delimiter'>;</span>               <span class='Comment_Single_Line'>/* could be any number */ 
</span>    <a href="parallel.c.html#LN1689"><span class='Ref_To_Local'>msg</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN25"><span class='Ref_to_Proto'>pg_malloc</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1691"><span class='Ref_To_Local'>bufsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="parallel.c.html#LN1690"><span class='Ref_To_Local'>msgsize</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="parallel.c.html#LN1690"><span class='Ref_To_Local'>msgsize</span></a> <span class='Operator'>&LT; </span><a href="parallel.c.html#LN1691"><span class='Ref_To_Local'>bufsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="parallel.c.html#LN1692"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN126"><span class='Ref_to_Proto'>piperead</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1687"><span class='Ref_to_Parameter'>fd</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1689"><span class='Ref_To_Local'>msg</span></a> <span class='Operator'>+ </span><a href="parallel.c.html#LN1690"><span class='Ref_To_Local'>msgsize</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN1692"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>;</span>              <span class='Comment_Single_Line'>/* error or connection closure */ 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="parallel.c.html#LN1692"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN1689"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN1690"><span class='Ref_To_Local'>msgsize</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <a href="parallel.c.html#LN1689"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* collected whole message */ 
</span> 
        <a href="parallel.c.html#LN1690"><span class='Ref_To_Local'>msgsize</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN1690"><span class='Ref_To_Local'>msgsize</span></a> <span class='Operator'>== </span><a href="parallel.c.html#LN1691"><span class='Ref_To_Local'>bufsize</span></a><span class='Parentheses'>) </span><span class='Comment_Single_Line'>/* enlarge buffer if needed */ 
</span>        <span class='Delimiter'>{ 
</span>            <a href="parallel.c.html#LN1691"><span class='Ref_To_Local'>bufsize</span></a> <span class='Operator'>+= </span><span class='Number'>16</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* could be any number */ 
</span>            <a href="parallel.c.html#LN1689"><span class='Ref_To_Local'>msg</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN28"><span class='Ref_to_Proto'>pg_realloc</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1689"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1691"><span class='Ref_To_Local'>bufsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Other end has closed the connection */ 
</span>    <a href="../../include/common/fe_memutils.h.html#LN29"><span class='Ref_to_Proto'>pg_free</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1689"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end readMessageFromPipe &raquo; </span> 
 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
 
<span class='Comment_Multi_Line'>/* 
 * This is a replacement version of pipe(2) for Windows which allows the pipe 
 * handles to be used in select(). 
 * 
 * Reads and writes on the pipe must go through piperead()/pipewrite(). 
 * 
 * For consistency with Unix we declare the returned handles as "int". 
 * This is okay even on WIN64 because system handles are not more than 
 * 32 bits wide, but we do have to do some casting. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN1744"></a><span class='Declare_Function'>pgpipe</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>handles</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1746"></a>    <a href="../../include/port.h.html#LN25"><span class='Ref_to_Typedef'>pgsocket</span></a>    <span class='Declare_Local'>s</span><span class='Delimiter'>, 
</span><a name="LN1747"></a>                <span class='Declare_Local'>tmp_sock</span><span class='Delimiter'>; 
</span><a name="LN1748"></a>    <span class='Control'>struct</span> sockaddr_in <span class='Declare_Local'>serv_addr</span><span class='Delimiter'>; 
</span><a name="LN1749"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>len</span> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="parallel.c.html#LN1748"><span class='Ref_To_Local'>serv_addr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We have to use the Unix socket invalid file descriptor value here. */ 
</span>    <a href="parallel.c.html#LN1744"><span class='Ref_to_Parameter'>handles</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="parallel.c.html#LN1744"><span class='Ref_to_Parameter'>handles</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * setup listen socket 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="parallel.c.html#LN1746"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>= </span><a href="../../include/port/win32.h.html#LN368"><span class='Ref_to_Macro'>socket</span></a><span class='Parentheses'>(</span>AF_INET<span class='Delimiter'>, </span>SOCK_STREAM<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>))</span> <span class='Operator'>== </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="pg_backup_utils.c.html#LN69"><span class='Ref_to_Func'>write_msg</span></a><span class='Parentheses'>(</span><a href="pg_dump_sort.c.html#LN24"><span class='Ref_to_Global_Var'>modulename</span></a><span class='Delimiter'>, </span><span class='String'>"pgpipe: could not create socket: error code %d\n"</span><span class='Delimiter'>, 
</span>                  WSAGetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    memset<span class='Parentheses'>((</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="parallel.c.html#LN1748"><span class='Ref_To_Local'>serv_addr</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="parallel.c.html#LN1748"><span class='Ref_To_Local'>serv_addr</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="parallel.c.html#LN1748"><span class='Ref_To_Local'>serv_addr</span></a><span class='Operator'>.</span>sin_family <span class='Operator'>= </span>AF_INET<span class='Delimiter'>; 
</span>    <a href="parallel.c.html#LN1748"><span class='Ref_To_Local'>serv_addr</span></a><span class='Operator'>.</span>sin_port <span class='Operator'>= </span>htons<span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="parallel.c.html#LN1748"><span class='Ref_To_Local'>serv_addr</span></a><span class='Operator'>.</span>sin_addr<span class='Operator'>.</span>s_addr <span class='Operator'>= </span>htonl<span class='Parentheses'>(</span>INADDR_LOOPBACK<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN369"><span class='Ref_to_Macro'>bind</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1746"><span class='Ref_To_Local'>s</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span>SOCKADDR <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="parallel.c.html#LN1748"><span class='Ref_To_Local'>serv_addr</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1749"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span> <span class='Operator'>== </span>SOCKET_ERROR<span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="pg_backup_utils.c.html#LN69"><span class='Ref_to_Func'>write_msg</span></a><span class='Parentheses'>(</span><a href="pg_dump_sort.c.html#LN24"><span class='Ref_to_Global_Var'>modulename</span></a><span class='Delimiter'>, </span><span class='String'>"pgpipe: could not bind: error code %d\n"</span><span class='Delimiter'>, 
</span>                  WSAGetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1746"><span class='Ref_To_Local'>s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN370"><span class='Ref_to_Macro'>listen</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1746"><span class='Ref_To_Local'>s</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>== </span>SOCKET_ERROR<span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="pg_backup_utils.c.html#LN69"><span class='Ref_to_Func'>write_msg</span></a><span class='Parentheses'>(</span><a href="pg_dump_sort.c.html#LN24"><span class='Ref_to_Global_Var'>modulename</span></a><span class='Delimiter'>, </span><span class='String'>"pgpipe: could not listen: error code %d\n"</span><span class='Delimiter'>, 
</span>                  WSAGetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1746"><span class='Ref_To_Local'>s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>getsockname<span class='Parentheses'>(</span><a href="parallel.c.html#LN1746"><span class='Ref_To_Local'>s</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span>SOCKADDR <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="parallel.c.html#LN1748"><span class='Ref_To_Local'>serv_addr</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="parallel.c.html#LN1749"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span> <span class='Operator'>== </span>SOCKET_ERROR<span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="pg_backup_utils.c.html#LN69"><span class='Ref_to_Func'>write_msg</span></a><span class='Parentheses'>(</span><a href="pg_dump_sort.c.html#LN24"><span class='Ref_to_Global_Var'>modulename</span></a><span class='Delimiter'>, </span><span class='String'>"pgpipe: getsockname() failed: error code %d\n"</span><span class='Delimiter'>, 
</span>                  WSAGetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1746"><span class='Ref_To_Local'>s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * setup pipe handles 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="parallel.c.html#LN1747"><span class='Ref_To_Local'>tmp_sock</span></a> <span class='Operator'>= </span><a href="../../include/port/win32.h.html#LN368"><span class='Ref_to_Macro'>socket</span></a><span class='Parentheses'>(</span>AF_INET<span class='Delimiter'>, </span>SOCK_STREAM<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>))</span> <span class='Operator'>== </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="pg_backup_utils.c.html#LN69"><span class='Ref_to_Func'>write_msg</span></a><span class='Parentheses'>(</span><a href="pg_dump_sort.c.html#LN24"><span class='Ref_to_Global_Var'>modulename</span></a><span class='Delimiter'>, </span><span class='String'>"pgpipe: could not create second socket: error code %d\n"</span><span class='Delimiter'>, 
</span>                  WSAGetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1746"><span class='Ref_To_Local'>s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="parallel.c.html#LN1744"><span class='Ref_to_Parameter'>handles</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="parallel.c.html#LN1747"><span class='Ref_To_Local'>tmp_sock</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN372"><span class='Ref_to_Macro'>connect</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1744"><span class='Ref_to_Parameter'>handles</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='Parentheses'>(</span>SOCKADDR <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="parallel.c.html#LN1748"><span class='Ref_To_Local'>serv_addr</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1749"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span> <span class='Operator'>== </span>SOCKET_ERROR<span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="pg_backup_utils.c.html#LN69"><span class='Ref_to_Func'>write_msg</span></a><span class='Parentheses'>(</span><a href="pg_dump_sort.c.html#LN24"><span class='Ref_to_Global_Var'>modulename</span></a><span class='Delimiter'>, </span><span class='String'>"pgpipe: could not connect socket: error code %d\n"</span><span class='Delimiter'>, 
</span>                  WSAGetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1744"><span class='Ref_to_Parameter'>handles</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="parallel.c.html#LN1744"><span class='Ref_to_Parameter'>handles</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1746"><span class='Ref_To_Local'>s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="parallel.c.html#LN1747"><span class='Ref_To_Local'>tmp_sock</span></a> <span class='Operator'>= </span><a href="../../include/port/win32.h.html#LN371"><span class='Ref_to_Macro'>accept</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1746"><span class='Ref_To_Local'>s</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span>SOCKADDR <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="parallel.c.html#LN1748"><span class='Ref_To_Local'>serv_addr</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="parallel.c.html#LN1749"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="pg_backup_utils.c.html#LN69"><span class='Ref_to_Func'>write_msg</span></a><span class='Parentheses'>(</span><a href="pg_dump_sort.c.html#LN24"><span class='Ref_to_Global_Var'>modulename</span></a><span class='Delimiter'>, </span><span class='String'>"pgpipe: could not accept connection: error code %d\n"</span><span class='Delimiter'>, 
</span>                  WSAGetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1744"><span class='Ref_to_Parameter'>handles</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="parallel.c.html#LN1744"><span class='Ref_to_Parameter'>handles</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1746"><span class='Ref_To_Local'>s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="parallel.c.html#LN1744"><span class='Ref_to_Parameter'>handles</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="parallel.c.html#LN1747"><span class='Ref_To_Local'>tmp_sock</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1746"><span class='Ref_To_Local'>s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgpipe &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Windows implementation of reading from a pipe. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN1830"></a><span class='Declare_Function'>piperead</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>s</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1832"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ret</span> <span class='Operator'>= </span><a href="../../include/port/win32.h.html#LN374"><span class='Ref_to_Macro'>recv</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1830"><span class='Ref_to_Parameter'>s</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1830"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1830"><span class='Ref_to_Parameter'>len</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN1832"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>&& </span>WSAGetLastError<span class='Parentheses'>() </span><span class='Operator'>== </span>WSAECONNRESET<span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* EOF on the pipe! */ 
</span>        <a href="parallel.c.html#LN1832"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <a href="parallel.c.html#LN1832"><span class='Ref_To_Local'>ret</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* WIN32 */ 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>