<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\bin\pg_dump\pg_backup_db.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\bin\pg_dump\pg_backup_db.c</b></p></td>
<td align='right'>
Wed Jun 14 08:26:00 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * pg_backup_db.c 
 * 
 *  Implements the basic DB functions used by the archiver. 
 * 
 * IDENTIFICATION 
 *    src/bin/pg_dump/pg_backup_db.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres_fe.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"dumputils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"fe_utils/string_utils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"parallel.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pg_backup_archiver.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pg_backup_db.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pg_backup_utils.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;ctype.h&GT;</span> 
<span class='Directive'>#ifdef</span> HAVE_TERMIOS_H 
<span class='Keyword'>#include </span><span class='String'>&LT;termios.h&GT;</span> 
<span class='Directive'>#endif</span> 
 
 
<span class='Comment_Multi_Line'>/* translator: this is a module name */ 
</span><a name="LN28"></a><span class='Keyword'>static const char </span><span class='Operator'>*</span><span class='Declare_Var'>modulename</span> <span class='Operator'>= </span><a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"archiver (db)"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN30"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>_check_database_version</span><span class='Parentheses'>(</span><a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AH</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN31"></a><span class='Keyword'>static </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>_connectDB</span><span class='Parentheses'>(</span><a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AH</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>newdbname</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>newUser</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN32"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>notice_processor</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>message</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Keyword'>static void 
</span><a name="LN35"></a><span class='Declare_Function'>_check_database_version</span><span class='Parentheses'>(</span><a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AH</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN37"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>remoteversion_str</span><span class='Delimiter'>; 
</span><a name="LN38"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>remoteversion</span><span class='Delimiter'>; 
</span><a name="LN39"></a>    <a href="../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span> 
    <a href="pg_backup_db.c.html#LN37"><span class='Ref_To_Local'>remoteversion_str</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN319"><span class='Ref_to_Proto'>PQparameterStatus</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN35"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Delimiter'>, </span><span class='String'>"server_version"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_backup_db.c.html#LN38"><span class='Ref_To_Local'>remoteversion</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN322"><span class='Ref_to_Proto'>PQserverVersion</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN35"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN38"><span class='Ref_To_Local'>remoteversion</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| !</span><a href="pg_backup_db.c.html#LN37"><span class='Ref_To_Local'>remoteversion_str</span></a><span class='Parentheses'>) 
</span>        <a href="pg_backup_utils.c.html#LN100"><span class='Ref_to_Func'>exit_horribly</span></a><span class='Parentheses'>(</span><a href="pg_dump_sort.c.html#LN24"><span class='Ref_to_Global_Var'>modulename</span></a><span class='Delimiter'>, </span><span class='String'>"could not get server_version from libpq\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pg_backup_db.c.html#LN35"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><span class='Keyword'>public</span><span class='Operator'>.</span><a href="pg_backup.h.html#LN183"><span class='Ref_to_Member'>remoteVersionStr</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN24"><span class='Ref_to_Proto'>pg_strdup</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN37"><span class='Ref_To_Local'>remoteversion_str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_backup_db.c.html#LN35"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><span class='Keyword'>public</span><span class='Operator'>.</span><a href="pg_backup.h.html#LN184"><span class='Ref_to_Member'>remoteVersion</span></a> <span class='Operator'>= </span><a href="pg_backup_db.c.html#LN38"><span class='Ref_To_Local'>remoteversion</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_backup_db.c.html#LN35"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN217"><span class='Ref_to_Member'>archiveRemoteVersion</span></a><span class='Parentheses'>) 
</span>        <a href="pg_backup_db.c.html#LN35"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN217"><span class='Ref_to_Member'>archiveRemoteVersion</span></a> <span class='Operator'>= </span><a href="pg_backup_db.c.html#LN35"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><span class='Keyword'>public</span><span class='Operator'>.</span><a href="pg_backup.h.html#LN183"><span class='Ref_to_Member'>remoteVersionStr</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN38"><span class='Ref_To_Local'>remoteversion</span></a> <span class='Operator'>!= </span>PG_VERSION_NUM 
        <span class='Operator'>&& </span><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN38"><span class='Ref_To_Local'>remoteversion</span></a> <span class='Operator'>&LT; </span><a href="pg_backup_db.c.html#LN35"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><span class='Keyword'>public</span><span class='Operator'>.</span><a href="pg_backup.h.html#LN187"><span class='Ref_to_Member'>minRemoteVersion</span></a> <span class='Operator'>|| 
</span>            <a href="pg_backup_db.c.html#LN38"><span class='Ref_To_Local'>remoteversion</span></a> <span class='Operator'>&GT; </span><a href="pg_backup_db.c.html#LN35"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><span class='Keyword'>public</span><span class='Operator'>.</span><a href="pg_backup.h.html#LN188"><span class='Ref_to_Member'>maxRemoteVersion</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="pg_backup_utils.c.html#LN69"><span class='Ref_to_Func'>write_msg</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>"server version: %s; %s version: %s\n"</span><span class='Delimiter'>, 
</span>                  <a href="pg_backup_db.c.html#LN37"><span class='Ref_To_Local'>remoteversion_str</span></a><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span>PG_VERSION<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_backup_utils.c.html#LN100"><span class='Ref_to_Func'>exit_horribly</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>"aborting because of server version mismatch\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * When running against 9.0 or later, check if we are in recovery mode, 
     * which means we are on a hot standby. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN38"><span class='Ref_To_Local'>remoteversion</span></a> <span class='Operator'>&GT;= </span><span class='Number'>90000</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pg_backup_db.c.html#LN39"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="pg_backup_db.h.html#LN18"><span class='Ref_to_Proto'>ExecuteSqlQueryForSingleRow</span></a><span class='Parentheses'>((</span><a href="pg_backup.h.html#LN177"><span class='Ref_to_Struct'>Archive</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="pg_backup_db.c.html#LN35"><span class='Ref_to_Parameter'>AH</span></a><span class='Delimiter'>, </span><span class='String'>"SELECT pg_catalog.pg_is_in_recovery()"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="pg_backup_db.c.html#LN35"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><span class='Keyword'>public</span><span class='Operator'>.</span><a href="pg_backup.h.html#LN185"><span class='Ref_to_Member'>isStandby</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN488"><span class='Ref_to_Proto'>PQgetvalue</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN39"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"t"</span><span class='Parentheses'>)</span> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN39"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="pg_backup_db.c.html#LN35"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><span class='Keyword'>public</span><span class='Operator'>.</span><a href="pg_backup.h.html#LN185"><span class='Ref_to_Member'>isStandby</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _check_database_version &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Reconnect to the server.  If dbname is not NULL, use that database, 
 * else the one associated with the archive handle.  If username is 
 * not NULL, use that user name, else the one from the handle.  If 
 * both the database and the user match the existing connection already, 
 * nothing will be done. 
 * 
 * Returns 1 in any case. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN85"></a><span class='Declare_Function'>ReconnectToServer</span><span class='Parentheses'>(</span><a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AH</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dbname</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>username</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN87"></a>    <a href="../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>newConn</span><span class='Delimiter'>; 
</span><a name="LN88"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>newdbname</span><span class='Delimiter'>; 
</span><a name="LN89"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>newusername</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_backup_db.c.html#LN85"><span class='Ref_to_Parameter'>dbname</span></a><span class='Parentheses'>) 
</span>        <a href="pg_backup_db.c.html#LN88"><span class='Ref_To_Local'>newdbname</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN310"><span class='Ref_to_Proto'>PQdb</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN85"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="pg_backup_db.c.html#LN88"><span class='Ref_To_Local'>newdbname</span></a> <span class='Operator'>= </span><a href="pg_backup_db.c.html#LN85"><span class='Ref_to_Parameter'>dbname</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_backup_db.c.html#LN85"><span class='Ref_to_Parameter'>username</span></a><span class='Parentheses'>) 
</span>        <a href="pg_backup_db.c.html#LN89"><span class='Ref_To_Local'>newusername</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN311"><span class='Ref_to_Proto'>PQuser</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN85"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="pg_backup_db.c.html#LN89"><span class='Ref_To_Local'>newusername</span></a> <span class='Operator'>= </span><a href="pg_backup_db.c.html#LN85"><span class='Ref_to_Parameter'>username</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Let's see if the request is already satisfied */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN88"><span class='Ref_To_Local'>newdbname</span></a><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN310"><span class='Ref_to_Proto'>PQdb</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN85"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>        strcmp<span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN89"><span class='Ref_To_Local'>newusername</span></a><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN311"><span class='Ref_to_Proto'>PQuser</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN85"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <a href="pg_backup_db.c.html#LN87"><span class='Ref_To_Local'>newConn</span></a> <span class='Operator'>= </span><a href="pg_backup_db.c.html#LN31"><span class='Ref_to_Proto'>_connectDB</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN85"><span class='Ref_to_Parameter'>AH</span></a><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN88"><span class='Ref_To_Local'>newdbname</span></a><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN89"><span class='Ref_To_Local'>newusername</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Update ArchiveHandle's connCancel before closing old connection */ 
</span>    <a href="parallel.h.html#LN67"><span class='Ref_to_Proto'>set_archive_cancel_info</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN85"><span class='Ref_to_Parameter'>AH</span></a><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN87"><span class='Ref_To_Local'>newConn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../interfaces/libpq/libpq-fe.h.html#LN272"><span class='Ref_to_Proto'>PQfinish</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN85"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_backup_db.c.html#LN85"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a> <span class='Operator'>= </span><a href="pg_backup_db.c.html#LN87"><span class='Ref_To_Local'>newConn</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Number'>1</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReconnectToServer &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Connect to the db again. 
 * 
 * Note: it's not really all that sensible to use a single-entry password 
 * cache if the username keeps changing.  In current usage, however, the 
 * username never does change, so one savedPassword is sufficient.  We do 
 * update the cache on the off chance that the password has changed since the 
 * start of the run. 
 */ 
</span><span class='Keyword'>static </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>* 
</span><a name="LN127"></a><span class='Declare_Function'>_connectDB</span><span class='Parentheses'>(</span><a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AH</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>reqdb</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>requser</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN129"></a>    <a href="../../interfaces/libpq/pqexpbuffer.h.html#LN43"><span class='Ref_to_Struct'>PQExpBufferData</span></a> <span class='Declare_Local'>connstr</span><span class='Delimiter'>; 
</span><a name="LN130"></a>    <a href="../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>newConn</span><span class='Delimiter'>; 
</span><a name="LN131"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>newdb</span><span class='Delimiter'>; 
</span><a name="LN132"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>newuser</span><span class='Delimiter'>; 
</span><a name="LN133"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>password</span><span class='Delimiter'>; 
</span><a name="LN134"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>passbuf</span><span class='Delimiter'>[</span><span class='Number'>100</span><span class='Delimiter'>]; 
</span><a name="LN135"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>new_pass</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_backup_db.c.html#LN127"><span class='Ref_to_Parameter'>reqdb</span></a><span class='Parentheses'>) 
</span>        <a href="pg_backup_db.c.html#LN131"><span class='Ref_To_Local'>newdb</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN310"><span class='Ref_to_Proto'>PQdb</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN127"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="pg_backup_db.c.html#LN131"><span class='Ref_To_Local'>newdb</span></a> <span class='Operator'>= </span><a href="pg_backup_db.c.html#LN127"><span class='Ref_to_Parameter'>reqdb</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_backup_db.c.html#LN127"><span class='Ref_to_Parameter'>requser</span></a> <span class='Operator'>|| </span>strlen<span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN127"><span class='Ref_to_Parameter'>requser</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="pg_backup_db.c.html#LN132"><span class='Ref_To_Local'>newuser</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN311"><span class='Ref_to_Proto'>PQuser</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN127"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="pg_backup_db.c.html#LN132"><span class='Ref_To_Local'>newuser</span></a> <span class='Operator'>= </span><a href="pg_backup_db.c.html#LN127"><span class='Ref_to_Parameter'>requser</span></a><span class='Delimiter'>; 
</span> 
    <a href="pg_backup_archiver.c.html#LN1616"><span class='Ref_to_Func'>ahlog</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN127"><span class='Ref_to_Parameter'>AH</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='String'>"connecting to database \"%s\" as user \"%s\"\n"</span><span class='Delimiter'>, 
</span>          <a href="pg_backup_db.c.html#LN131"><span class='Ref_To_Local'>newdb</span></a><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN132"><span class='Ref_To_Local'>newuser</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pg_backup_db.c.html#LN133"><span class='Ref_To_Local'>password</span></a> <span class='Operator'>= </span><a href="pg_backup_db.c.html#LN127"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN282"><span class='Ref_to_Member'>savedPassword</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN127"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN281"><span class='Ref_to_Member'>promptPassword</span></a> <span class='Operator'>== </span><a href="pg_backup.h.html#LN33"><span class='Ref_to_EnumConst'>TRI_YES</span></a> <span class='Operator'>&& </span><a href="pg_backup_db.c.html#LN133"><span class='Ref_To_Local'>password</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../port/sprompt.c.html#LN35"><span class='Ref_to_Func'>simple_prompt</span></a><span class='Parentheses'>(</span><span class='String'>"Password: "</span><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN134"><span class='Ref_To_Local'>passbuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN134"><span class='Ref_To_Local'>passbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_backup_db.c.html#LN133"><span class='Ref_To_Local'>password</span></a> <span class='Operator'>= </span><a href="pg_backup_db.c.html#LN134"><span class='Ref_To_Local'>passbuf</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../interfaces/libpq/pqexpbuffer.c.html#LN87"><span class='Ref_to_Func'>initPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_backup_db.c.html#LN129"><span class='Ref_To_Local'>connstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../interfaces/libpq/pqexpbuffer.c.html#LN260"><span class='Ref_to_Func'>appendPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_backup_db.c.html#LN129"><span class='Ref_To_Local'>connstr</span></a><span class='Delimiter'>, </span><span class='String'>"dbname="</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/fe_utils/string_utils.h.html#LN45"><span class='Ref_to_Proto'>appendConnStrVal</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_backup_db.c.html#LN129"><span class='Ref_To_Local'>connstr</span></a><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN131"><span class='Ref_To_Local'>newdb</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>do</span> 
    <span class='Delimiter'>{ 
</span><a name="LN164"></a>        <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>keywords</span><span class='Delimiter'>[</span><span class='Number'>7</span><span class='Delimiter'>]; 
</span><a name="LN165"></a>        <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>values</span><span class='Delimiter'>[</span><span class='Number'>7</span><span class='Delimiter'>]; 
</span> 
        <a href="pg_backup_db.c.html#LN164"><span class='Ref_To_Local'>keywords</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>"host"</span><span class='Delimiter'>; 
</span>        <a href="pg_backup_db.c.html#LN165"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN313"><span class='Ref_to_Proto'>PQhost</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN127"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_backup_db.c.html#LN164"><span class='Ref_To_Local'>keywords</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>"port"</span><span class='Delimiter'>; 
</span>        <a href="pg_backup_db.c.html#LN165"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN314"><span class='Ref_to_Proto'>PQport</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN127"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_backup_db.c.html#LN164"><span class='Ref_To_Local'>keywords</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>"user"</span><span class='Delimiter'>; 
</span>        <a href="pg_backup_db.c.html#LN165"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="pg_backup_db.c.html#LN132"><span class='Ref_To_Local'>newuser</span></a><span class='Delimiter'>; 
</span>        <a href="pg_backup_db.c.html#LN164"><span class='Ref_To_Local'>keywords</span></a><span class='Delimiter'>[</span><span class='Number'>3</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>"password"</span><span class='Delimiter'>; 
</span>        <a href="pg_backup_db.c.html#LN165"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>3</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="pg_backup_db.c.html#LN133"><span class='Ref_To_Local'>password</span></a><span class='Delimiter'>; 
</span>        <a href="pg_backup_db.c.html#LN164"><span class='Ref_To_Local'>keywords</span></a><span class='Delimiter'>[</span><span class='Number'>4</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>"dbname"</span><span class='Delimiter'>; 
</span>        <a href="pg_backup_db.c.html#LN165"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>4</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="pg_backup_db.c.html#LN129"><span class='Ref_To_Local'>connstr</span></a><span class='Operator'>.</span><a href="../../interfaces/libpq/pqexpbuffer.h.html#LN45"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>; 
</span>        <a href="pg_backup_db.c.html#LN164"><span class='Ref_To_Local'>keywords</span></a><span class='Delimiter'>[</span><span class='Number'>5</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>"fallback_application_name"</span><span class='Delimiter'>; 
</span>        <a href="pg_backup_db.c.html#LN165"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>5</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>; 
</span>        <a href="pg_backup_db.c.html#LN164"><span class='Ref_To_Local'>keywords</span></a><span class='Delimiter'>[</span><span class='Number'>6</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="pg_backup_db.c.html#LN165"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>6</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <a href="pg_backup_db.c.html#LN135"><span class='Ref_To_Local'>new_pass</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="pg_backup_db.c.html#LN130"><span class='Ref_To_Local'>newConn</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN261"><span class='Ref_to_Proto'>PQconnectdbParams</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN164"><span class='Ref_To_Local'>keywords</span></a><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN165"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_backup_db.c.html#LN130"><span class='Ref_To_Local'>newConn</span></a><span class='Parentheses'>) 
</span>            <a href="pg_backup_utils.c.html#LN100"><span class='Ref_to_Func'>exit_horribly</span></a><span class='Parentheses'>(</span><a href="pg_dump_sort.c.html#LN24"><span class='Ref_to_Global_Var'>modulename</span></a><span class='Delimiter'>, </span><span class='String'>"failed to reconnect to database\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN317"><span class='Ref_to_Proto'>PQstatus</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN130"><span class='Ref_To_Local'>newConn</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN49"><span class='Ref_to_EnumConst'>CONNECTION_BAD</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN326"><span class='Ref_to_Proto'>PQconnectionNeedsPassword</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN130"><span class='Ref_To_Local'>newConn</span></a><span class='Parentheses'>))</span> 
                <a href="pg_backup_utils.c.html#LN100"><span class='Ref_to_Func'>exit_horribly</span></a><span class='Parentheses'>(</span><a href="pg_dump_sort.c.html#LN24"><span class='Ref_to_Global_Var'>modulename</span></a><span class='Delimiter'>, </span><span class='String'>"could not reconnect to database: %s"</span><span class='Delimiter'>, 
</span>                              <a href="../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN130"><span class='Ref_To_Local'>newConn</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="../../interfaces/libpq/libpq-fe.h.html#LN272"><span class='Ref_to_Proto'>PQfinish</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN130"><span class='Ref_To_Local'>newConn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN133"><span class='Ref_To_Local'>password</span></a><span class='Parentheses'>) 
</span>                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"Password incorrect\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"Connecting to %s as %s\n"</span><span class='Delimiter'>, 
</span>                    <a href="pg_backup_db.c.html#LN131"><span class='Ref_To_Local'>newdb</span></a><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN132"><span class='Ref_To_Local'>newuser</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN127"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN281"><span class='Ref_to_Member'>promptPassword</span></a> <span class='Operator'>!= </span><a href="pg_backup.h.html#LN32"><span class='Ref_to_EnumConst'>TRI_NO</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../port/sprompt.c.html#LN35"><span class='Ref_to_Func'>simple_prompt</span></a><span class='Parentheses'>(</span><span class='String'>"Password: "</span><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN134"><span class='Ref_To_Local'>passbuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN134"><span class='Ref_To_Local'>passbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="pg_backup_db.c.html#LN133"><span class='Ref_To_Local'>password</span></a> <span class='Operator'>= </span><a href="pg_backup_db.c.html#LN134"><span class='Ref_To_Local'>passbuf</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
                <a href="pg_backup_utils.c.html#LN100"><span class='Ref_to_Func'>exit_horribly</span></a><span class='Parentheses'>(</span><a href="pg_dump_sort.c.html#LN24"><span class='Ref_to_Global_Var'>modulename</span></a><span class='Delimiter'>, </span><span class='String'>"connection needs password\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="pg_backup_db.c.html#LN135"><span class='Ref_To_Local'>new_pass</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if PQstatus(newConn)==CO... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end do &raquo; </span> <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN135"><span class='Ref_To_Local'>new_pass</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We want to remember connection's actual password, whether or not we got 
     * it by prompting.  So we don't just store the password variable. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN327"><span class='Ref_to_Proto'>PQconnectionUsedPassword</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN130"><span class='Ref_To_Local'>newConn</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN127"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN282"><span class='Ref_to_Member'>savedPassword</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN127"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN282"><span class='Ref_to_Member'>savedPassword</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_backup_db.c.html#LN127"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN282"><span class='Ref_to_Member'>savedPassword</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN24"><span class='Ref_to_Proto'>pg_strdup</span></a><span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN312"><span class='Ref_to_Proto'>PQpass</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN130"><span class='Ref_To_Local'>newConn</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../interfaces/libpq/pqexpbuffer.h.html#LN121"><span class='Ref_to_Proto'>termPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_backup_db.c.html#LN129"><span class='Ref_To_Local'>connstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* check for version mismatch */ 
</span>    <a href="pg_backup_db.c.html#LN30"><span class='Ref_to_Proto'>_check_database_version</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN127"><span class='Ref_to_Parameter'>AH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../interfaces/libpq/libpq-fe.h.html#LN362"><span class='Ref_to_Proto'>PQsetNoticeProcessor</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN130"><span class='Ref_To_Local'>newConn</span></a><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN32"><span class='Ref_to_Proto'>notice_processor</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="pg_backup_db.c.html#LN130"><span class='Ref_To_Local'>newConn</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _connectDB &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Make a database connection with the given parameters.  The 
 * connection handle is returned, the parameters are stored in AHX. 
 * An interactive password prompt is automatically issued if required. 
 * 
 * Note: it's not really all that sensible to use a single-entry password 
 * cache if the username keeps changing.  In current usage, however, the 
 * username never does change, so one savedPassword is sufficient. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN245"></a><span class='Declare_Function'>ConnectDatabase</span><span class='Parentheses'>(</span><a href="pg_backup.h.html#LN177"><span class='Ref_to_Struct'>Archive</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AHX</span><span class='Delimiter'>, 
</span><a name="LN246"></a>                <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dbname</span><span class='Delimiter'>, 
</span><a name="LN247"></a>                <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>pghost</span><span class='Delimiter'>, 
</span><a name="LN248"></a>                <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>pgport</span><span class='Delimiter'>, 
</span><a name="LN249"></a>                <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>username</span><span class='Delimiter'>, 
</span><a name="LN250"></a>                <a href="pg_backup.h.html#LN29"><span class='Ref_to_Enum'>trivalue</span></a> <span class='Declare_Parameter'>prompt_password</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN252"></a>    <a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Local'>AH</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="pg_backup_db.c.html#LN245"><span class='Ref_to_Parameter'>AHX</span></a><span class='Delimiter'>; 
</span><a name="LN253"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>password</span><span class='Delimiter'>; 
</span><a name="LN254"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>passbuf</span><span class='Delimiter'>[</span><span class='Number'>100</span><span class='Delimiter'>]; 
</span><a name="LN255"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>new_pass</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN252"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Parentheses'>) 
</span>        <a href="pg_backup_utils.c.html#LN100"><span class='Ref_to_Func'>exit_horribly</span></a><span class='Parentheses'>(</span><a href="pg_dump_sort.c.html#LN24"><span class='Ref_to_Global_Var'>modulename</span></a><span class='Delimiter'>, </span><span class='String'>"already connected to a database\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pg_backup_db.c.html#LN253"><span class='Ref_To_Local'>password</span></a> <span class='Operator'>= </span><a href="pg_backup_db.c.html#LN252"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN282"><span class='Ref_to_Member'>savedPassword</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN250"><span class='Ref_to_Parameter'>prompt_password</span></a> <span class='Operator'>== </span><a href="pg_backup.h.html#LN33"><span class='Ref_to_EnumConst'>TRI_YES</span></a> <span class='Operator'>&& </span><a href="pg_backup_db.c.html#LN253"><span class='Ref_To_Local'>password</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../port/sprompt.c.html#LN35"><span class='Ref_to_Func'>simple_prompt</span></a><span class='Parentheses'>(</span><span class='String'>"Password: "</span><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN254"><span class='Ref_To_Local'>passbuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN254"><span class='Ref_To_Local'>passbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_backup_db.c.html#LN253"><span class='Ref_To_Local'>password</span></a> <span class='Operator'>= </span><a href="pg_backup_db.c.html#LN254"><span class='Ref_To_Local'>passbuf</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="pg_backup_db.c.html#LN252"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN281"><span class='Ref_to_Member'>promptPassword</span></a> <span class='Operator'>= </span><a href="pg_backup_db.c.html#LN250"><span class='Ref_to_Parameter'>prompt_password</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Start the connection.  Loop until we have a password if requested by 
     * backend. 
     */ 
</span>    <span class='Control'>do</span> 
    <span class='Delimiter'>{ 
</span><a name="LN275"></a>        <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>keywords</span><span class='Delimiter'>[</span><span class='Number'>7</span><span class='Delimiter'>]; 
</span><a name="LN276"></a>        <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>values</span><span class='Delimiter'>[</span><span class='Number'>7</span><span class='Delimiter'>]; 
</span> 
        <a href="pg_backup_db.c.html#LN275"><span class='Ref_To_Local'>keywords</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>"host"</span><span class='Delimiter'>; 
</span>        <a href="pg_backup_db.c.html#LN276"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="pg_backup_db.c.html#LN247"><span class='Ref_to_Parameter'>pghost</span></a><span class='Delimiter'>; 
</span>        <a href="pg_backup_db.c.html#LN275"><span class='Ref_To_Local'>keywords</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>"port"</span><span class='Delimiter'>; 
</span>        <a href="pg_backup_db.c.html#LN276"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="pg_backup_db.c.html#LN248"><span class='Ref_to_Parameter'>pgport</span></a><span class='Delimiter'>; 
</span>        <a href="pg_backup_db.c.html#LN275"><span class='Ref_To_Local'>keywords</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>"user"</span><span class='Delimiter'>; 
</span>        <a href="pg_backup_db.c.html#LN276"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="pg_backup_db.c.html#LN249"><span class='Ref_to_Parameter'>username</span></a><span class='Delimiter'>; 
</span>        <a href="pg_backup_db.c.html#LN275"><span class='Ref_To_Local'>keywords</span></a><span class='Delimiter'>[</span><span class='Number'>3</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>"password"</span><span class='Delimiter'>; 
</span>        <a href="pg_backup_db.c.html#LN276"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>3</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="pg_backup_db.c.html#LN253"><span class='Ref_To_Local'>password</span></a><span class='Delimiter'>; 
</span>        <a href="pg_backup_db.c.html#LN275"><span class='Ref_To_Local'>keywords</span></a><span class='Delimiter'>[</span><span class='Number'>4</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>"dbname"</span><span class='Delimiter'>; 
</span>        <a href="pg_backup_db.c.html#LN276"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>4</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="pg_backup_db.c.html#LN246"><span class='Ref_to_Parameter'>dbname</span></a><span class='Delimiter'>; 
</span>        <a href="pg_backup_db.c.html#LN275"><span class='Ref_To_Local'>keywords</span></a><span class='Delimiter'>[</span><span class='Number'>5</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>"fallback_application_name"</span><span class='Delimiter'>; 
</span>        <a href="pg_backup_db.c.html#LN276"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>5</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>; 
</span>        <a href="pg_backup_db.c.html#LN275"><span class='Ref_To_Local'>keywords</span></a><span class='Delimiter'>[</span><span class='Number'>6</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="pg_backup_db.c.html#LN276"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>6</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <a href="pg_backup_db.c.html#LN255"><span class='Ref_To_Local'>new_pass</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="pg_backup_db.c.html#LN252"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN261"><span class='Ref_to_Proto'>PQconnectdbParams</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN275"><span class='Ref_To_Local'>keywords</span></a><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN276"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_backup_db.c.html#LN252"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Parentheses'>) 
</span>            <a href="pg_backup_utils.c.html#LN100"><span class='Ref_to_Func'>exit_horribly</span></a><span class='Parentheses'>(</span><a href="pg_dump_sort.c.html#LN24"><span class='Ref_to_Global_Var'>modulename</span></a><span class='Delimiter'>, </span><span class='String'>"failed to connect to database\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN317"><span class='Ref_to_Proto'>PQstatus</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN252"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN49"><span class='Ref_to_EnumConst'>CONNECTION_BAD</span></a> <span class='Operator'>&& 
</span>            <a href="../../interfaces/libpq/libpq-fe.h.html#LN326"><span class='Ref_to_Proto'>PQconnectionNeedsPassword</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN252"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>            <a href="pg_backup_db.c.html#LN253"><span class='Ref_To_Local'>password</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>&& 
</span>            <a href="pg_backup_db.c.html#LN250"><span class='Ref_to_Parameter'>prompt_password</span></a> <span class='Operator'>!= </span><a href="pg_backup.h.html#LN32"><span class='Ref_to_EnumConst'>TRI_NO</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../interfaces/libpq/libpq-fe.h.html#LN272"><span class='Ref_to_Proto'>PQfinish</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN252"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../port/sprompt.c.html#LN35"><span class='Ref_to_Func'>simple_prompt</span></a><span class='Parentheses'>(</span><span class='String'>"Password: "</span><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN254"><span class='Ref_To_Local'>passbuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN254"><span class='Ref_To_Local'>passbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pg_backup_db.c.html#LN253"><span class='Ref_To_Local'>password</span></a> <span class='Operator'>= </span><a href="pg_backup_db.c.html#LN254"><span class='Ref_To_Local'>passbuf</span></a><span class='Delimiter'>; 
</span>            <a href="pg_backup_db.c.html#LN255"><span class='Ref_To_Local'>new_pass</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end do &raquo; </span> <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN255"><span class='Ref_To_Local'>new_pass</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* check to see that the backend connection was successfully made */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN317"><span class='Ref_to_Proto'>PQstatus</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN252"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN49"><span class='Ref_to_EnumConst'>CONNECTION_BAD</span></a><span class='Parentheses'>)</span> 
        <a href="pg_backup_utils.c.html#LN100"><span class='Ref_to_Func'>exit_horribly</span></a><span class='Parentheses'>(</span><a href="pg_dump_sort.c.html#LN24"><span class='Ref_to_Global_Var'>modulename</span></a><span class='Delimiter'>, </span><span class='String'>"connection to database \"%s\" failed: %s"</span><span class='Delimiter'>, 
</span>                      <a href="../../interfaces/libpq/libpq-fe.h.html#LN310"><span class='Ref_to_Proto'>PQdb</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN252"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Parentheses'>) </span><span class='Operator'>? </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN310"><span class='Ref_to_Proto'>PQdb</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN252"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Parentheses'>) </span><span class='Operator'>: </span><span class='String'>""</span><span class='Delimiter'>, 
</span>                      <a href="../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN252"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We want to remember connection's actual password, whether or not we got 
     * it by prompting.  So we don't just store the password variable. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN327"><span class='Ref_to_Proto'>PQconnectionUsedPassword</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN252"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN252"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN282"><span class='Ref_to_Member'>savedPassword</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN252"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN282"><span class='Ref_to_Member'>savedPassword</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_backup_db.c.html#LN252"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN282"><span class='Ref_to_Member'>savedPassword</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN24"><span class='Ref_to_Proto'>pg_strdup</span></a><span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN312"><span class='Ref_to_Proto'>PQpass</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN252"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* check for version mismatch */ 
</span>    <a href="pg_backup_db.c.html#LN30"><span class='Ref_to_Proto'>_check_database_version</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN252"><span class='Ref_To_Local'>AH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../interfaces/libpq/libpq-fe.h.html#LN362"><span class='Ref_to_Proto'>PQsetNoticeProcessor</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN252"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN32"><span class='Ref_to_Proto'>notice_processor</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* arrange for SIGINT to issue a query cancel on this connection */ 
</span>    <a href="parallel.h.html#LN67"><span class='Ref_to_Proto'>set_archive_cancel_info</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN252"><span class='Ref_To_Local'>AH</span></a><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN252"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ConnectDatabase &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Close the connection to the database and also cancel off the query if we 
 * have one running. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN342"></a><span class='Declare_Function'>DisconnectDatabase</span><span class='Parentheses'>(</span><a href="pg_backup.h.html#LN177"><span class='Ref_to_Struct'>Archive</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AHX</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN344"></a>    <a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Local'>AH</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="pg_backup_db.c.html#LN342"><span class='Ref_to_Parameter'>AHX</span></a><span class='Delimiter'>; 
</span><a name="LN345"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>errbuf</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_backup_db.c.html#LN344"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN344"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN286"><span class='Ref_to_Member'>connCancel</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * If we have an active query, send a cancel before closing, ignoring 
         * any errors.  This is of no use for a normal exit, but might be 
         * helpful during exit_horribly(). 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN318"><span class='Ref_to_Proto'>PQtransactionStatus</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN344"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN103"><span class='Ref_to_EnumConst'>PQTRANS_ACTIVE</span></a><span class='Parentheses'>)</span> 
            <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN304"><span class='Ref_to_Proto'>PQcancel</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN344"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN286"><span class='Ref_to_Member'>connCancel</span></a><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN345"><span class='Ref_To_Local'>errbuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN345"><span class='Ref_To_Local'>errbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Prevent signal handler from sending a cancel after this. 
         */ 
</span>        <a href="parallel.h.html#LN67"><span class='Ref_to_Proto'>set_archive_cancel_info</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN344"><span class='Ref_To_Local'>AH</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../interfaces/libpq/libpq-fe.h.html#LN272"><span class='Ref_to_Proto'>PQfinish</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN344"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_backup_db.c.html#LN344"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end DisconnectDatabase &raquo; </span> 
 
<a href="../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>* 
</span><a name="LN371"></a><span class='Declare_Function'>GetConnection</span><span class='Parentheses'>(</span><a href="pg_backup.h.html#LN177"><span class='Ref_to_Struct'>Archive</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AHX</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN373"></a>    <a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Local'>AH</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="pg_backup_db.c.html#LN371"><span class='Ref_to_Parameter'>AHX</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="pg_backup_db.c.html#LN373"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN379"></a><span class='Declare_Function'>notice_processor</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>message</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="pg_backup_utils.c.html#LN69"><span class='Ref_to_Func'>write_msg</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN379"><span class='Ref_to_Parameter'>message</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* Like exit_horribly(), but with a complaint about a particular query. */ 
</span><span class='Keyword'>static void 
</span><a name="LN386"></a><span class='Declare_Function'>die_on_query_failure</span><span class='Parentheses'>(</span><a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AH</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>modulename</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>query</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="pg_backup_utils.c.html#LN69"><span class='Ref_to_Func'>write_msg</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN386"><span class='Ref_to_Parameter'>modulename</span></a><span class='Delimiter'>, </span><span class='String'>"query failed: %s"</span><span class='Delimiter'>, 
</span>              <a href="../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN386"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="pg_backup_utils.c.html#LN100"><span class='Ref_to_Func'>exit_horribly</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN386"><span class='Ref_to_Parameter'>modulename</span></a><span class='Delimiter'>, </span><span class='String'>"query was: %s\n"</span><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN386"><span class='Ref_to_Parameter'>query</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>void 
</span><a name="LN394"></a><span class='Declare_Function'>ExecuteSqlStatement</span><span class='Parentheses'>(</span><a href="pg_backup.h.html#LN177"><span class='Ref_to_Struct'>Archive</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AHX</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>query</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN396"></a>    <a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Local'>AH</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="pg_backup_db.c.html#LN394"><span class='Ref_to_Parameter'>AHX</span></a><span class='Delimiter'>; 
</span><a name="LN397"></a>    <a href="../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span> 
    <a href="pg_backup_db.c.html#LN397"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN380"><span class='Ref_to_Proto'>PQexec</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN396"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN394"><span class='Ref_to_Parameter'>query</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN397"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN84"><span class='Ref_to_EnumConst'>PGRES_COMMAND_OK</span></a><span class='Parentheses'>)</span> 
        <a href="pg_backup_db.c.html#LN385"><span class='Ref_to_Func'>die_on_query_failure</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN396"><span class='Ref_To_Local'>AH</span></a><span class='Delimiter'>, </span><a href="pg_dump_sort.c.html#LN24"><span class='Ref_to_Global_Var'>modulename</span></a><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN394"><span class='Ref_to_Parameter'>query</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN397"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<a href="../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a> <span class='Operator'>* 
</span><a name="LN406"></a><span class='Declare_Function'>ExecuteSqlQuery</span><span class='Parentheses'>(</span><a href="pg_backup.h.html#LN177"><span class='Ref_to_Struct'>Archive</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AHX</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>query</span><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN81"><span class='Ref_to_Typedef'>ExecStatusType</span></a> <span class='Declare_Parameter'>status</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN408"></a>    <a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Local'>AH</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="pg_backup_db.c.html#LN406"><span class='Ref_to_Parameter'>AHX</span></a><span class='Delimiter'>; 
</span><a name="LN409"></a>    <a href="../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span> 
    <a href="pg_backup_db.c.html#LN409"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN380"><span class='Ref_to_Proto'>PQexec</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN408"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN406"><span class='Ref_to_Parameter'>query</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN409"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="pg_backup_db.c.html#LN406"><span class='Ref_to_Parameter'>status</span></a><span class='Parentheses'>)</span> 
        <a href="pg_backup_db.c.html#LN385"><span class='Ref_to_Func'>die_on_query_failure</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN408"><span class='Ref_To_Local'>AH</span></a><span class='Delimiter'>, </span><a href="pg_dump_sort.c.html#LN24"><span class='Ref_to_Global_Var'>modulename</span></a><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN406"><span class='Ref_to_Parameter'>query</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="pg_backup_db.c.html#LN409"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Execute an SQL query and verify that we got exactly one row back. 
 */ 
</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a> <span class='Operator'>* 
</span><a name="LN421"></a><span class='Declare_Function'>ExecuteSqlQueryForSingleRow</span><span class='Parentheses'>(</span><a href="pg_backup.h.html#LN177"><span class='Ref_to_Struct'>Archive</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fout</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>query</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN423"></a>    <a href="../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span><a name="LN424"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ntups</span><span class='Delimiter'>; 
</span> 
    <a href="pg_backup_db.c.html#LN423"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="pg_backup_db.h.html#LN16"><span class='Ref_to_Proto'>ExecuteSqlQuery</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN421"><span class='Ref_to_Parameter'>fout</span></a><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN421"><span class='Ref_to_Parameter'>query</span></a><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN87"><span class='Ref_to_EnumConst'>PGRES_TUPLES_OK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Expecting a single result only */ 
</span>    <a href="pg_backup_db.c.html#LN424"><span class='Ref_To_Local'>ntups</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN473"><span class='Ref_to_Proto'>PQntuples</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN423"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN424"><span class='Ref_To_Local'>ntups</span></a> <span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <a href="pg_backup_utils.c.html#LN100"><span class='Ref_to_Func'>exit_horribly</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                      <a href="../../include/c.h.html#LN126"><span class='Ref_to_Macro'>ngettext</span></a><span class='Parentheses'>(</span><span class='String'>"query returned %d row instead of one: %s\n"</span><span class='Delimiter'>, 
</span>                               <span class='String'>"query returned %d rows instead of one: %s\n"</span><span class='Delimiter'>, 
</span>                               <a href="pg_backup_db.c.html#LN424"><span class='Ref_To_Local'>ntups</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                      <a href="pg_backup_db.c.html#LN424"><span class='Ref_To_Local'>ntups</span></a><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN421"><span class='Ref_to_Parameter'>query</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="pg_backup_db.c.html#LN423"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Convenience function to send a query. 
 * Monitors result to detect COPY statements 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN445"></a><span class='Declare_Function'>ExecuteSqlCommand</span><span class='Parentheses'>(</span><a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AH</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>qry</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>desc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN447"></a>    <a href="../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>conn</span> <span class='Operator'>= </span><a href="pg_backup_db.c.html#LN445"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Delimiter'>; 
</span><a name="LN448"></a>    <a href="../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> NOT_USED 
    <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"Executing: '%s'\n\n"</span><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN445"><span class='Ref_to_Parameter'>qry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <a href="pg_backup_db.c.html#LN448"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN380"><span class='Ref_to_Proto'>PQexec</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN447"><span class='Ref_To_Local'>conn</span></a><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN445"><span class='Ref_to_Parameter'>qry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN448"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../interfaces/libpq/libpq-fe.h.html#LN84"><span class='Ref_to_EnumConst'>PGRES_COMMAND_OK</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../interfaces/libpq/libpq-fe.h.html#LN87"><span class='Ref_to_EnumConst'>PGRES_TUPLES_OK</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../interfaces/libpq/libpq-fe.h.html#LN83"><span class='Ref_to_EnumConst'>PGRES_EMPTY_QUERY</span></a><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* A-OK */ 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../interfaces/libpq/libpq-fe.h.html#LN91"><span class='Ref_to_EnumConst'>PGRES_COPY_IN</span></a><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* Assume this is an expected result */ 
</span>            <a href="pg_backup_db.c.html#LN445"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN291"><span class='Ref_to_Member'>pgCopyIn</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>default</span><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* trouble */ 
</span>            <a href="pg_backup_archiver.c.html#LN1735"><span class='Ref_to_Func'>warn_or_exit_horribly</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN445"><span class='Ref_to_Parameter'>AH</span></a><span class='Delimiter'>, </span><a href="pg_dump_sort.c.html#LN24"><span class='Ref_to_Global_Var'>modulename</span></a><span class='Delimiter'>, </span><span class='String'>"%s: %s    Command was: %s\n"</span><span class='Delimiter'>, 
</span>                                  <a href="pg_backup_db.c.html#LN445"><span class='Ref_to_Parameter'>desc</span></a><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN447"><span class='Ref_To_Local'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN445"><span class='Ref_to_Parameter'>qry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN448"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ExecuteSqlCommand &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Process non-COPY table data (that is, INSERT commands). 
 * 
 * The commands have been run together as one long string for compressibility, 
 * and we are receiving them in bufferloads with arbitrary boundaries, so we 
 * have to locate command boundaries and save partial commands across calls. 
 * All state must be kept in AH-&GT;sqlparse, not in local variables of this 
 * routine.  We assume that AH-&GT;sqlparse was filled with zeroes when created. 
 * 
 * We have to lex the data to the extent of identifying literals and quoted 
 * identifiers, so that we can recognize statement-terminating semicolons. 
 * We assume that INSERT data will not contain SQL comments, E'' literals, 
 * or dollar-quoted strings, so this is much simpler than a full SQL lexer. 
 * 
 * Note: when restoring from a pre-9.0 dump file, this code is also used to 
 * process BLOB COMMENTS data, which has the same problem of containing 
 * multiple SQL commands that might be split across bufferloads.  Fortunately, 
 * that data won't contain anything complicated to lex either. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN497"></a><span class='Declare_Function'>ExecuteSimpleCommands</span><span class='Parentheses'>(</span><a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AH</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>bufLen</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN499"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>qry</span> <span class='Operator'>= </span><a href="pg_backup_db.c.html#LN497"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>; 
</span><a name="LN500"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>eos</span> <span class='Operator'>= </span><a href="pg_backup_db.c.html#LN497"><span class='Ref_to_Parameter'>buf</span></a> <span class='Operator'>+ </span><a href="pg_backup_db.c.html#LN497"><span class='Ref_to_Parameter'>bufLen</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* initialize command buffer if first time through */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN497"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN229"><span class='Ref_to_Member'>sqlparse</span></a><span class='Operator'>.</span><a href="pg_backup_archiver.h.html#LN187"><span class='Ref_to_Member'>curCmd</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="pg_backup_db.c.html#LN497"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN229"><span class='Ref_to_Member'>sqlparse</span></a><span class='Operator'>.</span><a href="pg_backup_archiver.h.html#LN187"><span class='Ref_to_Member'>curCmd</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/pqexpbuffer.c.html#LN69"><span class='Ref_to_Func'>createPQExpBuffer</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>; </span><a href="pg_backup_db.c.html#LN499"><span class='Ref_To_Local'>qry</span></a> <span class='Operator'>&LT; </span><a href="pg_backup_db.c.html#LN500"><span class='Ref_To_Local'>eos</span></a><span class='Delimiter'>; </span><a href="pg_backup_db.c.html#LN499"><span class='Ref_To_Local'>qry</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN508"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>ch</span> <span class='Operator'>= *</span><a href="pg_backup_db.c.html#LN499"><span class='Ref_To_Local'>qry</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* For neatness, we skip any newlines between commands */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN508"><span class='Ref_To_Local'>ch</span></a> <span class='Operator'>== </span><span class='String'>'\n'</span> <span class='Operator'>&& </span><a href="pg_backup_db.c.html#LN497"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN229"><span class='Ref_to_Member'>sqlparse</span></a><span class='Operator'>.</span><a href="pg_backup_archiver.h.html#LN187"><span class='Ref_to_Member'>curCmd</span></a><span class='Operator'>-&GT;</span><a href="../../interfaces/libpq/pqexpbuffer.h.html#LN46"><span class='Ref_to_Member'>len</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>))</span> 
            <a href="../../interfaces/libpq/pqexpbuffer.h.html#LN171"><span class='Ref_to_Proto'>appendPQExpBufferChar</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN497"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN229"><span class='Ref_to_Member'>sqlparse</span></a><span class='Operator'>.</span><a href="pg_backup_archiver.h.html#LN187"><span class='Ref_to_Member'>curCmd</span></a><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN508"><span class='Ref_To_Local'>ch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN497"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN229"><span class='Ref_to_Member'>sqlparse</span></a><span class='Operator'>.</span><a href="pg_backup_archiver.h.html#LN185"><span class='Ref_to_Member'>state</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <a href="pg_backup_archiver.h.html#LN178"><span class='Ref_to_EnumConst'>SQL_SCAN</span></a><span class='Operator'>:</span>      <span class='Comment_Single_Line'>/* Default state == 0, set in _allocAH */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN508"><span class='Ref_To_Local'>ch</span></a> <span class='Operator'>== </span><span class='String'>';'</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* 
                     * We've found the end of a statement. Send it and reset 
                     * the buffer. 
                     */ 
</span>                    <a href="pg_backup_db.c.html#LN444"><span class='Ref_to_Func'>ExecuteSqlCommand</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN497"><span class='Ref_to_Parameter'>AH</span></a><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN497"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN229"><span class='Ref_to_Member'>sqlparse</span></a><span class='Operator'>.</span><a href="pg_backup_archiver.h.html#LN187"><span class='Ref_to_Member'>curCmd</span></a><span class='Operator'>-&GT;</span><a href="../../interfaces/libpq/pqexpbuffer.h.html#LN45"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, 
</span>                                      <span class='String'>"could not execute query"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../interfaces/libpq/pqexpbuffer.h.html#LN129"><span class='Ref_to_Proto'>resetPQExpBuffer</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN497"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN229"><span class='Ref_to_Member'>sqlparse</span></a><span class='Operator'>.</span><a href="pg_backup_archiver.h.html#LN187"><span class='Ref_to_Member'>curCmd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN508"><span class='Ref_To_Local'>ch</span></a> <span class='Operator'>== </span><span class='String'>'\''</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="pg_backup_db.c.html#LN497"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN229"><span class='Ref_to_Member'>sqlparse</span></a><span class='Operator'>.</span><a href="pg_backup_archiver.h.html#LN185"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>= </span><a href="pg_backup_archiver.h.html#LN179"><span class='Ref_to_EnumConst'>SQL_IN_SINGLE_QUOTE</span></a><span class='Delimiter'>; 
</span>                    <a href="pg_backup_db.c.html#LN497"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN229"><span class='Ref_to_Member'>sqlparse</span></a><span class='Operator'>.</span><a href="pg_backup_archiver.h.html#LN186"><span class='Ref_to_Member'>backSlash</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN508"><span class='Ref_To_Local'>ch</span></a> <span class='Operator'>== </span><span class='String'>'"'</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="pg_backup_db.c.html#LN497"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN229"><span class='Ref_to_Member'>sqlparse</span></a><span class='Operator'>.</span><a href="pg_backup_archiver.h.html#LN185"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>= </span><a href="pg_backup_archiver.h.html#LN180"><span class='Ref_to_EnumConst'>SQL_IN_DOUBLE_QUOTE</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <a href="pg_backup_archiver.h.html#LN179"><span class='Ref_to_EnumConst'>SQL_IN_SINGLE_QUOTE</span></a><span class='Operator'>: 
</span>                <span class='Comment_Multi_Line'>/* We needn't handle '' specially */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN508"><span class='Ref_To_Local'>ch</span></a> <span class='Operator'>== </span><span class='String'>'\''</span> <span class='Operator'>&& !</span><a href="pg_backup_db.c.html#LN497"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN229"><span class='Ref_to_Member'>sqlparse</span></a><span class='Operator'>.</span><a href="pg_backup_archiver.h.html#LN186"><span class='Ref_to_Member'>backSlash</span></a><span class='Parentheses'>) 
</span>                    <a href="pg_backup_db.c.html#LN497"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN229"><span class='Ref_to_Member'>sqlparse</span></a><span class='Operator'>.</span><a href="pg_backup_archiver.h.html#LN185"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>= </span><a href="pg_backup_archiver.h.html#LN178"><span class='Ref_to_EnumConst'>SQL_SCAN</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN508"><span class='Ref_To_Local'>ch</span></a> <span class='Operator'>== </span><span class='String'>'\\'</span> <span class='Operator'>&& !</span><a href="pg_backup_db.c.html#LN497"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><span class='Keyword'>public</span><span class='Operator'>.</span><a href="pg_backup.h.html#LN196"><span class='Ref_to_Member'>std_strings</span></a><span class='Parentheses'>) 
</span>                    <a href="pg_backup_db.c.html#LN497"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN229"><span class='Ref_to_Member'>sqlparse</span></a><span class='Operator'>.</span><a href="pg_backup_archiver.h.html#LN186"><span class='Ref_to_Member'>backSlash</span></a> <span class='Operator'>= !</span><a href="pg_backup_db.c.html#LN497"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN229"><span class='Ref_to_Member'>sqlparse</span></a><span class='Operator'>.</span><a href="pg_backup_archiver.h.html#LN186"><span class='Ref_to_Member'>backSlash</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                    <a href="pg_backup_db.c.html#LN497"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN229"><span class='Ref_to_Member'>sqlparse</span></a><span class='Operator'>.</span><a href="pg_backup_archiver.h.html#LN186"><span class='Ref_to_Member'>backSlash</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <a href="pg_backup_archiver.h.html#LN180"><span class='Ref_to_EnumConst'>SQL_IN_DOUBLE_QUOTE</span></a><span class='Operator'>: 
</span>                <span class='Comment_Multi_Line'>/* We needn't handle "" specially */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN508"><span class='Ref_To_Local'>ch</span></a> <span class='Operator'>== </span><span class='String'>'"'</span><span class='Parentheses'>) 
</span>                    <a href="pg_backup_db.c.html#LN497"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN229"><span class='Ref_to_Member'>sqlparse</span></a><span class='Operator'>.</span><a href="pg_backup_archiver.h.html#LN185"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>= </span><a href="pg_backup_archiver.h.html#LN178"><span class='Ref_to_EnumConst'>SQL_SCAN</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch AH-&GT;sqlparse.state &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;qry&LT;eos;qry++ &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end ExecuteSimpleCommands &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Implement ahwrite() for direct-to-DB restore 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN562"></a><span class='Declare_Function'>ExecuteSqlCommandBuf</span><span class='Parentheses'>(</span><a href="pg_backup.h.html#LN177"><span class='Ref_to_Struct'>Archive</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AHX</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>bufLen</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN564"></a>    <a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Local'>AH</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="pg_backup_db.c.html#LN562"><span class='Ref_to_Parameter'>AHX</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN564"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN290"><span class='Ref_to_Member'>outputKind</span></a> <span class='Operator'>== </span><a href="pg_backup_archiver.h.html#LN201"><span class='Ref_to_EnumConst'>OUTPUT_COPYDATA</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * COPY data. 
         * 
         * We drop the data on the floor if libpq has failed to enter COPY 
         * mode; this allows us to behave reasonably when trying to continue 
         * after an error in a COPY command. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN564"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN291"><span class='Ref_to_Member'>pgCopyIn</span></a> <span class='Operator'>&& 
</span>            <a href="../../interfaces/libpq/libpq-fe.h.html#LN431"><span class='Ref_to_Proto'>PQputCopyData</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN564"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN562"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN562"><span class='Ref_to_Parameter'>bufLen</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="pg_backup_utils.c.html#LN100"><span class='Ref_to_Func'>exit_horribly</span></a><span class='Parentheses'>(</span><a href="pg_dump_sort.c.html#LN24"><span class='Ref_to_Global_Var'>modulename</span></a><span class='Delimiter'>, </span><span class='String'>"error returned by PQputCopyData: %s"</span><span class='Delimiter'>, 
</span>                          <a href="../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN564"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN564"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN290"><span class='Ref_to_Member'>outputKind</span></a> <span class='Operator'>== </span><a href="pg_backup_archiver.h.html#LN202"><span class='Ref_to_EnumConst'>OUTPUT_OTHERDATA</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Table data expressed as INSERT commands; or, in old dump files, 
         * BLOB COMMENTS data (which is expressed as COMMENT ON commands). 
         */ 
</span>        <a href="pg_backup_db.c.html#LN496"><span class='Ref_to_Func'>ExecuteSimpleCommands</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN564"><span class='Ref_To_Local'>AH</span></a><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN562"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN562"><span class='Ref_to_Parameter'>bufLen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * General SQL commands; we assume that commands will not be split 
         * across calls. 
         * 
         * In most cases the data passed to us will be a null-terminated 
         * string, but if it's not, we have to add a trailing null. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN562"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>[</span><a href="pg_backup_db.c.html#LN562"><span class='Ref_to_Parameter'>bufLen</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>            <a href="pg_backup_db.c.html#LN444"><span class='Ref_to_Func'>ExecuteSqlCommand</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN564"><span class='Ref_To_Local'>AH</span></a><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN562"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"could not execute query"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span><a name="LN601"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>str</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN25"><span class='Ref_to_Proto'>pg_malloc</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN562"><span class='Ref_to_Parameter'>bufLen</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            memcpy<span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN601"><span class='Ref_To_Local'>str</span></a><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN562"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN562"><span class='Ref_to_Parameter'>bufLen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pg_backup_db.c.html#LN601"><span class='Ref_To_Local'>str</span></a><span class='Delimiter'>[</span><a href="pg_backup_db.c.html#LN562"><span class='Ref_to_Parameter'>bufLen</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>            <a href="pg_backup_db.c.html#LN444"><span class='Ref_to_Func'>ExecuteSqlCommand</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN564"><span class='Ref_To_Local'>AH</span></a><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN601"><span class='Ref_To_Local'>str</span></a><span class='Delimiter'>, </span><span class='String'>"could not execute query"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN601"><span class='Ref_To_Local'>str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Control'>return</span> <a href="pg_backup_db.c.html#LN562"><span class='Ref_to_Parameter'>bufLen</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ExecuteSqlCommandBuf &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Terminate a COPY operation during direct-to-DB restore 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN617"></a><span class='Declare_Function'>EndDBCopyMode</span><span class='Parentheses'>(</span><a href="pg_backup.h.html#LN177"><span class='Ref_to_Struct'>Archive</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AHX</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>tocEntryTag</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN619"></a>    <a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Local'>AH</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="pg_backup_db.c.html#LN617"><span class='Ref_to_Parameter'>AHX</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN619"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN291"><span class='Ref_to_Member'>pgCopyIn</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN623"></a>        <a href="../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN432"><span class='Ref_to_Proto'>PQputCopyEnd</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN619"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) </span><span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="pg_backup_utils.c.html#LN100"><span class='Ref_to_Func'>exit_horribly</span></a><span class='Parentheses'>(</span><a href="pg_dump_sort.c.html#LN24"><span class='Ref_to_Global_Var'>modulename</span></a><span class='Delimiter'>, </span><span class='String'>"error returned by PQputCopyEnd: %s"</span><span class='Delimiter'>, 
</span>                          <a href="../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN619"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Check command status and return to normal libpq state */ 
</span>        <a href="pg_backup_db.c.html#LN623"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN421"><span class='Ref_to_Proto'>PQgetResult</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN619"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN623"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN84"><span class='Ref_to_EnumConst'>PGRES_COMMAND_OK</span></a><span class='Parentheses'>)</span> 
            <a href="pg_backup_archiver.c.html#LN1735"><span class='Ref_to_Func'>warn_or_exit_horribly</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN619"><span class='Ref_To_Local'>AH</span></a><span class='Delimiter'>, </span><a href="pg_dump_sort.c.html#LN24"><span class='Ref_to_Global_Var'>modulename</span></a><span class='Delimiter'>, </span><span class='String'>"COPY failed for table \"%s\": %s"</span><span class='Delimiter'>, 
</span>                                <a href="pg_backup_db.c.html#LN617"><span class='Ref_to_Parameter'>tocEntryTag</span></a><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN619"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN623"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Do this to ensure we've pumped libpq back to idle state */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN421"><span class='Ref_to_Proto'>PQgetResult</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN619"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
            <a href="pg_backup_utils.c.html#LN69"><span class='Ref_to_Func'>write_msg</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>"WARNING: unexpected extra results during COPY of table \"%s\"\n"</span><span class='Delimiter'>, 
</span>                      <a href="pg_backup_db.c.html#LN617"><span class='Ref_to_Parameter'>tocEntryTag</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="pg_backup_db.c.html#LN619"><span class='Ref_To_Local'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN291"><span class='Ref_to_Member'>pgCopyIn</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if AH-&GT;pgCopyIn &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end EndDBCopyMode &raquo; </span> 
 
<span class='Keyword'>void 
</span><a name="LN646"></a><span class='Declare_Function'>StartTransaction</span><span class='Parentheses'>(</span><a href="pg_backup.h.html#LN177"><span class='Ref_to_Struct'>Archive</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AHX</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN648"></a>    <a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Local'>AH</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="pg_backup_db.c.html#LN646"><span class='Ref_to_Parameter'>AHX</span></a><span class='Delimiter'>; 
</span> 
    <a href="pg_backup_db.c.html#LN444"><span class='Ref_to_Func'>ExecuteSqlCommand</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN648"><span class='Ref_To_Local'>AH</span></a><span class='Delimiter'>, </span><span class='String'>"BEGIN"</span><span class='Delimiter'>, </span><span class='String'>"could not start database transaction"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>void 
</span><a name="LN654"></a><span class='Declare_Function'>CommitTransaction</span><span class='Parentheses'>(</span><a href="pg_backup.h.html#LN177"><span class='Ref_to_Struct'>Archive</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AHX</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN656"></a>    <a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Local'>AH</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="pg_backup_db.c.html#LN654"><span class='Ref_to_Parameter'>AHX</span></a><span class='Delimiter'>; 
</span> 
    <a href="pg_backup_db.c.html#LN444"><span class='Ref_to_Func'>ExecuteSqlCommand</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN656"><span class='Ref_To_Local'>AH</span></a><span class='Delimiter'>, </span><span class='String'>"COMMIT"</span><span class='Delimiter'>, </span><span class='String'>"could not commit database transaction"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>void 
</span><a name="LN662"></a><span class='Declare_Function'>DropBlobIfExists</span><span class='Parentheses'>(</span><a href="pg_backup_archiver.h.html#LN119"><span class='Ref_to_Typedef'>ArchiveHandle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>AH</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>oid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * If we are not restoring to a direct database connection, we have to 
     * guess about how to detect whether the blob exists.  Assume new-style. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN662"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| 
</span>        <a href="../../interfaces/libpq/libpq-fe.h.html#LN322"><span class='Ref_to_Proto'>PQserverVersion</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN662"><span class='Ref_to_Parameter'>AH</span></a><span class='Operator'>-&GT;</span><a href="pg_backup_archiver.h.html#LN284"><span class='Ref_to_Member'>connection</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><span class='Number'>90000</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="pg_backup_archiver.c.html#LN1584"><span class='Ref_to_Func'>ahprintf</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN662"><span class='Ref_to_Parameter'>AH</span></a><span class='Delimiter'>, 
</span>                 <span class='String'>"SELECT pg_catalog.lo_unlink(oid) "</span> 
                 <span class='String'>"FROM pg_catalog.pg_largeobject_metadata "</span> 
                 <span class='String'>"WHERE oid = '%u';\n"</span><span class='Delimiter'>, 
</span>                 <a href="pg_backup_db.c.html#LN662"><span class='Ref_to_Parameter'>oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Restoring to pre-9.0 server, so do it the old way */ 
</span>        <a href="pg_backup_archiver.c.html#LN1584"><span class='Ref_to_Func'>ahprintf</span></a><span class='Parentheses'>(</span><a href="pg_backup_db.c.html#LN662"><span class='Ref_to_Parameter'>AH</span></a><span class='Delimiter'>, 
</span>                 <span class='String'>"SELECT CASE WHEN EXISTS("</span> 
                 <span class='String'>"SELECT 1 FROM pg_catalog.pg_largeobject WHERE loid = '%u'"</span> 
                 <span class='String'>") THEN pg_catalog.lo_unlink('%u') END;\n"</span><span class='Delimiter'>, 
</span>                 <a href="pg_backup_db.c.html#LN662"><span class='Ref_to_Parameter'>oid</span></a><span class='Delimiter'>, </span><a href="pg_backup_db.c.html#LN662"><span class='Ref_to_Parameter'>oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end DropBlobIfExists &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>