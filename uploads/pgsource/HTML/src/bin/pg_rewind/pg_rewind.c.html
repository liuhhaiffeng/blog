<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\bin\pg_rewind\pg_rewind.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\bin\pg_rewind\pg_rewind.c</b></p></td>
<td align='right'>
Wed Jun 14 08:26:01 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * pg_rewind.c 
 *    Synchronizes a PostgreSQL data directory to a new timeline 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres_fe.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/stat.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;fcntl.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;time.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"pg_rewind.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"fetch.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"file_ops.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"filemap.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"logging.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/timeline.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xlog_internal.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/catversion.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_control.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"common/restricted_token.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"getopt_long.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/bufpage.h"</span> 
 
<a name="LN30"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>usage</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>progname</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN32"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>createBackupLabel</span><span class='Parentheses'>(</span><a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>startpoint</span><span class='Delimiter'>, </span><a href="../../include/access/xlogdefs.h.html#LN44"><span class='Ref_to_Typedef'>TimeLineID</span></a> <span class='Declare_Parameter'>starttli</span><span class='Delimiter'>, 
</span><a name="LN33"></a>                  <a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>checkpointloc</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN35"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>digestControlFile</span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_control.h.html#LN102"><span class='Ref_to_Struct'>ControlFileData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>ControlFile</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>source</span><span class='Delimiter'>, 
</span><a name="LN36"></a>                  size_t <span class='Declare_Parameter'>size</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN37"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>updateControlFile</span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_control.h.html#LN102"><span class='Ref_to_Struct'>ControlFileData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>ControlFile</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN38"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>syncTargetDirectory</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>argv0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN39"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>sanityChecks</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN40"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>findCommonAncestorTimeline</span><span class='Parentheses'>(</span><a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>recptr</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>tliIndex</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN42"></a><span class='Keyword'>static </span><a href="../../include/catalog/pg_control.h.html#LN102"><span class='Ref_to_Struct'>ControlFileData</span></a> <span class='Declare_Var'>ControlFile_target</span><span class='Delimiter'>; 
</span><a name="LN43"></a><span class='Keyword'>static </span><a href="../../include/catalog/pg_control.h.html#LN102"><span class='Ref_to_Struct'>ControlFileData</span></a> <span class='Declare_Var'>ControlFile_source</span><span class='Delimiter'>; 
</span> 
<a name="LN45"></a><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Var'>progname</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Configuration options */ 
</span><a name="LN48"></a><span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Var'>datadir_target</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN49"></a><span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Var'>datadir_source</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN50"></a><span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Var'>connstr_source</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<a name="LN52"></a><span class='Keyword'>bool</span>        <span class='Declare_Var'>debug</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN53"></a><span class='Keyword'>bool</span>        <span class='Declare_Var'>showprogress</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN54"></a><span class='Keyword'>bool</span>        <span class='Declare_Var'>dry_run</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Target history */ 
</span><a name="LN57"></a><a href="../../include/access/timeline.h.html#LN24"><span class='Ref_to_Typedef'>TimeLineHistoryEntry</span></a> <span class='Operator'>*</span><span class='Declare_Var'>targetHistory</span><span class='Delimiter'>; 
</span><a name="LN58"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>targetNentries</span><span class='Delimiter'>; 
</span> 
<span class='Keyword'>static void 
</span><a name="LN61"></a><span class='Declare_Function'>usage</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>progname</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"%s resynchronizes a PostgreSQL cluster with another copy of the cluster.\n\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN61"><span class='Ref_to_Parameter'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"Usage:\n  %s [OPTION]...\n\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN61"><span class='Ref_to_Parameter'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"Options:\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -D, --target-pgdata=DIRECTORY  existing data directory to modify\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"      --source-pgdata=DIRECTORY  source data directory to synchronize with\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"      --source-server=CONNSTR    source server to synchronize with\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -n, --dry-run                  stop before modifying anything\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -P, --progress                 write progress messages\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"      --debug                    write a lot of debug messages\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -V, --version                  output version information, then exit\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -?, --help                     show this help, then exit\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"\nReport bugs to &LT;pgsql-bugs@postgresql.org&GT;.\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Keyword'>int 
</span><a name="LN79"></a><span class='Declare_Function'>main</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>argc</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>argv</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN81"></a>    <span class='Keyword'>static </span><span class='Control'>struct</span> <a href="../../include/getopt_long.h.html#LN15"><span class='Ref_to_Struct'>option</span></a> <span class='Declare_Local'>long_options</span><span class='Delimiter'>[] </span><span class='Operator'>= </span><span class='Delimiter'>{ 
</span>        <span class='Delimiter'>{</span><span class='String'>"help"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN23"><span class='Ref_to_Const'>no_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'?'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"target-pgdata"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN24"><span class='Ref_to_Const'>required_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'D'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"source-pgdata"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN24"><span class='Ref_to_Const'>required_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"source-server"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN24"><span class='Ref_to_Const'>required_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"version"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN23"><span class='Ref_to_Const'>no_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'V'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"dry-run"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN23"><span class='Ref_to_Const'>no_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'n'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"progress"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN23"><span class='Ref_to_Const'>no_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'P'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"debug"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN23"><span class='Ref_to_Const'>no_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>} 
</span>    <span class='Delimiter'>}; 
</span><a name="LN92"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>option_index</span><span class='Delimiter'>; 
</span><a name="LN93"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>c</span><span class='Delimiter'>; 
</span><a name="LN94"></a>    <a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>divergerec</span><span class='Delimiter'>; 
</span><a name="LN95"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>lastcommontliIndex</span><span class='Delimiter'>; 
</span><a name="LN96"></a>    <a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>chkptrec</span><span class='Delimiter'>; 
</span><a name="LN97"></a>    <a href="../../include/access/xlogdefs.h.html#LN44"><span class='Ref_to_Typedef'>TimeLineID</span></a>  <span class='Declare_Local'>chkpttli</span><span class='Delimiter'>; 
</span><a name="LN98"></a>    <a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>chkptredo</span><span class='Delimiter'>; 
</span><a name="LN99"></a>    size_t      <span class='Declare_Local'>size</span><span class='Delimiter'>; 
</span><a name="LN100"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span><a name="LN101"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>rewind_needed</span><span class='Delimiter'>; 
</span><a name="LN102"></a>    <a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>endrec</span><span class='Delimiter'>; 
</span><a name="LN103"></a>    <a href="../../include/access/xlogdefs.h.html#LN44"><span class='Ref_to_Typedef'>TimeLineID</span></a>  <span class='Declare_Local'>endtli</span><span class='Delimiter'>; 
</span><a name="LN104"></a>    <a href="../../include/catalog/pg_control.h.html#LN102"><span class='Ref_to_Struct'>ControlFileData</span></a> <span class='Declare_Local'>ControlFile_new</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/port.h.html#LN93"><span class='Ref_to_Proto'>set_pglocale_pgservice</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN79"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], </span><a href="../../include/c.h.html#LN1009"><span class='Ref_to_Macro'>PG_TEXTDOMAIN</span></a><span class='Parentheses'>(</span><span class='String'>"pg_rewind"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN49"><span class='Ref_to_Proto'>get_progname</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN79"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Process command-line arguments */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN79"><span class='Ref_to_Parameter'>argc</span></a> <span class='Operator'>&GT; </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN79"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"--help"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| </span>strcmp<span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN79"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"-?"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../psql/help.h.html#LN10"><span class='Ref_to_Proto'>usage</span></a><span class='Parentheses'>(</span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN79"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"--version"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| </span>strcmp<span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN79"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"-V"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            puts<span class='Parentheses'>(</span><span class='String'>"pg_rewind (PostgreSQL) "</span> PG_VERSION<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="pg_rewind.c.html#LN93"><span class='Ref_To_Local'>c</span></a> <span class='Operator'>= </span><a href="../../include/getopt_long.h.html#LN30"><span class='Ref_to_Proto'>getopt_long</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN79"><span class='Ref_to_Parameter'>argc</span></a><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN79"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>, </span><span class='String'>"D:nP"</span><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN81"><span class='Ref_To_Local'>long_options</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_rewind.c.html#LN92"><span class='Ref_To_Local'>option_index</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN93"><span class='Ref_To_Local'>c</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <span class='String'>'?'</span><span class='Operator'>: 
</span>                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"Try \"%s --help\" for more information.\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <span class='String'>'P'</span><span class='Operator'>: 
</span>                <a href="pg_rewind.c.html#LN53"><span class='Ref_to_Global_Var'>showprogress</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <span class='String'>'n'</span><span class='Operator'>: 
</span>                <a href="../../test/isolation/isolationtester.c.html#LN32"><span class='Ref_to_Global_Var'>dry_run</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <span class='Number'>3</span><span class='Operator'>: 
</span>                <a href="../pg_archivecleanup/pg_archivecleanup.c.html#LN28"><span class='Ref_to_Global_Var'>debug</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <span class='String'>'D'</span><span class='Operator'>:</span>           <span class='Comment_Single_Line'>/* -D or --target-pgdata */ 
</span>                <a href="pg_rewind.c.html#LN48"><span class='Ref_to_Global_Var'>datadir_target</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN24"><span class='Ref_to_Proto'>pg_strdup</span></a><span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <span class='Number'>1</span><span class='Operator'>:</span>             <span class='Comment_Single_Line'>/* --source-pgdata */ 
</span>                <a href="pg_rewind.c.html#LN49"><span class='Ref_to_Global_Var'>datadir_source</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN24"><span class='Ref_to_Proto'>pg_strdup</span></a><span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='Number'>2</span><span class='Operator'>:</span>             <span class='Comment_Single_Line'>/* --source-server */ 
</span>                <a href="pg_rewind.c.html#LN50"><span class='Ref_to_Global_Var'>connstr_source</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN24"><span class='Ref_to_Proto'>pg_strdup</span></a><span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch c &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (c=getopt_long(argc,a... &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN49"><span class='Ref_to_Global_Var'>datadir_source</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="pg_rewind.c.html#LN50"><span class='Ref_to_Global_Var'>connstr_source</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: no source specified (--source-pgdata or --source-server)\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"Try \"%s --help\" for more information.\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN49"><span class='Ref_to_Global_Var'>datadir_source</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="pg_rewind.c.html#LN50"><span class='Ref_to_Global_Var'>connstr_source</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: only one of --source-pgdata or --source-server can be specified\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"Try \"%s --help\" for more information.\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN48"><span class='Ref_to_Global_Var'>datadir_target</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: no target data directory specified (--target-pgdata)\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"Try \"%s --help\" for more information.\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN50"><span class='Ref_to_Global_Var'>optind</span></a> <span class='Operator'>&LT; </span><a href="pg_rewind.c.html#LN79"><span class='Ref_to_Parameter'>argc</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: too many command-line arguments (first is \"%s\")\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN79"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><a href="../../port/getopt.c.html#LN50"><span class='Ref_to_Global_Var'>optind</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"Try \"%s --help\" for more information.\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Don't allow pg_rewind to be run as root, to avoid overwriting the 
     * ownership of files in the data directory. We need only check for root 
     * -- any other user won't have sufficient permissions to modify files in 
     * the data directory. 
     */ 
</span><span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>geteuid<span class='Parentheses'>() </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"cannot be executed by \"root\"\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"You must run %s as the PostgreSQL superuser.\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
    <a href="../../include/common/restricted_token.h.html#LN16"><span class='Ref_to_Proto'>get_restricted_token</span></a><span class='Parentheses'>(</span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Connect to remote server */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN50"><span class='Ref_to_Global_Var'>connstr_source</span></a><span class='Parentheses'>) 
</span>        <a href="fetch.h.html#LN34"><span class='Ref_to_Proto'>libpqConnect</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN50"><span class='Ref_to_Global_Var'>connstr_source</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Ok, we have all the options and we're ready to start. Read in all the 
     * information we need from both clusters. 
     */ 
</span>    <a href="pg_rewind.c.html#LN100"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="file_ops.h.html#LN21"><span class='Ref_to_Proto'>slurpFile</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN48"><span class='Ref_to_Global_Var'>datadir_target</span></a><span class='Delimiter'>, </span><span class='String'>"global/pg_control"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_rewind.c.html#LN99"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_rewind.c.html#LN35"><span class='Ref_to_Proto'>digestControlFile</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_rewind.c.html#LN42"><span class='Ref_to_Global_Var'>ControlFile_target</span></a><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN100"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN99"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/fe_memutils.h.html#LN29"><span class='Ref_to_Proto'>pg_free</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN100"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pg_rewind.c.html#LN100"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="fetch.h.html#LN26"><span class='Ref_to_Proto'>fetchFile</span></a><span class='Parentheses'>(</span><span class='String'>"global/pg_control"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_rewind.c.html#LN99"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_rewind.c.html#LN35"><span class='Ref_to_Proto'>digestControlFile</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_rewind.c.html#LN43"><span class='Ref_to_Global_Var'>ControlFile_source</span></a><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN100"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN99"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/fe_memutils.h.html#LN29"><span class='Ref_to_Proto'>pg_free</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN100"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pg_rewind.c.html#LN39"><span class='Ref_to_Proto'>sanityChecks</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If both clusters are already on the same timeline, there's nothing to 
     * do. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN42"><span class='Ref_to_Global_Var'>ControlFile_target</span></a><span class='Operator'>.</span><a href="../../include/catalog/pg_control.h.html#LN134"><span class='Ref_to_Member'>checkPointCopy</span></a><span class='Operator'>.</span><a href="../../include/catalog/pg_control.h.html#LN36"><span class='Ref_to_Member'>ThisTimeLineID</span></a> <span class='Operator'>== </span><a href="pg_rewind.c.html#LN43"><span class='Ref_to_Global_Var'>ControlFile_source</span></a><span class='Operator'>.</span><a href="../../include/catalog/pg_control.h.html#LN134"><span class='Ref_to_Member'>checkPointCopy</span></a><span class='Operator'>.</span><a href="../../include/catalog/pg_control.h.html#LN36"><span class='Ref_to_Member'>ThisTimeLineID</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"source and target cluster are on the same timeline\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pg_rewind.c.html#LN101"><span class='Ref_To_Local'>rewind_needed</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="pg_rewind.c.html#LN40"><span class='Ref_to_Proto'>findCommonAncestorTimeline</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_rewind.c.html#LN94"><span class='Ref_To_Local'>divergerec</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_rewind.c.html#LN95"><span class='Ref_To_Local'>lastcommontliIndex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"servers diverged at WAL location %X/%X on timeline %u\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>               <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="pg_rewind.c.html#LN94"><span class='Ref_To_Local'>divergerec</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="pg_rewind.c.html#LN94"><span class='Ref_To_Local'>divergerec</span></a><span class='Delimiter'>, 
</span>               <a href="pg_rewind.c.html#LN57"><span class='Ref_to_Global_Var'>targetHistory</span></a><span class='Delimiter'>[</span><a href="pg_rewind.c.html#LN95"><span class='Ref_To_Local'>lastcommontliIndex</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../include/access/timeline.h.html#LN26"><span class='Ref_to_Member'>tli</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Check for the possibility that the target is in fact a direct 
         * ancestor of the source. In that case, there is no divergent history 
         * in the target that needs rewinding. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN42"><span class='Ref_to_Global_Var'>ControlFile_target</span></a><span class='Operator'>.</span><a href="../../include/catalog/pg_control.h.html#LN131"><span class='Ref_to_Member'>checkPoint</span></a> <span class='Operator'>&GT;= </span><a href="pg_rewind.c.html#LN94"><span class='Ref_To_Local'>divergerec</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="pg_rewind.c.html#LN101"><span class='Ref_To_Local'>rewind_needed</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span><a name="LN248"></a>            <a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>chkptendrec</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Read the checkpoint record on the target to see where it ends. */ 
</span>            <a href="pg_rewind.c.html#LN248"><span class='Ref_To_Local'>chkptendrec</span></a> <span class='Operator'>= </span><a href="pg_rewind.h.html#LN38"><span class='Ref_to_Proto'>readOneRecord</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN48"><span class='Ref_to_Global_Var'>datadir_target</span></a><span class='Delimiter'>, 
</span>                                        <a href="pg_rewind.c.html#LN42"><span class='Ref_to_Global_Var'>ControlFile_target</span></a><span class='Operator'>.</span><a href="../../include/catalog/pg_control.h.html#LN131"><span class='Ref_to_Member'>checkPoint</span></a><span class='Delimiter'>, 
</span>                                        <a href="pg_rewind.c.html#LN58"><span class='Ref_to_Global_Var'>targetNentries</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If the histories diverged exactly at the end of the shutdown 
             * checkpoint record on the target, there are no WAL records in 
             * the target that don't belong in the source's history, and no 
             * rewind is needed. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN248"><span class='Ref_To_Local'>chkptendrec</span></a> <span class='Operator'>== </span><a href="pg_rewind.c.html#LN94"><span class='Ref_To_Local'>divergerec</span></a><span class='Parentheses'>) 
</span>                <a href="pg_rewind.c.html#LN101"><span class='Ref_To_Local'>rewind_needed</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="pg_rewind.c.html#LN101"><span class='Ref_To_Local'>rewind_needed</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_rewind.c.html#LN101"><span class='Ref_To_Local'>rewind_needed</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"no rewind required\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="pg_rewind.h.html#LN34"><span class='Ref_to_Proto'>findLastCheckpoint</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN48"><span class='Ref_to_Global_Var'>datadir_target</span></a><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN94"><span class='Ref_To_Local'>divergerec</span></a><span class='Delimiter'>, 
</span>                       <a href="pg_rewind.c.html#LN95"><span class='Ref_To_Local'>lastcommontliIndex</span></a><span class='Delimiter'>, 
</span>                       <span class='Operator'>&</span><a href="pg_rewind.c.html#LN96"><span class='Ref_To_Local'>chkptrec</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_rewind.c.html#LN97"><span class='Ref_To_Local'>chkpttli</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_rewind.c.html#LN98"><span class='Ref_To_Local'>chkptredo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"rewinding from last common checkpoint at %X/%X on timeline %u\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>           <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="pg_rewind.c.html#LN96"><span class='Ref_To_Local'>chkptrec</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="pg_rewind.c.html#LN96"><span class='Ref_To_Local'>chkptrec</span></a><span class='Delimiter'>, 
</span>           <a href="pg_rewind.c.html#LN97"><span class='Ref_To_Local'>chkpttli</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Build the filemap, by comparing the source and target data directories. 
     */ 
</span>    <a href="filemap.c.html#LN36"><span class='Ref_to_Func'>filemap_create</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="logging.c.html#LN67"><span class='Ref_to_Func'>pg_log</span></a><span class='Parentheses'>(</span><a href="logging.h.html#LN24"><span class='Ref_to_EnumConst'>PG_PROGRESS</span></a><span class='Delimiter'>, </span><span class='String'>"reading source file list\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="fetch.h.html#LN25"><span class='Ref_to_Proto'>fetchSourceFileList</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="logging.c.html#LN67"><span class='Ref_to_Func'>pg_log</span></a><span class='Parentheses'>(</span><a href="logging.h.html#LN24"><span class='Ref_to_EnumConst'>PG_PROGRESS</span></a><span class='Delimiter'>, </span><span class='String'>"reading target file list\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="copy_fetch.c.html#LN34"><span class='Ref_to_Func'>traverse_datadir</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN48"><span class='Ref_to_Global_Var'>datadir_target</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="filemap.h.html#LN98"><span class='Ref_to_Proto'>process_target_file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Read the target WAL from last checkpoint before the point of fork, to 
     * extract all the pages that were modified on the target cluster after 
     * the fork. We can stop reading after reaching the final shutdown record. 
     * XXX: If we supported rewinding a server that was not shut down cleanly, 
     * we would need to replay until the end of WAL here. 
     */ 
</span>    <a href="logging.c.html#LN67"><span class='Ref_to_Func'>pg_log</span></a><span class='Parentheses'>(</span><a href="logging.h.html#LN24"><span class='Ref_to_EnumConst'>PG_PROGRESS</span></a><span class='Delimiter'>, </span><span class='String'>"reading WAL in target\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_rewind.h.html#LN32"><span class='Ref_to_Proto'>extractPageMap</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN48"><span class='Ref_to_Global_Var'>datadir_target</span></a><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN96"><span class='Ref_To_Local'>chkptrec</span></a><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN95"><span class='Ref_To_Local'>lastcommontliIndex</span></a><span class='Delimiter'>, 
</span>                   <a href="pg_rewind.c.html#LN42"><span class='Ref_to_Global_Var'>ControlFile_target</span></a><span class='Operator'>.</span><a href="../../include/catalog/pg_control.h.html#LN131"><span class='Ref_to_Member'>checkPoint</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="filemap.h.html#LN102"><span class='Ref_to_Proto'>filemap_finalize</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN53"><span class='Ref_to_Global_Var'>showprogress</span></a><span class='Parentheses'>) 
</span>        <a href="filemap.h.html#LN92"><span class='Ref_to_Proto'>calculate_totals</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* this is too verbose even for verbose mode */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../pg_archivecleanup/pg_archivecleanup.c.html#LN28"><span class='Ref_to_Global_Var'>debug</span></a><span class='Parentheses'>) 
</span>        <a href="filemap.h.html#LN93"><span class='Ref_to_Proto'>print_filemap</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Ok, we're ready to start copying things over. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN53"><span class='Ref_to_Global_Var'>showprogress</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="logging.c.html#LN67"><span class='Ref_to_Func'>pg_log</span></a><span class='Parentheses'>(</span><a href="logging.h.html#LN24"><span class='Ref_to_EnumConst'>PG_PROGRESS</span></a><span class='Delimiter'>, </span><span class='String'>"need to copy %lu MB (total source directory size is %lu MB)\n"</span><span class='Delimiter'>, 
</span>               <span class='Parentheses'>(</span><span class='Keyword'>unsigned long</span><span class='Parentheses'>)</span> <span class='Parentheses'>(</span><a href="filemap.c.html#LN24"><span class='Ref_to_Global_Var'>filemap</span></a><span class='Operator'>-&GT;</span><a href="filemap.h.html#LN86"><span class='Ref_to_Member'>fetch_size</span></a> <span class='Operator'>/ </span><span class='Parentheses'>(</span><span class='Number'>1024</span> <span class='Operator'>* </span><span class='Number'>1024</span><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>               <span class='Parentheses'>(</span><span class='Keyword'>unsigned long</span><span class='Parentheses'>)</span> <span class='Parentheses'>(</span><a href="filemap.c.html#LN24"><span class='Ref_to_Global_Var'>filemap</span></a><span class='Operator'>-&GT;</span><a href="filemap.h.html#LN85"><span class='Ref_to_Member'>total_size</span></a> <span class='Operator'>/ </span><span class='Parentheses'>(</span><span class='Number'>1024</span> <span class='Operator'>* </span><span class='Number'>1024</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="logging.c.html#LN20"><span class='Ref_to_Global_Var'>fetch_size</span></a> <span class='Operator'>= </span><a href="filemap.c.html#LN24"><span class='Ref_to_Global_Var'>filemap</span></a><span class='Operator'>-&GT;</span><a href="filemap.h.html#LN86"><span class='Ref_to_Member'>fetch_size</span></a><span class='Delimiter'>; 
</span>        <a href="logging.c.html#LN21"><span class='Ref_to_Global_Var'>fetch_done</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * This is the point of no return. Once we start copying things, we have 
     * modified the target directory and there is no turning back! 
     */ 
</span> 
    <a href="fetch.h.html#LN27"><span class='Ref_to_Proto'>executeFileMap</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="logging.h.html#LN32"><span class='Ref_to_Proto'>progress_report</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="logging.c.html#LN67"><span class='Ref_to_Func'>pg_log</span></a><span class='Parentheses'>(</span><a href="logging.h.html#LN24"><span class='Ref_to_EnumConst'>PG_PROGRESS</span></a><span class='Delimiter'>, </span><span class='String'>"\ncreating backup label and updating control file\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_rewind.c.html#LN32"><span class='Ref_to_Proto'>createBackupLabel</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN98"><span class='Ref_To_Local'>chkptredo</span></a><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN97"><span class='Ref_To_Local'>chkpttli</span></a><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN96"><span class='Ref_To_Local'>chkptrec</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Update control file of target. Make it ready to perform archive 
     * recovery when restarting. 
     * 
     * minRecoveryPoint is set to the current WAL insert location in the 
     * source server. Like in an online backup, it's important that we recover 
     * all the WAL that was generated while we copied the files over. 
     */ 
</span>    memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_rewind.c.html#LN104"><span class='Ref_To_Local'>ControlFile_new</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_rewind.c.html#LN43"><span class='Ref_to_Global_Var'>ControlFile_source</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_control.h.html#LN102"><span class='Ref_to_Struct'>ControlFileData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN50"><span class='Ref_to_Global_Var'>connstr_source</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pg_rewind.c.html#LN102"><span class='Ref_To_Local'>endrec</span></a> <span class='Operator'>= </span><a href="fetch.h.html#LN35"><span class='Ref_to_Proto'>libpqGetCurrentXlogInsertLocation</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="pg_rewind.c.html#LN103"><span class='Ref_To_Local'>endtli</span></a> <span class='Operator'>= </span><a href="pg_rewind.c.html#LN43"><span class='Ref_to_Global_Var'>ControlFile_source</span></a><span class='Operator'>.</span><a href="../../include/catalog/pg_control.h.html#LN134"><span class='Ref_to_Member'>checkPointCopy</span></a><span class='Operator'>.</span><a href="../../include/catalog/pg_control.h.html#LN36"><span class='Ref_to_Member'>ThisTimeLineID</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="pg_rewind.c.html#LN102"><span class='Ref_To_Local'>endrec</span></a> <span class='Operator'>= </span><a href="pg_rewind.c.html#LN43"><span class='Ref_to_Global_Var'>ControlFile_source</span></a><span class='Operator'>.</span><a href="../../include/catalog/pg_control.h.html#LN131"><span class='Ref_to_Member'>checkPoint</span></a><span class='Delimiter'>; 
</span>        <a href="pg_rewind.c.html#LN103"><span class='Ref_To_Local'>endtli</span></a> <span class='Operator'>= </span><a href="pg_rewind.c.html#LN43"><span class='Ref_to_Global_Var'>ControlFile_source</span></a><span class='Operator'>.</span><a href="../../include/catalog/pg_control.h.html#LN134"><span class='Ref_to_Member'>checkPointCopy</span></a><span class='Operator'>.</span><a href="../../include/catalog/pg_control.h.html#LN36"><span class='Ref_to_Member'>ThisTimeLineID</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="pg_rewind.c.html#LN104"><span class='Ref_To_Local'>ControlFile_new</span></a><span class='Operator'>.</span><a href="../../include/catalog/pg_control.h.html#LN169"><span class='Ref_to_Member'>minRecoveryPoint</span></a> <span class='Operator'>= </span><a href="pg_rewind.c.html#LN102"><span class='Ref_To_Local'>endrec</span></a><span class='Delimiter'>; 
</span>    <a href="pg_rewind.c.html#LN104"><span class='Ref_To_Local'>ControlFile_new</span></a><span class='Operator'>.</span><a href="../../include/catalog/pg_control.h.html#LN170"><span class='Ref_to_Member'>minRecoveryPointTLI</span></a> <span class='Operator'>= </span><a href="pg_rewind.c.html#LN103"><span class='Ref_To_Local'>endtli</span></a><span class='Delimiter'>; 
</span>    <a href="pg_rewind.c.html#LN104"><span class='Ref_To_Local'>ControlFile_new</span></a><span class='Operator'>.</span><a href="../../include/catalog/pg_control.h.html#LN129"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_control.h.html#LN90"><span class='Ref_to_EnumConst'>DB_IN_ARCHIVE_RECOVERY</span></a><span class='Delimiter'>; 
</span>    <a href="pg_rewind.c.html#LN37"><span class='Ref_to_Proto'>updateControlFile</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_rewind.c.html#LN104"><span class='Ref_To_Local'>ControlFile_new</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="logging.c.html#LN67"><span class='Ref_to_Func'>pg_log</span></a><span class='Parentheses'>(</span><a href="logging.h.html#LN24"><span class='Ref_to_EnumConst'>PG_PROGRESS</span></a><span class='Delimiter'>, </span><span class='String'>"syncing target data directory\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_rewind.c.html#LN38"><span class='Ref_to_Proto'>syncTargetDirectory</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN79"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"Done!\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end main &raquo; </span> 
 
<span class='Keyword'>static void 
</span><a name="LN368"></a><span class='Declare_Function'>sanityChecks</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* TODO Check that there's no backup_label in either cluster */ 
</span> 
    <span class='Comment_Multi_Line'>/* Check system_id match */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN42"><span class='Ref_to_Global_Var'>ControlFile_target</span></a><span class='Operator'>.</span><a href="../../include/catalog/pg_control.h.html#LN108"><span class='Ref_to_Member'>system_identifier</span></a> <span class='Operator'>!= </span><a href="pg_rewind.c.html#LN43"><span class='Ref_to_Global_Var'>ControlFile_source</span></a><span class='Operator'>.</span><a href="../../include/catalog/pg_control.h.html#LN108"><span class='Ref_to_Member'>system_identifier</span></a><span class='Parentheses'>) 
</span>        <a href="logging.c.html#LN81"><span class='Ref_to_Func'>pg_fatal</span></a><span class='Parentheses'>(</span><span class='String'>"source and target clusters are from different systems\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* check version */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN42"><span class='Ref_to_Global_Var'>ControlFile_target</span></a><span class='Operator'>.</span><a href="../../include/catalog/pg_control.h.html#LN123"><span class='Ref_to_Member'>pg_control_version</span></a> <span class='Operator'>!= </span><a href="../../include/catalog/pg_control.h.html#LN25"><span class='Ref_to_Const'>PG_CONTROL_VERSION</span></a> <span class='Operator'>|| 
</span>        <a href="pg_rewind.c.html#LN43"><span class='Ref_to_Global_Var'>ControlFile_source</span></a><span class='Operator'>.</span><a href="../../include/catalog/pg_control.h.html#LN123"><span class='Ref_to_Member'>pg_control_version</span></a> <span class='Operator'>!= </span><a href="../../include/catalog/pg_control.h.html#LN25"><span class='Ref_to_Const'>PG_CONTROL_VERSION</span></a> <span class='Operator'>|| 
</span>        <a href="pg_rewind.c.html#LN42"><span class='Ref_to_Global_Var'>ControlFile_target</span></a><span class='Operator'>.</span><a href="../../include/catalog/pg_control.h.html#LN124"><span class='Ref_to_Member'>catalog_version_no</span></a> <span class='Operator'>!= </span><a href="../../include/catalog/catversion.h.html#LN55"><span class='Ref_to_Const'>CATALOG_VERSION_NO</span></a> <span class='Operator'>|| 
</span>        <a href="pg_rewind.c.html#LN43"><span class='Ref_to_Global_Var'>ControlFile_source</span></a><span class='Operator'>.</span><a href="../../include/catalog/pg_control.h.html#LN124"><span class='Ref_to_Member'>catalog_version_no</span></a> <span class='Operator'>!= </span><a href="../../include/catalog/catversion.h.html#LN55"><span class='Ref_to_Const'>CATALOG_VERSION_NO</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="logging.c.html#LN81"><span class='Ref_to_Func'>pg_fatal</span></a><span class='Parentheses'>(</span><span class='String'>"clusters are not compatible with this version of pg_rewind\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Target cluster need to use checksums or hint bit wal-logging, this to 
     * prevent from data corruption that could occur because of hint bits. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN42"><span class='Ref_to_Global_Var'>ControlFile_target</span></a><span class='Operator'>.</span><a href="../../include/catalog/pg_control.h.html#LN224"><span class='Ref_to_Member'>data_checksum_version</span></a> <span class='Operator'>!= </span><a href="../../include/storage/bufpage.h.html#LN196"><span class='Ref_to_Const'>PG_DATA_CHECKSUM_VERSION</span></a> <span class='Operator'>&& 
</span>        <span class='Operator'>!</span><a href="pg_rewind.c.html#LN42"><span class='Ref_to_Global_Var'>ControlFile_target</span></a><span class='Operator'>.</span><a href="../../include/catalog/pg_control.h.html#LN180"><span class='Ref_to_Member'>wal_log_hints</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="logging.c.html#LN81"><span class='Ref_to_Func'>pg_fatal</span></a><span class='Parentheses'>(</span><span class='String'>"target server needs to use either data checksums or \"wal_log_hints = on\"\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Target cluster better not be running. This doesn't guard against 
     * someone starting the cluster concurrently. Also, this is probably more 
     * strict than necessary; it's OK if the target node was not shut down 
     * cleanly, as long as it isn't running at the moment. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN42"><span class='Ref_to_Global_Var'>ControlFile_target</span></a><span class='Operator'>.</span><a href="../../include/catalog/pg_control.h.html#LN129"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>!= </span><a href="../../include/catalog/pg_control.h.html#LN86"><span class='Ref_to_EnumConst'>DB_SHUTDOWNED</span></a> <span class='Operator'>&& 
</span>        <a href="pg_rewind.c.html#LN42"><span class='Ref_to_Global_Var'>ControlFile_target</span></a><span class='Operator'>.</span><a href="../../include/catalog/pg_control.h.html#LN129"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>!= </span><a href="../../include/catalog/pg_control.h.html#LN87"><span class='Ref_to_EnumConst'>DB_SHUTDOWNED_IN_RECOVERY</span></a><span class='Parentheses'>) 
</span>        <a href="logging.c.html#LN81"><span class='Ref_to_Func'>pg_fatal</span></a><span class='Parentheses'>(</span><span class='String'>"target server must be shut down cleanly\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * When the source is a data directory, also require that the source 
     * server is shut down. There isn't any very strong reason for this 
     * limitation, but better safe than sorry. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN49"><span class='Ref_to_Global_Var'>datadir_source</span></a> <span class='Operator'>&& 
</span>        <a href="pg_rewind.c.html#LN43"><span class='Ref_to_Global_Var'>ControlFile_source</span></a><span class='Operator'>.</span><a href="../../include/catalog/pg_control.h.html#LN129"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>!= </span><a href="../../include/catalog/pg_control.h.html#LN86"><span class='Ref_to_EnumConst'>DB_SHUTDOWNED</span></a> <span class='Operator'>&& 
</span>        <a href="pg_rewind.c.html#LN43"><span class='Ref_to_Global_Var'>ControlFile_source</span></a><span class='Operator'>.</span><a href="../../include/catalog/pg_control.h.html#LN129"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>!= </span><a href="../../include/catalog/pg_control.h.html#LN87"><span class='Ref_to_EnumConst'>DB_SHUTDOWNED_IN_RECOVERY</span></a><span class='Parentheses'>) 
</span>        <a href="logging.c.html#LN81"><span class='Ref_to_Func'>pg_fatal</span></a><span class='Parentheses'>(</span><span class='String'>"source data directory must be shut down cleanly\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end sanityChecks &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Find minimum from two WAL locations assuming InvalidXLogRecPtr means 
 * infinity as src/include/access/timeline.h states. This routine should 
 * be used only when comparing WAL locations related to history files. 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> 
<a name="LN422"></a><span class='Declare_Function'>MinXLogRecPtr</span><span class='Parentheses'>(</span><a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>a</span><span class='Delimiter'>, </span><a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>b</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/xlogdefs.h.html#LN28"><span class='Ref_to_Macro'>XLogRecPtrIsInvalid</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN422"><span class='Ref_to_Parameter'>a</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <a href="pg_rewind.c.html#LN422"><span class='Ref_to_Parameter'>b</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/xlogdefs.h.html#LN28"><span class='Ref_to_Macro'>XLogRecPtrIsInvalid</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN422"><span class='Ref_to_Parameter'>b</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <a href="pg_rewind.c.html#LN422"><span class='Ref_to_Parameter'>a</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <span class='Control'>return</span> <a href="../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN422"><span class='Ref_to_Parameter'>a</span></a><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN422"><span class='Ref_to_Parameter'>b</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Retrieve timeline history for given control file which should behold 
 * either source or target. 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/access/timeline.h.html#LN24"><span class='Ref_to_Typedef'>TimeLineHistoryEntry</span></a> <span class='Operator'>* 
</span><a name="LN437"></a><span class='Declare_Function'>getTimelineHistory</span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_control.h.html#LN102"><span class='Ref_to_Struct'>ControlFileData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>controlFile</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>nentries</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN439"></a>    <a href="../../include/access/timeline.h.html#LN24"><span class='Ref_to_Typedef'>TimeLineHistoryEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>history</span><span class='Delimiter'>; 
</span><a name="LN440"></a>    <a href="../../include/access/xlogdefs.h.html#LN44"><span class='Ref_to_Typedef'>TimeLineID</span></a>  <span class='Declare_Local'>tli</span><span class='Delimiter'>; 
</span> 
    <a href="pg_rewind.c.html#LN440"><span class='Ref_To_Local'>tli</span></a> <span class='Operator'>= </span><a href="pg_rewind.c.html#LN437"><span class='Ref_to_Parameter'>controlFile</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/pg_control.h.html#LN134"><span class='Ref_to_Member'>checkPointCopy</span></a><span class='Operator'>.</span><a href="../../include/catalog/pg_control.h.html#LN36"><span class='Ref_to_Member'>ThisTimeLineID</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Timeline 1 does not have a history file, so there is no need to check 
     * and fake an entry with infinite start and end positions. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN440"><span class='Ref_To_Local'>tli</span></a> <span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pg_rewind.c.html#LN439"><span class='Ref_To_Local'>history</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/access/timeline.h.html#LN24"><span class='Ref_to_Typedef'>TimeLineHistoryEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN25"><span class='Ref_to_Proto'>pg_malloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/access/timeline.h.html#LN24"><span class='Ref_to_Typedef'>TimeLineHistoryEntry</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pg_rewind.c.html#LN439"><span class='Ref_To_Local'>history</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/timeline.h.html#LN26"><span class='Ref_to_Member'>tli</span></a> <span class='Operator'>= </span><a href="pg_rewind.c.html#LN440"><span class='Ref_To_Local'>tli</span></a><span class='Delimiter'>; 
</span>        <a href="pg_rewind.c.html#LN439"><span class='Ref_To_Local'>history</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/timeline.h.html#LN27"><span class='Ref_to_Member'>begin</span></a> <span class='Operator'>= </span><a href="pg_rewind.c.html#LN439"><span class='Ref_To_Local'>history</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/timeline.h.html#LN28"><span class='Ref_to_Member'>end</span></a> <span class='Operator'>= </span><a href="../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="pg_rewind.c.html#LN437"><span class='Ref_to_Parameter'>nentries</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span><a name="LN457"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>path</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN458"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>histfile</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/access/xlog_internal.h.html#LN185"><span class='Ref_to_Macro'>TLHistoryFilePath</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN457"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN440"><span class='Ref_To_Local'>tli</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Get history file from appropriate source */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN437"><span class='Ref_to_Parameter'>controlFile</span></a> <span class='Operator'>== &</span><a href="pg_rewind.c.html#LN43"><span class='Ref_to_Global_Var'>ControlFile_source</span></a><span class='Parentheses'>) 
</span>            <a href="pg_rewind.c.html#LN458"><span class='Ref_To_Local'>histfile</span></a> <span class='Operator'>= </span><a href="fetch.h.html#LN26"><span class='Ref_to_Proto'>fetchFile</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN457"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN437"><span class='Ref_to_Parameter'>controlFile</span></a> <span class='Operator'>== &</span><a href="pg_rewind.c.html#LN42"><span class='Ref_to_Global_Var'>ControlFile_target</span></a><span class='Parentheses'>) 
</span>            <a href="pg_rewind.c.html#LN458"><span class='Ref_To_Local'>histfile</span></a> <span class='Operator'>= </span><a href="file_ops.h.html#LN21"><span class='Ref_to_Proto'>slurpFile</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN48"><span class='Ref_to_Global_Var'>datadir_target</span></a><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN457"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="logging.c.html#LN81"><span class='Ref_to_Func'>pg_fatal</span></a><span class='Parentheses'>(</span><span class='String'>"invalid control file"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="pg_rewind.c.html#LN439"><span class='Ref_To_Local'>history</span></a> <span class='Operator'>= </span><a href="timeline.c.html#LN28"><span class='Ref_to_Func'>rewind_parseTimeLineHistory</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN458"><span class='Ref_To_Local'>histfile</span></a><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN440"><span class='Ref_To_Local'>tli</span></a><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN437"><span class='Ref_to_Parameter'>nentries</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/common/fe_memutils.h.html#LN29"><span class='Ref_to_Proto'>pg_free</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN458"><span class='Ref_To_Local'>histfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../pg_archivecleanup/pg_archivecleanup.c.html#LN28"><span class='Ref_to_Global_Var'>debug</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN476"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN437"><span class='Ref_to_Parameter'>controlFile</span></a> <span class='Operator'>== &</span><a href="pg_rewind.c.html#LN43"><span class='Ref_to_Global_Var'>ControlFile_source</span></a><span class='Parentheses'>) 
</span>            <a href="logging.c.html#LN67"><span class='Ref_to_Func'>pg_log</span></a><span class='Parentheses'>(</span><a href="logging.h.html#LN23"><span class='Ref_to_EnumConst'>PG_DEBUG</span></a><span class='Delimiter'>, </span><span class='String'>"Source timeline history:\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN437"><span class='Ref_to_Parameter'>controlFile</span></a> <span class='Operator'>== &</span><a href="pg_rewind.c.html#LN42"><span class='Ref_to_Global_Var'>ControlFile_target</span></a><span class='Parentheses'>) 
</span>            <a href="logging.c.html#LN67"><span class='Ref_to_Func'>pg_log</span></a><span class='Parentheses'>(</span><a href="logging.h.html#LN23"><span class='Ref_to_EnumConst'>PG_DEBUG</span></a><span class='Delimiter'>, </span><span class='String'>"Target timeline history:\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Print the target timeline history. 
         */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN476"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pg_rewind.c.html#LN476"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="pg_rewind.c.html#LN58"><span class='Ref_to_Global_Var'>targetNentries</span></a><span class='Delimiter'>; </span><a href="pg_rewind.c.html#LN476"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN490"></a>            <a href="../../include/access/timeline.h.html#LN24"><span class='Ref_to_Typedef'>TimeLineHistoryEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>entry</span><span class='Delimiter'>; 
</span> 
            <a href="pg_rewind.c.html#LN490"><span class='Ref_To_Local'>entry</span></a> <span class='Operator'>= &</span><a href="pg_rewind.c.html#LN439"><span class='Ref_To_Local'>history</span></a><span class='Delimiter'>[</span><a href="pg_rewind.c.html#LN476"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>            <a href="logging.c.html#LN67"><span class='Ref_to_Func'>pg_log</span></a><span class='Parentheses'>(</span><a href="logging.h.html#LN23"><span class='Ref_to_EnumConst'>PG_DEBUG</span></a><span class='Delimiter'>, 
</span>            <span class='Comment_Multi_Line'>/* translator: %d is a timeline number, others are LSN positions */ 
</span>                   <span class='String'>"%d: %X/%X - %X/%X\n"</span><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN490"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/timeline.h.html#LN26"><span class='Ref_to_Member'>tli</span></a><span class='Delimiter'>, 
</span>                   <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="pg_rewind.c.html#LN490"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/timeline.h.html#LN27"><span class='Ref_to_Member'>begin</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="pg_rewind.c.html#LN490"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/timeline.h.html#LN27"><span class='Ref_to_Member'>begin</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                   <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="pg_rewind.c.html#LN490"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/timeline.h.html#LN28"><span class='Ref_to_Member'>end</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="pg_rewind.c.html#LN490"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/timeline.h.html#LN28"><span class='Ref_to_Member'>end</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if debug &raquo; </span> 
 
    <span class='Control'>return</span> <a href="pg_rewind.c.html#LN439"><span class='Ref_To_Local'>history</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end getTimelineHistory &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Determine the TLI of the last common timeline in the timeline history of the 
 * two clusters. targetHistory is filled with target timeline history and 
 * targetNentries is number of items in targetHistory. *tliIndex is set to the 
 * index of last common timeline in targetHistory array, and *recptr is set to 
 * the position where the timeline history diverged (ie. the first WAL record 
 * that's not the same in both clusters). 
 * 
 * Control files of both clusters must be read into ControlFile_target/source 
 * before calling this routine. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN516"></a><span class='Declare_Function'>findCommonAncestorTimeline</span><span class='Parentheses'>(</span><a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>recptr</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>tliIndex</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN518"></a>    <a href="../../include/access/timeline.h.html#LN24"><span class='Ref_to_Typedef'>TimeLineHistoryEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>sourceHistory</span><span class='Delimiter'>; 
</span><a name="LN519"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>sourceNentries</span><span class='Delimiter'>; 
</span><a name="LN520"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN521"></a>                <span class='Declare_Local'>n</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Retrieve timelines for both source and target */ 
</span>    <a href="pg_rewind.c.html#LN518"><span class='Ref_To_Local'>sourceHistory</span></a> <span class='Operator'>= </span><a href="pg_rewind.c.html#LN436"><span class='Ref_to_Func'>getTimelineHistory</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_rewind.c.html#LN43"><span class='Ref_to_Global_Var'>ControlFile_source</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_rewind.c.html#LN519"><span class='Ref_To_Local'>sourceNentries</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_rewind.c.html#LN57"><span class='Ref_to_Global_Var'>targetHistory</span></a> <span class='Operator'>= </span><a href="pg_rewind.c.html#LN436"><span class='Ref_to_Func'>getTimelineHistory</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_rewind.c.html#LN42"><span class='Ref_to_Global_Var'>ControlFile_target</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_rewind.c.html#LN58"><span class='Ref_to_Global_Var'>targetNentries</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Trace the history forward, until we hit the timeline diverge. It may 
     * still be possible that the source and target nodes used the same 
     * timeline number in their history but with different start position 
     * depending on the history files that each node has fetched in previous 
     * recovery processes. Hence check the start position of the new timeline 
     * as well and move down by one extra timeline entry if they do not match. 
     */ 
</span>    <a href="pg_rewind.c.html#LN521"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= </span><a href="../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN519"><span class='Ref_To_Local'>sourceNentries</span></a><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN58"><span class='Ref_to_Global_Var'>targetNentries</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN520"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pg_rewind.c.html#LN520"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="pg_rewind.c.html#LN521"><span class='Ref_To_Local'>n</span></a><span class='Delimiter'>; </span><a href="pg_rewind.c.html#LN520"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN518"><span class='Ref_To_Local'>sourceHistory</span></a><span class='Delimiter'>[</span><a href="pg_rewind.c.html#LN520"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../include/access/timeline.h.html#LN26"><span class='Ref_to_Member'>tli</span></a> <span class='Operator'>!= </span><a href="pg_rewind.c.html#LN57"><span class='Ref_to_Global_Var'>targetHistory</span></a><span class='Delimiter'>[</span><a href="pg_rewind.c.html#LN520"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../include/access/timeline.h.html#LN26"><span class='Ref_to_Member'>tli</span></a> <span class='Operator'>|| 
</span>            <a href="pg_rewind.c.html#LN518"><span class='Ref_To_Local'>sourceHistory</span></a><span class='Delimiter'>[</span><a href="pg_rewind.c.html#LN520"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../include/access/timeline.h.html#LN27"><span class='Ref_to_Member'>begin</span></a> <span class='Operator'>!= </span><a href="pg_rewind.c.html#LN57"><span class='Ref_to_Global_Var'>targetHistory</span></a><span class='Delimiter'>[</span><a href="pg_rewind.c.html#LN520"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../include/access/timeline.h.html#LN27"><span class='Ref_to_Member'>begin</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN520"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pg_rewind.c.html#LN520"><span class='Ref_To_Local'>i</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="pg_rewind.c.html#LN516"><span class='Ref_to_Parameter'>recptr</span></a> <span class='Operator'>= </span><a href="pg_rewind.c.html#LN421"><span class='Ref_to_Func'>MinXLogRecPtr</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN518"><span class='Ref_To_Local'>sourceHistory</span></a><span class='Delimiter'>[</span><a href="pg_rewind.c.html#LN520"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../include/access/timeline.h.html#LN28"><span class='Ref_to_Member'>end</span></a><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN57"><span class='Ref_to_Global_Var'>targetHistory</span></a><span class='Delimiter'>[</span><a href="pg_rewind.c.html#LN520"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../include/access/timeline.h.html#LN28"><span class='Ref_to_Member'>end</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="pg_rewind.c.html#LN516"><span class='Ref_to_Parameter'>tliIndex</span></a> <span class='Operator'>= </span><a href="pg_rewind.c.html#LN520"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../include/common/fe_memutils.h.html#LN29"><span class='Ref_to_Proto'>pg_free</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN518"><span class='Ref_To_Local'>sourceHistory</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="logging.c.html#LN81"><span class='Ref_to_Func'>pg_fatal</span></a><span class='Parentheses'>(</span><span class='String'>"could not find common ancestor of the source and target cluster's timelines\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end findCommonAncestorTimeline &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Create a backup_label file that forces recovery to begin at the last common 
 * checkpoint. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN564"></a><span class='Declare_Function'>createBackupLabel</span><span class='Parentheses'>(</span><a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>startpoint</span><span class='Delimiter'>, </span><a href="../../include/access/xlogdefs.h.html#LN44"><span class='Ref_to_Typedef'>TimeLineID</span></a> <span class='Declare_Parameter'>starttli</span><span class='Delimiter'>, </span><a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>checkpointloc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN566"></a>    <a href="../../include/access/xlogdefs.h.html#LN33"><span class='Ref_to_Typedef'>XLogSegNo</span></a>   <span class='Declare_Local'>startsegno</span><span class='Delimiter'>; 
</span><a name="LN567"></a>    time_t      <span class='Declare_Local'>stamp_time</span><span class='Delimiter'>; 
</span><a name="LN568"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>strfbuf</span><span class='Delimiter'>[</span><span class='Number'>128</span><span class='Delimiter'>]; 
</span><a name="LN569"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>xlogfilename</span><span class='Delimiter'>[</span><a href="../../include/access/xlog_internal.h.html#LN137"><span class='Ref_to_Const'>MAXFNAMELEN</span></a><span class='Delimiter'>]; 
</span><a name="LN570"></a>    <span class='Control'>struct</span> <a href="../../timezone/localtime.c.html#LN110"><span class='Ref_to_Global_Var'>tm</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>tmp</span><span class='Delimiter'>; 
</span><a name="LN571"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>buf</span><span class='Delimiter'>[</span><span class='Number'>1000</span><span class='Delimiter'>]; 
</span><a name="LN572"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/xlog_internal.h.html#LN105"><span class='Ref_to_Macro'>XLByteToSeg</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN564"><span class='Ref_to_Parameter'>startpoint</span></a><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN566"><span class='Ref_To_Local'>startsegno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/xlog_internal.h.html#LN142"><span class='Ref_to_Macro'>XLogFileName</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN569"><span class='Ref_To_Local'>xlogfilename</span></a><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN564"><span class='Ref_to_Parameter'>starttli</span></a><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN566"><span class='Ref_To_Local'>startsegno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Construct backup label file 
     */ 
</span>    <a href="pg_rewind.c.html#LN567"><span class='Ref_To_Local'>stamp_time</span></a> <span class='Operator'>= </span>time<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_rewind.c.html#LN570"><span class='Ref_To_Local'>tmp</span></a> <span class='Operator'>= </span>localtime<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_rewind.c.html#LN567"><span class='Ref_To_Local'>stamp_time</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../backend/utils/adt/pg_locale.c.html#LN753"><span class='Ref_to_Macro'>strftime</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN568"><span class='Ref_To_Local'>strfbuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN568"><span class='Ref_To_Local'>strfbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%Y-%m-%d %H:%M:%S %Z"</span><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN570"><span class='Ref_To_Local'>tmp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pg_rewind.c.html#LN572"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span><a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN571"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN571"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                   <span class='String'>"START WAL LOCATION: %X/%X (file %s)\n"</span> 
                   <span class='String'>"CHECKPOINT LOCATION: %X/%X\n"</span> 
                   <span class='String'>"BACKUP METHOD: pg_rewind\n"</span> 
                   <span class='String'>"BACKUP FROM: standby\n"</span> 
                   <span class='String'>"START TIME: %s\n"</span><span class='Delimiter'>, 
</span>    <span class='Comment_Multi_Line'>/* omit LABEL: line */ 
</span>              <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="pg_rewind.c.html#LN564"><span class='Ref_to_Parameter'>startpoint</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="pg_rewind.c.html#LN564"><span class='Ref_to_Parameter'>startpoint</span></a><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN569"><span class='Ref_To_Local'>xlogfilename</span></a><span class='Delimiter'>, 
</span>                   <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="pg_rewind.c.html#LN564"><span class='Ref_to_Parameter'>checkpointloc</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="pg_rewind.c.html#LN564"><span class='Ref_to_Parameter'>checkpointloc</span></a><span class='Delimiter'>, 
</span>                   <a href="pg_rewind.c.html#LN568"><span class='Ref_To_Local'>strfbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN572"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>&GT;= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN571"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>))</span> 
        <a href="logging.c.html#LN81"><span class='Ref_to_Func'>pg_fatal</span></a><span class='Parentheses'>(</span><span class='String'>"backup label buffer too small\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* shouldn't happen */ 
</span> 
    <span class='Comment_Multi_Line'>/* TODO: move old file out of the way, if any. */ 
</span>    <a href="file_ops.h.html#LN14"><span class='Ref_to_Proto'>open_target_file</span></a><span class='Parentheses'>(</span><span class='String'>"backup_label"</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* BACKUP_LABEL_FILE */ 
</span>    <a href="file_ops.h.html#LN15"><span class='Ref_to_Proto'>write_target_range</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN571"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN572"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="file_ops.h.html#LN16"><span class='Ref_to_Proto'>close_target_file</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end createBackupLabel &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Check CRC of control file 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN607"></a><span class='Declare_Function'>checkControlFile</span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_control.h.html#LN102"><span class='Ref_to_Struct'>ControlFileData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>ControlFile</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN609"></a>    <a href="../../include/port/pg_crc32c.h.html#LN37"><span class='Ref_to_Typedef'>pg_crc32c</span></a>   <span class='Declare_Local'>crc</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Calculate CRC */ 
</span>    <a href="../../include/port/pg_crc32c.h.html#LN40"><span class='Ref_to_Macro'>INIT_CRC32C</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN609"><span class='Ref_To_Local'>crc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/port/pg_crc32c.h.html#LN45"><span class='Ref_to_Macro'>COMP_CRC32C</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN609"><span class='Ref_To_Local'>crc</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="pg_rewind.c.html#LN607"><span class='Ref_to_Parameter'>ControlFile</span></a><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_control.h.html#LN102"><span class='Ref_to_Struct'>ControlFileData</span></a><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN609"><span class='Ref_To_Local'>crc</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port/pg_crc32c.h.html#LN47"><span class='Ref_to_Macro'>FIN_CRC32C</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN609"><span class='Ref_To_Local'>crc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* And simply compare it */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/port/pg_crc32c.h.html#LN41"><span class='Ref_to_Macro'>EQ_CRC32C</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN609"><span class='Ref_To_Local'>crc</span></a><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN607"><span class='Ref_to_Parameter'>ControlFile</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/pg_control.h.html#LN234"><span class='Ref_to_Member'>crc</span></a><span class='Parentheses'>))</span> 
        <a href="logging.c.html#LN81"><span class='Ref_to_Func'>pg_fatal</span></a><span class='Parentheses'>(</span><span class='String'>"unexpected control file CRC\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Verify control file contents in the buffer src, and copy it to *ControlFile. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN625"></a><span class='Declare_Function'>digestControlFile</span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_control.h.html#LN102"><span class='Ref_to_Struct'>ControlFileData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>ControlFile</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>src</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>size</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN625"><span class='Ref_to_Parameter'>size</span></a> <span class='Operator'>!= </span><a href="../../include/catalog/pg_control.h.html#LN244"><span class='Ref_to_Const'>PG_CONTROL_SIZE</span></a><span class='Parentheses'>) 
</span>        <a href="logging.c.html#LN81"><span class='Ref_to_Func'>pg_fatal</span></a><span class='Parentheses'>(</span><span class='String'>"unexpected control file size %d, expected %d\n"</span><span class='Delimiter'>, 
</span>                 <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="pg_rewind.c.html#LN625"><span class='Ref_to_Parameter'>size</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/pg_control.h.html#LN244"><span class='Ref_to_Const'>PG_CONTROL_SIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    memcpy<span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN625"><span class='Ref_to_Parameter'>ControlFile</span></a><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN625"><span class='Ref_to_Parameter'>src</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_control.h.html#LN102"><span class='Ref_to_Struct'>ControlFileData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Additional checks on control file */ 
</span>    <a href="pg_rewind.c.html#LN606"><span class='Ref_to_Func'>checkControlFile</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN625"><span class='Ref_to_Parameter'>ControlFile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Update the target's control file. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN641"></a><span class='Declare_Function'>updateControlFile</span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_control.h.html#LN102"><span class='Ref_to_Struct'>ControlFileData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>ControlFile</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN643"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>buffer</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_control.h.html#LN244"><span class='Ref_to_Const'>PG_CONTROL_SIZE</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* Recalculate CRC of control file */ 
</span>    <a href="../../include/port/pg_crc32c.h.html#LN40"><span class='Ref_to_Macro'>INIT_CRC32C</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN641"><span class='Ref_to_Parameter'>ControlFile</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/pg_control.h.html#LN234"><span class='Ref_to_Member'>crc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/port/pg_crc32c.h.html#LN45"><span class='Ref_to_Macro'>COMP_CRC32C</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN641"><span class='Ref_to_Parameter'>ControlFile</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/pg_control.h.html#LN234"><span class='Ref_to_Member'>crc</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="pg_rewind.c.html#LN641"><span class='Ref_to_Parameter'>ControlFile</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_control.h.html#LN102"><span class='Ref_to_Struct'>ControlFileData</span></a><span class='Delimiter'>, </span>crc<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port/pg_crc32c.h.html#LN47"><span class='Ref_to_Macro'>FIN_CRC32C</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN641"><span class='Ref_to_Parameter'>ControlFile</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/pg_control.h.html#LN234"><span class='Ref_to_Member'>crc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Write out PG_CONTROL_SIZE bytes into pg_control by zero-padding the 
     * excess over sizeof(ControlFileData) to avoid premature EOF related 
     * errors when reading it. 
     */ 
</span>    memset<span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN643"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="../../include/catalog/pg_control.h.html#LN244"><span class='Ref_to_Const'>PG_CONTROL_SIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN643"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN641"><span class='Ref_to_Parameter'>ControlFile</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_control.h.html#LN102"><span class='Ref_to_Struct'>ControlFileData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="file_ops.h.html#LN14"><span class='Ref_to_Proto'>open_target_file</span></a><span class='Parentheses'>(</span><span class='String'>"global/pg_control"</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="file_ops.h.html#LN15"><span class='Ref_to_Proto'>write_target_range</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN643"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="../../include/catalog/pg_control.h.html#LN244"><span class='Ref_to_Const'>PG_CONTROL_SIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="file_ops.h.html#LN16"><span class='Ref_to_Proto'>close_target_file</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end updateControlFile &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Sync target data directory to ensure that modifications are safely on disk. 
 * 
 * We do this once, for the whole data directory, for performance reasons.  At 
 * the end of pg_rewind's run, the kernel is likely to already have flushed 
 * most dirty buffers to disk. Additionally initdb -S uses a two-pass approach 
 * (only initiating writeback in the first pass), which often reduces the 
 * overall amount of IO noticeably. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN677"></a><span class='Declare_Function'>syncTargetDirectory</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>argv0</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN679"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ret</span><span class='Delimiter'>; 
</span><a name="LN680"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MAXCMDLEN</span> <span class='Parentheses'>(</span><span class='Number'>2</span> <span class='Operator'>* </span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Parentheses'>) 
</span><a name="LN681"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>exec_path</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN682"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>cmd</span><span class='Delimiter'>[</span><a href="pg_rewind.c.html#LN680"><span class='Ref_to_Const'>MAXCMDLEN</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* locate initdb binary */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="pg_rewind.c.html#LN679"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN97"><span class='Ref_to_Proto'>find_other_exec</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN677"><span class='Ref_to_Parameter'>argv0</span></a><span class='Delimiter'>, </span><span class='String'>"initdb"</span><span class='Delimiter'>, 
</span>                               <span class='String'>"initdb (PostgreSQL) "</span> PG_VERSION <span class='String'>"\n"</span><span class='Delimiter'>, 
</span>                               <a href="pg_rewind.c.html#LN681"><span class='Ref_To_Local'>exec_path</span></a><span class='Parentheses'>))</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN689"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>full_path</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port.h.html#LN96"><span class='Ref_to_Proto'>find_my_exec</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN677"><span class='Ref_to_Parameter'>argv0</span></a><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN689"><span class='Ref_To_Local'>full_path</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="../../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN689"><span class='Ref_To_Local'>full_path</span></a><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN689"><span class='Ref_To_Local'>full_path</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN679"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <a href="logging.c.html#LN81"><span class='Ref_to_Func'>pg_fatal</span></a><span class='Parentheses'>(</span><span class='String'>"The program \"initdb\" is needed by %s but was\n"</span> 
                     <span class='String'>"not found in the same directory as \"%s\".\n"</span> 
                     <span class='String'>"Check your installation.\n"</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN689"><span class='Ref_To_Local'>full_path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="logging.c.html#LN81"><span class='Ref_to_Func'>pg_fatal</span></a><span class='Parentheses'>(</span><span class='String'>"The program \"initdb\" was found by \"%s\"\n"</span> 
                     <span class='String'>"but was not the same version as %s.\n"</span> 
                     <span class='String'>"Check your installation.\n"</span><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN689"><span class='Ref_To_Local'>full_path</span></a><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* only skip processing after ensuring presence of initdb */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../test/isolation/isolationtester.c.html#LN32"><span class='Ref_to_Global_Var'>dry_run</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* finally run initdb -S */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../pg_archivecleanup/pg_archivecleanup.c.html#LN28"><span class='Ref_to_Global_Var'>debug</span></a><span class='Parentheses'>) 
</span>        <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN682"><span class='Ref_To_Local'>cmd</span></a><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN680"><span class='Ref_to_Const'>MAXCMDLEN</span></a><span class='Delimiter'>, </span><span class='String'>"\"%s\" -D \"%s\" -S"</span><span class='Delimiter'>, 
</span>                 <a href="pg_rewind.c.html#LN681"><span class='Ref_To_Local'>exec_path</span></a><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN48"><span class='Ref_to_Global_Var'>datadir_target</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN682"><span class='Ref_To_Local'>cmd</span></a><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN680"><span class='Ref_to_Const'>MAXCMDLEN</span></a><span class='Delimiter'>, </span><span class='String'>"\"%s\" -D \"%s\" -S &GT; \"%s\""</span><span class='Delimiter'>, 
</span>                 <a href="pg_rewind.c.html#LN681"><span class='Ref_To_Local'>exec_path</span></a><span class='Delimiter'>, </span><a href="pg_rewind.c.html#LN48"><span class='Ref_to_Global_Var'>datadir_target</span></a><span class='Delimiter'>, </span><a href="../../include/port.h.html#LN113"><span class='Ref_to_Const'>DEVNULL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port.h.html#LN312"><span class='Ref_to_Macro'>system</span></a><span class='Parentheses'>(</span><a href="pg_rewind.c.html#LN682"><span class='Ref_To_Local'>cmd</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="logging.c.html#LN81"><span class='Ref_to_Func'>pg_fatal</span></a><span class='Parentheses'>(</span><span class='String'>"sync of target directory failed\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end syncTargetDirectory &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>