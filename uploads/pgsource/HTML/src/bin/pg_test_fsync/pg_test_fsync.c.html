<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\bin\pg_test_fsync\pg_test_fsync.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\bin\pg_test_fsync\pg_test_fsync.c</b></p></td>
<td align='right'>
Wed Jun 14 08:26:01 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
</span><span class='Comment_Multi_Line'>/* 
 *  pg_test_fsync.c 
 *      tests all supported fsync() methods 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres_fe.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/stat.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/time.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;fcntl.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;time.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;signal.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"getopt_long.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xlogdefs.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * put the temp files in the local directory 
 * unless the user specifies otherwise 
 */ 
</span><a name="LN22"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>FSYNC_FILENAME</span>  <span class='String'>"./pg_test_fsync.out"</span> 
 
<a name="LN24"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>XLOG_BLCKSZ_K</span>   <span class='Parentheses'>(</span>XLOG_BLCKSZ <span class='Operator'>/ </span><span class='Number'>1024</span><span class='Parentheses'>) 
</span> 
<a name="LN26"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>LABEL_FORMAT</span>        <span class='String'>"        %-30s"</span> 
<a name="LN27"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>NA_FORMAT</span>           <span class='String'>"%20s"</span> 
<a name="LN28"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>OPS_FORMAT</span>          <span class='String'>"%13.3f ops/sec  %6.0f usecs/op"</span> 
<a name="LN29"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>USECS_SEC</span>           <span class='Number'>1000000</span> 
 
<span class='Comment_Multi_Line'>/* These are macros to avoid timing the function call overhead. */ 
</span><span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN33"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>START_TIMER</span> <span class='Operator'>\ 
</span><span class='Control'>do</span> <span class='Delimiter'>{ </span><span class='Operator'>\ 
</span>    <a href="pg_test_fsync.c.html#LN70"><span class='Ref_to_Global_Var'>alarm_triggered</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>    alarm<span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN63"><span class='Ref_to_Global_Var'>secs_per_test</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>    <a href="../../port/gettimeofday.c.html#LN103"><span class='Ref_to_Func'>gettimeofday</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_test_fsync.c.html#LN68"><span class='Ref_to_Global_Var'>start_t</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span><span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>) 
</span><span class='Directive'>#else</span> 
<span class='Comment_Multi_Line'>/* WIN32 doesn't support alarm, so we create a thread and sleep there */ 
</span><a name="LN41"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>START_TIMER</span> <span class='Operator'>\ 
</span><span class='Control'>do</span> <span class='Delimiter'>{ </span><span class='Operator'>\ 
</span>    <a href="pg_test_fsync.c.html#LN70"><span class='Ref_to_Global_Var'>alarm_triggered</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>CreateThread<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="pg_test_fsync.c.html#LN83"><span class='Ref_to_Proto'>process_alarm</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) </span><span class='Operator'>== \ 
</span>        INVALID_HANDLE_VALUE<span class='Parentheses'>)</span> <span class='Operator'>\ 
</span>    <span class='Delimiter'>{ </span><span class='Operator'>\ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"Cannot create thread for alarm\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>    <span class='Delimiter'>} </span><span class='Operator'>\ 
</span>    <a href="../../port/gettimeofday.c.html#LN103"><span class='Ref_to_Func'>gettimeofday</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_test_fsync.c.html#LN68"><span class='Ref_to_Global_Var'>start_t</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span><span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>) 
</span><span class='Directive'>#endif</span> 
 
<a name="LN54"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>STOP_TIMER</span>  <span class='Operator'>\ 
</span><span class='Control'>do</span> <span class='Delimiter'>{ </span><span class='Operator'>\ 
</span>    <a href="../../port/gettimeofday.c.html#LN103"><span class='Ref_to_Func'>gettimeofday</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_test_fsync.c.html#LN69"><span class='Ref_to_Global_Var'>stop_t</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>    <a href="pg_test_fsync.c.html#LN92"><span class='Ref_to_Proto'>print_elapse</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN68"><span class='Ref_to_Global_Var'>start_t</span></a><span class='Delimiter'>, </span><a href="pg_test_fsync.c.html#LN69"><span class='Ref_to_Global_Var'>stop_t</span></a><span class='Delimiter'>, </span>ops<span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span><span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>) 
</span> 
 
<a name="LN61"></a><span class='Keyword'>static const char </span><span class='Operator'>*</span><span class='Declare_Var'>progname</span><span class='Delimiter'>; 
</span> 
<a name="LN63"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>secs_per_test</span> <span class='Operator'>= </span><span class='Number'>5</span><span class='Delimiter'>; 
</span><a name="LN64"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>needs_unlink</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN65"></a><span class='Keyword'>static char </span><span class='Declare_Var'>full_buf</span><span class='Delimiter'>[</span>XLOG_SEG_SIZE<span class='Delimiter'>], 
</span><a name="LN66"></a>           <span class='Operator'>*</span><span class='Declare_Var'>buf</span><span class='Delimiter'>, 
</span><a name="LN67"></a>           <span class='Operator'>*</span><span class='Declare_Var'>filename</span> <span class='Operator'>= </span><a href="pg_test_fsync.c.html#LN22"><span class='Ref_to_Const'>FSYNC_FILENAME</span></a><span class='Delimiter'>; 
</span><a name="LN68"></a><span class='Keyword'>static </span><span class='Control'>struct</span> timeval <span class='Declare_Var'>start_t</span><span class='Delimiter'>, 
</span><a name="LN69"></a>            <span class='Declare_Var'>stop_t</span><span class='Delimiter'>; 
</span><a name="LN70"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>alarm_triggered</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
 
<a name="LN73"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>handle_args</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>argc</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>argv</span><span class='Delimiter'>[]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN74"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>prepare_buf</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN75"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>test_open</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN76"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>test_non_sync</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN77"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>test_sync</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>writes_per_op</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN78"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>test_open_syncs</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN79"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>test_open_sync</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>writes_size</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN80"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>test_file_descriptor_sync</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN83"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>process_alarm</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>sig</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
<a name="LN85"></a><span class='Keyword'>static DWORD </span>WINAPI <span class='Declare_Prototype'>process_alarm</span><span class='Parentheses'>(</span>LPVOID <span class='Declare_Parameter'>param</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<a name="LN87"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>signal_cleanup</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>sig</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/port/darwin.h.html#LN5"><span class='Ref_to_Const'>HAVE_FSYNC_WRITETHROUGH</span></a> 
<a name="LN90"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>pg_fsync_writethrough</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>fd</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<a name="LN92"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>print_elapse</span><span class='Parentheses'>(</span><span class='Control'>struct</span> timeval <span class='Declare_Parameter'>start_t</span><span class='Delimiter'>, </span><span class='Control'>struct</span> timeval <span class='Declare_Parameter'>stop_t</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>ops</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN93"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>die</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>str</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Keyword'>int 
</span><a name="LN97"></a><span class='Declare_Function'>main</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>argc</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>argv</span><span class='Delimiter'>[]</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../include/port.h.html#LN93"><span class='Ref_to_Proto'>set_pglocale_pgservice</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN97"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], </span><a href="../../include/c.h.html#LN1009"><span class='Ref_to_Macro'>PG_TEXTDOMAIN</span></a><span class='Parentheses'>(</span><span class='String'>"pg_test_fsync"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN49"><span class='Ref_to_Proto'>get_progname</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN97"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../pg_test_timing/pg_test_timing.c.html#LN15"><span class='Ref_to_Proto'>handle_args</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN97"><span class='Ref_to_Parameter'>argc</span></a><span class='Delimiter'>, </span><a href="pg_test_fsync.c.html#LN97"><span class='Ref_to_Parameter'>argv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Prevent leaving behind the test file */ 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span>SIGINT<span class='Delimiter'>, </span><a href="pg_test_fsync.c.html#LN87"><span class='Ref_to_Proto'>signal_cleanup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span>SIGTERM<span class='Delimiter'>, </span><a href="pg_test_fsync.c.html#LN87"><span class='Ref_to_Proto'>signal_cleanup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN193"><span class='Ref_to_Const'>SIGALRM</span></a><span class='Delimiter'>, </span><a href="pg_test_fsync.c.html#LN83"><span class='Ref_to_Proto'>process_alarm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/port/win32.h.html#LN187"><span class='Ref_to_Const'>SIGHUP</span></a> 
    <span class='Comment_Multi_Line'>/* Not defined on win32 */ 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN187"><span class='Ref_to_Const'>SIGHUP</span></a><span class='Delimiter'>, </span><a href="pg_test_fsync.c.html#LN87"><span class='Ref_to_Proto'>signal_cleanup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <a href="pg_test_fsync.c.html#LN74"><span class='Ref_to_Proto'>prepare_buf</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="pg_test_fsync.c.html#LN75"><span class='Ref_to_Proto'>test_open</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Test using 1 XLOG_BLCKSZ write */ 
</span>    <a href="pg_test_fsync.c.html#LN77"><span class='Ref_to_Proto'>test_sync</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Test using 2 XLOG_BLCKSZ writes */ 
</span>    <a href="pg_test_fsync.c.html#LN77"><span class='Ref_to_Proto'>test_sync</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pg_test_fsync.c.html#LN78"><span class='Ref_to_Proto'>test_open_syncs</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="pg_test_fsync.c.html#LN80"><span class='Ref_to_Proto'>test_file_descriptor_sync</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="pg_test_fsync.c.html#LN76"><span class='Ref_to_Proto'>test_non_sync</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN67"><span class='Ref_to_Global_Var'>filename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end main &raquo; </span> 
 
<span class='Keyword'>static void 
</span><a name="LN137"></a><span class='Declare_Function'>handle_args</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>argc</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>argv</span><span class='Delimiter'>[]</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN139"></a>    <span class='Keyword'>static </span><span class='Control'>struct</span> <a href="pg_test_fsync.c.html#LN145"><span class='Ref_To_Local'>option</span></a> <span class='Declare_Local'>long_options</span><span class='Delimiter'>[] </span><span class='Operator'>= </span><span class='Delimiter'>{ 
</span>        <span class='Delimiter'>{</span><span class='String'>"filename"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN24"><span class='Ref_to_Const'>required_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'f'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"secs-per-test"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN24"><span class='Ref_to_Const'>required_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'s'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>} 
</span>    <span class='Delimiter'>}; 
</span> 
<a name="LN145"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>option</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* Command line option */ 
</span><a name="LN146"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>optindex</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* used by getopt_long */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN137"><span class='Ref_to_Parameter'>argc</span></a> <span class='Operator'>&GT; </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN137"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"--help"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| </span>strcmp<span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN137"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"-?"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"Usage: %s [-f FILENAME] [-s SECS-PER-TEST]\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN137"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"--version"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| </span>strcmp<span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN137"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"-V"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            puts<span class='Parentheses'>(</span><span class='String'>"pg_test_fsync (PostgreSQL) "</span> PG_VERSION<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="pg_test_fsync.c.html#LN145"><span class='Ref_To_Local'>option</span></a> <span class='Operator'>= </span><a href="../../include/getopt_long.h.html#LN30"><span class='Ref_to_Proto'>getopt_long</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN137"><span class='Ref_to_Parameter'>argc</span></a><span class='Delimiter'>, </span><a href="pg_test_fsync.c.html#LN137"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>, </span><span class='String'>"f:s:"</span><span class='Delimiter'>, 
</span>                                 <a href="pg_test_fsync.c.html#LN139"><span class='Ref_To_Local'>long_options</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_test_fsync.c.html#LN146"><span class='Ref_To_Local'>optindex</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN145"><span class='Ref_To_Local'>option</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <span class='String'>'f'</span><span class='Operator'>: 
</span>                <a href="pg_test_fsync.c.html#LN67"><span class='Ref_to_Global_Var'>filename</span></a> <span class='Operator'>= </span>strdup<span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <span class='String'>'s'</span><span class='Operator'>: 
</span>                <a href="pg_test_fsync.c.html#LN63"><span class='Ref_to_Global_Var'>secs_per_test</span></a> <span class='Operator'>= </span>atoi<span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>default</span><span class='Operator'>: 
</span>                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"Try \"%s --help\" for more information.\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (option=getopt_long(a... &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN137"><span class='Ref_to_Parameter'>argc</span></a> <span class='Operator'>&GT; </span><a href="../../port/getopt.c.html#LN50"><span class='Ref_to_Global_Var'>optind</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                _<span class='Parentheses'>(</span><span class='String'>"%s: too many command-line arguments (first is \"%s\")\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_test_fsync.c.html#LN137"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><a href="../../port/getopt.c.html#LN50"><span class='Ref_to_Global_Var'>optind</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"Try \"%s --help\" for more information.\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"%d seconds per test\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="pg_test_fsync.c.html#LN63"><span class='Ref_to_Global_Var'>secs_per_test</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#if</span> <a href="../../include/access/xlogdefs.h.html#LN62"><span class='Ref_to_Const'>PG_O_DIRECT</span></a> <span class='Operator'>!= </span><span class='Number'>0</span> 
    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"O_DIRECT supported on this platform for open_datasync and open_sync.\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"Direct I/O is not supported on this platform.\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end handle_args &raquo; </span> 
 
<span class='Keyword'>static void 
</span><a name="LN202"></a><span class='Declare_Function'>prepare_buf</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN204"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ops</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* write random data into buffer */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN204"><span class='Ref_To_Local'>ops</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pg_test_fsync.c.html#LN204"><span class='Ref_To_Local'>ops</span></a> <span class='Operator'>&LT; </span>XLOG_SEG_SIZE<span class='Delimiter'>; </span><a href="pg_test_fsync.c.html#LN204"><span class='Ref_To_Local'>ops</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="pg_test_fsync.c.html#LN65"><span class='Ref_to_Global_Var'>full_buf</span></a><span class='Delimiter'>[</span><a href="pg_test_fsync.c.html#LN204"><span class='Ref_To_Local'>ops</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../port/random.c.html#LN20"><span class='Ref_to_Func'>random</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="pg_test_fsync.c.html#LN66"><span class='Ref_to_Global_Var'>buf</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/c.h.html#LN580"><span class='Ref_to_Macro'>TYPEALIGN</span></a><span class='Parentheses'>(</span>XLOG_BLCKSZ<span class='Delimiter'>, </span><a href="pg_test_fsync.c.html#LN65"><span class='Ref_to_Global_Var'>full_buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN214"></a><span class='Declare_Function'>test_open</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN216"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>tmpfile</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * test if we can open the target file 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="pg_test_fsync.c.html#LN216"><span class='Ref_To_Local'>tmpfile</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN289"><span class='Ref_to_Macro'>open</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN67"><span class='Ref_to_Global_Var'>filename</span></a><span class='Delimiter'>, </span>O_RDWR <span class='Operator'>| </span>O_CREAT<span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN424"><span class='Ref_to_Const'>S_IRUSR</span></a> <span class='Operator'>| </span><a href="../../include/port/win32.h.html#LN425"><span class='Ref_to_Const'>S_IWUSR</span></a><span class='Parentheses'>))</span> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
        <a href="../../include/tcop/tcopprot.h.html#LN67"><span class='Ref_to_Proto'>die</span></a><span class='Parentheses'>(</span><span class='String'>"could not open output file"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_test_fsync.c.html#LN64"><span class='Ref_to_Global_Var'>needs_unlink</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/win32.h.html#LN13"><span class='Ref_to_Macro'>write</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN216"><span class='Ref_To_Local'>tmpfile</span></a><span class='Delimiter'>, </span><a href="pg_test_fsync.c.html#LN65"><span class='Ref_to_Global_Var'>full_buf</span></a><span class='Delimiter'>, </span>XLOG_SEG_SIZE<span class='Parentheses'>) </span><span class='Operator'>!= </span>XLOG_SEG_SIZE<span class='Parentheses'>)</span> 
        <a href="../../include/tcop/tcopprot.h.html#LN67"><span class='Ref_to_Proto'>die</span></a><span class='Parentheses'>(</span><span class='String'>"write failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* fsync now so that dirty buffers don't skew later tests */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN61"><span class='Ref_to_Macro'>fsync</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN216"><span class='Ref_To_Local'>tmpfile</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../include/tcop/tcopprot.h.html#LN67"><span class='Ref_to_Proto'>die</span></a><span class='Parentheses'>(</span><span class='String'>"fsync failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN216"><span class='Ref_To_Local'>tmpfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end test_open &raquo; </span> 
 
<span class='Keyword'>static void 
</span><a name="LN235"></a><span class='Declare_Function'>test_sync</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>writes_per_op</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN237"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>tmpfile</span><span class='Delimiter'>, 
</span><a name="LN238"></a>                <span class='Declare_Local'>ops</span><span class='Delimiter'>, 
</span><a name="LN239"></a>                <span class='Declare_Local'>writes</span><span class='Delimiter'>; 
</span><a name="LN240"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>fs_warning</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN235"><span class='Ref_to_Parameter'>writes_per_op</span></a> <span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"\nCompare file sync methods using one %dkB write:\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="pg_test_fsync.c.html#LN24"><span class='Ref_to_Const'>XLOG_BLCKSZ_K</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"\nCompare file sync methods using two %dkB writes:\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="pg_test_fsync.c.html#LN24"><span class='Ref_to_Const'>XLOG_BLCKSZ_K</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"(in wal_sync_method preference order, except fdatasync is Linux's default)\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Test open_datasync if available 
     */ 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN26"><span class='Ref_to_Const'>LABEL_FORMAT</span></a><span class='Delimiter'>, </span><span class='String'>"open_datasync"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    fflush<span class='Parentheses'>(</span>stdout<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/access/xlogdefs.h.html#LN83"><span class='Ref_to_Const'>OPEN_DATASYNC_FLAG</span></a> 
    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="pg_test_fsync.c.html#LN237"><span class='Ref_To_Local'>tmpfile</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN289"><span class='Ref_to_Macro'>open</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN67"><span class='Ref_to_Global_Var'>filename</span></a><span class='Delimiter'>, </span>O_RDWR <span class='Operator'>| </span><a href="../../include/port/win32.h.html#LN269"><span class='Ref_to_Const'>O_DSYNC</span></a> <span class='Operator'>| </span><a href="../../include/access/xlogdefs.h.html#LN62"><span class='Ref_to_Const'>PG_O_DIRECT</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>))</span> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN27"><span class='Ref_to_Const'>NA_FORMAT</span></a><span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"n/a*\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pg_test_fsync.c.html#LN240"><span class='Ref_To_Local'>fs_warning</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="pg_test_fsync.c.html#LN33"><span class='Ref_to_Const'>START_TIMER</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN238"><span class='Ref_To_Local'>ops</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pg_test_fsync.c.html#LN70"><span class='Ref_to_Global_Var'>alarm_triggered</span></a> <span class='Operator'>== </span><span class='Boolean'>false</span><span class='Delimiter'>; </span><a href="pg_test_fsync.c.html#LN238"><span class='Ref_To_Local'>ops</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN239"><span class='Ref_To_Local'>writes</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pg_test_fsync.c.html#LN239"><span class='Ref_To_Local'>writes</span></a> <span class='Operator'>&LT; </span><a href="pg_test_fsync.c.html#LN235"><span class='Ref_to_Parameter'>writes_per_op</span></a><span class='Delimiter'>; </span><a href="pg_test_fsync.c.html#LN239"><span class='Ref_To_Local'>writes</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/win32.h.html#LN13"><span class='Ref_to_Macro'>write</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN237"><span class='Ref_To_Local'>tmpfile</span></a><span class='Delimiter'>, </span><a href="pg_test_fsync.c.html#LN66"><span class='Ref_to_Global_Var'>buf</span></a><span class='Delimiter'>, </span>XLOG_BLCKSZ<span class='Parentheses'>) </span><span class='Operator'>!= </span>XLOG_BLCKSZ<span class='Parentheses'>)</span> 
                    <a href="../../include/tcop/tcopprot.h.html#LN67"><span class='Ref_to_Proto'>die</span></a><span class='Parentheses'>(</span><span class='String'>"write failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>lseek<span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN237"><span class='Ref_To_Local'>tmpfile</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span>SEEK_SET<span class='Parentheses'>) </span><span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
                <a href="../../include/tcop/tcopprot.h.html#LN67"><span class='Ref_to_Proto'>die</span></a><span class='Parentheses'>(</span><span class='String'>"seek failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="pg_test_fsync.c.html#LN54"><span class='Ref_to_Const'>STOP_TIMER</span></a><span class='Delimiter'>; 
</span>        <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN237"><span class='Ref_To_Local'>tmpfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#else</span> 
    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN27"><span class='Ref_to_Const'>NA_FORMAT</span></a><span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"n/a\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Test fdatasync if available 
 */ 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN26"><span class='Ref_to_Const'>LABEL_FORMAT</span></a><span class='Delimiter'>, </span><span class='String'>"fdatasync"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    fflush<span class='Parentheses'>(</span>stdout<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> HAVE_FDATASYNC 
    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="pg_test_fsync.c.html#LN237"><span class='Ref_To_Local'>tmpfile</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN289"><span class='Ref_to_Macro'>open</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN67"><span class='Ref_to_Global_Var'>filename</span></a><span class='Delimiter'>, </span>O_RDWR<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>))</span> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
        <a href="../../include/tcop/tcopprot.h.html#LN67"><span class='Ref_to_Proto'>die</span></a><span class='Parentheses'>(</span><span class='String'>"could not open output file"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_test_fsync.c.html#LN33"><span class='Ref_to_Const'>START_TIMER</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN238"><span class='Ref_To_Local'>ops</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pg_test_fsync.c.html#LN70"><span class='Ref_to_Global_Var'>alarm_triggered</span></a> <span class='Operator'>== </span><span class='Boolean'>false</span><span class='Delimiter'>; </span><a href="pg_test_fsync.c.html#LN238"><span class='Ref_To_Local'>ops</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN239"><span class='Ref_To_Local'>writes</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pg_test_fsync.c.html#LN239"><span class='Ref_To_Local'>writes</span></a> <span class='Operator'>&LT; </span><a href="pg_test_fsync.c.html#LN235"><span class='Ref_to_Parameter'>writes_per_op</span></a><span class='Delimiter'>; </span><a href="pg_test_fsync.c.html#LN239"><span class='Ref_To_Local'>writes</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/win32.h.html#LN13"><span class='Ref_to_Macro'>write</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN237"><span class='Ref_To_Local'>tmpfile</span></a><span class='Delimiter'>, </span><a href="pg_test_fsync.c.html#LN66"><span class='Ref_to_Global_Var'>buf</span></a><span class='Delimiter'>, </span>XLOG_BLCKSZ<span class='Parentheses'>) </span><span class='Operator'>!= </span>XLOG_BLCKSZ<span class='Parentheses'>)</span> 
                <a href="../../include/tcop/tcopprot.h.html#LN67"><span class='Ref_to_Proto'>die</span></a><span class='Parentheses'>(</span><span class='String'>"write failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/c.h.html#LN1093"><span class='Ref_to_Proto'>fdatasync</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN237"><span class='Ref_To_Local'>tmpfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>lseek<span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN237"><span class='Ref_To_Local'>tmpfile</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span>SEEK_SET<span class='Parentheses'>) </span><span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
            <a href="../../include/tcop/tcopprot.h.html#LN67"><span class='Ref_to_Proto'>die</span></a><span class='Parentheses'>(</span><span class='String'>"seek failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="pg_test_fsync.c.html#LN54"><span class='Ref_to_Const'>STOP_TIMER</span></a><span class='Delimiter'>; 
</span>    <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN237"><span class='Ref_To_Local'>tmpfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN27"><span class='Ref_to_Const'>NA_FORMAT</span></a><span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"n/a\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Test fsync 
 */ 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN26"><span class='Ref_to_Const'>LABEL_FORMAT</span></a><span class='Delimiter'>, </span><span class='String'>"fsync"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    fflush<span class='Parentheses'>(</span>stdout<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="pg_test_fsync.c.html#LN237"><span class='Ref_To_Local'>tmpfile</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN289"><span class='Ref_to_Macro'>open</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN67"><span class='Ref_to_Global_Var'>filename</span></a><span class='Delimiter'>, </span>O_RDWR<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>))</span> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
        <a href="../../include/tcop/tcopprot.h.html#LN67"><span class='Ref_to_Proto'>die</span></a><span class='Parentheses'>(</span><span class='String'>"could not open output file"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_test_fsync.c.html#LN33"><span class='Ref_to_Const'>START_TIMER</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN238"><span class='Ref_To_Local'>ops</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pg_test_fsync.c.html#LN70"><span class='Ref_to_Global_Var'>alarm_triggered</span></a> <span class='Operator'>== </span><span class='Boolean'>false</span><span class='Delimiter'>; </span><a href="pg_test_fsync.c.html#LN238"><span class='Ref_To_Local'>ops</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN239"><span class='Ref_To_Local'>writes</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pg_test_fsync.c.html#LN239"><span class='Ref_To_Local'>writes</span></a> <span class='Operator'>&LT; </span><a href="pg_test_fsync.c.html#LN235"><span class='Ref_to_Parameter'>writes_per_op</span></a><span class='Delimiter'>; </span><a href="pg_test_fsync.c.html#LN239"><span class='Ref_To_Local'>writes</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/win32.h.html#LN13"><span class='Ref_to_Macro'>write</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN237"><span class='Ref_To_Local'>tmpfile</span></a><span class='Delimiter'>, </span><a href="pg_test_fsync.c.html#LN66"><span class='Ref_to_Global_Var'>buf</span></a><span class='Delimiter'>, </span>XLOG_BLCKSZ<span class='Parentheses'>) </span><span class='Operator'>!= </span>XLOG_BLCKSZ<span class='Parentheses'>)</span> 
                <a href="../../include/tcop/tcopprot.h.html#LN67"><span class='Ref_to_Proto'>die</span></a><span class='Parentheses'>(</span><span class='String'>"write failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN61"><span class='Ref_to_Macro'>fsync</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN237"><span class='Ref_To_Local'>tmpfile</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="../../include/tcop/tcopprot.h.html#LN67"><span class='Ref_to_Proto'>die</span></a><span class='Parentheses'>(</span><span class='String'>"fsync failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>lseek<span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN237"><span class='Ref_To_Local'>tmpfile</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span>SEEK_SET<span class='Parentheses'>) </span><span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
            <a href="../../include/tcop/tcopprot.h.html#LN67"><span class='Ref_to_Proto'>die</span></a><span class='Parentheses'>(</span><span class='String'>"seek failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="pg_test_fsync.c.html#LN54"><span class='Ref_to_Const'>STOP_TIMER</span></a><span class='Delimiter'>; 
</span>    <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN237"><span class='Ref_To_Local'>tmpfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * If fsync_writethrough is available, test as well 
 */ 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN26"><span class='Ref_to_Const'>LABEL_FORMAT</span></a><span class='Delimiter'>, </span><span class='String'>"fsync_writethrough"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    fflush<span class='Parentheses'>(</span>stdout<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/port/darwin.h.html#LN5"><span class='Ref_to_Const'>HAVE_FSYNC_WRITETHROUGH</span></a> 
    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="pg_test_fsync.c.html#LN237"><span class='Ref_To_Local'>tmpfile</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN289"><span class='Ref_to_Macro'>open</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN67"><span class='Ref_to_Global_Var'>filename</span></a><span class='Delimiter'>, </span>O_RDWR<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>))</span> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
        <a href="../../include/tcop/tcopprot.h.html#LN67"><span class='Ref_to_Proto'>die</span></a><span class='Parentheses'>(</span><span class='String'>"could not open output file"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_test_fsync.c.html#LN33"><span class='Ref_to_Const'>START_TIMER</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN238"><span class='Ref_To_Local'>ops</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pg_test_fsync.c.html#LN70"><span class='Ref_to_Global_Var'>alarm_triggered</span></a> <span class='Operator'>== </span><span class='Boolean'>false</span><span class='Delimiter'>; </span><a href="pg_test_fsync.c.html#LN238"><span class='Ref_To_Local'>ops</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN239"><span class='Ref_To_Local'>writes</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pg_test_fsync.c.html#LN239"><span class='Ref_To_Local'>writes</span></a> <span class='Operator'>&LT; </span><a href="pg_test_fsync.c.html#LN235"><span class='Ref_to_Parameter'>writes_per_op</span></a><span class='Delimiter'>; </span><a href="pg_test_fsync.c.html#LN239"><span class='Ref_To_Local'>writes</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/win32.h.html#LN13"><span class='Ref_to_Macro'>write</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN237"><span class='Ref_To_Local'>tmpfile</span></a><span class='Delimiter'>, </span><a href="pg_test_fsync.c.html#LN66"><span class='Ref_to_Global_Var'>buf</span></a><span class='Delimiter'>, </span>XLOG_BLCKSZ<span class='Parentheses'>) </span><span class='Operator'>!= </span>XLOG_BLCKSZ<span class='Parentheses'>)</span> 
                <a href="../../include/tcop/tcopprot.h.html#LN67"><span class='Ref_to_Proto'>die</span></a><span class='Parentheses'>(</span><span class='String'>"write failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN90"><span class='Ref_to_Proto'>pg_fsync_writethrough</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN237"><span class='Ref_To_Local'>tmpfile</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="../../include/tcop/tcopprot.h.html#LN67"><span class='Ref_to_Proto'>die</span></a><span class='Parentheses'>(</span><span class='String'>"fsync failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>lseek<span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN237"><span class='Ref_To_Local'>tmpfile</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span>SEEK_SET<span class='Parentheses'>) </span><span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
            <a href="../../include/tcop/tcopprot.h.html#LN67"><span class='Ref_to_Proto'>die</span></a><span class='Parentheses'>(</span><span class='String'>"seek failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="pg_test_fsync.c.html#LN54"><span class='Ref_to_Const'>STOP_TIMER</span></a><span class='Delimiter'>; 
</span>    <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN237"><span class='Ref_To_Local'>tmpfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN27"><span class='Ref_to_Const'>NA_FORMAT</span></a><span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"n/a\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Test open_sync if available 
 */ 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN26"><span class='Ref_to_Const'>LABEL_FORMAT</span></a><span class='Delimiter'>, </span><span class='String'>"open_sync"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    fflush<span class='Parentheses'>(</span>stdout<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/access/xlogdefs.h.html#LN74"><span class='Ref_to_Const'>OPEN_SYNC_FLAG</span></a> 
    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="pg_test_fsync.c.html#LN237"><span class='Ref_To_Local'>tmpfile</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN289"><span class='Ref_to_Macro'>open</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN67"><span class='Ref_to_Global_Var'>filename</span></a><span class='Delimiter'>, </span>O_RDWR <span class='Operator'>| </span><a href="../../include/access/xlogdefs.h.html#LN74"><span class='Ref_to_Const'>OPEN_SYNC_FLAG</span></a> <span class='Operator'>| </span><a href="../../include/access/xlogdefs.h.html#LN62"><span class='Ref_to_Const'>PG_O_DIRECT</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>))</span> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN27"><span class='Ref_to_Const'>NA_FORMAT</span></a><span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"n/a*\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pg_test_fsync.c.html#LN240"><span class='Ref_To_Local'>fs_warning</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="pg_test_fsync.c.html#LN33"><span class='Ref_to_Const'>START_TIMER</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN238"><span class='Ref_To_Local'>ops</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pg_test_fsync.c.html#LN70"><span class='Ref_to_Global_Var'>alarm_triggered</span></a> <span class='Operator'>== </span><span class='Boolean'>false</span><span class='Delimiter'>; </span><a href="pg_test_fsync.c.html#LN238"><span class='Ref_To_Local'>ops</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN239"><span class='Ref_To_Local'>writes</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pg_test_fsync.c.html#LN239"><span class='Ref_To_Local'>writes</span></a> <span class='Operator'>&LT; </span><a href="pg_test_fsync.c.html#LN235"><span class='Ref_to_Parameter'>writes_per_op</span></a><span class='Delimiter'>; </span><a href="pg_test_fsync.c.html#LN239"><span class='Ref_To_Local'>writes</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/win32.h.html#LN13"><span class='Ref_to_Macro'>write</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN237"><span class='Ref_To_Local'>tmpfile</span></a><span class='Delimiter'>, </span><a href="pg_test_fsync.c.html#LN66"><span class='Ref_to_Global_Var'>buf</span></a><span class='Delimiter'>, </span>XLOG_BLCKSZ<span class='Parentheses'>) </span><span class='Operator'>!= </span>XLOG_BLCKSZ<span class='Parentheses'>)</span> 
 
                    <span class='Comment_Multi_Line'>/* 
                     * This can generate write failures if the filesystem has 
                     * a large block size, e.g. 4k, and there is no support 
                     * for O_DIRECT writes smaller than the file system block 
                     * size, e.g. XFS. 
                     */ 
</span>                    <a href="../../include/tcop/tcopprot.h.html#LN67"><span class='Ref_to_Proto'>die</span></a><span class='Parentheses'>(</span><span class='String'>"write failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>lseek<span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN237"><span class='Ref_To_Local'>tmpfile</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span>SEEK_SET<span class='Parentheses'>) </span><span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
                <a href="../../include/tcop/tcopprot.h.html#LN67"><span class='Ref_to_Proto'>die</span></a><span class='Parentheses'>(</span><span class='String'>"seek failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="pg_test_fsync.c.html#LN54"><span class='Ref_to_Const'>STOP_TIMER</span></a><span class='Delimiter'>; 
</span>        <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN237"><span class='Ref_To_Local'>tmpfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
<span class='Directive'>#else</span> 
    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN27"><span class='Ref_to_Const'>NA_FORMAT</span></a><span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"n/a\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN240"><span class='Ref_To_Local'>fs_warning</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"* This file system and its mount options do not support direct\n"</span> 
                 <span class='String'>"  I/O, e.g. ext4 in journaled mode.\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end test_sync &raquo; </span> 
 
<span class='Keyword'>static void 
</span><a name="LN396"></a><span class='Declare_Function'>test_open_syncs</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"\nCompare open_sync with different write sizes:\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"(This is designed to compare the cost of writing 16kB in different write\n"</span> 
             <span class='String'>"open_sync sizes.)\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="pg_test_fsync.c.html#LN79"><span class='Ref_to_Proto'>test_open_sync</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>" 1 * 16kB open_sync write"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>16</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_test_fsync.c.html#LN79"><span class='Ref_to_Proto'>test_open_sync</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>" 2 *  8kB open_sync writes"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>8</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_test_fsync.c.html#LN79"><span class='Ref_to_Proto'>test_open_sync</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>" 4 *  4kB open_sync writes"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_test_fsync.c.html#LN79"><span class='Ref_to_Proto'>test_open_sync</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>" 8 *  2kB open_sync writes"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_test_fsync.c.html#LN79"><span class='Ref_to_Proto'>test_open_sync</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"16 *  1kB open_sync writes"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Test open_sync with different size files 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN413"></a><span class='Declare_Function'>test_open_sync</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>writes_size</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/access/xlogdefs.h.html#LN74"><span class='Ref_to_Const'>OPEN_SYNC_FLAG</span></a> 
<a name="LN416"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>tmpfile</span><span class='Delimiter'>, 
</span><a name="LN417"></a>                <span class='Declare_Local'>ops</span><span class='Delimiter'>, 
</span><a name="LN418"></a>                <span class='Declare_Local'>writes</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN26"><span class='Ref_to_Const'>LABEL_FORMAT</span></a><span class='Delimiter'>, </span><a href="pg_test_fsync.c.html#LN413"><span class='Ref_to_Parameter'>msg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    fflush<span class='Parentheses'>(</span>stdout<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/access/xlogdefs.h.html#LN74"><span class='Ref_to_Const'>OPEN_SYNC_FLAG</span></a> 
    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="pg_test_fsync.c.html#LN416"><span class='Ref_To_Local'>tmpfile</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN289"><span class='Ref_to_Macro'>open</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN67"><span class='Ref_to_Global_Var'>filename</span></a><span class='Delimiter'>, </span>O_RDWR <span class='Operator'>| </span><a href="../../include/access/xlogdefs.h.html#LN74"><span class='Ref_to_Const'>OPEN_SYNC_FLAG</span></a> <span class='Operator'>| </span><a href="../../include/access/xlogdefs.h.html#LN62"><span class='Ref_to_Const'>PG_O_DIRECT</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>))</span> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
        <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN27"><span class='Ref_to_Const'>NA_FORMAT</span></a><span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"n/a*\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="pg_test_fsync.c.html#LN33"><span class='Ref_to_Const'>START_TIMER</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN417"><span class='Ref_To_Local'>ops</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pg_test_fsync.c.html#LN70"><span class='Ref_to_Global_Var'>alarm_triggered</span></a> <span class='Operator'>== </span><span class='Boolean'>false</span><span class='Delimiter'>; </span><a href="pg_test_fsync.c.html#LN417"><span class='Ref_To_Local'>ops</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN418"><span class='Ref_To_Local'>writes</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pg_test_fsync.c.html#LN418"><span class='Ref_To_Local'>writes</span></a> <span class='Operator'>&LT; </span><span class='Number'>16</span> <span class='Operator'>/ </span><a href="pg_test_fsync.c.html#LN413"><span class='Ref_to_Parameter'>writes_size</span></a><span class='Delimiter'>; </span><a href="pg_test_fsync.c.html#LN418"><span class='Ref_To_Local'>writes</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/win32.h.html#LN13"><span class='Ref_to_Macro'>write</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN416"><span class='Ref_To_Local'>tmpfile</span></a><span class='Delimiter'>, </span><a href="pg_test_fsync.c.html#LN66"><span class='Ref_to_Global_Var'>buf</span></a><span class='Delimiter'>, </span><a href="pg_test_fsync.c.html#LN413"><span class='Ref_to_Parameter'>writes_size</span></a> <span class='Operator'>* </span><span class='Number'>1024</span><span class='Parentheses'>) </span><span class='Operator'>!= 
</span>                    <a href="pg_test_fsync.c.html#LN413"><span class='Ref_to_Parameter'>writes_size</span></a> <span class='Operator'>* </span><span class='Number'>1024</span><span class='Parentheses'>)</span> 
                    <a href="../../include/tcop/tcopprot.h.html#LN67"><span class='Ref_to_Proto'>die</span></a><span class='Parentheses'>(</span><span class='String'>"write failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>lseek<span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN416"><span class='Ref_To_Local'>tmpfile</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span>SEEK_SET<span class='Parentheses'>) </span><span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
                <a href="../../include/tcop/tcopprot.h.html#LN67"><span class='Ref_to_Proto'>die</span></a><span class='Parentheses'>(</span><span class='String'>"seek failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="pg_test_fsync.c.html#LN54"><span class='Ref_to_Const'>STOP_TIMER</span></a><span class='Delimiter'>; 
</span>        <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN416"><span class='Ref_To_Local'>tmpfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#else</span> 
    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN27"><span class='Ref_to_Const'>NA_FORMAT</span></a><span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"n/a\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end test_open_sync &raquo; </span> 
 
<span class='Keyword'>static void 
</span><a name="LN448"></a><span class='Declare_Function'>test_file_descriptor_sync</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN450"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>tmpfile</span><span class='Delimiter'>, 
</span><a name="LN451"></a>                <span class='Declare_Local'>ops</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Test whether fsync can sync data written on a different descriptor for 
     * the same file.  This checks the efficiency of multi-process fsyncs 
     * against the same file. Possibly this should be done with writethrough 
     * on platforms which support it. 
     */ 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"\nTest if fsync on non-write file descriptor is honored:\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"(If the times are similar, fsync() can sync data written on a different\n"</span> 
             <span class='String'>"descriptor.)\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * first write, fsync and close, which is the normal behavior without 
     * multiple descriptors 
     */ 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN26"><span class='Ref_to_Const'>LABEL_FORMAT</span></a><span class='Delimiter'>, </span><span class='String'>"write, fsync, close"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    fflush<span class='Parentheses'>(</span>stdout<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pg_test_fsync.c.html#LN33"><span class='Ref_to_Const'>START_TIMER</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN451"><span class='Ref_To_Local'>ops</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pg_test_fsync.c.html#LN70"><span class='Ref_to_Global_Var'>alarm_triggered</span></a> <span class='Operator'>== </span><span class='Boolean'>false</span><span class='Delimiter'>; </span><a href="pg_test_fsync.c.html#LN451"><span class='Ref_To_Local'>ops</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="pg_test_fsync.c.html#LN450"><span class='Ref_To_Local'>tmpfile</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN289"><span class='Ref_to_Macro'>open</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN67"><span class='Ref_to_Global_Var'>filename</span></a><span class='Delimiter'>, </span>O_RDWR<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>))</span> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
            <a href="../../include/tcop/tcopprot.h.html#LN67"><span class='Ref_to_Proto'>die</span></a><span class='Parentheses'>(</span><span class='String'>"could not open output file"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/win32.h.html#LN13"><span class='Ref_to_Macro'>write</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN450"><span class='Ref_To_Local'>tmpfile</span></a><span class='Delimiter'>, </span><a href="pg_test_fsync.c.html#LN66"><span class='Ref_to_Global_Var'>buf</span></a><span class='Delimiter'>, </span>XLOG_BLCKSZ<span class='Parentheses'>) </span><span class='Operator'>!= </span>XLOG_BLCKSZ<span class='Parentheses'>)</span> 
            <a href="../../include/tcop/tcopprot.h.html#LN67"><span class='Ref_to_Proto'>die</span></a><span class='Parentheses'>(</span><span class='String'>"write failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN61"><span class='Ref_to_Macro'>fsync</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN450"><span class='Ref_To_Local'>tmpfile</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="../../include/tcop/tcopprot.h.html#LN67"><span class='Ref_to_Proto'>die</span></a><span class='Parentheses'>(</span><span class='String'>"fsync failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN450"><span class='Ref_To_Local'>tmpfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * open and close the file again to be consistent with the following 
         * test 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="pg_test_fsync.c.html#LN450"><span class='Ref_To_Local'>tmpfile</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN289"><span class='Ref_to_Macro'>open</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN67"><span class='Ref_to_Global_Var'>filename</span></a><span class='Delimiter'>, </span>O_RDWR<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>))</span> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
            <a href="../../include/tcop/tcopprot.h.html#LN67"><span class='Ref_to_Proto'>die</span></a><span class='Parentheses'>(</span><span class='String'>"could not open output file"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN450"><span class='Ref_To_Local'>tmpfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="pg_test_fsync.c.html#LN54"><span class='Ref_to_Const'>STOP_TIMER</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now open, write, close, open again and fsync This simulates processes 
     * fsyncing each other's writes. 
     */ 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN26"><span class='Ref_to_Const'>LABEL_FORMAT</span></a><span class='Delimiter'>, </span><span class='String'>"write, close, fsync"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    fflush<span class='Parentheses'>(</span>stdout<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pg_test_fsync.c.html#LN33"><span class='Ref_to_Const'>START_TIMER</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN451"><span class='Ref_To_Local'>ops</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pg_test_fsync.c.html#LN70"><span class='Ref_to_Global_Var'>alarm_triggered</span></a> <span class='Operator'>== </span><span class='Boolean'>false</span><span class='Delimiter'>; </span><a href="pg_test_fsync.c.html#LN451"><span class='Ref_To_Local'>ops</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="pg_test_fsync.c.html#LN450"><span class='Ref_To_Local'>tmpfile</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN289"><span class='Ref_to_Macro'>open</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN67"><span class='Ref_to_Global_Var'>filename</span></a><span class='Delimiter'>, </span>O_RDWR<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>))</span> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
            <a href="../../include/tcop/tcopprot.h.html#LN67"><span class='Ref_to_Proto'>die</span></a><span class='Parentheses'>(</span><span class='String'>"could not open output file"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/win32.h.html#LN13"><span class='Ref_to_Macro'>write</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN450"><span class='Ref_To_Local'>tmpfile</span></a><span class='Delimiter'>, </span><a href="pg_test_fsync.c.html#LN66"><span class='Ref_to_Global_Var'>buf</span></a><span class='Delimiter'>, </span>XLOG_BLCKSZ<span class='Parentheses'>) </span><span class='Operator'>!= </span>XLOG_BLCKSZ<span class='Parentheses'>)</span> 
            <a href="../../include/tcop/tcopprot.h.html#LN67"><span class='Ref_to_Proto'>die</span></a><span class='Parentheses'>(</span><span class='String'>"write failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN450"><span class='Ref_To_Local'>tmpfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* reopen file */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="pg_test_fsync.c.html#LN450"><span class='Ref_To_Local'>tmpfile</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN289"><span class='Ref_to_Macro'>open</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN67"><span class='Ref_to_Global_Var'>filename</span></a><span class='Delimiter'>, </span>O_RDWR<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>))</span> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
            <a href="../../include/tcop/tcopprot.h.html#LN67"><span class='Ref_to_Proto'>die</span></a><span class='Parentheses'>(</span><span class='String'>"could not open output file"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN61"><span class='Ref_to_Macro'>fsync</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN450"><span class='Ref_To_Local'>tmpfile</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="../../include/tcop/tcopprot.h.html#LN67"><span class='Ref_to_Proto'>die</span></a><span class='Parentheses'>(</span><span class='String'>"fsync failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN450"><span class='Ref_To_Local'>tmpfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="pg_test_fsync.c.html#LN54"><span class='Ref_to_Const'>STOP_TIMER</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end test_file_descriptor_sync &raquo; </span> 
 
<span class='Keyword'>static void 
</span><a name="LN517"></a><span class='Declare_Function'>test_non_sync</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN519"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>tmpfile</span><span class='Delimiter'>, 
</span><a name="LN520"></a>                <span class='Declare_Local'>ops</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Test a simple write without fsync 
     */ 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"\nNon-sync'ed %dkB writes:\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="pg_test_fsync.c.html#LN24"><span class='Ref_to_Const'>XLOG_BLCKSZ_K</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN26"><span class='Ref_to_Const'>LABEL_FORMAT</span></a><span class='Delimiter'>, </span><span class='String'>"write"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    fflush<span class='Parentheses'>(</span>stdout<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pg_test_fsync.c.html#LN33"><span class='Ref_to_Const'>START_TIMER</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN520"><span class='Ref_To_Local'>ops</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pg_test_fsync.c.html#LN70"><span class='Ref_to_Global_Var'>alarm_triggered</span></a> <span class='Operator'>== </span><span class='Boolean'>false</span><span class='Delimiter'>; </span><a href="pg_test_fsync.c.html#LN520"><span class='Ref_To_Local'>ops</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="pg_test_fsync.c.html#LN519"><span class='Ref_To_Local'>tmpfile</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN289"><span class='Ref_to_Macro'>open</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN67"><span class='Ref_to_Global_Var'>filename</span></a><span class='Delimiter'>, </span>O_RDWR<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>))</span> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
            <a href="../../include/tcop/tcopprot.h.html#LN67"><span class='Ref_to_Proto'>die</span></a><span class='Parentheses'>(</span><span class='String'>"could not open output file"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/win32.h.html#LN13"><span class='Ref_to_Macro'>write</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN519"><span class='Ref_To_Local'>tmpfile</span></a><span class='Delimiter'>, </span><a href="pg_test_fsync.c.html#LN66"><span class='Ref_to_Global_Var'>buf</span></a><span class='Delimiter'>, </span>XLOG_BLCKSZ<span class='Parentheses'>) </span><span class='Operator'>!= </span>XLOG_BLCKSZ<span class='Parentheses'>)</span> 
            <a href="../../include/tcop/tcopprot.h.html#LN67"><span class='Ref_to_Proto'>die</span></a><span class='Parentheses'>(</span><span class='String'>"write failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN519"><span class='Ref_To_Local'>tmpfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="pg_test_fsync.c.html#LN54"><span class='Ref_to_Const'>STOP_TIMER</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end test_non_sync &raquo; </span> 
 
<span class='Keyword'>static void 
</span><a name="LN542"></a><span class='Declare_Function'>signal_cleanup</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>signum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Delete the file if it exists. Ignore errors */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN64"><span class='Ref_to_Global_Var'>needs_unlink</span></a><span class='Parentheses'>) 
</span>        <a href="../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN67"><span class='Ref_to_Global_Var'>filename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Finish incomplete line on stdout */ 
</span>    puts<span class='Parentheses'>(</span><span class='String'>""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN542"><span class='Ref_to_Parameter'>signum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/port/darwin.h.html#LN5"><span class='Ref_to_Const'>HAVE_FSYNC_WRITETHROUGH</span></a> 
 
<span class='Keyword'>static int 
</span><a name="LN555"></a><span class='Declare_Function'>pg_fsync_writethrough</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>fd</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <span class='Control'>return</span> _commit<span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN555"><span class='Ref_to_Parameter'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#elif</span> defined<span class='Parentheses'>(</span>F_FULLFSYNC<span class='Parentheses'>) 
</span>    <span class='Control'>return</span> <span class='Parentheses'>(</span>fcntl<span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN555"><span class='Ref_to_Parameter'>fd</span></a><span class='Delimiter'>, </span>F_FULLFSYNC<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> <span class='Operator'>? -</span><span class='Number'>1</span> <span class='Operator'>: </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
    errno <span class='Operator'>= </span>ENOSYS<span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* 
 * print out the writes per second for tests 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN572"></a><span class='Declare_Function'>print_elapse</span><span class='Parentheses'>(</span><span class='Control'>struct</span> timeval <span class='Declare_Parameter'>start_t</span><span class='Delimiter'>, </span><span class='Control'>struct</span> timeval <span class='Declare_Parameter'>stop_t</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>ops</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN574"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>total_time</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN572"><span class='Ref_to_Parameter'>stop_t</span></a><span class='Operator'>.</span>tv_sec <span class='Operator'>- </span><a href="pg_test_fsync.c.html#LN572"><span class='Ref_to_Parameter'>start_t</span></a><span class='Operator'>.</span>tv_sec<span class='Parentheses'>) </span><span class='Operator'>+ 
</span>    <span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN572"><span class='Ref_to_Parameter'>stop_t</span></a><span class='Operator'>.</span>tv_usec <span class='Operator'>- </span><a href="pg_test_fsync.c.html#LN572"><span class='Ref_to_Parameter'>start_t</span></a><span class='Operator'>.</span>tv_usec<span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Number'>0</span><span class='Operator'>.</span><span class='Number'>000001</span><span class='Delimiter'>; 
</span><a name="LN576"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>per_second</span> <span class='Operator'>= </span><a href="pg_test_fsync.c.html#LN572"><span class='Ref_to_Parameter'>ops</span></a> <span class='Operator'>/ </span><a href="pg_test_fsync.c.html#LN574"><span class='Ref_To_Local'>total_time</span></a><span class='Delimiter'>; 
</span><a name="LN577"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>avg_op_time_us</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN574"><span class='Ref_To_Local'>total_time</span></a> <span class='Operator'>/ </span><a href="pg_test_fsync.c.html#LN572"><span class='Ref_to_Parameter'>ops</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="pg_test_fsync.c.html#LN29"><span class='Ref_to_Const'>USECS_SEC</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN28"><span class='Ref_to_Const'>OPS_FORMAT</span></a> <span class='String'>"\n"</span><span class='Delimiter'>, </span><a href="pg_test_fsync.c.html#LN576"><span class='Ref_To_Local'>per_second</span></a><span class='Delimiter'>, </span><a href="pg_test_fsync.c.html#LN577"><span class='Ref_To_Local'>avg_op_time_us</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<span class='Keyword'>static void 
</span><a name="LN584"></a><span class='Declare_Function'>process_alarm</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>sig</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="pg_test_fsync.c.html#LN70"><span class='Ref_to_Global_Var'>alarm_triggered</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
} 
</span><span class='Directive'>#else</span> 
<span class='Keyword'>static DWORD </span>WINAPI 
<a name="LN590"></a><span class='Declare_Function'>process_alarm</span><span class='Parentheses'>(</span>LPVOID <span class='Declare_Parameter'>param</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* WIN32 doesn't support alarm, so we create a thread and sleep here */ 
</span>    Sleep<span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN63"><span class='Ref_to_Global_Var'>secs_per_test</span></a> <span class='Operator'>* </span><span class='Number'>1000</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_test_fsync.c.html#LN70"><span class='Ref_to_Global_Var'>alarm_triggered</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    ExitThread<span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span><span class='Directive'>#endif</span> 
 
<span class='Keyword'>static void 
</span><a name="LN600"></a><span class='Declare_Function'>die</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>str</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><a href="pg_test_fsync.c.html#LN600"><span class='Ref_to_Parameter'>str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>