<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\bin\pg_upgrade\exec.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\bin\pg_upgrade\exec.c</b></p></td>
<td align='right'>
Wed Jun 14 08:26:01 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/* 
 *  exec.c 
 * 
 *  execution functions 
 * 
 *  Copyright (c) 2010-2017, PostgreSQL Global Development Group 
 *  src/bin/pg_upgrade/exec.c 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres_fe.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;fcntl.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"pg_upgrade.h"</span> 
 
<a name="LN15"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>check_data_dir</span><span class='Parentheses'>(</span><a href="pg_upgrade.h.html#LN259"><span class='Ref_to_Typedef'>ClusterInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>cluster</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN16"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>check_bin_dir</span><span class='Parentheses'>(</span><a href="pg_upgrade.h.html#LN259"><span class='Ref_to_Typedef'>ClusterInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>cluster</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN17"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>get_bin_version</span><span class='Parentheses'>(</span><a href="pg_upgrade.h.html#LN259"><span class='Ref_to_Typedef'>ClusterInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>cluster</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN18"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>validate_exec</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dir</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>cmdName</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN21"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>win32_check_directory_write_permissions</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * get_bin_version 
 * 
 *  Fetch versions of binaries for cluster. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN31"></a><span class='Declare_Function'>get_bin_version</span><span class='Parentheses'>(</span><a href="pg_upgrade.h.html#LN259"><span class='Ref_to_Typedef'>ClusterInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>cluster</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN33"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>cmd</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>], 
</span><a name="LN34"></a>                <span class='Declare_Local'>cmd_output</span><span class='Delimiter'>[</span><a href="pg_upgrade.h.html#LN20"><span class='Ref_to_Const'>MAX_STRING</span></a><span class='Delimiter'>]; 
</span><a name="LN35"></a>    FILE       <span class='Operator'>*</span><span class='Declare_Local'>output</span><span class='Delimiter'>; 
</span><a name="LN36"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>pre_dot</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>, 
</span><a name="LN37"></a>                <span class='Declare_Local'>post_dot</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN33"><span class='Ref_To_Local'>cmd</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="exec.c.html#LN33"><span class='Ref_To_Local'>cmd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"\"%s/pg_ctl\" --version"</span><span class='Delimiter'>, </span><a href="exec.c.html#LN31"><span class='Ref_to_Parameter'>cluster</span></a><span class='Operator'>-&GT;</span><a href="pg_upgrade.h.html#LN266"><span class='Ref_to_Member'>bindir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="exec.c.html#LN35"><span class='Ref_To_Local'>output</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN313"><span class='Ref_to_Macro'>popen</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN33"><span class='Ref_To_Local'>cmd</span></a><span class='Delimiter'>, </span><span class='String'>"r"</span><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| 
</span>        fgets<span class='Parentheses'>(</span><a href="exec.c.html#LN34"><span class='Ref_To_Local'>cmd_output</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="exec.c.html#LN34"><span class='Ref_To_Local'>cmd_output</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="exec.c.html#LN35"><span class='Ref_To_Local'>output</span></a><span class='Parentheses'>)</span> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <a href="../pg_rewind/logging.c.html#LN81"><span class='Ref_to_Func'>pg_fatal</span></a><span class='Parentheses'>(</span><span class='String'>"could not get pg_ctl version data using %s: %s\n"</span><span class='Delimiter'>, 
</span>                 <a href="exec.c.html#LN33"><span class='Ref_To_Local'>cmd</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/port.h.html#LN314"><span class='Ref_to_Macro'>pclose</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN35"><span class='Ref_To_Local'>output</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Remove trailing newline */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strchr<span class='Parentheses'>(</span><a href="exec.c.html#LN34"><span class='Ref_To_Local'>cmd_output</span></a><span class='Delimiter'>, </span><span class='String'>'\n'</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <span class='Operator'>*</span>strchr<span class='Parentheses'>(</span><a href="exec.c.html#LN34"><span class='Ref_To_Local'>cmd_output</span></a><span class='Delimiter'>, </span><span class='String'>'\n'</span><span class='Parentheses'>) </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>sscanf<span class='Parentheses'>(</span><a href="exec.c.html#LN34"><span class='Ref_To_Local'>cmd_output</span></a><span class='Delimiter'>, </span><span class='String'>"%*s %*s %d.%d"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="exec.c.html#LN36"><span class='Ref_To_Local'>pre_dot</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="exec.c.html#LN37"><span class='Ref_To_Local'>post_dot</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
        <a href="../pg_rewind/logging.c.html#LN81"><span class='Ref_to_Func'>pg_fatal</span></a><span class='Parentheses'>(</span><span class='String'>"could not get version from %s\n"</span><span class='Delimiter'>, </span><a href="exec.c.html#LN33"><span class='Ref_To_Local'>cmd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="exec.c.html#LN31"><span class='Ref_to_Parameter'>cluster</span></a><span class='Operator'>-&GT;</span><a href="pg_upgrade.h.html#LN273"><span class='Ref_to_Member'>bin_version</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="exec.c.html#LN36"><span class='Ref_To_Local'>pre_dot</span></a> <span class='Operator'>* </span><span class='Number'>100</span> <span class='Operator'>+ </span><a href="exec.c.html#LN37"><span class='Ref_To_Local'>post_dot</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Number'>100</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end get_bin_version &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * exec_prog() 
 *      Execute an external program with stdout/stderr redirected, and report 
 *      errors 
 * 
 * Formats a command from the given argument list, logs it to the log file, 
 * and attempts to execute that command.  If the command executes 
 * successfully, exec_prog() returns true. 
 * 
 * If the command fails, an error message is saved to the specified log_file. 
 * If throw_error is true, this raises a PG_FATAL error and pg_upgrade 
 * terminates; otherwise it is just reported as PG_REPORT and exec_prog() 
 * returns false. 
 * 
 * The code requires it be called first from the primary thread on Windows. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN76"></a><span class='Declare_Function'>exec_prog</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>log_file</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>opt_log_file</span><span class='Delimiter'>, 
</span><a name="LN77"></a>          <span class='Keyword'>bool </span><span class='Declare_Parameter'>throw_error</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>fmt</span><span class='Delimiter'>,</span><span class='Operator'>...</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN79"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>result</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN80"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>written</span><span class='Delimiter'>; 
</span> 
<a name="LN82"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MAXCMDLEN</span> <span class='Parentheses'>(</span><span class='Number'>2</span> <span class='Operator'>* </span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Parentheses'>) 
</span><a name="LN83"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>cmd</span><span class='Delimiter'>[</span><a href="exec.c.html#LN82"><span class='Ref_to_Const'>MAXCMDLEN</span></a><span class='Delimiter'>]; 
</span><a name="LN84"></a>    FILE       <span class='Operator'>*</span><span class='Declare_Local'>log</span><span class='Delimiter'>; 
</span><a name="LN85"></a>    va_list     <span class='Declare_Local'>ap</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN88"></a>    <span class='Keyword'>static DWORD </span><span class='Declare_Local'>mainThreadId</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We assume we are called from the primary thread first */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="exec.c.html#LN88"><span class='Ref_To_Local'>mainThreadId</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="exec.c.html#LN88"><span class='Ref_To_Local'>mainThreadId</span></a> <span class='Operator'>= </span>GetCurrentThreadId<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <a href="exec.c.html#LN80"><span class='Ref_To_Local'>written</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="../../pl/plperl/ppport.h.html#LN5587"><span class='Ref_to_Proto'>va_start</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN85"><span class='Ref_To_Local'>ap</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN77"><span class='Ref_to_Parameter'>fmt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="exec.c.html#LN80"><span class='Ref_To_Local'>written</span></a> <span class='Operator'>+= </span><a href="../../pl/plperl/plperl.h.html#LN59"><span class='Ref_to_Macro'>vsnprintf</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN83"><span class='Ref_To_Local'>cmd</span></a> <span class='Operator'>+ </span><a href="exec.c.html#LN80"><span class='Ref_To_Local'>written</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN82"><span class='Ref_to_Const'>MAXCMDLEN</span></a> <span class='Operator'>- </span><a href="exec.c.html#LN80"><span class='Ref_To_Local'>written</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN77"><span class='Ref_to_Parameter'>fmt</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN85"><span class='Ref_To_Local'>ap</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../pl/plperl/ppport.h.html#LN5589"><span class='Ref_to_Proto'>va_end</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN85"><span class='Ref_To_Local'>ap</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="exec.c.html#LN80"><span class='Ref_To_Local'>written</span></a> <span class='Operator'>&GT;= </span><a href="exec.c.html#LN82"><span class='Ref_to_Const'>MAXCMDLEN</span></a><span class='Parentheses'>) 
</span>        <a href="../pg_rewind/logging.c.html#LN81"><span class='Ref_to_Func'>pg_fatal</span></a><span class='Parentheses'>(</span><span class='String'>"command too long\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="exec.c.html#LN80"><span class='Ref_To_Local'>written</span></a> <span class='Operator'>+= </span><a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN83"><span class='Ref_To_Local'>cmd</span></a> <span class='Operator'>+ </span><a href="exec.c.html#LN80"><span class='Ref_To_Local'>written</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN82"><span class='Ref_to_Const'>MAXCMDLEN</span></a> <span class='Operator'>- </span><a href="exec.c.html#LN80"><span class='Ref_To_Local'>written</span></a><span class='Delimiter'>, 
</span>                        <span class='String'>" &GT;&GT; \"%s\" 2&GT;&1"</span><span class='Delimiter'>, </span><a href="exec.c.html#LN76"><span class='Ref_to_Parameter'>log_file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="exec.c.html#LN80"><span class='Ref_To_Local'>written</span></a> <span class='Operator'>&GT;= </span><a href="exec.c.html#LN82"><span class='Ref_to_Const'>MAXCMDLEN</span></a><span class='Parentheses'>) 
</span>        <a href="../pg_rewind/logging.c.html#LN81"><span class='Ref_to_Func'>pg_fatal</span></a><span class='Parentheses'>(</span><span class='String'>"command too long\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../pg_rewind/logging.c.html#LN67"><span class='Ref_to_Func'>pg_log</span></a><span class='Parentheses'>(</span><a href="pg_upgrade.h.html#LN243"><span class='Ref_to_EnumConst'>PG_VERBOSE</span></a><span class='Delimiter'>, </span><span class='String'>"%s\n"</span><span class='Delimiter'>, </span><a href="exec.c.html#LN83"><span class='Ref_To_Local'>cmd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
 
    <span class='Comment_Multi_Line'>/* 
     * For some reason, Windows issues a file-in-use error if we write data to 
     * the log file from a non-primary thread just before we create a 
     * subprocess that also writes to the same log file.  One fix is to sleep 
     * for 100ms.  A cleaner fix is to write to the log file _after_ the 
     * subprocess has completed, so we do this only when writing from a 
     * non-primary thread.  fflush(), running system() twice, and pre-creating 
     * the file do not see to help. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="exec.c.html#LN88"><span class='Ref_To_Local'>mainThreadId</span></a> <span class='Operator'>!= </span>GetCurrentThreadId<span class='Parentheses'>())</span> 
        <a href="exec.c.html#LN79"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN312"><span class='Ref_to_Macro'>system</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN83"><span class='Ref_To_Local'>cmd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <a href="exec.c.html#LN84"><span class='Ref_To_Local'>log</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN290"><span class='Ref_to_Macro'>fopen</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN76"><span class='Ref_to_Parameter'>log_file</span></a><span class='Delimiter'>, </span><span class='String'>"a"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * "pg_ctl -w stop" might have reported that the server has stopped 
         * because the postmaster.pid file has been removed, but "pg_ctl -w 
         * start" might still be in the process of closing and might still be 
         * holding its stdout and -l log file descriptors open.  Therefore, 
         * try to open the log file a few more times. 
         */ 
</span><a name="LN134"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>iter</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="exec.c.html#LN134"><span class='Ref_To_Local'>iter</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="exec.c.html#LN134"><span class='Ref_To_Local'>iter</span></a> <span class='Operator'>&LT; </span><span class='Number'>4</span> <span class='Operator'>&& </span><a href="exec.c.html#LN84"><span class='Ref_To_Local'>log</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; </span><a href="exec.c.html#LN134"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../port/pgsleep.c.html#LN45"><span class='Ref_to_Func'>pg_usleep</span></a><span class='Parentheses'>(</span><span class='Number'>1000000</span><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* 1 sec */ 
</span>            <a href="exec.c.html#LN84"><span class='Ref_To_Local'>log</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN290"><span class='Ref_to_Macro'>fopen</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN76"><span class='Ref_to_Parameter'>log_file</span></a><span class='Delimiter'>, </span><span class='String'>"a"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="exec.c.html#LN84"><span class='Ref_To_Local'>log</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../pg_rewind/logging.c.html#LN81"><span class='Ref_to_Func'>pg_fatal</span></a><span class='Parentheses'>(</span><span class='String'>"cannot write to log file %s\n"</span><span class='Delimiter'>, </span><a href="exec.c.html#LN76"><span class='Ref_to_Parameter'>log_file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <span class='Comment_Multi_Line'>/* Are we printing "command:" before its output? */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="exec.c.html#LN88"><span class='Ref_To_Local'>mainThreadId</span></a> <span class='Operator'>== </span>GetCurrentThreadId<span class='Parentheses'>())</span> 
        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN84"><span class='Ref_To_Local'>log</span></a><span class='Delimiter'>, </span><span class='String'>"\n\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN84"><span class='Ref_To_Local'>log</span></a><span class='Delimiter'>, </span><span class='String'>"command: %s\n"</span><span class='Delimiter'>, </span><a href="exec.c.html#LN83"><span class='Ref_To_Local'>cmd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <span class='Comment_Multi_Line'>/* Are we printing "command:" after its output? */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="exec.c.html#LN88"><span class='Ref_To_Local'>mainThreadId</span></a> <span class='Operator'>!= </span>GetCurrentThreadId<span class='Parentheses'>())</span> 
        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN84"><span class='Ref_To_Local'>log</span></a><span class='Delimiter'>, </span><span class='String'>"\n\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * In Windows, we must close the log file at this point so the file is not 
     * open while the command is running, or we get a share violation. 
     */ 
</span>    fclose<span class='Parentheses'>(</span><a href="exec.c.html#LN84"><span class='Ref_To_Local'>log</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <span class='Comment_Multi_Line'>/* see comment above */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="exec.c.html#LN88"><span class='Ref_To_Local'>mainThreadId</span></a> <span class='Operator'>== </span>GetCurrentThreadId<span class='Parentheses'>())</span> 
<span class='Directive'>#endif</span> 
        <a href="exec.c.html#LN79"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN312"><span class='Ref_to_Macro'>system</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN83"><span class='Ref_To_Local'>cmd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="exec.c.html#LN79"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* we might be in on a progress status line, so go to the next line */ 
</span>        report_status<span class='Parentheses'>(</span><a href="pg_upgrade.h.html#LN245"><span class='Ref_to_EnumConst'>PG_REPORT</span></a><span class='Delimiter'>, </span><span class='String'>"\n*failure*"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        fflush<span class='Parentheses'>(</span>stdout<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../pg_rewind/logging.c.html#LN67"><span class='Ref_to_Func'>pg_log</span></a><span class='Parentheses'>(</span><a href="pg_upgrade.h.html#LN243"><span class='Ref_to_EnumConst'>PG_VERBOSE</span></a><span class='Delimiter'>, </span><span class='String'>"There were problems executing \"%s\"\n"</span><span class='Delimiter'>, </span><a href="exec.c.html#LN83"><span class='Ref_To_Local'>cmd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="exec.c.html#LN76"><span class='Ref_to_Parameter'>opt_log_file</span></a><span class='Parentheses'>) 
</span>            <a href="../pg_rewind/logging.c.html#LN67"><span class='Ref_to_Func'>pg_log</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN77"><span class='Ref_to_Parameter'>throw_error</span></a> <span class='Operator'>? </span><a href="pg_upgrade.h.html#LN247"><span class='Ref_to_EnumConst'>PG_FATAL</span></a> <span class='Operator'>: </span><a href="pg_upgrade.h.html#LN245"><span class='Ref_to_EnumConst'>PG_REPORT</span></a><span class='Delimiter'>, 
</span>                   <span class='String'>"Consult the last few lines of \"%s\" or \"%s\" for\n"</span> 
                   <span class='String'>"the probable cause of the failure.\n"</span><span class='Delimiter'>, 
</span>                   <a href="exec.c.html#LN76"><span class='Ref_to_Parameter'>log_file</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN76"><span class='Ref_to_Parameter'>opt_log_file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../pg_rewind/logging.c.html#LN67"><span class='Ref_to_Func'>pg_log</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN77"><span class='Ref_to_Parameter'>throw_error</span></a> <span class='Operator'>? </span><a href="pg_upgrade.h.html#LN247"><span class='Ref_to_EnumConst'>PG_FATAL</span></a> <span class='Operator'>: </span><a href="pg_upgrade.h.html#LN245"><span class='Ref_to_EnumConst'>PG_REPORT</span></a><span class='Delimiter'>, 
</span>                   <span class='String'>"Consult the last few lines of \"%s\" for\n"</span> 
                   <span class='String'>"the probable cause of the failure.\n"</span><span class='Delimiter'>, 
</span>                   <a href="exec.c.html#LN76"><span class='Ref_to_Parameter'>log_file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
<span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
 
    <span class='Comment_Multi_Line'>/* 
     * We can't do this on Windows because it will keep the "pg_ctl start" 
     * output filename open until the server stops, so we do the \n\n above on 
     * that platform.  We use a unique filename for "pg_ctl start" that is 
     * never reused while the server is running, so it works fine.  We could 
     * log these commands to a third file, but that just adds complexity. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="exec.c.html#LN84"><span class='Ref_To_Local'>log</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN290"><span class='Ref_to_Macro'>fopen</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN76"><span class='Ref_to_Parameter'>log_file</span></a><span class='Delimiter'>, </span><span class='String'>"a"</span><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <a href="../pg_rewind/logging.c.html#LN81"><span class='Ref_to_Func'>pg_fatal</span></a><span class='Parentheses'>(</span><span class='String'>"cannot write to log file %s\n"</span><span class='Delimiter'>, </span><a href="exec.c.html#LN76"><span class='Ref_to_Parameter'>log_file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN84"><span class='Ref_To_Local'>log</span></a><span class='Delimiter'>, </span><span class='String'>"\n\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    fclose<span class='Parentheses'>(</span><a href="exec.c.html#LN84"><span class='Ref_To_Local'>log</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Control'>return</span> <a href="exec.c.html#LN79"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end exec_prog &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * pid_lock_file_exists() 
 * 
 * Checks whether the postmaster.pid file exists. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN215"></a><span class='Declare_Function'>pid_lock_file_exists</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>datadir</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN217"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>path</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN218"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>fd</span><span class='Delimiter'>; 
</span> 
    <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN217"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="exec.c.html#LN217"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/postmaster.pid"</span><span class='Delimiter'>, </span><a href="exec.c.html#LN215"><span class='Ref_to_Parameter'>datadir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="exec.c.html#LN218"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN289"><span class='Ref_to_Macro'>open</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN217"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span>O_RDONLY<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>))</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* ENOTDIR means we will throw a more useful error later */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>!= </span>ENOENT <span class='Operator'>&& </span>errno <span class='Operator'>!= </span>ENOTDIR<span class='Parentheses'>) 
</span>            <a href="../pg_rewind/logging.c.html#LN81"><span class='Ref_to_Func'>pg_fatal</span></a><span class='Parentheses'>(</span><span class='String'>"could not open file \"%s\" for reading: %s\n"</span><span class='Delimiter'>, 
</span>                     <a href="exec.c.html#LN217"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN218"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pid_lock_file_exists &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * verify_directories() 
 * 
 * does all the hectic work of verifying directories and executables 
 * of old and new server. 
 * 
 * NOTE: May update the values of all parameters 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN246"></a><span class='Declare_Function'>verify_directories</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>access<span class='Parentheses'>(</span><span class='String'>"."</span><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN434"><span class='Ref_to_Const'>R_OK</span></a> <span class='Operator'>| </span><a href="../../include/port/win32.h.html#LN433"><span class='Ref_to_Const'>W_OK</span></a> <span class='Operator'>| </span>X_OK<span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
<span class='Directive'>#else</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="exec.c.html#LN21"><span class='Ref_to_Proto'>win32_check_directory_write_permissions</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
<span class='Directive'>#endif</span> 
        <a href="../pg_rewind/logging.c.html#LN81"><span class='Ref_to_Func'>pg_fatal</span></a><span class='Parentheses'>(</span><span class='String'>"You must have read and write access in the current directory.\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="exec.c.html#LN16"><span class='Ref_to_Proto'>check_bin_dir</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_upgrade.c.html#LN55"><span class='Ref_to_Global_Var'>old_cluster</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="exec.c.html#LN15"><span class='Ref_to_Proto'>check_data_dir</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_upgrade.c.html#LN55"><span class='Ref_to_Global_Var'>old_cluster</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="exec.c.html#LN16"><span class='Ref_to_Proto'>check_bin_dir</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_upgrade.c.html#LN56"><span class='Ref_to_Global_Var'>new_cluster</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="exec.c.html#LN15"><span class='Ref_to_Proto'>check_data_dir</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_upgrade.c.html#LN56"><span class='Ref_to_Global_Var'>new_cluster</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<span class='Comment_Multi_Line'>/* 
 * win32_check_directory_write_permissions() 
 * 
 *  access() on WIN32 can't check directory permissions, so we have to 
 *  optionally create, then delete a file to check. 
 *      http://msdn.microsoft.com/en-us/library/1w06ktdy%28v=vs.80%29.aspx 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN271"></a><span class='Declare_Function'>win32_check_directory_write_permissions</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN273"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>fd</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We open a file we would normally create anyway.  We do this even in 
     * 'check' mode, which isn't ideal, but this is the best we can do. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="exec.c.html#LN273"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN289"><span class='Ref_to_Macro'>open</span></a><span class='Parentheses'>(</span><a href="pg_upgrade.h.html#LN31"><span class='Ref_to_Const'>GLOBALS_DUMP_FILE</span></a><span class='Delimiter'>, </span>O_RDWR <span class='Operator'>| </span>O_CREAT<span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN424"><span class='Ref_to_Const'>S_IRUSR</span></a> <span class='Operator'>| </span><a href="../../include/port/win32.h.html#LN425"><span class='Ref_to_Const'>S_IWUSR</span></a><span class='Parentheses'>))</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN273"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="pg_upgrade.h.html#LN31"><span class='Ref_to_Const'>GLOBALS_DUMP_FILE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span><span class='Directive'>#endif</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * check_single_dir() 
 * 
 *  Check for the presence of a single directory in PGDATA, and fail if 
 * is it missing or not accessible. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN295"></a><span class='Declare_Function'>check_single_dir</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>pg_data</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>subdir</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN297"></a>    <span class='Control'>struct</span> <a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>statBuf</span><span class='Delimiter'>; 
</span><a name="LN298"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>subDirName</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span> 
    <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN298"><span class='Ref_To_Local'>subDirName</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="exec.c.html#LN298"><span class='Ref_To_Local'>subDirName</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s%s%s"</span><span class='Delimiter'>, </span><a href="exec.c.html#LN295"><span class='Ref_to_Parameter'>pg_data</span></a><span class='Delimiter'>, 
</span>    <span class='Comment_Multi_Line'>/* Win32 can't stat() a directory with a trailing slash. */ 
</span>             <span class='Operator'>*</span><a href="exec.c.html#LN295"><span class='Ref_to_Parameter'>subdir</span></a> <span class='Operator'>? </span><span class='String'>"/"</span> <span class='Operator'>: </span><span class='String'>""</span><span class='Delimiter'>, 
</span>             <a href="exec.c.html#LN295"><span class='Ref_to_Parameter'>subdir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN298"><span class='Ref_To_Local'>subDirName</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="exec.c.html#LN297"><span class='Ref_To_Local'>statBuf</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        report_status<span class='Parentheses'>(</span><a href="pg_upgrade.h.html#LN247"><span class='Ref_to_EnumConst'>PG_FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"check for \"%s\" failed: %s\n"</span><span class='Delimiter'>, 
</span>                      <a href="exec.c.html#LN298"><span class='Ref_To_Local'>subDirName</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/port/win32.h.html#LN429"><span class='Ref_to_Macro'>S_ISDIR</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN297"><span class='Ref_To_Local'>statBuf</span></a><span class='Operator'>.</span>st_mode<span class='Parentheses'>))</span> 
        report_status<span class='Parentheses'>(</span><a href="pg_upgrade.h.html#LN247"><span class='Ref_to_EnumConst'>PG_FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"%s is not a directory\n"</span><span class='Delimiter'>, 
</span>                      <a href="exec.c.html#LN298"><span class='Ref_To_Local'>subDirName</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * check_data_dir() 
 * 
 *  This function validates the given cluster directory - we search for a 
 *  small set of subdirectories that we expect to find in a valid $PGDATA 
 *  directory.  If any of the subdirectories are missing (or secured against 
 *  us) we display an error message and exit() 
 * 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN324"></a><span class='Declare_Function'>check_data_dir</span><span class='Parentheses'>(</span><a href="pg_upgrade.h.html#LN259"><span class='Ref_to_Typedef'>ClusterInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>cluster</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN326"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>pg_data</span> <span class='Operator'>= </span><a href="exec.c.html#LN324"><span class='Ref_to_Parameter'>cluster</span></a><span class='Operator'>-&GT;</span><a href="pg_upgrade.h.html#LN263"><span class='Ref_to_Member'>pgdata</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* get old and new cluster versions */ 
</span>    <a href="pg_upgrade.c.html#LN55"><span class='Ref_to_Global_Var'>old_cluster</span></a><span class='Operator'>.</span><a href="pg_upgrade.h.html#LN271"><span class='Ref_to_Member'>major_version</span></a> <span class='Operator'>= </span><a href="server.c.html#LN153"><span class='Ref_to_Func'>get_major_server_version</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_upgrade.c.html#LN55"><span class='Ref_to_Global_Var'>old_cluster</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_upgrade.c.html#LN56"><span class='Ref_to_Global_Var'>new_cluster</span></a><span class='Operator'>.</span><a href="pg_upgrade.h.html#LN271"><span class='Ref_to_Member'>major_version</span></a> <span class='Operator'>= </span><a href="server.c.html#LN153"><span class='Ref_to_Func'>get_major_server_version</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_upgrade.c.html#LN56"><span class='Ref_to_Global_Var'>new_cluster</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="exec.c.html#LN294"><span class='Ref_to_Func'>check_single_dir</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN326"><span class='Ref_To_Local'>pg_data</span></a><span class='Delimiter'>, </span><span class='String'>""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="exec.c.html#LN294"><span class='Ref_to_Func'>check_single_dir</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN326"><span class='Ref_To_Local'>pg_data</span></a><span class='Delimiter'>, </span><span class='String'>"base"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="exec.c.html#LN294"><span class='Ref_to_Func'>check_single_dir</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN326"><span class='Ref_To_Local'>pg_data</span></a><span class='Delimiter'>, </span><span class='String'>"global"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="exec.c.html#LN294"><span class='Ref_to_Func'>check_single_dir</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN326"><span class='Ref_To_Local'>pg_data</span></a><span class='Delimiter'>, </span><span class='String'>"pg_multixact"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="exec.c.html#LN294"><span class='Ref_to_Func'>check_single_dir</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN326"><span class='Ref_To_Local'>pg_data</span></a><span class='Delimiter'>, </span><span class='String'>"pg_subtrans"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="exec.c.html#LN294"><span class='Ref_to_Func'>check_single_dir</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN326"><span class='Ref_To_Local'>pg_data</span></a><span class='Delimiter'>, </span><span class='String'>"pg_tblspc"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="exec.c.html#LN294"><span class='Ref_to_Func'>check_single_dir</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN326"><span class='Ref_To_Local'>pg_data</span></a><span class='Delimiter'>, </span><span class='String'>"pg_twophase"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* pg_xlog has been renamed to pg_wal in v10 */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_upgrade.h.html#LN28"><span class='Ref_to_Macro'>GET_MAJOR_VERSION</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN324"><span class='Ref_to_Parameter'>cluster</span></a><span class='Operator'>-&GT;</span><a href="pg_upgrade.h.html#LN271"><span class='Ref_to_Member'>major_version</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>1000</span><span class='Parentheses'>)</span> 
        <a href="exec.c.html#LN294"><span class='Ref_to_Func'>check_single_dir</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN326"><span class='Ref_To_Local'>pg_data</span></a><span class='Delimiter'>, </span><span class='String'>"pg_xlog"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="exec.c.html#LN294"><span class='Ref_to_Func'>check_single_dir</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN326"><span class='Ref_To_Local'>pg_data</span></a><span class='Delimiter'>, </span><span class='String'>"pg_wal"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* pg_clog has been renamed to pg_xact in v10 */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_upgrade.h.html#LN28"><span class='Ref_to_Macro'>GET_MAJOR_VERSION</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN324"><span class='Ref_to_Parameter'>cluster</span></a><span class='Operator'>-&GT;</span><a href="pg_upgrade.h.html#LN271"><span class='Ref_to_Member'>major_version</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>1000</span><span class='Parentheses'>)</span> 
        <a href="exec.c.html#LN294"><span class='Ref_to_Func'>check_single_dir</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN326"><span class='Ref_To_Local'>pg_data</span></a><span class='Delimiter'>, </span><span class='String'>"pg_clog"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="exec.c.html#LN294"><span class='Ref_to_Func'>check_single_dir</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN326"><span class='Ref_To_Local'>pg_data</span></a><span class='Delimiter'>, </span><span class='String'>"pg_xact"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end check_data_dir &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * check_bin_dir() 
 * 
 *  This function searches for the executables that we expect to find 
 *  in the binaries directory.  If we find that a required executable 
 *  is missing (or secured against us), we display an error message and 
 *  exit(). 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN363"></a><span class='Declare_Function'>check_bin_dir</span><span class='Parentheses'>(</span><a href="pg_upgrade.h.html#LN259"><span class='Ref_to_Typedef'>ClusterInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>cluster</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN365"></a>    <span class='Control'>struct</span> <a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>statBuf</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* check bindir */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN363"><span class='Ref_to_Parameter'>cluster</span></a><span class='Operator'>-&GT;</span><a href="pg_upgrade.h.html#LN266"><span class='Ref_to_Member'>bindir</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="exec.c.html#LN365"><span class='Ref_To_Local'>statBuf</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        report_status<span class='Parentheses'>(</span><a href="pg_upgrade.h.html#LN247"><span class='Ref_to_EnumConst'>PG_FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"check for \"%s\" failed: %s\n"</span><span class='Delimiter'>, 
</span>                      <a href="exec.c.html#LN363"><span class='Ref_to_Parameter'>cluster</span></a><span class='Operator'>-&GT;</span><a href="pg_upgrade.h.html#LN266"><span class='Ref_to_Member'>bindir</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/port/win32.h.html#LN429"><span class='Ref_to_Macro'>S_ISDIR</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN365"><span class='Ref_To_Local'>statBuf</span></a><span class='Operator'>.</span>st_mode<span class='Parentheses'>))</span> 
        report_status<span class='Parentheses'>(</span><a href="pg_upgrade.h.html#LN247"><span class='Ref_to_EnumConst'>PG_FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"%s is not a directory\n"</span><span class='Delimiter'>, 
</span>                      <a href="exec.c.html#LN363"><span class='Ref_to_Parameter'>cluster</span></a><span class='Operator'>-&GT;</span><a href="pg_upgrade.h.html#LN266"><span class='Ref_to_Member'>bindir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="exec.c.html#LN18"><span class='Ref_to_Proto'>validate_exec</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN363"><span class='Ref_to_Parameter'>cluster</span></a><span class='Operator'>-&GT;</span><a href="pg_upgrade.h.html#LN266"><span class='Ref_to_Member'>bindir</span></a><span class='Delimiter'>, </span><span class='String'>"postgres"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="exec.c.html#LN18"><span class='Ref_to_Proto'>validate_exec</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN363"><span class='Ref_to_Parameter'>cluster</span></a><span class='Operator'>-&GT;</span><a href="pg_upgrade.h.html#LN266"><span class='Ref_to_Member'>bindir</span></a><span class='Delimiter'>, </span><span class='String'>"pg_ctl"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Fetch the binary versions after checking for the existence of pg_ctl, 
     * this gives a correct error if the binary used itself for the version 
     * fetching is broken. 
     */ 
</span>    <a href="exec.c.html#LN17"><span class='Ref_to_Proto'>get_bin_version</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_upgrade.c.html#LN55"><span class='Ref_to_Global_Var'>old_cluster</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="exec.c.html#LN17"><span class='Ref_to_Proto'>get_bin_version</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_upgrade.c.html#LN56"><span class='Ref_to_Global_Var'>new_cluster</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* pg_resetxlog has been renamed to pg_resetwal in version 10 */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_upgrade.h.html#LN28"><span class='Ref_to_Macro'>GET_MAJOR_VERSION</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN363"><span class='Ref_to_Parameter'>cluster</span></a><span class='Operator'>-&GT;</span><a href="pg_upgrade.h.html#LN273"><span class='Ref_to_Member'>bin_version</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>1000</span><span class='Parentheses'>)</span> 
        <a href="exec.c.html#LN18"><span class='Ref_to_Proto'>validate_exec</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN363"><span class='Ref_to_Parameter'>cluster</span></a><span class='Operator'>-&GT;</span><a href="pg_upgrade.h.html#LN266"><span class='Ref_to_Member'>bindir</span></a><span class='Delimiter'>, </span><span class='String'>"pg_resetxlog"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="exec.c.html#LN18"><span class='Ref_to_Proto'>validate_exec</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN363"><span class='Ref_to_Parameter'>cluster</span></a><span class='Operator'>-&GT;</span><a href="pg_upgrade.h.html#LN266"><span class='Ref_to_Member'>bindir</span></a><span class='Delimiter'>, </span><span class='String'>"pg_resetwal"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="exec.c.html#LN363"><span class='Ref_to_Parameter'>cluster</span></a> <span class='Operator'>== &</span><a href="pg_upgrade.c.html#LN56"><span class='Ref_to_Global_Var'>new_cluster</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* these are only needed in the new cluster */ 
</span>        <a href="exec.c.html#LN18"><span class='Ref_to_Proto'>validate_exec</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN363"><span class='Ref_to_Parameter'>cluster</span></a><span class='Operator'>-&GT;</span><a href="pg_upgrade.h.html#LN266"><span class='Ref_to_Member'>bindir</span></a><span class='Delimiter'>, </span><span class='String'>"psql"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="exec.c.html#LN18"><span class='Ref_to_Proto'>validate_exec</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN363"><span class='Ref_to_Parameter'>cluster</span></a><span class='Operator'>-&GT;</span><a href="pg_upgrade.h.html#LN266"><span class='Ref_to_Member'>bindir</span></a><span class='Delimiter'>, </span><span class='String'>"pg_dump"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="exec.c.html#LN18"><span class='Ref_to_Proto'>validate_exec</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN363"><span class='Ref_to_Parameter'>cluster</span></a><span class='Operator'>-&GT;</span><a href="pg_upgrade.h.html#LN266"><span class='Ref_to_Member'>bindir</span></a><span class='Delimiter'>, </span><span class='String'>"pg_dumpall"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end check_bin_dir &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * validate_exec() 
 * 
 * validate "path" as an executable file 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN407"></a><span class='Declare_Function'>validate_exec</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dir</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>cmdName</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN409"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>path</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN410"></a>    <span class='Control'>struct</span> <a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span> 
    <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN409"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="exec.c.html#LN409"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/%s"</span><span class='Delimiter'>, </span><a href="exec.c.html#LN407"><span class='Ref_to_Parameter'>dir</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN407"><span class='Ref_to_Parameter'>cmdName</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <span class='Comment_Multi_Line'>/* Windows requires a .exe suffix for stat() */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="exec.c.html#LN409"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span> <span class='Operator'>&LT;= </span>strlen<span class='Parentheses'>(</span><a href="pg_upgrade.h.html#LN91"><span class='Ref_to_Const'>EXE_EXT</span></a><span class='Parentheses'>)</span> <span class='Operator'>|| 
</span>        <a href="../../port/pgstrcasecmp.c.html#LN34"><span class='Ref_to_Func'>pg_strcasecmp</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN409"><span class='Ref_To_Local'>path</span></a> <span class='Operator'>+ </span>strlen<span class='Parentheses'>(</span><a href="exec.c.html#LN409"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span>strlen<span class='Parentheses'>(</span><a href="pg_upgrade.h.html#LN91"><span class='Ref_to_Const'>EXE_EXT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="pg_upgrade.h.html#LN91"><span class='Ref_to_Const'>EXE_EXT</span></a><span class='Parentheses'>)</span> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../port/strlcat.c.html#LN31"><span class='Ref_to_Func'>strlcat</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN409"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><a href="pg_upgrade.h.html#LN91"><span class='Ref_to_Const'>EXE_EXT</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="exec.c.html#LN409"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Ensure that the file exists and is a regular file. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN409"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="exec.c.html#LN410"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../pg_rewind/logging.c.html#LN81"><span class='Ref_to_Func'>pg_fatal</span></a><span class='Parentheses'>(</span><span class='String'>"check for \"%s\" failed: %s\n"</span><span class='Delimiter'>, 
</span>                 <a href="exec.c.html#LN409"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/port/win32.h.html#LN430"><span class='Ref_to_Macro'>S_ISREG</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN410"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span>st_mode<span class='Parentheses'>))</span> 
        <a href="../pg_rewind/logging.c.html#LN81"><span class='Ref_to_Func'>pg_fatal</span></a><span class='Parentheses'>(</span><span class='String'>"check for \"%s\" failed: not an executable file\n"</span><span class='Delimiter'>, 
</span>                 <a href="exec.c.html#LN409"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Ensure that the file is both executable and readable (required for 
     * dynamic loading). 
     */ 
</span><span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>access<span class='Parentheses'>(</span><a href="exec.c.html#LN409"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN434"><span class='Ref_to_Const'>R_OK</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
<span class='Directive'>#else</span> 
    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="exec.c.html#LN410"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span>st_mode <span class='Operator'>& </span><a href="../../include/port/win32.h.html#LN424"><span class='Ref_to_Const'>S_IRUSR</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
<span class='Directive'>#endif</span> 
        <a href="../pg_rewind/logging.c.html#LN81"><span class='Ref_to_Func'>pg_fatal</span></a><span class='Parentheses'>(</span><span class='String'>"check for \"%s\" failed: cannot read file (permission denied)\n"</span><span class='Delimiter'>, 
</span>                 <a href="exec.c.html#LN409"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>access<span class='Parentheses'>(</span><a href="exec.c.html#LN409"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span>X_OK<span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
<span class='Directive'>#else</span> 
    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="exec.c.html#LN410"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span>st_mode <span class='Operator'>& </span><a href="../../include/port/win32.h.html#LN426"><span class='Ref_to_Const'>S_IXUSR</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
<span class='Directive'>#endif</span> 
        <a href="../pg_rewind/logging.c.html#LN81"><span class='Ref_to_Func'>pg_fatal</span></a><span class='Parentheses'>(</span><span class='String'>"check for \"%s\" failed: cannot execute (permission denied)\n"</span><span class='Delimiter'>, 
</span>                 <a href="exec.c.html#LN409"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end validate_exec &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>