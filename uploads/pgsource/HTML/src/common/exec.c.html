<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\common\exec.c</title>
<LINK REL=StyleSheet HREF="../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\common\exec.c</b></p></td>
<td align='right'>
Wed Jun 14 08:26:02 2017
</td></tr>
<tr><td><a href='../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * exec.c 
 *      Functions for finding and validating executable files 
 * 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/common/exec.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Directive'>#ifndef</span> <a href="../bin/pg_waldump/rmgrdesc.c.html#LN7"><span class='Ref_to_Const'>FRONTEND</span></a> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
<span class='Directive'>#else</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres_fe.h"</span> 
<span class='Directive'>#endif</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;signal.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/stat.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/wait.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
 
<span class='Directive'>#ifndef</span> <a href="../bin/pg_waldump/rmgrdesc.c.html#LN7"><span class='Ref_to_Const'>FRONTEND</span></a> 
<span class='Comment_Multi_Line'>/* We use only 3- and 4-parameter elog calls in this file, for simplicity */ 
/* NOTE: caller must provide gettext call around str! */ 
</span><a name="LN30"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>log_error</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>str</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>param</span><span class='Parentheses'>)</span>   <a href="../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN30"><span class='Ref_to_Parameter'>str</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN30"><span class='Ref_to_Parameter'>param</span></a><span class='Parentheses'>) 
</span><a name="LN31"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>log_error4</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>str</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>param</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>arg1</span><span class='Parentheses'>)</span>    <a href="../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN31"><span class='Ref_to_Parameter'>str</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN31"><span class='Ref_to_Parameter'>param</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN31"><span class='Ref_to_Parameter'>arg1</span></a><span class='Parentheses'>) 
</span><span class='Directive'>#else</span> 
<a name="LN33"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>log_error</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>str</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>param</span><span class='Parentheses'>)</span>   <span class='Parentheses'>(</span><a href="../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><a href="exec.c.html#LN33"><span class='Ref_to_Parameter'>str</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN33"><span class='Ref_to_Parameter'>param</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span>fputc<span class='Parentheses'>(</span><span class='String'>'\n'</span><span class='Delimiter'>, </span>stderr<span class='Parentheses'>))</span> 
<a name="LN34"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>log_error4</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>str</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>param</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>arg1</span><span class='Parentheses'>)</span>    <span class='Parentheses'>(</span><a href="../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><a href="exec.c.html#LN34"><span class='Ref_to_Parameter'>str</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN34"><span class='Ref_to_Parameter'>param</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN34"><span class='Ref_to_Parameter'>arg1</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span>fputc<span class='Parentheses'>(</span><span class='String'>'\n'</span><span class='Delimiter'>, </span>stderr<span class='Parentheses'>))</span> 
<span class='Directive'>#endif</span> 
 
<span class='Directive'>#ifdef</span> _MSC_VER 
<a name="LN38"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>getcwd</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>cwd</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>len</span><span class='Parentheses'>)</span>  GetCurrentDirectory<span class='Parentheses'>(</span><a href="exec.c.html#LN38"><span class='Ref_to_Parameter'>len</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN38"><span class='Ref_to_Parameter'>cwd</span></a><span class='Parentheses'>) 
</span><span class='Directive'>#endif</span> 
 
<a name="LN41"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>validate_exec</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>path</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN42"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>resolve_symlinks</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>path</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN43"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Prototype'>pipe_read_line</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>cmd</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>line</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>maxsize</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN46"></a><span class='Keyword'>static </span>BOOL <span class='Declare_Prototype'>GetTokenUser</span><span class='Parentheses'>(</span>HANDLE <span class='Declare_Parameter'>hToken</span><span class='Delimiter'>, </span>PTOKEN_USER <span class='Operator'>*</span><span class='Declare_Parameter'>ppTokenUser</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* 
 * validate_exec -- validate "path" as an executable file 
 * 
 * returns 0 if the file is found and no error is encountered. 
 *        -1 if the regular file "path" does not exist or cannot be executed. 
 *        -2 if the file is otherwise valid but cannot be read. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN57"></a><span class='Declare_Function'>validate_exec</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>path</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN59"></a>    <span class='Control'>struct</span> <a href="../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN60"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>is_r</span><span class='Delimiter'>; 
</span><a name="LN61"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>is_x</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN64"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>path_exe</span><span class='Delimiter'>[</span><a href="../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='String'>".exe"</span><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* Win32 requires a .exe suffix for stat() */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="exec.c.html#LN57"><span class='Ref_to_Parameter'>path</span></a><span class='Parentheses'>)</span> <span class='Operator'>&GT;= </span>strlen<span class='Parentheses'>(</span><span class='String'>".exe"</span><span class='Parentheses'>)</span> <span class='Operator'>&& 
</span>        <a href="../port/pgstrcasecmp.c.html#LN34"><span class='Ref_to_Func'>pg_strcasecmp</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN57"><span class='Ref_to_Parameter'>path</span></a> <span class='Operator'>+ </span>strlen<span class='Parentheses'>(</span><a href="exec.c.html#LN57"><span class='Ref_to_Parameter'>path</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span>strlen<span class='Parentheses'>(</span><span class='String'>".exe"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>".exe"</span><span class='Parentheses'>)</span> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN64"><span class='Ref_To_Local'>path_exe</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN57"><span class='Ref_to_Parameter'>path</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="exec.c.html#LN64"><span class='Ref_To_Local'>path_exe</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        strcat<span class='Parentheses'>(</span><a href="exec.c.html#LN64"><span class='Ref_To_Local'>path_exe</span></a><span class='Delimiter'>, </span><span class='String'>".exe"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="exec.c.html#LN57"><span class='Ref_to_Parameter'>path</span></a> <span class='Operator'>= </span><a href="exec.c.html#LN64"><span class='Ref_To_Local'>path_exe</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Ensure that the file exists and is a regular file. 
     * 
     * XXX if you have a broken system where stat() looks at the symlink 
     * instead of the underlying file, you lose. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN57"><span class='Ref_to_Parameter'>path</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="exec.c.html#LN59"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../include/port/win32.h.html#LN430"><span class='Ref_to_Macro'>S_ISREG</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN59"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span>st_mode<span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Ensure that the file is both executable and readable (required for 
     * dynamic loading). 
     */ 
</span><span class='Directive'>#ifndef</span> <a href="../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <a href="exec.c.html#LN60"><span class='Ref_To_Local'>is_r</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span>access<span class='Parentheses'>(</span><a href="exec.c.html#LN57"><span class='Ref_to_Parameter'>path</span></a><span class='Delimiter'>, </span><a href="../include/port/win32.h.html#LN434"><span class='Ref_to_Const'>R_OK</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="exec.c.html#LN61"><span class='Ref_To_Local'>is_x</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span>access<span class='Parentheses'>(</span><a href="exec.c.html#LN57"><span class='Ref_to_Parameter'>path</span></a><span class='Delimiter'>, </span>X_OK<span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
    <a href="exec.c.html#LN60"><span class='Ref_To_Local'>is_r</span></a> <span class='Operator'>= </span><a href="exec.c.html#LN59"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span>st_mode <span class='Operator'>& </span><a href="../include/port/win32.h.html#LN424"><span class='Ref_to_Const'>S_IRUSR</span></a><span class='Delimiter'>; 
</span>    <a href="exec.c.html#LN61"><span class='Ref_To_Local'>is_x</span></a> <span class='Operator'>= </span><a href="exec.c.html#LN59"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span>st_mode <span class='Operator'>& </span><a href="../include/port/win32.h.html#LN426"><span class='Ref_to_Const'>S_IXUSR</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <span class='Control'>return</span> <a href="exec.c.html#LN61"><span class='Ref_To_Local'>is_x</span></a> <span class='Operator'>? </span><span class='Parentheses'>(</span><a href="exec.c.html#LN60"><span class='Ref_To_Local'>is_r</span></a> <span class='Operator'>? </span><span class='Number'>0</span> <span class='Operator'>: -</span><span class='Number'>2</span><span class='Parentheses'>) </span><span class='Operator'>: -</span><span class='Number'>1</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end validate_exec &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * find_my_exec -- find an absolute path to a valid executable 
 * 
 *  argv0 is the name passed on the command line 
 *  retpath is the output area (must be of size MAXPGPATH) 
 *  Returns 0 if OK, -1 if error. 
 * 
 * The reason we have to work so hard to find an absolute path is that 
 * on some platforms we can't do dynamic loading unless we know the 
 * executable's location.  Also, we need a full path not a relative 
 * path because we will later change working directory.  Finally, we want 
 * a true path not a symlink location, so that we can locate other files 
 * that are part of our installation relative to the executable. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN118"></a><span class='Declare_Function'>find_my_exec</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>argv0</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>retpath</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN120"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>cwd</span><span class='Delimiter'>[</span><a href="../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>], 
</span><a name="LN121"></a>                <span class='Declare_Local'>test_path</span><span class='Delimiter'>[</span><a href="../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN122"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>path</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="exec.c.html#LN38"><span class='Ref_to_Macro'>getcwd</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN120"><span class='Ref_To_Local'>cwd</span></a><span class='Delimiter'>, </span><a href="../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="exec.c.html#LN30"><span class='Ref_to_Macro'>log_error</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"could not identify current directory: %s"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                  <a href="../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If argv0 contains a separator, then PATH wasn't used. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../include/port.h.html#LN37"><span class='Ref_to_Proto'>first_dir_separator</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN118"><span class='Ref_to_Parameter'>argv0</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../include/port.h.html#LN76"><span class='Ref_to_Macro'>is_absolute_path</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN118"><span class='Ref_to_Parameter'>argv0</span></a><span class='Parentheses'>))</span> 
            <a href="../include/c.h.html#LN829"><span class='Ref_to_Macro'>StrNCpy</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN118"><span class='Ref_to_Parameter'>retpath</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN118"><span class='Ref_to_Parameter'>argv0</span></a><span class='Delimiter'>, </span><a href="../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../include/port.h.html#LN40"><span class='Ref_to_Proto'>join_path_components</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN118"><span class='Ref_to_Parameter'>retpath</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN120"><span class='Ref_To_Local'>cwd</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN118"><span class='Ref_to_Parameter'>argv0</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../include/port.h.html#LN42"><span class='Ref_to_Proto'>canonicalize_path</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN118"><span class='Ref_to_Parameter'>retpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../bin/pg_upgrade/exec.c.html#LN18"><span class='Ref_to_Proto'>validate_exec</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN118"><span class='Ref_to_Parameter'>retpath</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>return</span> <a href="exec.c.html#LN42"><span class='Ref_to_Proto'>resolve_symlinks</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN118"><span class='Ref_to_Parameter'>retpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="exec.c.html#LN30"><span class='Ref_to_Macro'>log_error</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"invalid binary \"%s\""</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="exec.c.html#LN118"><span class='Ref_to_Parameter'>retpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
<span class='Directive'>#ifdef</span> <a href="../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <span class='Comment_Multi_Line'>/* Win32 checks the current directory first for names without slashes */ 
</span>    <a href="../include/port.h.html#LN40"><span class='Ref_to_Proto'>join_path_components</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN118"><span class='Ref_to_Parameter'>retpath</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN120"><span class='Ref_To_Local'>cwd</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN118"><span class='Ref_to_Parameter'>argv0</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../bin/pg_upgrade/exec.c.html#LN18"><span class='Ref_to_Proto'>validate_exec</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN118"><span class='Ref_to_Parameter'>retpath</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <a href="exec.c.html#LN42"><span class='Ref_to_Proto'>resolve_symlinks</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN118"><span class='Ref_to_Parameter'>retpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Since no explicit path was supplied, the user must have been relying on 
     * PATH.  We'll search the same PATH. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="exec.c.html#LN122"><span class='Ref_To_Local'>path</span></a> <span class='Operator'>= </span>getenv<span class='Parentheses'>(</span><span class='String'>"PATH"</span><span class='Parentheses'>))</span> <span class='Operator'>&& *</span><a href="exec.c.html#LN122"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN162"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>startp</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span><a name="LN163"></a>                   <span class='Operator'>*</span><span class='Declare_Local'>endp</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>do</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="exec.c.html#LN162"><span class='Ref_To_Local'>startp</span></a><span class='Parentheses'>) 
</span>                <a href="exec.c.html#LN162"><span class='Ref_To_Local'>startp</span></a> <span class='Operator'>= </span><a href="exec.c.html#LN122"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="exec.c.html#LN162"><span class='Ref_To_Local'>startp</span></a> <span class='Operator'>= </span><a href="exec.c.html#LN163"><span class='Ref_To_Local'>endp</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
            <a href="exec.c.html#LN163"><span class='Ref_To_Local'>endp</span></a> <span class='Operator'>= </span><a href="../include/port.h.html#LN39"><span class='Ref_to_Proto'>first_path_var_separator</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN162"><span class='Ref_To_Local'>startp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="exec.c.html#LN163"><span class='Ref_To_Local'>endp</span></a><span class='Parentheses'>) 
</span>                <a href="exec.c.html#LN163"><span class='Ref_To_Local'>endp</span></a> <span class='Operator'>= </span><a href="exec.c.html#LN162"><span class='Ref_To_Local'>startp</span></a> <span class='Operator'>+ </span>strlen<span class='Parentheses'>(</span><a href="exec.c.html#LN162"><span class='Ref_To_Local'>startp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* point to end */ 
</span> 
            <a href="../include/c.h.html#LN829"><span class='Ref_to_Macro'>StrNCpy</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN121"><span class='Ref_To_Local'>test_path</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN162"><span class='Ref_To_Local'>startp</span></a><span class='Delimiter'>, </span><a href="../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN163"><span class='Ref_To_Local'>endp</span></a> <span class='Operator'>- </span><a href="exec.c.html#LN162"><span class='Ref_To_Local'>startp</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../include/port.h.html#LN76"><span class='Ref_to_Macro'>is_absolute_path</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN121"><span class='Ref_To_Local'>test_path</span></a><span class='Parentheses'>))</span> 
                <a href="../include/port.h.html#LN40"><span class='Ref_to_Proto'>join_path_components</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN118"><span class='Ref_to_Parameter'>retpath</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN121"><span class='Ref_To_Local'>test_path</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN118"><span class='Ref_to_Parameter'>argv0</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../include/port.h.html#LN40"><span class='Ref_to_Proto'>join_path_components</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN118"><span class='Ref_to_Parameter'>retpath</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN120"><span class='Ref_To_Local'>cwd</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN121"><span class='Ref_To_Local'>test_path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../include/port.h.html#LN40"><span class='Ref_to_Proto'>join_path_components</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN118"><span class='Ref_to_Parameter'>retpath</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN118"><span class='Ref_to_Parameter'>retpath</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN118"><span class='Ref_to_Parameter'>argv0</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="../include/port.h.html#LN42"><span class='Ref_to_Proto'>canonicalize_path</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN118"><span class='Ref_to_Parameter'>retpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="../bin/pg_upgrade/exec.c.html#LN18"><span class='Ref_to_Proto'>validate_exec</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN118"><span class='Ref_to_Parameter'>retpath</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Control'>case</span> <span class='Number'>0</span><span class='Operator'>: </span><span class='Comment_Single_Line'>/* found ok */ 
</span>                    <span class='Control'>return</span> <a href="exec.c.html#LN42"><span class='Ref_to_Proto'>resolve_symlinks</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN118"><span class='Ref_to_Parameter'>retpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>case</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Operator'>:</span>        <span class='Comment_Single_Line'>/* wasn't even a candidate, keep looking */ 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Control'>case</span> <span class='Operator'>-</span><span class='Number'>2</span><span class='Operator'>:</span>        <span class='Comment_Single_Line'>/* found but disqualified */ 
</span>                    <a href="exec.c.html#LN30"><span class='Ref_to_Macro'>log_error</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"could not read binary \"%s\""</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                              <a href="exec.c.html#LN118"><span class='Ref_to_Parameter'>retpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end do &raquo; </span> <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="exec.c.html#LN163"><span class='Ref_To_Local'>endp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if (path=getenv("PATH"))... &raquo; </span> 
 
    <a href="exec.c.html#LN30"><span class='Ref_to_Macro'>log_error</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"could not find a \"%s\" to execute"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="exec.c.html#LN118"><span class='Ref_to_Parameter'>argv0</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end find_my_exec &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * resolve_symlinks - resolve symlinks to the underlying file 
 * 
 * Replace "path" by the absolute path to the referenced file. 
 * 
 * Returns 0 if OK, -1 if error. 
 * 
 * Note: we are not particularly tense about producing nice error messages 
 * because we are not really expecting error here; we just determined that 
 * the symlink does point to a valid executable. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN218"></a><span class='Declare_Function'>resolve_symlinks</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>path</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> HAVE_READLINK 
<a name="LN221"></a>    <span class='Control'>struct</span> <a href="../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN222"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>orig_wd</span><span class='Delimiter'>[</span><a href="../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>], 
</span><a name="LN223"></a>                <span class='Declare_Local'>link_buf</span><span class='Delimiter'>[</span><a href="../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN224"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>fname</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * To resolve a symlink properly, we have to chdir into its directory and 
     * then chdir to where the symlink points; otherwise we may fail to 
     * resolve relative links correctly (consider cases involving mount 
     * points, for example).  After following the final symlink, we use 
     * getcwd() to figure out where the heck we're at. 
     * 
     * One might think we could skip all this if path doesn't point to a 
     * symlink to start with, but that's wrong.  We also want to get rid of 
     * any directory symlinks that are present in the given path. We expect 
     * getcwd() to give us an accurate, symlink-free path. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="exec.c.html#LN38"><span class='Ref_to_Macro'>getcwd</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN222"><span class='Ref_To_Local'>orig_wd</span></a><span class='Delimiter'>, </span><a href="../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="exec.c.html#LN30"><span class='Ref_to_Macro'>log_error</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"could not identify current directory: %s"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                  <a href="../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN247"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>lsep</span><span class='Delimiter'>; 
</span><a name="LN248"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>rllen</span><span class='Delimiter'>; 
</span> 
        <a href="exec.c.html#LN247"><span class='Ref_To_Local'>lsep</span></a> <span class='Operator'>= </span><a href="../include/port.h.html#LN38"><span class='Ref_to_Proto'>last_dir_separator</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN218"><span class='Ref_to_Parameter'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="exec.c.html#LN247"><span class='Ref_To_Local'>lsep</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Operator'>*</span><a href="exec.c.html#LN247"><span class='Ref_To_Local'>lsep</span></a> <span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>chdir<span class='Parentheses'>(</span><a href="exec.c.html#LN218"><span class='Ref_to_Parameter'>path</span></a><span class='Parentheses'>) </span><span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="exec.c.html#LN31"><span class='Ref_to_Macro'>log_error4</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"could not change directory to \"%s\": %s"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="exec.c.html#LN218"><span class='Ref_to_Parameter'>path</span></a><span class='Delimiter'>, </span><a href="../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="exec.c.html#LN224"><span class='Ref_To_Local'>fname</span></a> <span class='Operator'>= </span><a href="exec.c.html#LN247"><span class='Ref_To_Local'>lsep</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="exec.c.html#LN224"><span class='Ref_To_Local'>fname</span></a> <span class='Operator'>= </span><a href="exec.c.html#LN218"><span class='Ref_to_Parameter'>path</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../include/port/win32.h.html#LN261"><span class='Ref_to_Macro'>lstat</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN224"><span class='Ref_To_Local'>fname</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="exec.c.html#LN221"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>            <span class='Operator'>!</span>S_ISLNK<span class='Parentheses'>(</span><a href="exec.c.html#LN221"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span>st_mode<span class='Parentheses'>))</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <a href="exec.c.html#LN248"><span class='Ref_To_Local'>rllen</span></a> <span class='Operator'>= </span><a href="../include/port.h.html#LN256"><span class='Ref_to_Macro'>readlink</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN224"><span class='Ref_To_Local'>fname</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN223"><span class='Ref_To_Local'>link_buf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="exec.c.html#LN223"><span class='Ref_To_Local'>link_buf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="exec.c.html#LN248"><span class='Ref_To_Local'>rllen</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="exec.c.html#LN248"><span class='Ref_To_Local'>rllen</span></a> <span class='Operator'>&GT;= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="exec.c.html#LN223"><span class='Ref_To_Local'>link_buf</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="exec.c.html#LN30"><span class='Ref_to_Macro'>log_error</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"could not read symbolic link \"%s\""</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="exec.c.html#LN224"><span class='Ref_To_Local'>fname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="exec.c.html#LN223"><span class='Ref_To_Local'>link_buf</span></a><span class='Delimiter'>[</span><a href="exec.c.html#LN248"><span class='Ref_To_Local'>rllen</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>        <a href="../../contrib/cube/cubeparse.y.html#LN150"><span class='Ref_to_Proto'>strcpy</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN218"><span class='Ref_to_Parameter'>path</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN223"><span class='Ref_To_Local'>link_buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* must copy final component out of 'path' temporarily */ 
</span>    <a href="../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN223"><span class='Ref_To_Local'>link_buf</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN224"><span class='Ref_To_Local'>fname</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="exec.c.html#LN223"><span class='Ref_To_Local'>link_buf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="exec.c.html#LN38"><span class='Ref_to_Macro'>getcwd</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN218"><span class='Ref_to_Parameter'>path</span></a><span class='Delimiter'>, </span><a href="../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="exec.c.html#LN30"><span class='Ref_to_Macro'>log_error</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"could not identify current directory: %s"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                  <a href="../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../include/port.h.html#LN40"><span class='Ref_to_Proto'>join_path_components</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN218"><span class='Ref_to_Parameter'>path</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN218"><span class='Ref_to_Parameter'>path</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN223"><span class='Ref_To_Local'>link_buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../include/port.h.html#LN42"><span class='Ref_to_Proto'>canonicalize_path</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN218"><span class='Ref_to_Parameter'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>chdir<span class='Parentheses'>(</span><a href="exec.c.html#LN222"><span class='Ref_To_Local'>orig_wd</span></a><span class='Parentheses'>) </span><span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="exec.c.html#LN31"><span class='Ref_to_Macro'>log_error4</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"could not change directory to \"%s\": %s"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="exec.c.html#LN222"><span class='Ref_To_Local'>orig_wd</span></a><span class='Delimiter'>, </span><a href="../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* HAVE_READLINK */ 
</span> 
    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end resolve_symlinks &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Find another program in our binary's directory, 
 * then make sure it is the proper version. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN306"></a><span class='Declare_Function'>find_other_exec</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>argv0</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>target</span><span class='Delimiter'>, 
</span><a name="LN307"></a>                <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>versionstr</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>retpath</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN309"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>cmd</span><span class='Delimiter'>[</span><a href="../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN310"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>line</span><span class='Delimiter'>[</span><span class='Number'>100</span><span class='Delimiter'>]; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../include/port.h.html#LN96"><span class='Ref_to_Proto'>find_my_exec</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN306"><span class='Ref_to_Parameter'>argv0</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN307"><span class='Ref_to_Parameter'>retpath</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Trim off program name and keep just directory */ 
</span>    <span class='Operator'>*</span><a href="../include/port.h.html#LN38"><span class='Ref_to_Proto'>last_dir_separator</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN307"><span class='Ref_to_Parameter'>retpath</span></a><span class='Parentheses'>) </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>    <a href="../include/port.h.html#LN42"><span class='Ref_to_Proto'>canonicalize_path</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN307"><span class='Ref_to_Parameter'>retpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Now append the other program's name */ 
</span>    <a href="../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN307"><span class='Ref_to_Parameter'>retpath</span></a> <span class='Operator'>+ </span>strlen<span class='Parentheses'>(</span><a href="exec.c.html#LN307"><span class='Ref_to_Parameter'>retpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a> <span class='Operator'>- </span>strlen<span class='Parentheses'>(</span><a href="exec.c.html#LN307"><span class='Ref_to_Parameter'>retpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <span class='String'>"/%s%s"</span><span class='Delimiter'>, </span><a href="exec.c.html#LN306"><span class='Ref_to_Parameter'>target</span></a><span class='Delimiter'>, </span><a href="../include/port.h.html#LN107"><span class='Ref_to_Const'>EXE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../bin/pg_upgrade/exec.c.html#LN18"><span class='Ref_to_Proto'>validate_exec</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN307"><span class='Ref_to_Parameter'>retpath</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <a href="../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN309"><span class='Ref_To_Local'>cmd</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="exec.c.html#LN309"><span class='Ref_To_Local'>cmd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"\"%s\" -V"</span><span class='Delimiter'>, </span><a href="exec.c.html#LN307"><span class='Ref_to_Parameter'>retpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="exec.c.html#LN43"><span class='Ref_to_Proto'>pipe_read_line</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN309"><span class='Ref_To_Local'>cmd</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN310"><span class='Ref_To_Local'>line</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="exec.c.html#LN310"><span class='Ref_To_Local'>line</span></a><span class='Parentheses'>)))</span> 
        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="exec.c.html#LN310"><span class='Ref_To_Local'>line</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN307"><span class='Ref_to_Parameter'>versionstr</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>2</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end find_other_exec &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * The runtime library's popen() on win32 does not work when being 
 * called from a service when running on windows &LT;= 2000, because 
 * there is no stdin/stdout/stderr. 
 * 
 * Executing a command in a pipe and reading the first line from it 
 * is all we need. 
 */ 
</span><span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN347"></a><span class='Declare_Function'>pipe_read_line</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>cmd</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>line</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>maxsize</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifndef</span> <a href="../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN350"></a>    FILE       <span class='Operator'>*</span><span class='Declare_Local'>pgver</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* flush output buffers in case popen does not... */ 
</span>    fflush<span class='Parentheses'>(</span>stdout<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    fflush<span class='Parentheses'>(</span>stderr<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    errno <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="exec.c.html#LN350"><span class='Ref_To_Local'>pgver</span></a> <span class='Operator'>= </span><a href="../include/port.h.html#LN313"><span class='Ref_to_Macro'>popen</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN347"><span class='Ref_to_Parameter'>cmd</span></a><span class='Delimiter'>, </span><span class='String'>"r"</span><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        perror<span class='Parentheses'>(</span><span class='String'>"popen failure"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    errno <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>fgets<span class='Parentheses'>(</span><a href="exec.c.html#LN347"><span class='Ref_to_Parameter'>line</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN347"><span class='Ref_to_Parameter'>maxsize</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN350"><span class='Ref_To_Local'>pgver</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>feof<span class='Parentheses'>(</span><a href="exec.c.html#LN350"><span class='Ref_To_Local'>pgver</span></a><span class='Parentheses'>))</span> 
            <a href="../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"no data was returned by command \"%s\"\n"</span><span class='Delimiter'>, </span><a href="exec.c.html#LN347"><span class='Ref_to_Parameter'>cmd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            perror<span class='Parentheses'>(</span><span class='String'>"fgets failure"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../include/port.h.html#LN314"><span class='Ref_to_Macro'>pclose</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN350"><span class='Ref_To_Local'>pgver</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* no error checking */ 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../include/port.h.html#LN214"><span class='Ref_to_Proto'>pclose_check</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN350"><span class='Ref_To_Local'>pgver</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="exec.c.html#LN347"><span class='Ref_to_Parameter'>line</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#else</span>                           <span class='Comment_Single_Line'>/* WIN32 */ 
</span> 
<a name="LN380"></a>    SECURITY_ATTRIBUTES <span class='Declare_Local'>sattr</span><span class='Delimiter'>; 
</span><a name="LN381"></a>    HANDLE      <span class='Declare_Local'>childstdoutrd</span><span class='Delimiter'>, 
</span><a name="LN382"></a>                <span class='Declare_Local'>childstdoutwr</span><span class='Delimiter'>, 
</span><a name="LN383"></a>                <span class='Declare_Local'>childstdoutrddup</span><span class='Delimiter'>; 
</span><a name="LN384"></a>    PROCESS_INFORMATION <span class='Declare_Local'>pi</span><span class='Delimiter'>; 
</span><a name="LN385"></a>    STARTUPINFO <span class='Declare_Local'>si</span><span class='Delimiter'>; 
</span><a name="LN386"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>retval</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="exec.c.html#LN380"><span class='Ref_To_Local'>sattr</span></a><span class='Operator'>.</span>nLength <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span>SECURITY_ATTRIBUTES<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="exec.c.html#LN380"><span class='Ref_To_Local'>sattr</span></a><span class='Operator'>.</span>bInheritHandle <span class='Operator'>= </span><span class='Boolean'>TRUE</span><span class='Delimiter'>; 
</span>    <a href="exec.c.html#LN380"><span class='Ref_To_Local'>sattr</span></a><span class='Operator'>.</span>lpSecurityDescriptor <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>CreatePipe<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="exec.c.html#LN381"><span class='Ref_To_Local'>childstdoutrd</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="exec.c.html#LN382"><span class='Ref_To_Local'>childstdoutwr</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="exec.c.html#LN380"><span class='Ref_To_Local'>sattr</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>DuplicateHandle<span class='Parentheses'>(</span>GetCurrentProcess<span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                         <a href="exec.c.html#LN381"><span class='Ref_To_Local'>childstdoutrd</span></a><span class='Delimiter'>, 
</span>                         GetCurrentProcess<span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                         <span class='Operator'>&</span><a href="exec.c.html#LN383"><span class='Ref_To_Local'>childstdoutrddup</span></a><span class='Delimiter'>, 
</span>                         <span class='Number'>0</span><span class='Delimiter'>, 
</span>                         <span class='Boolean'>FALSE</span><span class='Delimiter'>, 
</span>                         DUPLICATE_SAME_ACCESS<span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        CloseHandle<span class='Parentheses'>(</span><a href="exec.c.html#LN381"><span class='Ref_To_Local'>childstdoutrd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        CloseHandle<span class='Parentheses'>(</span><a href="exec.c.html#LN382"><span class='Ref_To_Local'>childstdoutwr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    CloseHandle<span class='Parentheses'>(</span><a href="exec.c.html#LN381"><span class='Ref_To_Local'>childstdoutrd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    ZeroMemory<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="exec.c.html#LN384"><span class='Ref_To_Local'>pi</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="exec.c.html#LN384"><span class='Ref_To_Local'>pi</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    ZeroMemory<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="exec.c.html#LN385"><span class='Ref_To_Local'>si</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="exec.c.html#LN385"><span class='Ref_To_Local'>si</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="exec.c.html#LN385"><span class='Ref_To_Local'>si</span></a><span class='Operator'>.</span>cb <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="exec.c.html#LN385"><span class='Ref_To_Local'>si</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="exec.c.html#LN385"><span class='Ref_To_Local'>si</span></a><span class='Operator'>.</span>dwFlags <span class='Operator'>= </span>STARTF_USESTDHANDLES<span class='Delimiter'>; 
</span>    <a href="exec.c.html#LN385"><span class='Ref_To_Local'>si</span></a><span class='Operator'>.</span>hStdError <span class='Operator'>= </span><a href="exec.c.html#LN382"><span class='Ref_To_Local'>childstdoutwr</span></a><span class='Delimiter'>; 
</span>    <a href="exec.c.html#LN385"><span class='Ref_To_Local'>si</span></a><span class='Operator'>.</span>hStdOutput <span class='Operator'>= </span><a href="exec.c.html#LN382"><span class='Ref_To_Local'>childstdoutwr</span></a><span class='Delimiter'>; 
</span>    <a href="exec.c.html#LN385"><span class='Ref_To_Local'>si</span></a><span class='Operator'>.</span>hStdInput <span class='Operator'>= </span>INVALID_HANDLE_VALUE<span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>CreateProcess<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                      <a href="exec.c.html#LN347"><span class='Ref_to_Parameter'>cmd</span></a><span class='Delimiter'>, 
</span>                      <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                      <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                      <span class='Boolean'>TRUE</span><span class='Delimiter'>, 
</span>                      <span class='Number'>0</span><span class='Delimiter'>, 
</span>                      <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                      <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                      <span class='Operator'>&</span><a href="exec.c.html#LN385"><span class='Ref_To_Local'>si</span></a><span class='Delimiter'>, 
</span>                      <span class='Operator'>&</span><a href="exec.c.html#LN384"><span class='Ref_To_Local'>pi</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Successfully started the process */ 
</span><a name="LN430"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>lineptr</span><span class='Delimiter'>; 
</span> 
        ZeroMemory<span class='Parentheses'>(</span><a href="exec.c.html#LN347"><span class='Ref_to_Parameter'>line</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN347"><span class='Ref_to_Parameter'>maxsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Try to read at least one line from the pipe */ 
</span>        <span class='Comment_Multi_Line'>/* This may require more than one wait/read attempt */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="exec.c.html#LN430"><span class='Ref_To_Local'>lineptr</span></a> <span class='Operator'>= </span><a href="exec.c.html#LN347"><span class='Ref_to_Parameter'>line</span></a><span class='Delimiter'>; </span><a href="exec.c.html#LN430"><span class='Ref_To_Local'>lineptr</span></a> <span class='Operator'>&LT; </span><a href="exec.c.html#LN347"><span class='Ref_to_Parameter'>line</span></a> <span class='Operator'>+ </span><a href="exec.c.html#LN347"><span class='Ref_to_Parameter'>maxsize</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>;</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN438"></a>            <span class='Keyword'>DWORD</span>       <span class='Declare_Local'>bytesread</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Let's see if we can read */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>WaitForSingleObject<span class='Parentheses'>(</span><a href="exec.c.html#LN383"><span class='Ref_To_Local'>childstdoutrddup</span></a><span class='Delimiter'>, </span><span class='Number'>10000</span><span class='Parentheses'>) </span><span class='Operator'>!= </span>WAIT_OBJECT_0<span class='Parentheses'>)</span> 
                <span class='Control'>break</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* Timeout, but perhaps we got a line already */ 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>ReadFile<span class='Parentheses'>(</span><a href="exec.c.html#LN383"><span class='Ref_To_Local'>childstdoutrddup</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN430"><span class='Ref_To_Local'>lineptr</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN347"><span class='Ref_to_Parameter'>maxsize</span></a> <span class='Operator'>- </span><span class='Parentheses'>(</span><a href="exec.c.html#LN430"><span class='Ref_To_Local'>lineptr</span></a> <span class='Operator'>- </span><a href="exec.c.html#LN347"><span class='Ref_to_Parameter'>line</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                          <span class='Operator'>&</span><a href="exec.c.html#LN438"><span class='Ref_To_Local'>bytesread</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> 
                <span class='Control'>break</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* Error, but perhaps we got a line already */ 
</span> 
            <a href="exec.c.html#LN430"><span class='Ref_To_Local'>lineptr</span></a> <span class='Operator'>+= </span>strlen<span class='Parentheses'>(</span><a href="exec.c.html#LN430"><span class='Ref_To_Local'>lineptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="exec.c.html#LN438"><span class='Ref_To_Local'>bytesread</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>break</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* EOF */ 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span>strchr<span class='Parentheses'>(</span><a href="exec.c.html#LN347"><span class='Ref_to_Parameter'>line</span></a><span class='Delimiter'>, </span><span class='String'>'\n'</span><span class='Parentheses'>))</span> 
                <span class='Control'>break</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* One or more lines read */ 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for lineptr=line;lineptr&LT;... &raquo; </span> 
 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="exec.c.html#LN430"><span class='Ref_To_Local'>lineptr</span></a> <span class='Operator'>!= </span><a href="exec.c.html#LN347"><span class='Ref_to_Parameter'>line</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* OK, we read some data */ 
</span><a name="LN460"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* If we got more than one line, cut off after the first \n */ 
</span>            <a href="exec.c.html#LN430"><span class='Ref_To_Local'>lineptr</span></a> <span class='Operator'>= </span>strchr<span class='Parentheses'>(</span><a href="exec.c.html#LN347"><span class='Ref_to_Parameter'>line</span></a><span class='Delimiter'>, </span><span class='String'>'\n'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="exec.c.html#LN430"><span class='Ref_To_Local'>lineptr</span></a><span class='Parentheses'>) 
</span>                <span class='Operator'>*</span><span class='Parentheses'>(</span><a href="exec.c.html#LN430"><span class='Ref_To_Local'>lineptr</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span> 
            <a href="exec.c.html#LN460"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="exec.c.html#LN347"><span class='Ref_to_Parameter'>line</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If EOL is \r\n, convert to just \n. Because stdout is a 
             * text-mode stream, the \n output by the child process is 
             * received as \r\n, so we convert it to \n.  The server main.c 
             * sets setvbuf(stdout, NULL, _IONBF, 0) which has the effect of 
             * disabling \n to \r\n expansion for stdout. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="exec.c.html#LN460"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>&GT;= </span><span class='Number'>2</span> <span class='Operator'>&& </span><a href="exec.c.html#LN347"><span class='Ref_to_Parameter'>line</span></a><span class='Delimiter'>[</span><a href="exec.c.html#LN460"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>- </span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'\r'</span> <span class='Operator'>&& </span><a href="exec.c.html#LN347"><span class='Ref_to_Parameter'>line</span></a><span class='Delimiter'>[</span><a href="exec.c.html#LN460"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'\n'</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="exec.c.html#LN347"><span class='Ref_to_Parameter'>line</span></a><span class='Delimiter'>[</span><a href="exec.c.html#LN460"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>- </span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\n'</span><span class='Delimiter'>; 
</span>                <a href="exec.c.html#LN347"><span class='Ref_to_Parameter'>line</span></a><span class='Delimiter'>[</span><a href="exec.c.html#LN460"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>                <a href="exec.c.html#LN460"><span class='Ref_To_Local'>len</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * We emulate fgets() behaviour. So if there is no newline at the 
             * end, we add one... 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="exec.c.html#LN460"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="exec.c.html#LN347"><span class='Ref_to_Parameter'>line</span></a><span class='Delimiter'>[</span><a href="exec.c.html#LN460"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='String'>'\n'</span><span class='Parentheses'>) 
</span>                strcat<span class='Parentheses'>(</span><a href="exec.c.html#LN347"><span class='Ref_to_Parameter'>line</span></a><span class='Delimiter'>, </span><span class='String'>"\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="exec.c.html#LN386"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span><a href="exec.c.html#LN347"><span class='Ref_to_Parameter'>line</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if lineptr!=line &raquo; </span> 
 
        CloseHandle<span class='Parentheses'>(</span><a href="exec.c.html#LN384"><span class='Ref_To_Local'>pi</span></a><span class='Operator'>.</span>hProcess<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        CloseHandle<span class='Parentheses'>(</span><a href="exec.c.html#LN384"><span class='Ref_To_Local'>pi</span></a><span class='Operator'>.</span>hThread<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if CreateProcess(NULL,cm... &raquo; </span> 
 
    CloseHandle<span class='Parentheses'>(</span><a href="exec.c.html#LN382"><span class='Ref_To_Local'>childstdoutwr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    CloseHandle<span class='Parentheses'>(</span><a href="exec.c.html#LN383"><span class='Ref_To_Local'>childstdoutrddup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="exec.c.html#LN386"><span class='Ref_To_Local'>retval</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* WIN32 */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end pipe_read_line &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * pclose() plus useful error reporting 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN509"></a><span class='Declare_Function'>pclose_check</span><span class='Parentheses'>(</span>FILE <span class='Operator'>*</span><span class='Declare_Parameter'>stream</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN511"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>exitstatus</span><span class='Delimiter'>; 
</span><a name="LN512"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>reason</span><span class='Delimiter'>; 
</span> 
    <a href="exec.c.html#LN511"><span class='Ref_To_Local'>exitstatus</span></a> <span class='Operator'>= </span><a href="../include/port.h.html#LN314"><span class='Ref_to_Macro'>pclose</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN509"><span class='Ref_to_Parameter'>stream</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="exec.c.html#LN511"><span class='Ref_To_Local'>exitstatus</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>;</span>               <span class='Comment_Single_Line'>/* all is well */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="exec.c.html#LN511"><span class='Ref_To_Local'>exitstatus</span></a> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* pclose() itself failed, and hopefully set errno */ 
</span>        <a href="exec.c.html#LN30"><span class='Ref_to_Macro'>log_error</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"pclose failed: %s"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="exec.c.html#LN512"><span class='Ref_To_Local'>reason</span></a> <span class='Operator'>= </span><a href="wait_error.c.html#LN30"><span class='Ref_to_Func'>wait_result_to_str</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN511"><span class='Ref_To_Local'>exitstatus</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="exec.c.html#LN30"><span class='Ref_to_Macro'>log_error</span></a><span class='Parentheses'>(</span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="exec.c.html#LN512"><span class='Ref_To_Local'>reason</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> <a href="../bin/pg_waldump/rmgrdesc.c.html#LN7"><span class='Ref_to_Const'>FRONTEND</span></a> 
        <a href="../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN512"><span class='Ref_To_Local'>reason</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
        <a href="../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN512"><span class='Ref_To_Local'>reason</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <a href="exec.c.html#LN511"><span class='Ref_To_Local'>exitstatus</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pclose_check &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  set_pglocale_pgservice 
 * 
 *  Set application-specific locale and service directory 
 * 
 *  This function takes the value of argv[0] rather than a full path. 
 * 
 * (You may be wondering why this is in exec.c.  It requires this module's 
 * services and doesn't introduce any new dependencies, so this seems as 
 * good as anyplace.) 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN549"></a><span class='Declare_Function'>set_pglocale_pgservice</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>argv0</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>app</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN551"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>path</span><span class='Delimiter'>[</span><a href="../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN552"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>my_exec_path</span><span class='Delimiter'>[</span><a href="../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN553"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>env_path</span><span class='Delimiter'>[</span><a href="../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='String'>"PGSYSCONFDIR="</span><span class='Parentheses'>)</span><span class='Delimiter'>];</span>  <span class='Comment_Multi_Line'>/* longer than 
                                                                 * PGLOCALEDIR */ 
</span><a name="LN555"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>dup_path</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* don't set LC_ALL in the backend */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="exec.c.html#LN549"><span class='Ref_to_Parameter'>app</span></a><span class='Delimiter'>, </span><a href="../include/c.h.html#LN1009"><span class='Ref_to_Macro'>PG_TEXTDOMAIN</span></a><span class='Parentheses'>(</span><span class='String'>"postgres"</span><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../include/port.h.html#LN201"><span class='Ref_to_Macro'>setlocale</span></a><span class='Parentheses'>(</span>LC_ALL<span class='Delimiter'>, </span><span class='String'>""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * One could make a case for reproducing here PostmasterMain()'s test 
         * for whether the process is multithreaded.  Unlike the postmaster, 
         * no frontend program calls sigprocmask() or otherwise provides for 
         * mutual exclusion between signal handlers.  While frontends using 
         * fork(), if multithreaded, are formally exposed to undefined 
         * behavior, we have not witnessed a concrete bug.  Therefore, 
         * complaining about multithreading here may be mere pedantry. 
         */ 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../include/port.h.html#LN96"><span class='Ref_to_Proto'>find_my_exec</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN549"><span class='Ref_to_Parameter'>argv0</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN552"><span class='Ref_To_Local'>my_exec_path</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> ENABLE_NLS 
    <a href="../include/port.h.html#LN57"><span class='Ref_to_Proto'>get_locale_path</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN552"><span class='Ref_To_Local'>my_exec_path</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN551"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    bindtextdomain<span class='Parentheses'>(</span><a href="exec.c.html#LN549"><span class='Ref_to_Parameter'>app</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN551"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    textdomain<span class='Parentheses'>(</span><a href="exec.c.html#LN549"><span class='Ref_to_Parameter'>app</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>getenv<span class='Parentheses'>(</span><span class='String'>"PGLOCALEDIR"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* set for libpq to use */ 
</span>        <a href="../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN553"><span class='Ref_To_Local'>env_path</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="exec.c.html#LN553"><span class='Ref_To_Local'>env_path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"PGLOCALEDIR=%s"</span><span class='Delimiter'>, </span><a href="exec.c.html#LN551"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../include/port.h.html#LN42"><span class='Ref_to_Proto'>canonicalize_path</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN553"><span class='Ref_To_Local'>env_path</span></a> <span class='Operator'>+ </span><span class='Number'>12</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="exec.c.html#LN555"><span class='Ref_To_Local'>dup_path</span></a> <span class='Operator'>= </span>strdup<span class='Parentheses'>(</span><a href="exec.c.html#LN553"><span class='Ref_To_Local'>env_path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="exec.c.html#LN555"><span class='Ref_To_Local'>dup_path</span></a><span class='Parentheses'>) 
</span>            <a href="../include/port/win32.h.html#LN410"><span class='Ref_to_Macro'>putenv</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN555"><span class='Ref_To_Local'>dup_path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>getenv<span class='Parentheses'>(</span><span class='String'>"PGSYSCONFDIR"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../include/port.h.html#LN51"><span class='Ref_to_Proto'>get_etc_path</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN552"><span class='Ref_To_Local'>my_exec_path</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN551"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* set for libpq to use */ 
</span>        <a href="../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN553"><span class='Ref_To_Local'>env_path</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="exec.c.html#LN553"><span class='Ref_To_Local'>env_path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"PGSYSCONFDIR=%s"</span><span class='Delimiter'>, </span><a href="exec.c.html#LN551"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../include/port.h.html#LN42"><span class='Ref_to_Proto'>canonicalize_path</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN553"><span class='Ref_To_Local'>env_path</span></a> <span class='Operator'>+ </span><span class='Number'>13</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="exec.c.html#LN555"><span class='Ref_To_Local'>dup_path</span></a> <span class='Operator'>= </span>strdup<span class='Parentheses'>(</span><a href="exec.c.html#LN553"><span class='Ref_To_Local'>env_path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="exec.c.html#LN555"><span class='Ref_To_Local'>dup_path</span></a><span class='Parentheses'>) 
</span>            <a href="../include/port/win32.h.html#LN410"><span class='Ref_to_Macro'>putenv</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN555"><span class='Ref_To_Local'>dup_path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end set_pglocale_pgservice &raquo; </span> 
 
<span class='Directive'>#ifdef</span> <a href="../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
 
<span class='Comment_Multi_Line'>/* 
 * AddUserToTokenDacl(HANDLE hToken) 
 * 
 * This function adds the current user account to the restricted 
 * token used when we create a restricted process. 
 * 
 * This is required because of some security changes in Windows 
 * that appeared in patches to XP/2K3 and in Vista/2008. 
 * 
 * On these machines, the Administrator account is not included in 
 * the default DACL - you just get Administrators + System. For 
 * regular users you get User + System. Because we strip Administrators 
 * when we create the restricted token, we are left with only System 
 * in the DACL which leads to access denied errors for later CreatePipe() 
 * and CreateProcess() calls when running as Administrator. 
 * 
 * This function fixes this problem by modifying the DACL of the 
 * token the process will use, and explicitly re-adding the current 
 * user account.  This is still secure because the Administrator account 
 * inherits its privileges from the Administrators group - it doesn't 
 * have any of its own. 
 */ 
</span>BOOL 
<a name="LN630"></a><span class='Declare_Function'>AddUserToTokenDacl</span><span class='Parentheses'>(</span>HANDLE <span class='Declare_Parameter'>hToken</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN632"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN633"></a>    ACL_SIZE_INFORMATION <span class='Declare_Local'>asi</span><span class='Delimiter'>; 
</span><a name="LN634"></a>    ACCESS_ALLOWED_ACE <span class='Operator'>*</span><span class='Declare_Local'>pace</span><span class='Delimiter'>; 
</span><a name="LN635"></a>    <span class='Keyword'>DWORD</span>       <span class='Declare_Local'>dwNewAclSize</span><span class='Delimiter'>; 
</span><a name="LN636"></a>    <span class='Keyword'>DWORD</span>       <span class='Declare_Local'>dwSize</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN637"></a>    <span class='Keyword'>DWORD</span>       <span class='Declare_Local'>dwTokenInfoLength</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN638"></a>    PACL        <span class='Declare_Local'>pacl</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN639"></a>    PTOKEN_USER <span class='Declare_Local'>pTokenUser</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN640"></a>    TOKEN_DEFAULT_DACL <span class='Declare_Local'>tddNew</span><span class='Delimiter'>; 
</span><a name="LN641"></a>    TOKEN_DEFAULT_DACL <span class='Operator'>*</span><span class='Declare_Local'>ptdd</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN642"></a>    TOKEN_INFORMATION_CLASS <span class='Declare_Local'>tic</span> <span class='Operator'>= </span>TokenDefaultDacl<span class='Delimiter'>; 
</span><a name="LN643"></a>    BOOL        <span class='Declare_Local'>ret</span> <span class='Operator'>= </span><span class='Boolean'>FALSE</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Figure out the buffer size for the DACL info */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>GetTokenInformation<span class='Parentheses'>(</span><a href="exec.c.html#LN630"><span class='Ref_to_Parameter'>hToken</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN642"><span class='Ref_To_Local'>tic</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span>LPVOID<span class='Parentheses'>) </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="exec.c.html#LN637"><span class='Ref_To_Local'>dwTokenInfoLength</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="exec.c.html#LN636"><span class='Ref_To_Local'>dwSize</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>GetLastError<span class='Parentheses'>() </span><span class='Operator'>== </span>ERROR_INSUFFICIENT_BUFFER<span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="exec.c.html#LN641"><span class='Ref_To_Local'>ptdd</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span>TOKEN_DEFAULT_DACL <span class='Operator'>*</span><span class='Parentheses'>) </span>LocalAlloc<span class='Parentheses'>(</span>LPTR<span class='Delimiter'>, </span><a href="exec.c.html#LN636"><span class='Ref_To_Local'>dwSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="exec.c.html#LN641"><span class='Ref_To_Local'>ptdd</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="exec.c.html#LN30"><span class='Ref_to_Macro'>log_error</span></a><span class='Parentheses'>(</span><span class='String'>"could not allocate %lu bytes of memory"</span><span class='Delimiter'>, </span><a href="exec.c.html#LN636"><span class='Ref_To_Local'>dwSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="exec.c.html#LN735"><span class='Ref_to_Label'>cleanup</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>GetTokenInformation<span class='Parentheses'>(</span><a href="exec.c.html#LN630"><span class='Ref_to_Parameter'>hToken</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN642"><span class='Ref_To_Local'>tic</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span>LPVOID<span class='Parentheses'>) </span><a href="exec.c.html#LN641"><span class='Ref_To_Local'>ptdd</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN636"><span class='Ref_To_Local'>dwSize</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="exec.c.html#LN636"><span class='Ref_To_Local'>dwSize</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="exec.c.html#LN30"><span class='Ref_to_Macro'>log_error</span></a><span class='Parentheses'>(</span><span class='String'>"could not get token information: error code %lu"</span><span class='Delimiter'>, </span>GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>                <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="exec.c.html#LN735"><span class='Ref_to_Label'>cleanup</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="exec.c.html#LN30"><span class='Ref_to_Macro'>log_error</span></a><span class='Parentheses'>(</span><span class='String'>"could not get token information buffer size: error code %lu"</span><span class='Delimiter'>, </span>GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="exec.c.html#LN735"><span class='Ref_to_Label'>cleanup</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !GetTokenInformation(... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Get the ACL info */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>GetAclInformation<span class='Parentheses'>(</span><a href="exec.c.html#LN641"><span class='Ref_To_Local'>ptdd</span></a><span class='Operator'>-&GT;</span>DefaultDacl<span class='Delimiter'>, </span><span class='Parentheses'>(</span>LPVOID<span class='Parentheses'>) </span><span class='Operator'>&</span><a href="exec.c.html#LN633"><span class='Ref_To_Local'>asi</span></a><span class='Delimiter'>, 
</span>                           <span class='Parentheses'>(</span><span class='Keyword'>DWORD</span><span class='Parentheses'>) </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span>ACL_SIZE_INFORMATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                           AclSizeInformation<span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="exec.c.html#LN30"><span class='Ref_to_Macro'>log_error</span></a><span class='Parentheses'>(</span><span class='String'>"could not get ACL information: error code %lu"</span><span class='Delimiter'>, </span>GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="exec.c.html#LN735"><span class='Ref_to_Label'>cleanup</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Get the current user SID */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="exec.c.html#LN46"><span class='Ref_to_Proto'>GetTokenUser</span></a><span class='Parentheses'>(</span><a href="exec.c.html#LN630"><span class='Ref_to_Parameter'>hToken</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="exec.c.html#LN639"><span class='Ref_To_Local'>pTokenUser</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="exec.c.html#LN735"><span class='Ref_to_Label'>cleanup</span></a><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* callee printed a message */ 
</span> 
    <span class='Comment_Multi_Line'>/* Figure out the size of the new ACL */ 
</span>    <a href="exec.c.html#LN635"><span class='Ref_To_Local'>dwNewAclSize</span></a> <span class='Operator'>= </span><a href="exec.c.html#LN633"><span class='Ref_To_Local'>asi</span></a><span class='Operator'>.</span>AclBytesInUse <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span>ACCESS_ALLOWED_ACE<span class='Parentheses'>) </span><span class='Operator'>+ 
</span>        GetLengthSid<span class='Parentheses'>(</span><a href="exec.c.html#LN639"><span class='Ref_To_Local'>pTokenUser</span></a><span class='Operator'>-&GT;</span>User<span class='Operator'>.</span>Sid<span class='Parentheses'>) </span><span class='Operator'>-</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>DWORD</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Allocate the ACL buffer & initialize it */ 
</span>    <a href="exec.c.html#LN638"><span class='Ref_To_Local'>pacl</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span>PACL<span class='Parentheses'>) </span>LocalAlloc<span class='Parentheses'>(</span>LPTR<span class='Delimiter'>, </span><a href="exec.c.html#LN635"><span class='Ref_To_Local'>dwNewAclSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="exec.c.html#LN638"><span class='Ref_To_Local'>pacl</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="exec.c.html#LN30"><span class='Ref_to_Macro'>log_error</span></a><span class='Parentheses'>(</span><span class='String'>"could not allocate %lu bytes of memory"</span><span class='Delimiter'>, </span><a href="exec.c.html#LN635"><span class='Ref_To_Local'>dwNewAclSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="exec.c.html#LN735"><span class='Ref_to_Label'>cleanup</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>InitializeAcl<span class='Parentheses'>(</span><a href="exec.c.html#LN638"><span class='Ref_To_Local'>pacl</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN635"><span class='Ref_To_Local'>dwNewAclSize</span></a><span class='Delimiter'>, </span>ACL_REVISION<span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="exec.c.html#LN30"><span class='Ref_to_Macro'>log_error</span></a><span class='Parentheses'>(</span><span class='String'>"could not initialize ACL: error code %lu"</span><span class='Delimiter'>, </span>GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="exec.c.html#LN735"><span class='Ref_to_Label'>cleanup</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Loop through the existing ACEs, and build the new ACL */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="exec.c.html#LN632"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="exec.c.html#LN632"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="exec.c.html#LN633"><span class='Ref_To_Local'>asi</span></a><span class='Operator'>.</span>AceCount<span class='Delimiter'>; </span><a href="exec.c.html#LN632"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>GetAce<span class='Parentheses'>(</span><a href="exec.c.html#LN641"><span class='Ref_To_Local'>ptdd</span></a><span class='Operator'>-&GT;</span>DefaultDacl<span class='Delimiter'>, </span><a href="exec.c.html#LN632"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span>LPVOID <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="exec.c.html#LN634"><span class='Ref_To_Local'>pace</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="exec.c.html#LN30"><span class='Ref_to_Macro'>log_error</span></a><span class='Parentheses'>(</span><span class='String'>"could not get ACE: error code %lu"</span><span class='Delimiter'>, </span>GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="exec.c.html#LN735"><span class='Ref_to_Label'>cleanup</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>AddAce<span class='Parentheses'>(</span><a href="exec.c.html#LN638"><span class='Ref_To_Local'>pacl</span></a><span class='Delimiter'>, </span>ACL_REVISION<span class='Delimiter'>, </span>MAXDWORD<span class='Delimiter'>, </span><a href="exec.c.html#LN634"><span class='Ref_To_Local'>pace</span></a><span class='Delimiter'>, </span><span class='Parentheses'>((</span>PACE_HEADER<span class='Parentheses'>) </span><a href="exec.c.html#LN634"><span class='Ref_To_Local'>pace</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>AceSize<span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="exec.c.html#LN30"><span class='Ref_to_Macro'>log_error</span></a><span class='Parentheses'>(</span><span class='String'>"could not add ACE: error code %lu"</span><span class='Delimiter'>, </span>GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="exec.c.html#LN735"><span class='Ref_to_Label'>cleanup</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Add the new ACE for the current user */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>AddAccessAllowedAceEx<span class='Parentheses'>(</span><a href="exec.c.html#LN638"><span class='Ref_To_Local'>pacl</span></a><span class='Delimiter'>, </span>ACL_REVISION<span class='Delimiter'>, </span>OBJECT_INHERIT_ACE<span class='Delimiter'>, </span>GENERIC_ALL<span class='Delimiter'>, </span><a href="exec.c.html#LN639"><span class='Ref_To_Local'>pTokenUser</span></a><span class='Operator'>-&GT;</span>User<span class='Operator'>.</span>Sid<span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="exec.c.html#LN30"><span class='Ref_to_Macro'>log_error</span></a><span class='Parentheses'>(</span><span class='String'>"could not add access allowed ACE: error code %lu"</span><span class='Delimiter'>, </span>GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="exec.c.html#LN735"><span class='Ref_to_Label'>cleanup</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Set the new DACL in the token */ 
</span>    <a href="exec.c.html#LN640"><span class='Ref_To_Local'>tddNew</span></a><span class='Operator'>.</span>DefaultDacl <span class='Operator'>= </span><a href="exec.c.html#LN638"><span class='Ref_To_Local'>pacl</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>SetTokenInformation<span class='Parentheses'>(</span><a href="exec.c.html#LN630"><span class='Ref_to_Parameter'>hToken</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN642"><span class='Ref_To_Local'>tic</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span>LPVOID<span class='Parentheses'>) </span><span class='Operator'>&</span><a href="exec.c.html#LN640"><span class='Ref_To_Local'>tddNew</span></a><span class='Delimiter'>, </span><a href="exec.c.html#LN635"><span class='Ref_To_Local'>dwNewAclSize</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="exec.c.html#LN30"><span class='Ref_to_Macro'>log_error</span></a><span class='Parentheses'>(</span><span class='String'>"could not set token information: error code %lu"</span><span class='Delimiter'>, </span>GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="exec.c.html#LN735"><span class='Ref_to_Label'>cleanup</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="exec.c.html#LN643"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><span class='Boolean'>TRUE</span><span class='Delimiter'>; 
</span> 
<a name="LN735"></a><span class='Label'>cleanup</span><span class='Operator'>: 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="exec.c.html#LN639"><span class='Ref_To_Local'>pTokenUser</span></a><span class='Parentheses'>) 
</span>        LocalFree<span class='Parentheses'>((</span>HLOCAL<span class='Parentheses'>) </span><a href="exec.c.html#LN639"><span class='Ref_To_Local'>pTokenUser</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="exec.c.html#LN638"><span class='Ref_To_Local'>pacl</span></a><span class='Parentheses'>) 
</span>        LocalFree<span class='Parentheses'>((</span>HLOCAL<span class='Parentheses'>) </span><a href="exec.c.html#LN638"><span class='Ref_To_Local'>pacl</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="exec.c.html#LN641"><span class='Ref_To_Local'>ptdd</span></a><span class='Parentheses'>) 
</span>        LocalFree<span class='Parentheses'>((</span>HLOCAL<span class='Parentheses'>) </span><a href="exec.c.html#LN641"><span class='Ref_To_Local'>ptdd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="exec.c.html#LN643"><span class='Ref_To_Local'>ret</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AddUserToTokenDacl &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * GetTokenUser(HANDLE hToken, PTOKEN_USER *ppTokenUser) 
 * 
 * Get the users token information from a process token. 
 * 
 * The caller of this function is responsible for calling LocalFree() on the 
 * returned TOKEN_USER memory. 
 */ 
</span><span class='Keyword'>static </span>BOOL 
<a name="LN757"></a><span class='Declare_Function'>GetTokenUser</span><span class='Parentheses'>(</span>HANDLE <span class='Declare_Parameter'>hToken</span><span class='Delimiter'>, </span>PTOKEN_USER <span class='Operator'>*</span><span class='Declare_Parameter'>ppTokenUser</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN759"></a>    <span class='Keyword'>DWORD</span>       <span class='Declare_Local'>dwLength</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="exec.c.html#LN757"><span class='Ref_to_Parameter'>ppTokenUser</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>GetTokenInformation<span class='Parentheses'>(</span><a href="exec.c.html#LN757"><span class='Ref_to_Parameter'>hToken</span></a><span class='Delimiter'>, 
</span>                             TokenUser<span class='Delimiter'>, 
</span>                             <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                             <span class='Number'>0</span><span class='Delimiter'>, 
</span>                             <span class='Operator'>&</span><a href="exec.c.html#LN759"><span class='Ref_To_Local'>dwLength</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>GetLastError<span class='Parentheses'>() </span><span class='Operator'>== </span>ERROR_INSUFFICIENT_BUFFER<span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Operator'>*</span><a href="exec.c.html#LN757"><span class='Ref_to_Parameter'>ppTokenUser</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span>PTOKEN_USER<span class='Parentheses'>) </span>LocalAlloc<span class='Parentheses'>(</span>LPTR<span class='Delimiter'>, </span><a href="exec.c.html#LN759"><span class='Ref_To_Local'>dwLength</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="exec.c.html#LN757"><span class='Ref_to_Parameter'>ppTokenUser</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="exec.c.html#LN30"><span class='Ref_to_Macro'>log_error</span></a><span class='Parentheses'>(</span><span class='String'>"could not allocate %lu bytes of memory"</span><span class='Delimiter'>, </span><a href="exec.c.html#LN759"><span class='Ref_To_Local'>dwLength</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <span class='Boolean'>FALSE</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="exec.c.html#LN30"><span class='Ref_to_Macro'>log_error</span></a><span class='Parentheses'>(</span><span class='String'>"could not get token information buffer size: error code %lu"</span><span class='Delimiter'>, </span>GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>FALSE</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !GetTokenInformation(... &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>GetTokenInformation<span class='Parentheses'>(</span><a href="exec.c.html#LN757"><span class='Ref_to_Parameter'>hToken</span></a><span class='Delimiter'>, 
</span>                             TokenUser<span class='Delimiter'>, 
</span>                             <span class='Operator'>*</span><a href="exec.c.html#LN757"><span class='Ref_to_Parameter'>ppTokenUser</span></a><span class='Delimiter'>, 
</span>                             <a href="exec.c.html#LN759"><span class='Ref_To_Local'>dwLength</span></a><span class='Delimiter'>, 
</span>                             <span class='Operator'>&</span><a href="exec.c.html#LN759"><span class='Ref_To_Local'>dwLength</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        LocalFree<span class='Parentheses'>(</span><span class='Operator'>*</span><a href="exec.c.html#LN757"><span class='Ref_to_Parameter'>ppTokenUser</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="exec.c.html#LN757"><span class='Ref_to_Parameter'>ppTokenUser</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <a href="exec.c.html#LN30"><span class='Ref_to_Macro'>log_error</span></a><span class='Parentheses'>(</span><span class='String'>"could not get token information: error code %lu"</span><span class='Delimiter'>, </span>GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>FALSE</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Memory in *ppTokenUser is LocalFree():d by the caller */ 
</span>    <span class='Control'>return</span> <span class='Boolean'>TRUE</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end GetTokenUser &raquo; </span> 
 
<span class='Directive'>#endif</span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>