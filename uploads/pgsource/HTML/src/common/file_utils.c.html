<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\common\file_utils.c</title>
<LINK REL=StyleSheet HREF="../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\common\file_utils.c</b></p></td>
<td align='right'>
Wed Jun 14 08:26:02 2017
</td></tr>
<tr><td><a href='../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
</span><span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * File-processing utility routines. 
 * 
 * Assorted utility functions to work on files. 
 * 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * src/common/file_utils.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres_fe.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;dirent.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;fcntl.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/stat.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"common/file_utils.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* Define PG_FLUSH_DATA_WORKS if we have an implementation for pg_flush_data */ 
</span><span class='Directive'>#if</span> defined<span class='Parentheses'>(</span>HAVE_SYNC_FILE_RANGE<span class='Parentheses'>) 
</span><a name="LN26"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PG_FLUSH_DATA_WORKS</span> <span class='Number'>1</span> 
<span class='Directive'>#elif</span> defined<span class='Parentheses'>(</span><a href="../include/pg_config_manual.h.html#LN136"><span class='Ref_to_Const'>USE_POSIX_FADVISE</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span>defined<span class='Parentheses'>(</span>POSIX_FADV_DONTNEED<span class='Parentheses'>) 
</span><a name="LN28"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PG_FLUSH_DATA_WORKS</span> <span class='Number'>1</span> 
<span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* 
 * pg_xlog has been renamed to pg_wal in version 10. 
 */ 
</span><a name="LN34"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MINIMUM_VERSION_FOR_PG_WAL</span>  <span class='Number'>100000</span> 
 
<span class='Directive'>#ifdef</span> <a href="file_utils.c.html#LN26"><span class='Ref_to_Const'>PG_FLUSH_DATA_WORKS</span></a> 
<a name="LN37"></a><span class='Keyword'>static int </span><span class='Declare_Prototype'>pre_sync_fname</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>fname</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isdir</span><span class='Delimiter'>, 
</span><a name="LN38"></a>               <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>progname</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<a name="LN40"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>walkdir</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>path</span><span class='Delimiter'>, 
</span><a name="LN41"></a>        <span class='Keyword'>int </span><span class='Parentheses'>(</span><span class='Operator'>*</span><span class='Declare_Parameter'>action</span><span class='Parentheses'>) (</span><span class='Keyword'>const char </span><span class='Operator'>*</span>fname<span class='Delimiter'>, </span><span class='Keyword'>bool </span>isdir<span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><a href="file_utils.c.html#LN42"><span class='Ref_to_Parameter'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span><a name="LN42"></a>        <span class='Keyword'>bool </span><span class='Declare_Parameter'>process_symlinks</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>progname</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Issue fsync recursively on PGDATA and all its contents. 
 * 
 * We fsync regular files and directories wherever they are, but we follow 
 * symlinks only for pg_wal (or pg_xlog) and immediately under pg_tblspc. 
 * Other symlinks are presumed to point at files we're not responsible for 
 * fsyncing, and might not have privileges to write at all. 
 * 
 * serverVersion indicates the version of the server to be fsync'd. 
 * 
 * Errors are reported but not considered fatal. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN57"></a><span class='Declare_Function'>fsync_pgdata</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>pg_data</span><span class='Delimiter'>, 
</span><a name="LN58"></a>             <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>progname</span><span class='Delimiter'>, 
</span><a name="LN59"></a>             <span class='Keyword'>int </span><span class='Declare_Parameter'>serverVersion</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN61"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>xlog_is_symlink</span><span class='Delimiter'>; 
</span><a name="LN62"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>pg_wal</span><span class='Delimiter'>[</span><a href="../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN63"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>pg_tblspc</span><span class='Delimiter'>[</span><a href="../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* handle renaming of pg_xlog to pg_wal in post-10 clusters */ 
</span>    <a href="../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN62"><span class='Ref_To_Local'>pg_wal</span></a><span class='Delimiter'>, </span><a href="../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>, </span><span class='String'>"%s/%s"</span><span class='Delimiter'>, </span><a href="file_utils.c.html#LN57"><span class='Ref_to_Parameter'>pg_data</span></a><span class='Delimiter'>, 
</span>          <a href="file_utils.c.html#LN59"><span class='Ref_to_Parameter'>serverVersion</span></a> <span class='Operator'>&LT; </span><a href="file_utils.c.html#LN34"><span class='Ref_to_Const'>MINIMUM_VERSION_FOR_PG_WAL</span></a> <span class='Operator'>? </span><span class='String'>"pg_xlog"</span> <span class='Operator'>: </span><span class='String'>"pg_wal"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN63"><span class='Ref_To_Local'>pg_tblspc</span></a><span class='Delimiter'>, </span><a href="../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>, </span><span class='String'>"%s/pg_tblspc"</span><span class='Delimiter'>, </span><a href="file_utils.c.html#LN57"><span class='Ref_to_Parameter'>pg_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If pg_wal is a symlink, we'll need to recurse into it separately, 
     * because the first walkdir below will ignore it. 
     */ 
</span>    <a href="file_utils.c.html#LN61"><span class='Ref_To_Local'>xlog_is_symlink</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifndef</span> <a href="../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <span class='Delimiter'>{ 
</span><a name="LN78"></a>        <span class='Control'>struct</span> <a href="../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>st</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../include/port/win32.h.html#LN261"><span class='Ref_to_Macro'>lstat</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN62"><span class='Ref_To_Local'>pg_wal</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="file_utils.c.html#LN78"><span class='Ref_To_Local'>st</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not stat file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="file_utils.c.html#LN58"><span class='Ref_to_Parameter'>progname</span></a><span class='Delimiter'>, </span><a href="file_utils.c.html#LN62"><span class='Ref_To_Local'>pg_wal</span></a><span class='Delimiter'>, </span><a href="../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>S_ISLNK<span class='Parentheses'>(</span><a href="file_utils.c.html#LN78"><span class='Ref_To_Local'>st</span></a><span class='Operator'>.</span>st_mode<span class='Parentheses'>))</span> 
            <a href="file_utils.c.html#LN61"><span class='Ref_To_Local'>xlog_is_symlink</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#else</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../include/port.h.html#LN253"><span class='Ref_to_Proto'>pgwin32_is_junction</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN62"><span class='Ref_To_Local'>pg_wal</span></a><span class='Parentheses'>))</span> 
        <a href="file_utils.c.html#LN61"><span class='Ref_To_Local'>xlog_is_symlink</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * If possible, hint to the kernel that we're soon going to fsync the data 
     * directory and its contents. 
     */ 
</span><span class='Directive'>#ifdef</span> <a href="file_utils.c.html#LN26"><span class='Ref_to_Const'>PG_FLUSH_DATA_WORKS</span></a> 
    <a href="file_utils.c.html#LN40"><span class='Ref_to_Proto'>walkdir</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN57"><span class='Ref_to_Parameter'>pg_data</span></a><span class='Delimiter'>, </span><a href="file_utils.c.html#LN37"><span class='Ref_to_Proto'>pre_sync_fname</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="file_utils.c.html#LN58"><span class='Ref_to_Parameter'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="file_utils.c.html#LN61"><span class='Ref_To_Local'>xlog_is_symlink</span></a><span class='Parentheses'>) 
</span>        <a href="file_utils.c.html#LN40"><span class='Ref_to_Proto'>walkdir</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN62"><span class='Ref_To_Local'>pg_wal</span></a><span class='Delimiter'>, </span><a href="file_utils.c.html#LN37"><span class='Ref_to_Proto'>pre_sync_fname</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="file_utils.c.html#LN58"><span class='Ref_to_Parameter'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="file_utils.c.html#LN40"><span class='Ref_to_Proto'>walkdir</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN63"><span class='Ref_To_Local'>pg_tblspc</span></a><span class='Delimiter'>, </span><a href="file_utils.c.html#LN37"><span class='Ref_to_Proto'>pre_sync_fname</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="file_utils.c.html#LN58"><span class='Ref_to_Parameter'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Now we do the fsync()s in the same order. 
     * 
     * The main call ignores symlinks, so in addition to specially processing 
     * pg_wal if it's a symlink, pg_tblspc has to be visited separately with 
     * process_symlinks = true.  Note that if there are any plain directories 
     * in pg_tblspc, they'll get fsync'd twice.  That's not an expected case 
     * so we don't worry about optimizing it. 
     */ 
</span>    <a href="file_utils.c.html#LN40"><span class='Ref_to_Proto'>walkdir</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN57"><span class='Ref_to_Parameter'>pg_data</span></a><span class='Delimiter'>, </span><a href="../include/common/file_utils.h.html#LN17"><span class='Ref_to_Proto'>fsync_fname</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="file_utils.c.html#LN58"><span class='Ref_to_Parameter'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="file_utils.c.html#LN61"><span class='Ref_To_Local'>xlog_is_symlink</span></a><span class='Parentheses'>) 
</span>        <a href="file_utils.c.html#LN40"><span class='Ref_to_Proto'>walkdir</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN62"><span class='Ref_To_Local'>pg_wal</span></a><span class='Delimiter'>, </span><a href="../include/common/file_utils.h.html#LN17"><span class='Ref_to_Proto'>fsync_fname</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="file_utils.c.html#LN58"><span class='Ref_to_Parameter'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="file_utils.c.html#LN40"><span class='Ref_to_Proto'>walkdir</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN63"><span class='Ref_To_Local'>pg_tblspc</span></a><span class='Delimiter'>, </span><a href="../include/common/file_utils.h.html#LN17"><span class='Ref_to_Proto'>fsync_fname</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="file_utils.c.html#LN58"><span class='Ref_to_Parameter'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end fsync_pgdata &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Issue fsync recursively on the given directory and all its contents. 
 * 
 * This is a convenient wrapper on top of walkdir(). 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN123"></a><span class='Declare_Function'>fsync_dir_recurse</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dir</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>progname</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * If possible, hint to the kernel that we're soon going to fsync the data 
     * directory and its contents. 
     */ 
</span><span class='Directive'>#ifdef</span> <a href="file_utils.c.html#LN26"><span class='Ref_to_Const'>PG_FLUSH_DATA_WORKS</span></a> 
    <a href="file_utils.c.html#LN40"><span class='Ref_to_Proto'>walkdir</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN123"><span class='Ref_to_Parameter'>dir</span></a><span class='Delimiter'>, </span><a href="file_utils.c.html#LN37"><span class='Ref_to_Proto'>pre_sync_fname</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="file_utils.c.html#LN123"><span class='Ref_to_Parameter'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <a href="file_utils.c.html#LN40"><span class='Ref_to_Proto'>walkdir</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN123"><span class='Ref_to_Parameter'>dir</span></a><span class='Delimiter'>, </span><a href="../include/common/file_utils.h.html#LN17"><span class='Ref_to_Proto'>fsync_fname</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="file_utils.c.html#LN123"><span class='Ref_to_Parameter'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * walkdir: recursively walk a directory, applying the action to each 
 * regular file and directory (including the named directory itself). 
 * 
 * If process_symlinks is true, the action and recursion are also applied 
 * to regular files and directories that are pointed to by symlinks in the 
 * given directory; otherwise symlinks are ignored.  Symlinks are always 
 * ignored in subdirectories, ie we intentionally don't pass down the 
 * process_symlinks flag to recursive calls. 
 * 
 * Errors are reported but not considered fatal. 
 * 
 * See also walkdir in fd.c, which is a backend version of this logic. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN151"></a><span class='Declare_Function'>walkdir</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>path</span><span class='Delimiter'>, 
</span><a name="LN152"></a>        <span class='Keyword'>int </span><span class='Parentheses'>(</span><span class='Operator'>*</span><span class='Declare_Parameter'>action</span><span class='Parentheses'>) (</span><span class='Keyword'>const char </span><span class='Operator'>*</span>fname<span class='Delimiter'>, </span><span class='Keyword'>bool </span>isdir<span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><a href="file_utils.c.html#LN153"><span class='Ref_to_Parameter'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span><a name="LN153"></a>        <span class='Keyword'>bool </span><span class='Declare_Parameter'>process_symlinks</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>progname</span><span class='Parentheses'>)</span> 
<span class='Delimiter'>{ 
</span><a name="LN155"></a>    <a href="../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>dir</span><span class='Delimiter'>; 
</span><a name="LN156"></a>    <span class='Control'>struct</span> <a href="../include/port/win32_msvc/dirent.h.html#LN8"><span class='Ref_to_Struct'>dirent</span></a> <span class='Operator'>*</span><span class='Declare_Local'>de</span><span class='Delimiter'>; 
</span> 
    <a href="file_utils.c.html#LN155"><span class='Ref_To_Local'>dir</span></a> <span class='Operator'>= </span><a href="../include/port/win32_msvc/dirent.h.html#LN18"><span class='Ref_to_Proto'>opendir</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN151"><span class='Ref_to_Parameter'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="file_utils.c.html#LN155"><span class='Ref_To_Local'>dir</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not open directory \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="file_utils.c.html#LN153"><span class='Ref_to_Parameter'>progname</span></a><span class='Delimiter'>, </span><a href="file_utils.c.html#LN151"><span class='Ref_to_Parameter'>path</span></a><span class='Delimiter'>, </span><a href="../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span>errno <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="file_utils.c.html#LN156"><span class='Ref_To_Local'>de</span></a> <span class='Operator'>= </span><a href="../include/port/win32_msvc/dirent.h.html#LN19"><span class='Ref_to_Proto'>readdir</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN155"><span class='Ref_To_Local'>dir</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN168"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>subpath</span><span class='Delimiter'>[</span><a href="../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a> <span class='Operator'>* </span><span class='Number'>2</span><span class='Delimiter'>]; 
</span><a name="LN169"></a>        <span class='Control'>struct</span> <a href="../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>fst</span><span class='Delimiter'>; 
</span><a name="LN170"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>sret</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="file_utils.c.html#LN156"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='String'>"."</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>            strcmp<span class='Parentheses'>(</span><a href="file_utils.c.html#LN156"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='String'>".."</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN168"><span class='Ref_To_Local'>subpath</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="file_utils.c.html#LN168"><span class='Ref_To_Local'>subpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/%s"</span><span class='Delimiter'>, </span><a href="file_utils.c.html#LN151"><span class='Ref_to_Parameter'>path</span></a><span class='Delimiter'>, </span><a href="file_utils.c.html#LN156"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="file_utils.c.html#LN153"><span class='Ref_to_Parameter'>process_symlinks</span></a><span class='Parentheses'>) 
</span>            <a href="file_utils.c.html#LN170"><span class='Ref_To_Local'>sret</span></a> <span class='Operator'>= </span><a href="../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN168"><span class='Ref_To_Local'>subpath</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="file_utils.c.html#LN169"><span class='Ref_To_Local'>fst</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="file_utils.c.html#LN170"><span class='Ref_To_Local'>sret</span></a> <span class='Operator'>= </span><a href="../include/port/win32.h.html#LN261"><span class='Ref_to_Macro'>lstat</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN168"><span class='Ref_To_Local'>subpath</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="file_utils.c.html#LN169"><span class='Ref_To_Local'>fst</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="file_utils.c.html#LN170"><span class='Ref_To_Local'>sret</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not stat file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="file_utils.c.html#LN153"><span class='Ref_to_Parameter'>progname</span></a><span class='Delimiter'>, </span><a href="file_utils.c.html#LN168"><span class='Ref_To_Local'>subpath</span></a><span class='Delimiter'>, </span><a href="../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../include/port/win32.h.html#LN430"><span class='Ref_to_Macro'>S_ISREG</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN169"><span class='Ref_To_Local'>fst</span></a><span class='Operator'>.</span>st_mode<span class='Parentheses'>))</span> 
            <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="file_utils.c.html#LN152"><span class='Ref_to_Parameter'>action</span></a><span class='Parentheses'>) (</span><a href="file_utils.c.html#LN168"><span class='Ref_To_Local'>subpath</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="file_utils.c.html#LN153"><span class='Ref_to_Parameter'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../include/port/win32.h.html#LN429"><span class='Ref_to_Macro'>S_ISDIR</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN169"><span class='Ref_To_Local'>fst</span></a><span class='Operator'>.</span>st_mode<span class='Parentheses'>))</span> 
            <a href="file_utils.c.html#LN40"><span class='Ref_to_Proto'>walkdir</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN168"><span class='Ref_To_Local'>subpath</span></a><span class='Delimiter'>, </span><a href="file_utils.c.html#LN152"><span class='Ref_to_Parameter'>action</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="file_utils.c.html#LN153"><span class='Ref_to_Parameter'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while errno=0,(de=readdir(d... &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>errno<span class='Parentheses'>) 
</span>        <a href="../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not read directory \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="file_utils.c.html#LN153"><span class='Ref_to_Parameter'>progname</span></a><span class='Delimiter'>, </span><a href="file_utils.c.html#LN151"><span class='Ref_to_Parameter'>path</span></a><span class='Delimiter'>, </span><a href="../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../include/port/win32_msvc/dirent.h.html#LN20"><span class='Ref_to_Proto'>closedir</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN155"><span class='Ref_To_Local'>dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * It's important to fsync the destination directory itself as individual 
     * file fsyncs don't guarantee that the directory entry for the file is 
     * synced.  Recent versions of ext4 have made the window much wider but 
     * it's been an issue for ext3 and other filesystems in the past. 
     */ 
</span>    <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="file_utils.c.html#LN152"><span class='Ref_to_Parameter'>action</span></a><span class='Parentheses'>) (</span><a href="file_utils.c.html#LN151"><span class='Ref_to_Parameter'>path</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="file_utils.c.html#LN153"><span class='Ref_to_Parameter'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end walkdir &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Hint to the OS that it should get ready to fsync() this file. 
 * 
 * Ignores errors trying to open unreadable files, and reports other errors 
 * non-fatally. 
 */ 
</span><span class='Directive'>#ifdef</span> <a href="file_utils.c.html#LN26"><span class='Ref_to_Const'>PG_FLUSH_DATA_WORKS</span></a> 
 
<span class='Keyword'>static int 
</span><a name="LN220"></a><span class='Declare_Function'>pre_sync_fname</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>fname</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isdir</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>progname</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN222"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>fd</span><span class='Delimiter'>; 
</span> 
    <a href="file_utils.c.html#LN222"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span><a href="../include/port.h.html#LN289"><span class='Ref_to_Macro'>open</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN220"><span class='Ref_to_Parameter'>fname</span></a><span class='Delimiter'>, </span>O_RDONLY <span class='Operator'>| </span><a href="../include/c.h.html#LN1032"><span class='Ref_to_Const'>PG_BINARY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="file_utils.c.html#LN222"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span>EACCES <span class='Operator'>|| </span><span class='Parentheses'>(</span><a href="file_utils.c.html#LN220"><span class='Ref_to_Parameter'>isdir</span></a> <span class='Operator'>&& </span>errno <span class='Operator'>== </span>EISDIR<span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not open file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="file_utils.c.html#LN220"><span class='Ref_to_Parameter'>progname</span></a><span class='Delimiter'>, </span><a href="file_utils.c.html#LN220"><span class='Ref_to_Parameter'>fname</span></a><span class='Delimiter'>, </span><a href="../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We do what pg_flush_data() would do in the backend: prefer to use 
     * sync_file_range, but fall back to posix_fadvise.  We ignore errors 
     * because this is only a hint. 
     */ 
</span><span class='Directive'>#if</span> defined<span class='Parentheses'>(</span>HAVE_SYNC_FILE_RANGE<span class='Parentheses'>) 
</span>    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span>sync_file_range<span class='Parentheses'>(</span><a href="file_utils.c.html#LN222"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span>SYNC_FILE_RANGE_WRITE<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#elif</span> defined<span class='Parentheses'>(</span><a href="../include/pg_config_manual.h.html#LN136"><span class='Ref_to_Const'>USE_POSIX_FADVISE</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span>defined<span class='Parentheses'>(</span>POSIX_FADV_DONTNEED<span class='Parentheses'>) 
</span>    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span>posix_fadvise<span class='Parentheses'>(</span><a href="file_utils.c.html#LN222"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span>POSIX_FADV_DONTNEED<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
#error <a href="file_utils.c.html#LN26"><span class='Ref_to_Const'>PG_FLUSH_DATA_WORKS</span></a> should not have been defined 
<span class='Directive'>#endif</span> 
 
    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN222"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pre_sync_fname &raquo; </span> 
 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* PG_FLUSH_DATA_WORKS */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * fsync_fname -- Try to fsync a file or directory 
 * 
 * Ignores errors trying to open unreadable files, or trying to fsync 
 * directories on systems where that isn't allowed/required.  Reports 
 * other errors non-fatally. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN262"></a><span class='Declare_Function'>fsync_fname</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>fname</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isdir</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>progname</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN264"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>fd</span><span class='Delimiter'>; 
</span><a name="LN265"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>flags</span><span class='Delimiter'>; 
</span><a name="LN266"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>returncode</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Some OSs require directories to be opened read-only whereas other 
     * systems don't allow us to fsync files opened read-only; so we need both 
     * cases here.  Using O_RDWR will cause us to fail to fsync files that are 
     * not writable by our userid, but we assume that's OK. 
     */ 
</span>    <a href="file_utils.c.html#LN265"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>= </span><a href="../include/c.h.html#LN1032"><span class='Ref_to_Const'>PG_BINARY</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="file_utils.c.html#LN262"><span class='Ref_to_Parameter'>isdir</span></a><span class='Parentheses'>) 
</span>        <a href="file_utils.c.html#LN265"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>|= </span>O_RDWR<span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="file_utils.c.html#LN265"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>|= </span>O_RDONLY<span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Open the file, silently ignoring errors about unreadable files (or 
     * unsupported operations, e.g. opening a directory under Windows), and 
     * logging others. 
     */ 
</span>    <a href="file_utils.c.html#LN264"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span><a href="../include/port.h.html#LN289"><span class='Ref_to_Macro'>open</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN262"><span class='Ref_to_Parameter'>fname</span></a><span class='Delimiter'>, </span><a href="file_utils.c.html#LN265"><span class='Ref_To_Local'>flags</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="file_utils.c.html#LN264"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span>EACCES <span class='Operator'>|| </span><span class='Parentheses'>(</span><a href="file_utils.c.html#LN262"><span class='Ref_to_Parameter'>isdir</span></a> <span class='Operator'>&& </span>errno <span class='Operator'>== </span>EISDIR<span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not open file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="file_utils.c.html#LN262"><span class='Ref_to_Parameter'>progname</span></a><span class='Delimiter'>, </span><a href="file_utils.c.html#LN262"><span class='Ref_to_Parameter'>fname</span></a><span class='Delimiter'>, </span><a href="../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="file_utils.c.html#LN266"><span class='Ref_To_Local'>returncode</span></a> <span class='Operator'>= </span><a href="../include/port/win32.h.html#LN61"><span class='Ref_to_Macro'>fsync</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN264"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Some OSes don't allow us to fsync directories at all, so we can ignore 
     * those errors. Anything else needs to be reported. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="file_utils.c.html#LN266"><span class='Ref_To_Local'>returncode</span></a> <span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>&& !</span><span class='Parentheses'>(</span><a href="file_utils.c.html#LN262"><span class='Ref_to_Parameter'>isdir</span></a> <span class='Operator'>&& </span>errno <span class='Operator'>== </span>EBADF<span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not fsync file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="file_utils.c.html#LN262"><span class='Ref_to_Parameter'>progname</span></a><span class='Delimiter'>, </span><a href="file_utils.c.html#LN262"><span class='Ref_to_Parameter'>fname</span></a><span class='Delimiter'>, </span><a href="../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN264"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN264"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end fsync_fname &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * fsync_parent_path -- fsync the parent path of a file or directory 
 * 
 * This is aimed at making file operations persistent on disk in case of 
 * an OS crash or power failure. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN320"></a><span class='Declare_Function'>fsync_parent_path</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>fname</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>progname</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN322"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>parentpath</span><span class='Delimiter'>[</span><a href="../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span> 
    <a href="../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN322"><span class='Ref_To_Local'>parentpath</span></a><span class='Delimiter'>, </span><a href="file_utils.c.html#LN320"><span class='Ref_to_Parameter'>fname</span></a><span class='Delimiter'>, </span><a href="../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../include/port.h.html#LN62"><span class='Ref_to_Proto'>get_parent_directory</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN322"><span class='Ref_To_Local'>parentpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * get_parent_directory() returns an empty string if the input argument is 
     * just a file name (see comments in path.c), so handle that as being the 
     * current directory. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="file_utils.c.html#LN322"><span class='Ref_To_Local'>parentpath</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN322"><span class='Ref_To_Local'>parentpath</span></a><span class='Delimiter'>, </span><span class='String'>"."</span><span class='Delimiter'>, </span><a href="../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../include/common/file_utils.h.html#LN17"><span class='Ref_to_Proto'>fsync_fname</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN322"><span class='Ref_To_Local'>parentpath</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="file_utils.c.html#LN320"><span class='Ref_to_Parameter'>progname</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end fsync_parent_path &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * durable_rename -- rename(2) wrapper, issuing fsyncs required for durability 
 * 
 * Wrapper around rename, similar to the backend version. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN347"></a><span class='Declare_Function'>durable_rename</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>oldfile</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>newfile</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>progname</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN349"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>fd</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * First fsync the old and target path (if it exists), to ensure that they 
     * are properly persistent on disk. Syncing the target file is not 
     * strictly necessary, but it makes it easier to reason about crashes; 
     * because it's then guaranteed that either source or target file exists 
     * after a crash. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../include/common/file_utils.h.html#LN17"><span class='Ref_to_Proto'>fsync_fname</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN347"><span class='Ref_to_Parameter'>oldfile</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="file_utils.c.html#LN347"><span class='Ref_to_Parameter'>progname</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <a href="file_utils.c.html#LN349"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span><a href="../include/port.h.html#LN289"><span class='Ref_to_Macro'>open</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN347"><span class='Ref_to_Parameter'>newfile</span></a><span class='Delimiter'>, </span><a href="../include/c.h.html#LN1032"><span class='Ref_to_Const'>PG_BINARY</span></a> <span class='Operator'>| </span>O_RDWR<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="file_utils.c.html#LN349"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>!= </span>ENOENT<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not open file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="file_utils.c.html#LN347"><span class='Ref_to_Parameter'>progname</span></a><span class='Delimiter'>, </span><a href="file_utils.c.html#LN347"><span class='Ref_to_Parameter'>newfile</span></a><span class='Delimiter'>, </span><a href="../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../include/port/win32.h.html#LN61"><span class='Ref_to_Macro'>fsync</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN349"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not fsync file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="file_utils.c.html#LN347"><span class='Ref_to_Parameter'>progname</span></a><span class='Delimiter'>, </span><a href="file_utils.c.html#LN347"><span class='Ref_to_Parameter'>newfile</span></a><span class='Delimiter'>, </span><a href="../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN349"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN349"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Time to do the real deal... */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../port/dirmod.c.html#LN121"><span class='Ref_to_Macro'>rename</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN347"><span class='Ref_to_Parameter'>oldfile</span></a><span class='Delimiter'>, </span><a href="file_utils.c.html#LN347"><span class='Ref_to_Parameter'>newfile</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not rename file \"%s\" to \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="file_utils.c.html#LN347"><span class='Ref_to_Parameter'>progname</span></a><span class='Delimiter'>, </span><a href="file_utils.c.html#LN347"><span class='Ref_to_Parameter'>oldfile</span></a><span class='Delimiter'>, </span><a href="file_utils.c.html#LN347"><span class='Ref_to_Parameter'>newfile</span></a><span class='Delimiter'>, </span><a href="../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * To guarantee renaming the file is persistent, fsync the file with its 
     * new name, and its containing directory. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../include/common/file_utils.h.html#LN17"><span class='Ref_to_Proto'>fsync_fname</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN347"><span class='Ref_to_Parameter'>newfile</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="file_utils.c.html#LN347"><span class='Ref_to_Parameter'>progname</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../include/common/file_utils.h.html#LN24"><span class='Ref_to_Proto'>fsync_parent_path</span></a><span class='Parentheses'>(</span><a href="file_utils.c.html#LN347"><span class='Ref_to_Parameter'>newfile</span></a><span class='Delimiter'>, </span><a href="file_utils.c.html#LN347"><span class='Ref_to_Parameter'>progname</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end durable_rename &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>