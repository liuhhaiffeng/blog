<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\common\pg_lzcompress.c</title>
<LINK REL=StyleSheet HREF="../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\common\pg_lzcompress.c</b></p></td>
<td align='right'>
Wed Jun 14 08:26:02 2017
</td></tr>
<tr><td><a href='../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
</span><span class='Comment_Multi_Line'>/* ---------- 
 * pg_lzcompress.c - 
 * 
 *      This is an implementation of LZ compression for PostgreSQL. 
 *      It uses a simple history table and generates 2-3 byte tags 
 *      capable of backward copy information for 3-273 bytes with 
 *      a max offset of 4095. 
 * 
 *      Entry routines: 
 * 
 *          int32 
 *          pglz_compress(const char *source, int32 slen, char *dest, 
 *                        const PGLZ_Strategy *strategy); 
 * 
 *              source is the input data to be compressed. 
 * 
 *              slen is the length of the input data. 
 * 
 *              dest is the output area for the compressed result. 
 *                  It must be at least as big as PGLZ_MAX_OUTPUT(slen). 
 * 
 *              strategy is a pointer to some information controlling 
 *                  the compression algorithm. If NULL, the compiled 
 *                  in default strategy is used. 
 * 
 *              The return value is the number of bytes written in the 
 *              buffer dest, or -1 if compression fails; in the latter 
 *              case the contents of dest are undefined. 
 * 
 *          int32 
 *          pglz_decompress(const char *source, int32 slen, char *dest, 
 *                          int32 rawsize) 
 * 
 *              source is the compressed input. 
 * 
 *              slen is the length of the compressed input. 
 * 
 *              dest is the area where the uncompressed data will be 
 *                  written to. It is the callers responsibility to 
 *                  provide enough space. 
 * 
 *                  The data is written to buff exactly as it was handed 
 *                  to pglz_compress(). No terminating zero byte is added. 
 * 
 *              rawsize is the length of the uncompressed data. 
 * 
 *              The return value is the number of bytes written in the 
 *              buffer dest, or -1 if decompression fails. 
 * 
 *      The decompression algorithm and internal data format: 
 * 
 *          It is made with the compressed data itself. 
 * 
 *          The data representation is easiest explained by describing 
 *          the process of decompression. 
 * 
 *          If compressed_size == rawsize, then the data 
 *          is stored uncompressed as plain bytes. Thus, the decompressor 
 *          simply copies rawsize bytes to the destination. 
 * 
 *          Otherwise the first byte tells what to do the next 8 times. 
 *          We call this the control byte. 
 * 
 *          An unset bit in the control byte means, that one uncompressed 
 *          byte follows, which is copied from input to output. 
 * 
 *          A set bit in the control byte means, that a tag of 2-3 bytes 
 *          follows. A tag contains information to copy some bytes, that 
 *          are already in the output buffer, to the current location in 
 *          the output. Let's call the three tag bytes T1, T2 and T3. The 
 *          position of the data to copy is coded as an offset from the 
 *          actual output position. 
 * 
 *          The offset is in the upper nibble of T1 and in T2. 
 *          The length is in the lower nibble of T1. 
 * 
 *          So the 16 bits of a 2 byte tag are coded as 
 * 
 *              7---T1--0  7---T2--0 
 *              OOOO LLLL  OOOO OOOO 
 * 
 *          This limits the offset to 1-4095 (12 bits) and the length 
 *          to 3-18 (4 bits) because 3 is always added to it. To emit 
 *          a tag of 2 bytes with a length of 2 only saves one control 
 *          bit. But we lose one byte in the possible length of a tag. 
 * 
 *          In the actual implementation, the 2 byte tag's length is 
 *          limited to 3-17, because the value 0xF in the length nibble 
 *          has special meaning. It means, that the next following 
 *          byte (T3) has to be added to the length value of 18. That 
 *          makes total limits of 1-4095 for offset and 3-273 for length. 
 * 
 *          Now that we have successfully decoded a tag. We simply copy 
 *          the output that occurred &LT;offset&GT; bytes back to the current 
 *          output location in the specified &LT;length&GT;. Thus, a 
 *          sequence of 200 spaces (think about bpchar fields) could be 
 *          coded in 4 bytes. One literal space and a three byte tag to 
 *          copy 199 bytes with a -1 offset. Whow - that's a compression 
 *          rate of 98%! Well, the implementation needs to save the 
 *          original data size too, so we need another 4 bytes for it 
 *          and end up with a total compression rate of 96%, what's still 
 *          worth a Whow. 
 * 
 *      The compression algorithm 
 * 
 *          The following uses numbers used in the default strategy. 
 * 
 *          The compressor works best for attributes of a size between 
 *          1K and 1M. For smaller items there's not that much chance of 
 *          redundancy in the character sequence (except for large areas 
 *          of identical bytes like trailing spaces) and for bigger ones 
 *          our 4K maximum look-back distance is too small. 
 * 
 *          The compressor creates a table for lists of positions. 
 *          For each input position (except the last 3), a hash key is 
 *          built from the 4 next input bytes and the position remembered 
 *          in the appropriate list. Thus, the table points to linked 
 *          lists of likely to be at least in the first 4 characters 
 *          matching strings. This is done on the fly while the input 
 *          is compressed into the output area.  Table entries are only 
 *          kept for the last 4096 input positions, since we cannot use 
 *          back-pointers larger than that anyway.  The size of the hash 
 *          table is chosen based on the size of the input - a larger table 
 *          has a larger startup cost, as it needs to be initialized to 
 *          zero, but reduces the number of hash collisions on long inputs. 
 * 
 *          For each byte in the input, its hash key (built from this 
 *          byte and the next 3) is used to find the appropriate list 
 *          in the table. The lists remember the positions of all bytes 
 *          that had the same hash key in the past in increasing backward 
 *          offset order. Now for all entries in the used lists, the 
 *          match length is computed by comparing the characters from the 
 *          entries position with the characters from the actual input 
 *          position. 
 * 
 *          The compressor starts with a so called "good_match" of 128. 
 *          It is a "prefer speed against compression ratio" optimizer. 
 *          So if the first entry looked at already has 128 or more 
 *          matching characters, the lookup stops and that position is 
 *          used for the next tag in the output. 
 * 
 *          For each subsequent entry in the history list, the "good_match" 
 *          is lowered by 10%. So the compressor will be more happy with 
 *          short matches the farer it has to go back in the history. 
 *          Another "speed against ratio" preference characteristic of 
 *          the algorithm. 
 * 
 *          Thus there are 3 stop conditions for the lookup of matches: 
 * 
 *              - a match &GT;= good_match is found 
 *              - there are no more history entries to look at 
 *              - the next history entry is already too far back 
 *                to be coded into a tag. 
 * 
 *          Finally the match algorithm checks that at least a match 
 *          of 3 or more bytes has been found, because that is the smallest 
 *          amount of copy information to code into a tag. If so, a tag 
 *          is omitted and all the input bytes covered by that are just 
 *          scanned for the history add's, otherwise a literal character 
 *          is omitted and only his history entry added. 
 * 
 *      Acknowledgements: 
 * 
 *          Many thanks to Adisak Pochanayon, who's article about SLZ 
 *          inspired me to write the PostgreSQL compression this way. 
 * 
 *          Jan Wieck 
 * 
 * Copyright (c) 1999-2017, PostgreSQL Global Development Group 
 * 
 * src/common/pg_lzcompress.c 
 * ---------- 
 */ 
</span><span class='Directive'>#ifndef</span> <a href="../bin/pg_waldump/rmgrdesc.c.html#LN7"><span class='Ref_to_Const'>FRONTEND</span></a> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
<span class='Directive'>#else</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres_fe.h"</span> 
<span class='Directive'>#endif</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;limits.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"common/pg_lzcompress.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * Local definitions 
 * ---------- 
 */ 
</span><a name="LN188"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PGLZ_MAX_HISTORY_LISTS</span>  <span class='Number'>8192</span>    <span class='Comment_Single_Line'>/* must be power of 2 */ 
</span><a name="LN189"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PGLZ_HISTORY_SIZE</span>       <span class='Number'>4096</span> 
<a name="LN190"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PGLZ_MAX_MATCH</span>          <span class='Number'>273</span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * PGLZ_HistEntry - 
 * 
 *      Linked list for the backward history lookup 
 * 
 * All the entries sharing a hash key are linked in a doubly linked list. 
 * This makes it easy to remove an entry when it's time to recycle it 
 * (because it's more than 4K positions old). 
 * ---------- 
 */ 
</span><a name="LN203"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>PGLZ_HistEntry</span> 
<span class='Delimiter'>{ 
</span><a name="LN205"></a>    <span class='Control'>struct</span> <a href="pg_lzcompress.c.html#LN203"><span class='Ref_to_Struct'>PGLZ_HistEntry</span></a> <span class='Operator'>*</span><span class='Declare_Member'>next</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* links for my hash key's list */ 
</span><a name="LN206"></a>    <span class='Control'>struct</span> <a href="pg_lzcompress.c.html#LN203"><span class='Ref_to_Struct'>PGLZ_HistEntry</span></a> <span class='Operator'>*</span><span class='Declare_Member'>prev</span><span class='Delimiter'>; 
</span><a name="LN207"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>hindex</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* my current hash key */ 
</span><a name="LN208"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Member'>pos</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* my input position */ 
</span><a name="LN209"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>PGLZ_HistEntry</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * The provided standard strategies 
 * ---------- 
 */ 
</span><a name="LN216"></a><span class='Keyword'>static const </span><a href="../include/common/pg_lzcompress.h.html#LN56"><span class='Ref_to_Struct'>PGLZ_Strategy</span></a> <span class='Declare_Var'>strategy_default_data</span> <span class='Operator'>= </span><span class='Delimiter'>{ 
</span>    <span class='Number'>32</span><span class='Delimiter'>,</span>                         <span class='Comment_Multi_Line'>/* Data chunks less than 32 bytes are not 
                                 * compressed */ 
</span>    INT_MAX<span class='Delimiter'>,</span>                    <span class='Comment_Multi_Line'>/* No upper limit on what we'll try to 
                                 * compress */ 
</span>    <span class='Number'>25</span><span class='Delimiter'>,</span>                         <span class='Comment_Multi_Line'>/* Require 25% compression rate, or not worth 
                                 * it */ 
</span>    <span class='Number'>1024</span><span class='Delimiter'>,</span>                       <span class='Comment_Single_Line'>/* Give up if no compression in the first 1KB */ 
</span>    <span class='Number'>128</span><span class='Delimiter'>,</span>                        <span class='Comment_Multi_Line'>/* Stop history lookup if a match of 128 bytes 
                                 * is found */ 
</span>    <span class='Number'>10</span>                          <span class='Comment_Multi_Line'>/* Lower good match size by 10% at every loop 
                                 * iteration */ 
</span><span class='Delimiter'>}; 
</span><a name="LN229"></a><span class='Keyword'>const </span><a href="../include/common/pg_lzcompress.h.html#LN56"><span class='Ref_to_Struct'>PGLZ_Strategy</span></a> <span class='Operator'>*</span><span class='Keyword'>const </span><span class='Declare_Var'>PGLZ_strategy_default</span> <span class='Operator'>= &</span><a href="pg_lzcompress.c.html#LN216"><span class='Ref_to_Global_Var'>strategy_default_data</span></a><span class='Delimiter'>; 
</span> 
 
<a name="LN232"></a><span class='Keyword'>static const </span><a href="../include/common/pg_lzcompress.h.html#LN56"><span class='Ref_to_Struct'>PGLZ_Strategy</span></a> <span class='Declare_Var'>strategy_always_data</span> <span class='Operator'>= </span><span class='Delimiter'>{ 
</span>    <span class='Number'>0</span><span class='Delimiter'>,</span>                          <span class='Comment_Single_Line'>/* Chunks of any size are compressed */ 
</span>    INT_MAX<span class='Delimiter'>, 
</span>    <span class='Number'>0</span><span class='Delimiter'>,</span>                          <span class='Comment_Single_Line'>/* It's enough to save one single byte */ 
</span>    INT_MAX<span class='Delimiter'>,</span>                    <span class='Comment_Single_Line'>/* Never give up early */ 
</span>    <span class='Number'>128</span><span class='Delimiter'>,</span>                        <span class='Comment_Multi_Line'>/* Stop history lookup if a match of 128 bytes 
                                 * is found */ 
</span>    <span class='Number'>6</span>                           <span class='Comment_Single_Line'>/* Look harder for a good match */ 
</span><span class='Delimiter'>}; 
</span><a name="LN241"></a><span class='Keyword'>const </span><a href="../include/common/pg_lzcompress.h.html#LN56"><span class='Ref_to_Struct'>PGLZ_Strategy</span></a> <span class='Operator'>*</span><span class='Keyword'>const </span><span class='Declare_Var'>PGLZ_strategy_always</span> <span class='Operator'>= &</span><a href="pg_lzcompress.c.html#LN232"><span class='Ref_to_Global_Var'>strategy_always_data</span></a><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * Statically allocated work arrays for history 
 * ---------- 
 */ 
</span><a name="LN248"></a><span class='Keyword'>static </span><a href="../include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a> <span class='Declare_Var'>hist_start</span><span class='Delimiter'>[</span><a href="pg_lzcompress.c.html#LN188"><span class='Ref_to_Const'>PGLZ_MAX_HISTORY_LISTS</span></a><span class='Delimiter'>]; 
</span><a name="LN249"></a><span class='Keyword'>static </span><a href="pg_lzcompress.c.html#LN203"><span class='Ref_to_Struct'>PGLZ_HistEntry</span></a> <span class='Declare_Var'>hist_entries</span><span class='Delimiter'>[</span><a href="pg_lzcompress.c.html#LN189"><span class='Ref_to_Const'>PGLZ_HISTORY_SIZE</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Element 0 in hist_entries is unused, and means 'invalid'. Likewise, 
 * INVALID_ENTRY_PTR in next/prev pointers mean 'invalid'. 
 */ 
</span><a name="LN255"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>INVALID_ENTRY</span>           <span class='Number'>0</span> 
<a name="LN256"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>INVALID_ENTRY_PTR</span>       <span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_lzcompress.c.html#LN249"><span class='Ref_to_Global_Var'>hist_entries</span></a><span class='Delimiter'>[</span><a href="pg_lzcompress.c.html#LN255"><span class='Ref_to_Const'>INVALID_ENTRY</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span> 
<span class='Comment_Multi_Line'>/* ---------- 
 * pglz_hist_idx - 
 * 
 *      Computes the history table slot for the lookup by the next 4 
 *      characters in the input. 
 * 
 * NB: because we use the next 4 characters, we are not guaranteed to 
 * find 3-character matches; they very possibly will be in the wrong 
 * hash list.  This seems an acceptable tradeoff for spreading out the 
 * hash keys more. 
 * ---------- 
 */ 
</span><a name="LN270"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>pglz_hist_idx</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>_s</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>_e</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>_mask</span><span class='Parentheses'>) (</span>                                       <span class='Operator'>\ 
</span>            <span class='Parentheses'>((((</span><a href="pg_lzcompress.c.html#LN270"><span class='Ref_to_Parameter'>_e</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN270"><span class='Ref_to_Parameter'>_s</span></a><span class='Parentheses'>))</span> <span class='Operator'>&LT; </span><span class='Number'>4</span><span class='Parentheses'>)</span> <span class='Operator'>? </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>)</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN270"><span class='Ref_to_Parameter'>_s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>:</span>                          <span class='Operator'>\ 
</span>             <span class='Parentheses'>(((</span><a href="pg_lzcompress.c.html#LN270"><span class='Ref_to_Parameter'>_s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>&LT;&LT; </span><span class='Number'>6</span><span class='Parentheses'>)</span> <span class='Operator'>^ </span><span class='Parentheses'>((</span><a href="pg_lzcompress.c.html#LN270"><span class='Ref_to_Parameter'>_s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>&LT;&LT; </span><span class='Number'>4</span><span class='Parentheses'>)</span> <span class='Operator'>^</span>                             <span class='Operator'>\ 
</span>              <span class='Parentheses'>((</span><a href="pg_lzcompress.c.html#LN270"><span class='Ref_to_Parameter'>_s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>&LT;&LT; </span><span class='Number'>2</span><span class='Parentheses'>)</span> <span class='Operator'>^ </span><span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN270"><span class='Ref_to_Parameter'>_s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>[</span><span class='Number'>3</span><span class='Delimiter'>]</span><span class='Parentheses'>))</span> <span class='Operator'>& </span><span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN270"><span class='Ref_to_Parameter'>_mask</span></a><span class='Parentheses'>)</span>              <span class='Operator'>\ 
</span>        <span class='Parentheses'>)</span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pglz_hist_add - 
 * 
 *      Adds a new entry to the history table. 
 * 
 * If _recycle is true, then we are recycling a previously used entry, 
 * and must first delink it from its old hashcode's linked list. 
 * 
 * NOTE: beware of multiple evaluations of macro's arguments, and note that 
 * _hn and _recycle are modified in the macro. 
 * ---------- 
 */ 
</span><a name="LN289"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>pglz_hist_add</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>_hs</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>_he</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>_hn</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>_recycle</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>_s</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>_e</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>_mask</span><span class='Parentheses'>)</span>    <span class='Operator'>\ 
</span><span class='Control'>do</span> <span class='Delimiter'>{</span>                                    <span class='Operator'>\ 
</span>            <span class='Keyword'>int </span>__hindex <span class='Operator'>= </span><a href="pg_lzcompress.c.html#LN270"><span class='Ref_to_Macro'>pglz_hist_idx</span></a><span class='Parentheses'>((</span><a href="pg_lzcompress.c.html#LN289"><span class='Ref_to_Parameter'>_s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>,</span><span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN289"><span class='Ref_to_Parameter'>_e</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN289"><span class='Ref_to_Parameter'>_mask</span></a><span class='Parentheses'>))</span><span class='Delimiter'>;</span>               <span class='Operator'>\ 
</span>            <a href="../include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a> <span class='Operator'>*</span>__myhsp <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN289"><span class='Ref_to_Parameter'>_hs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>[</span>__hindex<span class='Delimiter'>];</span>                              <span class='Operator'>\ 
</span>            <a href="pg_lzcompress.c.html#LN203"><span class='Ref_to_Struct'>PGLZ_HistEntry</span></a> <span class='Operator'>*</span>__myhe <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN289"><span class='Ref_to_Parameter'>_he</span></a><span class='Parentheses'>)</span><span class='Delimiter'>[</span><a href="pg_lzcompress.c.html#LN289"><span class='Ref_to_Parameter'>_hn</span></a><span class='Delimiter'>];</span>                           <span class='Operator'>\ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN289"><span class='Ref_to_Parameter'>_recycle</span></a><span class='Parentheses'>) </span><span class='Delimiter'>{</span>                                                 <span class='Operator'>\ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span>__myhe<span class='Operator'>-&GT;</span>prev <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span>                                   <span class='Operator'>\ 
</span>                    <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN289"><span class='Ref_to_Parameter'>_hs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>[</span>__myhe<span class='Operator'>-&GT;</span>hindex<span class='Delimiter'>] </span><span class='Operator'>= </span>__myhe<span class='Operator'>-&GT;</span>next <span class='Operator'>- </span><span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN289"><span class='Ref_to_Parameter'>_he</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>           <span class='Operator'>\ 
</span>                <span class='Control'>else</span>                                                        <span class='Operator'>\ 
</span>                    __myhe<span class='Operator'>-&GT;</span>prev<span class='Operator'>-&GT;</span>next <span class='Operator'>= </span>__myhe<span class='Operator'>-&GT;</span>next<span class='Delimiter'>;</span>                      <span class='Operator'>\ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span>__myhe<span class='Operator'>-&GT;</span>next <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span>                                   <span class='Operator'>\ 
</span>                    __myhe<span class='Operator'>-&GT;</span>next<span class='Operator'>-&GT;</span>prev <span class='Operator'>= </span>__myhe<span class='Operator'>-&GT;</span>prev<span class='Delimiter'>;</span>                      <span class='Operator'>\ 
</span>            <span class='Delimiter'>}</span>                                                               <span class='Operator'>\ 
</span>            __myhe<span class='Operator'>-&GT;</span>next <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN289"><span class='Ref_to_Parameter'>_he</span></a><span class='Parentheses'>)</span><span class='Delimiter'>[</span><span class='Operator'>*</span>__myhsp<span class='Delimiter'>];</span>                                <span class='Operator'>\ 
</span>            __myhe<span class='Operator'>-&GT;</span>prev <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>                                            <span class='Operator'>\ 
</span>            __myhe<span class='Operator'>-&GT;</span>hindex <span class='Operator'>= </span>__hindex<span class='Delimiter'>;</span>                                      <span class='Operator'>\ 
</span>            __myhe<span class='Operator'>-&GT;</span>pos  <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN289"><span class='Ref_to_Parameter'>_s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>                                            <span class='Operator'>\ 
</span>            <span class='Comment_Multi_Line'>/* If there was an existing entry in this hash slot, link */</span>    <span class='Operator'>\ 
</span>            <span class='Comment_Multi_Line'>/* this new entry to it. However, the 0th entry in the */</span>       <span class='Operator'>\ 
</span>            <span class='Comment_Multi_Line'>/* entries table is unused, so we can freely scribble on it. */ </span><span class='Operator'>\ 
</span>            <span class='Comment_Multi_Line'>/* So don't bother checking if the slot was used - we'll */</span>     <span class='Operator'>\ 
</span>            <span class='Comment_Multi_Line'>/* scribble on the unused entry if it was not, but that's */</span>    <span class='Operator'>\ 
</span>            <span class='Comment_Multi_Line'>/* harmless. Avoiding the branch in this critical path */</span>       <span class='Operator'>\ 
</span>            <span class='Comment_Multi_Line'>/* speeds this up a little bit. */</span>                              <span class='Operator'>\ 
</span>            <span class='Comment_Multi_Line'>/* if (*__myhsp != INVALID_ENTRY) */</span>                            <span class='Operator'>\ 
</span>                <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN289"><span class='Ref_to_Parameter'>_he</span></a><span class='Parentheses'>)</span><span class='Delimiter'>[</span><span class='Parentheses'>(</span><span class='Operator'>*</span>__myhsp<span class='Parentheses'>)</span><span class='Delimiter'>]</span><span class='Operator'>.</span>prev <span class='Operator'>= </span>__myhe<span class='Delimiter'>;</span>                            <span class='Operator'>\ 
</span>            <span class='Operator'>*</span>__myhsp <span class='Operator'>= </span><a href="pg_lzcompress.c.html#LN289"><span class='Ref_to_Parameter'>_hn</span></a><span class='Delimiter'>;</span>                                                 <span class='Operator'>\ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>++</span><span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN289"><span class='Ref_to_Parameter'>_hn</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><a href="pg_lzcompress.c.html#LN189"><span class='Ref_to_Const'>PGLZ_HISTORY_SIZE</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span> <span class='Delimiter'>{</span>                         <span class='Operator'>\ 
</span>                <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN289"><span class='Ref_to_Parameter'>_hn</span></a><span class='Parentheses'>) </span><span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>;</span>                                                  <span class='Operator'>\ 
</span>                <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN289"><span class='Ref_to_Parameter'>_recycle</span></a><span class='Parentheses'>) </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>;</span>                                          <span class='Operator'>\ 
</span>            <span class='Delimiter'>}</span>                                                               <span class='Operator'>\ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end pglz_hist_add &raquo; </span> <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>) 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pglz_out_ctrl - 
 * 
 *      Outputs the last and allocates a new control byte if needed. 
 * ---------- 
 */ 
</span><a name="LN329"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>pglz_out_ctrl</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>__ctrlp</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>__ctrlb</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>__ctrl</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>__buf</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span><span class='Control'>do</span> <span class='Delimiter'>{ </span><span class='Operator'>\ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="pg_lzcompress.c.html#LN329"><span class='Ref_to_Parameter'>__ctrl</span></a> <span class='Operator'>& </span><span class='Number'>0xff</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span>                                               <span class='Operator'>\ 
</span>    <span class='Delimiter'>{</span>                                                                       <span class='Operator'>\ 
</span>        <span class='Operator'>*</span><span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN329"><span class='Ref_to_Parameter'>__ctrlp</span></a><span class='Parentheses'>) </span><span class='Operator'>= </span><a href="pg_lzcompress.c.html#LN329"><span class='Ref_to_Parameter'>__ctrlb</span></a><span class='Delimiter'>;</span>                                               <span class='Operator'>\ 
</span>        <a href="pg_lzcompress.c.html#LN329"><span class='Ref_to_Parameter'>__ctrlp</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN329"><span class='Ref_to_Parameter'>__buf</span></a><span class='Parentheses'>)</span><span class='Operator'>++</span><span class='Delimiter'>;</span>                                                <span class='Operator'>\ 
</span>        <a href="pg_lzcompress.c.html#LN329"><span class='Ref_to_Parameter'>__ctrlb</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>;</span>                                                        <span class='Operator'>\ 
</span>        <a href="pg_lzcompress.c.html#LN329"><span class='Ref_to_Parameter'>__ctrl</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>;</span>                                                         <span class='Operator'>\ 
</span>    <span class='Delimiter'>}</span>                                                                       <span class='Operator'>\ 
</span><span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>) 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pglz_out_literal - 
 * 
 *      Outputs a literal byte to the destination buffer including the 
 *      appropriate control bit. 
 * ---------- 
 */ 
</span><a name="LN348"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>pglz_out_literal</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>_ctrlp</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>_ctrlb</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>_ctrl</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>_buf</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>_byte</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span><span class='Control'>do</span> <span class='Delimiter'>{ </span><span class='Operator'>\ 
</span>    <a href="pg_lzcompress.c.html#LN329"><span class='Ref_to_Macro'>pglz_out_ctrl</span></a><span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN348"><span class='Ref_to_Parameter'>_ctrlp</span></a><span class='Delimiter'>,</span><a href="pg_lzcompress.c.html#LN348"><span class='Ref_to_Parameter'>_ctrlb</span></a><span class='Delimiter'>,</span><a href="pg_lzcompress.c.html#LN348"><span class='Ref_to_Parameter'>_ctrl</span></a><span class='Delimiter'>,</span><a href="pg_lzcompress.c.html#LN348"><span class='Ref_to_Parameter'>_buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>                                <span class='Operator'>\ 
</span>    <span class='Operator'>*</span><span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN348"><span class='Ref_to_Parameter'>_buf</span></a><span class='Parentheses'>)</span><span class='Operator'>++ = </span><span class='Parentheses'>(</span><span class='Keyword'>unsigned char</span><span class='Parentheses'>)(</span><a href="pg_lzcompress.c.html#LN348"><span class='Ref_to_Parameter'>_byte</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>                                     <span class='Operator'>\ 
</span>    <a href="pg_lzcompress.c.html#LN348"><span class='Ref_to_Parameter'>_ctrl</span></a> <span class='Operator'>&LT;&LT;= </span><span class='Number'>1</span><span class='Delimiter'>;</span>                                                            <span class='Operator'>\ 
</span><span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>) 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pglz_out_tag - 
 * 
 *      Outputs a backward reference tag of 2-4 bytes (depending on 
 *      offset and length) to the destination buffer including the 
 *      appropriate control bit. 
 * ---------- 
 */ 
</span><a name="LN364"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>pglz_out_tag</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>_ctrlp</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>_ctrlb</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>_ctrl</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>_buf</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>_len</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>_off</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span><span class='Control'>do</span> <span class='Delimiter'>{ </span><span class='Operator'>\ 
</span>    <a href="pg_lzcompress.c.html#LN329"><span class='Ref_to_Macro'>pglz_out_ctrl</span></a><span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN364"><span class='Ref_to_Parameter'>_ctrlp</span></a><span class='Delimiter'>,</span><a href="pg_lzcompress.c.html#LN364"><span class='Ref_to_Parameter'>_ctrlb</span></a><span class='Delimiter'>,</span><a href="pg_lzcompress.c.html#LN364"><span class='Ref_to_Parameter'>_ctrl</span></a><span class='Delimiter'>,</span><a href="pg_lzcompress.c.html#LN364"><span class='Ref_to_Parameter'>_buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>                                <span class='Operator'>\ 
</span>    <a href="pg_lzcompress.c.html#LN364"><span class='Ref_to_Parameter'>_ctrlb</span></a> <span class='Operator'>|= </span><a href="pg_lzcompress.c.html#LN364"><span class='Ref_to_Parameter'>_ctrl</span></a><span class='Delimiter'>;</span>                                                        <span class='Operator'>\ 
</span>    <a href="pg_lzcompress.c.html#LN364"><span class='Ref_to_Parameter'>_ctrl</span></a> <span class='Operator'>&LT;&LT;= </span><span class='Number'>1</span><span class='Delimiter'>;</span>                                                            <span class='Operator'>\ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN364"><span class='Ref_to_Parameter'>_len</span></a> <span class='Operator'>&GT; </span><span class='Number'>17</span><span class='Parentheses'>)</span>                                                          <span class='Operator'>\ 
</span>    <span class='Delimiter'>{</span>                                                                       <span class='Operator'>\ 
</span>        <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN364"><span class='Ref_to_Parameter'>_buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>unsigned char</span><span class='Parentheses'>)((((</span><a href="pg_lzcompress.c.html#LN364"><span class='Ref_to_Parameter'>_off</span></a><span class='Parentheses'>) </span><span class='Operator'>& </span><span class='Number'>0xf00</span><span class='Parentheses'>)</span> <span class='Operator'>&GT;&GT; </span><span class='Number'>4</span><span class='Parentheses'>)</span> <span class='Operator'>| </span><span class='Number'>0x0f</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>        <span class='Operator'>\ 
</span>        <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN364"><span class='Ref_to_Parameter'>_buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>unsigned char</span><span class='Parentheses'>)(((</span><a href="pg_lzcompress.c.html#LN364"><span class='Ref_to_Parameter'>_off</span></a><span class='Parentheses'>) </span><span class='Operator'>& </span><span class='Number'>0xff</span><span class='Parentheses'>))</span><span class='Delimiter'>;</span>                       <span class='Operator'>\ 
</span>        <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN364"><span class='Ref_to_Parameter'>_buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>unsigned char</span><span class='Parentheses'>)((</span><a href="pg_lzcompress.c.html#LN364"><span class='Ref_to_Parameter'>_len</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>18</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>                           <span class='Operator'>\ 
</span>        <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN364"><span class='Ref_to_Parameter'>_buf</span></a><span class='Parentheses'>) </span><span class='Operator'>+= </span><span class='Number'>3</span><span class='Delimiter'>;</span>                                                        <span class='Operator'>\ 
</span>    <span class='Delimiter'>} </span><span class='Control'>else</span> <span class='Delimiter'>{</span>                                                                <span class='Operator'>\ 
</span>        <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN364"><span class='Ref_to_Parameter'>_buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>unsigned char</span><span class='Parentheses'>)((((</span><a href="pg_lzcompress.c.html#LN364"><span class='Ref_to_Parameter'>_off</span></a><span class='Parentheses'>) </span><span class='Operator'>& </span><span class='Number'>0xf00</span><span class='Parentheses'>)</span> <span class='Operator'>&GT;&GT; </span><span class='Number'>4</span><span class='Parentheses'>)</span> <span class='Operator'>| </span><span class='Parentheses'>((</span><a href="pg_lzcompress.c.html#LN364"><span class='Ref_to_Parameter'>_len</span></a><span class='Parentheses'>)</span> <span class='Operator'>- </span><span class='Number'>3</span><span class='Parentheses'>))</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>        <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN364"><span class='Ref_to_Parameter'>_buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>unsigned char</span><span class='Parentheses'>)((</span><a href="pg_lzcompress.c.html#LN364"><span class='Ref_to_Parameter'>_off</span></a><span class='Parentheses'>) </span><span class='Operator'>& </span><span class='Number'>0xff</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>                         <span class='Operator'>\ 
</span>        <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN364"><span class='Ref_to_Parameter'>_buf</span></a><span class='Parentheses'>) </span><span class='Operator'>+= </span><span class='Number'>2</span><span class='Delimiter'>;</span>                                                        <span class='Operator'>\ 
</span>    <span class='Delimiter'>}</span>                                                                       <span class='Operator'>\ 
</span><span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>) 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pglz_find_match - 
 * 
 *      Lookup the history table if the actual input stream matches 
 *      another sequence of characters, starting somewhere earlier 
 *      in the input buffer. 
 * ---------- 
 */ 
</span><span class='Keyword'>static inline int 
</span><a name="LN392"></a><span class='Declare_Function'>pglz_find_match</span><span class='Parentheses'>(</span><a href="../include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hstart</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>input</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>end</span><span class='Delimiter'>, 
</span><a name="LN393"></a>                <span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>lenp</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>offp</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>good_match</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>good_drop</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>mask</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN395"></a>    <a href="pg_lzcompress.c.html#LN203"><span class='Ref_to_Struct'>PGLZ_HistEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>hent</span><span class='Delimiter'>; 
</span><a name="LN396"></a>    <a href="../include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a>       <span class='Declare_Local'>hentno</span><span class='Delimiter'>; 
</span><a name="LN397"></a>    <a href="../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>len</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN398"></a>    <a href="../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>off</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Traverse the linked history list until a good enough match is found. 
     */ 
</span>    <a href="pg_lzcompress.c.html#LN396"><span class='Ref_To_Local'>hentno</span></a> <span class='Operator'>= </span><a href="pg_lzcompress.c.html#LN392"><span class='Ref_to_Parameter'>hstart</span></a><span class='Delimiter'>[</span><a href="pg_lzcompress.c.html#LN270"><span class='Ref_to_Macro'>pglz_hist_idx</span></a><span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN392"><span class='Ref_to_Parameter'>input</span></a><span class='Delimiter'>, </span><a href="pg_lzcompress.c.html#LN392"><span class='Ref_to_Parameter'>end</span></a><span class='Delimiter'>, </span><a href="pg_lzcompress.c.html#LN393"><span class='Ref_to_Parameter'>mask</span></a><span class='Parentheses'>)</span><span class='Delimiter'>]; 
</span>    <a href="pg_lzcompress.c.html#LN395"><span class='Ref_To_Local'>hent</span></a> <span class='Operator'>= &</span><a href="pg_lzcompress.c.html#LN249"><span class='Ref_to_Global_Var'>hist_entries</span></a><span class='Delimiter'>[</span><a href="pg_lzcompress.c.html#LN396"><span class='Ref_To_Local'>hentno</span></a><span class='Delimiter'>]; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN395"><span class='Ref_To_Local'>hent</span></a> <span class='Operator'>!= </span><a href="pg_lzcompress.c.html#LN256"><span class='Ref_to_Const'>INVALID_ENTRY_PTR</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN407"></a>        <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>ip</span> <span class='Operator'>= </span><a href="pg_lzcompress.c.html#LN392"><span class='Ref_to_Parameter'>input</span></a><span class='Delimiter'>; 
</span><a name="LN408"></a>        <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>hp</span> <span class='Operator'>= </span><a href="pg_lzcompress.c.html#LN395"><span class='Ref_To_Local'>hent</span></a><span class='Operator'>-&GT;</span><a href="pg_lzcompress.c.html#LN208"><span class='Ref_to_Member'>pos</span></a><span class='Delimiter'>; 
</span><a name="LN409"></a>        <a href="../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>thisoff</span><span class='Delimiter'>; 
</span><a name="LN410"></a>        <a href="../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>thislen</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Stop if the offset does not fit into our tag anymore. 
         */ 
</span>        <a href="pg_lzcompress.c.html#LN409"><span class='Ref_To_Local'>thisoff</span></a> <span class='Operator'>= </span><a href="pg_lzcompress.c.html#LN407"><span class='Ref_To_Local'>ip</span></a> <span class='Operator'>- </span><a href="pg_lzcompress.c.html#LN408"><span class='Ref_To_Local'>hp</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN409"><span class='Ref_To_Local'>thisoff</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0x0fff</span><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Determine length of match. A better match must be larger than the 
         * best so far. And if we already have a match of 16 or more bytes, 
         * it's worth the call overhead to use memcmp() to check if this match 
         * is equal for the same size. After that we must fallback to 
         * character by character comparison to know the exact position where 
         * the diff occurred. 
         */ 
</span>        <a href="pg_lzcompress.c.html#LN410"><span class='Ref_To_Local'>thislen</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN397"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>&GT;= </span><span class='Number'>16</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>memcmp<span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN407"><span class='Ref_To_Local'>ip</span></a><span class='Delimiter'>, </span><a href="pg_lzcompress.c.html#LN408"><span class='Ref_To_Local'>hp</span></a><span class='Delimiter'>, </span><a href="pg_lzcompress.c.html#LN397"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="pg_lzcompress.c.html#LN410"><span class='Ref_To_Local'>thislen</span></a> <span class='Operator'>= </span><a href="pg_lzcompress.c.html#LN397"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>; 
</span>                <a href="pg_lzcompress.c.html#LN407"><span class='Ref_To_Local'>ip</span></a> <span class='Operator'>+= </span><a href="pg_lzcompress.c.html#LN397"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>; 
</span>                <a href="pg_lzcompress.c.html#LN408"><span class='Ref_To_Local'>hp</span></a> <span class='Operator'>+= </span><a href="pg_lzcompress.c.html#LN397"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN407"><span class='Ref_To_Local'>ip</span></a> <span class='Operator'>&LT; </span><a href="pg_lzcompress.c.html#LN392"><span class='Ref_to_Parameter'>end</span></a> <span class='Operator'>&& *</span><a href="pg_lzcompress.c.html#LN407"><span class='Ref_To_Local'>ip</span></a> <span class='Operator'>== *</span><a href="pg_lzcompress.c.html#LN408"><span class='Ref_To_Local'>hp</span></a> <span class='Operator'>&& </span><a href="pg_lzcompress.c.html#LN410"><span class='Ref_To_Local'>thislen</span></a> <span class='Operator'>&LT; </span><a href="pg_lzcompress.c.html#LN190"><span class='Ref_to_Const'>PGLZ_MAX_MATCH</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="pg_lzcompress.c.html#LN410"><span class='Ref_To_Local'>thislen</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                    <a href="pg_lzcompress.c.html#LN407"><span class='Ref_To_Local'>ip</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                    <a href="pg_lzcompress.c.html#LN408"><span class='Ref_To_Local'>hp</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN407"><span class='Ref_To_Local'>ip</span></a> <span class='Operator'>&LT; </span><a href="pg_lzcompress.c.html#LN392"><span class='Ref_to_Parameter'>end</span></a> <span class='Operator'>&& *</span><a href="pg_lzcompress.c.html#LN407"><span class='Ref_To_Local'>ip</span></a> <span class='Operator'>== *</span><a href="pg_lzcompress.c.html#LN408"><span class='Ref_To_Local'>hp</span></a> <span class='Operator'>&& </span><a href="pg_lzcompress.c.html#LN410"><span class='Ref_To_Local'>thislen</span></a> <span class='Operator'>&LT; </span><a href="pg_lzcompress.c.html#LN190"><span class='Ref_to_Const'>PGLZ_MAX_MATCH</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="pg_lzcompress.c.html#LN410"><span class='Ref_To_Local'>thislen</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <a href="pg_lzcompress.c.html#LN407"><span class='Ref_To_Local'>ip</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <a href="pg_lzcompress.c.html#LN408"><span class='Ref_To_Local'>hp</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Remember this match as the best (if it is) 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN410"><span class='Ref_To_Local'>thislen</span></a> <span class='Operator'>&GT; </span><a href="pg_lzcompress.c.html#LN397"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="pg_lzcompress.c.html#LN397"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span><a href="pg_lzcompress.c.html#LN410"><span class='Ref_To_Local'>thislen</span></a><span class='Delimiter'>; 
</span>            <a href="pg_lzcompress.c.html#LN398"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>= </span><a href="pg_lzcompress.c.html#LN409"><span class='Ref_To_Local'>thisoff</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Advance to the next history entry 
         */ 
</span>        <a href="pg_lzcompress.c.html#LN395"><span class='Ref_To_Local'>hent</span></a> <span class='Operator'>= </span><a href="pg_lzcompress.c.html#LN395"><span class='Ref_To_Local'>hent</span></a><span class='Operator'>-&GT;</span><a href="pg_lzcompress.c.html#LN205"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Be happy with lesser good matches the more entries we visited. But 
         * no point in doing calculation if we're at end of list. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN395"><span class='Ref_To_Local'>hent</span></a> <span class='Operator'>!= </span><a href="pg_lzcompress.c.html#LN256"><span class='Ref_to_Const'>INVALID_ENTRY_PTR</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN397"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>&GT;= </span><a href="pg_lzcompress.c.html#LN393"><span class='Ref_to_Parameter'>good_match</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <a href="pg_lzcompress.c.html#LN393"><span class='Ref_to_Parameter'>good_match</span></a> <span class='Operator'>-= </span><span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN393"><span class='Ref_to_Parameter'>good_match</span></a> <span class='Operator'>* </span><a href="pg_lzcompress.c.html#LN393"><span class='Ref_to_Parameter'>good_drop</span></a><span class='Parentheses'>) </span><span class='Operator'>/ </span><span class='Number'>100</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while hent!=INVALID_ENTRY_P... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Return match information only if it results at least in one byte 
     * reduction. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN397"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>&GT; </span><span class='Number'>2</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Operator'>*</span><a href="pg_lzcompress.c.html#LN393"><span class='Ref_to_Parameter'>lenp</span></a> <span class='Operator'>= </span><a href="pg_lzcompress.c.html#LN397"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="pg_lzcompress.c.html#LN393"><span class='Ref_to_Parameter'>offp</span></a> <span class='Operator'>= </span><a href="pg_lzcompress.c.html#LN398"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pglz_find_match &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pglz_compress - 
 * 
 *      Compresses source into dest using strategy. Returns the number of 
 *      bytes written in buffer dest, or -1 if compression fails. 
 * ---------- 
 */ 
</span><a href="../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> 
<a name="LN502"></a><span class='Declare_Function'>pglz_compress</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>source</span><span class='Delimiter'>, </span><a href="../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Declare_Parameter'>slen</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dest</span><span class='Delimiter'>, 
</span><a name="LN503"></a>              <span class='Keyword'>const </span><a href="../include/common/pg_lzcompress.h.html#LN56"><span class='Ref_to_Struct'>PGLZ_Strategy</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>strategy</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN505"></a>    <span class='Keyword'>unsigned char </span><span class='Operator'>*</span><span class='Declare_Local'>bp</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>unsigned char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="pg_lzcompress.c.html#LN502"><span class='Ref_to_Parameter'>dest</span></a><span class='Delimiter'>; 
</span><a name="LN506"></a>    <span class='Keyword'>unsigned char </span><span class='Operator'>*</span><span class='Declare_Local'>bstart</span> <span class='Operator'>= </span><a href="pg_lzcompress.c.html#LN505"><span class='Ref_To_Local'>bp</span></a><span class='Delimiter'>; 
</span><a name="LN507"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>hist_next</span> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span><a name="LN508"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>hist_recycle</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN509"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>dp</span> <span class='Operator'>= </span><a href="pg_lzcompress.c.html#LN502"><span class='Ref_to_Parameter'>source</span></a><span class='Delimiter'>; 
</span><a name="LN510"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>dend</span> <span class='Operator'>= </span><a href="pg_lzcompress.c.html#LN502"><span class='Ref_to_Parameter'>source</span></a> <span class='Operator'>+ </span><a href="pg_lzcompress.c.html#LN502"><span class='Ref_to_Parameter'>slen</span></a><span class='Delimiter'>; 
</span><a name="LN511"></a>    <span class='Keyword'>unsigned char </span><span class='Declare_Local'>ctrl_dummy</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN512"></a>    <span class='Keyword'>unsigned char </span><span class='Operator'>*</span><span class='Declare_Local'>ctrlp</span> <span class='Operator'>= &</span><a href="pg_lzcompress.c.html#LN511"><span class='Ref_To_Local'>ctrl_dummy</span></a><span class='Delimiter'>; 
</span><a name="LN513"></a>    <span class='Keyword'>unsigned char </span><span class='Declare_Local'>ctrlb</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN514"></a>    <span class='Keyword'>unsigned char </span><span class='Declare_Local'>ctrl</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN515"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found_match</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN516"></a>    <a href="../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>match_len</span><span class='Delimiter'>; 
</span><a name="LN517"></a>    <a href="../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>match_off</span><span class='Delimiter'>; 
</span><a name="LN518"></a>    <a href="../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>good_match</span><span class='Delimiter'>; 
</span><a name="LN519"></a>    <a href="../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>good_drop</span><span class='Delimiter'>; 
</span><a name="LN520"></a>    <a href="../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>result_size</span><span class='Delimiter'>; 
</span><a name="LN521"></a>    <a href="../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>result_max</span><span class='Delimiter'>; 
</span><a name="LN522"></a>    <a href="../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>need_rate</span><span class='Delimiter'>; 
</span><a name="LN523"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>hashsz</span><span class='Delimiter'>; 
</span><a name="LN524"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>mask</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Our fallback strategy is the default. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN503"><span class='Ref_to_Parameter'>strategy</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="pg_lzcompress.c.html#LN503"><span class='Ref_to_Parameter'>strategy</span></a> <span class='Operator'>= </span><a href="pg_lzcompress.c.html#LN229"><span class='Ref_to_Global_Var'>PGLZ_strategy_default</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the strategy forbids compression (at all or if source chunk size out 
     * of range), fail. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN503"><span class='Ref_to_Parameter'>strategy</span></a><span class='Operator'>-&GT;</span><a href="../include/common/pg_lzcompress.h.html#LN62"><span class='Ref_to_Member'>match_size_good</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>        <a href="pg_lzcompress.c.html#LN502"><span class='Ref_to_Parameter'>slen</span></a> <span class='Operator'>&LT; </span><a href="pg_lzcompress.c.html#LN503"><span class='Ref_to_Parameter'>strategy</span></a><span class='Operator'>-&GT;</span><a href="../include/common/pg_lzcompress.h.html#LN58"><span class='Ref_to_Member'>min_input_size</span></a> <span class='Operator'>|| 
</span>        <a href="pg_lzcompress.c.html#LN502"><span class='Ref_to_Parameter'>slen</span></a> <span class='Operator'>&GT; </span><a href="pg_lzcompress.c.html#LN503"><span class='Ref_to_Parameter'>strategy</span></a><span class='Operator'>-&GT;</span><a href="../include/common/pg_lzcompress.h.html#LN59"><span class='Ref_to_Member'>max_input_size</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Limit the match parameters to the supported range. 
     */ 
</span>    <a href="pg_lzcompress.c.html#LN518"><span class='Ref_To_Local'>good_match</span></a> <span class='Operator'>= </span><a href="pg_lzcompress.c.html#LN503"><span class='Ref_to_Parameter'>strategy</span></a><span class='Operator'>-&GT;</span><a href="../include/common/pg_lzcompress.h.html#LN62"><span class='Ref_to_Member'>match_size_good</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN518"><span class='Ref_To_Local'>good_match</span></a> <span class='Operator'>&GT; </span><a href="pg_lzcompress.c.html#LN190"><span class='Ref_to_Const'>PGLZ_MAX_MATCH</span></a><span class='Parentheses'>) 
</span>        <a href="pg_lzcompress.c.html#LN518"><span class='Ref_To_Local'>good_match</span></a> <span class='Operator'>= </span><a href="pg_lzcompress.c.html#LN190"><span class='Ref_to_Const'>PGLZ_MAX_MATCH</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN518"><span class='Ref_To_Local'>good_match</span></a> <span class='Operator'>&LT; </span><span class='Number'>17</span><span class='Parentheses'>) 
</span>        <a href="pg_lzcompress.c.html#LN518"><span class='Ref_To_Local'>good_match</span></a> <span class='Operator'>= </span><span class='Number'>17</span><span class='Delimiter'>; 
</span> 
    <a href="pg_lzcompress.c.html#LN519"><span class='Ref_To_Local'>good_drop</span></a> <span class='Operator'>= </span><a href="pg_lzcompress.c.html#LN503"><span class='Ref_to_Parameter'>strategy</span></a><span class='Operator'>-&GT;</span><a href="../include/common/pg_lzcompress.h.html#LN63"><span class='Ref_to_Member'>match_size_drop</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN519"><span class='Ref_To_Local'>good_drop</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="pg_lzcompress.c.html#LN519"><span class='Ref_To_Local'>good_drop</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN519"><span class='Ref_To_Local'>good_drop</span></a> <span class='Operator'>&GT; </span><span class='Number'>100</span><span class='Parentheses'>) 
</span>        <a href="pg_lzcompress.c.html#LN519"><span class='Ref_To_Local'>good_drop</span></a> <span class='Operator'>= </span><span class='Number'>100</span><span class='Delimiter'>; 
</span> 
    <a href="pg_lzcompress.c.html#LN522"><span class='Ref_To_Local'>need_rate</span></a> <span class='Operator'>= </span><a href="pg_lzcompress.c.html#LN503"><span class='Ref_to_Parameter'>strategy</span></a><span class='Operator'>-&GT;</span><a href="../include/common/pg_lzcompress.h.html#LN60"><span class='Ref_to_Member'>min_comp_rate</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN522"><span class='Ref_To_Local'>need_rate</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="pg_lzcompress.c.html#LN522"><span class='Ref_To_Local'>need_rate</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN522"><span class='Ref_To_Local'>need_rate</span></a> <span class='Operator'>&GT; </span><span class='Number'>99</span><span class='Parentheses'>) 
</span>        <a href="pg_lzcompress.c.html#LN522"><span class='Ref_To_Local'>need_rate</span></a> <span class='Operator'>= </span><span class='Number'>99</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Compute the maximum result size allowed by the strategy, namely the 
     * input size minus the minimum wanted compression rate.  This had better 
     * be &LT;= slen, else we might overrun the provided output buffer. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN502"><span class='Ref_to_Parameter'>slen</span></a> <span class='Operator'>&GT; </span><span class='Parentheses'>(</span>INT_MAX <span class='Operator'>/ </span><span class='Number'>100</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Approximate to avoid overflow */ 
</span>        <a href="pg_lzcompress.c.html#LN521"><span class='Ref_To_Local'>result_max</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN502"><span class='Ref_to_Parameter'>slen</span></a> <span class='Operator'>/ </span><span class='Number'>100</span><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Parentheses'>(</span><span class='Number'>100</span> <span class='Operator'>- </span><a href="pg_lzcompress.c.html#LN522"><span class='Ref_To_Local'>need_rate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="pg_lzcompress.c.html#LN521"><span class='Ref_To_Local'>result_max</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN502"><span class='Ref_to_Parameter'>slen</span></a> <span class='Operator'>* </span><span class='Parentheses'>(</span><span class='Number'>100</span> <span class='Operator'>- </span><a href="pg_lzcompress.c.html#LN522"><span class='Ref_To_Local'>need_rate</span></a><span class='Parentheses'>))</span> <span class='Operator'>/ </span><span class='Number'>100</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Experiments suggest that these hash sizes work pretty well. A large 
     * hash table minimizes collision, but has a higher startup cost. For a 
     * small input, the startup cost dominates. The table size must be a power 
     * of two. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN502"><span class='Ref_to_Parameter'>slen</span></a> <span class='Operator'>&LT; </span><span class='Number'>128</span><span class='Parentheses'>) 
</span>        <a href="pg_lzcompress.c.html#LN523"><span class='Ref_To_Local'>hashsz</span></a> <span class='Operator'>= </span><span class='Number'>512</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN502"><span class='Ref_to_Parameter'>slen</span></a> <span class='Operator'>&LT; </span><span class='Number'>256</span><span class='Parentheses'>) 
</span>        <a href="pg_lzcompress.c.html#LN523"><span class='Ref_To_Local'>hashsz</span></a> <span class='Operator'>= </span><span class='Number'>1024</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN502"><span class='Ref_to_Parameter'>slen</span></a> <span class='Operator'>&LT; </span><span class='Number'>512</span><span class='Parentheses'>) 
</span>        <a href="pg_lzcompress.c.html#LN523"><span class='Ref_To_Local'>hashsz</span></a> <span class='Operator'>= </span><span class='Number'>2048</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN502"><span class='Ref_to_Parameter'>slen</span></a> <span class='Operator'>&LT; </span><span class='Number'>1024</span><span class='Parentheses'>) 
</span>        <a href="pg_lzcompress.c.html#LN523"><span class='Ref_To_Local'>hashsz</span></a> <span class='Operator'>= </span><span class='Number'>4096</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="pg_lzcompress.c.html#LN523"><span class='Ref_To_Local'>hashsz</span></a> <span class='Operator'>= </span><span class='Number'>8192</span><span class='Delimiter'>; 
</span>    <a href="pg_lzcompress.c.html#LN524"><span class='Ref_To_Local'>mask</span></a> <span class='Operator'>= </span><a href="pg_lzcompress.c.html#LN523"><span class='Ref_To_Local'>hashsz</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Initialize the history lists to empty.  We do not need to zero the 
     * hist_entries[] array; its entries are initialized as they are used. 
     */ 
</span>    memset<span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN248"><span class='Ref_to_Global_Var'>hist_start</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="pg_lzcompress.c.html#LN523"><span class='Ref_To_Local'>hashsz</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Compress the source directly into the output buffer. 
     */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN509"><span class='Ref_To_Local'>dp</span></a> <span class='Operator'>&LT; </span><a href="pg_lzcompress.c.html#LN510"><span class='Ref_To_Local'>dend</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * If we already exceeded the maximum result size, fail. 
         * 
         * We check once per loop; since the loop body could emit as many as 4 
         * bytes (a control byte and 3-byte tag), PGLZ_MAX_OUTPUT() had better 
         * allow 4 slop bytes. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN505"><span class='Ref_To_Local'>bp</span></a> <span class='Operator'>- </span><a href="pg_lzcompress.c.html#LN506"><span class='Ref_To_Local'>bstart</span></a> <span class='Operator'>&GT;= </span><a href="pg_lzcompress.c.html#LN521"><span class='Ref_To_Local'>result_max</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If we've emitted more than first_success_by bytes without finding 
         * anything compressible at all, fail.  This lets us fall out 
         * reasonably quickly when looking at incompressible input (such as 
         * pre-compressed data). 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_lzcompress.c.html#LN515"><span class='Ref_To_Local'>found_match</span></a> <span class='Operator'>&& </span><a href="pg_lzcompress.c.html#LN505"><span class='Ref_To_Local'>bp</span></a> <span class='Operator'>- </span><a href="pg_lzcompress.c.html#LN506"><span class='Ref_To_Local'>bstart</span></a> <span class='Operator'>&GT;= </span><a href="pg_lzcompress.c.html#LN503"><span class='Ref_to_Parameter'>strategy</span></a><span class='Operator'>-&GT;</span><a href="../include/common/pg_lzcompress.h.html#LN61"><span class='Ref_to_Member'>first_success_by</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Try to find a match in the history 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN391"><span class='Ref_to_Func'>pglz_find_match</span></a><span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN248"><span class='Ref_to_Global_Var'>hist_start</span></a><span class='Delimiter'>, </span><a href="pg_lzcompress.c.html#LN509"><span class='Ref_To_Local'>dp</span></a><span class='Delimiter'>, </span><a href="pg_lzcompress.c.html#LN510"><span class='Ref_To_Local'>dend</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_lzcompress.c.html#LN516"><span class='Ref_To_Local'>match_len</span></a><span class='Delimiter'>, 
</span>                            <span class='Operator'>&</span><a href="pg_lzcompress.c.html#LN517"><span class='Ref_To_Local'>match_off</span></a><span class='Delimiter'>, </span><a href="pg_lzcompress.c.html#LN518"><span class='Ref_To_Local'>good_match</span></a><span class='Delimiter'>, </span><a href="pg_lzcompress.c.html#LN519"><span class='Ref_To_Local'>good_drop</span></a><span class='Delimiter'>, </span><a href="pg_lzcompress.c.html#LN524"><span class='Ref_To_Local'>mask</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Create the tag and add history entries for all matched 
             * characters. 
             */ 
</span>            <a href="pg_lzcompress.c.html#LN364"><span class='Ref_to_Macro'>pglz_out_tag</span></a><span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN512"><span class='Ref_To_Local'>ctrlp</span></a><span class='Delimiter'>, </span><a href="pg_lzcompress.c.html#LN513"><span class='Ref_To_Local'>ctrlb</span></a><span class='Delimiter'>, </span><a href="pg_lzcompress.c.html#LN514"><span class='Ref_To_Local'>ctrl</span></a><span class='Delimiter'>, </span><a href="pg_lzcompress.c.html#LN505"><span class='Ref_To_Local'>bp</span></a><span class='Delimiter'>, </span><a href="pg_lzcompress.c.html#LN516"><span class='Ref_To_Local'>match_len</span></a><span class='Delimiter'>, </span><a href="pg_lzcompress.c.html#LN517"><span class='Ref_To_Local'>match_off</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN516"><span class='Ref_To_Local'>match_len</span></a><span class='Operator'>--</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="pg_lzcompress.c.html#LN289"><span class='Ref_to_Macro'>pglz_hist_add</span></a><span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN248"><span class='Ref_to_Global_Var'>hist_start</span></a><span class='Delimiter'>, </span><a href="pg_lzcompress.c.html#LN249"><span class='Ref_to_Global_Var'>hist_entries</span></a><span class='Delimiter'>, 
</span>                              <a href="pg_lzcompress.c.html#LN507"><span class='Ref_To_Local'>hist_next</span></a><span class='Delimiter'>, </span><a href="pg_lzcompress.c.html#LN508"><span class='Ref_To_Local'>hist_recycle</span></a><span class='Delimiter'>, 
</span>                              <a href="pg_lzcompress.c.html#LN509"><span class='Ref_To_Local'>dp</span></a><span class='Delimiter'>, </span><a href="pg_lzcompress.c.html#LN510"><span class='Ref_To_Local'>dend</span></a><span class='Delimiter'>, </span><a href="pg_lzcompress.c.html#LN524"><span class='Ref_To_Local'>mask</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="pg_lzcompress.c.html#LN509"><span class='Ref_To_Local'>dp</span></a><span class='Operator'>++</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* Do not do this ++ in the line above! */ 
</span>                <span class='Comment_Multi_Line'>/* The macro would do it four times - Jan.  */ 
</span>            <span class='Delimiter'>} 
</span>            <a href="pg_lzcompress.c.html#LN515"><span class='Ref_To_Local'>found_match</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * No match found. Copy one literal byte. 
             */ 
</span>            <a href="pg_lzcompress.c.html#LN348"><span class='Ref_to_Macro'>pglz_out_literal</span></a><span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN512"><span class='Ref_To_Local'>ctrlp</span></a><span class='Delimiter'>, </span><a href="pg_lzcompress.c.html#LN513"><span class='Ref_To_Local'>ctrlb</span></a><span class='Delimiter'>, </span><a href="pg_lzcompress.c.html#LN514"><span class='Ref_To_Local'>ctrl</span></a><span class='Delimiter'>, </span><a href="pg_lzcompress.c.html#LN505"><span class='Ref_To_Local'>bp</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="pg_lzcompress.c.html#LN509"><span class='Ref_To_Local'>dp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pg_lzcompress.c.html#LN289"><span class='Ref_to_Macro'>pglz_hist_add</span></a><span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN248"><span class='Ref_to_Global_Var'>hist_start</span></a><span class='Delimiter'>, </span><a href="pg_lzcompress.c.html#LN249"><span class='Ref_to_Global_Var'>hist_entries</span></a><span class='Delimiter'>, 
</span>                          <a href="pg_lzcompress.c.html#LN507"><span class='Ref_To_Local'>hist_next</span></a><span class='Delimiter'>, </span><a href="pg_lzcompress.c.html#LN508"><span class='Ref_To_Local'>hist_recycle</span></a><span class='Delimiter'>, 
</span>                          <a href="pg_lzcompress.c.html#LN509"><span class='Ref_To_Local'>dp</span></a><span class='Delimiter'>, </span><a href="pg_lzcompress.c.html#LN510"><span class='Ref_To_Local'>dend</span></a><span class='Delimiter'>, </span><a href="pg_lzcompress.c.html#LN524"><span class='Ref_To_Local'>mask</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pg_lzcompress.c.html#LN509"><span class='Ref_To_Local'>dp</span></a><span class='Operator'>++</span><span class='Delimiter'>;</span>               <span class='Comment_Single_Line'>/* Do not do this ++ in the line above! */ 
</span>            <span class='Comment_Multi_Line'>/* The macro would do it four times - Jan.  */ 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while dp&LT;dend &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Write out the last control byte and check that we haven't overrun the 
     * output size allowed by the strategy. 
     */ 
</span>    <span class='Operator'>*</span><a href="pg_lzcompress.c.html#LN512"><span class='Ref_To_Local'>ctrlp</span></a> <span class='Operator'>= </span><a href="pg_lzcompress.c.html#LN513"><span class='Ref_To_Local'>ctrlb</span></a><span class='Delimiter'>; 
</span>    <a href="pg_lzcompress.c.html#LN520"><span class='Ref_To_Local'>result_size</span></a> <span class='Operator'>= </span><a href="pg_lzcompress.c.html#LN505"><span class='Ref_To_Local'>bp</span></a> <span class='Operator'>- </span><a href="pg_lzcompress.c.html#LN506"><span class='Ref_To_Local'>bstart</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN520"><span class='Ref_To_Local'>result_size</span></a> <span class='Operator'>&GT;= </span><a href="pg_lzcompress.c.html#LN521"><span class='Ref_To_Local'>result_max</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* success */ 
</span>    <span class='Control'>return</span> <a href="pg_lzcompress.c.html#LN520"><span class='Ref_To_Local'>result_size</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pglz_compress &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pglz_decompress - 
 * 
 *      Decompresses source into dest. Returns the number of bytes 
 *      decompressed in the destination buffer, or -1 if decompression 
 *      fails. 
 * ---------- 
 */ 
</span><a href="../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> 
<a name="LN681"></a><span class='Declare_Function'>pglz_decompress</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>source</span><span class='Delimiter'>, </span><a href="../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Declare_Parameter'>slen</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dest</span><span class='Delimiter'>, 
</span><a name="LN682"></a>                <a href="../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Declare_Parameter'>rawsize</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN684"></a>    <span class='Keyword'>const unsigned char </span><span class='Operator'>*</span><span class='Declare_Local'>sp</span><span class='Delimiter'>; 
</span><a name="LN685"></a>    <span class='Keyword'>const unsigned char </span><span class='Operator'>*</span><span class='Declare_Local'>srcend</span><span class='Delimiter'>; 
</span><a name="LN686"></a>    <span class='Keyword'>unsigned char </span><span class='Operator'>*</span><span class='Declare_Local'>dp</span><span class='Delimiter'>; 
</span><a name="LN687"></a>    <span class='Keyword'>unsigned char </span><span class='Operator'>*</span><span class='Declare_Local'>destend</span><span class='Delimiter'>; 
</span> 
    <a href="pg_lzcompress.c.html#LN684"><span class='Ref_To_Local'>sp</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>const unsigned char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="pg_lzcompress.c.html#LN681"><span class='Ref_to_Parameter'>source</span></a><span class='Delimiter'>; 
</span>    <a href="pg_lzcompress.c.html#LN685"><span class='Ref_To_Local'>srcend</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><span class='Keyword'>const unsigned char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="pg_lzcompress.c.html#LN681"><span class='Ref_to_Parameter'>source</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ </span><a href="pg_lzcompress.c.html#LN681"><span class='Ref_to_Parameter'>slen</span></a><span class='Delimiter'>; 
</span>    <a href="pg_lzcompress.c.html#LN686"><span class='Ref_To_Local'>dp</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>unsigned char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="pg_lzcompress.c.html#LN681"><span class='Ref_to_Parameter'>dest</span></a><span class='Delimiter'>; 
</span>    <a href="pg_lzcompress.c.html#LN687"><span class='Ref_To_Local'>destend</span></a> <span class='Operator'>= </span><a href="pg_lzcompress.c.html#LN686"><span class='Ref_To_Local'>dp</span></a> <span class='Operator'>+ </span><a href="pg_lzcompress.c.html#LN682"><span class='Ref_to_Parameter'>rawsize</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN684"><span class='Ref_To_Local'>sp</span></a> <span class='Operator'>&LT; </span><a href="pg_lzcompress.c.html#LN685"><span class='Ref_To_Local'>srcend</span></a> <span class='Operator'>&& </span><a href="pg_lzcompress.c.html#LN686"><span class='Ref_To_Local'>dp</span></a> <span class='Operator'>&LT; </span><a href="pg_lzcompress.c.html#LN687"><span class='Ref_To_Local'>destend</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Read one control byte and process the next 8 items (or as many as 
         * remain in the compressed input). 
         */ 
</span><a name="LN700"></a>        <span class='Keyword'>unsigned char </span><span class='Declare_Local'>ctrl</span> <span class='Operator'>= *</span><a href="pg_lzcompress.c.html#LN684"><span class='Ref_To_Local'>sp</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span><a name="LN701"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>ctrlc</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN701"><span class='Ref_To_Local'>ctrlc</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pg_lzcompress.c.html#LN701"><span class='Ref_To_Local'>ctrlc</span></a> <span class='Operator'>&LT; </span><span class='Number'>8</span> <span class='Operator'>&& </span><a href="pg_lzcompress.c.html#LN684"><span class='Ref_To_Local'>sp</span></a> <span class='Operator'>&LT; </span><a href="pg_lzcompress.c.html#LN685"><span class='Ref_To_Local'>srcend</span></a><span class='Delimiter'>; </span><a href="pg_lzcompress.c.html#LN701"><span class='Ref_To_Local'>ctrlc</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN700"><span class='Ref_To_Local'>ctrl</span></a> <span class='Operator'>& </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * Otherwise it contains the match length minus 3 and the 
                 * upper 4 bits of the offset. The next following byte 
                 * contains the lower 8 bits of the offset. If the length is 
                 * coded as 18, another extension tag byte tells how much 
                 * longer the match really was (0-255). 
                 */ 
</span><a name="LN714"></a>                <a href="../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span><a name="LN715"></a>                <a href="../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>off</span><span class='Delimiter'>; 
</span> 
                <a href="pg_lzcompress.c.html#LN714"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN684"><span class='Ref_To_Local'>sp</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>& </span><span class='Number'>0x0f</span><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>3</span><span class='Delimiter'>; 
</span>                <a href="pg_lzcompress.c.html#LN715"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="pg_lzcompress.c.html#LN684"><span class='Ref_To_Local'>sp</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>& </span><span class='Number'>0xf0</span><span class='Parentheses'>) </span><span class='Operator'>&LT;&LT; </span><span class='Number'>4</span><span class='Parentheses'>)</span> <span class='Operator'>| </span><a href="pg_lzcompress.c.html#LN684"><span class='Ref_To_Local'>sp</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span>                <a href="pg_lzcompress.c.html#LN684"><span class='Ref_To_Local'>sp</span></a> <span class='Operator'>+= </span><span class='Number'>2</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN714"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>== </span><span class='Number'>18</span><span class='Parentheses'>) 
</span>                    <a href="pg_lzcompress.c.html#LN714"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>+= *</span><a href="pg_lzcompress.c.html#LN684"><span class='Ref_To_Local'>sp</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * Check for output buffer overrun, to ensure we don't clobber 
                 * memory in case of corrupt input.  Note: we must advance dp 
                 * here to ensure the error is detected below the loop.  We 
                 * don't simply put the elog inside the loop since that will 
                 * probably interfere with optimization. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN686"><span class='Ref_To_Local'>dp</span></a> <span class='Operator'>+ </span><a href="pg_lzcompress.c.html#LN714"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>&GT; </span><a href="pg_lzcompress.c.html#LN687"><span class='Ref_To_Local'>destend</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="pg_lzcompress.c.html#LN686"><span class='Ref_To_Local'>dp</span></a> <span class='Operator'>+= </span><a href="pg_lzcompress.c.html#LN714"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * Now we copy the bytes specified by the tag from OUTPUT to 
                 * OUTPUT. It is dangerous and platform dependent to use 
                 * memcpy() here, because the copied areas could overlap 
                 * extremely! 
                 */ 
</span>                <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN714"><span class='Ref_To_Local'>len</span></a><span class='Operator'>--</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Operator'>*</span><a href="pg_lzcompress.c.html#LN686"><span class='Ref_To_Local'>dp</span></a> <span class='Operator'>= </span><a href="pg_lzcompress.c.html#LN686"><span class='Ref_To_Local'>dp</span></a><span class='Delimiter'>[</span><span class='Operator'>-</span><a href="pg_lzcompress.c.html#LN715"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>]; 
</span>                    <a href="pg_lzcompress.c.html#LN686"><span class='Ref_To_Local'>dp</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if ctrl&1 &raquo; </span> 
            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * An unset control bit means LITERAL BYTE. So we just copy 
                 * one from INPUT to OUTPUT. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN686"><span class='Ref_To_Local'>dp</span></a> <span class='Operator'>&GT;= </span><a href="pg_lzcompress.c.html#LN687"><span class='Ref_To_Local'>destend</span></a><span class='Parentheses'>)</span>      <span class='Comment_Single_Line'>/* check for buffer overrun */ 
</span>                    <span class='Control'>break</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* do not clobber memory */ 
</span> 
                <span class='Operator'>*</span><a href="pg_lzcompress.c.html#LN686"><span class='Ref_To_Local'>dp</span></a><span class='Operator'>++ = *</span><a href="pg_lzcompress.c.html#LN684"><span class='Ref_To_Local'>sp</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Advance the control bit 
             */ 
</span>            <a href="pg_lzcompress.c.html#LN700"><span class='Ref_To_Local'>ctrl</span></a> <span class='Operator'>&GT;&GT;= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ctrlc=0;ctrlc&LT;8&&sp&LT;s... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while sp&LT;srcend&&dp&LT;destend &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Check we decompressed the right amount. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_lzcompress.c.html#LN686"><span class='Ref_To_Local'>dp</span></a> <span class='Operator'>!= </span><a href="pg_lzcompress.c.html#LN687"><span class='Ref_To_Local'>destend</span></a> <span class='Operator'>|| </span><a href="pg_lzcompress.c.html#LN684"><span class='Ref_To_Local'>sp</span></a> <span class='Operator'>!= </span><a href="pg_lzcompress.c.html#LN685"><span class='Ref_To_Local'>srcend</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * That's it. 
     */ 
</span>    <span class='Control'>return</span> <a href="pg_lzcompress.c.html#LN682"><span class='Ref_to_Parameter'>rawsize</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pglz_decompress &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>