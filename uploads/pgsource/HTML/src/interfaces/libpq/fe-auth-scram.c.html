<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\interfaces\libpq\fe-auth-scram.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\interfaces\libpq\fe-auth-scram.c</b></p></td>
<td align='right'>
Wed Jun 14 08:26:10 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * fe-auth-scram.c 
 *     The front-end (client) implementation of SCRAM authentication. 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * IDENTIFICATION 
 *    src/interfaces/libpq/fe-auth-scram.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres_fe.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"common/base64.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"common/saslprep.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"common/scram-common.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"fe-auth.h"</span> 
 
<span class='Comment_Multi_Line'>/* These are needed for getpid(), in the fallback implementation */ 
</span><span class='Directive'>#ifndef</span> HAVE_STRONG_RANDOM 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/types.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
<span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Status of exchange messages used for SCRAM authentication via the 
 * SASL protocol. 
 */ 
</span><span class='Control'>typedef</span> <span class='Control'>enum</span> 
<span class='Delimiter'>{ 
</span><a name="LN33"></a>    <span class='Declare_Enum_Const'>FE_SCRAM_INIT</span><span class='Delimiter'>, 
</span><a name="LN34"></a>    <span class='Declare_Enum_Const'>FE_SCRAM_NONCE_SENT</span><span class='Delimiter'>, 
</span><a name="LN35"></a>    <span class='Declare_Enum_Const'>FE_SCRAM_PROOF_SENT</span><span class='Delimiter'>, 
</span><a name="LN36"></a>    <span class='Declare_Enum_Const'>FE_SCRAM_FINISHED</span> 
<a name="LN37"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>fe_scram_state_enum</span><span class='Delimiter'>; 
</span> 
<span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN41"></a>    <a href="fe-auth-scram.c.html#LN31"><span class='Ref_to_Typedef'>fe_scram_state_enum</span></a> <span class='Declare_Member'>state</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* These are supplied by the user */ 
</span><a name="LN44"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Member'>username</span><span class='Delimiter'>; 
</span><a name="LN45"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Member'>password</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We construct these */ 
</span><a name="LN48"></a>    <a href="../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Member'>SaltedPassword</span><span class='Delimiter'>[</span><a href="../../include/common/scram-common.h.html#LN18"><span class='Ref_to_Const'>SCRAM_KEY_LEN</span></a><span class='Delimiter'>]; 
</span><a name="LN49"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Member'>client_nonce</span><span class='Delimiter'>; 
</span><a name="LN50"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Member'>client_first_message_bare</span><span class='Delimiter'>; 
</span><a name="LN51"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Member'>client_final_message_without_proof</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* These come from the server-first message */ 
</span><a name="LN54"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Member'>server_first_message</span><span class='Delimiter'>; 
</span><a name="LN55"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Member'>salt</span><span class='Delimiter'>; 
</span><a name="LN56"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>saltlen</span><span class='Delimiter'>; 
</span><a name="LN57"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>iterations</span><span class='Delimiter'>; 
</span><a name="LN58"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Member'>nonce</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* These come from the server-final message */ 
</span><a name="LN61"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Member'>server_final_message</span><span class='Delimiter'>; 
</span><a name="LN62"></a>    <span class='Keyword'>char</span>        <span class='Declare_Member'>ServerSignature</span><span class='Delimiter'>[</span><a href="../../include/common/scram-common.h.html#LN18"><span class='Ref_to_Const'>SCRAM_KEY_LEN</span></a><span class='Delimiter'>]; 
</span><a name="LN63"></a>}<span class='Auto_Annotations'> &laquo; end {anonfe_scram_state} &raquo; </span> <span class='Declare_Typedef'>fe_scram_state</span><span class='Delimiter'>; 
</span> 
<a name="LN65"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>read_server_first_message</span><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN39"><span class='Ref_to_Typedef'>fe_scram_state</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>input</span><span class='Delimiter'>, 
</span><a name="LN66"></a>                          <a href="pqexpbuffer.h.html#LN50"><span class='Ref_to_Typedef'>PQExpBuffer</span></a> <span class='Declare_Parameter'>errormessage</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN67"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>read_server_final_message</span><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN39"><span class='Ref_to_Typedef'>fe_scram_state</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>input</span><span class='Delimiter'>, 
</span><a name="LN68"></a>                          <a href="pqexpbuffer.h.html#LN50"><span class='Ref_to_Typedef'>PQExpBuffer</span></a> <span class='Declare_Parameter'>errormessage</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN69"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Prototype'>build_client_first_message</span><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN39"><span class='Ref_to_Typedef'>fe_scram_state</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, 
</span><a name="LN70"></a>                           <a href="pqexpbuffer.h.html#LN50"><span class='Ref_to_Typedef'>PQExpBuffer</span></a> <span class='Declare_Parameter'>errormessage</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN71"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Prototype'>build_client_final_message</span><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN39"><span class='Ref_to_Typedef'>fe_scram_state</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, 
</span><a name="LN72"></a>                           <a href="pqexpbuffer.h.html#LN50"><span class='Ref_to_Typedef'>PQExpBuffer</span></a> <span class='Declare_Parameter'>errormessage</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN73"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>verify_server_signature</span><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN39"><span class='Ref_to_Typedef'>fe_scram_state</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN74"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>calculate_client_proof</span><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN39"><span class='Ref_to_Typedef'>fe_scram_state</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, 
</span><a name="LN75"></a>                       <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>client_final_message_without_proof</span><span class='Delimiter'>, 
</span><a name="LN76"></a>                       <a href="../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>result</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN77"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>pg_frontend_random</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dst</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Initialize SCRAM exchange status. 
 */ 
</span><span class='Keyword'>void </span><span class='Operator'>* 
</span><a name="LN83"></a><span class='Declare_Function'>pg_fe_scram_init</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>username</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>password</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN85"></a>    <a href="fe-auth-scram.c.html#LN39"><span class='Ref_to_Typedef'>fe_scram_state</span></a> <span class='Operator'>*</span><span class='Declare_Local'>state</span><span class='Delimiter'>; 
</span><a name="LN86"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>prep_password</span><span class='Delimiter'>; 
</span><a name="LN87"></a>    <a href="../../include/common/saslprep.h.html#LN19"><span class='Ref_to_Typedef'>pg_saslprep_rc</span></a> <span class='Declare_Local'>rc</span><span class='Delimiter'>; 
</span> 
    <a href="fe-auth-scram.c.html#LN85"><span class='Ref_To_Local'>state</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN39"><span class='Ref_to_Typedef'>fe_scram_state</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/snowball/header.h.html#LN49"><span class='Ref_to_Macro'>malloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN39"><span class='Ref_to_Typedef'>fe_scram_state</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fe-auth-scram.c.html#LN85"><span class='Ref_To_Local'>state</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    memset<span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN85"><span class='Ref_To_Local'>state</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN39"><span class='Ref_to_Typedef'>fe_scram_state</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="fe-auth-scram.c.html#LN85"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN41"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>= </span><a href="fe-auth-scram.c.html#LN33"><span class='Ref_to_EnumConst'>FE_SCRAM_INIT</span></a><span class='Delimiter'>; 
</span>    <a href="fe-auth-scram.c.html#LN85"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN44"><span class='Ref_to_Member'>username</span></a> <span class='Operator'>= </span><a href="fe-auth-scram.c.html#LN83"><span class='Ref_to_Parameter'>username</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Normalize the password with SASLprep, if possible */ 
</span>    <a href="fe-auth-scram.c.html#LN87"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span><a href="../../include/common/saslprep.h.html#LN27"><span class='Ref_to_Proto'>pg_saslprep</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN83"><span class='Ref_to_Parameter'>password</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fe-auth-scram.c.html#LN86"><span class='Ref_To_Local'>prep_password</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN87"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>== </span><a href="../../include/common/saslprep.h.html#LN22"><span class='Ref_to_EnumConst'>SASLPREP_OOM</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN85"><span class='Ref_To_Local'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN87"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>!= </span><a href="../../include/common/saslprep.h.html#LN21"><span class='Ref_to_EnumConst'>SASLPREP_SUCCESS</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="fe-auth-scram.c.html#LN86"><span class='Ref_To_Local'>prep_password</span></a> <span class='Operator'>= </span>strdup<span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN83"><span class='Ref_to_Parameter'>password</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fe-auth-scram.c.html#LN86"><span class='Ref_To_Local'>prep_password</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN85"><span class='Ref_To_Local'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <a href="fe-auth-scram.c.html#LN85"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN45"><span class='Ref_to_Member'>password</span></a> <span class='Operator'>= </span><a href="fe-auth-scram.c.html#LN86"><span class='Ref_To_Local'>prep_password</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="fe-auth-scram.c.html#LN85"><span class='Ref_To_Local'>state</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pg_fe_scram_init &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Free SCRAM exchange status 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN121"></a><span class='Declare_Function'>pg_fe_scram_free</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>opaq</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN123"></a>    <a href="fe-auth-scram.c.html#LN39"><span class='Ref_to_Typedef'>fe_scram_state</span></a> <span class='Operator'>*</span><span class='Declare_Local'>state</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN39"><span class='Ref_to_Typedef'>fe_scram_state</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="fe-auth-scram.c.html#LN121"><span class='Ref_to_Parameter'>opaq</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN123"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN45"><span class='Ref_to_Member'>password</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN123"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN45"><span class='Ref_to_Member'>password</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* client messages */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN123"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN49"><span class='Ref_to_Member'>client_nonce</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN123"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN49"><span class='Ref_to_Member'>client_nonce</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN123"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN50"><span class='Ref_to_Member'>client_first_message_bare</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN123"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN50"><span class='Ref_to_Member'>client_first_message_bare</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN123"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN51"><span class='Ref_to_Member'>client_final_message_without_proof</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN123"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN51"><span class='Ref_to_Member'>client_final_message_without_proof</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* first message from server */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN123"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN54"><span class='Ref_to_Member'>server_first_message</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN123"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN54"><span class='Ref_to_Member'>server_first_message</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN123"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN55"><span class='Ref_to_Member'>salt</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN123"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN55"><span class='Ref_to_Member'>salt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN123"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN58"><span class='Ref_to_Member'>nonce</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN123"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN58"><span class='Ref_to_Member'>nonce</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* final message from server */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN123"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN61"><span class='Ref_to_Member'>server_final_message</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN123"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN61"><span class='Ref_to_Member'>server_final_message</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN123"><span class='Ref_To_Local'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pg_fe_scram_free &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Exchange a SCRAM message with backend. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN155"></a><span class='Declare_Function'>pg_fe_scram_exchange</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>opaq</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>input</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>inputlen</span><span class='Delimiter'>, 
</span><a name="LN156"></a>                     <span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>output</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>outputlen</span><span class='Delimiter'>, 
</span><a name="LN157"></a>                     <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>done</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>success</span><span class='Delimiter'>, </span><a href="pqexpbuffer.h.html#LN50"><span class='Ref_to_Typedef'>PQExpBuffer</span></a> <span class='Declare_Parameter'>errorMessage</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN159"></a>    <a href="fe-auth-scram.c.html#LN39"><span class='Ref_to_Typedef'>fe_scram_state</span></a> <span class='Operator'>*</span><span class='Declare_Local'>state</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN39"><span class='Ref_to_Typedef'>fe_scram_state</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="fe-auth-scram.c.html#LN155"><span class='Ref_to_Parameter'>opaq</span></a><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="fe-auth-scram.c.html#LN157"><span class='Ref_to_Parameter'>done</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="fe-auth-scram.c.html#LN157"><span class='Ref_to_Parameter'>success</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="fe-auth-scram.c.html#LN156"><span class='Ref_to_Parameter'>output</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="fe-auth-scram.c.html#LN156"><span class='Ref_to_Parameter'>outputlen</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check that the input length agrees with the string length of the input. 
     * We can ignore inputlen after this. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN159"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN41"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>!= </span><a href="fe-auth-scram.c.html#LN33"><span class='Ref_to_EnumConst'>FE_SCRAM_INIT</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN155"><span class='Ref_to_Parameter'>inputlen</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN157"><span class='Ref_to_Parameter'>errorMessage</span></a><span class='Delimiter'>, 
</span>                 <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"malformed SCRAM message (empty message)\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="fe-auth-scram.c.html#LN244"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN155"><span class='Ref_to_Parameter'>inputlen</span></a> <span class='Operator'>!= </span>strlen<span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN155"><span class='Ref_to_Parameter'>input</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN157"><span class='Ref_to_Parameter'>errorMessage</span></a><span class='Delimiter'>, 
</span>               <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"malformed SCRAM message (length mismatch)\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="fe-auth-scram.c.html#LN244"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN159"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN41"><span class='Ref_to_Member'>state</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="fe-auth-scram.c.html#LN33"><span class='Ref_to_EnumConst'>FE_SCRAM_INIT</span></a><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* Begin the SCRAM handshake, by sending client nonce */ 
</span>            <span class='Operator'>*</span><a href="fe-auth-scram.c.html#LN156"><span class='Ref_to_Parameter'>output</span></a> <span class='Operator'>= </span><a href="fe-auth-scram.c.html#LN69"><span class='Ref_to_Proto'>build_client_first_message</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN159"><span class='Ref_To_Local'>state</span></a><span class='Delimiter'>, </span><a href="fe-auth-scram.c.html#LN157"><span class='Ref_to_Parameter'>errorMessage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="fe-auth-scram.c.html#LN156"><span class='Ref_to_Parameter'>output</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="fe-auth-scram.c.html#LN244"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span> 
            <span class='Operator'>*</span><a href="fe-auth-scram.c.html#LN156"><span class='Ref_to_Parameter'>outputlen</span></a> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><span class='Operator'>*</span><a href="fe-auth-scram.c.html#LN156"><span class='Ref_to_Parameter'>output</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Operator'>*</span><a href="fe-auth-scram.c.html#LN157"><span class='Ref_to_Parameter'>done</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <a href="fe-auth-scram.c.html#LN159"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN41"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>= </span><a href="fe-auth-scram.c.html#LN34"><span class='Ref_to_EnumConst'>FE_SCRAM_NONCE_SENT</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="fe-auth-scram.c.html#LN34"><span class='Ref_to_EnumConst'>FE_SCRAM_NONCE_SENT</span></a><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* Receive salt and server nonce, send response. */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fe-auth-scram.c.html#LN65"><span class='Ref_to_Proto'>read_server_first_message</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN159"><span class='Ref_To_Local'>state</span></a><span class='Delimiter'>, </span><a href="fe-auth-scram.c.html#LN155"><span class='Ref_to_Parameter'>input</span></a><span class='Delimiter'>, </span><a href="fe-auth-scram.c.html#LN157"><span class='Ref_to_Parameter'>errorMessage</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="fe-auth-scram.c.html#LN244"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span> 
            <span class='Operator'>*</span><a href="fe-auth-scram.c.html#LN156"><span class='Ref_to_Parameter'>output</span></a> <span class='Operator'>= </span><a href="fe-auth-scram.c.html#LN71"><span class='Ref_to_Proto'>build_client_final_message</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN159"><span class='Ref_To_Local'>state</span></a><span class='Delimiter'>, </span><a href="fe-auth-scram.c.html#LN157"><span class='Ref_to_Parameter'>errorMessage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="fe-auth-scram.c.html#LN156"><span class='Ref_to_Parameter'>output</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="fe-auth-scram.c.html#LN244"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span> 
            <span class='Operator'>*</span><a href="fe-auth-scram.c.html#LN156"><span class='Ref_to_Parameter'>outputlen</span></a> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><span class='Operator'>*</span><a href="fe-auth-scram.c.html#LN156"><span class='Ref_to_Parameter'>output</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Operator'>*</span><a href="fe-auth-scram.c.html#LN157"><span class='Ref_to_Parameter'>done</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <a href="fe-auth-scram.c.html#LN159"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN41"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>= </span><a href="fe-auth-scram.c.html#LN35"><span class='Ref_to_EnumConst'>FE_SCRAM_PROOF_SENT</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="fe-auth-scram.c.html#LN35"><span class='Ref_to_EnumConst'>FE_SCRAM_PROOF_SENT</span></a><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* Receive server signature */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fe-auth-scram.c.html#LN67"><span class='Ref_to_Proto'>read_server_final_message</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN159"><span class='Ref_To_Local'>state</span></a><span class='Delimiter'>, </span><a href="fe-auth-scram.c.html#LN155"><span class='Ref_to_Parameter'>input</span></a><span class='Delimiter'>, </span><a href="fe-auth-scram.c.html#LN157"><span class='Ref_to_Parameter'>errorMessage</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="fe-auth-scram.c.html#LN244"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Verify server signature, to make sure we're talking to the 
             * genuine server.  XXX: A fake server could simply not require 
             * authentication, though.  There is currently no option in libpq 
             * to reject a connection, if SCRAM authentication did not happen. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN73"><span class='Ref_to_Proto'>verify_server_signature</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN159"><span class='Ref_To_Local'>state</span></a><span class='Parentheses'>))</span> 
                <span class='Operator'>*</span><a href="fe-auth-scram.c.html#LN157"><span class='Ref_to_Parameter'>success</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Operator'>*</span><a href="fe-auth-scram.c.html#LN157"><span class='Ref_to_Parameter'>success</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN157"><span class='Ref_to_Parameter'>errorMessage</span></a><span class='Delimiter'>, 
</span>                                <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"invalid server signature\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Operator'>*</span><a href="fe-auth-scram.c.html#LN157"><span class='Ref_to_Parameter'>done</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="fe-auth-scram.c.html#LN159"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN41"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>= </span><a href="fe-auth-scram.c.html#LN36"><span class='Ref_to_EnumConst'>FE_SCRAM_FINISHED</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>default</span><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* shouldn't happen */ 
</span>            <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN157"><span class='Ref_to_Parameter'>errorMessage</span></a><span class='Delimiter'>, 
</span>                            <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"invalid SCRAM exchange state\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="fe-auth-scram.c.html#LN244"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch state-&GT;state &raquo; </span> 
    <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
<a name="LN244"></a><span class='Label'>error</span><span class='Operator'>: 
</span>    <span class='Operator'>*</span><a href="fe-auth-scram.c.html#LN157"><span class='Ref_to_Parameter'>done</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="fe-auth-scram.c.html#LN157"><span class='Ref_to_Parameter'>success</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pg_fe_scram_exchange &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Read value for an attribute part of a SASL message. 
 */ 
</span><span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN254"></a><span class='Declare_Function'>read_attr_value</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>input</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Declare_Parameter'>attr</span><span class='Delimiter'>, </span><a href="pqexpbuffer.h.html#LN50"><span class='Ref_to_Typedef'>PQExpBuffer</span></a> <span class='Declare_Parameter'>errorMessage</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN256"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>begin</span> <span class='Operator'>= *</span><a href="fe-auth-scram.c.html#LN254"><span class='Ref_to_Parameter'>input</span></a><span class='Delimiter'>; 
</span><a name="LN257"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>end</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="fe-auth-scram.c.html#LN256"><span class='Ref_To_Local'>begin</span></a> <span class='Operator'>!= </span><a href="fe-auth-scram.c.html#LN254"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN254"><span class='Ref_to_Parameter'>errorMessage</span></a><span class='Delimiter'>, 
</span>                    <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"malformed SCRAM message (%c expected)\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                          <a href="fe-auth-scram.c.html#LN254"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="fe-auth-scram.c.html#LN256"><span class='Ref_To_Local'>begin</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="fe-auth-scram.c.html#LN256"><span class='Ref_To_Local'>begin</span></a> <span class='Operator'>!= </span><span class='String'>'='</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN254"><span class='Ref_to_Parameter'>errorMessage</span></a><span class='Delimiter'>, 
</span>        <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"malformed SCRAM message (expected = in attr '%c')\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                          <a href="fe-auth-scram.c.html#LN254"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="fe-auth-scram.c.html#LN256"><span class='Ref_To_Local'>begin</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
    <a href="fe-auth-scram.c.html#LN257"><span class='Ref_To_Local'>end</span></a> <span class='Operator'>= </span><a href="fe-auth-scram.c.html#LN256"><span class='Ref_To_Local'>begin</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="fe-auth-scram.c.html#LN257"><span class='Ref_To_Local'>end</span></a> <span class='Operator'>&& *</span><a href="fe-auth-scram.c.html#LN257"><span class='Ref_To_Local'>end</span></a> <span class='Operator'>!= </span><span class='String'>','</span><span class='Parentheses'>) 
</span>        <a href="fe-auth-scram.c.html#LN257"><span class='Ref_To_Local'>end</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="fe-auth-scram.c.html#LN257"><span class='Ref_To_Local'>end</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Operator'>*</span><a href="fe-auth-scram.c.html#LN257"><span class='Ref_To_Local'>end</span></a> <span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="fe-auth-scram.c.html#LN254"><span class='Ref_to_Parameter'>input</span></a> <span class='Operator'>= </span><a href="fe-auth-scram.c.html#LN257"><span class='Ref_To_Local'>end</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <span class='Operator'>*</span><a href="fe-auth-scram.c.html#LN254"><span class='Ref_to_Parameter'>input</span></a> <span class='Operator'>= </span><a href="fe-auth-scram.c.html#LN257"><span class='Ref_To_Local'>end</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="fe-auth-scram.c.html#LN256"><span class='Ref_To_Local'>begin</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end read_attr_value &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Build the first exchange message sent by the client. 
 */ 
</span><span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN296"></a><span class='Declare_Function'>build_client_first_message</span><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN39"><span class='Ref_to_Typedef'>fe_scram_state</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="pqexpbuffer.h.html#LN50"><span class='Ref_to_Typedef'>PQExpBuffer</span></a> <span class='Declare_Parameter'>errormessage</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN298"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>raw_nonce</span><span class='Delimiter'>[</span><a href="../../include/common/scram-common.h.html#LN28"><span class='Ref_to_Const'>SCRAM_RAW_NONCE_LEN</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN299"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN300"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>buflen</span><span class='Delimiter'>; 
</span><a name="LN301"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>encoded_len</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Generate a "raw" nonce.  This is converted to ASCII-printable form by 
     * base64-encoding it. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fe-auth-scram.c.html#LN77"><span class='Ref_to_Proto'>pg_frontend_random</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN298"><span class='Ref_To_Local'>raw_nonce</span></a><span class='Delimiter'>, </span><a href="../../include/common/scram-common.h.html#LN28"><span class='Ref_to_Const'>SCRAM_RAW_NONCE_LEN</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN296"><span class='Ref_to_Parameter'>errormessage</span></a><span class='Delimiter'>, 
</span>                          <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"failed to generate nonce\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="fe-auth-scram.c.html#LN296"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN49"><span class='Ref_to_Member'>client_nonce</span></a> <span class='Operator'>= </span><a href="../../include/snowball/header.h.html#LN49"><span class='Ref_to_Macro'>malloc</span></a><span class='Parentheses'>(</span><a href="../../include/common/base64.h.html#LN15"><span class='Ref_to_Proto'>pg_b64_enc_len</span></a><span class='Parentheses'>(</span><a href="../../include/common/scram-common.h.html#LN28"><span class='Ref_to_Const'>SCRAM_RAW_NONCE_LEN</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN296"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN49"><span class='Ref_to_Member'>client_nonce</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN296"><span class='Ref_to_Parameter'>errormessage</span></a><span class='Delimiter'>, 
</span>                          <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="fe-auth-scram.c.html#LN301"><span class='Ref_To_Local'>encoded_len</span></a> <span class='Operator'>= </span><a href="../../include/common/base64.h.html#LN13"><span class='Ref_to_Proto'>pg_b64_encode</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN298"><span class='Ref_To_Local'>raw_nonce</span></a><span class='Delimiter'>, </span><a href="../../include/common/scram-common.h.html#LN28"><span class='Ref_to_Const'>SCRAM_RAW_NONCE_LEN</span></a><span class='Delimiter'>, </span><a href="fe-auth-scram.c.html#LN296"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN49"><span class='Ref_to_Member'>client_nonce</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="fe-auth-scram.c.html#LN296"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN49"><span class='Ref_to_Member'>client_nonce</span></a><span class='Delimiter'>[</span><a href="fe-auth-scram.c.html#LN301"><span class='Ref_To_Local'>encoded_len</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Generate message.  The username is left empty as the backend uses the 
     * value provided by the startup packet.  Also, as this username is not 
     * prepared with SASLprep, the message parsing would fail if it includes 
     * '=' or ',' characters. 
     */ 
</span>    <a href="fe-auth-scram.c.html#LN300"><span class='Ref_To_Local'>buflen</span></a> <span class='Operator'>= </span><span class='Number'>8</span> <span class='Operator'>+ </span>strlen<span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN296"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN49"><span class='Ref_to_Member'>client_nonce</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="fe-auth-scram.c.html#LN299"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="../../include/snowball/header.h.html#LN49"><span class='Ref_to_Macro'>malloc</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN300"><span class='Ref_To_Local'>buflen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN299"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN296"><span class='Ref_to_Parameter'>errormessage</span></a><span class='Delimiter'>, 
</span>                          <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN299"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="fe-auth-scram.c.html#LN300"><span class='Ref_To_Local'>buflen</span></a><span class='Delimiter'>, </span><span class='String'>"n,,n=,r=%s"</span><span class='Delimiter'>, </span><a href="fe-auth-scram.c.html#LN296"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN49"><span class='Ref_to_Member'>client_nonce</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="fe-auth-scram.c.html#LN296"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN50"><span class='Ref_to_Member'>client_first_message_bare</span></a> <span class='Operator'>= </span>strdup<span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN299"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>+ </span><span class='Number'>3</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fe-auth-scram.c.html#LN296"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN50"><span class='Ref_to_Member'>client_first_message_bare</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN299"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN296"><span class='Ref_to_Parameter'>errormessage</span></a><span class='Delimiter'>, 
</span>                          <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="fe-auth-scram.c.html#LN299"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end build_client_first_message &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Build the final exchange message sent from the client. 
 */ 
</span><span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN356"></a><span class='Declare_Function'>build_client_final_message</span><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN39"><span class='Ref_to_Typedef'>fe_scram_state</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="pqexpbuffer.h.html#LN50"><span class='Ref_to_Typedef'>PQExpBuffer</span></a> <span class='Declare_Parameter'>errormessage</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN358"></a>    <a href="pqexpbuffer.h.html#LN43"><span class='Ref_to_Struct'>PQExpBufferData</span></a> <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN359"></a>    <a href="../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>client_proof</span><span class='Delimiter'>[</span><a href="../../include/common/scram-common.h.html#LN18"><span class='Ref_to_Const'>SCRAM_KEY_LEN</span></a><span class='Delimiter'>]; 
</span><a name="LN360"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    <a href="pqexpbuffer.c.html#LN87"><span class='Ref_to_Func'>initPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth-scram.c.html#LN358"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Construct client-final-message-without-proof.  We need to remember it 
     * for verifying the server proof in the final step of authentication. 
     */ 
</span>    <a href="pqexpbuffer.c.html#LN260"><span class='Ref_to_Func'>appendPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth-scram.c.html#LN358"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"c=biws,r=%s"</span><span class='Delimiter'>, </span><a href="fe-auth-scram.c.html#LN356"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN58"><span class='Ref_to_Member'>nonce</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqexpbuffer.h.html#LN66"><span class='Ref_to_Macro'>PQExpBufferDataBroken</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN358"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="fe-auth-scram.c.html#LN396"><span class='Ref_to_Label'>oom_error</span></a><span class='Delimiter'>; 
</span> 
    <a href="fe-auth-scram.c.html#LN356"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN51"><span class='Ref_to_Member'>client_final_message_without_proof</span></a> <span class='Operator'>= </span>strdup<span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN358"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="pqexpbuffer.h.html#LN45"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN356"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN51"><span class='Ref_to_Member'>client_final_message_without_proof</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="fe-auth-scram.c.html#LN396"><span class='Ref_to_Label'>oom_error</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Append proof to it, to form client-final-message. */ 
</span>    <a href="fe-auth-scram.c.html#LN74"><span class='Ref_to_Proto'>calculate_client_proof</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN356"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, 
</span>                           <a href="fe-auth-scram.c.html#LN356"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN51"><span class='Ref_to_Member'>client_final_message_without_proof</span></a><span class='Delimiter'>, 
</span>                           <a href="fe-auth-scram.c.html#LN359"><span class='Ref_To_Local'>client_proof</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pqexpbuffer.c.html#LN260"><span class='Ref_to_Func'>appendPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth-scram.c.html#LN358"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>",p="</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pqexpbuffer.h.html#LN139"><span class='Ref_to_Proto'>enlargePQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth-scram.c.html#LN358"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../include/common/base64.h.html#LN15"><span class='Ref_to_Proto'>pg_b64_enc_len</span></a><span class='Parentheses'>(</span><a href="../../include/common/scram-common.h.html#LN18"><span class='Ref_to_Const'>SCRAM_KEY_LEN</span></a><span class='Parentheses'>)))</span> 
        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="fe-auth-scram.c.html#LN396"><span class='Ref_to_Label'>oom_error</span></a><span class='Delimiter'>; 
</span>    <a href="fe-auth-scram.c.html#LN358"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="pqexpbuffer.h.html#LN46"><span class='Ref_to_Member'>len</span></a> <span class='Operator'>+= </span><a href="../../include/common/base64.h.html#LN13"><span class='Ref_to_Proto'>pg_b64_encode</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="fe-auth-scram.c.html#LN359"><span class='Ref_To_Local'>client_proof</span></a><span class='Delimiter'>, 
</span>                             <a href="../../include/common/scram-common.h.html#LN18"><span class='Ref_to_Const'>SCRAM_KEY_LEN</span></a><span class='Delimiter'>, 
</span>                             <a href="fe-auth-scram.c.html#LN358"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="pqexpbuffer.h.html#LN45"><span class='Ref_to_Member'>data</span></a> <span class='Operator'>+ </span><a href="fe-auth-scram.c.html#LN358"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="pqexpbuffer.h.html#LN46"><span class='Ref_to_Member'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="fe-auth-scram.c.html#LN358"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="pqexpbuffer.h.html#LN45"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>[</span><a href="fe-auth-scram.c.html#LN358"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="pqexpbuffer.h.html#LN46"><span class='Ref_to_Member'>len</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span> 
    <a href="fe-auth-scram.c.html#LN360"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span>strdup<span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN358"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="pqexpbuffer.h.html#LN45"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN360"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="fe-auth-scram.c.html#LN396"><span class='Ref_to_Label'>oom_error</span></a><span class='Delimiter'>; 
</span> 
    <a href="pqexpbuffer.h.html#LN121"><span class='Ref_to_Proto'>termPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth-scram.c.html#LN358"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="fe-auth-scram.c.html#LN360"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
</span> 
<a name="LN396"></a><span class='Label'>oom_error</span><span class='Operator'>: 
</span>    <a href="pqexpbuffer.h.html#LN121"><span class='Ref_to_Proto'>termPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth-scram.c.html#LN358"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN356"><span class='Ref_to_Parameter'>errormessage</span></a><span class='Delimiter'>, 
</span>                      <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end build_client_final_message &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Read the first exchange message coming from the server. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN407"></a><span class='Declare_Function'>read_server_first_message</span><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN39"><span class='Ref_to_Typedef'>fe_scram_state</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>input</span><span class='Delimiter'>, 
</span><a name="LN408"></a>                          <a href="pqexpbuffer.h.html#LN50"><span class='Ref_to_Typedef'>PQExpBuffer</span></a> <span class='Declare_Parameter'>errormessage</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN410"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>iterations_str</span><span class='Delimiter'>; 
</span><a name="LN411"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>endptr</span><span class='Delimiter'>; 
</span><a name="LN412"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>encoded_salt</span><span class='Delimiter'>; 
</span><a name="LN413"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>nonce</span><span class='Delimiter'>; 
</span> 
    <a href="fe-auth-scram.c.html#LN407"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN54"><span class='Ref_to_Member'>server_first_message</span></a> <span class='Operator'>= </span>strdup<span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN407"><span class='Ref_to_Parameter'>input</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN407"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN54"><span class='Ref_to_Member'>server_first_message</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN408"><span class='Ref_to_Parameter'>errormessage</span></a><span class='Delimiter'>, 
</span>                          <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* parse the message */ 
</span>    <a href="fe-auth-scram.c.html#LN413"><span class='Ref_To_Local'>nonce</span></a> <span class='Operator'>= </span><a href="fe-auth-scram.c.html#LN253"><span class='Ref_to_Func'>read_attr_value</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth-scram.c.html#LN407"><span class='Ref_to_Parameter'>input</span></a><span class='Delimiter'>, </span><span class='String'>'r'</span><span class='Delimiter'>, </span><a href="fe-auth-scram.c.html#LN408"><span class='Ref_to_Parameter'>errormessage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN413"><span class='Ref_To_Local'>nonce</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* read_attr_value() has generated an error string */ 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Verify immediately that the server used our part of the nonce */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN413"><span class='Ref_To_Local'>nonce</span></a><span class='Parentheses'>)</span> <span class='Operator'>&LT; </span>strlen<span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN407"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN49"><span class='Ref_to_Member'>client_nonce</span></a><span class='Parentheses'>)</span> <span class='Operator'>|| 
</span>        memcmp<span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN413"><span class='Ref_To_Local'>nonce</span></a><span class='Delimiter'>, </span><a href="fe-auth-scram.c.html#LN407"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN49"><span class='Ref_to_Member'>client_nonce</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN407"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN49"><span class='Ref_to_Member'>client_nonce</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN408"><span class='Ref_to_Parameter'>errormessage</span></a><span class='Delimiter'>, 
</span>                 <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"invalid SCRAM response (nonce mismatch)\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="fe-auth-scram.c.html#LN407"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN58"><span class='Ref_to_Member'>nonce</span></a> <span class='Operator'>= </span>strdup<span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN413"><span class='Ref_To_Local'>nonce</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN407"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN58"><span class='Ref_to_Member'>nonce</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN408"><span class='Ref_to_Parameter'>errormessage</span></a><span class='Delimiter'>, 
</span>                          <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="fe-auth-scram.c.html#LN412"><span class='Ref_To_Local'>encoded_salt</span></a> <span class='Operator'>= </span><a href="fe-auth-scram.c.html#LN253"><span class='Ref_to_Func'>read_attr_value</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth-scram.c.html#LN407"><span class='Ref_to_Parameter'>input</span></a><span class='Delimiter'>, </span><span class='String'>'s'</span><span class='Delimiter'>, </span><a href="fe-auth-scram.c.html#LN408"><span class='Ref_to_Parameter'>errormessage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN412"><span class='Ref_To_Local'>encoded_salt</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* read_attr_value() has generated an error string */ 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="fe-auth-scram.c.html#LN407"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN55"><span class='Ref_to_Member'>salt</span></a> <span class='Operator'>= </span><a href="../../include/snowball/header.h.html#LN49"><span class='Ref_to_Macro'>malloc</span></a><span class='Parentheses'>(</span><a href="../../include/common/base64.h.html#LN16"><span class='Ref_to_Proto'>pg_b64_dec_len</span></a><span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN412"><span class='Ref_To_Local'>encoded_salt</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN407"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN55"><span class='Ref_to_Member'>salt</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN408"><span class='Ref_to_Parameter'>errormessage</span></a><span class='Delimiter'>, 
</span>                          <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="fe-auth-scram.c.html#LN407"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN56"><span class='Ref_to_Member'>saltlen</span></a> <span class='Operator'>= </span><a href="../../include/common/base64.h.html#LN14"><span class='Ref_to_Proto'>pg_b64_decode</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN412"><span class='Ref_To_Local'>encoded_salt</span></a><span class='Delimiter'>, 
</span>                                   strlen<span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN412"><span class='Ref_To_Local'>encoded_salt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                   <a href="fe-auth-scram.c.html#LN407"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN55"><span class='Ref_to_Member'>salt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="fe-auth-scram.c.html#LN410"><span class='Ref_To_Local'>iterations_str</span></a> <span class='Operator'>= </span><a href="fe-auth-scram.c.html#LN253"><span class='Ref_to_Func'>read_attr_value</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth-scram.c.html#LN407"><span class='Ref_to_Parameter'>input</span></a><span class='Delimiter'>, </span><span class='String'>'i'</span><span class='Delimiter'>, </span><a href="fe-auth-scram.c.html#LN408"><span class='Ref_to_Parameter'>errormessage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN410"><span class='Ref_To_Local'>iterations_str</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* read_attr_value() has generated an error string */ 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="fe-auth-scram.c.html#LN407"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN57"><span class='Ref_to_Member'>iterations</span></a> <span class='Operator'>= </span>strtol<span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN410"><span class='Ref_To_Local'>iterations_str</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fe-auth-scram.c.html#LN411"><span class='Ref_To_Local'>endptr</span></a><span class='Delimiter'>, </span><span class='Number'>10</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="fe-auth-scram.c.html#LN411"><span class='Ref_To_Local'>endptr</span></a> <span class='Operator'>!= </span><span class='String'>'\0'</span> <span class='Operator'>|| </span><a href="fe-auth-scram.c.html#LN407"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN57"><span class='Ref_to_Member'>iterations</span></a> <span class='Operator'>&LT; </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN408"><span class='Ref_to_Parameter'>errormessage</span></a><span class='Delimiter'>, 
</span>        <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"malformed SCRAM message (invalid iteration count)\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="fe-auth-scram.c.html#LN407"><span class='Ref_to_Parameter'>input</span></a> <span class='Operator'>!= </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN408"><span class='Ref_to_Parameter'>errormessage</span></a><span class='Delimiter'>, 
</span>                          <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"malformed SCRAM message (garbage at end of server-first-message)\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end read_server_first_message &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Read the final exchange message coming from the server. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN490"></a><span class='Declare_Function'>read_server_final_message</span><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN39"><span class='Ref_to_Typedef'>fe_scram_state</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>input</span><span class='Delimiter'>, 
</span><a name="LN491"></a>                          <a href="pqexpbuffer.h.html#LN50"><span class='Ref_to_Typedef'>PQExpBuffer</span></a> <span class='Declare_Parameter'>errormessage</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN493"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>encoded_server_signature</span><span class='Delimiter'>; 
</span><a name="LN494"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>server_signature_len</span><span class='Delimiter'>; 
</span> 
    <a href="fe-auth-scram.c.html#LN490"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN61"><span class='Ref_to_Member'>server_final_message</span></a> <span class='Operator'>= </span>strdup<span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN490"><span class='Ref_to_Parameter'>input</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fe-auth-scram.c.html#LN490"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN61"><span class='Ref_to_Member'>server_final_message</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN491"><span class='Ref_to_Parameter'>errormessage</span></a><span class='Delimiter'>, 
</span>                          <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Check for error result. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="fe-auth-scram.c.html#LN490"><span class='Ref_to_Parameter'>input</span></a> <span class='Operator'>== </span><span class='String'>'e'</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN507"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>errmsg</span> <span class='Operator'>= </span><a href="fe-auth-scram.c.html#LN253"><span class='Ref_to_Func'>read_attr_value</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth-scram.c.html#LN490"><span class='Ref_to_Parameter'>input</span></a><span class='Delimiter'>, </span><span class='String'>'e'</span><span class='Delimiter'>, </span><a href="fe-auth-scram.c.html#LN491"><span class='Ref_to_Parameter'>errormessage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN491"><span class='Ref_to_Parameter'>errormessage</span></a><span class='Delimiter'>, 
</span>          <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"error received from server in SASL exchange: %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                          <a href="fe-auth-scram.c.html#LN507"><span class='Ref_To_Local'>errmsg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Parse the message. */ 
</span>    <a href="fe-auth-scram.c.html#LN493"><span class='Ref_To_Local'>encoded_server_signature</span></a> <span class='Operator'>= </span><a href="fe-auth-scram.c.html#LN253"><span class='Ref_to_Func'>read_attr_value</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth-scram.c.html#LN490"><span class='Ref_to_Parameter'>input</span></a><span class='Delimiter'>, </span><span class='String'>'v'</span><span class='Delimiter'>, </span><a href="fe-auth-scram.c.html#LN491"><span class='Ref_to_Parameter'>errormessage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN493"><span class='Ref_To_Local'>encoded_server_signature</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* read_attr_value() has generated an error message */ 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="fe-auth-scram.c.html#LN490"><span class='Ref_to_Parameter'>input</span></a> <span class='Operator'>!= </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN491"><span class='Ref_to_Parameter'>errormessage</span></a><span class='Delimiter'>, 
</span>                          <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"malformed SCRAM message (garbage at end of server-final-message)\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="fe-auth-scram.c.html#LN494"><span class='Ref_To_Local'>server_signature_len</span></a> <span class='Operator'>= </span><a href="../../include/common/base64.h.html#LN14"><span class='Ref_to_Proto'>pg_b64_decode</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN493"><span class='Ref_To_Local'>encoded_server_signature</span></a><span class='Delimiter'>, 
</span>                                         strlen<span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN493"><span class='Ref_To_Local'>encoded_server_signature</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                         <a href="fe-auth-scram.c.html#LN490"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN62"><span class='Ref_to_Member'>ServerSignature</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN494"><span class='Ref_To_Local'>server_signature_len</span></a> <span class='Operator'>!= </span><a href="../../include/common/scram-common.h.html#LN18"><span class='Ref_to_Const'>SCRAM_KEY_LEN</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN491"><span class='Ref_to_Parameter'>errormessage</span></a><span class='Delimiter'>, 
</span>                          <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"malformed SCRAM message (invalid server signature)\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end read_server_final_message &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Calculate the client proof, part of the final exchange message sent 
 * by the client. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN545"></a><span class='Declare_Function'>calculate_client_proof</span><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN39"><span class='Ref_to_Typedef'>fe_scram_state</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, 
</span><a name="LN546"></a>                       <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>client_final_message_without_proof</span><span class='Delimiter'>, 
</span><a name="LN547"></a>                       <a href="../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>result</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN549"></a>    <a href="../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>StoredKey</span><span class='Delimiter'>[</span><a href="../../include/common/scram-common.h.html#LN18"><span class='Ref_to_Const'>SCRAM_KEY_LEN</span></a><span class='Delimiter'>]; 
</span><a name="LN550"></a>    <a href="../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>ClientKey</span><span class='Delimiter'>[</span><a href="../../include/common/scram-common.h.html#LN18"><span class='Ref_to_Const'>SCRAM_KEY_LEN</span></a><span class='Delimiter'>]; 
</span><a name="LN551"></a>    <a href="../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>ClientSignature</span><span class='Delimiter'>[</span><a href="../../include/common/scram-common.h.html#LN18"><span class='Ref_to_Const'>SCRAM_KEY_LEN</span></a><span class='Delimiter'>]; 
</span><a name="LN552"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN553"></a>    <a href="../../include/common/scram-common.h.html#LN39"><span class='Ref_to_Typedef'>scram_HMAC_ctx</span></a> <span class='Declare_Local'>ctx</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Calculate SaltedPassword, and store it in 'state' so that we can reuse 
     * it later in verify_server_signature. 
     */ 
</span>    <a href="../../include/common/scram-common.h.html#LN49"><span class='Ref_to_Proto'>scram_SaltedPassword</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN545"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN45"><span class='Ref_to_Member'>password</span></a><span class='Delimiter'>, </span><a href="fe-auth-scram.c.html#LN545"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN55"><span class='Ref_to_Member'>salt</span></a><span class='Delimiter'>, </span><a href="fe-auth-scram.c.html#LN545"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN56"><span class='Ref_to_Member'>saltlen</span></a><span class='Delimiter'>, 
</span>                         <a href="fe-auth-scram.c.html#LN545"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN57"><span class='Ref_to_Member'>iterations</span></a><span class='Delimiter'>, </span><a href="fe-auth-scram.c.html#LN545"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN48"><span class='Ref_to_Member'>SaltedPassword</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/common/scram-common.h.html#LN52"><span class='Ref_to_Proto'>scram_ClientKey</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN545"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN48"><span class='Ref_to_Member'>SaltedPassword</span></a><span class='Delimiter'>, </span><a href="fe-auth-scram.c.html#LN550"><span class='Ref_To_Local'>ClientKey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/scram-common.h.html#LN51"><span class='Ref_to_Proto'>scram_H</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN550"><span class='Ref_To_Local'>ClientKey</span></a><span class='Delimiter'>, </span><a href="../../include/common/scram-common.h.html#LN18"><span class='Ref_to_Const'>SCRAM_KEY_LEN</span></a><span class='Delimiter'>, </span><a href="fe-auth-scram.c.html#LN549"><span class='Ref_To_Local'>StoredKey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../common/scram-common.c.html#LN36"><span class='Ref_to_Func'>scram_HMAC_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth-scram.c.html#LN553"><span class='Ref_To_Local'>ctx</span></a><span class='Delimiter'>, </span><a href="fe-auth-scram.c.html#LN549"><span class='Ref_To_Local'>StoredKey</span></a><span class='Delimiter'>, </span><a href="../../include/common/scram-common.h.html#LN18"><span class='Ref_to_Const'>SCRAM_KEY_LEN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/scram-common.h.html#LN46"><span class='Ref_to_Proto'>scram_HMAC_update</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth-scram.c.html#LN553"><span class='Ref_To_Local'>ctx</span></a><span class='Delimiter'>, 
</span>                      <a href="fe-auth-scram.c.html#LN545"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN50"><span class='Ref_to_Member'>client_first_message_bare</span></a><span class='Delimiter'>, 
</span>                      strlen<span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN545"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN50"><span class='Ref_to_Member'>client_first_message_bare</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/scram-common.h.html#LN46"><span class='Ref_to_Proto'>scram_HMAC_update</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth-scram.c.html#LN553"><span class='Ref_To_Local'>ctx</span></a><span class='Delimiter'>, </span><span class='String'>","</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/scram-common.h.html#LN46"><span class='Ref_to_Proto'>scram_HMAC_update</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth-scram.c.html#LN553"><span class='Ref_To_Local'>ctx</span></a><span class='Delimiter'>, 
</span>                      <a href="fe-auth-scram.c.html#LN545"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN54"><span class='Ref_to_Member'>server_first_message</span></a><span class='Delimiter'>, 
</span>                      strlen<span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN545"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN54"><span class='Ref_to_Member'>server_first_message</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/scram-common.h.html#LN46"><span class='Ref_to_Proto'>scram_HMAC_update</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth-scram.c.html#LN553"><span class='Ref_To_Local'>ctx</span></a><span class='Delimiter'>, </span><span class='String'>","</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/scram-common.h.html#LN46"><span class='Ref_to_Proto'>scram_HMAC_update</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth-scram.c.html#LN553"><span class='Ref_To_Local'>ctx</span></a><span class='Delimiter'>, 
</span>                      <a href="fe-auth-scram.c.html#LN546"><span class='Ref_to_Parameter'>client_final_message_without_proof</span></a><span class='Delimiter'>, 
</span>                      strlen<span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN546"><span class='Ref_to_Parameter'>client_final_message_without_proof</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/scram-common.h.html#LN47"><span class='Ref_to_Proto'>scram_HMAC_final</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN551"><span class='Ref_To_Local'>ClientSignature</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fe-auth-scram.c.html#LN553"><span class='Ref_To_Local'>ctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN552"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="fe-auth-scram.c.html#LN552"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="../../include/common/scram-common.h.html#LN18"><span class='Ref_to_Const'>SCRAM_KEY_LEN</span></a><span class='Delimiter'>; </span><a href="fe-auth-scram.c.html#LN552"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="fe-auth-scram.c.html#LN547"><span class='Ref_to_Parameter'>result</span></a><span class='Delimiter'>[</span><a href="fe-auth-scram.c.html#LN552"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="fe-auth-scram.c.html#LN550"><span class='Ref_To_Local'>ClientKey</span></a><span class='Delimiter'>[</span><a href="fe-auth-scram.c.html#LN552"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>^ </span><a href="fe-auth-scram.c.html#LN551"><span class='Ref_To_Local'>ClientSignature</span></a><span class='Delimiter'>[</span><a href="fe-auth-scram.c.html#LN552"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
}</span><span class='Auto_Annotations'> &laquo; end calculate_client_proof &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Validate the server signature, received as part of the final exchange 
 * message received from the server. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN588"></a><span class='Declare_Function'>verify_server_signature</span><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN39"><span class='Ref_to_Typedef'>fe_scram_state</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN590"></a>    <a href="../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>expected_ServerSignature</span><span class='Delimiter'>[</span><a href="../../include/common/scram-common.h.html#LN18"><span class='Ref_to_Const'>SCRAM_KEY_LEN</span></a><span class='Delimiter'>]; 
</span><a name="LN591"></a>    <a href="../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>ServerKey</span><span class='Delimiter'>[</span><a href="../../include/common/scram-common.h.html#LN18"><span class='Ref_to_Const'>SCRAM_KEY_LEN</span></a><span class='Delimiter'>]; 
</span><a name="LN592"></a>    <a href="../../include/common/scram-common.h.html#LN39"><span class='Ref_to_Typedef'>scram_HMAC_ctx</span></a> <span class='Declare_Local'>ctx</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/common/scram-common.h.html#LN53"><span class='Ref_to_Proto'>scram_ServerKey</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN588"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN48"><span class='Ref_to_Member'>SaltedPassword</span></a><span class='Delimiter'>, </span><a href="fe-auth-scram.c.html#LN591"><span class='Ref_To_Local'>ServerKey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* calculate ServerSignature */ 
</span>    <a href="../../common/scram-common.c.html#LN36"><span class='Ref_to_Func'>scram_HMAC_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth-scram.c.html#LN592"><span class='Ref_To_Local'>ctx</span></a><span class='Delimiter'>, </span><a href="fe-auth-scram.c.html#LN591"><span class='Ref_To_Local'>ServerKey</span></a><span class='Delimiter'>, </span><a href="../../include/common/scram-common.h.html#LN18"><span class='Ref_to_Const'>SCRAM_KEY_LEN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/scram-common.h.html#LN46"><span class='Ref_to_Proto'>scram_HMAC_update</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth-scram.c.html#LN592"><span class='Ref_To_Local'>ctx</span></a><span class='Delimiter'>, 
</span>                      <a href="fe-auth-scram.c.html#LN588"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN50"><span class='Ref_to_Member'>client_first_message_bare</span></a><span class='Delimiter'>, 
</span>                      strlen<span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN588"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN50"><span class='Ref_to_Member'>client_first_message_bare</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/scram-common.h.html#LN46"><span class='Ref_to_Proto'>scram_HMAC_update</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth-scram.c.html#LN592"><span class='Ref_To_Local'>ctx</span></a><span class='Delimiter'>, </span><span class='String'>","</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/scram-common.h.html#LN46"><span class='Ref_to_Proto'>scram_HMAC_update</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth-scram.c.html#LN592"><span class='Ref_To_Local'>ctx</span></a><span class='Delimiter'>, 
</span>                      <a href="fe-auth-scram.c.html#LN588"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN54"><span class='Ref_to_Member'>server_first_message</span></a><span class='Delimiter'>, 
</span>                      strlen<span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN588"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN54"><span class='Ref_to_Member'>server_first_message</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/scram-common.h.html#LN46"><span class='Ref_to_Proto'>scram_HMAC_update</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth-scram.c.html#LN592"><span class='Ref_To_Local'>ctx</span></a><span class='Delimiter'>, </span><span class='String'>","</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/scram-common.h.html#LN46"><span class='Ref_to_Proto'>scram_HMAC_update</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth-scram.c.html#LN592"><span class='Ref_To_Local'>ctx</span></a><span class='Delimiter'>, 
</span>                      <a href="fe-auth-scram.c.html#LN588"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN51"><span class='Ref_to_Member'>client_final_message_without_proof</span></a><span class='Delimiter'>, 
</span>                      strlen<span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN588"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN51"><span class='Ref_to_Member'>client_final_message_without_proof</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/scram-common.h.html#LN47"><span class='Ref_to_Proto'>scram_HMAC_final</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN590"><span class='Ref_To_Local'>expected_ServerSignature</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fe-auth-scram.c.html#LN592"><span class='Ref_To_Local'>ctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>memcmp<span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN590"><span class='Ref_To_Local'>expected_ServerSignature</span></a><span class='Delimiter'>, </span><a href="fe-auth-scram.c.html#LN588"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="fe-auth-scram.c.html#LN62"><span class='Ref_to_Member'>ServerSignature</span></a><span class='Delimiter'>, </span><a href="../../include/common/scram-common.h.html#LN18"><span class='Ref_to_Const'>SCRAM_KEY_LEN</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end verify_server_signature &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Build a new SCRAM verifier. 
 */ 
</span><span class='Keyword'>char </span><span class='Operator'>* 
</span><a name="LN621"></a><span class='Declare_Function'>pg_fe_scram_build_verifier</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>password</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN623"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>prep_password</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN624"></a>    <a href="../../include/common/saslprep.h.html#LN19"><span class='Ref_to_Typedef'>pg_saslprep_rc</span></a> <span class='Declare_Local'>rc</span><span class='Delimiter'>; 
</span><a name="LN625"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>saltbuf</span><span class='Delimiter'>[</span><a href="../../include/common/scram-common.h.html#LN31"><span class='Ref_to_Const'>SCRAM_DEFAULT_SALT_LEN</span></a><span class='Delimiter'>]; 
</span><a name="LN626"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Normalize the password with SASLprep.  If that doesn't work, because 
     * the password isn't valid UTF-8 or contains prohibited characters, just 
     * proceed with the original password.  (See comments at top of file.) 
     */ 
</span>    <a href="fe-auth-scram.c.html#LN624"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span><a href="../../include/common/saslprep.h.html#LN27"><span class='Ref_to_Proto'>pg_saslprep</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN621"><span class='Ref_to_Parameter'>password</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fe-auth-scram.c.html#LN623"><span class='Ref_To_Local'>prep_password</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN624"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>== </span><a href="../../include/common/saslprep.h.html#LN22"><span class='Ref_to_EnumConst'>SASLPREP_OOM</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN624"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>== </span><a href="../../include/common/saslprep.h.html#LN21"><span class='Ref_to_EnumConst'>SASLPREP_SUCCESS</span></a><span class='Parentheses'>) 
</span>        <a href="fe-auth-scram.c.html#LN621"><span class='Ref_to_Parameter'>password</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="fe-auth-scram.c.html#LN623"><span class='Ref_To_Local'>prep_password</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Generate a random salt */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fe-auth-scram.c.html#LN77"><span class='Ref_to_Proto'>pg_frontend_random</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN625"><span class='Ref_To_Local'>saltbuf</span></a><span class='Delimiter'>, </span><a href="../../include/common/scram-common.h.html#LN31"><span class='Ref_to_Const'>SCRAM_DEFAULT_SALT_LEN</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN623"><span class='Ref_To_Local'>prep_password</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN623"><span class='Ref_To_Local'>prep_password</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="fe-auth-scram.c.html#LN626"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../include/common/scram-common.h.html#LN55"><span class='Ref_to_Proto'>scram_build_verifier</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN625"><span class='Ref_To_Local'>saltbuf</span></a><span class='Delimiter'>, </span><a href="../../include/common/scram-common.h.html#LN31"><span class='Ref_to_Const'>SCRAM_DEFAULT_SALT_LEN</span></a><span class='Delimiter'>, 
</span>                                  <a href="../../include/common/scram-common.h.html#LN34"><span class='Ref_to_Const'>SCRAM_DEFAULT_ITERATIONS</span></a><span class='Delimiter'>, </span><a href="fe-auth-scram.c.html#LN621"><span class='Ref_to_Parameter'>password</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN623"><span class='Ref_To_Local'>prep_password</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN623"><span class='Ref_To_Local'>prep_password</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="fe-auth-scram.c.html#LN626"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pg_fe_scram_build_verifier &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Random number generator. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN660"></a><span class='Declare_Function'>pg_frontend_random</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dst</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> HAVE_STRONG_RANDOM 
    <span class='Control'>return</span> <a href="../../port/pg_strong_random.c.html#LN98"><span class='Ref_to_Func'>pg_strong_random</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN660"><span class='Ref_to_Parameter'>dst</span></a><span class='Delimiter'>, </span><a href="fe-auth-scram.c.html#LN660"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
<a name="LN665"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN666"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>end</span> <span class='Operator'>= </span><a href="fe-auth-scram.c.html#LN660"><span class='Ref_to_Parameter'>dst</span></a> <span class='Operator'>+ </span><a href="fe-auth-scram.c.html#LN660"><span class='Ref_to_Parameter'>len</span></a><span class='Delimiter'>; 
</span> 
<a name="LN668"></a>    <span class='Keyword'>static unsigned short </span><span class='Declare_Local'>seed</span><span class='Delimiter'>[</span><span class='Number'>3</span><span class='Delimiter'>]; 
</span><a name="LN669"></a>    <span class='Keyword'>static int</span>  <span class='Declare_Local'>mypid</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="libpq-int.h.html#LN558"><span class='Ref_to_Macro'>pglock_thread</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN669"><span class='Ref_To_Local'>mypid</span></a> <span class='Operator'>!= </span>getpid<span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span><a name="LN675"></a>        <span class='Control'>struct</span> timeval <span class='Declare_Local'>now</span><span class='Delimiter'>; 
</span> 
        <a href="../../port/gettimeofday.c.html#LN103"><span class='Ref_to_Func'>gettimeofday</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth-scram.c.html#LN675"><span class='Ref_To_Local'>now</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="fe-auth-scram.c.html#LN668"><span class='Ref_To_Local'>seed</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="fe-auth-scram.c.html#LN675"><span class='Ref_To_Local'>now</span></a><span class='Operator'>.</span>tv_sec <span class='Operator'>^ </span>getpid<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="fe-auth-scram.c.html#LN668"><span class='Ref_To_Local'>seed</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>unsigned short</span><span class='Parentheses'>) (</span><a href="fe-auth-scram.c.html#LN675"><span class='Ref_To_Local'>now</span></a><span class='Operator'>.</span>tv_usec<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="fe-auth-scram.c.html#LN668"><span class='Ref_To_Local'>seed</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>unsigned short</span><span class='Parentheses'>) (</span><a href="fe-auth-scram.c.html#LN675"><span class='Ref_To_Local'>now</span></a><span class='Operator'>.</span>tv_usec <span class='Operator'>&GT;&GT; </span><span class='Number'>16</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN665"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="fe-auth-scram.c.html#LN660"><span class='Ref_to_Parameter'>dst</span></a> <span class='Operator'>&LT; </span><a href="fe-auth-scram.c.html#LN666"><span class='Ref_To_Local'>end</span></a><span class='Delimiter'>; </span><a href="fe-auth-scram.c.html#LN665"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN686"></a>        <a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>r</span><span class='Delimiter'>; 
</span><a name="LN687"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>j</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * pg_jrand48 returns a 32-bit integer.  Fill the next 4 bytes from 
         * it. 
         */ 
</span>        <a href="fe-auth-scram.c.html#LN686"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="../../port/erand48.c.html#LN93"><span class='Ref_to_Func'>pg_jrand48</span></a><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN668"><span class='Ref_To_Local'>seed</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN687"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="fe-auth-scram.c.html#LN687"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><span class='Number'>4</span> <span class='Operator'>&& </span><a href="fe-auth-scram.c.html#LN660"><span class='Ref_to_Parameter'>dst</span></a> <span class='Operator'>&LT; </span><a href="fe-auth-scram.c.html#LN666"><span class='Ref_To_Local'>end</span></a><span class='Delimiter'>; </span><a href="fe-auth-scram.c.html#LN687"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Operator'>*</span><span class='Parentheses'>(</span><a href="fe-auth-scram.c.html#LN660"><span class='Ref_to_Parameter'>dst</span></a><span class='Operator'>++</span><span class='Parentheses'>) </span><span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char</span><span class='Parentheses'>) (</span><a href="fe-auth-scram.c.html#LN686"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>& </span><span class='Number'>0xFF</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="fe-auth-scram.c.html#LN686"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>&GT;&GT;= </span><span class='Number'>8</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="libpq-int.h.html#LN559"><span class='Ref_to_Macro'>pgunlock_thread</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end pg_frontend_random &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>