<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\interfaces\libpq\fe-auth.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\interfaces\libpq\fe-auth.c</b></p></td>
<td align='right'>
Wed Jun 14 08:26:10 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * fe-auth.c 
 *     The front-end (client) authorization routines 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * IDENTIFICATION 
 *    src/interfaces/libpq/fe-auth.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * INTERFACE ROUTINES 
 *     frontend (client) routines: 
 *      pg_fe_sendauth          send authentication information 
 *      pg_fe_getauthname       get user's name according to the client side 
 *                              of the authentication system 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres_fe.h"</span> 
 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<span class='Keyword'>#include </span><span class='String'>"win32.h"</span> 
<span class='Directive'>#else</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;fcntl.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/param.h&GT;</span>          <span class='Comment_Single_Line'>/* for MAXHOSTNAMELEN on most */ 
</span><span class='Keyword'>#include </span><span class='String'>&LT;sys/socket.h&GT;</span> 
<span class='Directive'>#ifdef</span> HAVE_SYS_UCRED_H 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/ucred.h&GT;</span> 
<span class='Directive'>#endif</span> 
<span class='Directive'>#ifndef</span>  <a href="../../test/thread/thread_test.c.html#LN55"><span class='Ref_to_Const'>MAXHOSTNAMELEN</span></a> 
<span class='Keyword'>#include </span><span class='String'>&LT;netdb.h&GT;</span>              <span class='Comment_Single_Line'>/* for MAXHOSTNAMELEN on some */ 
</span><span class='Directive'>#endif</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;pwd.h&GT;</span> 
<span class='Directive'>#endif</span> 
 
<span class='Keyword'>#include </span><span class='String'>"common/md5.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"libpq-fe.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"libpq/scram.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"fe-auth.h"</span> 
 
 
<span class='Directive'>#ifdef</span> ENABLE_GSS 
<span class='Comment_Multi_Line'>/* 
 * GSSAPI authentication system. 
 */ 
</span> 
<span class='Directive'>#if</span> defined<span class='Parentheses'>(</span><a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a><span class='Parentheses'>) </span><span class='Operator'>&& !</span>defined<span class='Parentheses'>(</span>_MSC_VER<span class='Parentheses'>) 
</span><span class='Comment_Multi_Line'>/* 
 * MIT Kerberos GSSAPI DLL doesn't properly export the symbols for MingW 
 * that contain the OIDs required. Redefine here, values copied 
 * from src/athena/auth/krb5/src/lib/gssapi/generic/gssapi_generic.c 
 */ 
</span><a name="LN57"></a><span class='Keyword'>static const </span>gss_OID_desc <span class='Declare_Var'>GSS_C_NT_HOSTBASED_SERVICE_desc</span> <span class='Operator'>= 
</span><span class='Delimiter'>{</span><span class='Number'>10</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='String'>"\x2a\x86\x48\x86\xf7\x12\x01\x02\x01\x04"</span><span class='Delimiter'>}; 
</span><a name="LN59"></a><span class='Keyword'>static </span>GSS_DLLIMP gss_OID <span class='Declare_Var'>GSS_C_NT_HOSTBASED_SERVICE</span> <span class='Operator'>= &</span><a href="fe-auth.c.html#LN57"><span class='Ref_to_Global_Var'>GSS_C_NT_HOSTBASED_SERVICE_desc</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Fetch all errors of a specific type and append to "str". 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN66"></a><span class='Declare_Function'>pg_GSS_error_int</span><span class='Parentheses'>(</span><a href="pqexpbuffer.h.html#LN50"><span class='Ref_to_Typedef'>PQExpBuffer</span></a> <span class='Declare_Parameter'>str</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>mprefix</span><span class='Delimiter'>, 
</span><a name="LN67"></a>                 OM_uint32 <span class='Declare_Parameter'>stat</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>type</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN69"></a>    OM_uint32   <span class='Declare_Local'>lmin_s</span><span class='Delimiter'>; 
</span><a name="LN70"></a>    <a href="libpq-int.h.html#LN65"><span class='Ref_to_Typedef'>gss_buffer_desc</span></a> <span class='Declare_Local'>lmsg</span><span class='Delimiter'>; 
</span><a name="LN71"></a>    OM_uint32   <span class='Declare_Local'>msg_ctx</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>do</span> 
    <span class='Delimiter'>{ 
</span>        gss_display_status<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN69"><span class='Ref_To_Local'>lmin_s</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN67"><span class='Ref_to_Parameter'>stat</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN67"><span class='Ref_to_Parameter'>type</span></a><span class='Delimiter'>, 
</span>                           GSS_C_NO_OID<span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fe-auth.c.html#LN71"><span class='Ref_To_Local'>msg_ctx</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fe-auth.c.html#LN70"><span class='Ref_To_Local'>lmsg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pqexpbuffer.c.html#LN260"><span class='Ref_to_Func'>appendPQExpBuffer</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN66"><span class='Ref_to_Parameter'>str</span></a><span class='Delimiter'>, </span><span class='String'>"%s: %s\n"</span><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN66"><span class='Ref_to_Parameter'>mprefix</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="fe-auth.c.html#LN70"><span class='Ref_To_Local'>lmsg</span></a><span class='Operator'>.</span><span class='Keyword'>value</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        gss_release_buffer<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN69"><span class='Ref_To_Local'>lmin_s</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fe-auth.c.html#LN70"><span class='Ref_To_Local'>lmsg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN71"><span class='Ref_To_Local'>msg_ctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * GSSAPI errors contain two parts; put both into conn-&GT;errorMessage. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN86"></a><span class='Declare_Function'>pg_GSS_error</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>mprefix</span><span class='Delimiter'>, </span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, 
</span><a name="LN87"></a>             OM_uint32 <span class='Declare_Parameter'>maj_stat</span><span class='Delimiter'>, </span>OM_uint32 <span class='Declare_Parameter'>min_stat</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="pqexpbuffer.h.html#LN129"><span class='Ref_to_Proto'>resetPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN86"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Fetch major error codes */ 
</span>    <a href="fe-auth.c.html#LN65"><span class='Ref_to_Func'>pg_GSS_error_int</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN86"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN86"><span class='Ref_to_Parameter'>mprefix</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN87"><span class='Ref_to_Parameter'>maj_stat</span></a><span class='Delimiter'>, </span>GSS_C_GSS_CODE<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Add the minor codes as well */ 
</span>    <a href="fe-auth.c.html#LN65"><span class='Ref_to_Func'>pg_GSS_error_int</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN86"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN86"><span class='Ref_to_Parameter'>mprefix</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN87"><span class='Ref_to_Parameter'>min_stat</span></a><span class='Delimiter'>, </span>GSS_C_MECH_CODE<span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Continue GSS authentication with next token as needed. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN102"></a><span class='Declare_Function'>pg_GSS_continue</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>payloadlen</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN104"></a>    OM_uint32   <span class='Declare_Local'>maj_stat</span><span class='Delimiter'>, 
</span><a name="LN105"></a>                <span class='Declare_Local'>min_stat</span><span class='Delimiter'>, 
</span><a name="LN106"></a>                <span class='Declare_Local'>lmin_s</span><span class='Delimiter'>; 
</span><a name="LN107"></a>    <a href="libpq-int.h.html#LN65"><span class='Ref_to_Typedef'>gss_buffer_desc</span></a> <span class='Declare_Local'>ginbuf</span><span class='Delimiter'>; 
</span><a name="LN108"></a>    <a href="libpq-int.h.html#LN65"><span class='Ref_to_Typedef'>gss_buffer_desc</span></a> <span class='Declare_Local'>goutbuf</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * On first call, there's no input token. On subsequent calls, read the 
     * input token into a GSS buffer. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN102"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN474"><span class='Ref_to_Member'>gctx</span></a> <span class='Operator'>!= </span>GSS_C_NO_CONTEXT<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="fe-auth.c.html#LN107"><span class='Ref_To_Local'>ginbuf</span></a><span class='Operator'>.</span><a href="../../include/libpq/libpq-be.h.html#LN60"><span class='Ref_to_Member'>length</span></a> <span class='Operator'>= </span><a href="fe-auth.c.html#LN102"><span class='Ref_to_Parameter'>payloadlen</span></a><span class='Delimiter'>; 
</span>        <a href="fe-auth.c.html#LN107"><span class='Ref_To_Local'>ginbuf</span></a><span class='Operator'>.</span><span class='Keyword'>value </span><span class='Operator'>= </span><a href="../../include/snowball/header.h.html#LN49"><span class='Ref_to_Macro'>malloc</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN102"><span class='Ref_to_Parameter'>payloadlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fe-auth.c.html#LN107"><span class='Ref_To_Local'>ginbuf</span></a><span class='Operator'>.</span><span class='Keyword'>value</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN102"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>              <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory allocating GSSAPI buffer (%d)\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                              <a href="fe-auth.c.html#LN102"><span class='Ref_to_Parameter'>payloadlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-misc.c.html#LN195"><span class='Ref_to_Func'>pqGetnchar</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN107"><span class='Ref_To_Local'>ginbuf</span></a><span class='Operator'>.</span><span class='Keyword'>value</span><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN102"><span class='Ref_to_Parameter'>payloadlen</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN102"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Shouldn't happen, because the caller should've ensured that the 
             * whole message is already in the input buffer. 
             */ 
</span>            <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN107"><span class='Ref_To_Local'>ginbuf</span></a><span class='Operator'>.</span><span class='Keyword'>value</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if conn-&GT;gctx!=GSS_C_NO_... &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="fe-auth.c.html#LN107"><span class='Ref_To_Local'>ginbuf</span></a><span class='Operator'>.</span><a href="../../include/libpq/libpq-be.h.html#LN60"><span class='Ref_to_Member'>length</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="fe-auth.c.html#LN107"><span class='Ref_To_Local'>ginbuf</span></a><span class='Operator'>.</span><span class='Keyword'>value </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="fe-auth.c.html#LN104"><span class='Ref_To_Local'>maj_stat</span></a> <span class='Operator'>= </span>gss_init_sec_context<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN105"><span class='Ref_To_Local'>min_stat</span></a><span class='Delimiter'>, 
</span>                                    GSS_C_NO_CREDENTIAL<span class='Delimiter'>, 
</span>                                    <span class='Operator'>&</span><a href="fe-auth.c.html#LN102"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN474"><span class='Ref_to_Member'>gctx</span></a><span class='Delimiter'>, 
</span>                                    <a href="fe-auth.c.html#LN102"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN475"><span class='Ref_to_Member'>gtarg_nam</span></a><span class='Delimiter'>, 
</span>                                    GSS_C_NO_OID<span class='Delimiter'>, 
</span>                                    GSS_C_MUTUAL_FLAG<span class='Delimiter'>, 
</span>                                    <span class='Number'>0</span><span class='Delimiter'>, 
</span>                                    GSS_C_NO_CHANNEL_BINDINGS<span class='Delimiter'>, 
</span>                          <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN107"><span class='Ref_To_Local'>ginbuf</span></a><span class='Operator'>.</span><span class='Keyword'>value </span><span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) </span><span class='Operator'>? </span>GSS_C_NO_BUFFER <span class='Operator'>: &</span><a href="fe-auth.c.html#LN107"><span class='Ref_To_Local'>ginbuf</span></a><span class='Delimiter'>, 
</span>                                    <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                    <span class='Operator'>&</span><a href="fe-auth.c.html#LN108"><span class='Ref_To_Local'>goutbuf</span></a><span class='Delimiter'>, 
</span>                                    <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                    <span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN107"><span class='Ref_To_Local'>ginbuf</span></a><span class='Operator'>.</span><span class='Keyword'>value</span><span class='Parentheses'>) 
</span>        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN107"><span class='Ref_To_Local'>ginbuf</span></a><span class='Operator'>.</span><span class='Keyword'>value</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN108"><span class='Ref_To_Local'>goutbuf</span></a><span class='Operator'>.</span><a href="../../include/libpq/libpq-be.h.html#LN60"><span class='Ref_to_Member'>length</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * GSS generated data to send to the server. We don't care if it's the 
         * first or subsequent packet, just send the same kind of password 
         * packet. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="libpq-int.h.html#LN544"><span class='Ref_to_Proto'>pqPacketSend</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN102"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><span class='String'>'p'</span><span class='Delimiter'>, 
</span>                         <a href="fe-auth.c.html#LN108"><span class='Ref_To_Local'>goutbuf</span></a><span class='Operator'>.</span><span class='Keyword'>value</span><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN108"><span class='Ref_To_Local'>goutbuf</span></a><span class='Operator'>.</span><a href="../../include/libpq/libpq-be.h.html#LN60"><span class='Ref_to_Member'>length</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            gss_release_buffer<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN106"><span class='Ref_To_Local'>lmin_s</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fe-auth.c.html#LN108"><span class='Ref_To_Local'>goutbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    gss_release_buffer<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN106"><span class='Ref_To_Local'>lmin_s</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fe-auth.c.html#LN108"><span class='Ref_To_Local'>goutbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN104"><span class='Ref_To_Local'>maj_stat</span></a> <span class='Operator'>!= </span>GSS_S_COMPLETE <span class='Operator'>&& </span><a href="fe-auth.c.html#LN104"><span class='Ref_To_Local'>maj_stat</span></a> <span class='Operator'>!= </span>GSS_S_CONTINUE_NEEDED<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="fe-auth.c.html#LN85"><span class='Ref_to_Func'>pg_GSS_error</span></a><span class='Parentheses'>(</span><a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"GSSAPI continuation error"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="fe-auth.c.html#LN102"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, 
</span>                     <a href="fe-auth.c.html#LN104"><span class='Ref_To_Local'>maj_stat</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN105"><span class='Ref_To_Local'>min_stat</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        gss_release_name<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN106"><span class='Ref_To_Local'>lmin_s</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fe-auth.c.html#LN102"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN475"><span class='Ref_to_Member'>gtarg_nam</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN102"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN474"><span class='Ref_to_Member'>gctx</span></a><span class='Parentheses'>) 
</span>            gss_delete_sec_context<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN106"><span class='Ref_To_Local'>lmin_s</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fe-auth.c.html#LN102"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN474"><span class='Ref_to_Member'>gctx</span></a><span class='Delimiter'>, </span>GSS_C_NO_BUFFER<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN104"><span class='Ref_To_Local'>maj_stat</span></a> <span class='Operator'>== </span>GSS_S_COMPLETE<span class='Parentheses'>) 
</span>        gss_release_name<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN106"><span class='Ref_To_Local'>lmin_s</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fe-auth.c.html#LN102"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN475"><span class='Ref_to_Member'>gtarg_nam</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pg_GSS_continue &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Send initial GSS authentication token 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN195"></a><span class='Declare_Function'>pg_GSS_startup</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>payloadlen</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN197"></a>    OM_uint32   <span class='Declare_Local'>maj_stat</span><span class='Delimiter'>, 
</span><a name="LN198"></a>                <span class='Declare_Local'>min_stat</span><span class='Delimiter'>; 
</span><a name="LN199"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>maxlen</span><span class='Delimiter'>; 
</span><a name="LN200"></a>    <a href="libpq-int.h.html#LN65"><span class='Ref_to_Typedef'>gss_buffer_desc</span></a> <span class='Declare_Local'>temp_gbuf</span><span class='Delimiter'>; 
</span><a name="LN201"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>host</span> <span class='Operator'>= </span><a href="libpq-fe.h.html#LN313"><span class='Ref_to_Proto'>PQhost</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN195"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN201"><span class='Ref_To_Local'>host</span></a> <span class='Operator'>&& </span><a href="fe-auth.c.html#LN201"><span class='Ref_To_Local'>host</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='String'>'\0'</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN195"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                          <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"host name must be specified\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN195"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN474"><span class='Ref_to_Member'>gctx</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN195"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                    <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"duplicate GSS authentication request\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Import service principal name so the proper ticket can be acquired by 
     * the GSSAPI system. 
     */ 
</span>    <a href="fe-auth.c.html#LN199"><span class='Ref_To_Local'>maxlen</span></a> <span class='Operator'>= </span><a href="../../include/getaddrinfo.h.html#LN87"><span class='Ref_to_Const'>NI_MAXHOST</span></a> <span class='Operator'>+ </span>strlen<span class='Parentheses'>(</span><a href="fe-auth.c.html#LN195"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN359"><span class='Ref_to_Member'>krbsrvname</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>2</span><span class='Delimiter'>; 
</span>    <a href="fe-auth.c.html#LN200"><span class='Ref_To_Local'>temp_gbuf</span></a><span class='Operator'>.</span><span class='Keyword'>value </span><span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/snowball/header.h.html#LN49"><span class='Ref_to_Macro'>malloc</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN199"><span class='Ref_To_Local'>maxlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fe-auth.c.html#LN200"><span class='Ref_To_Local'>temp_gbuf</span></a><span class='Operator'>.</span><span class='Keyword'>value</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN195"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                          <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN200"><span class='Ref_To_Local'>temp_gbuf</span></a><span class='Operator'>.</span><span class='Keyword'>value</span><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN199"><span class='Ref_To_Local'>maxlen</span></a><span class='Delimiter'>, </span><span class='String'>"%s@%s"</span><span class='Delimiter'>, 
</span>             <a href="fe-auth.c.html#LN195"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN359"><span class='Ref_to_Member'>krbsrvname</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN201"><span class='Ref_To_Local'>host</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="fe-auth.c.html#LN200"><span class='Ref_To_Local'>temp_gbuf</span></a><span class='Operator'>.</span><a href="../../include/libpq/libpq-be.h.html#LN60"><span class='Ref_to_Member'>length</span></a> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="fe-auth.c.html#LN200"><span class='Ref_To_Local'>temp_gbuf</span></a><span class='Operator'>.</span><span class='Keyword'>value</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="fe-auth.c.html#LN197"><span class='Ref_To_Local'>maj_stat</span></a> <span class='Operator'>= </span>gss_import_name<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN198"><span class='Ref_To_Local'>min_stat</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fe-auth.c.html#LN200"><span class='Ref_To_Local'>temp_gbuf</span></a><span class='Delimiter'>, 
</span>                               <a href="fe-auth.c.html#LN59"><span class='Ref_to_Global_Var'>GSS_C_NT_HOSTBASED_SERVICE</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fe-auth.c.html#LN195"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN475"><span class='Ref_to_Member'>gtarg_nam</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN200"><span class='Ref_To_Local'>temp_gbuf</span></a><span class='Operator'>.</span><span class='Keyword'>value</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN197"><span class='Ref_To_Local'>maj_stat</span></a> <span class='Operator'>!= </span>GSS_S_COMPLETE<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="fe-auth.c.html#LN85"><span class='Ref_to_Func'>pg_GSS_error</span></a><span class='Parentheses'>(</span><a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"GSSAPI name import error"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="fe-auth.c.html#LN195"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, 
</span>                     <a href="fe-auth.c.html#LN197"><span class='Ref_To_Local'>maj_stat</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN198"><span class='Ref_To_Local'>min_stat</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Initial packet is the same as a continuation packet with no initial 
     * context. 
     */ 
</span>    <a href="fe-auth.c.html#LN195"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN474"><span class='Ref_to_Member'>gctx</span></a> <span class='Operator'>= </span>GSS_C_NO_CONTEXT<span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="fe-auth.c.html#LN101"><span class='Ref_to_Func'>pg_GSS_continue</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN195"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN195"><span class='Ref_to_Parameter'>payloadlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pg_GSS_startup &raquo; </span> 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* ENABLE_GSS */ 
</span> 
 
<span class='Directive'>#ifdef</span> <a href="../../include/port/win32.h.html#LN30"><span class='Ref_to_Const'>ENABLE_SSPI</span></a> 
<span class='Comment_Multi_Line'>/* 
 * SSPI authentication system (Windows only) 
 */ 
</span> 
<span class='Keyword'>static void 
</span><a name="LN262"></a><span class='Declare_Function'>pg_SSPI_error</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>mprefix</span><span class='Delimiter'>, </span>SECURITY_STATUS <span class='Declare_Parameter'>r</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN264"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>sysmsg</span><span class='Delimiter'>[</span><span class='Number'>256</span><span class='Delimiter'>]; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>FormatMessage<span class='Parentheses'>(</span>FORMAT_MESSAGE_IGNORE_INSERTS <span class='Operator'>| 
</span>                      FORMAT_MESSAGE_FROM_SYSTEM<span class='Delimiter'>, 
</span>                      <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN262"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                      <a href="fe-auth.c.html#LN264"><span class='Ref_To_Local'>sysmsg</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN264"><span class='Ref_To_Local'>sysmsg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN262"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, </span><span class='String'>"%s: SSPI error %x\n"</span><span class='Delimiter'>, 
</span>                          <a href="fe-auth.c.html#LN262"><span class='Ref_to_Parameter'>mprefix</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>unsigned int</span><span class='Parentheses'>) </span><a href="fe-auth.c.html#LN262"><span class='Ref_to_Parameter'>r</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN262"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, </span><span class='String'>"%s: %s (%x)\n"</span><span class='Delimiter'>, 
</span>                          <a href="fe-auth.c.html#LN262"><span class='Ref_to_Parameter'>mprefix</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN264"><span class='Ref_To_Local'>sysmsg</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>unsigned int</span><span class='Parentheses'>) </span><a href="fe-auth.c.html#LN262"><span class='Ref_to_Parameter'>r</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Continue SSPI authentication with next token as needed. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN281"></a><span class='Declare_Function'>pg_SSPI_continue</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>payloadlen</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN283"></a>    SECURITY_STATUS <span class='Declare_Local'>r</span><span class='Delimiter'>; 
</span><a name="LN284"></a>    CtxtHandle  <span class='Declare_Local'>newContext</span><span class='Delimiter'>; 
</span><a name="LN285"></a>    ULONG       <span class='Declare_Local'>contextAttr</span><span class='Delimiter'>; 
</span><a name="LN286"></a>    SecBufferDesc <span class='Declare_Local'>inbuf</span><span class='Delimiter'>; 
</span><a name="LN287"></a>    SecBufferDesc <span class='Declare_Local'>outbuf</span><span class='Delimiter'>; 
</span><a name="LN288"></a>    SecBuffer   <span class='Declare_Local'>OutBuffers</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN289"></a>    SecBuffer   <span class='Declare_Local'>InBuffers</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN290"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>inputbuf</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN281"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN484"><span class='Ref_to_Member'>sspictx</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * On runs other than the first we have some data to send. Put this 
         * data in a SecBuffer type structure. 
         */ 
</span>        <a href="fe-auth.c.html#LN290"><span class='Ref_To_Local'>inputbuf</span></a> <span class='Operator'>= </span><a href="../../include/snowball/header.h.html#LN49"><span class='Ref_to_Macro'>malloc</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN281"><span class='Ref_to_Parameter'>payloadlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fe-auth.c.html#LN290"><span class='Ref_To_Local'>inputbuf</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN281"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory allocating SSPI buffer (%d)\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                              <a href="fe-auth.c.html#LN281"><span class='Ref_to_Parameter'>payloadlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-misc.c.html#LN195"><span class='Ref_to_Func'>pqGetnchar</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN290"><span class='Ref_To_Local'>inputbuf</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN281"><span class='Ref_to_Parameter'>payloadlen</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN281"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Shouldn't happen, because the caller should've ensured that the 
             * whole message is already in the input buffer. 
             */ 
</span>            <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN290"><span class='Ref_To_Local'>inputbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="fe-auth.c.html#LN286"><span class='Ref_To_Local'>inbuf</span></a><span class='Operator'>.</span>ulVersion <span class='Operator'>= </span>SECBUFFER_VERSION<span class='Delimiter'>; 
</span>        <a href="fe-auth.c.html#LN286"><span class='Ref_To_Local'>inbuf</span></a><span class='Operator'>.</span>cBuffers <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <a href="fe-auth.c.html#LN286"><span class='Ref_To_Local'>inbuf</span></a><span class='Operator'>.</span>pBuffers <span class='Operator'>= </span><a href="fe-auth.c.html#LN289"><span class='Ref_To_Local'>InBuffers</span></a><span class='Delimiter'>; 
</span>        <a href="fe-auth.c.html#LN289"><span class='Ref_To_Local'>InBuffers</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span>pvBuffer <span class='Operator'>= </span><a href="fe-auth.c.html#LN290"><span class='Ref_To_Local'>inputbuf</span></a><span class='Delimiter'>; 
</span>        <a href="fe-auth.c.html#LN289"><span class='Ref_To_Local'>InBuffers</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span>cbBuffer <span class='Operator'>= </span><a href="fe-auth.c.html#LN281"><span class='Ref_to_Parameter'>payloadlen</span></a><span class='Delimiter'>; 
</span>        <a href="fe-auth.c.html#LN289"><span class='Ref_To_Local'>InBuffers</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span>BufferType <span class='Operator'>= </span>SECBUFFER_TOKEN<span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if conn-&GT;sspictx!=NULL &raquo; </span> 
 
    <a href="fe-auth.c.html#LN288"><span class='Ref_To_Local'>OutBuffers</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span>pvBuffer <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="fe-auth.c.html#LN288"><span class='Ref_To_Local'>OutBuffers</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span>BufferType <span class='Operator'>= </span>SECBUFFER_TOKEN<span class='Delimiter'>; 
</span>    <a href="fe-auth.c.html#LN288"><span class='Ref_To_Local'>OutBuffers</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span>cbBuffer <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="fe-auth.c.html#LN287"><span class='Ref_To_Local'>outbuf</span></a><span class='Operator'>.</span>cBuffers <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="fe-auth.c.html#LN287"><span class='Ref_To_Local'>outbuf</span></a><span class='Operator'>.</span>pBuffers <span class='Operator'>= </span><a href="fe-auth.c.html#LN288"><span class='Ref_To_Local'>OutBuffers</span></a><span class='Delimiter'>; 
</span>    <a href="fe-auth.c.html#LN287"><span class='Ref_To_Local'>outbuf</span></a><span class='Operator'>.</span>ulVersion <span class='Operator'>= </span>SECBUFFER_VERSION<span class='Delimiter'>; 
</span> 
    <a href="fe-auth.c.html#LN283"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span>InitializeSecurityContext<span class='Parentheses'>(</span><a href="fe-auth.c.html#LN281"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN483"><span class='Ref_to_Member'>sspicred</span></a><span class='Delimiter'>, 
</span>                                  <a href="fe-auth.c.html#LN281"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN484"><span class='Ref_to_Member'>sspictx</span></a><span class='Delimiter'>, 
</span>                                  <a href="fe-auth.c.html#LN281"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN485"><span class='Ref_to_Member'>sspitarget</span></a><span class='Delimiter'>, 
</span>                                  ISC_REQ_ALLOCATE_MEMORY<span class='Delimiter'>, 
</span>                                  <span class='Number'>0</span><span class='Delimiter'>, 
</span>                                  SECURITY_NETWORK_DREP<span class='Delimiter'>, 
</span>                                  <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN281"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN484"><span class='Ref_to_Member'>sspictx</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) </span><span class='Operator'>? </span><span class='Null_Value'>NULL </span><span class='Operator'>: &</span><a href="fe-auth.c.html#LN286"><span class='Ref_To_Local'>inbuf</span></a><span class='Delimiter'>, 
</span>                                  <span class='Number'>0</span><span class='Delimiter'>, 
</span>                                  <span class='Operator'>&</span><a href="fe-auth.c.html#LN284"><span class='Ref_To_Local'>newContext</span></a><span class='Delimiter'>, 
</span>                                  <span class='Operator'>&</span><a href="fe-auth.c.html#LN287"><span class='Ref_To_Local'>outbuf</span></a><span class='Delimiter'>, 
</span>                                  <span class='Operator'>&</span><a href="fe-auth.c.html#LN285"><span class='Ref_To_Local'>contextAttr</span></a><span class='Delimiter'>, 
</span>                                  <span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* we don't need the input anymore */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN290"><span class='Ref_To_Local'>inputbuf</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN290"><span class='Ref_To_Local'>inputbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN283"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>!= </span>SEC_E_OK <span class='Operator'>&& </span><a href="fe-auth.c.html#LN283"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>!= </span>SEC_I_CONTINUE_NEEDED<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="fe-auth.c.html#LN261"><span class='Ref_to_Func'>pg_SSPI_error</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN281"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"SSPI continuation error"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN283"><span class='Ref_To_Local'>r</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN281"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN484"><span class='Ref_to_Member'>sspictx</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* On first run, transfer retrieved context handle */ 
</span>        <a href="fe-auth.c.html#LN281"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN484"><span class='Ref_to_Member'>sspictx</span></a> <span class='Operator'>= </span><a href="../../include/snowball/header.h.html#LN49"><span class='Ref_to_Macro'>malloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span>CtxtHandle<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN281"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN484"><span class='Ref_to_Member'>sspictx</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN281"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, </span><a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        memcpy<span class='Parentheses'>(</span><a href="fe-auth.c.html#LN281"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN484"><span class='Ref_to_Member'>sspictx</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fe-auth.c.html#LN284"><span class='Ref_To_Local'>newContext</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span>CtxtHandle<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If SSPI returned any data to be sent to the server (as it normally 
     * would), send this data as a password packet. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN287"><span class='Ref_To_Local'>outbuf</span></a><span class='Operator'>.</span>cBuffers <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN287"><span class='Ref_To_Local'>outbuf</span></a><span class='Operator'>.</span>cBuffers <span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * This should never happen, at least not for Kerberos 
             * authentication. Keep check in case it shows up with other 
             * authentication methods later. 
             */ 
</span>            <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN281"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, </span><span class='String'>"SSPI returned invalid number of output buffers\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If the negotiation is complete, there may be zero bytes to send. 
         * The server is at this point not expecting any more data, so don't 
         * send it. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN287"><span class='Ref_To_Local'>outbuf</span></a><span class='Operator'>.</span>pBuffers<span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span>cbBuffer <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="libpq-int.h.html#LN544"><span class='Ref_to_Proto'>pqPacketSend</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN281"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><span class='String'>'p'</span><span class='Delimiter'>, 
</span>                   <a href="fe-auth.c.html#LN287"><span class='Ref_To_Local'>outbuf</span></a><span class='Operator'>.</span>pBuffers<span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span>pvBuffer<span class='Delimiter'>, </span><a href="fe-auth.c.html#LN287"><span class='Ref_To_Local'>outbuf</span></a><span class='Operator'>.</span>pBuffers<span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span>cbBuffer<span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                FreeContextBuffer<span class='Parentheses'>(</span><a href="fe-auth.c.html#LN287"><span class='Ref_To_Local'>outbuf</span></a><span class='Operator'>.</span>pBuffers<span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span>pvBuffer<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        FreeContextBuffer<span class='Parentheses'>(</span><a href="fe-auth.c.html#LN287"><span class='Ref_To_Local'>outbuf</span></a><span class='Operator'>.</span>pBuffers<span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span>pvBuffer<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if outbuf.cBuffers&GT;0 &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Cleanup is handled by the code in freePGconn() */ 
</span>    <span class='Control'>return</span> <a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pg_SSPI_continue &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Send initial SSPI authentication token. 
 * If use_negotiate is 0, use kerberos authentication package which is 
 * compatible with Unix. If use_negotiate is 1, use the negotiate package 
 * which supports both kerberos and NTLM, but is not compatible with Unix. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN412"></a><span class='Declare_Function'>pg_SSPI_startup</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>use_negotiate</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>payloadlen</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN414"></a>    SECURITY_STATUS <span class='Declare_Local'>r</span><span class='Delimiter'>; 
</span><a name="LN415"></a>    TimeStamp   <span class='Declare_Local'>expire</span><span class='Delimiter'>; 
</span><a name="LN416"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>host</span> <span class='Operator'>= </span><a href="libpq-fe.h.html#LN313"><span class='Ref_to_Proto'>PQhost</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN412"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN412"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN484"><span class='Ref_to_Member'>sspictx</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN412"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                   <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"duplicate SSPI authentication request\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Retrieve credentials handle 
     */ 
</span>    <a href="fe-auth.c.html#LN412"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN483"><span class='Ref_to_Member'>sspicred</span></a> <span class='Operator'>= </span><a href="../../include/snowball/header.h.html#LN49"><span class='Ref_to_Macro'>malloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span>CredHandle<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN412"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN483"><span class='Ref_to_Member'>sspicred</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN412"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, </span><a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="fe-auth.c.html#LN414"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span>AcquireCredentialsHandle<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                 <a href="fe-auth.c.html#LN412"><span class='Ref_to_Parameter'>use_negotiate</span></a> <span class='Operator'>? </span><span class='String'>"negotiate"</span> <span class='Operator'>: </span><span class='String'>"kerberos"</span><span class='Delimiter'>, 
</span>                                 SECPKG_CRED_OUTBOUND<span class='Delimiter'>, 
</span>                                 <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                 <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                 <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                 <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                 <a href="fe-auth.c.html#LN412"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN483"><span class='Ref_to_Member'>sspicred</span></a><span class='Delimiter'>, 
</span>                                 <span class='Operator'>&</span><a href="fe-auth.c.html#LN415"><span class='Ref_To_Local'>expire</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN414"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>!= </span>SEC_E_OK<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="fe-auth.c.html#LN261"><span class='Ref_to_Func'>pg_SSPI_error</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN412"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"could not acquire SSPI credentials"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN414"><span class='Ref_To_Local'>r</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN412"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN483"><span class='Ref_to_Member'>sspicred</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="fe-auth.c.html#LN412"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN483"><span class='Ref_to_Member'>sspicred</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Compute target principal name. SSPI has a different format from GSSAPI, 
     * but not more complex. We can skip the @REALM part, because Windows will 
     * fill that in for us automatically. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN416"><span class='Ref_To_Local'>host</span></a> <span class='Operator'>&& </span><a href="fe-auth.c.html#LN416"><span class='Ref_To_Local'>host</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='String'>'\0'</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN412"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                          <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"host name must be specified\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="fe-auth.c.html#LN412"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN485"><span class='Ref_to_Member'>sspitarget</span></a> <span class='Operator'>= </span><a href="../../include/snowball/header.h.html#LN49"><span class='Ref_to_Macro'>malloc</span></a><span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="fe-auth.c.html#LN412"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN359"><span class='Ref_to_Member'>krbsrvname</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span>strlen<span class='Parentheses'>(</span><a href="fe-auth.c.html#LN416"><span class='Ref_To_Local'>host</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fe-auth.c.html#LN412"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN485"><span class='Ref_to_Member'>sspitarget</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN412"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, </span><a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN412"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN485"><span class='Ref_to_Member'>sspitarget</span></a><span class='Delimiter'>, </span><span class='String'>"%s/%s"</span><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN412"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN359"><span class='Ref_to_Member'>krbsrvname</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN416"><span class='Ref_To_Local'>host</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Indicate that we're in SSPI authentication mode to make sure that 
     * pg_SSPI_continue is called next time in the negotiation. 
     */ 
</span>    <a href="fe-auth.c.html#LN412"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN486"><span class='Ref_to_Member'>usesspi</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="fe-auth.c.html#LN280"><span class='Ref_to_Func'>pg_SSPI_continue</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN412"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN412"><span class='Ref_to_Parameter'>payloadlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pg_SSPI_startup &raquo; </span> 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* ENABLE_SSPI */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Initialize SASL authentication exchange. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN485"></a><span class='Declare_Function'>pg_SASL_init</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>payloadlen</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN487"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>initialresponse</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN488"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>initialresponselen</span><span class='Delimiter'>; 
</span><a name="LN489"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>done</span><span class='Delimiter'>; 
</span><a name="LN490"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>success</span><span class='Delimiter'>; 
</span><a name="LN491"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>selected_mechanism</span><span class='Delimiter'>; 
</span><a name="LN492"></a>    <a href="pqexpbuffer.h.html#LN43"><span class='Ref_to_Struct'>PQExpBufferData</span></a> <span class='Declare_Local'>mechanism_buf</span><span class='Delimiter'>; 
</span> 
    <a href="pqexpbuffer.c.html#LN87"><span class='Ref_to_Func'>initPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN492"><span class='Ref_To_Local'>mechanism_buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN485"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN454"><span class='Ref_to_Member'>sasl_state</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN485"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                   <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"duplicate SASL authentication request\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="fe-auth.c.html#LN597"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Parse the list of SASL authentication mechanisms in the 
     * AuthenticationSASL message, and select the best mechanism that we 
     * support.  (Only SCRAM-SHA-256 is supported at the moment.) 
     */ 
</span>    <a href="fe-auth.c.html#LN491"><span class='Ref_To_Local'>selected_mechanism</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-misc.c.html#LN163"><span class='Ref_to_Func'>pqGets</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN492"><span class='Ref_To_Local'>mechanism_buf</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN485"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN485"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                              <span class='String'>"fe_sendauth: invalid authentication request from server: invalid list of authentication mechanisms\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="fe-auth.c.html#LN597"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqexpbuffer.h.html#LN66"><span class='Ref_to_Macro'>PQExpBufferDataBroken</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN492"><span class='Ref_To_Local'>mechanism_buf</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="fe-auth.c.html#LN603"><span class='Ref_to_Label'>oom_error</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* An empty string indicates end of list */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN492"><span class='Ref_To_Local'>mechanism_buf</span></a><span class='Operator'>.</span><a href="pqexpbuffer.h.html#LN45"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If we have already selected a mechanism, just skip through the rest 
         * of the list. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN491"><span class='Ref_To_Local'>selected_mechanism</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Do we support this mechanism? 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="fe-auth.c.html#LN492"><span class='Ref_To_Local'>mechanism_buf</span></a><span class='Operator'>.</span><a href="pqexpbuffer.h.html#LN45"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><a href="../../include/libpq/scram.h.html#LN16"><span class='Ref_to_Const'>SCRAM_SHA256_NAME</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><a name="LN536"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>password</span><span class='Delimiter'>; 
</span> 
            <a href="fe-auth.c.html#LN485"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN407"><span class='Ref_to_Member'>password_needed</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="fe-auth.c.html#LN536"><span class='Ref_To_Local'>password</span></a> <span class='Operator'>= </span><a href="fe-auth.c.html#LN485"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN396"><span class='Ref_to_Member'>connhost</span></a><span class='Delimiter'>[</span><a href="fe-auth.c.html#LN485"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN395"><span class='Ref_to_Member'>whichhost</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="libpq-int.h.html#LN310"><span class='Ref_to_Member'>password</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN536"><span class='Ref_To_Local'>password</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <a href="fe-auth.c.html#LN536"><span class='Ref_To_Local'>password</span></a> <span class='Operator'>= </span><a href="fe-auth.c.html#LN485"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN342"><span class='Ref_to_Member'>pgpass</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN536"><span class='Ref_To_Local'>password</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><a href="fe-auth.c.html#LN536"><span class='Ref_To_Local'>password</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN485"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                                  <a href="libpq-fe.h.html#LN511"><span class='Ref_to_Const'>PQnoPasswordSupplied</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="fe-auth.c.html#LN597"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="fe-auth.c.html#LN485"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN454"><span class='Ref_to_Member'>sasl_state</span></a> <span class='Operator'>= </span><a href="fe-auth.h.html#LN25"><span class='Ref_to_Proto'>pg_fe_scram_init</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN485"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN341"><span class='Ref_to_Member'>pguser</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN536"><span class='Ref_To_Local'>password</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fe-auth.c.html#LN485"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN454"><span class='Ref_to_Member'>sasl_state</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="fe-auth.c.html#LN603"><span class='Ref_to_Label'>oom_error</span></a><span class='Delimiter'>; 
</span>            <a href="fe-auth.c.html#LN491"><span class='Ref_To_Local'>selected_mechanism</span></a> <span class='Operator'>= </span><a href="../../include/libpq/scram.h.html#LN16"><span class='Ref_to_Const'>SCRAM_SHA256_NAME</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if strcmp(mechanism_buf.... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fe-auth.c.html#LN491"><span class='Ref_To_Local'>selected_mechanism</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN485"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                          <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"none of the server's SASL authentication mechanisms are supported\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="fe-auth.c.html#LN597"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Get the mechanism-specific Initial Client Response, if any */ 
</span>    <a href="fe-auth.h.html#LN27"><span class='Ref_to_Proto'>pg_fe_scram_exchange</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN485"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN454"><span class='Ref_to_Member'>sasl_state</span></a><span class='Delimiter'>, 
</span>                         <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                         <span class='Operator'>&</span><a href="fe-auth.c.html#LN487"><span class='Ref_To_Local'>initialresponse</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fe-auth.c.html#LN488"><span class='Ref_To_Local'>initialresponselen</span></a><span class='Delimiter'>, 
</span>                         <span class='Operator'>&</span><a href="fe-auth.c.html#LN489"><span class='Ref_To_Local'>done</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fe-auth.c.html#LN490"><span class='Ref_To_Local'>success</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fe-auth.c.html#LN485"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN489"><span class='Ref_To_Local'>done</span></a> <span class='Operator'>&& !</span><a href="fe-auth.c.html#LN490"><span class='Ref_To_Local'>success</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="fe-auth.c.html#LN597"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Build a SASLInitialResponse message, and send it. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-misc.c.html#LN519"><span class='Ref_to_Func'>pqPutMsgStart</span></a><span class='Parentheses'>(</span><span class='String'>'p'</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN485"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="fe-auth.c.html#LN597"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-misc.c.html#LN179"><span class='Ref_to_Func'>pqPuts</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN491"><span class='Ref_To_Local'>selected_mechanism</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN485"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="fe-auth.c.html#LN597"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN487"><span class='Ref_To_Local'>initialresponse</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-misc.c.html#LN307"><span class='Ref_to_Func'>pqPutInt</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN488"><span class='Ref_To_Local'>initialresponselen</span></a><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN485"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="fe-auth.c.html#LN597"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-misc.c.html#LN246"><span class='Ref_to_Func'>pqPutnchar</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN487"><span class='Ref_To_Local'>initialresponse</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN488"><span class='Ref_To_Local'>initialresponselen</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN485"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="fe-auth.c.html#LN597"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-misc.c.html#LN587"><span class='Ref_to_Func'>pqPutMsgEnd</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN485"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="fe-auth.c.html#LN597"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="libpq-int.h.html#LN637"><span class='Ref_to_Proto'>pqFlush</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN485"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="fe-auth.c.html#LN597"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span> 
    <a href="pqexpbuffer.h.html#LN121"><span class='Ref_to_Proto'>termPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN492"><span class='Ref_To_Local'>mechanism_buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN487"><span class='Ref_To_Local'>initialresponse</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN487"><span class='Ref_To_Local'>initialresponse</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Delimiter'>; 
</span> 
<a name="LN597"></a><span class='Label'>error</span><span class='Operator'>: 
</span>    <a href="pqexpbuffer.h.html#LN121"><span class='Ref_to_Proto'>termPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN492"><span class='Ref_To_Local'>mechanism_buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN487"><span class='Ref_To_Local'>initialresponse</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN487"><span class='Ref_To_Local'>initialresponse</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span> 
<a name="LN603"></a><span class='Label'>oom_error</span><span class='Operator'>: 
</span>    <a href="pqexpbuffer.h.html#LN121"><span class='Ref_to_Proto'>termPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN492"><span class='Ref_To_Local'>mechanism_buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN487"><span class='Ref_To_Local'>initialresponse</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN487"><span class='Ref_To_Local'>initialresponse</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN485"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                      <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pg_SASL_init &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Exchange a message for SASL communication protocol with the backend. 
 * This should be used after calling pg_SASL_init to set up the status of 
 * the protocol. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN618"></a><span class='Declare_Function'>pg_SASL_continue</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>payloadlen</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>final</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN620"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>output</span><span class='Delimiter'>; 
</span><a name="LN621"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>outputlen</span><span class='Delimiter'>; 
</span><a name="LN622"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>done</span><span class='Delimiter'>; 
</span><a name="LN623"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>success</span><span class='Delimiter'>; 
</span><a name="LN624"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span><a name="LN625"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>challenge</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Read the SASL challenge from the AuthenticationSASLContinue message. */ 
</span>    <a href="fe-auth.c.html#LN625"><span class='Ref_To_Local'>challenge</span></a> <span class='Operator'>= </span><a href="../../include/snowball/header.h.html#LN49"><span class='Ref_to_Macro'>malloc</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN618"><span class='Ref_to_Parameter'>payloadlen</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fe-auth.c.html#LN625"><span class='Ref_To_Local'>challenge</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN618"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory allocating SASL buffer (%d)\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                          <a href="fe-auth.c.html#LN618"><span class='Ref_to_Parameter'>payloadlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-misc.c.html#LN195"><span class='Ref_to_Func'>pqGetnchar</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN625"><span class='Ref_To_Local'>challenge</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN618"><span class='Ref_to_Parameter'>payloadlen</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN618"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN625"><span class='Ref_To_Local'>challenge</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Comment_Multi_Line'>/* For safety and convenience, ensure the buffer is NULL-terminated. */ 
</span>    <a href="fe-auth.c.html#LN625"><span class='Ref_To_Local'>challenge</span></a><span class='Delimiter'>[</span><a href="fe-auth.c.html#LN618"><span class='Ref_to_Parameter'>payloadlen</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span> 
    <a href="fe-auth.h.html#LN27"><span class='Ref_to_Proto'>pg_fe_scram_exchange</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN618"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN454"><span class='Ref_to_Member'>sasl_state</span></a><span class='Delimiter'>, 
</span>                         <a href="fe-auth.c.html#LN625"><span class='Ref_To_Local'>challenge</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN618"><span class='Ref_to_Parameter'>payloadlen</span></a><span class='Delimiter'>, 
</span>                         <span class='Operator'>&</span><a href="fe-auth.c.html#LN620"><span class='Ref_To_Local'>output</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fe-auth.c.html#LN621"><span class='Ref_To_Local'>outputlen</span></a><span class='Delimiter'>, 
</span>                         <span class='Operator'>&</span><a href="fe-auth.c.html#LN622"><span class='Ref_To_Local'>done</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fe-auth.c.html#LN623"><span class='Ref_To_Local'>success</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fe-auth.c.html#LN618"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN625"><span class='Ref_To_Local'>challenge</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* don't need the input anymore */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Keyword'>final </span><span class='Operator'>&& !</span><a href="fe-auth.c.html#LN622"><span class='Ref_To_Local'>done</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN621"><span class='Ref_To_Local'>outputlen</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN620"><span class='Ref_To_Local'>output</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN618"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                          <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"AuthenticationSASLFinal received from server, but SASL authentication was not completed\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN621"><span class='Ref_To_Local'>outputlen</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Send the SASL response to the server. 
         */ 
</span>        <a href="fe-auth.c.html#LN624"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="libpq-int.h.html#LN544"><span class='Ref_to_Proto'>pqPacketSend</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN618"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><span class='String'>'p'</span><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN620"><span class='Ref_To_Local'>output</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN621"><span class='Ref_To_Local'>outputlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN620"><span class='Ref_To_Local'>output</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN624"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>!= </span><a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN622"><span class='Ref_To_Local'>done</span></a> <span class='Operator'>&& !</span><a href="fe-auth.c.html#LN623"><span class='Ref_To_Local'>success</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pg_SASL_continue &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Respond to AUTH_REQ_SCM_CREDS challenge. 
 * 
 * Note: this is dead code as of Postgres 9.1, because current backends will 
 * never send this challenge.  But we must keep it as long as libpq needs to 
 * interoperate with pre-9.1 servers.  It is believed to be needed only on 
 * Debian/kFreeBSD (ie, FreeBSD kernel with Linux userland, so that the 
 * getpeereid() function isn't provided by libc). 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN688"></a><span class='Declare_Function'>pg_local_sendauth</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> HAVE_STRUCT_CMSGCRED 
<a name="LN691"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN692"></a>    <span class='Control'>struct</span> iovec <span class='Declare_Local'>iov</span><span class='Delimiter'>; 
</span><a name="LN693"></a>    <span class='Control'>struct</span> msghdr <span class='Declare_Local'>msg</span><span class='Delimiter'>; 
</span><a name="LN694"></a>    <span class='Control'>struct</span> cmsghdr <span class='Operator'>*</span><span class='Declare_Local'>cmsg</span><span class='Delimiter'>; 
</span>    <span class='Control'>union</span> 
    <span class='Delimiter'>{ 
</span><a name="LN697"></a>        <span class='Control'>struct</span> cmsghdr <span class='Declare_Member'>hdr</span><span class='Delimiter'>; 
</span><a name="LN698"></a>        <span class='Keyword'>unsigned char </span><span class='Declare_Member'>buf</span><span class='Delimiter'>[</span>CMSG_SPACE<span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Control'>struct</span> cmsgcred<span class='Parentheses'>))</span><span class='Delimiter'>]; 
</span><a name="LN699"></a>    <span class='Delimiter'>}</span>           <span class='Declare_Local'>cmsgbuf</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The backend doesn't care what we send here, but it wants exactly one 
     * character to force recvmsg() to block and wait for us. 
     */ 
</span>    <a href="fe-auth.c.html#LN691"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>    <a href="fe-auth.c.html#LN692"><span class='Ref_To_Local'>iov</span></a><span class='Operator'>.</span>iov_base <span class='Operator'>= &</span><a href="fe-auth.c.html#LN691"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>; 
</span>    <a href="fe-auth.c.html#LN692"><span class='Ref_To_Local'>iov</span></a><span class='Operator'>.</span>iov_len <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN693"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN693"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="fe-auth.c.html#LN693"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span>msg_iov <span class='Operator'>= &</span><a href="fe-auth.c.html#LN692"><span class='Ref_To_Local'>iov</span></a><span class='Delimiter'>; 
</span>    <a href="fe-auth.c.html#LN693"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span>msg_iovlen <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We must set up a message that will be filled in by kernel */ 
</span>    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN699"><span class='Ref_To_Local'>cmsgbuf</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN699"><span class='Ref_To_Local'>cmsgbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="fe-auth.c.html#LN693"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span>msg_control <span class='Operator'>= &</span><a href="fe-auth.c.html#LN699"><span class='Ref_To_Local'>cmsgbuf</span></a><span class='Operator'>.</span><a href="fe-auth.c.html#LN698"><span class='Ref_to_Member'>buf</span></a><span class='Delimiter'>; 
</span>    <a href="fe-auth.c.html#LN693"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span>msg_controllen <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN699"><span class='Ref_To_Local'>cmsgbuf</span></a><span class='Operator'>.</span><a href="fe-auth.c.html#LN698"><span class='Ref_to_Member'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="fe-auth.c.html#LN694"><span class='Ref_To_Local'>cmsg</span></a> <span class='Operator'>= </span>CMSG_FIRSTHDR<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN693"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="fe-auth.c.html#LN694"><span class='Ref_To_Local'>cmsg</span></a><span class='Operator'>-&GT;</span>cmsg_len <span class='Operator'>= </span>CMSG_LEN<span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Control'>struct</span> cmsgcred<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="fe-auth.c.html#LN694"><span class='Ref_To_Local'>cmsg</span></a><span class='Operator'>-&GT;</span>cmsg_level <span class='Operator'>= </span>SOL_SOCKET<span class='Delimiter'>; 
</span>    <a href="fe-auth.c.html#LN694"><span class='Ref_To_Local'>cmsg</span></a><span class='Operator'>-&GT;</span>cmsg_type <span class='Operator'>= </span>SCM_CREDS<span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>sendmsg<span class='Parentheses'>(</span><a href="fe-auth.c.html#LN688"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN399"><span class='Ref_to_Member'>sock</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fe-auth.c.html#LN693"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN724"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>sebuf</span><span class='Delimiter'>[</span><span class='Number'>256</span><span class='Delimiter'>]; 
</span> 
        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN688"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                          <span class='String'>"pg_local_sendauth: sendmsg: %s\n"</span><span class='Delimiter'>, 
</span>                          <a href="../../port/thread.c.html#LN59"><span class='Ref_to_Func'>pqStrerror</span></a><span class='Parentheses'>(</span>errno<span class='Delimiter'>, </span><a href="fe-auth.c.html#LN724"><span class='Ref_To_Local'>sebuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN724"><span class='Ref_To_Local'>sebuf</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
    <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN688"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>            <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"SCM_CRED authentication method not supported\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end pg_local_sendauth &raquo; </span> 
 
<span class='Keyword'>static int 
</span><a name="LN740"></a><span class='Declare_Function'>pg_password_sendauth</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>password</span><span class='Delimiter'>, </span><a href="../../include/libpq/pqcomm.h.html#LN178"><span class='Ref_to_Typedef'>AuthRequest</span></a> <span class='Declare_Parameter'>areq</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN742"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ret</span><span class='Delimiter'>; 
</span><a name="LN743"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>crypt_pwd</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN744"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>pwd_to_send</span><span class='Delimiter'>; 
</span><a name="LN745"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>md5Salt</span><span class='Delimiter'>[</span><span class='Number'>4</span><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* Read the salt from the AuthenticationMD5 message. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN740"><span class='Ref_to_Parameter'>areq</span></a> <span class='Operator'>== </span><a href="../../include/libpq/pqcomm.h.html#LN169"><span class='Ref_to_Const'>AUTH_REQ_MD5</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-misc.c.html#LN195"><span class='Ref_to_Func'>pqGetnchar</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN745"><span class='Ref_To_Local'>md5Salt</span></a><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN740"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* shouldn't happen */ 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Encrypt the password if needed. */ 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN740"><span class='Ref_to_Parameter'>areq</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../include/libpq/pqcomm.h.html#LN169"><span class='Ref_to_Const'>AUTH_REQ_MD5</span></a><span class='Operator'>: 
</span>            <span class='Delimiter'>{ 
</span><a name="LN760"></a>                <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>crypt_pwd2</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* Allocate enough space for two MD5 hashes */ 
</span>                <a href="fe-auth.c.html#LN743"><span class='Ref_To_Local'>crypt_pwd</span></a> <span class='Operator'>= </span><a href="../../include/snowball/header.h.html#LN49"><span class='Ref_to_Macro'>malloc</span></a><span class='Parentheses'>(</span><span class='Number'>2</span> <span class='Operator'>* </span><span class='Parentheses'>(</span><a href="../../include/common/md5.h.html#LN18"><span class='Ref_to_Const'>MD5_PASSWD_LEN</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fe-auth.c.html#LN743"><span class='Ref_To_Local'>crypt_pwd</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN740"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                                      <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <a href="fe-auth.c.html#LN760"><span class='Ref_To_Local'>crypt_pwd2</span></a> <span class='Operator'>= </span><a href="fe-auth.c.html#LN743"><span class='Ref_To_Local'>crypt_pwd</span></a> <span class='Operator'>+ </span><a href="../../include/common/md5.h.html#LN18"><span class='Ref_to_Const'>MD5_PASSWD_LEN</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/common/md5.h.html#LN22"><span class='Ref_to_Proto'>pg_md5_encrypt</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN740"><span class='Ref_to_Parameter'>password</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN740"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN341"><span class='Ref_to_Member'>pguser</span></a><span class='Delimiter'>, 
</span>                                    strlen<span class='Parentheses'>(</span><a href="fe-auth.c.html#LN740"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN341"><span class='Ref_to_Member'>pguser</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN760"><span class='Ref_To_Local'>crypt_pwd2</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN743"><span class='Ref_To_Local'>crypt_pwd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/common/md5.h.html#LN22"><span class='Ref_to_Proto'>pg_md5_encrypt</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN760"><span class='Ref_To_Local'>crypt_pwd2</span></a> <span class='Operator'>+ </span>strlen<span class='Parentheses'>(</span><span class='String'>"md5"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN745"><span class='Ref_To_Local'>md5Salt</span></a><span class='Delimiter'>, 
</span>                                    <span class='Number'>4</span><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN743"><span class='Ref_To_Local'>crypt_pwd</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN743"><span class='Ref_To_Local'>crypt_pwd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <a href="fe-auth.c.html#LN744"><span class='Ref_To_Local'>pwd_to_send</span></a> <span class='Operator'>= </span><a href="fe-auth.c.html#LN743"><span class='Ref_To_Local'>crypt_pwd</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Control'>case</span> <a href="../../include/libpq/pqcomm.h.html#LN167"><span class='Ref_to_Const'>AUTH_REQ_PASSWORD</span></a><span class='Operator'>: 
</span>            <a href="fe-auth.c.html#LN744"><span class='Ref_To_Local'>pwd_to_send</span></a> <span class='Operator'>= </span><a href="fe-auth.c.html#LN740"><span class='Ref_to_Parameter'>password</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>default</span><span class='Operator'>: 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch areq &raquo; </span> 
    <span class='Comment_Multi_Line'>/* Packet has a message type as of protocol 3.0 */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/libpq/pqcomm.h.html#LN103"><span class='Ref_to_Macro'>PG_PROTOCOL_MAJOR</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN740"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN403"><span class='Ref_to_Member'>pversion</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><span class='Number'>3</span><span class='Parentheses'>)</span> 
        <a href="fe-auth.c.html#LN742"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><a href="libpq-int.h.html#LN544"><span class='Ref_to_Proto'>pqPacketSend</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN740"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><span class='String'>'p'</span><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN744"><span class='Ref_To_Local'>pwd_to_send</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="fe-auth.c.html#LN744"><span class='Ref_To_Local'>pwd_to_send</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="fe-auth.c.html#LN742"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><a href="libpq-int.h.html#LN544"><span class='Ref_to_Proto'>pqPacketSend</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN740"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN744"><span class='Ref_To_Local'>pwd_to_send</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="fe-auth.c.html#LN744"><span class='Ref_To_Local'>pwd_to_send</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN743"><span class='Ref_To_Local'>crypt_pwd</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN743"><span class='Ref_To_Local'>crypt_pwd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="fe-auth.c.html#LN742"><span class='Ref_To_Local'>ret</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pg_password_sendauth &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * pg_fe_sendauth 
 *      client demux routine for processing an authentication request 
 * 
 * The server has sent us an authentication challenge (or OK). Send an 
 * appropriate response. The caller has ensured that the whole message is 
 * now in the input buffer, and has already read the type and length of 
 * it. We are responsible for reading any remaining extra data, specific 
 * to the authentication method. 'payloadlen' is the remaining length in 
 * the message. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN816"></a><span class='Declare_Function'>pg_fe_sendauth</span><span class='Parentheses'>(</span><a href="../../include/libpq/pqcomm.h.html#LN178"><span class='Ref_to_Typedef'>AuthRequest</span></a> <span class='Declare_Parameter'>areq</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>payloadlen</span><span class='Delimiter'>, </span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>areq</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../include/libpq/pqcomm.h.html#LN164"><span class='Ref_to_Const'>AUTH_REQ_OK</span></a><span class='Operator'>: 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../include/libpq/pqcomm.h.html#LN165"><span class='Ref_to_Const'>AUTH_REQ_KRB4</span></a><span class='Operator'>: 
</span>            <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                 <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"Kerberos 4 authentication not supported\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../include/libpq/pqcomm.h.html#LN166"><span class='Ref_to_Const'>AUTH_REQ_KRB5</span></a><span class='Operator'>: 
</span>            <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                 <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"Kerberos 5 authentication not supported\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span> 
<span class='Directive'>#if</span> defined<span class='Parentheses'>(</span>ENABLE_GSS<span class='Parentheses'>) </span><span class='Operator'>|| </span>defined<span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN30"><span class='Ref_to_Const'>ENABLE_SSPI</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>case</span> <a href="../../include/libpq/pqcomm.h.html#LN171"><span class='Ref_to_Const'>AUTH_REQ_GSS</span></a><span class='Operator'>: 
</span><span class='Directive'>#if</span> <span class='Operator'>!</span>defined<span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN30"><span class='Ref_to_Const'>ENABLE_SSPI</span></a><span class='Parentheses'>) 
</span>            <span class='Comment_Multi_Line'>/* no native SSPI, so use GSSAPI library for it */ 
</span>        <span class='Control'>case</span> <a href="../../include/libpq/pqcomm.h.html#LN173"><span class='Ref_to_Const'>AUTH_REQ_SSPI</span></a><span class='Operator'>: 
</span><span class='Directive'>#endif</span> 
            <span class='Delimiter'>{ 
</span><a name="LN840"></a>                <span class='Keyword'>int</span>         <span class='Declare_Local'>r</span><span class='Delimiter'>; 
</span> 
                <a href="libpq-int.h.html#LN558"><span class='Ref_to_Macro'>pglock_thread</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * If we have both GSS and SSPI support compiled in, use SSPI 
                 * support by default. This is overridable by a connection 
                 * string parameter. Note that when using SSPI we still leave 
                 * the negotiate parameter off, since we want SSPI to use the 
                 * GSSAPI kerberos protocol. For actual SSPI negotiate 
                 * protocol, we use AUTH_REQ_SSPI. 
                 */ 
</span><span class='Directive'>#if</span> defined<span class='Parentheses'>(</span>ENABLE_GSS<span class='Parentheses'>) </span><span class='Operator'>&& </span>defined<span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN30"><span class='Ref_to_Const'>ENABLE_SSPI</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN480"><span class='Ref_to_Member'>gsslib</span></a> <span class='Operator'>&& </span><span class='Parentheses'>(</span><a href="../../port/pgstrcasecmp.c.html#LN34"><span class='Ref_to_Func'>pg_strcasecmp</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN480"><span class='Ref_to_Member'>gsslib</span></a><span class='Delimiter'>, </span><span class='String'>"gssapi"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>))</span> 
                    <a href="fe-auth.c.html#LN840"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="fe-auth.c.html#LN194"><span class='Ref_to_Func'>pg_GSS_startup</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>payloadlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                    <a href="fe-auth.c.html#LN840"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="fe-auth.c.html#LN411"><span class='Ref_to_Func'>pg_SSPI_startup</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>payloadlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#elif</span> defined<span class='Parentheses'>(</span>ENABLE_GSS<span class='Parentheses'>) </span><span class='Operator'>&& !</span>defined<span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN30"><span class='Ref_to_Const'>ENABLE_SSPI</span></a><span class='Parentheses'>) 
</span>                <a href="fe-auth.c.html#LN840"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="fe-auth.c.html#LN194"><span class='Ref_to_Func'>pg_GSS_startup</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>payloadlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#elif</span> <span class='Operator'>!</span>defined<span class='Parentheses'>(</span>ENABLE_GSS<span class='Parentheses'>) </span><span class='Operator'>&& </span>defined<span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN30"><span class='Ref_to_Const'>ENABLE_SSPI</span></a><span class='Parentheses'>) 
</span>                <a href="fe-auth.c.html#LN840"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="fe-auth.c.html#LN411"><span class='Ref_to_Func'>pg_SSPI_startup</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>payloadlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN840"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>!= </span><a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* Error message already filled in. */ 
</span>                    <a href="libpq-int.h.html#LN559"><span class='Ref_to_Macro'>pgunlock_thread</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <a href="libpq-int.h.html#LN559"><span class='Ref_to_Macro'>pgunlock_thread</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../include/libpq/pqcomm.h.html#LN172"><span class='Ref_to_Const'>AUTH_REQ_GSS_CONT</span></a><span class='Operator'>: 
</span>            <span class='Delimiter'>{ 
</span><a name="LN874"></a>                <span class='Keyword'>int</span>         <span class='Declare_Local'>r</span><span class='Delimiter'>; 
</span> 
                <a href="libpq-int.h.html#LN558"><span class='Ref_to_Macro'>pglock_thread</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><span class='Directive'>#if</span> defined<span class='Parentheses'>(</span>ENABLE_GSS<span class='Parentheses'>) </span><span class='Operator'>&& </span>defined<span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN30"><span class='Ref_to_Const'>ENABLE_SSPI</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN486"><span class='Ref_to_Member'>usesspi</span></a><span class='Parentheses'>) 
</span>                    <a href="fe-auth.c.html#LN874"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="fe-auth.c.html#LN280"><span class='Ref_to_Func'>pg_SSPI_continue</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>payloadlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                    <a href="fe-auth.c.html#LN874"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="fe-auth.c.html#LN101"><span class='Ref_to_Func'>pg_GSS_continue</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>payloadlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#elif</span> defined<span class='Parentheses'>(</span>ENABLE_GSS<span class='Parentheses'>) </span><span class='Operator'>&& !</span>defined<span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN30"><span class='Ref_to_Const'>ENABLE_SSPI</span></a><span class='Parentheses'>) 
</span>                <a href="fe-auth.c.html#LN874"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="fe-auth.c.html#LN101"><span class='Ref_to_Func'>pg_GSS_continue</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>payloadlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#elif</span> <span class='Operator'>!</span>defined<span class='Parentheses'>(</span>ENABLE_GSS<span class='Parentheses'>) </span><span class='Operator'>&& </span>defined<span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN30"><span class='Ref_to_Const'>ENABLE_SSPI</span></a><span class='Parentheses'>) 
</span>                <a href="fe-auth.c.html#LN874"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="fe-auth.c.html#LN280"><span class='Ref_to_Func'>pg_SSPI_continue</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>payloadlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN874"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>!= </span><a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* Error message already filled in. */ 
</span>                    <a href="libpq-int.h.html#LN559"><span class='Ref_to_Macro'>pgunlock_thread</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <a href="libpq-int.h.html#LN559"><span class='Ref_to_Macro'>pgunlock_thread</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span>                           <span class='Comment_Single_Line'>/* defined(ENABLE_GSS) || defined(ENABLE_SSPI) */ 
</span>            <span class='Comment_Multi_Line'>/* No GSSAPI *or* SSPI support */ 
</span>        <span class='Control'>case</span> <a href="../../include/libpq/pqcomm.h.html#LN171"><span class='Ref_to_Const'>AUTH_REQ_GSS</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../include/libpq/pqcomm.h.html#LN172"><span class='Ref_to_Const'>AUTH_REQ_GSS_CONT</span></a><span class='Operator'>: 
</span>            <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                     <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"GSSAPI authentication not supported\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* defined(ENABLE_GSS) || defined(ENABLE_SSPI) */ 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/port/win32.h.html#LN30"><span class='Ref_to_Const'>ENABLE_SSPI</span></a> 
        <span class='Control'>case</span> <a href="../../include/libpq/pqcomm.h.html#LN173"><span class='Ref_to_Const'>AUTH_REQ_SSPI</span></a><span class='Operator'>: 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * SSPI has it's own startup message so libpq can decide which 
             * method to use. Indicate to pg_SSPI_startup that we want SSPI 
             * negotiation instead of Kerberos. 
             */ 
</span>            <a href="libpq-int.h.html#LN558"><span class='Ref_to_Macro'>pglock_thread</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN411"><span class='Ref_to_Func'>pg_SSPI_startup</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>payloadlen</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Error message already filled in. */ 
</span>                <a href="libpq-int.h.html#LN559"><span class='Ref_to_Macro'>pgunlock_thread</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="libpq-int.h.html#LN559"><span class='Ref_to_Macro'>pgunlock_thread</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
 
            <span class='Comment_Multi_Line'>/* 
             * No SSPI support. However, if we have GSSAPI but not SSPI 
             * support, AUTH_REQ_SSPI will have been handled in the codepath 
             * for AUTH_REQ_GSSAPI above, so don't duplicate the case label in 
             * that case. 
             */ 
</span><span class='Directive'>#if</span> <span class='Operator'>!</span>defined<span class='Parentheses'>(</span>ENABLE_GSS<span class='Parentheses'>) 
</span>        <span class='Control'>case</span> <a href="../../include/libpq/pqcomm.h.html#LN173"><span class='Ref_to_Const'>AUTH_REQ_SSPI</span></a><span class='Operator'>: 
</span>            <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                       <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"SSPI authentication not supported\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* !define(ENABLE_GSSAPI) */ 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* ENABLE_SSPI */ 
</span> 
 
        <span class='Control'>case</span> <a href="../../include/libpq/pqcomm.h.html#LN168"><span class='Ref_to_Const'>AUTH_REQ_CRYPT</span></a><span class='Operator'>: 
</span>            <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                      <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"Crypt authentication not supported\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../include/libpq/pqcomm.h.html#LN169"><span class='Ref_to_Const'>AUTH_REQ_MD5</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../include/libpq/pqcomm.h.html#LN167"><span class='Ref_to_Const'>AUTH_REQ_PASSWORD</span></a><span class='Operator'>: 
</span>            <span class='Delimiter'>{ 
</span><a name="LN947"></a>                <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>password</span><span class='Delimiter'>; 
</span> 
                <a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN407"><span class='Ref_to_Member'>password_needed</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <a href="fe-auth.c.html#LN947"><span class='Ref_To_Local'>password</span></a> <span class='Operator'>= </span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN396"><span class='Ref_to_Member'>connhost</span></a><span class='Delimiter'>[</span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN395"><span class='Ref_to_Member'>whichhost</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="libpq-int.h.html#LN310"><span class='Ref_to_Member'>password</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN947"><span class='Ref_To_Local'>password</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                    <a href="fe-auth.c.html#LN947"><span class='Ref_To_Local'>password</span></a> <span class='Operator'>= </span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN342"><span class='Ref_to_Member'>pgpass</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN947"><span class='Ref_To_Local'>password</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><a href="fe-auth.c.html#LN947"><span class='Ref_To_Local'>password</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                                      <a href="libpq-fe.h.html#LN511"><span class='Ref_to_Const'>PQnoPasswordSupplied</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN739"><span class='Ref_to_Func'>pg_password_sendauth</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN947"><span class='Ref_To_Local'>password</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>areq</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Parentheses'>)</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                     <span class='String'>"fe_sendauth: error sending password authentication\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
        <span class='Control'>case</span> <a href="../../include/libpq/pqcomm.h.html#LN174"><span class='Ref_to_Const'>AUTH_REQ_SASL</span></a><span class='Operator'>: 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * The request contains the name (as assigned by IANA) of the 
             * authentication mechanism. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN484"><span class='Ref_to_Func'>pg_SASL_init</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>payloadlen</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* pg_SASL_init already set the error message */ 
</span>                <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../include/libpq/pqcomm.h.html#LN175"><span class='Ref_to_Const'>AUTH_REQ_SASL_CONT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../include/libpq/pqcomm.h.html#LN176"><span class='Ref_to_Const'>AUTH_REQ_SASL_FIN</span></a><span class='Operator'>: 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN454"><span class='Ref_to_Member'>sasl_state</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                                  <span class='String'>"fe_sendauth: invalid authentication request from server: AUTH_REQ_SASL_CONT without AUTH_REQ_SASL\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN617"><span class='Ref_to_Func'>pg_SASL_continue</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>payloadlen</span></a><span class='Delimiter'>, 
</span>                                 <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>areq</span></a> <span class='Operator'>== </span><a href="../../include/libpq/pqcomm.h.html#LN176"><span class='Ref_to_Const'>AUTH_REQ_SASL_FIN</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Use error message, if set already */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Operator'>.</span><a href="pqexpbuffer.h.html#LN46"><span class='Ref_to_Member'>len</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                    <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                              <span class='String'>"fe_sendauth: error in SASL authentication\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../include/libpq/pqcomm.h.html#LN170"><span class='Ref_to_Const'>AUTH_REQ_SCM_CREDS</span></a><span class='Operator'>: 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN687"><span class='Ref_to_Func'>pg_local_sendauth</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Parentheses'>)</span> 
                <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>default</span><span class='Operator'>: 
</span>            <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>            <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"authentication method %u not supported\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN816"><span class='Ref_to_Parameter'>areq</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch areq &raquo; </span> 
 
    <span class='Control'>return</span> <a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pg_fe_sendauth &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * pg_fe_getauthname 
 * 
 * Returns a pointer to malloc'd space containing whatever name the user 
 * has authenticated to the system.  If there is an error, return NULL, 
 * and put a suitable error message in *errorMessage if that's not NULL. 
 */ 
</span><span class='Keyword'>char </span><span class='Operator'>* 
</span><a name="LN1023"></a><span class='Declare_Function'>pg_fe_getauthname</span><span class='Parentheses'>(</span><a href="pqexpbuffer.h.html#LN50"><span class='Ref_to_Typedef'>PQExpBuffer</span></a> <span class='Declare_Parameter'>errorMessage</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1025"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>result</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1026"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>name</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <span class='Comment_Multi_Line'>/* Microsoft recommends buffer size of UNLEN+1, where UNLEN = 256 */ 
</span><a name="LN1030"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>username</span><span class='Delimiter'>[</span><span class='Number'>256</span> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN1031"></a>    <span class='Keyword'>DWORD</span>       <span class='Declare_Local'>namesize</span> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1030"><span class='Ref_To_Local'>username</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
<a name="LN1033"></a>    <a href="../../include/port/win32.h.html#LN249"><span class='Ref_to_Typedef'>uid_t</span></a>       <span class='Declare_Local'>user_id</span> <span class='Operator'>= </span>geteuid<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><a name="LN1034"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>pwdbuf</span><span class='Delimiter'>[</span>BUFSIZ<span class='Delimiter'>]; 
</span><a name="LN1035"></a>    <span class='Control'>struct</span> passwd <span class='Declare_Local'>pwdstr</span><span class='Delimiter'>; 
</span><a name="LN1036"></a>    <span class='Control'>struct</span> passwd <span class='Operator'>*</span><span class='Declare_Local'>pw</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1037"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>pwerr</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Some users are using configure --enable-thread-safety-force, so we 
     * might as well do the locking within our library to protect 
     * pqGetpwuid(). In fact, application developers can use getpwuid() in 
     * their application if they use the locking call we provide, or install 
     * their own locking function using PQregisterThreadLock(). 
     */ 
</span>    <a href="libpq-int.h.html#LN558"><span class='Ref_to_Macro'>pglock_thread</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>GetUserName<span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1030"><span class='Ref_To_Local'>username</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fe-auth.c.html#LN1031"><span class='Ref_To_Local'>namesize</span></a><span class='Parentheses'>))</span> 
        <a href="fe-auth.c.html#LN1026"><span class='Ref_To_Local'>name</span></a> <span class='Operator'>= </span><a href="fe-auth.c.html#LN1030"><span class='Ref_To_Local'>username</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1023"><span class='Ref_to_Parameter'>errorMessage</span></a><span class='Parentheses'>) 
</span>        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1023"><span class='Ref_to_Parameter'>errorMessage</span></a><span class='Delimiter'>, 
</span>                 <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"user name lookup failure: error code %lu\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                          GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
    <a href="fe-auth.c.html#LN1037"><span class='Ref_To_Local'>pwerr</span></a> <span class='Operator'>= </span><a href="../../port/thread.c.html#LN93"><span class='Ref_to_Func'>pqGetpwuid</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1033"><span class='Ref_To_Local'>user_id</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fe-auth.c.html#LN1035"><span class='Ref_To_Local'>pwdstr</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN1034"><span class='Ref_To_Local'>pwdbuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1034"><span class='Ref_To_Local'>pwdbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fe-auth.c.html#LN1036"><span class='Ref_To_Local'>pw</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1036"><span class='Ref_To_Local'>pw</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="fe-auth.c.html#LN1026"><span class='Ref_To_Local'>name</span></a> <span class='Operator'>= </span><a href="fe-auth.c.html#LN1036"><span class='Ref_To_Local'>pw</span></a><span class='Operator'>-&GT;</span>pw_name<span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1023"><span class='Ref_to_Parameter'>errorMessage</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1037"><span class='Ref_To_Local'>pwerr</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1023"><span class='Ref_to_Parameter'>errorMessage</span></a><span class='Delimiter'>, 
</span>                   <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"could not look up local user ID %d: %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                              <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>)</span> <a href="fe-auth.c.html#LN1033"><span class='Ref_To_Local'>user_id</span></a><span class='Delimiter'>, 
</span>                              <a href="../../port/thread.c.html#LN59"><span class='Ref_to_Func'>pqStrerror</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1037"><span class='Ref_To_Local'>pwerr</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN1034"><span class='Ref_To_Local'>pwdbuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1034"><span class='Ref_To_Local'>pwdbuf</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1023"><span class='Ref_to_Parameter'>errorMessage</span></a><span class='Delimiter'>, 
</span>                     <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"local user with ID %d does not exist\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                              <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="fe-auth.c.html#LN1033"><span class='Ref_To_Local'>user_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1026"><span class='Ref_To_Local'>name</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="fe-auth.c.html#LN1025"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span>strdup<span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1026"><span class='Ref_To_Local'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1025"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="fe-auth.c.html#LN1023"><span class='Ref_to_Parameter'>errorMessage</span></a><span class='Parentheses'>) 
</span>            <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1023"><span class='Ref_to_Parameter'>errorMessage</span></a><span class='Delimiter'>, 
</span>                              <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="libpq-int.h.html#LN559"><span class='Ref_to_Macro'>pgunlock_thread</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="fe-auth.c.html#LN1025"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pg_fe_getauthname &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * PQencryptPassword -- exported routine to encrypt a password with MD5 
 * 
 * This function is equivalent to calling PQencryptPasswordConn with 
 * "md5" as the encryption method, except that this doesn't require 
 * a connection object.  This function is deprecated, use 
 * PQencryptPasswordConn instead. 
 */ 
</span><span class='Keyword'>char </span><span class='Operator'>* 
</span><a name="LN1097"></a><span class='Declare_Function'>PQencryptPassword</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>passwd</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>user</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1099"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>crypt_pwd</span><span class='Delimiter'>; 
</span> 
    <a href="fe-auth.c.html#LN1099"><span class='Ref_To_Local'>crypt_pwd</span></a> <span class='Operator'>= </span><a href="../../include/snowball/header.h.html#LN49"><span class='Ref_to_Macro'>malloc</span></a><span class='Parentheses'>(</span><a href="../../include/common/md5.h.html#LN18"><span class='Ref_to_Const'>MD5_PASSWD_LEN</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fe-auth.c.html#LN1099"><span class='Ref_To_Local'>crypt_pwd</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/common/md5.h.html#LN22"><span class='Ref_to_Proto'>pg_md5_encrypt</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1097"><span class='Ref_to_Parameter'>passwd</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN1097"><span class='Ref_to_Parameter'>user</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1097"><span class='Ref_to_Parameter'>user</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN1099"><span class='Ref_To_Local'>crypt_pwd</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1099"><span class='Ref_To_Local'>crypt_pwd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="fe-auth.c.html#LN1099"><span class='Ref_To_Local'>crypt_pwd</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * PQencryptPasswordConn -- exported routine to encrypt a password 
 * 
 * This is intended to be used by client applications that wish to send 
 * commands like ALTER USER joe PASSWORD 'pwd'.  The password need not 
 * be sent in cleartext if it is encrypted on the client side.  This is 
 * good because it ensures the cleartext password won't end up in logs, 
 * pg_stat displays, etc.  We export the function so that clients won't 
 * be dependent on low-level details like whether the encryption is MD5 
 * or something else. 
 * 
 * Arguments are a connection object, the cleartext password, the SQL 
 * name of the user it is for, and a string indicating the algorithm to 
 * use for encrypting the password.  If algorithm is NULL, this queries 
 * the server for the current 'password_encryption' value.  If you wish 
 * to avoid that, e.g. to avoid blocking, you can execute 
 * 'show password_encryption' yourself before calling this function, and 
 * pass it as the algorithm. 
 * 
 * Return value is a malloc'd string.  The client may assume the string 
 * doesn't contain any special characters that would require escaping. 
 * On error, an error message is stored in the connection object, and 
 * returns NULL. 
 */ 
</span><span class='Keyword'>char </span><span class='Operator'>* 
</span><a name="LN1139"></a><span class='Declare_Function'>PQencryptPasswordConn</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>passwd</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>user</span><span class='Delimiter'>, 
</span><a name="LN1140"></a>                      <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>algorithm</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1142"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MAX_ALGORITHM_NAME_LEN</span> <span class='Number'>50</span> 
<a name="LN1143"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>algobuf</span><span class='Delimiter'>[</span><a href="fe-auth.c.html#LN1142"><span class='Ref_to_Const'>MAX_ALGORITHM_NAME_LEN</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN1144"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>crypt_pwd</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fe-auth.c.html#LN1139"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If no algorithm was given, ask the server. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1140"><span class='Ref_to_Parameter'>algorithm</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1152"></a>        <a href="libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span><a name="LN1153"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>val</span><span class='Delimiter'>; 
</span> 
        <a href="fe-auth.c.html#LN1152"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="libpq-fe.h.html#LN380"><span class='Ref_to_Proto'>PQexec</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1139"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><span class='String'>"show password_encryption"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1152"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* PQexec() should've set conn-&GT;errorMessage already */ 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1152"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="libpq-fe.h.html#LN87"><span class='Ref_to_EnumConst'>PGRES_TUPLES_OK</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* PQexec() should've set conn-&GT;errorMessage already */ 
</span>            <a href="libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1152"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN473"><span class='Ref_to_Proto'>PQntuples</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1152"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span> <span class='Operator'>|| </span><a href="libpq-fe.h.html#LN474"><span class='Ref_to_Proto'>PQnfields</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1152"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1152"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN1139"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                              <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"unexpected shape of result set returned for SHOW\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="fe-auth.c.html#LN1153"><span class='Ref_To_Local'>val</span></a> <span class='Operator'>= </span><a href="libpq-fe.h.html#LN488"><span class='Ref_to_Proto'>PQgetvalue</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1152"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1153"><span class='Ref_To_Local'>val</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><a href="fe-auth.c.html#LN1142"><span class='Ref_to_Const'>MAX_ALGORITHM_NAME_LEN</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1152"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN1139"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                      <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"password_encryption value too long\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../../contrib/cube/cubeparse.y.html#LN150"><span class='Ref_to_Proto'>strcpy</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1143"><span class='Ref_To_Local'>algobuf</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN1153"><span class='Ref_To_Local'>val</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1152"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="fe-auth.c.html#LN1140"><span class='Ref_to_Parameter'>algorithm</span></a> <span class='Operator'>= </span><a href="fe-auth.c.html#LN1143"><span class='Ref_To_Local'>algobuf</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if algorithm==NULL &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Also accept "on" and "off" as aliases for "md5", because 
     * password_encryption was a boolean before PostgreSQL 10.  We refuse to 
     * send the password in plaintext even if it was "off". 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1140"><span class='Ref_to_Parameter'>algorithm</span></a><span class='Delimiter'>, </span><span class='String'>"on"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>        strcmp<span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1140"><span class='Ref_to_Parameter'>algorithm</span></a><span class='Delimiter'>, </span><span class='String'>"off"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="fe-auth.c.html#LN1140"><span class='Ref_to_Parameter'>algorithm</span></a> <span class='Operator'>= </span><span class='String'>"md5"</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Ok, now we know what algorithm to use 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1140"><span class='Ref_to_Parameter'>algorithm</span></a><span class='Delimiter'>, </span><span class='String'>"scram-sha-256"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="fe-auth.c.html#LN1144"><span class='Ref_To_Local'>crypt_pwd</span></a> <span class='Operator'>= </span><a href="fe-auth.h.html#LN30"><span class='Ref_to_Proto'>pg_fe_scram_build_verifier</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1139"><span class='Ref_to_Parameter'>passwd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1140"><span class='Ref_to_Parameter'>algorithm</span></a><span class='Delimiter'>, </span><span class='String'>"md5"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="fe-auth.c.html#LN1144"><span class='Ref_To_Local'>crypt_pwd</span></a> <span class='Operator'>= </span><a href="../../include/snowball/header.h.html#LN49"><span class='Ref_to_Macro'>malloc</span></a><span class='Parentheses'>(</span><a href="../../include/common/md5.h.html#LN18"><span class='Ref_to_Const'>MD5_PASSWD_LEN</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1144"><span class='Ref_To_Local'>crypt_pwd</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/common/md5.h.html#LN22"><span class='Ref_to_Proto'>pg_md5_encrypt</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1139"><span class='Ref_to_Parameter'>passwd</span></a><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN1139"><span class='Ref_to_Parameter'>user</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1139"><span class='Ref_to_Parameter'>user</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="fe-auth.c.html#LN1144"><span class='Ref_To_Local'>crypt_pwd</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-auth.c.html#LN1144"><span class='Ref_To_Local'>crypt_pwd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="fe-auth.c.html#LN1144"><span class='Ref_To_Local'>crypt_pwd</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN1139"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>        <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"unrecognized password encryption algorithm \"%s\"\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                          <a href="fe-auth.c.html#LN1140"><span class='Ref_to_Parameter'>algorithm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fe-auth.c.html#LN1144"><span class='Ref_To_Local'>crypt_pwd</span></a><span class='Parentheses'>) 
</span>        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-auth.c.html#LN1139"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                          <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="fe-auth.c.html#LN1144"><span class='Ref_To_Local'>crypt_pwd</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PQencryptPasswordConn &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>