<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\interfaces\libpq\fe-secure-openssl.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\interfaces\libpq\fe-secure-openssl.c</b></p></td>
<td align='right'>
Wed Jun 14 08:26:11 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * fe-secure-openssl.c 
 *    OpenSSL support 
 * 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/interfaces/libpq/fe-secure-openssl.c 
 * 
 * NOTES 
 * 
 *    We don't provide informational callbacks here (like 
 *    info_cb() in be-secure.c), since there's no good mechanism to 
 *    display such information to the user. 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres_fe.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;signal.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;fcntl.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;ctype.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"libpq-fe.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"fe-auth.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"libpq-int.h"</span> 
 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<span class='Keyword'>#include </span><span class='String'>"win32.h"</span> 
<span class='Directive'>#else</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/socket.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;netdb.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;netinet/in.h&GT;</span> 
<span class='Directive'>#ifdef</span> HAVE_NETINET_TCP_H 
<span class='Keyword'>#include </span><span class='String'>&LT;netinet/tcp.h&GT;</span> 
<span class='Directive'>#endif</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;arpa/inet.h&GT;</span> 
<span class='Directive'>#endif</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/stat.h&GT;</span> 
 
<span class='Directive'>#ifdef</span> ENABLE_THREAD_SAFETY 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<span class='Keyword'>#include </span><span class='String'>"pthread-win32.h"</span> 
<span class='Directive'>#else</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;pthread.h&GT;</span> 
<span class='Directive'>#endif</span> 
<span class='Directive'>#endif</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;openssl/ssl.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;openssl/conf.h&GT;</span> 
<span class='Directive'>#ifdef</span> <a href="libpq-int.h.html#LN78"><span class='Ref_to_Const'>USE_SSL_ENGINE</span></a> 
<span class='Keyword'>#include </span><span class='String'>&LT;openssl/engine.h&GT;</span> 
<span class='Directive'>#endif</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;openssl/x509v3.h&GT;</span> 
 
<a name="LN62"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>verify_peer_name_matches_certificate</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>PGconn</span> <span class='Operator'>*</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN63"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>verify_cb</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>ok</span><span class='Delimiter'>, </span>X509_STORE_CTX <span class='Operator'>*</span><span class='Declare_Parameter'>ctx</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN64"></a><span class='Keyword'>static int </span><span class='Declare_Prototype'>verify_peer_name_matches_certificate_name</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, 
</span><a name="LN65"></a>                                          ASN1_STRING <span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Delimiter'>, 
</span><a name="LN66"></a>                                          <span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>store_name</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN67"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>destroy_ssl_system</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN68"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>initialize_SSL</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN69"></a><span class='Keyword'>static </span><a href="libpq-fe.h.html#LN71"><span class='Ref_to_Typedef'>PostgresPollingStatusType</span></a> <span class='Declare_Prototype'>open_client_SSL</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>PGconn</span> <span class='Operator'>*</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN70"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Prototype'>SSLerrmessage</span><span class='Parentheses'>(</span><span class='Keyword'>unsigned long </span><span class='Declare_Parameter'>ecode</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN71"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>SSLerrfree</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>buf</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN73"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>my_sock_read</span><span class='Parentheses'>(</span>BIO <span class='Operator'>*</span><span class='Declare_Parameter'>h</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>size</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN74"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>my_sock_write</span><span class='Parentheses'>(</span>BIO <span class='Operator'>*</span><span class='Declare_Parameter'>h</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>size</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN75"></a><span class='Keyword'>static </span>BIO_METHOD <span class='Operator'>*</span><span class='Declare_Prototype'>my_BIO_s_socket</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN76"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>my_SSL_set_fd</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>fd</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<a name="LN79"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>pq_init_ssl_lib</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span><a name="LN80"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>pq_init_crypto_lib</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
<a name="LN82"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>ssl_lib_initialized</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> ENABLE_THREAD_SAFETY 
<a name="LN85"></a><span class='Keyword'>static long </span><span class='Declare_Var'>ssl_open_connections</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN88"></a><span class='Keyword'>static </span><a href="../ecpg/include/ecpg-pthread-win32.h.html#LN14"><span class='Ref_to_Struct'>pthread_mutex_t</span></a> <span class='Declare_Var'>ssl_config_mutex</span> <span class='Operator'>= </span><a href="../ecpg/include/ecpg-pthread-win32.h.html#LN23"><span class='Ref_to_Const'>PTHREAD_MUTEX_INITIALIZER</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
<a name="LN90"></a><span class='Keyword'>static </span><a href="../ecpg/include/ecpg-pthread-win32.h.html#LN14"><span class='Ref_to_Struct'>pthread_mutex_t</span></a> <span class='Declare_Var'>ssl_config_mutex</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN91"></a><span class='Keyword'>static long </span><span class='Declare_Var'>win32_ssl_create_mutex</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* ENABLE_THREAD_SAFETY */ 
</span> 
 
<span class='Comment_Multi_Line'>/* ------------------------------------------------------------ */ 
/*           Procedures common to all secure sessions           */ 
/* ------------------------------------------------------------ */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  Exported function to allow application to tell us it's already 
 *  initialized OpenSSL and/or libcrypto. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN105"></a><span class='Declare_Function'>pgtls_init_library</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>do_ssl</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>do_crypto</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> ENABLE_THREAD_SAFETY 
 
    <span class='Comment_Multi_Line'>/* 
     * Disallow changing the flags while we have open connections, else we'd 
     * get completely confused. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN85"><span class='Ref_to_Global_Var'>ssl_open_connections</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <a href="fe-secure-openssl.c.html#LN79"><span class='Ref_to_Global_Var'>pq_init_ssl_lib</span></a> <span class='Operator'>= </span><a href="fe-secure-openssl.c.html#LN105"><span class='Ref_to_Parameter'>do_ssl</span></a><span class='Delimiter'>; 
</span>    <a href="fe-secure-openssl.c.html#LN80"><span class='Ref_to_Global_Var'>pq_init_crypto_lib</span></a> <span class='Operator'>= </span><a href="fe-secure-openssl.c.html#LN105"><span class='Ref_to_Parameter'>do_crypto</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  Begin or continue negotiating a secure session. 
 */ 
</span><a href="libpq-fe.h.html#LN71"><span class='Ref_to_Typedef'>PostgresPollingStatusType</span></a> 
<a name="LN125"></a><span class='Declare_Function'>pgtls_open_client</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* First time through? */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN125"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN462"><span class='Ref_to_Member'>ssl</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Create a connection-specific SSL object, and load client 
         * certificate, private key, and trusted CA certs. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN68"><span class='Ref_to_Proto'>initialize_SSL</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN125"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* initialize_SSL already put a message in conn-&GT;errorMessage */ 
</span>            <a href="libpq-int.h.html#LN667"><span class='Ref_to_Proto'>pgtls_close</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN125"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="libpq-fe.h.html#LN73"><span class='Ref_to_EnumConst'>PGRES_POLLING_FAILED</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Begin or continue the actual handshake */ 
</span>    <span class='Control'>return</span> <a href="fe-secure-openssl.c.html#LN69"><span class='Ref_to_Proto'>open_client_SSL</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN125"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgtls_open_client &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  Is there unread data waiting in the SSL read buffer? 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN150"></a><span class='Declare_Function'>pgtls_read_pending</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> SSL_pending<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN150"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN462"><span class='Ref_to_Member'>ssl</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  Read data from a secure connection. 
 * 
 * On failure, this function is responsible for putting a suitable message 
 * into conn-&GT;errorMessage.  The caller must still inspect errno, but only 
 * to determine whether to continue/retry after error. 
 */ 
</span><a href="../../include/port/win32.h.html#LN419"><span class='Ref_to_Typedef'>ssize_t</span></a> 
<a name="LN163"></a><span class='Declare_Function'>pgtls_read</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>ptr</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN165"></a>    <a href="../../include/port/win32.h.html#LN419"><span class='Ref_to_Typedef'>ssize_t</span></a>     <span class='Declare_Local'>n</span><span class='Delimiter'>; 
</span><a name="LN166"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>result_errno</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN167"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>sebuf</span><span class='Delimiter'>[</span><span class='Number'>256</span><span class='Delimiter'>]; 
</span><a name="LN168"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>err</span><span class='Delimiter'>; 
</span><a name="LN169"></a>    <span class='Keyword'>unsigned long </span><span class='Declare_Local'>ecode</span><span class='Delimiter'>; 
</span> 
<a name="LN171"></a><span class='Label'>rloop</span><span class='Operator'>: 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Prepare to call SSL_get_error() by clearing thread's OpenSSL error 
     * queue.  In general, the current thread's error queue must be empty 
     * before the TLS/SSL I/O operation is attempted, or SSL_get_error() will 
     * not work reliably.  Since the possibility exists that other OpenSSL 
     * clients running in the same thread but not under our control will fail 
     * to call ERR_get_error() themselves (after their own I/O operations), 
     * pro-actively clear the per-thread error queue now. 
     */ 
</span>    <a href="libpq-int.h.html#LN693"><span class='Ref_to_Macro'>SOCK_ERRNO_SET</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    ERR_clear_error<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="fe-secure-openssl.c.html#LN165"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= </span>SSL_read<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN163"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN462"><span class='Ref_to_Member'>ssl</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN163"><span class='Ref_to_Parameter'>ptr</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN163"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="fe-secure-openssl.c.html#LN168"><span class='Ref_To_Local'>err</span></a> <span class='Operator'>= </span>SSL_get_error<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN163"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN462"><span class='Ref_to_Member'>ssl</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN165"><span class='Ref_To_Local'>n</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Other clients of OpenSSL may fail to call ERR_get_error(), but we 
     * always do, so as to not cause problems for OpenSSL clients that don't 
     * call ERR_clear_error() defensively.  Be sure that this happens by 
     * calling now.  SSL_get_error() relies on the OpenSSL per-thread error 
     * queue being intact, so this is the earliest possible point 
     * ERR_get_error() may be called. 
     */ 
</span>    <a href="fe-secure-openssl.c.html#LN169"><span class='Ref_To_Local'>ecode</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN168"><span class='Ref_To_Local'>err</span></a> <span class='Operator'>!= </span>SSL_ERROR_NONE <span class='Operator'>|| </span><a href="fe-secure-openssl.c.html#LN165"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>? </span>ERR_get_error<span class='Parentheses'>() </span><span class='Operator'>: </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN168"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> SSL_ERROR_NONE<span class='Operator'>: 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN165"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Not supposed to happen, so we don't translate the msg */ 
</span>                <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN163"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                  <span class='String'>"SSL_read failed but did not provide error information\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* assume the connection is broken */ 
</span>                <a href="fe-secure-openssl.c.html#LN166"><span class='Ref_To_Local'>result_errno</span></a> <span class='Operator'>= </span><a href="win32.h.html#LN22"><span class='Ref_to_Const'>ECONNRESET</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> SSL_ERROR_WANT_READ<span class='Operator'>: 
</span>            <a href="fe-secure-openssl.c.html#LN165"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> SSL_ERROR_WANT_WRITE<span class='Operator'>: 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Returning 0 here would cause caller to wait for read-ready, 
             * which is not correct since what SSL wants is wait for 
             * write-ready.  The former could get us stuck in an infinite 
             * wait, so don't risk it; busy-loop instead. 
             */ 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="fe-secure-openssl.c.html#LN171"><span class='Ref_to_Label'>rloop</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> SSL_ERROR_SYSCALL<span class='Operator'>: 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN165"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="fe-secure-openssl.c.html#LN166"><span class='Ref_To_Local'>result_errno</span></a> <span class='Operator'>= </span><a href="libpq-int.h.html#LN691"><span class='Ref_to_Const'>SOCK_ERRNO</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN166"><span class='Ref_To_Local'>result_errno</span></a> <span class='Operator'>== </span>EPIPE <span class='Operator'>|| 
</span>                    <a href="fe-secure-openssl.c.html#LN166"><span class='Ref_To_Local'>result_errno</span></a> <span class='Operator'>== </span><a href="win32.h.html#LN22"><span class='Ref_to_Const'>ECONNRESET</span></a><span class='Parentheses'>) 
</span>                    <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN163"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                                      <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>( 
</span>                                <span class='String'>"server closed the connection unexpectedly\n"</span> 
                    <span class='String'>"\tThis probably means the server terminated abnormally\n"</span> 
                             <span class='String'>"\tbefore or while processing the request.\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                    <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN163"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                                    <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"SSL SYSCALL error: %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                      <a href="libpq-int.h.html#LN692"><span class='Ref_to_Const'>SOCK_STRERROR</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN166"><span class='Ref_To_Local'>result_errno</span></a><span class='Delimiter'>, 
</span>                                                    <a href="fe-secure-openssl.c.html#LN167"><span class='Ref_To_Local'>sebuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN167"><span class='Ref_To_Local'>sebuf</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN163"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                         <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"SSL SYSCALL error: EOF detected\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* assume the connection is broken */ 
</span>                <a href="fe-secure-openssl.c.html#LN166"><span class='Ref_To_Local'>result_errno</span></a> <span class='Operator'>= </span><a href="win32.h.html#LN22"><span class='Ref_to_Const'>ECONNRESET</span></a><span class='Delimiter'>; 
</span>                <a href="fe-secure-openssl.c.html#LN165"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> SSL_ERROR_SSL<span class='Operator'>: 
</span>            <span class='Delimiter'>{ 
</span><a name="LN248"></a>                <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>errm</span> <span class='Operator'>= </span><a href="fe-secure-openssl.c.html#LN70"><span class='Ref_to_Proto'>SSLerrmessage</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN169"><span class='Ref_To_Local'>ecode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN163"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                                  <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"SSL error: %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN248"><span class='Ref_To_Local'>errm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="fe-secure-openssl.c.html#LN71"><span class='Ref_to_Proto'>SSLerrfree</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN248"><span class='Ref_To_Local'>errm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* assume the connection is broken */ 
</span>                <a href="fe-secure-openssl.c.html#LN166"><span class='Ref_To_Local'>result_errno</span></a> <span class='Operator'>= </span><a href="win32.h.html#LN22"><span class='Ref_to_Const'>ECONNRESET</span></a><span class='Delimiter'>; 
</span>                <a href="fe-secure-openssl.c.html#LN165"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Control'>case</span> SSL_ERROR_ZERO_RETURN<span class='Operator'>: 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Per OpenSSL documentation, this error code is only returned for 
             * a clean connection closure, so we should not report it as a 
             * server crash. 
             */ 
</span>            <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN163"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>             <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"SSL connection has been closed unexpectedly\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="fe-secure-openssl.c.html#LN166"><span class='Ref_To_Local'>result_errno</span></a> <span class='Operator'>= </span><a href="win32.h.html#LN22"><span class='Ref_to_Const'>ECONNRESET</span></a><span class='Delimiter'>; 
</span>            <a href="fe-secure-openssl.c.html#LN165"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>default</span><span class='Operator'>: 
</span>            <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN163"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                          <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"unrecognized SSL error code: %d\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                              <a href="fe-secure-openssl.c.html#LN168"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* assume the connection is broken */ 
</span>            <a href="fe-secure-openssl.c.html#LN166"><span class='Ref_To_Local'>result_errno</span></a> <span class='Operator'>= </span><a href="win32.h.html#LN22"><span class='Ref_to_Const'>ECONNRESET</span></a><span class='Delimiter'>; 
</span>            <a href="fe-secure-openssl.c.html#LN165"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch err &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* ensure we return the intended errno to caller */ 
</span>    <a href="libpq-int.h.html#LN693"><span class='Ref_to_Macro'>SOCK_ERRNO_SET</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN166"><span class='Ref_To_Local'>result_errno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="fe-secure-openssl.c.html#LN165"><span class='Ref_To_Local'>n</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgtls_read &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  Write data to a secure connection. 
 * 
 * On failure, this function is responsible for putting a suitable message 
 * into conn-&GT;errorMessage.  The caller must still inspect errno, but only 
 * to determine whether to continue/retry after error. 
 */ 
</span><a href="../../include/port/win32.h.html#LN419"><span class='Ref_to_Typedef'>ssize_t</span></a> 
<a name="LN294"></a><span class='Declare_Function'>pgtls_write</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>ptr</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN296"></a>    <a href="../../include/port/win32.h.html#LN419"><span class='Ref_to_Typedef'>ssize_t</span></a>     <span class='Declare_Local'>n</span><span class='Delimiter'>; 
</span><a name="LN297"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>result_errno</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN298"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>sebuf</span><span class='Delimiter'>[</span><span class='Number'>256</span><span class='Delimiter'>]; 
</span><a name="LN299"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>err</span><span class='Delimiter'>; 
</span><a name="LN300"></a>    <span class='Keyword'>unsigned long </span><span class='Declare_Local'>ecode</span><span class='Delimiter'>; 
</span> 
    <a href="libpq-int.h.html#LN693"><span class='Ref_to_Macro'>SOCK_ERRNO_SET</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    ERR_clear_error<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="fe-secure-openssl.c.html#LN296"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= </span>SSL_write<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN294"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN462"><span class='Ref_to_Member'>ssl</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN294"><span class='Ref_to_Parameter'>ptr</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN294"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="fe-secure-openssl.c.html#LN299"><span class='Ref_To_Local'>err</span></a> <span class='Operator'>= </span>SSL_get_error<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN294"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN462"><span class='Ref_to_Member'>ssl</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN296"><span class='Ref_To_Local'>n</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="fe-secure-openssl.c.html#LN300"><span class='Ref_To_Local'>ecode</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN299"><span class='Ref_To_Local'>err</span></a> <span class='Operator'>!= </span>SSL_ERROR_NONE <span class='Operator'>|| </span><a href="fe-secure-openssl.c.html#LN296"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>? </span>ERR_get_error<span class='Parentheses'>() </span><span class='Operator'>: </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN299"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> SSL_ERROR_NONE<span class='Operator'>: 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN296"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Not supposed to happen, so we don't translate the msg */ 
</span>                <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN294"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                 <span class='String'>"SSL_write failed but did not provide error information\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* assume the connection is broken */ 
</span>                <a href="fe-secure-openssl.c.html#LN297"><span class='Ref_To_Local'>result_errno</span></a> <span class='Operator'>= </span><a href="win32.h.html#LN22"><span class='Ref_to_Const'>ECONNRESET</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> SSL_ERROR_WANT_READ<span class='Operator'>: 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Returning 0 here causes caller to wait for write-ready, which 
             * is not really the right thing, but it's the best we can do. 
             */ 
</span>            <a href="fe-secure-openssl.c.html#LN296"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> SSL_ERROR_WANT_WRITE<span class='Operator'>: 
</span>            <a href="fe-secure-openssl.c.html#LN296"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> SSL_ERROR_SYSCALL<span class='Operator'>: 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN296"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="fe-secure-openssl.c.html#LN297"><span class='Ref_To_Local'>result_errno</span></a> <span class='Operator'>= </span><a href="libpq-int.h.html#LN691"><span class='Ref_to_Const'>SOCK_ERRNO</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN297"><span class='Ref_To_Local'>result_errno</span></a> <span class='Operator'>== </span>EPIPE <span class='Operator'>|| </span><a href="fe-secure-openssl.c.html#LN297"><span class='Ref_To_Local'>result_errno</span></a> <span class='Operator'>== </span><a href="win32.h.html#LN22"><span class='Ref_to_Const'>ECONNRESET</span></a><span class='Parentheses'>) 
</span>                    <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN294"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                                      <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>( 
</span>                                <span class='String'>"server closed the connection unexpectedly\n"</span> 
                    <span class='String'>"\tThis probably means the server terminated abnormally\n"</span> 
                             <span class='String'>"\tbefore or while processing the request.\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                    <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN294"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                                    <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"SSL SYSCALL error: %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                      <a href="libpq-int.h.html#LN692"><span class='Ref_to_Const'>SOCK_STRERROR</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN297"><span class='Ref_To_Local'>result_errno</span></a><span class='Delimiter'>, 
</span>                                                    <a href="fe-secure-openssl.c.html#LN298"><span class='Ref_To_Local'>sebuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN298"><span class='Ref_To_Local'>sebuf</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN294"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                         <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"SSL SYSCALL error: EOF detected\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* assume the connection is broken */ 
</span>                <a href="fe-secure-openssl.c.html#LN297"><span class='Ref_To_Local'>result_errno</span></a> <span class='Operator'>= </span><a href="win32.h.html#LN22"><span class='Ref_to_Const'>ECONNRESET</span></a><span class='Delimiter'>; 
</span>                <a href="fe-secure-openssl.c.html#LN296"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> SSL_ERROR_SSL<span class='Operator'>: 
</span>            <span class='Delimiter'>{ 
</span><a name="LN357"></a>                <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>errm</span> <span class='Operator'>= </span><a href="fe-secure-openssl.c.html#LN70"><span class='Ref_to_Proto'>SSLerrmessage</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN300"><span class='Ref_To_Local'>ecode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN294"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                                  <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"SSL error: %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN357"><span class='Ref_To_Local'>errm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="fe-secure-openssl.c.html#LN71"><span class='Ref_to_Proto'>SSLerrfree</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN357"><span class='Ref_To_Local'>errm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* assume the connection is broken */ 
</span>                <a href="fe-secure-openssl.c.html#LN297"><span class='Ref_To_Local'>result_errno</span></a> <span class='Operator'>= </span><a href="win32.h.html#LN22"><span class='Ref_to_Const'>ECONNRESET</span></a><span class='Delimiter'>; 
</span>                <a href="fe-secure-openssl.c.html#LN296"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Control'>case</span> SSL_ERROR_ZERO_RETURN<span class='Operator'>: 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Per OpenSSL documentation, this error code is only returned for 
             * a clean connection closure, so we should not report it as a 
             * server crash. 
             */ 
</span>            <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN294"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>             <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"SSL connection has been closed unexpectedly\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="fe-secure-openssl.c.html#LN297"><span class='Ref_To_Local'>result_errno</span></a> <span class='Operator'>= </span><a href="win32.h.html#LN22"><span class='Ref_to_Const'>ECONNRESET</span></a><span class='Delimiter'>; 
</span>            <a href="fe-secure-openssl.c.html#LN296"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>default</span><span class='Operator'>: 
</span>            <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN294"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                          <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"unrecognized SSL error code: %d\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                              <a href="fe-secure-openssl.c.html#LN299"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* assume the connection is broken */ 
</span>            <a href="fe-secure-openssl.c.html#LN297"><span class='Ref_To_Local'>result_errno</span></a> <span class='Operator'>= </span><a href="win32.h.html#LN22"><span class='Ref_to_Const'>ECONNRESET</span></a><span class='Delimiter'>; 
</span>            <a href="fe-secure-openssl.c.html#LN296"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch err &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* ensure we return the intended errno to caller */ 
</span>    <a href="libpq-int.h.html#LN693"><span class='Ref_to_Macro'>SOCK_ERRNO_SET</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN297"><span class='Ref_To_Local'>result_errno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="fe-secure-openssl.c.html#LN296"><span class='Ref_To_Local'>n</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgtls_write &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ------------------------------------------------------------ */ 
/*                      OpenSSL specific code                   */ 
/* ------------------------------------------------------------ */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  Certificate verification callback 
 * 
 *  This callback allows us to log intermediate problems during 
 *  verification, but there doesn't seem to be a clean way to get 
 *  our PGconn * structure.  So we can't log anything! 
 * 
 *  This callback also allows us to override the default acceptance 
 *  criteria (e.g., accepting self-signed or expired certs), but 
 *  for now we accept the default checks. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN411"></a><span class='Declare_Function'>verify_cb</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>ok</span><span class='Delimiter'>, </span>X509_STORE_CTX <span class='Operator'>*</span><span class='Declare_Parameter'>ctx</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="fe-secure-openssl.c.html#LN411"><span class='Ref_to_Parameter'>ok</span></a><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Check if a wildcard certificate matches the server hostname. 
 * 
 * The rule for this is: 
 *  1. We only match the '*' character as wildcard 
 *  2. We match only wildcards at the start of the string 
 *  3. The '*' character does *not* match '.', meaning that we match only 
 *     a single pathname component. 
 *  4. We don't support more than one '*' in a single pattern. 
 * 
 * This is roughly in line with RFC2818, but contrary to what most browsers 
 * appear to be implementing (point 3 being the difference) 
 * 
 * Matching is always case-insensitive, since DNS is case insensitive. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN433"></a><span class='Declare_Function'>wildcard_certificate_match</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>pattern</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>string</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN435"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>lenpat</span> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN433"><span class='Ref_to_Parameter'>pattern</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN436"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>lenstr</span> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN433"><span class='Ref_to_Parameter'>string</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If we don't start with a wildcard, it's not a match (rule 1 & 2) */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN435"><span class='Ref_To_Local'>lenpat</span></a> <span class='Operator'>&LT; </span><span class='Number'>3</span> <span class='Operator'>|| 
</span>        <a href="fe-secure-openssl.c.html#LN433"><span class='Ref_to_Parameter'>pattern</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='String'>'*'</span> <span class='Operator'>|| 
</span>        <a href="fe-secure-openssl.c.html#LN433"><span class='Ref_to_Parameter'>pattern</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='String'>'.'</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN435"><span class='Ref_To_Local'>lenpat</span></a> <span class='Operator'>&GT; </span><a href="fe-secure-openssl.c.html#LN436"><span class='Ref_To_Local'>lenstr</span></a><span class='Parentheses'>) 
</span>        <span class='Comment_Multi_Line'>/* If pattern is longer than the string, we can never match */ 
</span>        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../port/pgstrcasecmp.c.html#LN34"><span class='Ref_to_Func'>pg_strcasecmp</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN433"><span class='Ref_to_Parameter'>pattern</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN433"><span class='Ref_to_Parameter'>string</span></a> <span class='Operator'>+ </span><a href="fe-secure-openssl.c.html#LN436"><span class='Ref_To_Local'>lenstr</span></a> <span class='Operator'>- </span><a href="fe-secure-openssl.c.html#LN435"><span class='Ref_To_Local'>lenpat</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
 
        <span class='Comment_Multi_Line'>/* 
         * If string does not end in pattern (minus the wildcard), we don't 
         * match 
         */ 
</span>        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>strchr<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN433"><span class='Ref_to_Parameter'>string</span></a><span class='Delimiter'>, </span><span class='String'>'.'</span><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><a href="fe-secure-openssl.c.html#LN433"><span class='Ref_to_Parameter'>string</span></a> <span class='Operator'>+ </span><a href="fe-secure-openssl.c.html#LN436"><span class='Ref_To_Local'>lenstr</span></a> <span class='Operator'>- </span><a href="fe-secure-openssl.c.html#LN435"><span class='Ref_To_Local'>lenpat</span></a><span class='Parentheses'>)</span> 
 
        <span class='Comment_Multi_Line'>/* 
         * If there is a dot left of where the pattern started to match, we 
         * don't match (rule 3) 
         */ 
</span>        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* String ended with pattern, and didn't have a dot before, so we match */ 
</span>    <span class='Control'>return</span> <span class='Number'>1</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end wildcard_certificate_match &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Check if a name from a server's certificate matches the peer's hostname. 
 * 
 * Returns 1 if the name matches, and 0 if it does not. On error, returns 
 * -1, and sets the libpq error message. 
 * 
 * The name extracted from the certificate is returned in *store_name. The 
 * caller is responsible for freeing it. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN478"></a><span class='Declare_Function'>verify_peer_name_matches_certificate_name</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span>ASN1_STRING <span class='Operator'>*</span><span class='Declare_Parameter'>name_entry</span><span class='Delimiter'>, 
</span><a name="LN479"></a>                                          <span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>store_name</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN481"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span><a name="LN482"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>name</span><span class='Delimiter'>; 
</span><a name="LN483"></a>    <span class='Keyword'>const unsigned char </span><span class='Operator'>*</span><span class='Declare_Local'>namedata</span><span class='Delimiter'>; 
</span><a name="LN484"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN485"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>host</span> <span class='Operator'>= </span><a href="libpq-fe.h.html#LN313"><span class='Ref_to_Proto'>PQhost</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN478"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="fe-secure-openssl.c.html#LN479"><span class='Ref_to_Parameter'>store_name</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Should not happen... */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN478"><span class='Ref_to_Parameter'>name_entry</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN478"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                 <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"SSL certificate's name entry is missing\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * GEN_DNS can be only IA5String, equivalent to US ASCII. 
     * 
     * There is no guarantee the string returned from the certificate is 
     * NULL-terminated, so make a copy that is. 
     */ 
</span><span class='Directive'>#ifdef</span> HAVE_ASN1_STRING_GET0_DATA 
    <a href="fe-secure-openssl.c.html#LN483"><span class='Ref_To_Local'>namedata</span></a> <span class='Operator'>= </span>ASN1_STRING_get0_data<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN478"><span class='Ref_to_Parameter'>name_entry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
    <a href="fe-secure-openssl.c.html#LN483"><span class='Ref_To_Local'>namedata</span></a> <span class='Operator'>= </span>ASN1_STRING_data<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN478"><span class='Ref_to_Parameter'>name_entry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <a href="fe-secure-openssl.c.html#LN481"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span>ASN1_STRING_length<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN478"><span class='Ref_to_Parameter'>name_entry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="fe-secure-openssl.c.html#LN482"><span class='Ref_To_Local'>name</span></a> <span class='Operator'>= </span><a href="../../include/snowball/header.h.html#LN49"><span class='Ref_to_Macro'>malloc</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN481"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN482"><span class='Ref_To_Local'>name</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN478"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                          <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    memcpy<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN482"><span class='Ref_To_Local'>name</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN483"><span class='Ref_To_Local'>namedata</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN481"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="fe-secure-openssl.c.html#LN482"><span class='Ref_To_Local'>name</span></a><span class='Delimiter'>[</span><a href="fe-secure-openssl.c.html#LN481"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Reject embedded NULLs in certificate common or alternative name to 
     * prevent attacks like CVE-2009-4034. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN481"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>!= </span>strlen<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN482"><span class='Ref_To_Local'>name</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN482"><span class='Ref_To_Local'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN478"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>           <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"SSL certificate's name contains embedded null\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../port/pgstrcasecmp.c.html#LN34"><span class='Ref_to_Func'>pg_strcasecmp</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN482"><span class='Ref_To_Local'>name</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN485"><span class='Ref_To_Local'>host</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Exact name match */ 
</span>        <a href="fe-secure-openssl.c.html#LN484"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN432"><span class='Ref_to_Func'>wildcard_certificate_match</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN482"><span class='Ref_To_Local'>name</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN485"><span class='Ref_To_Local'>host</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Matched wildcard name */ 
</span>        <a href="fe-secure-openssl.c.html#LN484"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="fe-secure-openssl.c.html#LN484"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Operator'>*</span><a href="fe-secure-openssl.c.html#LN479"><span class='Ref_to_Parameter'>store_name</span></a> <span class='Operator'>= </span><a href="fe-secure-openssl.c.html#LN482"><span class='Ref_To_Local'>name</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="fe-secure-openssl.c.html#LN484"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end verify_peer_name_matches_certificate_name &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  Verify that the server certificate matches the hostname we connected to. 
 * 
 * The certificate's Common Name and Subject Alternative Names are considered. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN556"></a><span class='Declare_Function'>verify_peer_name_matches_certificate</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN558"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>names_examined</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN559"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found_match</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN560"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>got_error</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN561"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>first_name</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<a name="LN563"></a>    STACK_OF<span class='Parentheses'>(</span>GENERAL_NAME<span class='Parentheses'>) </span><span class='Operator'>*</span><span class='Declare_Local'>peer_san</span><span class='Delimiter'>; 
</span><a name="LN564"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN565"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>rc</span><span class='Delimiter'>; 
</span><a name="LN566"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>host</span> <span class='Operator'>= </span><a href="libpq-fe.h.html#LN313"><span class='Ref_to_Proto'>PQhost</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN556"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If told not to verify the peer name, don't do it. Return true 
     * indicating that the verification was successful. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN556"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN350"><span class='Ref_to_Member'>sslmode</span></a><span class='Delimiter'>, </span><span class='String'>"verify-full"</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Check that we have a hostname to compare with. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN566"><span class='Ref_To_Local'>host</span></a> <span class='Operator'>&& </span><a href="fe-secure-openssl.c.html#LN566"><span class='Ref_To_Local'>host</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='String'>'\0'</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN556"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                          <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"host name must be specified for a verified SSL connection\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * First, get the Subject Alternative Names (SANs) from the certificate, 
     * and compare them against the originally given hostname. 
     */ 
</span>    <a href="fe-secure-openssl.c.html#LN563"><span class='Ref_To_Local'>peer_san</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span>STACK_OF<span class='Parentheses'>(</span>GENERAL_NAME<span class='Parentheses'>) </span><span class='Operator'>*</span><span class='Parentheses'>)</span> 
        X509_get_ext_d2i<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN556"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN463"><span class='Ref_to_Member'>peer</span></a><span class='Delimiter'>, </span>NID_subject_alt_name<span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN563"><span class='Ref_To_Local'>peer_san</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN592"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>san_len</span> <span class='Operator'>= </span>sk_GENERAL_NAME_num<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN563"><span class='Ref_To_Local'>peer_san</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN564"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="fe-secure-openssl.c.html#LN564"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="fe-secure-openssl.c.html#LN592"><span class='Ref_To_Local'>san_len</span></a><span class='Delimiter'>; </span><a href="fe-secure-openssl.c.html#LN564"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN596"></a>            <span class='Keyword'>const </span>GENERAL_NAME <span class='Operator'>*</span><span class='Declare_Local'>name</span> <span class='Operator'>= </span>sk_GENERAL_NAME_value<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN563"><span class='Ref_To_Local'>peer_san</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN564"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN596"><span class='Ref_To_Local'>name</span></a><span class='Operator'>-&GT;</span>type <span class='Operator'>== </span>GEN_DNS<span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN600"></a>                <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>alt_name</span><span class='Delimiter'>; 
</span> 
                <a href="fe-secure-openssl.c.html#LN558"><span class='Ref_To_Local'>names_examined</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <a href="fe-secure-openssl.c.html#LN565"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span><a href="fe-secure-openssl.c.html#LN64"><span class='Ref_to_Proto'>verify_peer_name_matches_certificate_name</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN556"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, 
</span>                                                             <a href="fe-secure-openssl.c.html#LN596"><span class='Ref_To_Local'>name</span></a><span class='Operator'>-&GT;</span>d<span class='Operator'>.</span>dNSName<span class='Delimiter'>, 
</span>                                                               <span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN600"><span class='Ref_To_Local'>alt_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN565"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>                    <a href="fe-secure-openssl.c.html#LN560"><span class='Ref_To_Local'>got_error</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN565"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>                    <a href="fe-secure-openssl.c.html#LN559"><span class='Ref_To_Local'>found_match</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN600"><span class='Ref_To_Local'>alt_name</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fe-secure-openssl.c.html#LN561"><span class='Ref_To_Local'>first_name</span></a><span class='Parentheses'>) 
</span>                        <a href="fe-secure-openssl.c.html#LN561"><span class='Ref_To_Local'>first_name</span></a> <span class='Operator'>= </span><a href="fe-secure-openssl.c.html#LN600"><span class='Ref_To_Local'>alt_name</span></a><span class='Delimiter'>; 
</span>                    <span class='Control'>else</span> 
                        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN600"><span class='Ref_To_Local'>alt_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if name-&GT;type==GEN_DNS &raquo; </span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN559"><span class='Ref_To_Local'>found_match</span></a> <span class='Operator'>|| </span><a href="fe-secure-openssl.c.html#LN560"><span class='Ref_To_Local'>got_error</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;san_len;i++ &raquo; </span> 
        sk_GENERAL_NAME_free<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN563"><span class='Ref_To_Local'>peer_san</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if peer_san &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * If there is no subjectAltName extension of type dNSName, check the 
     * Common Name. 
     * 
     * (Per RFC 2818 and RFC 6125, if the subjectAltName extension of type 
     * dNSName is present, the CN must be ignored.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN558"><span class='Ref_To_Local'>names_examined</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN634"></a>        X509_NAME  <span class='Operator'>*</span><span class='Declare_Local'>subject_name</span><span class='Delimiter'>; 
</span> 
        <a href="fe-secure-openssl.c.html#LN634"><span class='Ref_To_Local'>subject_name</span></a> <span class='Operator'>= </span>X509_get_subject_name<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN556"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN463"><span class='Ref_to_Member'>peer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN634"><span class='Ref_To_Local'>subject_name</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN639"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>cn_index</span><span class='Delimiter'>; 
</span> 
            <a href="fe-secure-openssl.c.html#LN639"><span class='Ref_To_Local'>cn_index</span></a> <span class='Operator'>= </span>X509_NAME_get_index_by_NID<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN634"><span class='Ref_To_Local'>subject_name</span></a><span class='Delimiter'>, 
</span>                                                  NID_commonName<span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN639"><span class='Ref_To_Local'>cn_index</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="fe-secure-openssl.c.html#LN558"><span class='Ref_To_Local'>names_examined</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <a href="fe-secure-openssl.c.html#LN565"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span><a href="fe-secure-openssl.c.html#LN64"><span class='Ref_to_Proto'>verify_peer_name_matches_certificate_name</span></a><span class='Parentheses'>(</span> 
                                                               <a href="fe-secure-openssl.c.html#LN556"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, 
</span>                                                    X509_NAME_ENTRY_get_data<span class='Parentheses'>(</span> 
                                X509_NAME_get_entry<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN634"><span class='Ref_To_Local'>subject_name</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN639"><span class='Ref_To_Local'>cn_index</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                                                               <span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN561"><span class='Ref_To_Local'>first_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN565"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>                    <a href="fe-secure-openssl.c.html#LN560"><span class='Ref_To_Local'>got_error</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN565"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>                    <a href="fe-secure-openssl.c.html#LN559"><span class='Ref_To_Local'>found_match</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if subject_name!=NULL &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if names_examined==0 &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fe-secure-openssl.c.html#LN559"><span class='Ref_To_Local'>found_match</span></a> <span class='Operator'>&& !</span><a href="fe-secure-openssl.c.html#LN560"><span class='Ref_To_Local'>got_error</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * No match. Include the name from the server certificate in the error 
         * message, to aid debugging broken configurations. If there are 
         * multiple names, only print the first one to avoid an overly long 
         * error message. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN558"><span class='Ref_To_Local'>names_examined</span></a> <span class='Operator'>&GT; </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN556"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                              <a href="libpq-int.h.html#LN683"><span class='Ref_to_Macro'>libpq_ngettext</span></a><span class='Parentheses'>(</span><span class='String'>"server certificate for \"%s\" (and %d other name) does not match host name \"%s\"\n"</span><span class='Delimiter'>, 
</span>                                             <span class='String'>"server certificate for \"%s\" (and %d other names) does not match host name \"%s\"\n"</span><span class='Delimiter'>, 
</span>                                             <a href="fe-secure-openssl.c.html#LN558"><span class='Ref_To_Local'>names_examined</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                              <a href="fe-secure-openssl.c.html#LN561"><span class='Ref_To_Local'>first_name</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN558"><span class='Ref_To_Local'>names_examined</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN566"><span class='Ref_To_Local'>host</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN558"><span class='Ref_To_Local'>names_examined</span></a> <span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN556"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                              <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"server certificate for \"%s\" does not match host name \"%s\"\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                              <a href="fe-secure-openssl.c.html#LN561"><span class='Ref_To_Local'>first_name</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN566"><span class='Ref_To_Local'>host</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN556"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                              <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"could not get server's host name from server certificate\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !found_match&&!got_er... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* clean up */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN561"><span class='Ref_To_Local'>first_name</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN561"><span class='Ref_To_Local'>first_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="fe-secure-openssl.c.html#LN559"><span class='Ref_To_Local'>found_match</span></a> <span class='Operator'>&& !</span><a href="fe-secure-openssl.c.html#LN560"><span class='Ref_To_Local'>got_error</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end verify_peer_name_matches_certificate &raquo; </span> 
 
<span class='Directive'>#if</span> defined<span class='Parentheses'>(</span>ENABLE_THREAD_SAFETY<span class='Parentheses'>) </span><span class='Operator'>&& </span>defined<span class='Parentheses'>(</span>HAVE_CRYPTO_LOCK<span class='Parentheses'>) 
</span><span class='Comment_Multi_Line'>/* 
 *  Callback functions for OpenSSL internal locking.  (OpenSSL 1.1.0 
 *  does its own locking, and doesn't need these anymore.  The 
 *  CRYPTO_lock() function was removed in 1.1.0, when the callbacks 
 *  were made obsolete, so we assume that if CRYPTO_lock() exists, 
 *  the callbacks are still required.) 
 */ 
</span> 
<span class='Keyword'>static unsigned long 
</span><a name="LN706"></a><span class='Declare_Function'>pq_threadidcallback</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * This is not standards-compliant.  pthread_self() returns pthread_t, and 
     * shouldn't be cast to unsigned long, but CRYPTO_set_id_callback requires 
     * it, so we have to do it. 
     */ 
</span>    <span class='Control'>return</span> <span class='Parentheses'>(</span><span class='Keyword'>unsigned long</span><span class='Parentheses'>) </span><a href="../../port/pthread-win32.h.html#LN10"><span class='Ref_to_Proto'>pthread_self</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
} 
</span> 
<a name="LN716"></a><span class='Keyword'>static </span><a href="../ecpg/include/ecpg-pthread-win32.h.html#LN14"><span class='Ref_to_Struct'>pthread_mutex_t</span></a> <span class='Operator'>*</span><span class='Declare_Var'>pq_lockarray</span><span class='Delimiter'>; 
</span> 
<span class='Keyword'>static void 
</span><a name="LN719"></a><span class='Declare_Function'>pq_lockingcallback</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>mode</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>n</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>file</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>line</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN719"><span class='Ref_to_Parameter'>mode</span></a> <span class='Operator'>& </span>CRYPTO_LOCK<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../port/pthread-win32.h.html#LN16"><span class='Ref_to_Proto'>pthread_mutex_lock</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN716"><span class='Ref_to_Global_Var'>pq_lockarray</span></a><span class='Delimiter'>[</span><a href="fe-secure-openssl.c.html#LN719"><span class='Ref_to_Parameter'>n</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span> 
            <a href="libpq-int.h.html#LN551"><span class='Ref_to_Macro'>PGTHREAD_ERROR</span></a><span class='Parentheses'>(</span><span class='String'>"failed to lock mutex"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../port/pthread-win32.h.html#LN19"><span class='Ref_to_Proto'>pthread_mutex_unlock</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN716"><span class='Ref_to_Global_Var'>pq_lockarray</span></a><span class='Delimiter'>[</span><a href="fe-secure-openssl.c.html#LN719"><span class='Ref_to_Parameter'>n</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span> 
            <a href="libpq-int.h.html#LN551"><span class='Ref_to_Macro'>PGTHREAD_ERROR</span></a><span class='Parentheses'>(</span><span class='String'>"failed to unlock mutex"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* ENABLE_THREAD_SAFETY && HAVE_CRYPTO_LOCK */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Initialize SSL library. 
 * 
 * In threadsafe mode, this includes setting up libcrypto callback functions 
 * to do thread locking. 
 * 
 * If the caller has told us (through PQinitOpenSSL) that he's taking care 
 * of libcrypto, we expect that callbacks are already set, and won't try to 
 * override it. 
 * 
 * The conn parameter is only used to be able to pass back an error 
 * message - no connection-local setup is made here. 
 * 
 * Returns 0 if OK, -1 on failure (with a message in conn-&GT;errorMessage). 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN750"></a><span class='Declare_Function'>pgtls_init</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> ENABLE_THREAD_SAFETY 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <span class='Comment_Multi_Line'>/* Also see similar code in fe-connect.c, default_threadlock() */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN88"><span class='Ref_to_Global_Var'>ssl_config_mutex</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span>InterlockedExchange<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN91"><span class='Ref_to_Global_Var'>win32_ssl_create_mutex</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
             <span class='Comment_Multi_Line'>/* loop, another thread own the lock */ </span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN88"><span class='Ref_to_Global_Var'>ssl_config_mutex</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../port/pthread-win32.h.html#LN15"><span class='Ref_to_Proto'>pthread_mutex_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN88"><span class='Ref_to_Global_Var'>ssl_config_mutex</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> 
                <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        InterlockedExchange<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN91"><span class='Ref_to_Global_Var'>win32_ssl_create_mutex</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../port/pthread-win32.h.html#LN16"><span class='Ref_to_Proto'>pthread_mutex_lock</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN88"><span class='Ref_to_Global_Var'>ssl_config_mutex</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> HAVE_CRYPTO_LOCK 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN80"><span class='Ref_to_Global_Var'>pq_init_crypto_lib</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * If necessary, set up an array to hold locks for libcrypto. 
         * libcrypto will tell us how big to make this array. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN716"><span class='Ref_to_Global_Var'>pq_lockarray</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN779"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
            <a href="fe-secure-openssl.c.html#LN716"><span class='Ref_to_Global_Var'>pq_lockarray</span></a> <span class='Operator'>= </span><a href="../../include/snowball/header.h.html#LN49"><span class='Ref_to_Macro'>malloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../ecpg/include/ecpg-pthread-win32.h.html#LN14"><span class='Ref_to_Struct'>pthread_mutex_t</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span>CRYPTO_num_locks<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fe-secure-openssl.c.html#LN716"><span class='Ref_to_Global_Var'>pq_lockarray</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../port/pthread-win32.h.html#LN19"><span class='Ref_to_Proto'>pthread_mutex_unlock</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN88"><span class='Ref_to_Global_Var'>ssl_config_mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN779"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="fe-secure-openssl.c.html#LN779"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span>CRYPTO_num_locks<span class='Parentheses'>()</span><span class='Delimiter'>; </span><a href="fe-secure-openssl.c.html#LN779"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../port/pthread-win32.h.html#LN15"><span class='Ref_to_Proto'>pthread_mutex_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN716"><span class='Ref_to_Global_Var'>pq_lockarray</span></a><span class='Delimiter'>[</span><a href="fe-secure-openssl.c.html#LN779"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN716"><span class='Ref_to_Global_Var'>pq_lockarray</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="fe-secure-openssl.c.html#LN716"><span class='Ref_to_Global_Var'>pq_lockarray</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                    <a href="../../port/pthread-win32.h.html#LN19"><span class='Ref_to_Proto'>pthread_mutex_unlock</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN88"><span class='Ref_to_Global_Var'>ssl_config_mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if pq_lockarray==NULL &raquo; </span> 
 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN85"><span class='Ref_to_Global_Var'>ssl_open_connections</span></a><span class='Operator'>++ == </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * These are only required for threaded libcrypto applications, 
             * but make sure we don't stomp on them if they're already set. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>CRYPTO_get_id_callback<span class='Parentheses'>() </span><span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
                CRYPTO_set_id_callback<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN705"><span class='Ref_to_Func'>pq_threadidcallback</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>CRYPTO_get_locking_callback<span class='Parentheses'>() </span><span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
                CRYPTO_set_locking_callback<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN718"><span class='Ref_to_Func'>pq_lockingcallback</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if pq_init_crypto_lib &raquo; </span> 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* HAVE_CRYPTO_LOCK */ 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* ENABLE_THREAD_SAFETY */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fe-secure-openssl.c.html#LN82"><span class='Ref_to_Global_Var'>ssl_lib_initialized</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN79"><span class='Ref_to_Global_Var'>pq_init_ssl_lib</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> HAVE_OPENSSL_INIT_SSL 
            OPENSSL_init_ssl<span class='Parentheses'>(</span>OPENSSL_INIT_LOAD_CONFIG<span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
            OPENSSL_config<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            SSL_library_init<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            SSL_load_error_strings<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
        <span class='Delimiter'>} 
</span>        <a href="fe-secure-openssl.c.html#LN82"><span class='Ref_to_Global_Var'>ssl_lib_initialized</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
<span class='Directive'>#ifdef</span> ENABLE_THREAD_SAFETY 
    <a href="../../port/pthread-win32.h.html#LN19"><span class='Ref_to_Proto'>pthread_mutex_unlock</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN88"><span class='Ref_to_Global_Var'>ssl_config_mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgtls_init &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  This function is needed because if the libpq library is unloaded 
 *  from the application, the callback functions will no longer exist when 
 *  libcrypto is used by other parts of the system.  For this reason, 
 *  we unregister the callback functions when the last libpq 
 *  connection is closed.  (The same would apply for OpenSSL callbacks 
 *  if we had any.) 
 * 
 *  Callbacks are only set when we're compiled in threadsafe mode, so 
 *  we only need to remove them in this case. They are also not needed 
 *  with OpenSSL 1.1.0 anymore. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN848"></a><span class='Declare_Function'>destroy_ssl_system</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#if</span> defined<span class='Parentheses'>(</span>ENABLE_THREAD_SAFETY<span class='Parentheses'>) </span><span class='Operator'>&& </span>defined<span class='Parentheses'>(</span>HAVE_CRYPTO_LOCK<span class='Parentheses'>) 
</span>    <span class='Comment_Multi_Line'>/* Mutex is created in initialize_ssl_system() */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../port/pthread-win32.h.html#LN16"><span class='Ref_to_Proto'>pthread_mutex_lock</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN88"><span class='Ref_to_Global_Var'>ssl_config_mutex</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN80"><span class='Ref_to_Global_Var'>pq_init_crypto_lib</span></a> <span class='Operator'>&& </span><a href="fe-secure-openssl.c.html#LN85"><span class='Ref_to_Global_Var'>ssl_open_connections</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Operator'>--</span><a href="fe-secure-openssl.c.html#LN85"><span class='Ref_to_Global_Var'>ssl_open_connections</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN80"><span class='Ref_to_Global_Var'>pq_init_crypto_lib</span></a> <span class='Operator'>&& </span><a href="fe-secure-openssl.c.html#LN85"><span class='Ref_to_Global_Var'>ssl_open_connections</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * No connections left, unregister libcrypto callbacks, if no one 
         * registered different ones in the meantime. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>CRYPTO_get_locking_callback<span class='Parentheses'>() </span><span class='Operator'>== </span><a href="fe-secure-openssl.c.html#LN718"><span class='Ref_to_Func'>pq_lockingcallback</span></a><span class='Parentheses'>)</span> 
            CRYPTO_set_locking_callback<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>CRYPTO_get_id_callback<span class='Parentheses'>() </span><span class='Operator'>== </span><a href="fe-secure-openssl.c.html#LN705"><span class='Ref_to_Func'>pq_threadidcallback</span></a><span class='Parentheses'>)</span> 
            CRYPTO_set_id_callback<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We don't free the lock array. If we get another connection in this 
         * process, we will just re-use them with the existing mutexes. 
         * 
         * This means we leak a little memory on repeated load/unload of the 
         * library. 
         */ 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../port/pthread-win32.h.html#LN19"><span class='Ref_to_Proto'>pthread_mutex_unlock</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN88"><span class='Ref_to_Global_Var'>ssl_config_mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end destroy_ssl_system &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  Create per-connection SSL object, and load the client certificate, 
 *  private key, and trusted CA certs. 
 * 
 *  Returns 0 if OK, -1 on failure (with a message in conn-&GT;errorMessage). 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN889"></a><span class='Declare_Function'>initialize_SSL</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN891"></a>    SSL_CTX    <span class='Operator'>*</span><span class='Declare_Local'>SSL_context</span><span class='Delimiter'>; 
</span><a name="LN892"></a>    <span class='Control'>struct</span> <a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN893"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>homedir</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN894"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>fnbuf</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN895"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>sebuf</span><span class='Delimiter'>[</span><span class='Number'>256</span><span class='Delimiter'>]; 
</span><a name="LN896"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>have_homedir</span><span class='Delimiter'>; 
</span><a name="LN897"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>have_cert</span><span class='Delimiter'>; 
</span><a name="LN898"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>have_rootcert</span><span class='Delimiter'>; 
</span><a name="LN899"></a>    EVP_PKEY   <span class='Operator'>*</span><span class='Declare_Local'>pkey</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We'll need the home directory if any of the relevant parameters are 
     * defaulted.  If pqGetHomeDirectory fails, act as though none of the 
     * files could be found. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN353"><span class='Ref_to_Member'>sslcert</span></a> <span class='Operator'>&& </span>strlen<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN353"><span class='Ref_to_Member'>sslcert</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> <span class='Operator'>|| 
</span>        <span class='Operator'>!</span><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN352"><span class='Ref_to_Member'>sslkey</span></a> <span class='Operator'>&& </span>strlen<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN352"><span class='Ref_to_Member'>sslkey</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> <span class='Operator'>|| 
</span>        <span class='Operator'>!</span><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN354"><span class='Ref_to_Member'>sslrootcert</span></a> <span class='Operator'>&& </span>strlen<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN354"><span class='Ref_to_Member'>sslrootcert</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> <span class='Operator'>|| 
</span>        <span class='Operator'>!</span><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN355"><span class='Ref_to_Member'>sslcrl</span></a> <span class='Operator'>&& </span>strlen<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN355"><span class='Ref_to_Member'>sslcrl</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>))</span> 
        <a href="fe-secure-openssl.c.html#LN896"><span class='Ref_To_Local'>have_homedir</span></a> <span class='Operator'>= </span><a href="libpq-int.h.html#LN546"><span class='Ref_to_Proto'>pqGetHomeDirectory</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN893"><span class='Ref_To_Local'>homedir</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN893"><span class='Ref_To_Local'>homedir</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span>    <span class='Comment_Single_Line'>/* won't need it */ 
</span>        <a href="fe-secure-openssl.c.html#LN896"><span class='Ref_To_Local'>have_homedir</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create a new SSL_CTX object. 
     * 
     * We used to share a single SSL_CTX between all connections, but it was 
     * complicated if connections used different certificates. So now we 
     * create a separate context for each connection, and accept the overhead. 
     */ 
</span>    <a href="fe-secure-openssl.c.html#LN891"><span class='Ref_To_Local'>SSL_context</span></a> <span class='Operator'>= </span>SSL_CTX_new<span class='Parentheses'>(</span>SSLv23_method<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fe-secure-openssl.c.html#LN891"><span class='Ref_To_Local'>SSL_context</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN924"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>err</span> <span class='Operator'>= </span><a href="fe-secure-openssl.c.html#LN70"><span class='Ref_to_Proto'>SSLerrmessage</span></a><span class='Parentheses'>(</span>ERR_get_error<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                          <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"could not create SSL context: %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                          <a href="fe-secure-openssl.c.html#LN924"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="fe-secure-openssl.c.html#LN71"><span class='Ref_to_Proto'>SSLerrfree</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN924"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Disable old protocol versions */ 
</span>    SSL_CTX_set_options<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN891"><span class='Ref_To_Local'>SSL_context</span></a><span class='Delimiter'>, </span>SSL_OP_NO_SSLv2 <span class='Operator'>| </span>SSL_OP_NO_SSLv3<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Disable OpenSSL's moving-write-buffer sanity check, because it causes 
     * unnecessary failures in nonblocking send cases. 
     */ 
</span>    SSL_CTX_set_mode<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN891"><span class='Ref_To_Local'>SSL_context</span></a><span class='Delimiter'>, </span>SSL_MODE_ACCEPT_MOVING_WRITE_BUFFER<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the root cert file exists, load it so we can perform certificate 
     * verification. If sslmode is "verify-full" we will also do further 
     * verification after the connection has been completed. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN354"><span class='Ref_to_Member'>sslrootcert</span></a> <span class='Operator'>&& </span>strlen<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN354"><span class='Ref_to_Member'>sslrootcert</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN354"><span class='Ref_to_Member'>sslrootcert</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN896"><span class='Ref_To_Local'>have_homedir</span></a><span class='Parentheses'>) 
</span>        <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/%s"</span><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN893"><span class='Ref_To_Local'>homedir</span></a><span class='Delimiter'>, </span><a href="libpq-int.h.html#LN520"><span class='Ref_to_Const'>ROOT_CERT_FILE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='String'>'\0'</span> <span class='Operator'>&& 
</span>        <a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN892"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN957"></a>        X509_STORE <span class='Operator'>*</span><span class='Declare_Local'>cvstore</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>SSL_CTX_load_verify_locations<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN891"><span class='Ref_To_Local'>SSL_context</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><a name="LN961"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>err</span> <span class='Operator'>= </span><a href="fe-secure-openssl.c.html#LN70"><span class='Ref_to_Proto'>SSLerrmessage</span></a><span class='Parentheses'>(</span>ERR_get_error<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
            <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                              <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"could not read root certificate file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                              <a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN961"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="fe-secure-openssl.c.html#LN71"><span class='Ref_to_Proto'>SSLerrfree</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN961"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            SSL_CTX_free<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN891"><span class='Ref_To_Local'>SSL_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="fe-secure-openssl.c.html#LN957"><span class='Ref_To_Local'>cvstore</span></a> <span class='Operator'>= </span>SSL_CTX_get_cert_store<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN891"><span class='Ref_To_Local'>SSL_context</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN355"><span class='Ref_to_Member'>sslcrl</span></a> <span class='Operator'>&& </span>strlen<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN355"><span class='Ref_to_Member'>sslcrl</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <a href="../../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN355"><span class='Ref_to_Member'>sslcrl</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN896"><span class='Ref_To_Local'>have_homedir</span></a><span class='Parentheses'>) 
</span>                <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/%s"</span><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN893"><span class='Ref_To_Local'>homedir</span></a><span class='Delimiter'>, </span><a href="libpq-int.h.html#LN521"><span class='Ref_to_Const'>ROOT_CRL_FILE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Set the flags to check against the complete CRL chain */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='String'>'\0'</span> <span class='Operator'>&& 
</span>                X509_STORE_load_locations<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN957"><span class='Ref_To_Local'>cvstore</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* OpenSSL 0.96 does not support X509_V_FLAG_CRL_CHECK */ 
</span><span class='Directive'>#ifdef</span> X509_V_FLAG_CRL_CHECK 
                X509_STORE_set_flags<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN957"><span class='Ref_To_Local'>cvstore</span></a><span class='Delimiter'>, 
</span>                          X509_V_FLAG_CRL_CHECK <span class='Operator'>| </span>X509_V_FLAG_CRL_CHECK_ALL<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
<a name="LN989"></a>                <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>err</span> <span class='Operator'>= </span><a href="fe-secure-openssl.c.html#LN70"><span class='Ref_to_Proto'>SSLerrmessage</span></a><span class='Parentheses'>(</span>ERR_get_error<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
                <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                                  <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"SSL library does not support CRL certificates (file \"%s\")\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                  <a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="fe-secure-openssl.c.html#LN71"><span class='Ref_to_Proto'>SSLerrfree</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN989"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                SSL_CTX_free<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN891"><span class='Ref_To_Local'>SSL_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
            <span class='Delimiter'>} 
</span>            <span class='Comment_Multi_Line'>/* if not found, silently ignore;  we do not require CRL */ 
</span>            ERR_clear_error<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if (cvstore=SSL_CTX_get_... &raquo; </span> 
        <a href="fe-secure-openssl.c.html#LN898"><span class='Ref_To_Local'>have_rootcert</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if fnbuf[0]!='\0'&&stat(... &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * stat() failed; assume root file doesn't exist.  If sslmode is 
         * verify-ca or verify-full, this is an error.  Otherwise, continue 
         * without performing any server cert verification. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN350"><span class='Ref_to_Member'>sslmode</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'v'</span><span class='Parentheses'>)</span>    <span class='Comment_Single_Line'>/* "verify-ca" or "verify-full" */ 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * The only way to reach here with an empty filename is if 
             * pqGetHomeDirectory failed.  That's a sufficiently unusual case 
             * that it seems worth having a specialized error message for it. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>                <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                                  <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"could not get home directory to locate root certificate file\n"</span> 
                                                <span class='String'>"Either provide the file or change sslmode to disable server certificate verification.\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"root certificate file \"%s\" does not exist\n"</span> 
                              <span class='String'>"Either provide the file or change sslmode to disable server certificate verification.\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            SSL_CTX_free<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN891"><span class='Ref_To_Local'>SSL_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="fe-secure-openssl.c.html#LN898"><span class='Ref_To_Local'>have_rootcert</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Read the client certificate file */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN353"><span class='Ref_to_Member'>sslcert</span></a> <span class='Operator'>&& </span>strlen<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN353"><span class='Ref_to_Member'>sslcert</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN353"><span class='Ref_to_Member'>sslcert</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN896"><span class='Ref_To_Local'>have_homedir</span></a><span class='Parentheses'>) 
</span>        <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/%s"</span><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN893"><span class='Ref_To_Local'>homedir</span></a><span class='Delimiter'>, </span><a href="libpq-int.h.html#LN518"><span class='Ref_to_Const'>USER_CERT_FILE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* no home directory, proceed without a client cert */ 
</span>        <a href="fe-secure-openssl.c.html#LN897"><span class='Ref_To_Local'>have_cert</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN892"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * If file is not present, just go on without a client cert; server 
         * might or might not accept the connection.  Any other error, 
         * however, is grounds for complaint. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>!= </span>ENOENT <span class='Operator'>&& </span>errno <span class='Operator'>!= </span>ENOTDIR<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>               <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"could not open certificate file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                              <a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Delimiter'>, </span><a href="../../port/thread.c.html#LN59"><span class='Ref_to_Func'>pqStrerror</span></a><span class='Parentheses'>(</span>errno<span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN895"><span class='Ref_To_Local'>sebuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN895"><span class='Ref_To_Local'>sebuf</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            SSL_CTX_free<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN891"><span class='Ref_To_Local'>SSL_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="fe-secure-openssl.c.html#LN897"><span class='Ref_To_Local'>have_cert</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Cert file exists, so load it. Since OpenSSL doesn't provide the 
         * equivalent of "SSL_use_certificate_chain_file", we have to load it 
         * into the SSL context, rather than the SSL object. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>SSL_CTX_use_certificate_chain_file<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN891"><span class='Ref_To_Local'>SSL_context</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1071"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>err</span> <span class='Operator'>= </span><a href="fe-secure-openssl.c.html#LN70"><span class='Ref_to_Proto'>SSLerrmessage</span></a><span class='Parentheses'>(</span>ERR_get_error<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
            <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>               <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"could not read certificate file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                              <a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN1071"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="fe-secure-openssl.c.html#LN71"><span class='Ref_to_Proto'>SSLerrfree</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1071"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            SSL_CTX_free<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN891"><span class='Ref_To_Local'>SSL_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* need to load the associated private key, too */ 
</span>        <a href="fe-secure-openssl.c.html#LN897"><span class='Ref_To_Local'>have_cert</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * The SSL context is now loaded with the correct root and client 
     * certificates. Create a connection-specific SSL object. The private key 
     * is loaded directly into the SSL object. (We could load the private key 
     * into the context, too, but we have done it this way historically, and 
     * it doesn't really matter.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN462"><span class='Ref_to_Member'>ssl</span></a> <span class='Operator'>= </span>SSL_new<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN891"><span class='Ref_To_Local'>SSL_context</span></a><span class='Parentheses'>))</span> <span class='Operator'>|| 
</span>        <span class='Operator'>!</span>SSL_set_app_data<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN462"><span class='Ref_to_Member'>ssl</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>)</span> <span class='Operator'>|| 
</span>        <span class='Operator'>!</span><a href="../../backend/libpq/be-secure-openssl.c.html#LN71"><span class='Ref_to_Proto'>my_SSL_set_fd</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN399"><span class='Ref_to_Member'>sock</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1096"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>err</span> <span class='Operator'>= </span><a href="fe-secure-openssl.c.html#LN70"><span class='Ref_to_Proto'>SSLerrmessage</span></a><span class='Parentheses'>(</span>ERR_get_error<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                   <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"could not establish SSL connection: %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                          <a href="fe-secure-openssl.c.html#LN1096"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="fe-secure-openssl.c.html#LN71"><span class='Ref_to_Proto'>SSLerrfree</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1096"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        SSL_CTX_free<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN891"><span class='Ref_To_Local'>SSL_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN460"><span class='Ref_to_Member'>ssl_in_use</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * SSL contexts are reference counted by OpenSSL. We can free it as soon 
     * as we have created the SSL object, and it will stick around for as long 
     * as it's actually needed. 
     */ 
</span>    SSL_CTX_free<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN891"><span class='Ref_To_Local'>SSL_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="fe-secure-openssl.c.html#LN891"><span class='Ref_To_Local'>SSL_context</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Read the SSL key. If a key is specified, treat it as an engine:key 
     * combination if there is colon present - we don't support files with 
     * colon in the name. The exception is if the second character is a colon, 
     * in which case it can be a Windows filename with drive specification. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN897"><span class='Ref_To_Local'>have_cert</span></a> <span class='Operator'>&& </span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN352"><span class='Ref_to_Member'>sslkey</span></a> <span class='Operator'>&& </span>strlen<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN352"><span class='Ref_to_Member'>sslkey</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> <a href="libpq-int.h.html#LN78"><span class='Ref_to_Const'>USE_SSL_ENGINE</span></a> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>strchr<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN352"><span class='Ref_to_Member'>sslkey</span></a><span class='Delimiter'>, </span><span class='String'>':'</span><span class='Parentheses'>) 
</span><span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
            <span class='Operator'>&& </span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN352"><span class='Ref_to_Member'>sslkey</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='String'>':'</span> 
<span class='Directive'>#endif</span> 
            <span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Colon, but not in second character, treat as engine:key */ 
</span><a name="LN1131"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>engine_str</span> <span class='Operator'>= </span>strdup<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN352"><span class='Ref_to_Member'>sslkey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1132"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>engine_colon</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1131"><span class='Ref_To_Local'>engine_str</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                                  <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* cannot return NULL because we already checked before strdup */ 
</span>            <a href="fe-secure-openssl.c.html#LN1132"><span class='Ref_To_Local'>engine_colon</span></a> <span class='Operator'>= </span>strchr<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1131"><span class='Ref_To_Local'>engine_str</span></a><span class='Delimiter'>, </span><span class='String'>':'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Operator'>*</span><a href="fe-secure-openssl.c.html#LN1132"><span class='Ref_To_Local'>engine_colon</span></a> <span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* engine_str now has engine name */ 
</span>            <a href="fe-secure-openssl.c.html#LN1132"><span class='Ref_To_Local'>engine_colon</span></a><span class='Operator'>++</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* engine_colon now has key name */ 
</span> 
            <a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN465"><span class='Ref_to_Member'>engine</span></a> <span class='Operator'>= </span>ENGINE_by_id<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1131"><span class='Ref_To_Local'>engine_str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN465"><span class='Ref_to_Member'>engine</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN1150"></a>                <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>err</span> <span class='Operator'>= </span><a href="fe-secure-openssl.c.html#LN70"><span class='Ref_to_Proto'>SSLerrmessage</span></a><span class='Parentheses'>(</span>ERR_get_error<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
                <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                     <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"could not load SSL engine \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                  <a href="fe-secure-openssl.c.html#LN1131"><span class='Ref_To_Local'>engine_str</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN1150"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="fe-secure-openssl.c.html#LN71"><span class='Ref_to_Proto'>SSLerrfree</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1150"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1131"><span class='Ref_To_Local'>engine_str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span>ENGINE_init<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN465"><span class='Ref_to_Member'>engine</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span><a name="LN1162"></a>                <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>err</span> <span class='Operator'>= </span><a href="fe-secure-openssl.c.html#LN70"><span class='Ref_to_Proto'>SSLerrmessage</span></a><span class='Parentheses'>(</span>ERR_get_error<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
                <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"could not initialize SSL engine \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                  <a href="fe-secure-openssl.c.html#LN1131"><span class='Ref_To_Local'>engine_str</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN1162"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="fe-secure-openssl.c.html#LN71"><span class='Ref_to_Proto'>SSLerrfree</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1162"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                ENGINE_free<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN465"><span class='Ref_to_Member'>engine</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN465"><span class='Ref_to_Member'>engine</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1131"><span class='Ref_To_Local'>engine_str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="fe-secure-openssl.c.html#LN899"><span class='Ref_To_Local'>pkey</span></a> <span class='Operator'>= </span>ENGINE_load_private_key<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN465"><span class='Ref_to_Member'>engine</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN1132"><span class='Ref_To_Local'>engine_colon</span></a><span class='Delimiter'>, 
</span>                                           <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN899"><span class='Ref_To_Local'>pkey</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN1178"></a>                <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>err</span> <span class='Operator'>= </span><a href="fe-secure-openssl.c.html#LN70"><span class='Ref_to_Proto'>SSLerrmessage</span></a><span class='Parentheses'>(</span>ERR_get_error<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
                <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                                  <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"could not read private SSL key \"%s\" from engine \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                  <a href="fe-secure-openssl.c.html#LN1132"><span class='Ref_To_Local'>engine_colon</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN1131"><span class='Ref_To_Local'>engine_str</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN1178"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="fe-secure-openssl.c.html#LN71"><span class='Ref_to_Proto'>SSLerrfree</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1178"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                ENGINE_finish<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN465"><span class='Ref_to_Member'>engine</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                ENGINE_free<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN465"><span class='Ref_to_Member'>engine</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN465"><span class='Ref_to_Member'>engine</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1131"><span class='Ref_To_Local'>engine_str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>SSL_use_PrivateKey<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN462"><span class='Ref_to_Member'>ssl</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN899"><span class='Ref_To_Local'>pkey</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span><a name="LN1192"></a>                <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>err</span> <span class='Operator'>= </span><a href="fe-secure-openssl.c.html#LN70"><span class='Ref_to_Proto'>SSLerrmessage</span></a><span class='Parentheses'>(</span>ERR_get_error<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
                <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                                  <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"could not load private SSL key \"%s\" from engine \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                  <a href="fe-secure-openssl.c.html#LN1132"><span class='Ref_To_Local'>engine_colon</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN1131"><span class='Ref_To_Local'>engine_str</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN1192"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="fe-secure-openssl.c.html#LN71"><span class='Ref_to_Proto'>SSLerrfree</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1192"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                ENGINE_finish<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN465"><span class='Ref_to_Member'>engine</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                ENGINE_free<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN465"><span class='Ref_to_Member'>engine</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN465"><span class='Ref_to_Member'>engine</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1131"><span class='Ref_To_Local'>engine_str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1131"><span class='Ref_To_Local'>engine_str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>;</span>    <span class='Comment_Multi_Line'>/* indicate we're not going to load from a 
                                 * file */ 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if strchr(conn-&GT;sslkey,'... &raquo; </span> 
        <span class='Control'>else</span> 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* USE_SSL_ENGINE */ 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* PGSSLKEY is not an engine, treat it as a filename */ 
</span>            <a href="../../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN352"><span class='Ref_to_Member'>sslkey</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if have_cert&&conn-&GT;sslk... &raquo; </span> 
    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN896"><span class='Ref_To_Local'>have_homedir</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* No PGSSLKEY specified, load default file */ 
</span>        <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/%s"</span><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN893"><span class='Ref_To_Local'>homedir</span></a><span class='Delimiter'>, </span><a href="libpq-int.h.html#LN519"><span class='Ref_to_Const'>USER_KEY_FILE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN897"><span class='Ref_To_Local'>have_cert</span></a> <span class='Operator'>&& </span><a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* read the client key from file */ 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN892"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                              <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"certificate present, but not private key file \"%s\"\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                              <a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span><span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/port/win32.h.html#LN430"><span class='Ref_to_Macro'>S_ISREG</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN892"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span>st_mode<span class='Parentheses'>) </span><span class='Operator'>|| </span><a href="fe-secure-openssl.c.html#LN892"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span>st_mode <span class='Operator'>& </span><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN450"><span class='Ref_to_Const'>S_IRWXG</span></a> <span class='Operator'>| </span><a href="../../include/port/win32.h.html#LN454"><span class='Ref_to_Const'>S_IRWXO</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                              <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"private key file \"%s\" has group or world access; permissions should be u=rw (0600) or less\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                              <a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>SSL_use_PrivateKey_file<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN462"><span class='Ref_to_Member'>ssl</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Delimiter'>, </span>SSL_FILETYPE_PEM<span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1248"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>err</span> <span class='Operator'>= </span><a href="fe-secure-openssl.c.html#LN70"><span class='Ref_to_Proto'>SSLerrmessage</span></a><span class='Parentheses'>(</span>ERR_get_error<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
            <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>               <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"could not load private key file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                              <a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN1248"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="fe-secure-openssl.c.html#LN71"><span class='Ref_to_Proto'>SSLerrfree</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1248"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if have_cert&&fnbuf[0]!=... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* verify that the cert and key go together */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN897"><span class='Ref_To_Local'>have_cert</span></a> <span class='Operator'>&& 
</span>        SSL_check_private_key<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN462"><span class='Ref_to_Member'>ssl</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1262"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>err</span> <span class='Operator'>= </span><a href="fe-secure-openssl.c.html#LN70"><span class='Ref_to_Proto'>SSLerrmessage</span></a><span class='Parentheses'>(</span>ERR_get_error<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                          <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"certificate does not match private key file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                          <a href="fe-secure-openssl.c.html#LN894"><span class='Ref_To_Local'>fnbuf</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN1262"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="fe-secure-openssl.c.html#LN71"><span class='Ref_to_Proto'>SSLerrfree</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1262"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If a root cert was loaded, also set our certificate verification 
     * callback. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN898"><span class='Ref_To_Local'>have_rootcert</span></a><span class='Parentheses'>) 
</span>        SSL_set_verify<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN462"><span class='Ref_to_Member'>ssl</span></a><span class='Delimiter'>, </span>SSL_VERIFY_PEER<span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN63"><span class='Ref_to_Proto'>verify_cb</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the OpenSSL version used supports it (from 1.0.0 on) and the user 
     * requested it, disable SSL compression. 
     */ 
</span><span class='Directive'>#ifdef</span> SSL_OP_NO_COMPRESSION 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN351"><span class='Ref_to_Member'>sslcompression</span></a> <span class='Operator'>&& </span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN351"><span class='Ref_to_Member'>sslcompression</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'0'</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        SSL_set_options<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN889"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN462"><span class='Ref_to_Member'>ssl</span></a><span class='Delimiter'>, </span>SSL_OP_NO_COMPRESSION<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end initialize_SSL &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  Attempt to negotiate SSL connection. 
 */ 
</span><span class='Keyword'>static </span><a href="libpq-fe.h.html#LN71"><span class='Ref_to_Typedef'>PostgresPollingStatusType</span></a> 
<a name="LN1296"></a><span class='Declare_Function'>open_client_SSL</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1298"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>r</span><span class='Delimiter'>; 
</span> 
    ERR_clear_error<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="fe-secure-openssl.c.html#LN1298"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span>SSL_connect<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1296"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN462"><span class='Ref_to_Member'>ssl</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1298"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1304"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>err</span> <span class='Operator'>= </span>SSL_get_error<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1296"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN462"><span class='Ref_to_Member'>ssl</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN1298"><span class='Ref_To_Local'>r</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1305"></a>        <span class='Keyword'>unsigned long </span><span class='Declare_Local'>ecode</span><span class='Delimiter'>; 
</span> 
        <a href="fe-secure-openssl.c.html#LN1305"><span class='Ref_To_Local'>ecode</span></a> <span class='Operator'>= </span>ERR_get_error<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1304"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> SSL_ERROR_WANT_READ<span class='Operator'>: 
</span>                <span class='Control'>return</span> <a href="libpq-fe.h.html#LN74"><span class='Ref_to_EnumConst'>PGRES_POLLING_READING</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> SSL_ERROR_WANT_WRITE<span class='Operator'>: 
</span>                <span class='Control'>return</span> <a href="libpq-fe.h.html#LN75"><span class='Ref_to_EnumConst'>PGRES_POLLING_WRITING</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> SSL_ERROR_SYSCALL<span class='Operator'>: 
</span>                <span class='Delimiter'>{ 
</span><a name="LN1318"></a>                    <span class='Keyword'>char</span>        <span class='Declare_Local'>sebuf</span><span class='Delimiter'>[</span><span class='Number'>256</span><span class='Delimiter'>]; 
</span> 
                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1298"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>                        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN1296"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                                    <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"SSL SYSCALL error: %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                            <a href="libpq-int.h.html#LN692"><span class='Ref_to_Const'>SOCK_STRERROR</span></a><span class='Parentheses'>(</span><a href="libpq-int.h.html#LN691"><span class='Ref_to_Const'>SOCK_ERRNO</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN1318"><span class='Ref_To_Local'>sebuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1318"><span class='Ref_To_Local'>sebuf</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                    <span class='Control'>else</span> 
                        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN1296"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                         <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"SSL SYSCALL error: EOF detected\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                    <a href="libpq-int.h.html#LN667"><span class='Ref_to_Proto'>pgtls_close</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1296"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <a href="libpq-fe.h.html#LN73"><span class='Ref_to_EnumConst'>PGRES_POLLING_FAILED</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Control'>case</span> SSL_ERROR_SSL<span class='Operator'>: 
</span>                <span class='Delimiter'>{ 
</span><a name="LN1332"></a>                    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>err</span> <span class='Operator'>= </span><a href="fe-secure-openssl.c.html#LN70"><span class='Ref_to_Proto'>SSLerrmessage</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1305"><span class='Ref_To_Local'>ecode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN1296"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                                      <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"SSL error: %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                      <a href="fe-secure-openssl.c.html#LN1332"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="fe-secure-openssl.c.html#LN71"><span class='Ref_to_Proto'>SSLerrfree</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1332"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="libpq-int.h.html#LN667"><span class='Ref_to_Proto'>pgtls_close</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1296"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <a href="libpq-fe.h.html#LN73"><span class='Ref_to_EnumConst'>PGRES_POLLING_FAILED</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
            <span class='Control'>default</span><span class='Operator'>: 
</span>                <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN1296"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                          <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"unrecognized SSL error code: %d\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                  <a href="fe-secure-openssl.c.html#LN1304"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="libpq-int.h.html#LN667"><span class='Ref_to_Proto'>pgtls_close</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1296"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <a href="libpq-fe.h.html#LN73"><span class='Ref_to_EnumConst'>PGRES_POLLING_FAILED</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch err &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if r&LT;=0 &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * We already checked the server certificate in initialize_SSL() using 
     * SSL_CTX_set_verify(), if root.crt exists. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* get server certificate */ 
</span>    <a href="fe-secure-openssl.c.html#LN1296"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN463"><span class='Ref_to_Member'>peer</span></a> <span class='Operator'>= </span>SSL_get_peer_certificate<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1296"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN462"><span class='Ref_to_Member'>ssl</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1296"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN463"><span class='Ref_to_Member'>peer</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1360"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>err</span><span class='Delimiter'>; 
</span> 
        <a href="fe-secure-openssl.c.html#LN1360"><span class='Ref_To_Local'>err</span></a> <span class='Operator'>= </span><a href="fe-secure-openssl.c.html#LN70"><span class='Ref_to_Proto'>SSLerrmessage</span></a><span class='Parentheses'>(</span>ERR_get_error<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
        <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN1296"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                    <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"certificate could not be obtained: %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                          <a href="fe-secure-openssl.c.html#LN1360"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="fe-secure-openssl.c.html#LN71"><span class='Ref_to_Proto'>SSLerrfree</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1360"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="libpq-int.h.html#LN667"><span class='Ref_to_Proto'>pgtls_close</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1296"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="libpq-fe.h.html#LN73"><span class='Ref_to_EnumConst'>PGRES_POLLING_FAILED</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fe-secure-openssl.c.html#LN62"><span class='Ref_to_Proto'>verify_peer_name_matches_certificate</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1296"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="libpq-int.h.html#LN667"><span class='Ref_to_Proto'>pgtls_close</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1296"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="libpq-fe.h.html#LN73"><span class='Ref_to_EnumConst'>PGRES_POLLING_FAILED</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* SSL handshake is complete */ 
</span>    <span class='Control'>return</span> <a href="libpq-fe.h.html#LN76"><span class='Ref_to_EnumConst'>PGRES_POLLING_OK</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end open_client_SSL &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  Close SSL connection. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1386"></a><span class='Declare_Function'>pgtls_close</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1388"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>destroy_needed</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1386"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN462"><span class='Ref_to_Member'>ssl</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * We can't destroy everything SSL-related here due to the possible 
         * later calls to OpenSSL routines which may need our thread 
         * callbacks, so set a flag here and check at the end. 
         */ 
</span>        <a href="fe-secure-openssl.c.html#LN1388"><span class='Ref_To_Local'>destroy_needed</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
        SSL_shutdown<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1386"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN462"><span class='Ref_to_Member'>ssl</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        SSL_free<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1386"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN462"><span class='Ref_to_Member'>ssl</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="fe-secure-openssl.c.html#LN1386"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN462"><span class='Ref_to_Member'>ssl</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="fe-secure-openssl.c.html#LN1386"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN460"><span class='Ref_to_Member'>ssl_in_use</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1386"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN463"><span class='Ref_to_Member'>peer</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        X509_free<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1386"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN463"><span class='Ref_to_Member'>peer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="fe-secure-openssl.c.html#LN1386"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN463"><span class='Ref_to_Member'>peer</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
<span class='Directive'>#ifdef</span> <a href="libpq-int.h.html#LN78"><span class='Ref_to_Const'>USE_SSL_ENGINE</span></a> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1386"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN465"><span class='Ref_to_Member'>engine</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        ENGINE_finish<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1386"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN465"><span class='Ref_to_Member'>engine</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        ENGINE_free<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1386"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN465"><span class='Ref_to_Member'>engine</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="fe-secure-openssl.c.html#LN1386"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN465"><span class='Ref_to_Member'>engine</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * This will remove our SSL locking hooks, if this is the last SSL 
     * connection, which means we must wait to call it until after all SSL 
     * calls have been made, otherwise we can end up with a race condition and 
     * possible deadlocks. 
     * 
     * See comments above destroy_ssl_system(). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1388"><span class='Ref_To_Local'>destroy_needed</span></a><span class='Parentheses'>) 
</span>        <a href="fe-secure-openssl.c.html#LN67"><span class='Ref_to_Proto'>destroy_ssl_system</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgtls_close &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Obtain reason string for passed SSL errcode 
 * 
 * ERR_get_error() is used by caller to get errcode to pass here. 
 * 
 * Some caution is needed here since ERR_reason_error_string will 
 * return NULL if it doesn't recognize the error code.  We don't 
 * want to return NULL ever. 
 */ 
</span><a name="LN1442"></a><span class='Keyword'>static char </span><span class='Declare_Var'>ssl_nomem</span><span class='Delimiter'>[] </span><span class='Operator'>= </span><span class='String'>"out of memory allocating error description"</span><span class='Delimiter'>; 
</span> 
<a name="LN1444"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>SSL_ERR_LEN</span> <span class='Number'>128</span> 
 
<span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN1447"></a><span class='Declare_Function'>SSLerrmessage</span><span class='Parentheses'>(</span><span class='Keyword'>unsigned long </span><span class='Declare_Parameter'>ecode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1449"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>errreason</span><span class='Delimiter'>; 
</span><a name="LN1450"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>errbuf</span><span class='Delimiter'>; 
</span> 
    <a href="fe-secure-openssl.c.html#LN1450"><span class='Ref_To_Local'>errbuf</span></a> <span class='Operator'>= </span><a href="../../include/snowball/header.h.html#LN49"><span class='Ref_to_Macro'>malloc</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1444"><span class='Ref_to_Const'>SSL_ERR_LEN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fe-secure-openssl.c.html#LN1450"><span class='Ref_To_Local'>errbuf</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="fe-secure-openssl.c.html#LN1442"><span class='Ref_to_Global_Var'>ssl_nomem</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1447"><span class='Ref_to_Parameter'>ecode</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1450"><span class='Ref_To_Local'>errbuf</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN1444"><span class='Ref_to_Const'>SSL_ERR_LEN</span></a><span class='Delimiter'>, </span><a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"no SSL error reported"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="fe-secure-openssl.c.html#LN1450"><span class='Ref_To_Local'>errbuf</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="fe-secure-openssl.c.html#LN1449"><span class='Ref_To_Local'>errreason</span></a> <span class='Operator'>= </span>ERR_reason_error_string<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1447"><span class='Ref_to_Parameter'>ecode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1449"><span class='Ref_To_Local'>errreason</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1450"><span class='Ref_To_Local'>errbuf</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN1449"><span class='Ref_To_Local'>errreason</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN1444"><span class='Ref_to_Const'>SSL_ERR_LEN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="fe-secure-openssl.c.html#LN1450"><span class='Ref_To_Local'>errbuf</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1450"><span class='Ref_To_Local'>errbuf</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN1444"><span class='Ref_to_Const'>SSL_ERR_LEN</span></a><span class='Delimiter'>, </span><a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"SSL error code %lu"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN1447"><span class='Ref_to_Parameter'>ecode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="fe-secure-openssl.c.html#LN1450"><span class='Ref_To_Local'>errbuf</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end SSLerrmessage &raquo; </span> 
 
<span class='Keyword'>static void 
</span><a name="LN1471"></a><span class='Declare_Function'>SSLerrfree</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>buf</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1471"><span class='Ref_to_Parameter'>buf</span></a> <span class='Operator'>!= </span><a href="fe-secure-openssl.c.html#LN1442"><span class='Ref_to_Global_Var'>ssl_nomem</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1471"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* ------------------------------------------------------------ */ 
/*                  SSL information functions                   */ 
/* ------------------------------------------------------------ */ 
</span> 
<span class='Keyword'>int 
</span><a name="LN1482"></a><span class='Declare_Function'>PQsslInUse</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fe-secure-openssl.c.html#LN1482"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="fe-secure-openssl.c.html#LN1482"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN460"><span class='Ref_to_Member'>ssl_in_use</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  Return pointer to OpenSSL object. 
 */ 
</span><span class='Keyword'>void </span><span class='Operator'>* 
</span><a name="LN1493"></a><span class='Declare_Function'>PQgetssl</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fe-secure-openssl.c.html#LN1493"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="fe-secure-openssl.c.html#LN1493"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN462"><span class='Ref_to_Member'>ssl</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>void </span><span class='Operator'>* 
</span><a name="LN1501"></a><span class='Declare_Function'>PQsslStruct</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>struct_name</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fe-secure-openssl.c.html#LN1501"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1501"><span class='Ref_to_Parameter'>struct_name</span></a><span class='Delimiter'>, </span><span class='String'>"OpenSSL"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <a href="fe-secure-openssl.c.html#LN1501"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN462"><span class='Ref_to_Member'>ssl</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Keyword'>const </span><span class='Operator'>* 
</span><a name="LN1511"></a><span class='Declare_Function'>PQsslAttributeNames</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1513"></a>    <span class='Keyword'>static const char </span><span class='Operator'>*</span><span class='Keyword'>const </span><span class='Declare_Local'>result</span><span class='Delimiter'>[] </span><span class='Operator'>= </span><span class='Delimiter'>{ 
</span>        <span class='String'>"library"</span><span class='Delimiter'>, 
</span>        <span class='String'>"key_bits"</span><span class='Delimiter'>, 
</span>        <span class='String'>"cipher"</span><span class='Delimiter'>, 
</span>        <span class='String'>"compression"</span><span class='Delimiter'>, 
</span>        <span class='String'>"protocol"</span><span class='Delimiter'>, 
</span>        <span class='Null_Value'>NULL 
</span>    <span class='Delimiter'>}; 
</span> 
    <span class='Control'>return</span> <a href="fe-secure-openssl.c.html#LN1513"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>const char </span><span class='Operator'>* 
</span><a name="LN1526"></a><span class='Declare_Function'>PQsslAttribute</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>attribute_name</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fe-secure-openssl.c.html#LN1526"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1526"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN462"><span class='Ref_to_Member'>ssl</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1526"><span class='Ref_to_Parameter'>attribute_name</span></a><span class='Delimiter'>, </span><span class='String'>"library"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='String'>"OpenSSL"</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1526"><span class='Ref_to_Parameter'>attribute_name</span></a><span class='Delimiter'>, </span><span class='String'>"key_bits"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1538"></a>        <span class='Keyword'>static char </span><span class='Declare_Local'>sslbits_str</span><span class='Delimiter'>[</span><span class='Number'>10</span><span class='Delimiter'>]; 
</span><a name="LN1539"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>sslbits</span><span class='Delimiter'>; 
</span> 
        SSL_get_cipher_bits<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1526"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN462"><span class='Ref_to_Member'>ssl</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fe-secure-openssl.c.html#LN1539"><span class='Ref_To_Local'>sslbits</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1538"><span class='Ref_To_Local'>sslbits_str</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1538"><span class='Ref_To_Local'>sslbits_str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%d"</span><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN1539"><span class='Ref_To_Local'>sslbits</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="fe-secure-openssl.c.html#LN1538"><span class='Ref_To_Local'>sslbits_str</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1526"><span class='Ref_to_Parameter'>attribute_name</span></a><span class='Delimiter'>, </span><span class='String'>"cipher"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> SSL_get_cipher<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1526"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN462"><span class='Ref_to_Member'>ssl</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1526"><span class='Ref_to_Parameter'>attribute_name</span></a><span class='Delimiter'>, </span><span class='String'>"compression"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <a href="../../include/port.h.html#LN418"><span class='Ref_to_Macro'>SSL_get_current_compression</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1526"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN462"><span class='Ref_to_Member'>ssl</span></a><span class='Parentheses'>) </span><span class='Operator'>? </span><span class='String'>"on"</span> <span class='Operator'>: </span><span class='String'>"off"</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1526"><span class='Ref_to_Parameter'>attribute_name</span></a><span class='Delimiter'>, </span><span class='String'>"protocol"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> SSL_get_version<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1526"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN462"><span class='Ref_to_Member'>ssl</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>                <span class='Comment_Single_Line'>/* unknown attribute */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end PQsslAttribute &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Private substitute BIO: this does the sending and receiving using 
 * pqsecure_raw_write() and pqsecure_raw_read() instead, to allow those 
 * functions to disable SIGPIPE and give better error messages on I/O errors. 
 * 
 * These functions are closely modelled on the standard socket BIO in OpenSSL; 
 * see sock_read() and sock_write() in OpenSSL's crypto/bio/bss_sock.c. 
 * XXX OpenSSL 1.0.1e considers many more errcodes than just EINTR as reasons 
 * to retry; do we need to adopt their logic for that? 
 */ 
</span> 
<span class='Directive'>#ifndef</span> HAVE_BIO_GET_DATA 
<a name="LN1570"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>BIO_get_data</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>bio</span><span class='Parentheses'>) (</span><a href="fe-secure-openssl.c.html#LN1570"><span class='Ref_to_Parameter'>bio</span></a><span class='Operator'>-&GT;</span>ptr<span class='Parentheses'>) 
</span><a name="LN1571"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>BIO_set_data</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>bio</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>data</span><span class='Parentheses'>) (</span><a href="fe-secure-openssl.c.html#LN1571"><span class='Ref_to_Parameter'>bio</span></a><span class='Operator'>-&GT;</span>ptr <span class='Operator'>= </span><a href="fe-secure-openssl.c.html#LN1571"><span class='Ref_to_Parameter'>data</span></a><span class='Parentheses'>) 
</span><span class='Directive'>#endif</span> 
 
<a name="LN1574"></a><span class='Keyword'>static </span>BIO_METHOD <span class='Operator'>*</span><span class='Declare_Var'>my_bio_methods</span><span class='Delimiter'>; 
</span> 
<span class='Keyword'>static int 
</span><a name="LN1577"></a><span class='Declare_Function'>my_sock_read</span><span class='Parentheses'>(</span>BIO <span class='Operator'>*</span><span class='Declare_Parameter'>h</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>size</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1579"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span> 
    <a href="fe-secure-openssl.c.html#LN1579"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="fe-secure.c.html#LN222"><span class='Ref_to_Func'>pqsecure_raw_read</span></a><span class='Parentheses'>((</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../backend/libpq/be-secure-openssl.c.html#LN787"><span class='Ref_to_Macro'>BIO_get_data</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1577"><span class='Ref_to_Parameter'>h</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN1577"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN1577"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    BIO_clear_retry_flags<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1577"><span class='Ref_to_Parameter'>h</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1579"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* If we were interrupted, tell caller to retry */ 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="libpq-int.h.html#LN691"><span class='Ref_to_Const'>SOCK_ERRNO</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/port/win32.h.html#LN282"><span class='Ref_to_Const'>EAGAIN</span></a> 
            <span class='Control'>case</span> <a href="../../include/port/win32.h.html#LN282"><span class='Ref_to_Const'>EAGAIN</span></a><span class='Operator'>: 
</span><span class='Directive'>#endif</span> 
<span class='Directive'>#if</span> defined<span class='Parentheses'>(</span><a href="win32.h.html#LN19"><span class='Ref_to_Const'>EWOULDBLOCK</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><span class='Parentheses'>(</span><span class='Operator'>!</span>defined<span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN282"><span class='Ref_to_Const'>EAGAIN</span></a><span class='Parentheses'>) </span><span class='Operator'>|| </span><span class='Parentheses'>(</span><a href="win32.h.html#LN19"><span class='Ref_to_Const'>EWOULDBLOCK</span></a> <span class='Operator'>!= </span><a href="../../include/port/win32.h.html#LN282"><span class='Ref_to_Const'>EAGAIN</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>case</span> <a href="win32.h.html#LN19"><span class='Ref_to_Const'>EWOULDBLOCK</span></a><span class='Operator'>: 
</span><span class='Directive'>#endif</span> 
            <span class='Control'>case</span> <a href="win32.h.html#LN17"><span class='Ref_to_Const'>EINTR</span></a><span class='Operator'>: 
</span>                BIO_set_retry_read<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1577"><span class='Ref_to_Parameter'>h</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>default</span><span class='Operator'>: 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="fe-secure-openssl.c.html#LN1579"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end my_sock_read &raquo; </span> 
 
<span class='Keyword'>static int 
</span><a name="LN1607"></a><span class='Declare_Function'>my_sock_write</span><span class='Parentheses'>(</span>BIO <span class='Operator'>*</span><span class='Declare_Parameter'>h</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>size</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1609"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span> 
    <a href="fe-secure-openssl.c.html#LN1609"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="fe-secure.c.html#LN299"><span class='Ref_to_Func'>pqsecure_raw_write</span></a><span class='Parentheses'>((</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../backend/libpq/be-secure-openssl.c.html#LN787"><span class='Ref_to_Macro'>BIO_get_data</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1607"><span class='Ref_to_Parameter'>h</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN1607"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN1607"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    BIO_clear_retry_flags<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1607"><span class='Ref_to_Parameter'>h</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1609"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* If we were interrupted, tell caller to retry */ 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="libpq-int.h.html#LN691"><span class='Ref_to_Const'>SOCK_ERRNO</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/port/win32.h.html#LN282"><span class='Ref_to_Const'>EAGAIN</span></a> 
            <span class='Control'>case</span> <a href="../../include/port/win32.h.html#LN282"><span class='Ref_to_Const'>EAGAIN</span></a><span class='Operator'>: 
</span><span class='Directive'>#endif</span> 
<span class='Directive'>#if</span> defined<span class='Parentheses'>(</span><a href="win32.h.html#LN19"><span class='Ref_to_Const'>EWOULDBLOCK</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><span class='Parentheses'>(</span><span class='Operator'>!</span>defined<span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN282"><span class='Ref_to_Const'>EAGAIN</span></a><span class='Parentheses'>) </span><span class='Operator'>|| </span><span class='Parentheses'>(</span><a href="win32.h.html#LN19"><span class='Ref_to_Const'>EWOULDBLOCK</span></a> <span class='Operator'>!= </span><a href="../../include/port/win32.h.html#LN282"><span class='Ref_to_Const'>EAGAIN</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>case</span> <a href="win32.h.html#LN19"><span class='Ref_to_Const'>EWOULDBLOCK</span></a><span class='Operator'>: 
</span><span class='Directive'>#endif</span> 
            <span class='Control'>case</span> <a href="win32.h.html#LN17"><span class='Ref_to_Const'>EINTR</span></a><span class='Operator'>: 
</span>                BIO_set_retry_write<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1607"><span class='Ref_to_Parameter'>h</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>default</span><span class='Operator'>: 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="fe-secure-openssl.c.html#LN1609"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end my_sock_write &raquo; </span> 
 
<span class='Keyword'>static </span>BIO_METHOD <span class='Operator'>* 
</span><a name="LN1637"></a><span class='Declare_Function'>my_BIO_s_socket</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../backend/libpq/be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1641"></a>        BIO_METHOD <span class='Operator'>*</span><span class='Declare_Local'>biom</span> <span class='Operator'>= </span><span class='Parentheses'>(</span>BIO_METHOD <span class='Operator'>*</span><span class='Parentheses'>) </span>BIO_s_socket<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> HAVE_BIO_METH_NEW 
<a name="LN1643"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>my_bio_index</span><span class='Delimiter'>; 
</span> 
        <a href="fe-secure-openssl.c.html#LN1643"><span class='Ref_To_Local'>my_bio_index</span></a> <span class='Operator'>= </span>BIO_get_new_index<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1643"><span class='Ref_To_Local'>my_bio_index</span></a> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="../../backend/libpq/be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a> <span class='Operator'>= </span>BIO_meth_new<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1643"><span class='Ref_To_Local'>my_bio_index</span></a><span class='Delimiter'>, </span><span class='String'>"libpq socket"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../backend/libpq/be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * As of this writing, these functions never fail. But check anyway, 
         * like OpenSSL's own examples do. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>BIO_meth_set_write<span class='Parentheses'>(</span><a href="../../backend/libpq/be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a><span class='Delimiter'>, </span><a href="../../backend/libpq/be-secure-openssl.c.html#LN69"><span class='Ref_to_Proto'>my_sock_write</span></a><span class='Parentheses'>)</span> <span class='Operator'>|| 
</span>            <span class='Operator'>!</span>BIO_meth_set_read<span class='Parentheses'>(</span><a href="../../backend/libpq/be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a><span class='Delimiter'>, </span><a href="../../backend/libpq/be-secure-openssl.c.html#LN68"><span class='Ref_to_Proto'>my_sock_read</span></a><span class='Parentheses'>)</span> <span class='Operator'>|| 
</span>            <span class='Operator'>!</span>BIO_meth_set_gets<span class='Parentheses'>(</span><a href="../../backend/libpq/be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a><span class='Delimiter'>, </span>BIO_meth_get_gets<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1641"><span class='Ref_To_Local'>biom</span></a><span class='Parentheses'>))</span> <span class='Operator'>|| 
</span>            <span class='Operator'>!</span>BIO_meth_set_puts<span class='Parentheses'>(</span><a href="../../backend/libpq/be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a><span class='Delimiter'>, </span>BIO_meth_get_puts<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1641"><span class='Ref_To_Local'>biom</span></a><span class='Parentheses'>))</span> <span class='Operator'>|| 
</span>            <span class='Operator'>!</span>BIO_meth_set_ctrl<span class='Parentheses'>(</span><a href="../../backend/libpq/be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a><span class='Delimiter'>, </span>BIO_meth_get_ctrl<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1641"><span class='Ref_To_Local'>biom</span></a><span class='Parentheses'>))</span> <span class='Operator'>|| 
</span>            <span class='Operator'>!</span>BIO_meth_set_create<span class='Parentheses'>(</span><a href="../../backend/libpq/be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a><span class='Delimiter'>, </span>BIO_meth_get_create<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1641"><span class='Ref_To_Local'>biom</span></a><span class='Parentheses'>))</span> <span class='Operator'>|| 
</span>         <span class='Operator'>!</span>BIO_meth_set_destroy<span class='Parentheses'>(</span><a href="../../backend/libpq/be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a><span class='Delimiter'>, </span>BIO_meth_get_destroy<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1641"><span class='Ref_To_Local'>biom</span></a><span class='Parentheses'>))</span> <span class='Operator'>|| 
</span>            <span class='Operator'>!</span>BIO_meth_set_callback_ctrl<span class='Parentheses'>(</span><a href="../../backend/libpq/be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a><span class='Delimiter'>, </span>BIO_meth_get_callback_ctrl<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1641"><span class='Ref_To_Local'>biom</span></a><span class='Parentheses'>)))</span> 
        <span class='Delimiter'>{ 
</span>            BIO_meth_free<span class='Parentheses'>(</span><a href="../../backend/libpq/be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../backend/libpq/be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span><span class='Directive'>#else</span> 
        <a href="../../backend/libpq/be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a> <span class='Operator'>= </span><a href="../../include/snowball/header.h.html#LN49"><span class='Ref_to_Macro'>malloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span>BIO_METHOD<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../backend/libpq/be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        memcpy<span class='Parentheses'>(</span><a href="../../backend/libpq/be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN1641"><span class='Ref_To_Local'>biom</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span>BIO_METHOD<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../backend/libpq/be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a><span class='Operator'>-&GT;</span>bread <span class='Operator'>= </span><a href="../../backend/libpq/be-secure-openssl.c.html#LN68"><span class='Ref_to_Proto'>my_sock_read</span></a><span class='Delimiter'>; 
</span>        <a href="../../backend/libpq/be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a><span class='Operator'>-&GT;</span>bwrite <span class='Operator'>= </span><a href="../../backend/libpq/be-secure-openssl.c.html#LN69"><span class='Ref_to_Proto'>my_sock_write</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !my_bio_methods &raquo; </span> 
    <span class='Control'>return</span> <a href="../../backend/libpq/be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end my_BIO_s_socket &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* This should exactly match openssl's SSL_set_fd except for using my BIO */ 
</span><span class='Keyword'>static int 
</span><a name="LN1683"></a><span class='Declare_Function'>my_SSL_set_fd</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>fd</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1685"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ret</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1686"></a>    BIO        <span class='Operator'>*</span><span class='Declare_Local'>bio</span><span class='Delimiter'>; 
</span><a name="LN1687"></a>    BIO_METHOD <span class='Operator'>*</span><span class='Declare_Local'>bio_method</span><span class='Delimiter'>; 
</span> 
    <a href="fe-secure-openssl.c.html#LN1687"><span class='Ref_To_Local'>bio_method</span></a> <span class='Operator'>= </span><a href="../../backend/libpq/be-secure-openssl.c.html#LN70"><span class='Ref_to_Proto'>my_BIO_s_socket</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1687"><span class='Ref_To_Local'>bio_method</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        SSLerr<span class='Parentheses'>(</span>SSL_F_SSL_SET_FD<span class='Delimiter'>, </span>ERR_R_BUF_LIB<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="fe-secure-openssl.c.html#LN1706"><span class='Ref_to_Label'>err</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="fe-secure-openssl.c.html#LN1686"><span class='Ref_To_Local'>bio</span></a> <span class='Operator'>= </span>BIO_new<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1687"><span class='Ref_To_Local'>bio_method</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1686"><span class='Ref_To_Local'>bio</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        SSLerr<span class='Parentheses'>(</span>SSL_F_SSL_SET_FD<span class='Delimiter'>, </span>ERR_R_BUF_LIB<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="fe-secure-openssl.c.html#LN1706"><span class='Ref_to_Label'>err</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../backend/libpq/be-secure-openssl.c.html#LN788"><span class='Ref_to_Macro'>BIO_set_data</span></a><span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1686"><span class='Ref_To_Local'>bio</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN1683"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    SSL_set_bio<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1683"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN462"><span class='Ref_to_Member'>ssl</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN1686"><span class='Ref_To_Local'>bio</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN1686"><span class='Ref_To_Local'>bio</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    BIO_set_fd<span class='Parentheses'>(</span><a href="fe-secure-openssl.c.html#LN1686"><span class='Ref_To_Local'>bio</span></a><span class='Delimiter'>, </span><a href="fe-secure-openssl.c.html#LN1683"><span class='Ref_to_Parameter'>fd</span></a><span class='Delimiter'>, </span>BIO_NOCLOSE<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="fe-secure-openssl.c.html#LN1685"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span><a name="LN1706"></a><span class='Label'>err</span><span class='Operator'>: 
</span>    <span class='Control'>return</span> <a href="fe-secure-openssl.c.html#LN1685"><span class='Ref_To_Local'>ret</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end my_SSL_set_fd &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>