<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\interfaces\libpq\fe-secure.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\interfaces\libpq\fe-secure.c</b></p></td>
<td align='right'>
Wed Jun 14 08:26:11 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * fe-secure.c 
 *    functions related to setting up a secure connection to the backend. 
 *    Secure connections are expected to provide confidentiality, 
 *    message integrity and endpoint authentication. 
 * 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/interfaces/libpq/fe-secure.c 
 * 
 * NOTES 
 * 
 *    We don't provide informational callbacks here (like 
 *    info_cb() in be-secure.c), since there's no good mechanism to 
 *    display such information to the user. 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres_fe.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;signal.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;fcntl.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;ctype.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"libpq-fe.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"fe-auth.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"libpq-int.h"</span> 
 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<span class='Keyword'>#include </span><span class='String'>"win32.h"</span> 
<span class='Directive'>#else</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/socket.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;netdb.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;netinet/in.h&GT;</span> 
<span class='Directive'>#ifdef</span> HAVE_NETINET_TCP_H 
<span class='Keyword'>#include </span><span class='String'>&LT;netinet/tcp.h&GT;</span> 
<span class='Directive'>#endif</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;arpa/inet.h&GT;</span> 
<span class='Directive'>#endif</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/stat.h&GT;</span> 
 
<span class='Directive'>#ifdef</span> ENABLE_THREAD_SAFETY 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<span class='Keyword'>#include </span><span class='String'>"pthread-win32.h"</span> 
<span class='Directive'>#else</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;pthread.h&GT;</span> 
<span class='Directive'>#endif</span> 
<span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Macros to handle disabling and then restoring the state of SIGPIPE handling. 
 * On Windows, these are all no-ops since there's no SIGPIPEs. 
 */ 
</span> 
<span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
 
<a name="LN64"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>SIGPIPE_MASKED</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>conn</span><span class='Parentheses'>)</span>    <span class='Parentheses'>((</span><a href="fe-secure.c.html#LN64"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN409"><span class='Ref_to_Member'>sigpipe_so</span></a> <span class='Operator'>|| </span><span class='Parentheses'>(</span><a href="fe-secure.c.html#LN64"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>sigpipe_flag<span class='Parentheses'>)</span> 
 
<span class='Directive'>#ifdef</span> ENABLE_THREAD_SAFETY 
 
<a name="LN68"></a><span class='Control'>struct</span> <span class='Declare_Struct'>sigpipe_info</span> 
<span class='Delimiter'>{ 
</span><a name="LN70"></a>    <a href="../../include/libpq/pqsignal.h.html#LN21"><span class='Ref_to_Typedef'>sigset_t</span></a>    <span class='Declare_Member'>oldsigmask</span><span class='Delimiter'>; 
</span><a name="LN71"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>sigpipe_pending</span><span class='Delimiter'>; 
</span><a name="LN72"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>got_epipe</span><span class='Delimiter'>; 
}; 
</span> 
<a name="LN75"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>DECLARE_SIGPIPE_INFO</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>spinfo</span><span class='Parentheses'>) </span><span class='Control'>struct</span> <a href="fe-secure.c.html#LN68"><span class='Ref_to_Struct'>sigpipe_info</span></a> <a href="fe-secure.c.html#LN75"><span class='Ref_to_Parameter'>spinfo</span></a> 
 
<a name="LN77"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>DISABLE_SIGPIPE</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>spinfo</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>failaction</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Control'>do</span> <span class='Delimiter'>{ </span><span class='Operator'>\ 
</span>        <span class='Parentheses'>(</span><a href="fe-secure.c.html#LN77"><span class='Ref_to_Parameter'>spinfo</span></a><span class='Parentheses'>)</span><span class='Operator'>.</span>got_epipe <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fe-secure.c.html#LN64"><span class='Ref_to_Macro'>SIGPIPE_MASKED</span></a><span class='Parentheses'>(</span><a href="fe-secure.c.html#LN77"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span> <span class='Operator'>\ 
</span>        <span class='Delimiter'>{ </span><span class='Operator'>\ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure.c.html#LN426"><span class='Ref_to_Func'>pq_block_sigpipe</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="fe-secure.c.html#LN77"><span class='Ref_to_Parameter'>spinfo</span></a><span class='Parentheses'>)</span><span class='Operator'>.</span>oldsigmask<span class='Delimiter'>, </span><span class='Operator'>\ 
</span>                                 <span class='Operator'>&</span><span class='Parentheses'>(</span><a href="fe-secure.c.html#LN77"><span class='Ref_to_Parameter'>spinfo</span></a><span class='Parentheses'>)</span><span class='Operator'>.</span>sigpipe_pending<span class='Parentheses'>)</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> <span class='Operator'>\ 
</span>                <a href="fe-secure.c.html#LN77"><span class='Ref_to_Parameter'>failaction</span></a><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>        <span class='Delimiter'>} </span><span class='Operator'>\ 
</span>    <span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>) 
</span> 
<a name="LN88"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>REMEMBER_EPIPE</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>spinfo</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>cond</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Control'>do</span> <span class='Delimiter'>{ </span><span class='Operator'>\ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure.c.html#LN88"><span class='Ref_to_Parameter'>cond</span></a><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>            <span class='Parentheses'>(</span><a href="fe-secure.c.html#LN88"><span class='Ref_to_Parameter'>spinfo</span></a><span class='Parentheses'>)</span><span class='Operator'>.</span>got_epipe <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>    <span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>) 
</span> 
<a name="LN94"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>RESTORE_SIGPIPE</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>spinfo</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Control'>do</span> <span class='Delimiter'>{ </span><span class='Operator'>\ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fe-secure.c.html#LN64"><span class='Ref_to_Macro'>SIGPIPE_MASKED</span></a><span class='Parentheses'>(</span><a href="fe-secure.c.html#LN94"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span> <span class='Operator'>\ 
</span>            <a href="fe-secure.c.html#LN476"><span class='Ref_to_Func'>pq_reset_sigpipe</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="fe-secure.c.html#LN94"><span class='Ref_to_Parameter'>spinfo</span></a><span class='Parentheses'>)</span><span class='Operator'>.</span>oldsigmask<span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="fe-secure.c.html#LN94"><span class='Ref_to_Parameter'>spinfo</span></a><span class='Parentheses'>)</span><span class='Operator'>.</span>sigpipe_pending<span class='Delimiter'>, </span><span class='Operator'>\ 
</span>                             <span class='Parentheses'>(</span><a href="fe-secure.c.html#LN94"><span class='Ref_to_Parameter'>spinfo</span></a><span class='Parentheses'>)</span><span class='Operator'>.</span>got_epipe<span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>    <span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>) 
</span><span class='Directive'>#else</span>                           <span class='Comment_Single_Line'>/* !ENABLE_THREAD_SAFETY */ 
</span> 
<a name="LN102"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>DECLARE_SIGPIPE_INFO</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>spinfo</span><span class='Parentheses'>) </span><a href="../../include/port.h.html#LN469"><span class='Ref_to_Typedef'>pqsigfunc</span></a> <a href="fe-secure.c.html#LN102"><span class='Ref_to_Parameter'>spinfo</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL 
</span> 
<a name="LN104"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>DISABLE_SIGPIPE</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>spinfo</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>failaction</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Control'>do</span> <span class='Delimiter'>{ </span><span class='Operator'>\ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fe-secure.c.html#LN64"><span class='Ref_to_Macro'>SIGPIPE_MASKED</span></a><span class='Parentheses'>(</span><a href="fe-secure.c.html#LN104"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span> <span class='Operator'>\ 
</span>            <a href="fe-secure.c.html#LN104"><span class='Ref_to_Parameter'>spinfo</span></a> <span class='Operator'>= </span><a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN192"><span class='Ref_to_Const'>SIGPIPE</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN184"><span class='Ref_to_Const'>SIG_IGN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>    <span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>) 
</span> 
<a name="LN110"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>REMEMBER_EPIPE</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>spinfo</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>cond</span><span class='Parentheses'>) 
</span> 
<a name="LN112"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>RESTORE_SIGPIPE</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>spinfo</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Control'>do</span> <span class='Delimiter'>{ </span><span class='Operator'>\ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fe-secure.c.html#LN64"><span class='Ref_to_Macro'>SIGPIPE_MASKED</span></a><span class='Parentheses'>(</span><a href="fe-secure.c.html#LN112"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span> <span class='Operator'>\ 
</span>            <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN192"><span class='Ref_to_Const'>SIGPIPE</span></a><span class='Delimiter'>, </span><a href="fe-secure.c.html#LN112"><span class='Ref_to_Parameter'>spinfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>    <span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>) 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* ENABLE_THREAD_SAFETY */ 
</span><span class='Directive'>#else</span>                           <span class='Comment_Single_Line'>/* WIN32 */ 
</span> 
<a name="LN120"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>DECLARE_SIGPIPE_INFO</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>spinfo</span><span class='Parentheses'>) 
</span><a name="LN121"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>DISABLE_SIGPIPE</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>spinfo</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>failaction</span><span class='Parentheses'>) 
</span><a name="LN122"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>REMEMBER_EPIPE</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>spinfo</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>cond</span><span class='Parentheses'>) 
</span><a name="LN123"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>RESTORE_SIGPIPE</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>spinfo</span><span class='Parentheses'>) 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* WIN32 */ 
</span> 
<span class='Comment_Multi_Line'>/* ------------------------------------------------------------ */ 
/*           Procedures common to all secure sessions           */ 
/* ------------------------------------------------------------ */ 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 *  Exported function to allow application to tell us it's already 
 *  initialized OpenSSL. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN136"></a><span class='Declare_Function'>PQinitSSL</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>do_init</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/pg_config_manual.h.html#LN172"><span class='Ref_to_Const'>USE_SSL</span></a> 
    <a href="fe-secure-openssl.c.html#LN104"><span class='Ref_to_Func'>pgtls_init_library</span></a><span class='Parentheses'>(</span><a href="fe-secure.c.html#LN136"><span class='Ref_to_Parameter'>do_init</span></a><span class='Delimiter'>, </span><a href="fe-secure.c.html#LN136"><span class='Ref_to_Parameter'>do_init</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  Exported function to allow application to tell us it's already 
 *  initialized OpenSSL and/or libcrypto. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN148"></a><span class='Declare_Function'>PQinitOpenSSL</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>do_ssl</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>do_crypto</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/pg_config_manual.h.html#LN172"><span class='Ref_to_Const'>USE_SSL</span></a> 
    <a href="fe-secure-openssl.c.html#LN104"><span class='Ref_to_Func'>pgtls_init_library</span></a><span class='Parentheses'>(</span><a href="fe-secure.c.html#LN148"><span class='Ref_to_Parameter'>do_ssl</span></a><span class='Delimiter'>, </span><a href="fe-secure.c.html#LN148"><span class='Ref_to_Parameter'>do_crypto</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  Initialize global SSL context 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN159"></a><span class='Declare_Function'>pqsecure_initialize</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN161"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>r</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/pg_config_manual.h.html#LN172"><span class='Ref_to_Const'>USE_SSL</span></a> 
    <a href="fe-secure.c.html#LN161"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="libpq-int.h.html#LN665"><span class='Ref_to_Proto'>pgtls_init</span></a><span class='Parentheses'>(</span><a href="fe-secure.c.html#LN159"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Control'>return</span> <a href="fe-secure.c.html#LN161"><span class='Ref_To_Local'>r</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  Begin or continue negotiating a secure session. 
 */ 
</span><a href="libpq-fe.h.html#LN71"><span class='Ref_to_Typedef'>PostgresPollingStatusType</span></a> 
<a name="LN174"></a><span class='Declare_Function'>pqsecure_open_client</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/pg_config_manual.h.html#LN172"><span class='Ref_to_Const'>USE_SSL</span></a> 
    <span class='Control'>return</span> <a href="fe-secure-openssl.c.html#LN124"><span class='Ref_to_Func'>pgtls_open_client</span></a><span class='Parentheses'>(</span><a href="fe-secure.c.html#LN174"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
    <span class='Comment_Multi_Line'>/* shouldn't get here */ 
</span>    <span class='Control'>return</span> <a href="libpq-fe.h.html#LN73"><span class='Ref_to_EnumConst'>PGRES_POLLING_FAILED</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  Close secure session. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN188"></a><span class='Declare_Function'>pqsecure_close</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/pg_config_manual.h.html#LN172"><span class='Ref_to_Const'>USE_SSL</span></a> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure.c.html#LN188"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN460"><span class='Ref_to_Member'>ssl_in_use</span></a><span class='Parentheses'>) 
</span>        <a href="libpq-int.h.html#LN667"><span class='Ref_to_Proto'>pgtls_close</span></a><span class='Parentheses'>(</span><a href="fe-secure.c.html#LN188"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  Read data from a secure connection. 
 * 
 * On failure, this function is responsible for putting a suitable message 
 * into conn-&GT;errorMessage.  The caller must still inspect errno, but only 
 * to determine whether to continue/retry after error. 
 */ 
</span><a href="../../include/port/win32.h.html#LN419"><span class='Ref_to_Typedef'>ssize_t</span></a> 
<a name="LN204"></a><span class='Declare_Function'>pqsecure_read</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>ptr</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN206"></a>    <a href="../../include/port/win32.h.html#LN419"><span class='Ref_to_Typedef'>ssize_t</span></a>     <span class='Declare_Local'>n</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/pg_config_manual.h.html#LN172"><span class='Ref_to_Const'>USE_SSL</span></a> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure.c.html#LN204"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN460"><span class='Ref_to_Member'>ssl_in_use</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="fe-secure.c.html#LN206"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= </span><a href="fe-secure-openssl.c.html#LN162"><span class='Ref_to_Func'>pgtls_read</span></a><span class='Parentheses'>(</span><a href="fe-secure.c.html#LN204"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="fe-secure.c.html#LN204"><span class='Ref_to_Parameter'>ptr</span></a><span class='Delimiter'>, </span><a href="fe-secure.c.html#LN204"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
<span class='Directive'>#endif</span> 
    <span class='Delimiter'>{ 
</span>        <a href="fe-secure.c.html#LN206"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= </span><a href="fe-secure.c.html#LN222"><span class='Ref_to_Func'>pqsecure_raw_read</span></a><span class='Parentheses'>(</span><a href="fe-secure.c.html#LN204"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="fe-secure.c.html#LN204"><span class='Ref_to_Parameter'>ptr</span></a><span class='Delimiter'>, </span><a href="fe-secure.c.html#LN204"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="fe-secure.c.html#LN206"><span class='Ref_To_Local'>n</span></a><span class='Delimiter'>; 
} 
</span> 
<a href="../../include/port/win32.h.html#LN419"><span class='Ref_to_Typedef'>ssize_t</span></a> 
<a name="LN223"></a><span class='Declare_Function'>pqsecure_raw_read</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>ptr</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN225"></a>    <a href="../../include/port/win32.h.html#LN419"><span class='Ref_to_Typedef'>ssize_t</span></a>     <span class='Declare_Local'>n</span><span class='Delimiter'>; 
</span><a name="LN226"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>result_errno</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN227"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>sebuf</span><span class='Delimiter'>[</span><span class='Number'>256</span><span class='Delimiter'>]; 
</span> 
    <a href="fe-secure.c.html#LN225"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= </span><a href="../../include/port/win32.h.html#LN374"><span class='Ref_to_Macro'>recv</span></a><span class='Parentheses'>(</span><a href="fe-secure.c.html#LN223"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN399"><span class='Ref_to_Member'>sock</span></a><span class='Delimiter'>, </span><a href="fe-secure.c.html#LN223"><span class='Ref_to_Parameter'>ptr</span></a><span class='Delimiter'>, </span><a href="fe-secure.c.html#LN223"><span class='Ref_to_Parameter'>len</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure.c.html#LN225"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="fe-secure.c.html#LN226"><span class='Ref_To_Local'>result_errno</span></a> <span class='Operator'>= </span><a href="libpq-int.h.html#LN691"><span class='Ref_to_Const'>SOCK_ERRNO</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Set error message if appropriate */ 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="fe-secure.c.html#LN226"><span class='Ref_To_Local'>result_errno</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/port/win32.h.html#LN282"><span class='Ref_to_Const'>EAGAIN</span></a> 
            <span class='Control'>case</span> <a href="../../include/port/win32.h.html#LN282"><span class='Ref_to_Const'>EAGAIN</span></a><span class='Operator'>: 
</span><span class='Directive'>#endif</span> 
<span class='Directive'>#if</span> defined<span class='Parentheses'>(</span><a href="win32.h.html#LN19"><span class='Ref_to_Const'>EWOULDBLOCK</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><span class='Parentheses'>(</span><span class='Operator'>!</span>defined<span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN282"><span class='Ref_to_Const'>EAGAIN</span></a><span class='Parentheses'>) </span><span class='Operator'>|| </span><span class='Parentheses'>(</span><a href="win32.h.html#LN19"><span class='Ref_to_Const'>EWOULDBLOCK</span></a> <span class='Operator'>!= </span><a href="../../include/port/win32.h.html#LN282"><span class='Ref_to_Const'>EAGAIN</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>case</span> <a href="win32.h.html#LN19"><span class='Ref_to_Const'>EWOULDBLOCK</span></a><span class='Operator'>: 
</span><span class='Directive'>#endif</span> 
            <span class='Control'>case</span> <a href="win32.h.html#LN17"><span class='Ref_to_Const'>EINTR</span></a><span class='Operator'>: 
</span>                <span class='Comment_Multi_Line'>/* no error message, caller is expected to retry */ 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="win32.h.html#LN22"><span class='Ref_to_Const'>ECONNRESET</span></a> 
            <span class='Control'>case</span> <a href="win32.h.html#LN22"><span class='Ref_to_Const'>ECONNRESET</span></a><span class='Operator'>: 
</span>                <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure.c.html#LN223"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                                  <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>( 
</span>                                <span class='String'>"server closed the connection unexpectedly\n"</span> 
                   <span class='String'>"\tThis probably means the server terminated abnormally\n"</span> 
                             <span class='String'>"\tbefore or while processing the request.\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
            <span class='Control'>default</span><span class='Operator'>: 
</span>                <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure.c.html#LN223"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                   <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"could not receive data from server: %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                  <a href="libpq-int.h.html#LN692"><span class='Ref_to_Const'>SOCK_STRERROR</span></a><span class='Parentheses'>(</span><a href="fe-secure.c.html#LN226"><span class='Ref_To_Local'>result_errno</span></a><span class='Delimiter'>, 
</span>                                                <a href="fe-secure.c.html#LN227"><span class='Ref_To_Local'>sebuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fe-secure.c.html#LN227"><span class='Ref_To_Local'>sebuf</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch result_errno &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if n&LT;0 &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* ensure we return the intended errno to caller */ 
</span>    <a href="libpq-int.h.html#LN693"><span class='Ref_to_Macro'>SOCK_ERRNO_SET</span></a><span class='Parentheses'>(</span><a href="fe-secure.c.html#LN226"><span class='Ref_To_Local'>result_errno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="fe-secure.c.html#LN225"><span class='Ref_To_Local'>n</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pqsecure_raw_read &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  Write data to a secure connection. 
 * 
 * On failure, this function is responsible for putting a suitable message 
 * into conn-&GT;errorMessage.  The caller must still inspect errno, but only 
 * to determine whether to continue/retry after error. 
 */ 
</span><a href="../../include/port/win32.h.html#LN419"><span class='Ref_to_Typedef'>ssize_t</span></a> 
<a name="LN281"></a><span class='Declare_Function'>pqsecure_write</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>ptr</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN283"></a>    <a href="../../include/port/win32.h.html#LN419"><span class='Ref_to_Typedef'>ssize_t</span></a>     <span class='Declare_Local'>n</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/pg_config_manual.h.html#LN172"><span class='Ref_to_Const'>USE_SSL</span></a> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure.c.html#LN281"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN460"><span class='Ref_to_Member'>ssl_in_use</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="fe-secure.c.html#LN283"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= </span><a href="fe-secure-openssl.c.html#LN293"><span class='Ref_to_Func'>pgtls_write</span></a><span class='Parentheses'>(</span><a href="fe-secure.c.html#LN281"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="fe-secure.c.html#LN281"><span class='Ref_to_Parameter'>ptr</span></a><span class='Delimiter'>, </span><a href="fe-secure.c.html#LN281"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
<span class='Directive'>#endif</span> 
    <span class='Delimiter'>{ 
</span>        <a href="fe-secure.c.html#LN283"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= </span><a href="fe-secure.c.html#LN299"><span class='Ref_to_Func'>pqsecure_raw_write</span></a><span class='Parentheses'>(</span><a href="fe-secure.c.html#LN281"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="fe-secure.c.html#LN281"><span class='Ref_to_Parameter'>ptr</span></a><span class='Delimiter'>, </span><a href="fe-secure.c.html#LN281"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="fe-secure.c.html#LN283"><span class='Ref_To_Local'>n</span></a><span class='Delimiter'>; 
} 
</span> 
<a href="../../include/port/win32.h.html#LN419"><span class='Ref_to_Typedef'>ssize_t</span></a> 
<a name="LN300"></a><span class='Declare_Function'>pqsecure_raw_write</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>ptr</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN302"></a>    <a href="../../include/port/win32.h.html#LN419"><span class='Ref_to_Typedef'>ssize_t</span></a>     <span class='Declare_Local'>n</span><span class='Delimiter'>; 
</span><a name="LN303"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>flags</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN304"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>result_errno</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN305"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>sebuf</span><span class='Delimiter'>[</span><span class='Number'>256</span><span class='Delimiter'>]; 
</span> 
    <a href="fe-secure.c.html#LN75"><span class='Ref_to_Macro'>DECLARE_SIGPIPE_INFO</span></a><span class='Parentheses'>(</span>spinfo<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> MSG_NOSIGNAL 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure.c.html#LN300"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN410"><span class='Ref_to_Member'>sigpipe_flag</span></a><span class='Parentheses'>) 
</span>        <a href="fe-secure.c.html#LN303"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>|= </span>MSG_NOSIGNAL<span class='Delimiter'>; 
</span> 
<a name="LN313"></a><span class='Label'>retry_masked</span><span class='Operator'>: 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* MSG_NOSIGNAL */ 
</span> 
    <a href="fe-secure.c.html#LN77"><span class='Ref_to_Macro'>DISABLE_SIGPIPE</span></a><span class='Parentheses'>(</span><a href="fe-secure.c.html#LN300"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span>spinfo<span class='Delimiter'>, </span><span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="fe-secure.c.html#LN302"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= </span><a href="../../include/port/win32.h.html#LN375"><span class='Ref_to_Macro'>send</span></a><span class='Parentheses'>(</span><a href="fe-secure.c.html#LN300"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN399"><span class='Ref_to_Member'>sock</span></a><span class='Delimiter'>, </span><a href="fe-secure.c.html#LN300"><span class='Ref_to_Parameter'>ptr</span></a><span class='Delimiter'>, </span><a href="fe-secure.c.html#LN300"><span class='Ref_to_Parameter'>len</span></a><span class='Delimiter'>, </span><a href="fe-secure.c.html#LN303"><span class='Ref_To_Local'>flags</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure.c.html#LN302"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="fe-secure.c.html#LN304"><span class='Ref_To_Local'>result_errno</span></a> <span class='Operator'>= </span><a href="libpq-int.h.html#LN691"><span class='Ref_to_Const'>SOCK_ERRNO</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If we see an EINVAL, it may be because MSG_NOSIGNAL isn't available 
         * on this machine.  So, clear sigpipe_flag so we don't try the flag 
         * again, and retry the send(). 
         */ 
</span><span class='Directive'>#ifdef</span> MSG_NOSIGNAL 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure.c.html#LN303"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="fe-secure.c.html#LN304"><span class='Ref_To_Local'>result_errno</span></a> <span class='Operator'>== </span>EINVAL<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="fe-secure.c.html#LN300"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN410"><span class='Ref_to_Member'>sigpipe_flag</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <a href="fe-secure.c.html#LN303"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="fe-secure.c.html#LN313"><span class='Ref_to_Label'>retry_masked</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* MSG_NOSIGNAL */ 
</span> 
        <span class='Comment_Multi_Line'>/* Set error message if appropriate */ 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="fe-secure.c.html#LN304"><span class='Ref_To_Local'>result_errno</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/port/win32.h.html#LN282"><span class='Ref_to_Const'>EAGAIN</span></a> 
            <span class='Control'>case</span> <a href="../../include/port/win32.h.html#LN282"><span class='Ref_to_Const'>EAGAIN</span></a><span class='Operator'>: 
</span><span class='Directive'>#endif</span> 
<span class='Directive'>#if</span> defined<span class='Parentheses'>(</span><a href="win32.h.html#LN19"><span class='Ref_to_Const'>EWOULDBLOCK</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><span class='Parentheses'>(</span><span class='Operator'>!</span>defined<span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN282"><span class='Ref_to_Const'>EAGAIN</span></a><span class='Parentheses'>) </span><span class='Operator'>|| </span><span class='Parentheses'>(</span><a href="win32.h.html#LN19"><span class='Ref_to_Const'>EWOULDBLOCK</span></a> <span class='Operator'>!= </span><a href="../../include/port/win32.h.html#LN282"><span class='Ref_to_Const'>EAGAIN</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>case</span> <a href="win32.h.html#LN19"><span class='Ref_to_Const'>EWOULDBLOCK</span></a><span class='Operator'>: 
</span><span class='Directive'>#endif</span> 
            <span class='Control'>case</span> <a href="win32.h.html#LN17"><span class='Ref_to_Const'>EINTR</span></a><span class='Operator'>: 
</span>                <span class='Comment_Multi_Line'>/* no error message, caller is expected to retry */ 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> EPIPE<span class='Operator'>: 
</span>                <span class='Comment_Multi_Line'>/* Set flag for EPIPE */ 
</span>                <a href="fe-secure.c.html#LN88"><span class='Ref_to_Macro'>REMEMBER_EPIPE</span></a><span class='Parentheses'>(</span>spinfo<span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* FALL THRU */ 
</span> 
<span class='Directive'>#ifdef</span> <a href="win32.h.html#LN22"><span class='Ref_to_Const'>ECONNRESET</span></a> 
            <span class='Control'>case</span> <a href="win32.h.html#LN22"><span class='Ref_to_Const'>ECONNRESET</span></a><span class='Operator'>: 
</span><span class='Directive'>#endif</span> 
                <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure.c.html#LN300"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                                  <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>( 
</span>                                <span class='String'>"server closed the connection unexpectedly\n"</span> 
                   <span class='String'>"\tThis probably means the server terminated abnormally\n"</span> 
                             <span class='String'>"\tbefore or while processing the request.\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>default</span><span class='Operator'>: 
</span>                <a href="pqexpbuffer.c.html#LN232"><span class='Ref_to_Func'>printfPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure.c.html#LN300"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpq-int.h.html#LN491"><span class='Ref_to_Member'>errorMessage</span></a><span class='Delimiter'>, 
</span>                        <a href="win32.c.html#LN36"><span class='Ref_to_Func'>libpq_gettext</span></a><span class='Parentheses'>(</span><span class='String'>"could not send data to server: %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                  <a href="libpq-int.h.html#LN692"><span class='Ref_to_Const'>SOCK_STRERROR</span></a><span class='Parentheses'>(</span><a href="fe-secure.c.html#LN304"><span class='Ref_To_Local'>result_errno</span></a><span class='Delimiter'>, 
</span>                                                <a href="fe-secure.c.html#LN305"><span class='Ref_To_Local'>sebuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fe-secure.c.html#LN305"><span class='Ref_To_Local'>sebuf</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch result_errno &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if n&LT;0 &raquo; </span> 
 
    <a href="fe-secure.c.html#LN94"><span class='Ref_to_Macro'>RESTORE_SIGPIPE</span></a><span class='Parentheses'>(</span><a href="fe-secure.c.html#LN300"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span>spinfo<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* ensure we return the intended errno to caller */ 
</span>    <a href="libpq-int.h.html#LN693"><span class='Ref_to_Macro'>SOCK_ERRNO_SET</span></a><span class='Parentheses'>(</span><a href="fe-secure.c.html#LN304"><span class='Ref_To_Local'>result_errno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="fe-secure.c.html#LN302"><span class='Ref_To_Local'>n</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pqsecure_raw_write &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* Dummy versions of SSL info functions, when built without SSL support */ 
</span><span class='Directive'>#ifndef</span> <a href="../../include/pg_config_manual.h.html#LN172"><span class='Ref_to_Const'>USE_SSL</span></a> 
 
<span class='Keyword'>int 
</span><a name="LN387"></a><span class='Declare_Function'>PQsslInUse</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>void </span><span class='Operator'>* 
</span><a name="LN393"></a><span class='Declare_Function'>PQgetssl</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>void </span><span class='Operator'>* 
</span><a name="LN399"></a><span class='Declare_Function'>PQsslStruct</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>struct_name</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>const char </span><span class='Operator'>* 
</span><a name="LN405"></a><span class='Declare_Function'>PQsslAttribute</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>attribute_name</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Keyword'>const </span><span class='Operator'>* 
</span><a name="LN411"></a><span class='Declare_Function'>PQsslAttributeNames</span><span class='Parentheses'>(</span><a href="libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN413"></a>    <span class='Keyword'>static const char </span><span class='Operator'>*</span><span class='Keyword'>const </span><span class='Declare_Local'>result</span><span class='Delimiter'>[] </span><span class='Operator'>= </span><span class='Delimiter'>{</span><span class='Null_Value'>NULL</span><span class='Delimiter'>}; 
</span> 
    <span class='Control'>return</span> <a href="fe-secure.c.html#LN413"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
} 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* USE_SSL */ 
</span> 
 
<span class='Directive'>#if</span> defined<span class='Parentheses'>(</span>ENABLE_THREAD_SAFETY<span class='Parentheses'>) </span><span class='Operator'>&& !</span>defined<span class='Parentheses'>(</span><a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a><span class='Parentheses'>) 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  Block SIGPIPE for this thread.  This prevents send()/write() from exiting 
 *  the application. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN427"></a><span class='Declare_Function'>pq_block_sigpipe</span><span class='Parentheses'>(</span><a href="../../include/libpq/pqsignal.h.html#LN21"><span class='Ref_to_Typedef'>sigset_t</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>osigset</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>sigpipe_pending</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN429"></a>    <a href="../../include/libpq/pqsignal.h.html#LN21"><span class='Ref_to_Typedef'>sigset_t</span></a>    <span class='Declare_Local'>sigpipe_sigset</span><span class='Delimiter'>; 
</span><a name="LN430"></a>    <a href="../../include/libpq/pqsignal.h.html#LN21"><span class='Ref_to_Typedef'>sigset_t</span></a>    <span class='Declare_Local'>sigset</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/libpq/pqsignal.h.html#LN26"><span class='Ref_to_Macro'>sigemptyset</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure.c.html#LN429"><span class='Ref_To_Local'>sigpipe_sigset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/libpq/pqsignal.h.html#LN28"><span class='Ref_to_Macro'>sigaddset</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure.c.html#LN429"><span class='Ref_To_Local'>sigpipe_sigset</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN192"><span class='Ref_to_Const'>SIGPIPE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Block SIGPIPE and save previous mask for later reset */ 
</span>    <a href="libpq-int.h.html#LN693"><span class='Ref_to_Macro'>SOCK_ERRNO_SET</span></a><span class='Parentheses'>(</span>pthread_sigmask<span class='Parentheses'>(</span>SIG_BLOCK<span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fe-secure.c.html#LN429"><span class='Ref_To_Local'>sigpipe_sigset</span></a><span class='Delimiter'>, </span><a href="fe-secure.c.html#LN427"><span class='Ref_to_Parameter'>osigset</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="libpq-int.h.html#LN691"><span class='Ref_to_Const'>SOCK_ERRNO</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We can have a pending SIGPIPE only if it was blocked before */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>sigismember<span class='Parentheses'>(</span><a href="fe-secure.c.html#LN427"><span class='Ref_to_Parameter'>osigset</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN192"><span class='Ref_to_Const'>SIGPIPE</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Is there a pending SIGPIPE? */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>sigpending<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure.c.html#LN430"><span class='Ref_To_Local'>sigset</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>sigismember<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure.c.html#LN430"><span class='Ref_To_Local'>sigset</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN192"><span class='Ref_to_Const'>SIGPIPE</span></a><span class='Parentheses'>))</span> 
            <span class='Operator'>*</span><a href="fe-secure.c.html#LN427"><span class='Ref_to_Parameter'>sigpipe_pending</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <span class='Operator'>*</span><a href="fe-secure.c.html#LN427"><span class='Ref_to_Parameter'>sigpipe_pending</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <span class='Operator'>*</span><a href="fe-secure.c.html#LN427"><span class='Ref_to_Parameter'>sigpipe_pending</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pq_block_sigpipe &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  Discard any pending SIGPIPE and reset the signal mask. 
 * 
 * Note: we are effectively assuming here that the C library doesn't queue 
 * up multiple SIGPIPE events.  If it did, then we'd accidentally leave 
 * ours in the queue when an event was already pending and we got another. 
 * As long as it doesn't queue multiple events, we're OK because the caller 
 * can't tell the difference. 
 * 
 * The caller should say got_epipe = FALSE if it is certain that it 
 * didn't get an EPIPE error; in that case we'll skip the clear operation 
 * and things are definitely OK, queuing or no.  If it got one or might have 
 * gotten one, pass got_epipe = TRUE. 
 * 
 * We do not want this to change errno, since if it did that could lose 
 * the error code from a preceding send().  We essentially assume that if 
 * we were able to do pq_block_sigpipe(), this can't fail. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN477"></a><span class='Declare_Function'>pq_reset_sigpipe</span><span class='Parentheses'>(</span><a href="../../include/libpq/pqsignal.h.html#LN21"><span class='Ref_to_Typedef'>sigset_t</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>osigset</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>sigpipe_pending</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>got_epipe</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN479"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span> <span class='Operator'>= </span><a href="libpq-int.h.html#LN691"><span class='Ref_to_Const'>SOCK_ERRNO</span></a><span class='Delimiter'>; 
</span><a name="LN480"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>signo</span><span class='Delimiter'>; 
</span><a name="LN481"></a>    <a href="../../include/libpq/pqsignal.h.html#LN21"><span class='Ref_to_Typedef'>sigset_t</span></a>    <span class='Declare_Local'>sigset</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Clear SIGPIPE only if none was pending */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fe-secure.c.html#LN477"><span class='Ref_to_Parameter'>got_epipe</span></a> <span class='Operator'>&& !</span><a href="fe-secure.c.html#LN477"><span class='Ref_to_Parameter'>sigpipe_pending</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>sigpending<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure.c.html#LN481"><span class='Ref_To_Local'>sigset</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>            sigismember<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure.c.html#LN481"><span class='Ref_To_Local'>sigset</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN192"><span class='Ref_to_Const'>SIGPIPE</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN489"></a>            <a href="../../include/libpq/pqsignal.h.html#LN21"><span class='Ref_to_Typedef'>sigset_t</span></a>    <span class='Declare_Local'>sigpipe_sigset</span><span class='Delimiter'>; 
</span> 
            <a href="../../include/libpq/pqsignal.h.html#LN26"><span class='Ref_to_Macro'>sigemptyset</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure.c.html#LN489"><span class='Ref_To_Local'>sigpipe_sigset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/libpq/pqsignal.h.html#LN28"><span class='Ref_to_Macro'>sigaddset</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure.c.html#LN489"><span class='Ref_To_Local'>sigpipe_sigset</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN192"><span class='Ref_to_Const'>SIGPIPE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../test/thread/thread_test.c.html#LN62"><span class='Ref_to_Proto'>sigwait</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fe-secure.c.html#LN489"><span class='Ref_To_Local'>sigpipe_sigset</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fe-secure.c.html#LN480"><span class='Ref_To_Local'>signo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Restore saved block mask */ 
</span>    pthread_sigmask<span class='Parentheses'>(</span>SIG_SETMASK<span class='Delimiter'>, </span><a href="fe-secure.c.html#LN477"><span class='Ref_to_Parameter'>osigset</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="libpq-int.h.html#LN693"><span class='Ref_to_Macro'>SOCK_ERRNO_SET</span></a><span class='Parentheses'>(</span><a href="fe-secure.c.html#LN479"><span class='Ref_To_Local'>save_errno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pq_reset_sigpipe &raquo; </span> 
 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* ENABLE_THREAD_SAFETY && !WIN32 */ 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>