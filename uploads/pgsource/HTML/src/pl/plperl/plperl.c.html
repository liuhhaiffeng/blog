<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\pl\plperl\plperl.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\pl\plperl\plperl.c</b></p></td>
<td align='right'>
Wed Jun 14 08:26:11 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
</span><span class='Comment_Multi_Line'>/********************************************************************** 
 * plperl.c - perl as a procedural language for PostgreSQL 
 * 
 *    src/pl/plperl/plperl.c 
 * 
 **********************************************************************/ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
<span class='Comment_Multi_Line'>/* Defined by Perl */ 
</span><span class='Keyword'>#undef </span>_ 
 
<span class='Comment_Multi_Line'>/* system stuff */ 
</span><span class='Keyword'>#include </span><span class='String'>&LT;ctype.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;fcntl.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;limits.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
 
<span class='Comment_Multi_Line'>/* postgreSQL stuff */ 
</span><span class='Keyword'>#include </span><span class='String'>"access/htup_details.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_language.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_proc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_proc_fn.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_type.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/event_trigger.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/trigger.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"executor/spi.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"funcapi.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"mb/pg_wchar.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"nodes/makefuncs.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"parser/parse_type.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/ipc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"tcop/tcopprot.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/fmgroids.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/guc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/hsearch.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/lsyscache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/rel.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/syscache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/typcache.h"</span> 
 
<span class='Comment_Multi_Line'>/* define our text domain for translations */ 
</span><span class='Keyword'>#undef </span><a href="../plpgsql/src/plpgsql.h.html#LN29"><span class='Ref_to_Const'>TEXTDOMAIN</span></a> 
<a name="LN46"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>TEXTDOMAIN</span> <a href="../../include/c.h.html#LN1009"><span class='Ref_to_Macro'>PG_TEXTDOMAIN</span></a><span class='Parentheses'>(</span><span class='String'>"plperl"</span><span class='Parentheses'>) 
</span> 
<span class='Comment_Multi_Line'>/* perl stuff */ 
</span><span class='Keyword'>#include </span><span class='String'>"plperl.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"plperl_helpers.h"</span> 
 
<span class='Comment_Multi_Line'>/* string literal macros defining chunks of perl code */ 
</span><span class='Keyword'>#include </span><span class='String'>"perlchunks.h"</span> 
<span class='Comment_Multi_Line'>/* defines PLPERL_SET_OPMASK */ 
</span><span class='Keyword'>#include </span><span class='String'>"plperl_opmask.h"</span> 
 
<a name="LN57"></a><a href="ppport.h.html#LN3803"><span class='Ref_to_Const'>EXTERN_C</span></a> <span class='Keyword'>void </span><span class='Declare_Prototype'>boot_DynaLoader</span><span class='Parentheses'>(</span><a href="ppport.h.html#LN3218"><span class='Ref_to_Const'>pTHX_</span></a> CV <span class='Operator'>*</span><span class='Declare_Parameter'>cv</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN58"></a><a href="ppport.h.html#LN3803"><span class='Ref_to_Const'>EXTERN_C</span></a> <span class='Keyword'>void </span><span class='Declare_Prototype'>boot_PostgreSQL__InServer__Util</span><span class='Parentheses'>(</span><a href="ppport.h.html#LN3218"><span class='Ref_to_Const'>pTHX_</span></a> CV <span class='Operator'>*</span><span class='Declare_Parameter'>cv</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN59"></a><a href="ppport.h.html#LN3803"><span class='Ref_to_Const'>EXTERN_C</span></a> <span class='Keyword'>void </span><span class='Declare_Prototype'>boot_PostgreSQL__InServer__SPI</span><span class='Parentheses'>(</span><a href="ppport.h.html#LN3218"><span class='Ref_to_Const'>pTHX_</span></a> CV <span class='Operator'>*</span><span class='Declare_Parameter'>cv</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a href="../../include/fmgr.h.html#LN442"><span class='Ref_to_Const'>PG_MODULE_MAGIC</span></a><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * Information associated with a Perl interpreter.  We have one interpreter 
 * that is used for all plperlu (untrusted) functions.  For plperl (trusted) 
 * functions, there is a separate interpreter for each effective SQL userid. 
 * (This is needed to ensure that an unprivileged user can't inject Perl code 
 * that'll be executed with the privileges of some other SQL user.) 
 * 
 * The plperl_interp_desc structs are kept in a Postgres hash table indexed 
 * by userid OID, with OID 0 used for the single untrusted interpreter. 
 * Once created, an interpreter is kept for the life of the process. 
 * 
 * We start out by creating a "held" interpreter, which we initialize 
 * only as far as we can do without deciding if it will be trusted or 
 * untrusted.  Later, when we first need to run a plperl or plperlu 
 * function, we complete the initialization appropriately and move the 
 * PerlInterpreter pointer into the plperl_interp_hash hashtable.  If after 
 * that we need more interpreters, we create them as needed if we can, or 
 * fail if the Perl build doesn't support multiple interpreters. 
 * 
 * The reason for all the dancing about with a held interpreter is to make 
 * it possible for people to preload a lot of Perl code at postmaster startup 
 * (using plperl.on_init) and then use that code in backends.  Of course this 
 * will only work for the first interpreter created in any backend, but it's 
 * still useful with that restriction. 
 **********************************************************************/ 
</span><a name="LN88"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>plperl_interp_desc</span> 
<span class='Delimiter'>{ 
</span><a name="LN90"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>user_id</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* Hash key (must be first!) */ 
</span><a name="LN91"></a>    PerlInterpreter <span class='Operator'>*</span><span class='Declare_Member'>interp</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* The interpreter */ 
</span><a name="LN92"></a>    <a href="../../backend/utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a>       <span class='Operator'>*</span><span class='Declare_Member'>query_hash</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* plperl_query_entry structs */ 
</span><a name="LN93"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>plperl_interp_desc</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * The information we cache about loaded procedures 
 * 
 * The fn_refcount field counts the struct's reference from the hash table 
 * shown below, plus one reference for each function call level that is using 
 * the struct.  We can release the struct, and the associated Perl sub, when 
 * the fn_refcount goes to zero.  Releasing the struct itself is done by 
 * deleting the fn_cxt, which also gets rid of all subsidiary data. 
 **********************************************************************/ 
</span><a name="LN105"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>plperl_proc_desc</span> 
<span class='Delimiter'>{ 
</span><a name="LN107"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Member'>proname</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* user name of procedure */ 
</span><a name="LN108"></a>    <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Member'>fn_cxt</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* memory context for this procedure */ 
</span><a name="LN109"></a>    <span class='Keyword'>unsigned long </span><span class='Declare_Member'>fn_refcount</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* number of active references */ 
</span><a name="LN110"></a>    <a href="../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Member'>fn_xmin</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* xmin/TID of procedure's pg_proc tuple */ 
</span><a name="LN111"></a>    <a href="../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a> <span class='Declare_Member'>fn_tid</span><span class='Delimiter'>; 
</span><a name="LN112"></a>    SV         <span class='Operator'>*</span><span class='Declare_Member'>reference</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* CODE reference for Perl sub */ 
</span><a name="LN113"></a>    <a href="plperl.c.html#LN88"><span class='Ref_to_Struct'>plperl_interp_desc</span></a> <span class='Operator'>*</span><span class='Declare_Member'>interp</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* interpreter it's created in */ 
</span><a name="LN114"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>fn_readonly</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* is function readonly (not volatile)? */ 
</span><a name="LN115"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>lang_oid</span><span class='Delimiter'>; 
</span><a name="LN116"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Member'>trftypes</span><span class='Delimiter'>; 
</span><a name="LN117"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>lanpltrusted</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* is it plperl, rather than plperlu? */ 
</span><a name="LN118"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>fn_retistuple</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* true, if function returns tuple */ 
</span><a name="LN119"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>fn_retisset</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* true, if function returns set */ 
</span><a name="LN120"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>fn_retisarray</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* true if function returns array */ 
</span>    <span class='Comment_Multi_Line'>/* Conversion info for function's result type: */ 
</span><a name="LN122"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>result_oid</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* Oid of result type */ 
</span><a name="LN123"></a>    <a href="../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a>    <span class='Declare_Member'>result_in_func</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* I/O function and arg for result type */ 
</span><a name="LN124"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>result_typioparam</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Per-argument info for function's argument types: */ 
</span><a name="LN126"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>nargs</span><span class='Delimiter'>; 
</span><a name="LN127"></a>    <a href="../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a>   <span class='Operator'>*</span><span class='Declare_Member'>arg_out_func</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* output fns for arg types */ 
</span><a name="LN128"></a>    <span class='Keyword'>bool</span>       <span class='Operator'>*</span><span class='Declare_Member'>arg_is_rowtype</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* is each arg composite? */ 
</span><a name="LN129"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>        <span class='Operator'>*</span><span class='Declare_Member'>arg_arraytype</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* InvalidOid if not an array */ 
</span><a name="LN130"></a><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end plperl_proc_desc &raquo; </span> <span class='Declare_Typedef'>plperl_proc_desc</span><span class='Delimiter'>; 
</span> 
<a name="LN132"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>increment_prodesc_refcount</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>prodesc</span><span class='Parentheses'>)</span>  <span class='Operator'>\ 
</span>    <span class='Parentheses'>((</span><a href="plperl.c.html#LN132"><span class='Ref_to_Parameter'>prodesc</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>fn_refcount<span class='Operator'>++</span><span class='Parentheses'>)</span> 
<a name="LN134"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>decrement_prodesc_refcount</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>prodesc</span><span class='Parentheses'>)</span>  <span class='Operator'>\ 
</span>    <span class='Control'>do</span> <span class='Delimiter'>{ </span><span class='Operator'>\ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>((</span><a href="plperl.c.html#LN134"><span class='Ref_to_Parameter'>prodesc</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>fn_refcount <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>--</span><span class='Parentheses'>((</span><a href="plperl.c.html#LN134"><span class='Ref_to_Parameter'>prodesc</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>fn_refcount<span class='Parentheses'>)</span> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> <span class='Operator'>\ 
</span>            <a href="plperl.c.html#LN259"><span class='Ref_to_Proto'>free_plperl_function</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN134"><span class='Ref_to_Parameter'>prodesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>    <span class='Delimiter'>} </span><span class='Control'>while</span><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>) 
</span> 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * For speedy lookup, we maintain a hash table mapping from 
 * function OID + trigger flag + user OID to plperl_proc_desc pointers. 
 * The reason the plperl_proc_desc struct isn't directly part of the hash 
 * entry is to simplify recovery from errors during compile_plperl_function. 
 * 
 * Note: if the same function is called by multiple userIDs within a session, 
 * there will be a separate plperl_proc_desc entry for each userID in the case 
 * of plperl functions, but only one entry for plperlu functions, because we 
 * set user_id = 0 for that case.  If the user redeclares the same function 
 * from plperl to plperlu or vice versa, there might be multiple 
 * plperl_proc_ptr entries in the hashtable, but only one is valid. 
 **********************************************************************/ 
</span><a name="LN154"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>plperl_proc_key</span> 
<span class='Delimiter'>{ 
</span><a name="LN156"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>proc_id</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* Function OID */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * is_trigger is really a bool, but declare as Oid to ensure this struct 
     * contains no padding 
     */ 
</span><a name="LN162"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>is_trigger</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* is it a trigger function? */ 
</span><a name="LN163"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>user_id</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* User calling the function, or 0 */ 
</span><a name="LN164"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>plperl_proc_key</span><span class='Delimiter'>; 
</span> 
<a name="LN166"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>plperl_proc_ptr</span> 
<span class='Delimiter'>{ 
</span><a name="LN168"></a>    <a href="plperl.c.html#LN154"><span class='Ref_to_Struct'>plperl_proc_key</span></a> <span class='Declare_Member'>proc_key</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* Hash key (must be first!) */ 
</span><a name="LN169"></a>    <a href="plperl.c.html#LN105"><span class='Ref_to_Struct'>plperl_proc_desc</span></a> <span class='Operator'>*</span><span class='Declare_Member'>proc_ptr</span><span class='Delimiter'>; 
</span><a name="LN170"></a>} <span class='Declare_Typedef'>plperl_proc_ptr</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * The information we cache for the duration of a single call to a 
 * function. 
 */ 
</span><a name="LN176"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>plperl_call_data</span> 
<span class='Delimiter'>{ 
</span><a name="LN178"></a>    <a href="plperl.c.html#LN105"><span class='Ref_to_Struct'>plperl_proc_desc</span></a> <span class='Operator'>*</span><span class='Declare_Member'>prodesc</span><span class='Delimiter'>; 
</span><a name="LN179"></a>    <a href="../../include/fmgr.h.html#LN37"><span class='Ref_to_Typedef'>FunctionCallInfo</span></a> <span class='Declare_Member'>fcinfo</span><span class='Delimiter'>; 
</span><a name="LN180"></a>    <a href="../../backend/utils/sort/tuplestore.c.html#LN102"><span class='Ref_to_Struct'>Tuplestorestate</span></a> <span class='Operator'>*</span><span class='Declare_Member'>tuple_store</span><span class='Delimiter'>; 
</span><a name="LN181"></a>    <a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Member'>ret_tdesc</span><span class='Delimiter'>; 
</span><a name="LN182"></a>    <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Member'>tmp_cxt</span><span class='Delimiter'>; 
</span><a name="LN183"></a>} <span class='Declare_Typedef'>plperl_call_data</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * The information we cache about prepared and saved plans 
 **********************************************************************/ 
</span><a name="LN188"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>plperl_query_desc</span> 
<span class='Delimiter'>{ 
</span><a name="LN190"></a>    <span class='Keyword'>char</span>        <span class='Declare_Member'>qname</span><span class='Delimiter'>[</span><span class='Number'>24</span><span class='Delimiter'>]; 
</span><a name="LN191"></a>    <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Member'>plan_cxt</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* context holding this struct */ 
</span><a name="LN192"></a>    <a href="../../include/executor/spi.h.html#LN33"><span class='Ref_to_Typedef'>SPIPlanPtr</span></a>  <span class='Declare_Member'>plan</span><span class='Delimiter'>; 
</span><a name="LN193"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>nargs</span><span class='Delimiter'>; 
</span><a name="LN194"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>        <span class='Operator'>*</span><span class='Declare_Member'>argtypes</span><span class='Delimiter'>; 
</span><a name="LN195"></a>    <a href="../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a>   <span class='Operator'>*</span><span class='Declare_Member'>arginfuncs</span><span class='Delimiter'>; 
</span><a name="LN196"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>        <span class='Operator'>*</span><span class='Declare_Member'>argtypioparams</span><span class='Delimiter'>; 
</span><a name="LN197"></a>} <span class='Declare_Typedef'>plperl_query_desc</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* hash table entry for query desc  */ 
</span> 
<a name="LN201"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>plperl_query_entry</span> 
<span class='Delimiter'>{ 
</span><a name="LN203"></a>    <span class='Keyword'>char</span>        <span class='Declare_Member'>query_name</span><span class='Delimiter'>[</span><a href="../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a><span class='Delimiter'>]; 
</span><a name="LN204"></a>    <a href="plperl.c.html#LN188"><span class='Ref_to_Struct'>plperl_query_desc</span></a> <span class='Operator'>*</span><span class='Declare_Member'>query_data</span><span class='Delimiter'>; 
</span><a name="LN205"></a>} <span class='Declare_Typedef'>plperl_query_entry</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * Information for PostgreSQL - Perl array conversion. 
 **********************************************************************/ 
</span><a name="LN210"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>plperl_array_info</span> 
<span class='Delimiter'>{ 
</span><a name="LN212"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>ndims</span><span class='Delimiter'>; 
</span><a name="LN213"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>elem_is_rowtype</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* 't' if element type is a rowtype */ 
</span><a name="LN214"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>      <span class='Operator'>*</span><span class='Declare_Member'>elements</span><span class='Delimiter'>; 
</span><a name="LN215"></a>    <span class='Keyword'>bool</span>       <span class='Operator'>*</span><span class='Declare_Member'>nulls</span><span class='Delimiter'>; 
</span><a name="LN216"></a>    <span class='Keyword'>int</span>        <span class='Operator'>*</span><span class='Declare_Member'>nelems</span><span class='Delimiter'>; 
</span><a name="LN217"></a>    <a href="../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a>    <span class='Declare_Member'>proc</span><span class='Delimiter'>; 
</span><a name="LN218"></a>    <a href="../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a>    <span class='Declare_Member'>transform_proc</span><span class='Delimiter'>; 
</span><a name="LN219"></a>} <span class='Declare_Typedef'>plperl_array_info</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * Global data 
 **********************************************************************/ 
</span> 
<a name="LN225"></a><span class='Keyword'>static </span><a href="../../backend/utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Var'>plperl_interp_hash</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN226"></a><span class='Keyword'>static </span><a href="../../backend/utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Var'>plperl_proc_hash</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN227"></a><span class='Keyword'>static </span><a href="plperl.c.html#LN88"><span class='Ref_to_Struct'>plperl_interp_desc</span></a> <span class='Operator'>*</span><span class='Declare_Var'>plperl_active_interp</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* If we have an unassigned "held" interpreter, it's stored here */ 
</span><a name="LN230"></a><span class='Keyword'>static </span>PerlInterpreter <span class='Operator'>*</span><span class='Declare_Var'>plperl_held_interp</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* GUC variables */ 
</span><a name="LN233"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>plperl_use_strict</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN234"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Var'>plperl_on_init</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN235"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Var'>plperl_on_plperl_init</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN236"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Var'>plperl_on_plperlu_init</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<a name="LN238"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>plperl_ending</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><span class='Keyword'>static </span>OP  <span class='Operator'>*</span><span class='Parentheses'>(</span><span class='Operator'>*</span>pp_require_orig<span class='Parentheses'>) (</span><a href="ppport.h.html#LN3214"><span class='Ref_to_Const'>pTHX</span></a><span class='Parentheses'>) </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN240"></a><span class='Keyword'>static char </span><span class='Declare_Var'>plperl_opmask</span><span class='Delimiter'>[</span>MAXO<span class='Delimiter'>]; 
</span> 
<span class='Comment_Multi_Line'>/* this is saved and restored by plperl_call_handler */ 
</span><a name="LN243"></a><span class='Keyword'>static </span><a href="plperl.c.html#LN176"><span class='Ref_to_Struct'>plperl_call_data</span></a> <span class='Operator'>*</span><span class='Declare_Var'>current_call_data</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * Forward declarations 
 **********************************************************************/ 
</span><a name="LN248"></a><span class='Keyword'>void</span>        <span class='Declare_Prototype'>_PG_init</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN250"></a><span class='Keyword'>static </span>PerlInterpreter <span class='Operator'>*</span><span class='Declare_Prototype'>plperl_init_interp</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN251"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>plperl_destroy_interp</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>PerlInterpreter</span> <span class='Operator'>**</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN252"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>plperl_fini</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>code</span><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN253"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>set_interp_require</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>trusted</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN255"></a><span class='Keyword'>static </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Prototype'>plperl_func_handler</span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN256"></a><span class='Keyword'>static </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Prototype'>plperl_trigger_handler</span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN257"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>plperl_event_trigger_handler</span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN259"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>free_plperl_function</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN105"><span class='Ref_to_Struct'>plperl_proc_desc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>prodesc</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN261"></a><span class='Keyword'>static </span><a href="plperl.c.html#LN105"><span class='Ref_to_Struct'>plperl_proc_desc</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>compile_plperl_function</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>fn_oid</span><span class='Delimiter'>, 
</span><a name="LN262"></a>                        <span class='Keyword'>bool </span><span class='Declare_Parameter'>is_trigger</span><span class='Delimiter'>, 
</span><a name="LN263"></a>                        <span class='Keyword'>bool </span><span class='Declare_Parameter'>is_event_trigger</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN265"></a><span class='Keyword'>static </span>SV  <span class='Operator'>*</span><span class='Declare_Prototype'>plperl_hash_from_tuple</span><span class='Parentheses'>(</span><a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>tuple</span><span class='Delimiter'>, </span><a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>tupdesc</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN266"></a><span class='Keyword'>static </span>SV  <span class='Operator'>*</span><span class='Declare_Prototype'>plperl_hash_from_datum</span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>attr</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN267"></a><span class='Keyword'>static </span>SV  <span class='Operator'>*</span><span class='Declare_Prototype'>plperl_ref_from_pg_array</span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>typid</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN268"></a><span class='Keyword'>static </span>SV  <span class='Operator'>*</span><span class='Declare_Prototype'>split_array</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN210"><span class='Ref_to_Struct'>plperl_array_info</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>info</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>first</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>last</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nest</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN269"></a><span class='Keyword'>static </span>SV  <span class='Operator'>*</span><span class='Declare_Prototype'>make_array_ref</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN210"><span class='Ref_to_Struct'>plperl_array_info</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>info</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>first</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>last</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN270"></a><span class='Keyword'>static </span>SV  <span class='Operator'>*</span><span class='Declare_Prototype'>get_perl_array_ref</span><span class='Parentheses'>(</span>SV <span class='Operator'>*</span><span class='Declare_Parameter'>sv</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN271"></a><span class='Keyword'>static </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Prototype'>plperl_sv_to_datum</span><span class='Parentheses'>(</span>SV <span class='Operator'>*</span><span class='Declare_Parameter'>sv</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>typid</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Declare_Parameter'>typmod</span><span class='Delimiter'>, 
</span><a name="LN272"></a>                   <a href="../../include/fmgr.h.html#LN37"><span class='Ref_to_Typedef'>FunctionCallInfo</span></a> <span class='Declare_Parameter'>fcinfo</span><span class='Delimiter'>, 
</span><a name="LN273"></a>                   <a href="../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>finfo</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>typioparam</span><span class='Delimiter'>, 
</span><a name="LN274"></a>                   <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>isnull</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN275"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>_sv_to_datum_finfo</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>typid</span><span class='Delimiter'>, </span><a href="../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>finfo</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>typioparam</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN276"></a><span class='Keyword'>static </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Prototype'>plperl_array_to_datum</span><span class='Parentheses'>(</span>SV <span class='Operator'>*</span><span class='Declare_Parameter'>src</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>typid</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Declare_Parameter'>typmod</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN277"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>array_to_datum_internal</span><span class='Parentheses'>(</span>AV <span class='Operator'>*</span><span class='Declare_Parameter'>av</span><span class='Delimiter'>, </span><a href="../../include/utils/array.h.html#LN167"><span class='Ref_to_Struct'>ArrayBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>astate</span><span class='Delimiter'>, 
</span><a name="LN278"></a>                        <span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>ndims</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>dims</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>cur_depth</span><span class='Delimiter'>, 
</span><a name="LN279"></a>                        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>arraytypid</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>elemtypid</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Declare_Parameter'>typmod</span><span class='Delimiter'>, 
</span><a name="LN280"></a>                        <a href="../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>finfo</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>typioparam</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN281"></a><span class='Keyword'>static </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Prototype'>plperl_hash_to_datum</span><span class='Parentheses'>(</span>SV <span class='Operator'>*</span><span class='Declare_Parameter'>src</span><span class='Delimiter'>, </span><a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>td</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN283"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>plperl_init_shared_libs</span><span class='Parentheses'>(</span><a href="ppport.h.html#LN3214"><span class='Ref_to_Const'>pTHX</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN284"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>plperl_trusted_init</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN285"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>plperl_untrusted_init</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN286"></a><span class='Keyword'>static </span>HV  <span class='Operator'>*</span><span class='Declare_Prototype'>plperl_spi_execute_fetch_result</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>SPITupleTable</span> <span class='Operator'>*</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a><span class='Delimiter'>, </span><span class='Keyword'>int</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN287"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Prototype'>hek2cstr</span><span class='Parentheses'>(</span>HE <span class='Operator'>*</span><span class='Declare_Parameter'>he</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN288"></a><span class='Keyword'>static </span>SV <span class='Operator'>**</span><span class='Declare_Prototype'>hv_store_string</span><span class='Parentheses'>(</span>HV <span class='Operator'>*</span><span class='Declare_Parameter'>hv</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>key</span><span class='Delimiter'>, </span>SV <span class='Operator'>*</span><span class='Declare_Parameter'>val</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN289"></a><span class='Keyword'>static </span>SV <span class='Operator'>**</span><span class='Declare_Prototype'>hv_fetch_string</span><span class='Parentheses'>(</span>HV <span class='Operator'>*</span><span class='Declare_Parameter'>hv</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>key</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN290"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>plperl_create_sub</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN105"><span class='Ref_to_Struct'>plperl_proc_desc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>desc</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>s</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>fn_oid</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN291"></a><span class='Keyword'>static </span>SV  <span class='Operator'>*</span><span class='Declare_Prototype'>plperl_call_perl_func</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN105"><span class='Ref_to_Struct'>plperl_proc_desc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>desc</span><span class='Delimiter'>, 
</span><a name="LN292"></a>                      <a href="../../include/fmgr.h.html#LN37"><span class='Ref_to_Typedef'>FunctionCallInfo</span></a> <span class='Declare_Parameter'>fcinfo</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN293"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>plperl_compile_callback</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN294"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>plperl_exec_callback</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN295"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>plperl_inline_callback</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN296"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Prototype'>strip_trailing_ws</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN297"></a><span class='Keyword'>static </span>OP  <span class='Operator'>*</span><span class='Declare_Prototype'>pp_require_safe</span><span class='Parentheses'>(</span><a href="ppport.h.html#LN3214"><span class='Ref_to_Const'>pTHX</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN298"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>activate_interpreter</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN88"><span class='Ref_to_Struct'>plperl_interp_desc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>interp_desc</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN301"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Prototype'>setlocale_perl</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>category</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>locale</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* 
 * convert a HE (hash entry) key to a cstr in the current database encoding 
 */ 
</span><span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN308"></a><span class='Declare_Function'>hek2cstr</span><span class='Parentheses'>(</span>HE <span class='Operator'>*</span><span class='Declare_Parameter'>he</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN310"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>ret</span><span class='Delimiter'>; 
</span><a name="LN311"></a>    SV         <span class='Operator'>*</span><span class='Declare_Local'>sv</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * HeSVKEY_force will return a temporary mortal SV*, so we need to make 
     * sure to free it with ENTER/SAVE/FREE/LEAVE 
     */ 
</span>    ENTER<span class='Delimiter'>; 
</span>    SAVETMPS<span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/*------------------------- 
     * Unfortunately,  while HeUTF8 is true for most things &GT; 256, for values 
     * 128..255 it's not, but perl will treat them as unicode code points if 
     * the utf8 flag is not set ( see The "Unicode Bug" in perldoc perlunicode 
     * for more) 
     * 
     * So if we did the expected: 
     *    if (HeUTF8(he)) 
     *        utf_u2e(key...); 
     *    else // must be ascii 
     *        return HePV(he); 
     * we won't match columns with codepoints from 128..255 
     * 
     * For a more concrete example given a column with the name of the unicode 
     * codepoint U+00ae (registered sign) and a UTF8 database and the perl 
     * return_next { "\N{U+00ae}=&GT;'text } would always fail as heUTF8 returns 
     * 0 and HePV() would give us a char * with 1 byte contains the decimal 
     * value 174 
     * 
     * Perl has the brains to know when it should utf8 encode 174 properly, so 
     * here we force it into an SV so that perl will figure it out and do the 
     * right thing 
     *------------------------- 
     */ 
</span> 
    <a href="plperl.c.html#LN311"><span class='Ref_To_Local'>sv</span></a> <span class='Operator'>= </span>HeSVKEY_force<span class='Parentheses'>(</span><a href="plperl.c.html#LN308"><span class='Ref_to_Parameter'>he</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.h.html#LN80"><span class='Ref_to_Macro'>HeUTF8</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN308"><span class='Ref_to_Parameter'>he</span></a><span class='Parentheses'>))</span> 
        SvUTF8_on<span class='Parentheses'>(</span><a href="plperl.c.html#LN311"><span class='Ref_To_Local'>sv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN310"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><a href="plperl_helpers.h.html#LN49"><span class='Ref_to_Func'>sv2cstr</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN311"><span class='Ref_To_Local'>sv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* free sv */ 
</span>    FREETMPS<span class='Delimiter'>; 
</span>    LEAVE<span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="plperl.c.html#LN310"><span class='Ref_To_Local'>ret</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end hek2cstr &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * _PG_init()           - library load-time initialization 
 * 
 * DO NOT make this static nor change its name! 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN364"></a><span class='Declare_Function'>_PG_init</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Be sure we do initialization only once. 
     * 
     * If initialization fails due to, e.g., plperl_init_interp() throwing an 
     * exception, then we'll return here on the next usage and the user will 
     * get a rather cryptic: ERROR:  attempt to redefine parameter 
     * "plperl.use_strict" 
     */ 
</span><a name="LN374"></a>    <span class='Keyword'>static bool </span><span class='Declare_Local'>inited</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN375"></a>    <a href="../../include/utils/hsearch.h.html#LN64"><span class='Ref_to_Struct'>HASHCTL</span></a>     <span class='Declare_Local'>hash_ctl</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN374"><span class='Ref_To_Local'>inited</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Support localized messages. 
     */ 
</span>    <a href="../../include/miscadmin.h.html#LN467"><span class='Ref_to_Proto'>pg_bindtextdomain</span></a><span class='Parentheses'>(</span><a href="../plpgsql/src/plpgsql.h.html#LN29"><span class='Ref_to_Const'>TEXTDOMAIN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Initialize plperl's GUCs. 
     */ 
</span>    <a href="../../include/utils/guc.h.html#LN279"><span class='Ref_to_Proto'>DefineCustomBoolVariable</span></a><span class='Parentheses'>(</span><span class='String'>"plperl.use_strict"</span><span class='Delimiter'>, 
</span>                             <a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"If true, trusted and untrusted Perl code will be compiled in strict mode."</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                             <span class='Operator'>&</span><a href="plperl.c.html#LN233"><span class='Ref_to_Global_Var'>plperl_use_strict</span></a><span class='Delimiter'>, 
</span>                             <span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                             <a href="../../include/utils/guc.h.html#LN75"><span class='Ref_to_EnumConst'>PGC_USERSET</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                             <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * plperl.on_init is marked PGC_SIGHUP to support the idea that it might 
     * be executed in the postmaster (if plperl is loaded into the postmaster 
     * via shared_preload_libraries).  This isn't really right either way, 
     * though. 
     */ 
</span>    <a href="../../include/utils/guc.h.html#LN319"><span class='Ref_to_Proto'>DefineCustomStringVariable</span></a><span class='Parentheses'>(</span><span class='String'>"plperl.on_init"</span><span class='Delimiter'>, 
</span>                               <a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"Perl initialization code to execute when a Perl interpreter is initialized."</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                               <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                               <span class='Operator'>&</span><a href="plperl.c.html#LN234"><span class='Ref_to_Global_Var'>plperl_on_init</span></a><span class='Delimiter'>, 
</span>                               <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                               <a href="../../include/utils/guc.h.html#LN71"><span class='Ref_to_EnumConst'>PGC_SIGHUP</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                               <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * plperl.on_plperl_init is marked PGC_SUSET to avoid issues whereby a 
     * user who might not even have USAGE privilege on the plperl language 
     * could nonetheless use SET plperl.on_plperl_init='...' to influence the 
     * behaviour of any existing plperl function that they can execute (which 
     * might be SECURITY DEFINER, leading to a privilege escalation).  See 
     * http://archives.postgresql.org/pgsql-hackers/2010-02/msg00281.php and 
     * the overall thread. 
     * 
     * Note that because plperl.use_strict is USERSET, a nefarious user could 
     * set it to be applied against other people's functions.  This is judged 
     * OK since the worst result would be an error.  Your code oughta pass 
     * use_strict anyway ;-) 
     */ 
</span>    <a href="../../include/utils/guc.h.html#LN319"><span class='Ref_to_Proto'>DefineCustomStringVariable</span></a><span class='Parentheses'>(</span><span class='String'>"plperl.on_plperl_init"</span><span class='Delimiter'>, 
</span>                               <a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"Perl initialization code to execute once when plperl is first used."</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                               <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                               <span class='Operator'>&</span><a href="plperl.c.html#LN235"><span class='Ref_to_Global_Var'>plperl_on_plperl_init</span></a><span class='Delimiter'>, 
</span>                               <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                               <a href="../../include/utils/guc.h.html#LN74"><span class='Ref_to_EnumConst'>PGC_SUSET</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                               <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/guc.h.html#LN319"><span class='Ref_to_Proto'>DefineCustomStringVariable</span></a><span class='Parentheses'>(</span><span class='String'>"plperl.on_plperlu_init"</span><span class='Delimiter'>, 
</span>                               <a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"Perl initialization code to execute once when plperlu is first used."</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                               <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                               <span class='Operator'>&</span><a href="plperl.c.html#LN236"><span class='Ref_to_Global_Var'>plperl_on_plperlu_init</span></a><span class='Delimiter'>, 
</span>                               <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                               <a href="../../include/utils/guc.h.html#LN74"><span class='Ref_to_EnumConst'>PGC_SUSET</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                               <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/guc.h.html#LN344"><span class='Ref_to_Proto'>EmitWarningsOnPlaceholders</span></a><span class='Parentheses'>(</span><span class='String'>"plperl"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create hash tables. 
     */ 
</span>    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="plperl.c.html#LN375"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN375"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN375"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN375"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN88"><span class='Ref_to_Struct'>plperl_interp_desc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN225"><span class='Ref_to_Global_Var'>plperl_interp_hash</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN121"><span class='Ref_to_Proto'>hash_create</span></a><span class='Parentheses'>(</span><span class='String'>"PL/Perl interpreters"</span><span class='Delimiter'>, 
</span>                                     <span class='Number'>8</span><span class='Delimiter'>, 
</span>                                     <span class='Operator'>&</span><a href="plperl.c.html#LN375"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Delimiter'>, 
</span>                                     <a href="../../include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a> <span class='Operator'>| </span><a href="../../include/utils/hsearch.h.html#LN87"><span class='Ref_to_Const'>HASH_BLOBS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="plperl.c.html#LN375"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN375"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN375"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN154"><span class='Ref_to_Struct'>plperl_proc_key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN375"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN166"><span class='Ref_to_Struct'>plperl_proc_ptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN226"><span class='Ref_to_Global_Var'>plperl_proc_hash</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN121"><span class='Ref_to_Proto'>hash_create</span></a><span class='Parentheses'>(</span><span class='String'>"PL/Perl procedures"</span><span class='Delimiter'>, 
</span>                                   <span class='Number'>32</span><span class='Delimiter'>, 
</span>                                   <span class='Operator'>&</span><a href="plperl.c.html#LN375"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Delimiter'>, 
</span>                                   <a href="../../include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a> <span class='Operator'>| </span><a href="../../include/utils/hsearch.h.html#LN87"><span class='Ref_to_Const'>HASH_BLOBS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Save the default opmask. 
     */ 
</span>    PLPERL_SET_OPMASK<span class='Parentheses'>(</span><a href="plperl.c.html#LN240"><span class='Ref_to_Global_Var'>plperl_opmask</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create the first Perl interpreter, but only partially initialize it. 
     */ 
</span>    <a href="plperl.c.html#LN230"><span class='Ref_to_Global_Var'>plperl_held_interp</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN250"><span class='Ref_to_Proto'>plperl_init_interp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN374"><span class='Ref_To_Local'>inited</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _PG_init &raquo; </span> 
 
 
<span class='Keyword'>static void 
</span><a name="LN476"></a><span class='Declare_Function'>set_interp_require</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>trusted</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN476"><span class='Ref_to_Parameter'>trusted</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="ppport.h.html#LN4084"><span class='Ref_to_Const'>PL_ppaddr</span></a><span class='Delimiter'>[</span>OP_REQUIRE<span class='Delimiter'>] </span><span class='Operator'>= </span><a href="plperl.c.html#LN297"><span class='Ref_to_Proto'>pp_require_safe</span></a><span class='Delimiter'>; 
</span>        <a href="ppport.h.html#LN4084"><span class='Ref_to_Const'>PL_ppaddr</span></a><span class='Delimiter'>[</span>OP_DOFILE<span class='Delimiter'>] </span><span class='Operator'>= </span><a href="plperl.c.html#LN297"><span class='Ref_to_Proto'>pp_require_safe</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="ppport.h.html#LN4084"><span class='Ref_to_Const'>PL_ppaddr</span></a><span class='Delimiter'>[</span>OP_REQUIRE<span class='Delimiter'>] </span><span class='Operator'>= </span>pp_require_orig<span class='Delimiter'>; 
</span>        <a href="ppport.h.html#LN4084"><span class='Ref_to_Const'>PL_ppaddr</span></a><span class='Delimiter'>[</span>OP_DOFILE<span class='Delimiter'>] </span><span class='Operator'>= </span>pp_require_orig<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Cleanup perl interpreters, including running END blocks. 
 * Does not fully undo the actions of _PG_init() nor make it callable again. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN495"></a><span class='Declare_Function'>plperl_fini</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>code</span><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN497"></a>    <a href="../../include/utils/hsearch.h.html#LN111"><span class='Ref_to_Typedef'>HASH_SEQ_STATUS</span></a> <span class='Declare_Local'>hash_seq</span><span class='Delimiter'>; 
</span><a name="LN498"></a>    <a href="plperl.c.html#LN88"><span class='Ref_to_Struct'>plperl_interp_desc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>interp_desc</span><span class='Delimiter'>; 
</span> 
    <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN22"><span class='Ref_to_Const'>DEBUG3</span></a><span class='Delimiter'>, </span><span class='String'>"plperl_fini"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Indicate that perl is terminating. Disables use of spi_* functions when 
     * running END/DESTROY code. See check_spi_usage_allowed(). Could be 
     * enabled in future, with care, using a transaction 
     * http://archives.postgresql.org/pgsql-hackers/2010-01/msg02743.php 
     */ 
</span>    <a href="plperl.c.html#LN238"><span class='Ref_to_Global_Var'>plperl_ending</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Only perform perl cleanup if we're exiting cleanly */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN495"><span class='Ref_to_Parameter'>code</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN22"><span class='Ref_to_Const'>DEBUG3</span></a><span class='Delimiter'>, </span><span class='String'>"plperl_fini: skipped"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Zap the "held" interpreter, if we still have it */ 
</span>    <a href="plperl.c.html#LN251"><span class='Ref_to_Proto'>plperl_destroy_interp</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="plperl.c.html#LN230"><span class='Ref_to_Global_Var'>plperl_held_interp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Zap any fully-initialized interpreters */ 
</span>    <a href="../../include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="plperl.c.html#LN497"><span class='Ref_To_Local'>hash_seq</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN225"><span class='Ref_to_Global_Var'>plperl_interp_hash</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="plperl.c.html#LN498"><span class='Ref_To_Local'>interp_desc</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN135"><span class='Ref_to_Proto'>hash_seq_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="plperl.c.html#LN497"><span class='Ref_To_Local'>hash_seq</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN498"><span class='Ref_To_Local'>interp_desc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN91"><span class='Ref_to_Member'>interp</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="plperl.c.html#LN298"><span class='Ref_to_Proto'>activate_interpreter</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN498"><span class='Ref_To_Local'>interp_desc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="plperl.c.html#LN251"><span class='Ref_to_Proto'>plperl_destroy_interp</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="plperl.c.html#LN498"><span class='Ref_To_Local'>interp_desc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN91"><span class='Ref_to_Member'>interp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN22"><span class='Ref_to_Const'>DEBUG3</span></a><span class='Delimiter'>, </span><span class='String'>"plperl_fini: done"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end plperl_fini &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Select and activate an appropriate Perl interpreter. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN539"></a><span class='Declare_Function'>select_perl_context</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>trusted</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN541"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>user_id</span><span class='Delimiter'>; 
</span><a name="LN542"></a>    <a href="plperl.c.html#LN88"><span class='Ref_to_Struct'>plperl_interp_desc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>interp_desc</span><span class='Delimiter'>; 
</span><a name="LN543"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span><a name="LN544"></a>    PerlInterpreter <span class='Operator'>*</span><span class='Declare_Local'>interp</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Find or create the interpreter hashtable entry for this userid */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN539"><span class='Ref_to_Parameter'>trusted</span></a><span class='Parentheses'>) 
</span>        <a href="plperl.c.html#LN541"><span class='Ref_To_Local'>user_id</span></a> <span class='Operator'>= </span><a href="../../backend/utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="plperl.c.html#LN541"><span class='Ref_To_Local'>user_id</span></a> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN542"><span class='Ref_To_Local'>interp_desc</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN225"><span class='Ref_to_Global_Var'>plperl_interp_hash</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN541"><span class='Ref_To_Local'>user_id</span></a><span class='Delimiter'>, 
</span>                              <a href="../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a><span class='Delimiter'>, 
</span>                              <span class='Operator'>&</span><a href="plperl.c.html#LN543"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plperl.c.html#LN543"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Initialize newly-created hashtable entry */ 
</span>        <a href="plperl.c.html#LN542"><span class='Ref_To_Local'>interp_desc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN91"><span class='Ref_to_Member'>interp</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN542"><span class='Ref_To_Local'>interp_desc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN92"><span class='Ref_to_Member'>query_hash</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Make sure we have a query_hash for this interpreter */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN542"><span class='Ref_To_Local'>interp_desc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN92"><span class='Ref_to_Member'>query_hash</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN565"></a>        <a href="../../include/utils/hsearch.h.html#LN64"><span class='Ref_to_Struct'>HASHCTL</span></a>     <span class='Declare_Local'>hash_ctl</span><span class='Delimiter'>; 
</span> 
        memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="plperl.c.html#LN565"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN565"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN565"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><a href="../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN565"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN201"><span class='Ref_to_Struct'>plperl_query_entry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN542"><span class='Ref_To_Local'>interp_desc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN92"><span class='Ref_to_Member'>query_hash</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN121"><span class='Ref_to_Proto'>hash_create</span></a><span class='Parentheses'>(</span><span class='String'>"PL/Perl queries"</span><span class='Delimiter'>, 
</span>                                              <span class='Number'>32</span><span class='Delimiter'>, 
</span>                                              <span class='Operator'>&</span><a href="plperl.c.html#LN565"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Delimiter'>, 
</span>                                              <a href="../../include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Quick exit if already have an interpreter 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN542"><span class='Ref_To_Local'>interp_desc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN91"><span class='Ref_to_Member'>interp</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="plperl.c.html#LN298"><span class='Ref_to_Proto'>activate_interpreter</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN542"><span class='Ref_To_Local'>interp_desc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * adopt held interp if free, else create new one if possible 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN230"><span class='Ref_to_Global_Var'>plperl_held_interp</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* first actual use of a perl interpreter */ 
</span>        <a href="plperl.c.html#LN544"><span class='Ref_To_Local'>interp</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN230"><span class='Ref_to_Global_Var'>plperl_held_interp</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Reset the plperl_held_interp pointer first; if we fail during init 
         * we don't want to try again with the partially-initialized interp. 
         */ 
</span>        <a href="plperl.c.html#LN230"><span class='Ref_to_Global_Var'>plperl_held_interp</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN539"><span class='Ref_to_Parameter'>trusted</span></a><span class='Parentheses'>) 
</span>            <a href="plperl.c.html#LN284"><span class='Ref_to_Proto'>plperl_trusted_init</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="plperl.c.html#LN285"><span class='Ref_to_Proto'>plperl_untrusted_init</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* successfully initialized, so arrange for cleanup */ 
</span>        <a href="../../include/storage/ipc.h.html#LN68"><span class='Ref_to_Proto'>on_proc_exit</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN252"><span class='Ref_to_Proto'>plperl_fini</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> MULTIPLICITY 
 
        <span class='Comment_Multi_Line'>/* 
         * plperl_init_interp will change Perl's idea of the active 
         * interpreter.  Reset plperl_active_interp temporarily, so that if we 
         * hit an error partway through here, we'll make sure to switch back 
         * to a non-broken interpreter before running any other Perl 
         * functions. 
         */ 
</span>        <a href="plperl.c.html#LN227"><span class='Ref_to_Global_Var'>plperl_active_interp</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Now build the new interpreter */ 
</span>        <a href="plperl.c.html#LN544"><span class='Ref_To_Local'>interp</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN250"><span class='Ref_to_Proto'>plperl_init_interp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN539"><span class='Ref_to_Parameter'>trusted</span></a><span class='Parentheses'>) 
</span>            <a href="plperl.c.html#LN284"><span class='Ref_to_Proto'>plperl_trusted_init</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="plperl.c.html#LN285"><span class='Ref_to_Proto'>plperl_untrusted_init</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot allocate multiple Perl interpreters on this platform"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <a href="plperl.c.html#LN253"><span class='Ref_to_Proto'>set_interp_require</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN539"><span class='Ref_to_Parameter'>trusted</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Since the timing of first use of PL/Perl can't be predicted, any 
     * database interaction during initialization is problematic. Including, 
     * but not limited to, security definer issues. So we only enable access 
     * to the database AFTER on_*_init code has run. See 
     * http://archives.postgresql.org/pgsql-hackers/2010-01/msg02669.php 
     */ 
</span>    newXS<span class='Parentheses'>(</span><span class='String'>"PostgreSQL::InServer::SPI::bootstrap"</span><span class='Delimiter'>, 
</span>          <a href="plperl.c.html#LN59"><span class='Ref_to_Proto'>boot_PostgreSQL__InServer__SPI</span></a><span class='Delimiter'>, </span>__FILE__<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="ppport.h.html#LN4313"><span class='Ref_to_Macro'>eval_pv</span></a><span class='Parentheses'>(</span><span class='String'>"PostgreSQL::InServer::SPI::bootstrap()"</span><span class='Delimiter'>, </span><span class='Boolean'>FALSE</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>SvTRUE<span class='Parentheses'>(</span><a href="ppport.h.html#LN3858"><span class='Ref_to_Const'>ERRSV</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_EXTERNAL_ROUTINE_EXCEPTION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="plperl.c.html#LN296"><span class='Ref_to_Proto'>strip_trailing_ws</span></a><span class='Parentheses'>(</span><a href="plperl_helpers.h.html#LN49"><span class='Ref_to_Func'>sv2cstr</span></a><span class='Parentheses'>(</span><a href="ppport.h.html#LN3858"><span class='Ref_to_Const'>ERRSV</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>, 
</span>        errcontext<span class='Parentheses'>(</span><span class='String'>"while executing PostgreSQL::InServer::SPI::bootstrap"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Fully initialized, so mark the hashtable entry valid */ 
</span>    <a href="plperl.c.html#LN542"><span class='Ref_To_Local'>interp_desc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN91"><span class='Ref_to_Member'>interp</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN544"><span class='Ref_To_Local'>interp</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* And mark this as the active interpreter */ 
</span>    <a href="plperl.c.html#LN227"><span class='Ref_to_Global_Var'>plperl_active_interp</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN542"><span class='Ref_To_Local'>interp_desc</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end select_perl_context &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Make the specified interpreter the active one 
 * 
 * A call with NULL does nothing.  This is so that "restoring" to a previously 
 * null state of plperl_active_interp doesn't result in useless thrashing. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN667"></a><span class='Declare_Function'>activate_interpreter</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN88"><span class='Ref_to_Struct'>plperl_interp_desc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>interp_desc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN667"><span class='Ref_to_Parameter'>interp_desc</span></a> <span class='Operator'>&& </span><a href="plperl.c.html#LN227"><span class='Ref_to_Global_Var'>plperl_active_interp</span></a> <span class='Operator'>!= </span><a href="plperl.c.html#LN667"><span class='Ref_to_Parameter'>interp_desc</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN667"><span class='Ref_to_Parameter'>interp_desc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN91"><span class='Ref_to_Member'>interp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        PERL_SET_CONTEXT<span class='Parentheses'>(</span><a href="plperl.c.html#LN667"><span class='Ref_to_Parameter'>interp_desc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN91"><span class='Ref_to_Member'>interp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* trusted iff user_id isn't InvalidOid */ 
</span>        <a href="plperl.c.html#LN253"><span class='Ref_to_Proto'>set_interp_require</span></a><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN667"><span class='Ref_to_Parameter'>interp_desc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN90"><span class='Ref_to_Member'>user_id</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN227"><span class='Ref_to_Global_Var'>plperl_active_interp</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN667"><span class='Ref_to_Parameter'>interp_desc</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Create a new Perl interpreter. 
 * 
 * We initialize the interpreter as far as we can without knowing whether 
 * it will become a trusted or untrusted interpreter; in particular, the 
 * plperl.on_init code will get executed.  Later, either plperl_trusted_init 
 * or plperl_untrusted_init must be called to complete the initialization. 
 */ 
</span><span class='Keyword'>static </span>PerlInterpreter <span class='Operator'>* 
</span><a name="LN688"></a><span class='Declare_Function'>plperl_init_interp</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN690"></a>    PerlInterpreter <span class='Operator'>*</span><span class='Declare_Local'>plperl</span><span class='Delimiter'>; 
</span> 
<a name="LN692"></a>    <span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Local'>embedding</span><span class='Delimiter'>[</span><span class='Number'>3</span> <span class='Operator'>+ </span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Delimiter'>{ 
</span>        <span class='String'>""</span><span class='Delimiter'>, </span><span class='String'>"-e"</span><span class='Delimiter'>, </span>PLC_PERLBOOT 
    <span class='Delimiter'>}; 
</span><a name="LN695"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nargs</span> <span class='Operator'>= </span><span class='Number'>3</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
 
    <span class='Comment_Multi_Line'>/* 
     * The perl library on startup does horrible things like call 
     * setlocale(LC_ALL,""). We have protected against that on most platforms 
     * by setting the environment appropriately. However, on Windows, 
     * setlocale() does not consult the environment, so we need to save the 
     * existing locale settings before perl has a chance to mangle them and 
     * restore them after its dirty deeds are done. 
     * 
     * MSDN ref: 
     * http://msdn.microsoft.com/library/en-us/vclib/html/_crt_locale.asp 
     * 
     * It appears that we only need to do this on interpreter startup, and 
     * subsequent calls to the interpreter don't mess with the locale 
     * settings. 
     * 
     * We restore them using setlocale_perl(), defined below, so that Perl 
     * doesn't have a different idea of the locale from Postgres. 
     * 
     */ 
</span> 
<a name="LN719"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>loc</span><span class='Delimiter'>; 
</span><a name="LN720"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>save_collate</span><span class='Delimiter'>, 
</span><a name="LN721"></a>               <span class='Operator'>*</span><span class='Declare_Local'>save_ctype</span><span class='Delimiter'>, 
</span><a name="LN722"></a>               <span class='Operator'>*</span><span class='Declare_Local'>save_monetary</span><span class='Delimiter'>, 
</span><a name="LN723"></a>               <span class='Operator'>*</span><span class='Declare_Local'>save_numeric</span><span class='Delimiter'>, 
</span><a name="LN724"></a>               <span class='Operator'>*</span><span class='Declare_Local'>save_time</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN719"><span class='Ref_To_Local'>loc</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN201"><span class='Ref_to_Macro'>setlocale</span></a><span class='Parentheses'>(</span>LC_COLLATE<span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN720"><span class='Ref_To_Local'>save_collate</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN719"><span class='Ref_To_Local'>loc</span></a> <span class='Operator'>? </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN719"><span class='Ref_To_Local'>loc</span></a><span class='Parentheses'>) </span><span class='Operator'>: </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN719"><span class='Ref_To_Local'>loc</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN201"><span class='Ref_to_Macro'>setlocale</span></a><span class='Parentheses'>(</span>LC_CTYPE<span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN721"><span class='Ref_To_Local'>save_ctype</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN719"><span class='Ref_To_Local'>loc</span></a> <span class='Operator'>? </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN719"><span class='Ref_To_Local'>loc</span></a><span class='Parentheses'>) </span><span class='Operator'>: </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN719"><span class='Ref_To_Local'>loc</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN201"><span class='Ref_to_Macro'>setlocale</span></a><span class='Parentheses'>(</span>LC_MONETARY<span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN722"><span class='Ref_To_Local'>save_monetary</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN719"><span class='Ref_To_Local'>loc</span></a> <span class='Operator'>? </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN719"><span class='Ref_To_Local'>loc</span></a><span class='Parentheses'>) </span><span class='Operator'>: </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN719"><span class='Ref_To_Local'>loc</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN201"><span class='Ref_to_Macro'>setlocale</span></a><span class='Parentheses'>(</span>LC_NUMERIC<span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN723"><span class='Ref_To_Local'>save_numeric</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN719"><span class='Ref_To_Local'>loc</span></a> <span class='Operator'>? </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN719"><span class='Ref_To_Local'>loc</span></a><span class='Parentheses'>) </span><span class='Operator'>: </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN719"><span class='Ref_To_Local'>loc</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN201"><span class='Ref_to_Macro'>setlocale</span></a><span class='Parentheses'>(</span>LC_TIME<span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN724"><span class='Ref_To_Local'>save_time</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN719"><span class='Ref_To_Local'>loc</span></a> <span class='Operator'>? </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN719"><span class='Ref_To_Local'>loc</span></a><span class='Parentheses'>) </span><span class='Operator'>: </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<a name="LN737"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>PLPERL_RESTORE_LOCALE</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>name</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>saved</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <a href="ppport.h.html#LN3825"><span class='Ref_to_Const'>STMT_START</span></a> <span class='Delimiter'>{ </span><span class='Operator'>\ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>saved <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) </span><span class='Delimiter'>{ </span><a href="plperl.c.html#LN301"><span class='Ref_to_Proto'>setlocale_perl</span></a><span class='Parentheses'>(</span>name<span class='Delimiter'>, </span>saved<span class='Parentheses'>)</span><span class='Delimiter'>; </span><a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span>saved<span class='Parentheses'>)</span><span class='Delimiter'>; } </span><span class='Operator'>\ 
</span>    <span class='Delimiter'>} </span><a href="ppport.h.html#LN3826"><span class='Ref_to_Const'>STMT_END</span></a> 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* WIN32 */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN234"><span class='Ref_to_Global_Var'>plperl_on_init</span></a> <span class='Operator'>&& *</span><a href="plperl.c.html#LN234"><span class='Ref_to_Global_Var'>plperl_on_init</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="plperl.c.html#LN692"><span class='Ref_To_Local'>embedding</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN695"><span class='Ref_To_Local'>nargs</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>"-e"</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN692"><span class='Ref_To_Local'>embedding</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN695"><span class='Ref_To_Local'>nargs</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="plperl.c.html#LN234"><span class='Ref_to_Global_Var'>plperl_on_init</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The perl API docs state that PERL_SYS_INIT3 should be called before 
     * allocating interpreters. Unfortunately, on some platforms this fails in 
     * the Perl_do_taint() routine, which is called when the platform is using 
     * the system's malloc() instead of perl's own. Other platforms, notably 
     * Windows, fail if PERL_SYS_INIT3 is not called. So we call it if it's 
     * available, unless perl is using the system malloc(), which is true when 
     * MYMALLOC is set. 
     */ 
</span><span class='Directive'>#if</span> defined<span class='Parentheses'>(</span>PERL_SYS_INIT3<span class='Parentheses'>) </span><span class='Operator'>&& !</span>defined<span class='Parentheses'>(</span>MYMALLOC<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN760"></a>        <span class='Keyword'>static int</span>  <span class='Declare_Local'>perl_sys_init_done</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* only call this the first time through, as per perlembed man page */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plperl.c.html#LN760"><span class='Ref_To_Local'>perl_sys_init_done</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN765"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>dummy_env</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Delimiter'>{</span><span class='Null_Value'>NULL</span><span class='Delimiter'>}; 
</span> 
            PERL_SYS_INIT3<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="plperl.c.html#LN695"><span class='Ref_To_Local'>nargs</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>***</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="plperl.c.html#LN692"><span class='Ref_To_Local'>embedding</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>***</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="plperl.c.html#LN765"><span class='Ref_To_Local'>dummy_env</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * For unclear reasons, PERL_SYS_INIT3 sets the SIGFPE handler to 
             * SIG_IGN.  Aside from being extremely unfriendly behavior for a 
             * library, this is dumb on the grounds that the results of a 
             * SIGFPE in this state are undefined according to POSIX, and in 
             * fact you get a forced process kill at least on Linux.  Hence, 
             * restore the SIGFPE handler to the backend's standard setting. 
             * (See Perl bug 114574 for more information.) 
             */ 
</span>            <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span>SIGFPE<span class='Delimiter'>, </span><a href="../../backend/tcop/postgres.c.html#LN2667"><span class='Ref_to_Func'>FloatExceptionHandler</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="plperl.c.html#LN760"><span class='Ref_To_Local'>perl_sys_init_done</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* quiet warning if PERL_SYS_INIT3 doesn't use the third argument */ 
</span>            <a href="plperl.c.html#LN765"><span class='Ref_To_Local'>dummy_env</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !perl_sys_init_done &raquo; </span> 
    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
    <a href="plperl.c.html#LN690"><span class='Ref_To_Local'>plperl</span></a> <span class='Operator'>= </span>perl_alloc<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plperl.c.html#LN690"><span class='Ref_To_Local'>plperl</span></a><span class='Parentheses'>) 
</span>        <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not allocate Perl interpreter"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    PERL_SET_CONTEXT<span class='Parentheses'>(</span><a href="plperl.c.html#LN690"><span class='Ref_To_Local'>plperl</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    perl_construct<span class='Parentheses'>(</span><a href="plperl.c.html#LN690"><span class='Ref_To_Local'>plperl</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* run END blocks in perl_destruct instead of perl_run */ 
</span>    PL_exit_flags <span class='Operator'>|= </span>PERL_EXIT_DESTRUCT_END<span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Record the original function for the 'require' and 'dofile' opcodes. 
     * (They share the same implementation.) Ensure it's used for new 
     * interpreters. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>pp_require_orig<span class='Parentheses'>) 
</span>        pp_require_orig <span class='Operator'>= </span><a href="ppport.h.html#LN4084"><span class='Ref_to_Const'>PL_ppaddr</span></a><span class='Delimiter'>[</span>OP_REQUIRE<span class='Delimiter'>]; 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="ppport.h.html#LN4084"><span class='Ref_to_Const'>PL_ppaddr</span></a><span class='Delimiter'>[</span>OP_REQUIRE<span class='Delimiter'>] </span><span class='Operator'>= </span>pp_require_orig<span class='Delimiter'>; 
</span>        <a href="ppport.h.html#LN4084"><span class='Ref_to_Const'>PL_ppaddr</span></a><span class='Delimiter'>[</span>OP_DOFILE<span class='Delimiter'>] </span><span class='Operator'>= </span>pp_require_orig<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
<span class='Directive'>#ifdef</span> PLPERL_ENABLE_OPMASK_EARLY 
 
    <span class='Comment_Multi_Line'>/* 
     * For regression testing to prove that the PLC_PERLBOOT and PLC_TRUSTED 
     * code doesn't even compile any unsafe ops. In future there may be a 
     * valid need for them to do so, in which case this could be softened 
     * (perhaps moved to plperl_trusted_init()) or removed. 
     */ 
</span>    PL_op_mask <span class='Operator'>= </span><a href="plperl.c.html#LN240"><span class='Ref_to_Global_Var'>plperl_opmask</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>perl_parse<span class='Parentheses'>(</span><a href="plperl.c.html#LN690"><span class='Ref_To_Local'>plperl</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN283"><span class='Ref_to_Proto'>plperl_init_shared_libs</span></a><span class='Delimiter'>, 
</span>                   <a href="plperl.c.html#LN695"><span class='Ref_To_Local'>nargs</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN692"><span class='Ref_To_Local'>embedding</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_EXTERNAL_ROUTINE_EXCEPTION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="plperl.c.html#LN296"><span class='Ref_to_Proto'>strip_trailing_ws</span></a><span class='Parentheses'>(</span><a href="plperl_helpers.h.html#LN49"><span class='Ref_to_Func'>sv2cstr</span></a><span class='Parentheses'>(</span><a href="ppport.h.html#LN3858"><span class='Ref_to_Const'>ERRSV</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>, 
</span>                 errcontext<span class='Parentheses'>(</span><span class='String'>"while parsing Perl initialization"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>perl_run<span class='Parentheses'>(</span><a href="plperl.c.html#LN690"><span class='Ref_To_Local'>plperl</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_EXTERNAL_ROUTINE_EXCEPTION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="plperl.c.html#LN296"><span class='Ref_to_Proto'>strip_trailing_ws</span></a><span class='Parentheses'>(</span><a href="plperl_helpers.h.html#LN49"><span class='Ref_to_Func'>sv2cstr</span></a><span class='Parentheses'>(</span><a href="ppport.h.html#LN3858"><span class='Ref_to_Const'>ERRSV</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>, 
</span>                 errcontext<span class='Parentheses'>(</span><span class='String'>"while running Perl initialization"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="plperl.c.html#LN737"><span class='Ref_to_Macro'>PLPERL_RESTORE_LOCALE</span></a> 
    <a href="plperl.c.html#LN737"><span class='Ref_to_Macro'>PLPERL_RESTORE_LOCALE</span></a><span class='Parentheses'>(</span>LC_COLLATE<span class='Delimiter'>, </span><a href="plperl.c.html#LN720"><span class='Ref_To_Local'>save_collate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN737"><span class='Ref_to_Macro'>PLPERL_RESTORE_LOCALE</span></a><span class='Parentheses'>(</span>LC_CTYPE<span class='Delimiter'>, </span><a href="plperl.c.html#LN721"><span class='Ref_To_Local'>save_ctype</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN737"><span class='Ref_to_Macro'>PLPERL_RESTORE_LOCALE</span></a><span class='Parentheses'>(</span>LC_MONETARY<span class='Delimiter'>, </span><a href="plperl.c.html#LN722"><span class='Ref_To_Local'>save_monetary</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN737"><span class='Ref_to_Macro'>PLPERL_RESTORE_LOCALE</span></a><span class='Parentheses'>(</span>LC_NUMERIC<span class='Delimiter'>, </span><a href="plperl.c.html#LN723"><span class='Ref_To_Local'>save_numeric</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN737"><span class='Ref_to_Macro'>PLPERL_RESTORE_LOCALE</span></a><span class='Parentheses'>(</span>LC_TIME<span class='Delimiter'>, </span><a href="plperl.c.html#LN724"><span class='Ref_To_Local'>save_time</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Control'>return</span> <a href="plperl.c.html#LN690"><span class='Ref_To_Local'>plperl</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end plperl_init_interp &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Our safe implementation of the require opcode. 
 * This is safe because it's completely unable to load any code. 
 * If the requested file/module has already been loaded it'll return true. 
 * If not, it'll die. 
 * So now "use Foo;" will work iff Foo has already been loaded. 
 */ 
</span><span class='Keyword'>static </span>OP  <span class='Operator'>* 
</span><a name="LN854"></a><span class='Declare_Function'>pp_require_safe</span><span class='Parentheses'>(</span><a href="ppport.h.html#LN3214"><span class='Ref_to_Const'>pTHX</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="ppport.h.html#LN3933"><span class='Ref_to_Const'>dVAR</span></a><span class='Delimiter'>; 
</span>    dSP<span class='Delimiter'>; 
</span><a name="LN858"></a>    SV         <span class='Operator'>*</span><span class='Declare_Local'>sv</span><span class='Delimiter'>, 
</span><a name="LN859"></a>              <span class='Operator'>**</span><span class='Declare_Local'>svp</span><span class='Delimiter'>; 
</span><a name="LN860"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>name</span><span class='Delimiter'>; 
</span><a name="LN861"></a>    STRLEN      <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN858"><span class='Ref_To_Local'>sv</span></a> <span class='Operator'>= </span>POPs<span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN860"><span class='Ref_To_Local'>name</span></a> <span class='Operator'>= </span>SvPV<span class='Parentheses'>(</span><a href="plperl.c.html#LN858"><span class='Ref_To_Local'>sv</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN861"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN860"><span class='Ref_To_Local'>name</span></a> <span class='Operator'>&& </span><a href="plperl.c.html#LN861"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& *</span><a href="plperl.c.html#LN860"><span class='Ref_To_Local'>name</span></a><span class='Parentheses'>))</span> 
        RETPUSHNO<span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN859"><span class='Ref_To_Local'>svp</span></a> <span class='Operator'>= </span>hv_fetch<span class='Parentheses'>(</span>GvHVn<span class='Parentheses'>(</span>PL_incgv<span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="plperl.c.html#LN860"><span class='Ref_To_Local'>name</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN861"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN859"><span class='Ref_To_Local'>svp</span></a> <span class='Operator'>&& *</span><a href="plperl.c.html#LN859"><span class='Ref_To_Local'>svp</span></a> <span class='Operator'>!= &</span><a href="ppport.h.html#LN4128"><span class='Ref_to_Const'>PL_sv_undef</span></a><span class='Parentheses'>) 
</span>        RETPUSHYES<span class='Delimiter'>; 
</span> 
    DIE<span class='Parentheses'>(</span><a href="ppport.h.html#LN3226"><span class='Ref_to_Const'>aTHX_</span></a> <span class='String'>"Unable to load %s into plperl"</span><span class='Delimiter'>, </span><a href="plperl.c.html#LN860"><span class='Ref_To_Local'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * In most Perl versions, DIE() expands to a return statement, so the next 
     * line is not necessary.  But in versions between but not including 
     * 5.11.1 and 5.13.3 it does not, so the next line is necessary to avoid a 
     * "control reaches end of non-void function" warning from gcc.  Other 
     * compilers such as Solaris Studio will, however, issue a "statement not 
     * reached" warning instead. 
     */ 
</span>    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pp_require_safe &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Destroy one Perl interpreter ... actually we just run END blocks. 
 * 
 * Caller must have ensured this interpreter is the active one. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN892"></a><span class='Declare_Function'>plperl_destroy_interp</span><span class='Parentheses'>(</span>PerlInterpreter <span class='Operator'>**</span><span class='Declare_Parameter'>interp</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN892"><span class='Ref_to_Parameter'>interp</span></a> <span class='Operator'>&& *</span><a href="plperl.c.html#LN892"><span class='Ref_to_Parameter'>interp</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Only a very minimal destruction is performed: - just call END 
         * blocks. 
         * 
         * We could call perl_destruct() but we'd need to audit its actions 
         * very carefully and work-around any that impact us. (Calling 
         * sv_clean_objs() isn't an option because it's not part of perl's 
         * public API so isn't portably available.) Meanwhile END blocks can 
         * be used to perform manual cleanup. 
         */ 
</span> 
        <span class='Comment_Multi_Line'>/* Run END blocks - based on perl's perl_destruct() */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>PL_exit_flags <span class='Operator'>& </span>PERL_EXIT_DESTRUCT_END<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            dJMPENV<span class='Delimiter'>; 
</span><a name="LN911"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>x</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
            JMPENV_PUSH<span class='Parentheses'>(</span><a href="plperl.c.html#LN911"><span class='Ref_To_Local'>x</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="ppport.h.html#LN3729"><span class='Ref_to_Macro'>PERL_UNUSED_VAR</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN911"><span class='Ref_To_Local'>x</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>PL_endav <span class='Operator'>&& !</span>PL_minus_c<span class='Parentheses'>) 
</span>                call_list<span class='Parentheses'>(</span>PL_scopestack_ix<span class='Delimiter'>, </span>PL_endav<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            JMPENV_POP<span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        LEAVE<span class='Delimiter'>; 
</span>        FREETMPS<span class='Delimiter'>; 
</span> 
        <span class='Operator'>*</span><a href="plperl.c.html#LN892"><span class='Ref_to_Parameter'>interp</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if interp&&*interp &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end plperl_destroy_interp &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Initialize the current Perl interpreter as a trusted interp 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN930"></a><span class='Declare_Function'>plperl_trusted_init</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN932"></a>    HV         <span class='Operator'>*</span><span class='Declare_Local'>stash</span><span class='Delimiter'>; 
</span><a name="LN933"></a>    SV         <span class='Operator'>*</span><span class='Declare_Local'>sv</span><span class='Delimiter'>; 
</span><a name="LN934"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>key</span><span class='Delimiter'>; 
</span><a name="LN935"></a>    I32         <span class='Declare_Local'>klen</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* use original require while we set up */ 
</span>    <a href="ppport.h.html#LN4084"><span class='Ref_to_Const'>PL_ppaddr</span></a><span class='Delimiter'>[</span>OP_REQUIRE<span class='Delimiter'>] </span><span class='Operator'>= </span>pp_require_orig<span class='Delimiter'>; 
</span>    <a href="ppport.h.html#LN4084"><span class='Ref_to_Const'>PL_ppaddr</span></a><span class='Delimiter'>[</span>OP_DOFILE<span class='Delimiter'>] </span><span class='Operator'>= </span>pp_require_orig<span class='Delimiter'>; 
</span> 
    <a href="ppport.h.html#LN4313"><span class='Ref_to_Macro'>eval_pv</span></a><span class='Parentheses'>(</span>PLC_TRUSTED<span class='Delimiter'>, </span><span class='Boolean'>FALSE</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>SvTRUE<span class='Parentheses'>(</span><a href="ppport.h.html#LN3858"><span class='Ref_to_Const'>ERRSV</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_EXTERNAL_ROUTINE_EXCEPTION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="plperl.c.html#LN296"><span class='Ref_to_Proto'>strip_trailing_ws</span></a><span class='Parentheses'>(</span><a href="plperl_helpers.h.html#LN49"><span class='Ref_to_Func'>sv2cstr</span></a><span class='Parentheses'>(</span><a href="ppport.h.html#LN3858"><span class='Ref_to_Const'>ERRSV</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>, 
</span>                 errcontext<span class='Parentheses'>(</span><span class='String'>"while executing PLC_TRUSTED"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Force loading of utf8 module now to prevent errors that can arise from 
     * the regex code later trying to load utf8 modules. See 
     * http://rt.perl.org/rt3/Ticket/Display.html?id=47576 
     */ 
</span>    <a href="ppport.h.html#LN4313"><span class='Ref_to_Macro'>eval_pv</span></a><span class='Parentheses'>(</span><span class='String'>"my $a=chr(0x100); return $a =~ /\\xa9/i"</span><span class='Delimiter'>, </span><span class='Boolean'>FALSE</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>SvTRUE<span class='Parentheses'>(</span><a href="ppport.h.html#LN3858"><span class='Ref_to_Const'>ERRSV</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_EXTERNAL_ROUTINE_EXCEPTION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="plperl.c.html#LN296"><span class='Ref_to_Proto'>strip_trailing_ws</span></a><span class='Parentheses'>(</span><a href="plperl_helpers.h.html#LN49"><span class='Ref_to_Func'>sv2cstr</span></a><span class='Parentheses'>(</span><a href="ppport.h.html#LN3858"><span class='Ref_to_Const'>ERRSV</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>, 
</span>                 errcontext<span class='Parentheses'>(</span><span class='String'>"while executing utf8fix"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Lock down the interpreter 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* switch to the safe require/dofile opcode for future code */ 
</span>    <a href="ppport.h.html#LN4084"><span class='Ref_to_Const'>PL_ppaddr</span></a><span class='Delimiter'>[</span>OP_REQUIRE<span class='Delimiter'>] </span><span class='Operator'>= </span><a href="plperl.c.html#LN297"><span class='Ref_to_Proto'>pp_require_safe</span></a><span class='Delimiter'>; 
</span>    <a href="ppport.h.html#LN4084"><span class='Ref_to_Const'>PL_ppaddr</span></a><span class='Delimiter'>[</span>OP_DOFILE<span class='Delimiter'>] </span><span class='Operator'>= </span><a href="plperl.c.html#LN297"><span class='Ref_to_Proto'>pp_require_safe</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * prevent (any more) unsafe opcodes being compiled PL_op_mask is per 
     * interpreter, so this only needs to be set once 
     */ 
</span>    PL_op_mask <span class='Operator'>= </span><a href="plperl.c.html#LN240"><span class='Ref_to_Global_Var'>plperl_opmask</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* delete the DynaLoader:: namespace so extensions can't be loaded */ 
</span>    <a href="plperl.c.html#LN932"><span class='Ref_To_Local'>stash</span></a> <span class='Operator'>= </span>gv_stashpv<span class='Parentheses'>(</span><span class='String'>"DynaLoader"</span><span class='Delimiter'>, </span>GV_ADDWARN<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    hv_iterinit<span class='Parentheses'>(</span><a href="plperl.c.html#LN932"><span class='Ref_To_Local'>stash</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="plperl.c.html#LN933"><span class='Ref_To_Local'>sv</span></a> <span class='Operator'>= </span>hv_iternextsv<span class='Parentheses'>(</span><a href="plperl.c.html#LN932"><span class='Ref_To_Local'>stash</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN934"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN935"><span class='Ref_To_Local'>klen</span></a><span class='Parentheses'>)))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>isGV_with_GP<span class='Parentheses'>(</span><a href="plperl.c.html#LN933"><span class='Ref_To_Local'>sv</span></a><span class='Parentheses'>) </span><span class='Operator'>|| !</span>GvCV<span class='Parentheses'>(</span><a href="plperl.c.html#LN933"><span class='Ref_To_Local'>sv</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        SvREFCNT_dec<span class='Parentheses'>(</span>GvCV<span class='Parentheses'>(</span><a href="plperl.c.html#LN933"><span class='Ref_To_Local'>sv</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* free the CV */ 
</span>        <a href="plperl.h.html#LN87"><span class='Ref_to_Macro'>GvCV_set</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN933"><span class='Ref_To_Local'>sv</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* prevent call via GV */ 
</span>    <span class='Delimiter'>} 
</span>    hv_clear<span class='Parentheses'>(</span><a href="plperl.c.html#LN932"><span class='Ref_To_Local'>stash</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* invalidate assorted caches */ 
</span>    <span class='Operator'>++</span>PL_sub_generation<span class='Delimiter'>; 
</span>    hv_clear<span class='Parentheses'>(</span>PL_stashcache<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Execute plperl.on_plperl_init in the locked-down interpreter 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN235"><span class='Ref_to_Global_Var'>plperl_on_plperl_init</span></a> <span class='Operator'>&& *</span><a href="plperl.c.html#LN235"><span class='Ref_to_Global_Var'>plperl_on_plperl_init</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="ppport.h.html#LN4313"><span class='Ref_to_Macro'>eval_pv</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN235"><span class='Ref_to_Global_Var'>plperl_on_plperl_init</span></a><span class='Delimiter'>, </span><span class='Boolean'>FALSE</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* XXX need to find a way to determine a better errcode here */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>SvTRUE<span class='Parentheses'>(</span><a href="ppport.h.html#LN3858"><span class='Ref_to_Const'>ERRSV</span></a><span class='Parentheses'>))</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_EXTERNAL_ROUTINE_EXCEPTION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="plperl.c.html#LN296"><span class='Ref_to_Proto'>strip_trailing_ws</span></a><span class='Parentheses'>(</span><a href="plperl_helpers.h.html#LN49"><span class='Ref_to_Func'>sv2cstr</span></a><span class='Parentheses'>(</span><a href="ppport.h.html#LN3858"><span class='Ref_to_Const'>ERRSV</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>, 
</span>                     errcontext<span class='Parentheses'>(</span><span class='String'>"while executing plperl.on_plperl_init"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end plperl_trusted_init &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Initialize the current Perl interpreter as an untrusted interp 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1010"></a><span class='Declare_Function'>plperl_untrusted_init</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Nothing to do except execute plperl.on_plperlu_init 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN236"><span class='Ref_to_Global_Var'>plperl_on_plperlu_init</span></a> <span class='Operator'>&& *</span><a href="plperl.c.html#LN236"><span class='Ref_to_Global_Var'>plperl_on_plperlu_init</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="ppport.h.html#LN4313"><span class='Ref_to_Macro'>eval_pv</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN236"><span class='Ref_to_Global_Var'>plperl_on_plperlu_init</span></a><span class='Delimiter'>, </span><span class='Boolean'>FALSE</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>SvTRUE<span class='Parentheses'>(</span><a href="ppport.h.html#LN3858"><span class='Ref_to_Const'>ERRSV</span></a><span class='Parentheses'>))</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_EXTERNAL_ROUTINE_EXCEPTION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="plperl.c.html#LN296"><span class='Ref_to_Proto'>strip_trailing_ws</span></a><span class='Parentheses'>(</span><a href="plperl_helpers.h.html#LN49"><span class='Ref_to_Func'>sv2cstr</span></a><span class='Parentheses'>(</span><a href="ppport.h.html#LN3858"><span class='Ref_to_Const'>ERRSV</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>, 
</span>                     errcontext<span class='Parentheses'>(</span><span class='String'>"while executing plperl.on_plperlu_init"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Perl likes to put a newline after its error messages; clean up such 
 */ 
</span><span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN1031"></a><span class='Declare_Function'>strip_trailing_ws</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1033"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>res</span> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1031"><span class='Ref_to_Parameter'>msg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1034"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>len</span> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="plperl.c.html#LN1033"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN1034"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& </span>isspace<span class='Parentheses'>((</span><span class='Keyword'>unsigned char</span><span class='Parentheses'>) </span><a href="plperl.c.html#LN1033"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN1034"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>))</span> 
        <a href="plperl.c.html#LN1033"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>[</span><span class='Operator'>--</span><a href="plperl.c.html#LN1034"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="plperl.c.html#LN1033"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* Build a tuple from a hash. */ 
</span> 
<span class='Keyword'>static </span><a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> 
<a name="LN1045"></a><span class='Declare_Function'>plperl_build_tuple_result</span><span class='Parentheses'>(</span>HV <span class='Operator'>*</span><span class='Declare_Parameter'>perlhash</span><span class='Delimiter'>, </span><a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>td</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1047"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>values</span><span class='Delimiter'>; 
</span><a name="LN1048"></a>    <span class='Keyword'>bool</span>       <span class='Operator'>*</span><span class='Declare_Local'>nulls</span><span class='Delimiter'>; 
</span><a name="LN1049"></a>    HE         <span class='Operator'>*</span><span class='Declare_Local'>he</span><span class='Delimiter'>; 
</span><a name="LN1050"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tup</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN1047"><span class='Ref_To_Local'>values</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="plperl.c.html#LN1045"><span class='Ref_to_Parameter'>td</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN1048"><span class='Ref_To_Local'>nulls</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>bool</span><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="plperl.c.html#LN1045"><span class='Ref_to_Parameter'>td</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    memset<span class='Parentheses'>(</span><a href="plperl.c.html#LN1048"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>bool</span><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="plperl.c.html#LN1045"><span class='Ref_to_Parameter'>td</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    hv_iterinit<span class='Parentheses'>(</span><a href="plperl.c.html#LN1045"><span class='Ref_to_Parameter'>perlhash</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="plperl.c.html#LN1049"><span class='Ref_To_Local'>he</span></a> <span class='Operator'>= </span>hv_iternext<span class='Parentheses'>(</span><a href="plperl.c.html#LN1045"><span class='Ref_to_Parameter'>perlhash</span></a><span class='Parentheses'>)))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1059"></a>        SV         <span class='Operator'>*</span><span class='Declare_Local'>val</span> <span class='Operator'>= </span>HeVAL<span class='Parentheses'>(</span><a href="plperl.c.html#LN1049"><span class='Ref_To_Local'>he</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1060"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>key</span> <span class='Operator'>= </span><a href="plperl.c.html#LN287"><span class='Ref_to_Proto'>hek2cstr</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1049"><span class='Ref_To_Local'>he</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1061"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>attn</span> <span class='Operator'>= </span><a href="../../include/executor/spi.h.html#LN123"><span class='Ref_to_Proto'>SPI_fnumber</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1045"><span class='Ref_to_Parameter'>td</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1060"><span class='Ref_To_Local'>key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN1061"><span class='Ref_To_Local'>attn</span></a> <span class='Operator'>== </span><a href="../../include/executor/spi.h.html#LN43"><span class='Ref_to_Const'>SPI_ERROR_NOATTRIBUTE</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_COLUMN<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"Perl hash contains nonexistent column \"%s\""</span><span class='Delimiter'>, 
</span>                            <a href="plperl.c.html#LN1060"><span class='Ref_To_Local'>key</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN1061"><span class='Ref_To_Local'>attn</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot set system attribute \"%s\""</span><span class='Delimiter'>, 
</span>                            <a href="plperl.c.html#LN1060"><span class='Ref_To_Local'>key</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="plperl.c.html#LN1047"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN1061"><span class='Ref_To_Local'>attn</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="plperl.c.html#LN271"><span class='Ref_to_Proto'>plperl_sv_to_datum</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1059"><span class='Ref_To_Local'>val</span></a><span class='Delimiter'>, 
</span>                                              <a href="plperl.c.html#LN1045"><span class='Ref_to_Parameter'>td</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN1061"><span class='Ref_To_Local'>attn</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypid<span class='Delimiter'>, 
</span>                                              <a href="plperl.c.html#LN1045"><span class='Ref_to_Parameter'>td</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN1061"><span class='Ref_To_Local'>attn</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypmod<span class='Delimiter'>, 
</span>                                              <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                              <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                              <a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, 
</span>                                              <span class='Operator'>&</span><a href="plperl.c.html#LN1048"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN1061"><span class='Ref_To_Local'>attn</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1060"><span class='Ref_To_Local'>key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (he=hv_iternext(perlh... &raquo; </span> 
    hv_iterinit<span class='Parentheses'>(</span><a href="plperl.c.html#LN1045"><span class='Ref_to_Parameter'>perlhash</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN1050"><span class='Ref_To_Local'>tup</span></a> <span class='Operator'>= </span><a href="../../backend/access/common/heaptuple.c.html#LN690"><span class='Ref_to_Func'>heap_form_tuple</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1045"><span class='Ref_to_Parameter'>td</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1047"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1048"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1047"><span class='Ref_To_Local'>values</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1048"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="plperl.c.html#LN1050"><span class='Ref_To_Local'>tup</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end plperl_build_tuple_result &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* convert a hash reference to a datum */ 
</span><span class='Keyword'>static </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1094"></a><span class='Declare_Function'>plperl_hash_to_datum</span><span class='Parentheses'>(</span>SV <span class='Operator'>*</span><span class='Declare_Parameter'>src</span><span class='Delimiter'>, </span><a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>td</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1096"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tup</span> <span class='Operator'>= </span><a href="plperl.c.html#LN1044"><span class='Ref_to_Func'>plperl_build_tuple_result</span></a><span class='Parentheses'>((</span>HV <span class='Operator'>*</span><span class='Parentheses'>) </span>SvRV<span class='Parentheses'>(</span><a href="plperl.c.html#LN1094"><span class='Ref_to_Parameter'>src</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="plperl.c.html#LN1094"><span class='Ref_to_Parameter'>td</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../include/funcapi.h.html#LN221"><span class='Ref_to_Macro'>HeapTupleGetDatum</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1096"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * if we are an array ref return the reference. this is special in that if we 
 * are a PostgreSQL::InServer::ARRAY object we will return the 'magic' array. 
 */ 
</span><span class='Keyword'>static </span>SV  <span class='Operator'>* 
</span><a name="LN1106"></a><span class='Declare_Function'>get_perl_array_ref</span><span class='Parentheses'>(</span>SV <span class='Operator'>*</span><span class='Declare_Parameter'>sv</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>SvOK<span class='Parentheses'>(</span><a href="plperl.c.html#LN1106"><span class='Ref_to_Parameter'>sv</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span>SvROK<span class='Parentheses'>(</span><a href="plperl.c.html#LN1106"><span class='Ref_to_Parameter'>sv</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>SvTYPE<span class='Parentheses'>(</span>SvRV<span class='Parentheses'>(</span><a href="plperl.c.html#LN1106"><span class='Ref_to_Parameter'>sv</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span>SVt_PVAV<span class='Parentheses'>)</span> 
            <span class='Control'>return</span> <a href="plperl.c.html#LN1106"><span class='Ref_to_Parameter'>sv</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>sv_isa<span class='Parentheses'>(</span><a href="plperl.c.html#LN1106"><span class='Ref_to_Parameter'>sv</span></a><span class='Delimiter'>, </span><span class='String'>"PostgreSQL::InServer::ARRAY"</span><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1114"></a>            HV         <span class='Operator'>*</span><span class='Declare_Local'>hv</span> <span class='Operator'>= </span><span class='Parentheses'>(</span>HV <span class='Operator'>*</span><span class='Parentheses'>) </span>SvRV<span class='Parentheses'>(</span><a href="plperl.c.html#LN1106"><span class='Ref_to_Parameter'>sv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1115"></a>            SV        <span class='Operator'>**</span><span class='Declare_Local'>sav</span> <span class='Operator'>= </span><a href="plperl.c.html#LN289"><span class='Ref_to_Proto'>hv_fetch_string</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1114"><span class='Ref_To_Local'>hv</span></a><span class='Delimiter'>, </span><span class='String'>"array"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="plperl.c.html#LN1115"><span class='Ref_To_Local'>sav</span></a> <span class='Operator'>&& </span>SvOK<span class='Parentheses'>(</span><span class='Operator'>*</span><a href="plperl.c.html#LN1115"><span class='Ref_To_Local'>sav</span></a><span class='Parentheses'>)</span> <span class='Operator'>&& </span>SvROK<span class='Parentheses'>(</span><span class='Operator'>*</span><a href="plperl.c.html#LN1115"><span class='Ref_To_Local'>sav</span></a><span class='Parentheses'>)</span> <span class='Operator'>&& 
</span>                SvTYPE<span class='Parentheses'>(</span>SvRV<span class='Parentheses'>(</span><span class='Operator'>*</span><a href="plperl.c.html#LN1115"><span class='Ref_To_Local'>sav</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span>SVt_PVAV<span class='Parentheses'>)</span> 
                <span class='Control'>return</span> <span class='Operator'>*</span><a href="plperl.c.html#LN1115"><span class='Ref_To_Local'>sav</span></a><span class='Delimiter'>; 
</span> 
            <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not get array reference from PostgreSQL::InServer::ARRAY object"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end get_perl_array_ref &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * helper function for plperl_array_to_datum, recurses for multi-D arrays 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1131"></a><span class='Declare_Function'>array_to_datum_internal</span><span class='Parentheses'>(</span>AV <span class='Operator'>*</span><span class='Declare_Parameter'>av</span><span class='Delimiter'>, </span><a href="../../include/utils/array.h.html#LN167"><span class='Ref_to_Struct'>ArrayBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>astate</span><span class='Delimiter'>, 
</span><a name="LN1132"></a>                        <span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>ndims</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>dims</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>cur_depth</span><span class='Delimiter'>, 
</span><a name="LN1133"></a>                        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>arraytypid</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>elemtypid</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Declare_Parameter'>typmod</span><span class='Delimiter'>, 
</span><a name="LN1134"></a>                        <a href="../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>finfo</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>typioparam</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1136"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1137"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>len</span> <span class='Operator'>= </span>av_len<span class='Parentheses'>(</span><a href="plperl.c.html#LN1131"><span class='Ref_to_Parameter'>av</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN1136"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="plperl.c.html#LN1136"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="plperl.c.html#LN1137"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>; </span><a href="plperl.c.html#LN1136"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* fetch the array element */ 
</span><a name="LN1142"></a>        SV        <span class='Operator'>**</span><span class='Declare_Local'>svp</span> <span class='Operator'>= </span>av_fetch<span class='Parentheses'>(</span><a href="plperl.c.html#LN1131"><span class='Ref_to_Parameter'>av</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1136"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><span class='Boolean'>FALSE</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* see if this element is an array, if so get that */ 
</span><a name="LN1145"></a>        SV         <span class='Operator'>*</span><span class='Declare_Local'>sav</span> <span class='Operator'>= </span><a href="plperl.c.html#LN1142"><span class='Ref_To_Local'>svp</span></a> <span class='Operator'>? </span><a href="plperl.c.html#LN270"><span class='Ref_to_Proto'>get_perl_array_ref</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="plperl.c.html#LN1142"><span class='Ref_To_Local'>svp</span></a><span class='Parentheses'>) </span><span class='Operator'>: </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* multi-dimensional array? */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN1145"><span class='Ref_To_Local'>sav</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1150"></a>            AV         <span class='Operator'>*</span><span class='Declare_Local'>nav</span> <span class='Operator'>= </span><span class='Parentheses'>(</span>AV <span class='Operator'>*</span><span class='Parentheses'>) </span>SvRV<span class='Parentheses'>(</span><a href="plperl.c.html#LN1145"><span class='Ref_To_Local'>sav</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* dimensionality checks */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN1132"><span class='Ref_to_Parameter'>cur_depth</span></a> <span class='Operator'>+ </span><span class='Number'>1</span> <span class='Operator'>&GT; </span><a href="../../include/c.h.html#LN418"><span class='Ref_to_Const'>MAXDIM</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROGRAM_LIMIT_EXCEEDED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"number of array dimensions (%d) exceeds the maximum allowed (%d)"</span><span class='Delimiter'>, 
</span>                                <a href="plperl.c.html#LN1132"><span class='Ref_to_Parameter'>cur_depth</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN418"><span class='Ref_to_Const'>MAXDIM</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* set size when at first element in this level, else compare */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN1136"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& *</span><a href="plperl.c.html#LN1132"><span class='Ref_to_Parameter'>ndims</span></a> <span class='Operator'>== </span><a href="plperl.c.html#LN1132"><span class='Ref_to_Parameter'>cur_depth</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="plperl.c.html#LN1132"><span class='Ref_to_Parameter'>dims</span></a><span class='Delimiter'>[</span><span class='Operator'>*</span><a href="plperl.c.html#LN1132"><span class='Ref_to_Parameter'>ndims</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span>av_len<span class='Parentheses'>(</span><a href="plperl.c.html#LN1150"><span class='Ref_To_Local'>nav</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="plperl.c.html#LN1132"><span class='Ref_to_Parameter'>ndims</span></a><span class='Parentheses'>)</span><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>av_len<span class='Parentheses'>(</span><a href="plperl.c.html#LN1150"><span class='Ref_To_Local'>nav</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span> <span class='Operator'>!= </span><a href="plperl.c.html#LN1132"><span class='Ref_to_Parameter'>dims</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN1132"><span class='Ref_to_Parameter'>cur_depth</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span> 
                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_TEXT_REPRESENTATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"multidimensional arrays must have array expressions with matching dimensions"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* recurse to fetch elements of this sub-array */ 
</span>            <a href="plperl.c.html#LN277"><span class='Ref_to_Proto'>array_to_datum_internal</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1150"><span class='Ref_To_Local'>nav</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1131"><span class='Ref_to_Parameter'>astate</span></a><span class='Delimiter'>, 
</span>                                    <a href="plperl.c.html#LN1132"><span class='Ref_to_Parameter'>ndims</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1132"><span class='Ref_to_Parameter'>dims</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1132"><span class='Ref_to_Parameter'>cur_depth</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                                    <a href="plperl.c.html#LN1133"><span class='Ref_to_Parameter'>arraytypid</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1133"><span class='Ref_to_Parameter'>elemtypid</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1133"><span class='Ref_to_Parameter'>typmod</span></a><span class='Delimiter'>, 
</span>                                    <a href="plperl.c.html#LN1134"><span class='Ref_to_Parameter'>finfo</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1134"><span class='Ref_to_Parameter'>typioparam</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if sav &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1178"></a>            <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>dat</span><span class='Delimiter'>; 
</span><a name="LN1179"></a>            <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* scalar after some sub-arrays at same level? */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="plperl.c.html#LN1132"><span class='Ref_to_Parameter'>ndims</span></a> <span class='Operator'>!= </span><a href="plperl.c.html#LN1132"><span class='Ref_to_Parameter'>cur_depth</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_TEXT_REPRESENTATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"multidimensional arrays must have array expressions with matching dimensions"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
            <a href="plperl.c.html#LN1178"><span class='Ref_To_Local'>dat</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN271"><span class='Ref_to_Proto'>plperl_sv_to_datum</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1142"><span class='Ref_To_Local'>svp</span></a> <span class='Operator'>? *</span><a href="plperl.c.html#LN1142"><span class='Ref_To_Local'>svp</span></a> <span class='Operator'>: </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                     <a href="plperl.c.html#LN1133"><span class='Ref_to_Parameter'>elemtypid</span></a><span class='Delimiter'>, 
</span>                                     <a href="plperl.c.html#LN1133"><span class='Ref_to_Parameter'>typmod</span></a><span class='Delimiter'>, 
</span>                                     <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                     <a href="plperl.c.html#LN1134"><span class='Ref_to_Parameter'>finfo</span></a><span class='Delimiter'>, 
</span>                                     <a href="plperl.c.html#LN1134"><span class='Ref_to_Parameter'>typioparam</span></a><span class='Delimiter'>, 
</span>                                     <span class='Operator'>&</span><a href="plperl.c.html#LN1179"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../include/utils/array.h.html#LN390"><span class='Ref_to_Proto'>accumArrayResult</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1131"><span class='Ref_to_Parameter'>astate</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1178"><span class='Ref_To_Local'>dat</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1179"><span class='Ref_To_Local'>isnull</span></a><span class='Delimiter'>, 
</span>                                    <a href="plperl.c.html#LN1133"><span class='Ref_to_Parameter'>elemtypid</span></a><span class='Delimiter'>, </span><a href="../../backend/utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;len;i++ &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end array_to_datum_internal &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * convert perl array ref to a datum 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1205"></a><span class='Declare_Function'>plperl_array_to_datum</span><span class='Parentheses'>(</span>SV <span class='Operator'>*</span><span class='Declare_Parameter'>src</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>typid</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Declare_Parameter'>typmod</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1207"></a>    <a href="../../include/utils/array.h.html#LN167"><span class='Ref_to_Struct'>ArrayBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>astate</span><span class='Delimiter'>; 
</span><a name="LN1208"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>elemtypid</span><span class='Delimiter'>; 
</span><a name="LN1209"></a>    <a href="../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a>    <span class='Declare_Local'>finfo</span><span class='Delimiter'>; 
</span><a name="LN1210"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>typioparam</span><span class='Delimiter'>; 
</span><a name="LN1211"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>dims</span><span class='Delimiter'>[</span><a href="../../include/c.h.html#LN418"><span class='Ref_to_Const'>MAXDIM</span></a><span class='Delimiter'>]; 
</span><a name="LN1212"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>lbs</span><span class='Delimiter'>[</span><a href="../../include/c.h.html#LN418"><span class='Ref_to_Const'>MAXDIM</span></a><span class='Delimiter'>]; 
</span><a name="LN1213"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ndims</span> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span><a name="LN1214"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN1208"><span class='Ref_To_Local'>elemtypid</span></a> <span class='Operator'>= </span><a href="../../include/utils/lsyscache.h.html#LN157"><span class='Ref_to_Proto'>get_element_type</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1205"><span class='Ref_to_Parameter'>typid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plperl.c.html#LN1208"><span class='Ref_To_Local'>elemtypid</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATATYPE_MISMATCH<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot convert Perl array to non-array type %s"</span><span class='Delimiter'>, 
</span>                        <a href="../../backend/utils/adt/format_type.c.html#LN92"><span class='Ref_to_Func'>format_type_be</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1205"><span class='Ref_to_Parameter'>typid</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN1207"><span class='Ref_To_Local'>astate</span></a> <span class='Operator'>= </span><a href="../../include/utils/array.h.html#LN388"><span class='Ref_to_Proto'>initArrayResult</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1208"><span class='Ref_To_Local'>elemtypid</span></a><span class='Delimiter'>, </span><a href="../../backend/utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN275"><span class='Ref_to_Proto'>_sv_to_datum_finfo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1208"><span class='Ref_To_Local'>elemtypid</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN1209"><span class='Ref_To_Local'>finfo</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN1210"><span class='Ref_To_Local'>typioparam</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    memset<span class='Parentheses'>(</span><a href="plperl.c.html#LN1211"><span class='Ref_To_Local'>dims</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN1211"><span class='Ref_To_Local'>dims</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN1211"><span class='Ref_To_Local'>dims</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span>av_len<span class='Parentheses'>((</span>AV <span class='Operator'>*</span><span class='Parentheses'>) </span>SvRV<span class='Parentheses'>(</span><a href="plperl.c.html#LN1205"><span class='Ref_to_Parameter'>src</span></a><span class='Parentheses'>))</span> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN277"><span class='Ref_to_Proto'>array_to_datum_internal</span></a><span class='Parentheses'>((</span>AV <span class='Operator'>*</span><span class='Parentheses'>) </span>SvRV<span class='Parentheses'>(</span><a href="plperl.c.html#LN1205"><span class='Ref_to_Parameter'>src</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="plperl.c.html#LN1207"><span class='Ref_To_Local'>astate</span></a><span class='Delimiter'>, 
</span>                            <span class='Operator'>&</span><a href="plperl.c.html#LN1213"><span class='Ref_To_Local'>ndims</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1211"><span class='Ref_To_Local'>dims</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                            <a href="plperl.c.html#LN1205"><span class='Ref_to_Parameter'>typid</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1208"><span class='Ref_To_Local'>elemtypid</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1205"><span class='Ref_to_Parameter'>typmod</span></a><span class='Delimiter'>, 
</span>                            <span class='Operator'>&</span><a href="plperl.c.html#LN1209"><span class='Ref_To_Local'>finfo</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1210"><span class='Ref_To_Local'>typioparam</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* ensure we get zero-D array for no inputs, as per PG convention */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN1211"><span class='Ref_To_Local'>dims</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="plperl.c.html#LN1213"><span class='Ref_To_Local'>ndims</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN1214"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="plperl.c.html#LN1214"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="plperl.c.html#LN1213"><span class='Ref_To_Local'>ndims</span></a><span class='Delimiter'>; </span><a href="plperl.c.html#LN1214"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="plperl.c.html#LN1212"><span class='Ref_To_Local'>lbs</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN1214"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../include/utils/array.h.html#LN396"><span class='Ref_to_Proto'>makeMdArrayResult</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1207"><span class='Ref_To_Local'>astate</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1213"><span class='Ref_To_Local'>ndims</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1211"><span class='Ref_To_Local'>dims</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1212"><span class='Ref_To_Local'>lbs</span></a><span class='Delimiter'>, 
</span>                             <a href="../../backend/utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end plperl_array_to_datum &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* Get the information needed to convert data to the specified PG type */ 
</span><span class='Keyword'>static void 
</span><a name="LN1248"></a><span class='Declare_Function'>_sv_to_datum_finfo</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>typid</span><span class='Delimiter'>, </span><a href="../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>finfo</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>typioparam</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1250"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>typinput</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* XXX would be better to cache these lookups */ 
</span>    <a href="../../include/utils/lsyscache.h.html#LN161"><span class='Ref_to_Proto'>getTypeInputInfo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1248"><span class='Ref_to_Parameter'>typid</span></a><span class='Delimiter'>, 
</span>                     <span class='Operator'>&</span><a href="plperl.c.html#LN1250"><span class='Ref_To_Local'>typinput</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1248"><span class='Ref_to_Parameter'>typioparam</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/fmgr.h.html#LN92"><span class='Ref_to_Proto'>fmgr_info</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1250"><span class='Ref_To_Local'>typinput</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1248"><span class='Ref_to_Parameter'>finfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * convert Perl SV to PG datum of type typid, typmod typmod 
 * 
 * Pass the PL/Perl function's fcinfo when attempting to convert to the 
 * function's result type; otherwise pass NULL.  This is used when we need to 
 * resolve the actual result type of a function returning RECORD. 
 * 
 * finfo and typioparam should be the results of _sv_to_datum_finfo for the 
 * given typid, or NULL/InvalidOid to let this function do the lookups. 
 * 
 * *isnull is an output parameter. 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1271"></a><span class='Declare_Function'>plperl_sv_to_datum</span><span class='Parentheses'>(</span>SV <span class='Operator'>*</span><span class='Declare_Parameter'>sv</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>typid</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Declare_Parameter'>typmod</span><span class='Delimiter'>, 
</span><a name="LN1272"></a>                   <a href="../../include/fmgr.h.html#LN37"><span class='Ref_to_Typedef'>FunctionCallInfo</span></a> <span class='Declare_Parameter'>fcinfo</span><span class='Delimiter'>, 
</span><a name="LN1273"></a>                   <a href="../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>finfo</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>typioparam</span><span class='Delimiter'>, 
</span><a name="LN1274"></a>                   <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>isnull</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1276"></a>    <a href="../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a>    <span class='Declare_Local'>tmp</span><span class='Delimiter'>; 
</span><a name="LN1277"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>funcid</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* we might recurse */ 
</span>    <a href="../../include/miscadmin.h.html#LN275"><span class='Ref_to_Proto'>check_stack_depth</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="plperl.c.html#LN1274"><span class='Ref_to_Parameter'>isnull</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Return NULL if result is undef, or if we're in a function returning 
     * VOID.  In the latter case, we should pay no attention to the last Perl 
     * statement's result, and this is a convenient means to ensure that. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plperl.c.html#LN1271"><span class='Ref_to_Parameter'>sv</span></a> <span class='Operator'>|| !</span>SvOK<span class='Parentheses'>(</span><a href="plperl.c.html#LN1271"><span class='Ref_to_Parameter'>sv</span></a><span class='Parentheses'>) </span><span class='Operator'>|| </span><a href="plperl.c.html#LN1271"><span class='Ref_to_Parameter'>typid</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_type.h.html#LN689"><span class='Ref_to_Const'>VOIDOID</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* look up type info if they did not pass it */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plperl.c.html#LN1273"><span class='Ref_to_Parameter'>finfo</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="plperl.c.html#LN275"><span class='Ref_to_Proto'>_sv_to_datum_finfo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1271"><span class='Ref_to_Parameter'>typid</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN1276"><span class='Ref_To_Local'>tmp</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN1273"><span class='Ref_to_Parameter'>typioparam</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="plperl.c.html#LN1273"><span class='Ref_to_Parameter'>finfo</span></a> <span class='Operator'>= &</span><a href="plperl.c.html#LN1276"><span class='Ref_To_Local'>tmp</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Operator'>*</span><a href="plperl.c.html#LN1274"><span class='Ref_to_Parameter'>isnull</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* must call typinput in case it wants to reject NULL */ 
</span>        <span class='Control'>return</span> <a href="../../include/fmgr.h.html#LN642"><span class='Ref_to_Proto'>InputFunctionCall</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1273"><span class='Ref_to_Parameter'>finfo</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="plperl.c.html#LN1273"><span class='Ref_to_Parameter'>typioparam</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1271"><span class='Ref_to_Parameter'>typmod</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="plperl.c.html#LN1277"><span class='Ref_To_Local'>funcid</span></a> <span class='Operator'>= </span><a href="../../include/utils/lsyscache.h.html#LN131"><span class='Ref_to_Proto'>get_transform_tosql</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1271"><span class='Ref_to_Parameter'>typid</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN178"><span class='Ref_to_Member'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN115"><span class='Ref_to_Member'>lang_oid</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN178"><span class='Ref_to_Member'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN116"><span class='Ref_to_Member'>trftypes</span></a><span class='Parentheses'>)))</span> 
        <span class='Control'>return</span> <a href="../../include/fmgr.h.html#LN621"><span class='Ref_to_Macro'>OidFunctionCall1</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1277"><span class='Ref_To_Local'>funcid</span></a><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1271"><span class='Ref_to_Parameter'>sv</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>SvROK<span class='Parentheses'>(</span><a href="plperl.c.html#LN1271"><span class='Ref_to_Parameter'>sv</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* handle references */ 
</span><a name="LN1306"></a>        SV         <span class='Operator'>*</span><span class='Declare_Local'>sav</span> <span class='Operator'>= </span><a href="plperl.c.html#LN270"><span class='Ref_to_Proto'>get_perl_array_ref</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1271"><span class='Ref_to_Parameter'>sv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN1306"><span class='Ref_To_Local'>sav</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* handle an arrayref */ 
</span>            <span class='Control'>return</span> <a href="plperl.c.html#LN276"><span class='Ref_to_Proto'>plperl_array_to_datum</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1306"><span class='Ref_To_Local'>sav</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1271"><span class='Ref_to_Parameter'>typid</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1271"><span class='Ref_to_Parameter'>typmod</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>SvTYPE<span class='Parentheses'>(</span>SvRV<span class='Parentheses'>(</span><a href="plperl.c.html#LN1271"><span class='Ref_to_Parameter'>sv</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span>SVt_PVHV<span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* handle a hashref */ 
</span><a name="LN1316"></a>            <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>ret</span><span class='Delimiter'>; 
</span><a name="LN1317"></a>            <a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>td</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/utils/lsyscache.h.html#LN150"><span class='Ref_to_Proto'>type_is_rowtype</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1271"><span class='Ref_to_Parameter'>typid</span></a><span class='Parentheses'>))</span> 
                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATATYPE_MISMATCH<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                  <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot convert Perl hash to non-composite type %s"</span><span class='Delimiter'>, 
</span>                         <a href="../../backend/utils/adt/format_type.c.html#LN92"><span class='Ref_to_Func'>format_type_be</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1271"><span class='Ref_to_Parameter'>typid</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
            <a href="plperl.c.html#LN1317"><span class='Ref_To_Local'>td</span></a> <span class='Operator'>= </span><a href="../../include/utils/typcache.h.html#LN153"><span class='Ref_to_Proto'>lookup_rowtype_tupdesc_noerror</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1271"><span class='Ref_to_Parameter'>typid</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1271"><span class='Ref_to_Parameter'>typmod</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN1317"><span class='Ref_To_Local'>td</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Try to look it up based on our result type */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN1272"><span class='Ref_to_Parameter'>fcinfo</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| 
</span>                <a href="../../include/funcapi.h.html#LN157"><span class='Ref_to_Proto'>get_call_result_type</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1272"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN1317"><span class='Ref_To_Local'>td</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../include/funcapi.h.html#LN152"><span class='Ref_to_EnumConst'>TYPEFUNC_COMPOSITE</span></a><span class='Parentheses'>)</span> 
                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"function returning record called in context "</span> 
                               <span class='String'>"that cannot accept type record"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="plperl.c.html#LN1316"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN281"><span class='Ref_to_Proto'>plperl_hash_to_datum</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1271"><span class='Ref_to_Parameter'>sv</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1317"><span class='Ref_To_Local'>td</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Release on the result of get_call_result_type is harmless */ 
</span>            <a href="../../include/access/tupdesc.h.html#LN106"><span class='Ref_to_Macro'>ReleaseTupleDesc</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1317"><span class='Ref_To_Local'>td</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>return</span> <a href="plperl.c.html#LN1316"><span class='Ref_To_Local'>ret</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if SvTYPE(SvRV(sv))==SVt... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* Reference, but not reference to hash or array ... */ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATATYPE_MISMATCH<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>         <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"PL/Perl function must return reference to hash or array"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* shut up compiler */ 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if SvROK(sv) &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* handle a string/number */ 
</span><a name="LN1354"></a>        <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>ret</span><span class='Delimiter'>; 
</span><a name="LN1355"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>str</span> <span class='Operator'>= </span><a href="plperl_helpers.h.html#LN49"><span class='Ref_to_Func'>sv2cstr</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1271"><span class='Ref_to_Parameter'>sv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* did not pass in any typeinfo? look it up */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plperl.c.html#LN1273"><span class='Ref_to_Parameter'>finfo</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="plperl.c.html#LN275"><span class='Ref_to_Proto'>_sv_to_datum_finfo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1271"><span class='Ref_to_Parameter'>typid</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN1276"><span class='Ref_To_Local'>tmp</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN1273"><span class='Ref_to_Parameter'>typioparam</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="plperl.c.html#LN1273"><span class='Ref_to_Parameter'>finfo</span></a> <span class='Operator'>= &</span><a href="plperl.c.html#LN1276"><span class='Ref_To_Local'>tmp</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="plperl.c.html#LN1354"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><a href="../../include/fmgr.h.html#LN642"><span class='Ref_to_Proto'>InputFunctionCall</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1273"><span class='Ref_to_Parameter'>finfo</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1355"><span class='Ref_To_Local'>str</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1273"><span class='Ref_to_Parameter'>typioparam</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1271"><span class='Ref_to_Parameter'>typmod</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1355"><span class='Ref_To_Local'>str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> <a href="plperl.c.html#LN1354"><span class='Ref_To_Local'>ret</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end plperl_sv_to_datum &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* Convert the perl SV to a string returned by the type output function */ 
</span><span class='Keyword'>char </span><span class='Operator'>* 
</span><a name="LN1373"></a><span class='Declare_Function'>plperl_sv_to_literal</span><span class='Parentheses'>(</span>SV <span class='Operator'>*</span><span class='Declare_Parameter'>sv</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>fqtypename</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1375"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>str</span> <span class='Operator'>= </span><a href="../../include/postgres.h.html#LN583"><span class='Ref_to_Macro'>CStringGetDatum</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1373"><span class='Ref_to_Parameter'>fqtypename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1376"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>typid</span> <span class='Operator'>= </span><a href="../../include/fmgr.h.html#LN583"><span class='Ref_to_Macro'>DirectFunctionCall1</span></a><span class='Parentheses'>(</span><a href="../../backend/utils/adt/regproc.c.html#LN1059"><span class='Ref_to_Func'>regtypein</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1375"><span class='Ref_To_Local'>str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1377"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>typoutput</span><span class='Delimiter'>; 
</span><a name="LN1378"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>datum</span><span class='Delimiter'>; 
</span><a name="LN1379"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>typisvarlena</span><span class='Delimiter'>, 
</span><a name="LN1380"></a>                <span class='Declare_Local'>isnull</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1376"><span class='Ref_To_Local'>typid</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_OBJECT<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"lookup failed for type %s"</span><span class='Delimiter'>, </span><a href="plperl.c.html#LN1373"><span class='Ref_to_Parameter'>fqtypename</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN1378"><span class='Ref_To_Local'>datum</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN271"><span class='Ref_to_Proto'>plperl_sv_to_datum</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1373"><span class='Ref_to_Parameter'>sv</span></a><span class='Delimiter'>, 
</span>                               <a href="plperl.c.html#LN1376"><span class='Ref_To_Local'>typid</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                               <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, 
</span>                               <span class='Operator'>&</span><a href="plperl.c.html#LN1380"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN1380"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/lsyscache.h.html#LN162"><span class='Ref_to_Proto'>getTypeOutputInfo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1376"><span class='Ref_To_Local'>typid</span></a><span class='Delimiter'>, 
</span>                      <span class='Operator'>&</span><a href="plperl.c.html#LN1377"><span class='Ref_To_Local'>typoutput</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN1379"><span class='Ref_To_Local'>typisvarlena</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../include/fmgr.h.html#LN647"><span class='Ref_to_Proto'>OidOutputFunctionCall</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1377"><span class='Ref_To_Local'>typoutput</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1378"><span class='Ref_To_Local'>datum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end plperl_sv_to_literal &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Convert PostgreSQL array datum to a perl array reference. 
 * 
 * typid is arg's OID, which must be an array type. 
 */ 
</span><span class='Keyword'>static </span>SV  <span class='Operator'>* 
</span><a name="LN1407"></a><span class='Declare_Function'>plperl_ref_from_pg_array</span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>typid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1409"></a>    <a href="../../include/utils/array.h.html#LN75"><span class='Ref_to_Typedef'>ArrayType</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>ar</span> <span class='Operator'>= </span><a href="../../include/utils/array.h.html#LN241"><span class='Ref_to_Macro'>DatumGetArrayTypeP</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1407"><span class='Ref_to_Parameter'>arg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1410"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>elementtype</span> <span class='Operator'>= </span><a href="../../include/utils/array.h.html#LN272"><span class='Ref_to_Macro'>ARR_ELEMTYPE</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1409"><span class='Ref_To_Local'>ar</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1411"></a>    <a href="../../include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a>       <span class='Declare_Local'>typlen</span><span class='Delimiter'>; 
</span><a name="LN1412"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>typbyval</span><span class='Delimiter'>; 
</span><a name="LN1413"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>typalign</span><span class='Delimiter'>, 
</span><a name="LN1414"></a>                <span class='Declare_Local'>typdelim</span><span class='Delimiter'>; 
</span><a name="LN1415"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>typioparam</span><span class='Delimiter'>; 
</span><a name="LN1416"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>typoutputfunc</span><span class='Delimiter'>; 
</span><a name="LN1417"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>transform_funcid</span><span class='Delimiter'>; 
</span><a name="LN1418"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN1419"></a>                <span class='Declare_Local'>nitems</span><span class='Delimiter'>, 
</span><a name="LN1420"></a>               <span class='Operator'>*</span><span class='Declare_Local'>dims</span><span class='Delimiter'>; 
</span><a name="LN1421"></a>    <a href="plperl.c.html#LN210"><span class='Ref_to_Struct'>plperl_array_info</span></a> <span class='Operator'>*</span><span class='Declare_Local'>info</span><span class='Delimiter'>; 
</span><a name="LN1422"></a>    SV         <span class='Operator'>*</span><span class='Declare_Local'>av</span><span class='Delimiter'>; 
</span><a name="LN1423"></a>    HV         <span class='Operator'>*</span><span class='Declare_Local'>hv</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Currently we make no effort to cache any of the stuff we look up here, 
     * which is bad. 
     */ 
</span>    <a href="plperl.c.html#LN1421"><span class='Ref_To_Local'>info</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN210"><span class='Ref_to_Struct'>plperl_array_info</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* get element type information, including output conversion function */ 
</span>    <a href="../../include/utils/lsyscache.h.html#LN139"><span class='Ref_to_Proto'>get_type_io_data</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1410"><span class='Ref_To_Local'>elementtype</span></a><span class='Delimiter'>, </span><a href="../../include/utils/lsyscache.h.html#LN32"><span class='Ref_to_EnumConst'>IOFunc_output</span></a><span class='Delimiter'>, 
</span>                     <span class='Operator'>&</span><a href="plperl.c.html#LN1411"><span class='Ref_To_Local'>typlen</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN1412"><span class='Ref_To_Local'>typbyval</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN1413"><span class='Ref_To_Local'>typalign</span></a><span class='Delimiter'>, 
</span>                     <span class='Operator'>&</span><a href="plperl.c.html#LN1414"><span class='Ref_To_Local'>typdelim</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN1415"><span class='Ref_To_Local'>typioparam</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN1416"><span class='Ref_To_Local'>typoutputfunc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Check for a transform function */ 
</span>    <a href="plperl.c.html#LN1417"><span class='Ref_To_Local'>transform_funcid</span></a> <span class='Operator'>= </span><a href="../../include/utils/lsyscache.h.html#LN130"><span class='Ref_to_Proto'>get_transform_fromsql</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1410"><span class='Ref_To_Local'>elementtype</span></a><span class='Delimiter'>, 
</span>                                        <a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN178"><span class='Ref_to_Member'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN115"><span class='Ref_to_Member'>lang_oid</span></a><span class='Delimiter'>, 
</span>                                       <a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN178"><span class='Ref_to_Member'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN116"><span class='Ref_to_Member'>trftypes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Look up transform or output function as appropriate */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1417"><span class='Ref_To_Local'>transform_funcid</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/fmgr.h.html#LN92"><span class='Ref_to_Proto'>fmgr_info</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1417"><span class='Ref_To_Local'>transform_funcid</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN1421"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN218"><span class='Ref_to_Member'>transform_proc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../include/fmgr.h.html#LN92"><span class='Ref_to_Proto'>fmgr_info</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1416"><span class='Ref_To_Local'>typoutputfunc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN1421"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN217"><span class='Ref_to_Member'>proc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN1421"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN213"><span class='Ref_to_Member'>elem_is_rowtype</span></a> <span class='Operator'>= </span><a href="../../include/utils/lsyscache.h.html#LN150"><span class='Ref_to_Proto'>type_is_rowtype</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1410"><span class='Ref_To_Local'>elementtype</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Get the number and bounds of array dimensions */ 
</span>    <a href="plperl.c.html#LN1421"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN212"><span class='Ref_to_Member'>ndims</span></a> <span class='Operator'>= </span><a href="../../include/utils/array.h.html#LN270"><span class='Ref_to_Macro'>ARR_NDIM</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1409"><span class='Ref_To_Local'>ar</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN1420"><span class='Ref_To_Local'>dims</span></a> <span class='Operator'>= </span><a href="../../include/utils/array.h.html#LN274"><span class='Ref_to_Macro'>ARR_DIMS</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1409"><span class='Ref_To_Local'>ar</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* No dimensions? Return an empty array */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN1421"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN212"><span class='Ref_to_Member'>ndims</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="plperl.c.html#LN1422"><span class='Ref_To_Local'>av</span></a> <span class='Operator'>= </span><a href="ppport.h.html#LN4455"><span class='Ref_to_Macro'>newRV_noinc</span></a><span class='Parentheses'>((</span>SV <span class='Operator'>*</span><span class='Parentheses'>) </span>newAV<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/array.h.html#LN382"><span class='Ref_to_Proto'>deconstruct_array</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1409"><span class='Ref_To_Local'>ar</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1410"><span class='Ref_To_Local'>elementtype</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1411"><span class='Ref_To_Local'>typlen</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1412"><span class='Ref_To_Local'>typbyval</span></a><span class='Delimiter'>, 
</span>                          <a href="plperl.c.html#LN1413"><span class='Ref_To_Local'>typalign</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN1421"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN214"><span class='Ref_to_Member'>elements</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN1421"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN215"><span class='Ref_to_Member'>nulls</span></a><span class='Delimiter'>, 
</span>                          <span class='Operator'>&</span><a href="plperl.c.html#LN1419"><span class='Ref_To_Local'>nitems</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Get total number of elements in each dimension */ 
</span>        <a href="plperl.c.html#LN1421"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN216"><span class='Ref_to_Member'>nelems</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="plperl.c.html#LN1421"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN212"><span class='Ref_to_Member'>ndims</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN1421"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN216"><span class='Ref_to_Member'>nelems</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="plperl.c.html#LN1419"><span class='Ref_To_Local'>nitems</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN1418"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="plperl.c.html#LN1418"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="plperl.c.html#LN1421"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN212"><span class='Ref_to_Member'>ndims</span></a><span class='Delimiter'>; </span><a href="plperl.c.html#LN1418"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <a href="plperl.c.html#LN1421"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN216"><span class='Ref_to_Member'>nelems</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN1418"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="plperl.c.html#LN1421"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN216"><span class='Ref_to_Member'>nelems</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN1418"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>/ </span><a href="plperl.c.html#LN1420"><span class='Ref_To_Local'>dims</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN1418"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span> 
        <a href="plperl.c.html#LN1422"><span class='Ref_To_Local'>av</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN268"><span class='Ref_to_Proto'>split_array</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1421"><span class='Ref_To_Local'>info</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="plperl.c.html#LN1419"><span class='Ref_To_Local'>nitems</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="plperl.c.html#LN1423"><span class='Ref_To_Local'>hv</span></a> <span class='Operator'>= </span>newHV<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span>hv_store<span class='Parentheses'>(</span><a href="plperl.c.html#LN1423"><span class='Ref_To_Local'>hv</span></a><span class='Delimiter'>, </span><span class='String'>"array"</span><span class='Delimiter'>, </span><span class='Number'>5</span><span class='Delimiter'>, </span><a href="plperl.c.html#LN1422"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span>hv_store<span class='Parentheses'>(</span><a href="plperl.c.html#LN1423"><span class='Ref_To_Local'>hv</span></a><span class='Delimiter'>, </span><span class='String'>"typeoid"</span><span class='Delimiter'>, </span><span class='Number'>7</span><span class='Delimiter'>, </span><a href="ppport.h.html#LN3595"><span class='Ref_to_Macro'>newSVuv</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1407"><span class='Ref_to_Parameter'>typid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> sv_bless<span class='Parentheses'>(</span><a href="ppport.h.html#LN4455"><span class='Ref_to_Macro'>newRV_noinc</span></a><span class='Parentheses'>((</span>SV <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="plperl.c.html#LN1423"><span class='Ref_To_Local'>hv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    gv_stashpv<span class='Parentheses'>(</span><span class='String'>"PostgreSQL::InServer::ARRAY"</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end plperl_ref_from_pg_array &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Recursively form array references from splices of the initial array 
 */ 
</span><span class='Keyword'>static </span>SV  <span class='Operator'>* 
</span><a name="LN1485"></a><span class='Declare_Function'>split_array</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN210"><span class='Ref_to_Struct'>plperl_array_info</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>info</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>first</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>last</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nest</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1487"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1488"></a>    AV         <span class='Operator'>*</span><span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* we should only be called when we have something to split */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN1485"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN212"><span class='Ref_to_Member'>ndims</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* since this function recurses, it could be driven to stack overflow */ 
</span>    <a href="../../include/miscadmin.h.html#LN275"><span class='Ref_to_Proto'>check_stack_depth</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Base case, return a reference to a single-dimensional array 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN1485"><span class='Ref_to_Parameter'>nest</span></a> <span class='Operator'>&GT;= </span><a href="plperl.c.html#LN1485"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN212"><span class='Ref_to_Member'>ndims</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="plperl.c.html#LN269"><span class='Ref_to_Proto'>make_array_ref</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1485"><span class='Ref_to_Parameter'>info</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1485"><span class='Ref_to_Parameter'>first</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1485"><span class='Ref_to_Parameter'>last</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN1488"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span>newAV<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN1487"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN1485"><span class='Ref_to_Parameter'>first</span></a><span class='Delimiter'>; </span><a href="plperl.c.html#LN1487"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="plperl.c.html#LN1485"><span class='Ref_to_Parameter'>last</span></a><span class='Delimiter'>; </span><a href="plperl.c.html#LN1487"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+= </span><a href="plperl.c.html#LN1485"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN216"><span class='Ref_to_Member'>nelems</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN1485"><span class='Ref_to_Parameter'>nest</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Recursively form references to arrays of lower dimensions */ 
</span><a name="LN1506"></a>        SV         <span class='Operator'>*</span><span class='Declare_Local'>ref</span> <span class='Operator'>= </span><a href="plperl.c.html#LN268"><span class='Ref_to_Proto'>split_array</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1485"><span class='Ref_to_Parameter'>info</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1487"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1487"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><a href="plperl.c.html#LN1485"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN216"><span class='Ref_to_Member'>nelems</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN1485"><span class='Ref_to_Parameter'>nest</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>], </span><a href="plperl.c.html#LN1485"><span class='Ref_to_Parameter'>nest</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        av_push<span class='Parentheses'>(</span><a href="plperl.c.html#LN1488"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><span class='Keyword'>ref</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <a href="ppport.h.html#LN4455"><span class='Ref_to_Macro'>newRV_noinc</span></a><span class='Parentheses'>((</span>SV <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="plperl.c.html#LN1488"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end split_array &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Create a Perl reference from a one-dimensional C array, converting 
 * composite type elements to hash references. 
 */ 
</span><span class='Keyword'>static </span>SV  <span class='Operator'>* 
</span><a name="LN1518"></a><span class='Declare_Function'>make_array_ref</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN210"><span class='Ref_to_Struct'>plperl_array_info</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>info</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>first</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>last</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1520"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1521"></a>    AV         <span class='Operator'>*</span><span class='Declare_Local'>result</span> <span class='Operator'>= </span>newAV<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN1520"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN1518"><span class='Ref_to_Parameter'>first</span></a><span class='Delimiter'>; </span><a href="plperl.c.html#LN1520"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="plperl.c.html#LN1518"><span class='Ref_to_Parameter'>last</span></a><span class='Delimiter'>; </span><a href="plperl.c.html#LN1520"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN1518"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN215"><span class='Ref_to_Member'>nulls</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN1520"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * We can't use &PL_sv_undef here.  See "AVs, HVs and undefined 
             * values" in perlguts. 
             */ 
</span>            av_push<span class='Parentheses'>(</span><a href="plperl.c.html#LN1521"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span>newSV<span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1535"></a>            <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>itemvalue</span> <span class='Operator'>= </span><a href="plperl.c.html#LN1518"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN214"><span class='Ref_to_Member'>elements</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN1520"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN1518"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN218"><span class='Ref_to_Member'>transform_proc</span></a><span class='Operator'>.</span><a href="../../include/fmgr.h.html#LN58"><span class='Ref_to_Member'>fn_oid</span></a><span class='Parentheses'>) 
</span>                av_push<span class='Parentheses'>(</span><a href="plperl.c.html#LN1521"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span>SV <span class='Operator'>*</span><span class='Parentheses'>)</span> <a href="../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN601"><span class='Ref_to_Macro'>FunctionCall1</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="plperl.c.html#LN1518"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN218"><span class='Ref_to_Member'>transform_proc</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1535"><span class='Ref_To_Local'>itemvalue</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN1518"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN213"><span class='Ref_to_Member'>elem_is_rowtype</span></a><span class='Parentheses'>) 
</span>                <span class='Comment_Multi_Line'>/* Handle composite type elements */ 
</span>                av_push<span class='Parentheses'>(</span><a href="plperl.c.html#LN1521"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN266"><span class='Ref_to_Proto'>plperl_hash_from_datum</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1535"><span class='Ref_To_Local'>itemvalue</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span><a name="LN1544"></a>                <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>val</span> <span class='Operator'>= </span><a href="../../include/fmgr.h.html#LN646"><span class='Ref_to_Proto'>OutputFunctionCall</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="plperl.c.html#LN1518"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN217"><span class='Ref_to_Member'>proc</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1535"><span class='Ref_To_Local'>itemvalue</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                av_push<span class='Parentheses'>(</span><a href="plperl.c.html#LN1521"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><a href="plperl_helpers.h.html#LN106"><span class='Ref_to_Func'>cstr2sv</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1544"><span class='Ref_To_Local'>val</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=first;i&LT;last;i++ &raquo; </span> 
    <span class='Control'>return</span> <a href="ppport.h.html#LN4455"><span class='Ref_to_Macro'>newRV_noinc</span></a><span class='Parentheses'>((</span>SV <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="plperl.c.html#LN1521"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end make_array_ref &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* Set up the arguments for a trigger call. */ 
</span><span class='Keyword'>static </span>SV  <span class='Operator'>* 
</span><a name="LN1555"></a><span class='Declare_Function'>plperl_trigger_build_args</span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN37"><span class='Ref_to_Typedef'>FunctionCallInfo</span></a> <span class='Declare_Parameter'>fcinfo</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1557"></a>    <a href="../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tdata</span><span class='Delimiter'>; 
</span><a name="LN1558"></a>    <a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span><span class='Delimiter'>; 
</span><a name="LN1559"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1560"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>level</span><span class='Delimiter'>; 
</span><a name="LN1561"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>event</span><span class='Delimiter'>; 
</span><a name="LN1562"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>relid</span><span class='Delimiter'>; 
</span><a name="LN1563"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>when</span><span class='Delimiter'>; 
</span><a name="LN1564"></a>    HV         <span class='Operator'>*</span><span class='Declare_Local'>hv</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN1564"><span class='Ref_To_Local'>hv</span></a> <span class='Operator'>= </span>newHV<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    hv_ksplit<span class='Parentheses'>(</span><a href="plperl.c.html#LN1564"><span class='Ref_To_Local'>hv</span></a><span class='Delimiter'>, </span><span class='Number'>12</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* pre-grow the hash */ 
</span> 
    <a href="plperl.c.html#LN1557"><span class='Ref_To_Local'>tdata</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="plperl.c.html#LN1555"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/fmgr.h.html#LN79"><span class='Ref_to_Member'>context</span></a><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN1558"><span class='Ref_To_Local'>tupdesc</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN1557"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN1562"><span class='Ref_To_Local'>relid</span></a> <span class='Operator'>= </span><a href="../../include/postgres.h.html#LN571"><span class='Ref_to_Macro'>DatumGetCString</span></a><span class='Parentheses'>(</span> 
                            <a href="../../include/fmgr.h.html#LN583"><span class='Ref_to_Macro'>DirectFunctionCall1</span></a><span class='Parentheses'>(</span><a href="../../backend/utils/adt/oid.c.html#LN125"><span class='Ref_to_Func'>oidout</span></a><span class='Delimiter'>, 
</span>                                  <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1557"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN115"><span class='Ref_to_Member'>rd_id</span></a><span class='Parentheses'>) 
</span>                                                <span class='Parentheses'>)</span> 
        <span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN288"><span class='Ref_to_Proto'>hv_store_string</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1564"><span class='Ref_To_Local'>hv</span></a><span class='Delimiter'>, </span><span class='String'>"name"</span><span class='Delimiter'>, </span><a href="plperl_helpers.h.html#LN106"><span class='Ref_to_Func'>cstr2sv</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1557"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN36"><span class='Ref_to_Member'>tg_trigger</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/reltrigger.h.html#LN26"><span class='Ref_to_Member'>tgname</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN288"><span class='Ref_to_Proto'>hv_store_string</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1564"><span class='Ref_To_Local'>hv</span></a><span class='Delimiter'>, </span><span class='String'>"relid"</span><span class='Delimiter'>, </span><a href="plperl_helpers.h.html#LN106"><span class='Ref_to_Func'>cstr2sv</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1562"><span class='Ref_To_Local'>relid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN69"><span class='Ref_to_Macro'>TRIGGER_FIRED_BY_INSERT</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1557"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="plperl.c.html#LN1561"><span class='Ref_To_Local'>event</span></a> <span class='Operator'>= </span><span class='String'>"INSERT"</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN81"><span class='Ref_to_Macro'>TRIGGER_FIRED_FOR_ROW</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1557"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
            <a href="plperl.c.html#LN288"><span class='Ref_to_Proto'>hv_store_string</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1564"><span class='Ref_To_Local'>hv</span></a><span class='Delimiter'>, </span><span class='String'>"new"</span><span class='Delimiter'>, 
</span>                            <a href="plperl.c.html#LN265"><span class='Ref_to_Proto'>plperl_hash_from_tuple</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1557"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN34"><span class='Ref_to_Member'>tg_trigtuple</span></a><span class='Delimiter'>, 
</span>                                                   <a href="plperl.c.html#LN1558"><span class='Ref_To_Local'>tupdesc</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN72"><span class='Ref_to_Macro'>TRIGGER_FIRED_BY_DELETE</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1557"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="plperl.c.html#LN1561"><span class='Ref_To_Local'>event</span></a> <span class='Operator'>= </span><span class='String'>"DELETE"</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN81"><span class='Ref_to_Macro'>TRIGGER_FIRED_FOR_ROW</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1557"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
            <a href="plperl.c.html#LN288"><span class='Ref_to_Proto'>hv_store_string</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1564"><span class='Ref_To_Local'>hv</span></a><span class='Delimiter'>, </span><span class='String'>"old"</span><span class='Delimiter'>, 
</span>                            <a href="plperl.c.html#LN265"><span class='Ref_to_Proto'>plperl_hash_from_tuple</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1557"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN34"><span class='Ref_to_Member'>tg_trigtuple</span></a><span class='Delimiter'>, 
</span>                                                   <a href="plperl.c.html#LN1558"><span class='Ref_To_Local'>tupdesc</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN75"><span class='Ref_to_Macro'>TRIGGER_FIRED_BY_UPDATE</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1557"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="plperl.c.html#LN1561"><span class='Ref_To_Local'>event</span></a> <span class='Operator'>= </span><span class='String'>"UPDATE"</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN81"><span class='Ref_to_Macro'>TRIGGER_FIRED_FOR_ROW</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1557"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="plperl.c.html#LN288"><span class='Ref_to_Proto'>hv_store_string</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1564"><span class='Ref_To_Local'>hv</span></a><span class='Delimiter'>, </span><span class='String'>"old"</span><span class='Delimiter'>, 
</span>                            <a href="plperl.c.html#LN265"><span class='Ref_to_Proto'>plperl_hash_from_tuple</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1557"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN34"><span class='Ref_to_Member'>tg_trigtuple</span></a><span class='Delimiter'>, 
</span>                                                   <a href="plperl.c.html#LN1558"><span class='Ref_To_Local'>tupdesc</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="plperl.c.html#LN288"><span class='Ref_to_Proto'>hv_store_string</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1564"><span class='Ref_To_Local'>hv</span></a><span class='Delimiter'>, </span><span class='String'>"new"</span><span class='Delimiter'>, 
</span>                            <a href="plperl.c.html#LN265"><span class='Ref_to_Proto'>plperl_hash_from_tuple</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1557"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN35"><span class='Ref_to_Member'>tg_newtuple</span></a><span class='Delimiter'>, 
</span>                                                   <a href="plperl.c.html#LN1558"><span class='Ref_To_Local'>tupdesc</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN78"><span class='Ref_to_Macro'>TRIGGER_FIRED_BY_TRUNCATE</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1557"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
        <a href="plperl.c.html#LN1561"><span class='Ref_To_Local'>event</span></a> <span class='Operator'>= </span><span class='String'>"TRUNCATE"</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="plperl.c.html#LN1561"><span class='Ref_To_Local'>event</span></a> <span class='Operator'>= </span><span class='String'>"UNKNOWN"</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN288"><span class='Ref_to_Proto'>hv_store_string</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1564"><span class='Ref_To_Local'>hv</span></a><span class='Delimiter'>, </span><span class='String'>"event"</span><span class='Delimiter'>, </span><a href="plperl_helpers.h.html#LN106"><span class='Ref_to_Func'>cstr2sv</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1561"><span class='Ref_To_Local'>event</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN288"><span class='Ref_to_Proto'>hv_store_string</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1564"><span class='Ref_To_Local'>hv</span></a><span class='Delimiter'>, </span><span class='String'>"argc"</span><span class='Delimiter'>, </span>newSViv<span class='Parentheses'>(</span><a href="plperl.c.html#LN1557"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN36"><span class='Ref_to_Member'>tg_trigger</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/reltrigger.h.html#LN36"><span class='Ref_to_Member'>tgnargs</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN1557"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN36"><span class='Ref_to_Member'>tg_trigger</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/reltrigger.h.html#LN36"><span class='Ref_to_Member'>tgnargs</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1620"></a>        AV         <span class='Operator'>*</span><span class='Declare_Local'>av</span> <span class='Operator'>= </span>newAV<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        av_extend<span class='Parentheses'>(</span><a href="plperl.c.html#LN1620"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1557"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN36"><span class='Ref_to_Member'>tg_trigger</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/reltrigger.h.html#LN36"><span class='Ref_to_Member'>tgnargs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN1559"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="plperl.c.html#LN1559"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="plperl.c.html#LN1557"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN36"><span class='Ref_to_Member'>tg_trigger</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/reltrigger.h.html#LN36"><span class='Ref_to_Member'>tgnargs</span></a><span class='Delimiter'>; </span><a href="plperl.c.html#LN1559"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            av_push<span class='Parentheses'>(</span><a href="plperl.c.html#LN1620"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>, </span><a href="plperl_helpers.h.html#LN106"><span class='Ref_to_Func'>cstr2sv</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1557"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN36"><span class='Ref_to_Member'>tg_trigger</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/reltrigger.h.html#LN39"><span class='Ref_to_Member'>tgargs</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN1559"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN288"><span class='Ref_to_Proto'>hv_store_string</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1564"><span class='Ref_To_Local'>hv</span></a><span class='Delimiter'>, </span><span class='String'>"args"</span><span class='Delimiter'>, </span><a href="ppport.h.html#LN4455"><span class='Ref_to_Macro'>newRV_noinc</span></a><span class='Parentheses'>((</span>SV <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="plperl.c.html#LN1620"><span class='Ref_To_Local'>av</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="plperl.c.html#LN288"><span class='Ref_to_Proto'>hv_store_string</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1564"><span class='Ref_To_Local'>hv</span></a><span class='Delimiter'>, </span><span class='String'>"relname"</span><span class='Delimiter'>, 
</span>                    <a href="plperl_helpers.h.html#LN106"><span class='Ref_to_Func'>cstr2sv</span></a><span class='Parentheses'>(</span><a href="../../include/executor/spi.h.html#LN129"><span class='Ref_to_Proto'>SPI_getrelname</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1557"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN288"><span class='Ref_to_Proto'>hv_store_string</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1564"><span class='Ref_To_Local'>hv</span></a><span class='Delimiter'>, </span><span class='String'>"table_name"</span><span class='Delimiter'>, 
</span>                    <a href="plperl_helpers.h.html#LN106"><span class='Ref_to_Func'>cstr2sv</span></a><span class='Parentheses'>(</span><a href="../../include/executor/spi.h.html#LN129"><span class='Ref_to_Proto'>SPI_getrelname</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1557"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN288"><span class='Ref_to_Proto'>hv_store_string</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1564"><span class='Ref_To_Local'>hv</span></a><span class='Delimiter'>, </span><span class='String'>"table_schema"</span><span class='Delimiter'>, 
</span>                    <a href="plperl_helpers.h.html#LN106"><span class='Ref_to_Func'>cstr2sv</span></a><span class='Parentheses'>(</span><a href="../../include/executor/spi.h.html#LN130"><span class='Ref_to_Proto'>SPI_getnspname</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1557"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN87"><span class='Ref_to_Macro'>TRIGGER_FIRED_BEFORE</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1557"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
        <a href="plperl.c.html#LN1563"><span class='Ref_To_Local'>when</span></a> <span class='Operator'>= </span><span class='String'>"BEFORE"</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN90"><span class='Ref_to_Macro'>TRIGGER_FIRED_AFTER</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1557"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
        <a href="plperl.c.html#LN1563"><span class='Ref_To_Local'>when</span></a> <span class='Operator'>= </span><span class='String'>"AFTER"</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN93"><span class='Ref_to_Macro'>TRIGGER_FIRED_INSTEAD</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1557"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
        <a href="plperl.c.html#LN1563"><span class='Ref_To_Local'>when</span></a> <span class='Operator'>= </span><span class='String'>"INSTEAD OF"</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="plperl.c.html#LN1563"><span class='Ref_To_Local'>when</span></a> <span class='Operator'>= </span><span class='String'>"UNKNOWN"</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN288"><span class='Ref_to_Proto'>hv_store_string</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1564"><span class='Ref_To_Local'>hv</span></a><span class='Delimiter'>, </span><span class='String'>"when"</span><span class='Delimiter'>, </span><a href="plperl_helpers.h.html#LN106"><span class='Ref_to_Func'>cstr2sv</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1563"><span class='Ref_To_Local'>when</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN81"><span class='Ref_to_Macro'>TRIGGER_FIRED_FOR_ROW</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1557"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
        <a href="plperl.c.html#LN1560"><span class='Ref_To_Local'>level</span></a> <span class='Operator'>= </span><span class='String'>"ROW"</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN84"><span class='Ref_to_Macro'>TRIGGER_FIRED_FOR_STATEMENT</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1557"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
        <a href="plperl.c.html#LN1560"><span class='Ref_To_Local'>level</span></a> <span class='Operator'>= </span><span class='String'>"STATEMENT"</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="plperl.c.html#LN1560"><span class='Ref_To_Local'>level</span></a> <span class='Operator'>= </span><span class='String'>"UNKNOWN"</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN288"><span class='Ref_to_Proto'>hv_store_string</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1564"><span class='Ref_To_Local'>hv</span></a><span class='Delimiter'>, </span><span class='String'>"level"</span><span class='Delimiter'>, </span><a href="plperl_helpers.h.html#LN106"><span class='Ref_to_Func'>cstr2sv</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1560"><span class='Ref_To_Local'>level</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="ppport.h.html#LN4455"><span class='Ref_to_Macro'>newRV_noinc</span></a><span class='Parentheses'>((</span>SV <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="plperl.c.html#LN1564"><span class='Ref_To_Local'>hv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end plperl_trigger_build_args &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* Set up the arguments for an event trigger call. */ 
</span><span class='Keyword'>static </span>SV  <span class='Operator'>* 
</span><a name="LN1661"></a><span class='Declare_Function'>plperl_event_trigger_build_args</span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN37"><span class='Ref_to_Typedef'>FunctionCallInfo</span></a> <span class='Declare_Parameter'>fcinfo</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1663"></a>    <a href="../../include/commands/event_trigger.h.html#LN22"><span class='Ref_to_Struct'>EventTriggerData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tdata</span><span class='Delimiter'>; 
</span><a name="LN1664"></a>    HV         <span class='Operator'>*</span><span class='Declare_Local'>hv</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN1664"><span class='Ref_To_Local'>hv</span></a> <span class='Operator'>= </span>newHV<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN1663"><span class='Ref_To_Local'>tdata</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/commands/event_trigger.h.html#LN22"><span class='Ref_to_Struct'>EventTriggerData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="plperl.c.html#LN1661"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/fmgr.h.html#LN79"><span class='Ref_to_Member'>context</span></a><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN288"><span class='Ref_to_Proto'>hv_store_string</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1664"><span class='Ref_To_Local'>hv</span></a><span class='Delimiter'>, </span><span class='String'>"event"</span><span class='Delimiter'>, </span><a href="plperl_helpers.h.html#LN106"><span class='Ref_to_Func'>cstr2sv</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1663"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/event_trigger.h.html#LN25"><span class='Ref_to_Member'>event</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN288"><span class='Ref_to_Proto'>hv_store_string</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1664"><span class='Ref_To_Local'>hv</span></a><span class='Delimiter'>, </span><span class='String'>"tag"</span><span class='Delimiter'>, </span><a href="plperl_helpers.h.html#LN106"><span class='Ref_to_Func'>cstr2sv</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1663"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/event_trigger.h.html#LN27"><span class='Ref_to_Member'>tag</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="ppport.h.html#LN4455"><span class='Ref_to_Macro'>newRV_noinc</span></a><span class='Parentheses'>((</span>SV <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="plperl.c.html#LN1664"><span class='Ref_To_Local'>hv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* Construct the modified new tuple to be returned from a trigger. */ 
</span><span class='Keyword'>static </span><a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> 
<a name="LN1678"></a><span class='Declare_Function'>plperl_modify_tuple</span><span class='Parentheses'>(</span>HV <span class='Operator'>*</span><span class='Declare_Parameter'>hvTD</span><span class='Delimiter'>, </span><a href="../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tdata</span><span class='Delimiter'>, </span><a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>otup</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1680"></a>    SV        <span class='Operator'>**</span><span class='Declare_Local'>svp</span><span class='Delimiter'>; 
</span><a name="LN1681"></a>    HV         <span class='Operator'>*</span><span class='Declare_Local'>hvNew</span><span class='Delimiter'>; 
</span><a name="LN1682"></a>    HE         <span class='Operator'>*</span><span class='Declare_Local'>he</span><span class='Delimiter'>; 
</span><a name="LN1683"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>rtup</span><span class='Delimiter'>; 
</span><a name="LN1684"></a>    <a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span><span class='Delimiter'>; 
</span><a name="LN1685"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>natts</span><span class='Delimiter'>; 
</span><a name="LN1686"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>modvalues</span><span class='Delimiter'>; 
</span><a name="LN1687"></a>    <span class='Keyword'>bool</span>       <span class='Operator'>*</span><span class='Declare_Local'>modnulls</span><span class='Delimiter'>; 
</span><a name="LN1688"></a>    <span class='Keyword'>bool</span>       <span class='Operator'>*</span><span class='Declare_Local'>modrepls</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN1680"><span class='Ref_To_Local'>svp</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN289"><span class='Ref_to_Proto'>hv_fetch_string</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1678"><span class='Ref_to_Parameter'>hvTD</span></a><span class='Delimiter'>, </span><span class='String'>"new"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plperl.c.html#LN1680"><span class='Ref_To_Local'>svp</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_COLUMN<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"$_TD-&GT;{new} does not exist"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>SvOK<span class='Parentheses'>(</span><span class='Operator'>*</span><a href="plperl.c.html#LN1680"><span class='Ref_To_Local'>svp</span></a><span class='Parentheses'>)</span> <span class='Operator'>|| !</span>SvROK<span class='Parentheses'>(</span><span class='Operator'>*</span><a href="plperl.c.html#LN1680"><span class='Ref_To_Local'>svp</span></a><span class='Parentheses'>)</span> <span class='Operator'>|| </span>SvTYPE<span class='Parentheses'>(</span>SvRV<span class='Parentheses'>(</span><span class='Operator'>*</span><a href="plperl.c.html#LN1680"><span class='Ref_To_Local'>svp</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span>SVt_PVHV<span class='Parentheses'>)</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATATYPE_MISMATCH<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"$_TD-&GT;{new} is not a hash reference"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN1681"><span class='Ref_To_Local'>hvNew</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span>HV <span class='Operator'>*</span><span class='Parentheses'>) </span>SvRV<span class='Parentheses'>(</span><span class='Operator'>*</span><a href="plperl.c.html#LN1680"><span class='Ref_To_Local'>svp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN1684"><span class='Ref_To_Local'>tupdesc</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN1678"><span class='Ref_to_Parameter'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN1685"><span class='Ref_To_Local'>natts</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN1684"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN1686"><span class='Ref_To_Local'>modvalues</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1685"><span class='Ref_To_Local'>natts</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN1687"><span class='Ref_To_Local'>modnulls</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1685"><span class='Ref_To_Local'>natts</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>bool</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN1688"><span class='Ref_To_Local'>modrepls</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1685"><span class='Ref_To_Local'>natts</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>bool</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    hv_iterinit<span class='Parentheses'>(</span><a href="plperl.c.html#LN1681"><span class='Ref_To_Local'>hvNew</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="plperl.c.html#LN1682"><span class='Ref_To_Local'>he</span></a> <span class='Operator'>= </span>hv_iternext<span class='Parentheses'>(</span><a href="plperl.c.html#LN1681"><span class='Ref_To_Local'>hvNew</span></a><span class='Parentheses'>)))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1711"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>key</span> <span class='Operator'>= </span><a href="plperl.c.html#LN287"><span class='Ref_to_Proto'>hek2cstr</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1682"><span class='Ref_To_Local'>he</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1712"></a>        SV         <span class='Operator'>*</span><span class='Declare_Local'>val</span> <span class='Operator'>= </span>HeVAL<span class='Parentheses'>(</span><a href="plperl.c.html#LN1682"><span class='Ref_To_Local'>he</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1713"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>attn</span> <span class='Operator'>= </span><a href="../../include/executor/spi.h.html#LN123"><span class='Ref_to_Proto'>SPI_fnumber</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1684"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1711"><span class='Ref_To_Local'>key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN1713"><span class='Ref_To_Local'>attn</span></a> <span class='Operator'>== </span><a href="../../include/executor/spi.h.html#LN43"><span class='Ref_to_Const'>SPI_ERROR_NOATTRIBUTE</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_COLUMN<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"Perl hash contains nonexistent column \"%s\""</span><span class='Delimiter'>, 
</span>                            <a href="plperl.c.html#LN1711"><span class='Ref_To_Local'>key</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN1713"><span class='Ref_To_Local'>attn</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot set system attribute \"%s\""</span><span class='Delimiter'>, 
</span>                            <a href="plperl.c.html#LN1711"><span class='Ref_To_Local'>key</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="plperl.c.html#LN1686"><span class='Ref_To_Local'>modvalues</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN1713"><span class='Ref_To_Local'>attn</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="plperl.c.html#LN271"><span class='Ref_to_Proto'>plperl_sv_to_datum</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1712"><span class='Ref_To_Local'>val</span></a><span class='Delimiter'>, 
</span>                                          <a href="plperl.c.html#LN1684"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN1713"><span class='Ref_To_Local'>attn</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypid<span class='Delimiter'>, 
</span>                                         <a href="plperl.c.html#LN1684"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN1713"><span class='Ref_To_Local'>attn</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypmod<span class='Delimiter'>, 
</span>                                                 <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                                 <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                                 <a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, 
</span>                                                 <span class='Operator'>&</span><a href="plperl.c.html#LN1687"><span class='Ref_To_Local'>modnulls</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN1713"><span class='Ref_To_Local'>attn</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN1688"><span class='Ref_To_Local'>modrepls</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN1713"><span class='Ref_To_Local'>attn</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1711"><span class='Ref_To_Local'>key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (he=hv_iternext(hvNew... &raquo; </span> 
    hv_iterinit<span class='Parentheses'>(</span><a href="plperl.c.html#LN1681"><span class='Ref_To_Local'>hvNew</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN1683"><span class='Ref_To_Local'>rtup</span></a> <span class='Operator'>= </span><a href="../../backend/access/common/heaptuple.c.html#LN789"><span class='Ref_to_Func'>heap_modify_tuple</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1678"><span class='Ref_to_Parameter'>otup</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1684"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1686"><span class='Ref_To_Local'>modvalues</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1687"><span class='Ref_To_Local'>modnulls</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1688"><span class='Ref_To_Local'>modrepls</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1686"><span class='Ref_To_Local'>modvalues</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1687"><span class='Ref_To_Local'>modnulls</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1688"><span class='Ref_To_Local'>modrepls</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="plperl.c.html#LN1683"><span class='Ref_To_Local'>rtup</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end plperl_modify_tuple &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * There are three externally visible pieces to plperl: plperl_call_handler, 
 * plperl_inline_handler, and plperl_validator. 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * The call handler is called to run normal functions (including trigger 
 * functions) that are defined in pg_proc. 
 */ 
</span><a name="LN1758"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN1760"><span class='Ref_to_Func'>plperl_call_handler</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1761"></a><span class='Declare_Function'>plperl_call_handler</span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1763"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>retval</span><span class='Delimiter'>; 
</span><a name="LN1764"></a>    <a href="plperl.c.html#LN176"><span class='Ref_to_Struct'>plperl_call_data</span></a> <span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Declare_Local'>save_call_data</span> <span class='Operator'>= </span><a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a><span class='Delimiter'>; 
</span><a name="LN1765"></a>    <a href="plperl.c.html#LN88"><span class='Ref_to_Struct'>plperl_interp_desc</span></a> <span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Declare_Local'>oldinterp</span> <span class='Operator'>= </span><a href="plperl.c.html#LN227"><span class='Ref_to_Global_Var'>plperl_active_interp</span></a><span class='Delimiter'>; 
</span><a name="LN1766"></a>    <a href="plperl.c.html#LN176"><span class='Ref_to_Struct'>plperl_call_data</span></a> <span class='Declare_Local'>this_call_data</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize current-call status record */ 
</span>    <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="plperl.c.html#LN1766"><span class='Ref_To_Local'>this_call_data</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN1766"><span class='Ref_To_Local'>this_call_data</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN1766"><span class='Ref_To_Local'>this_call_data</span></a><span class='Operator'>.</span><a href="plperl.c.html#LN179"><span class='Ref_to_Member'>fcinfo</span></a> <span class='Operator'>= </span>fcinfo<span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a> <span class='Operator'>= &</span><a href="plperl.c.html#LN1766"><span class='Ref_To_Local'>this_call_data</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN24"><span class='Ref_to_Macro'>CALLED_AS_TRIGGER</span></a><span class='Parentheses'>(</span>fcinfo<span class='Parentheses'>))</span> 
            <a href="plperl.c.html#LN1763"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span><a href="../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN256"><span class='Ref_to_Proto'>plperl_trigger_handler</span></a><span class='Parentheses'>(</span>fcinfo<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/event_trigger.h.html#LN39"><span class='Ref_to_Macro'>CALLED_AS_EVENT_TRIGGER</span></a><span class='Parentheses'>(</span>fcinfo<span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="plperl.c.html#LN257"><span class='Ref_to_Proto'>plperl_event_trigger_handler</span></a><span class='Parentheses'>(</span>fcinfo<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="plperl.c.html#LN1763"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="plperl.c.html#LN1763"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN255"><span class='Ref_to_Proto'>plperl_func_handler</span></a><span class='Parentheses'>(</span>fcinfo<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN1764"><span class='Ref_To_Local'>save_call_data</span></a><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN298"><span class='Ref_to_Proto'>activate_interpreter</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1765"><span class='Ref_To_Local'>oldinterp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN1766"><span class='Ref_To_Local'>this_call_data</span></a><span class='Operator'>.</span><a href="plperl.c.html#LN178"><span class='Ref_to_Member'>prodesc</span></a><span class='Parentheses'>) 
</span>            <a href="plperl.c.html#LN134"><span class='Ref_to_Macro'>decrement_prodesc_refcount</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1766"><span class='Ref_To_Local'>this_call_data</span></a><span class='Operator'>.</span><a href="plperl.c.html#LN178"><span class='Ref_to_Member'>prodesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN310"><span class='Ref_to_Macro'>PG_RE_THROW</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN1764"><span class='Ref_To_Local'>save_call_data</span></a><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN298"><span class='Ref_to_Proto'>activate_interpreter</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1765"><span class='Ref_To_Local'>oldinterp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN1766"><span class='Ref_To_Local'>this_call_data</span></a><span class='Operator'>.</span><a href="plperl.c.html#LN178"><span class='Ref_to_Member'>prodesc</span></a><span class='Parentheses'>) 
</span>        <a href="plperl.c.html#LN134"><span class='Ref_to_Macro'>decrement_prodesc_refcount</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1766"><span class='Ref_To_Local'>this_call_data</span></a><span class='Operator'>.</span><a href="plperl.c.html#LN178"><span class='Ref_to_Member'>prodesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="plperl.c.html#LN1763"><span class='Ref_To_Local'>retval</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end plperl_call_handler &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * The inline handler runs anonymous code blocks (DO blocks). 
 */ 
</span><a name="LN1805"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN1807"><span class='Ref_to_Func'>plperl_inline_handler</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1808"></a><span class='Declare_Function'>plperl_inline_handler</span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1810"></a>    <a href="../../include/nodes/parsenodes.h.html#LN2758"><span class='Ref_to_Struct'>InlineCodeBlock</span></a> <span class='Operator'>*</span><span class='Declare_Local'>codeblock</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN2758"><span class='Ref_to_Struct'>InlineCodeBlock</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/fmgr.h.html#LN240"><span class='Ref_to_Macro'>PG_GETARG_POINTER</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1811"></a>    <a href="../../include/fmgr.h.html#LN76"><span class='Ref_to_Struct'>FunctionCallInfoData</span></a> <span class='Declare_Local'>fake_fcinfo</span><span class='Delimiter'>; 
</span><a name="LN1812"></a>    <a href="../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a>    <span class='Declare_Local'>flinfo</span><span class='Delimiter'>; 
</span><a name="LN1813"></a>    <a href="plperl.c.html#LN105"><span class='Ref_to_Struct'>plperl_proc_desc</span></a> <span class='Declare_Local'>desc</span><span class='Delimiter'>; 
</span><a name="LN1814"></a>    <a href="plperl.c.html#LN176"><span class='Ref_to_Struct'>plperl_call_data</span></a> <span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Declare_Local'>save_call_data</span> <span class='Operator'>= </span><a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a><span class='Delimiter'>; 
</span><a name="LN1815"></a>    <a href="plperl.c.html#LN88"><span class='Ref_to_Struct'>plperl_interp_desc</span></a> <span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Declare_Local'>oldinterp</span> <span class='Operator'>= </span><a href="plperl.c.html#LN227"><span class='Ref_to_Global_Var'>plperl_active_interp</span></a><span class='Delimiter'>; 
</span><a name="LN1816"></a>    <a href="plperl.c.html#LN176"><span class='Ref_to_Struct'>plperl_call_data</span></a> <span class='Declare_Local'>this_call_data</span><span class='Delimiter'>; 
</span><a name="LN1817"></a>    ErrorContextCallback <span class='Declare_Local'>pl_error_context</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize current-call status record */ 
</span>    <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="plperl.c.html#LN1816"><span class='Ref_To_Local'>this_call_data</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN1816"><span class='Ref_To_Local'>this_call_data</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set up a callback for error reporting */ 
</span>    <a href="plperl.c.html#LN1817"><span class='Ref_To_Local'>pl_error_context</span></a><span class='Operator'>.</span>callback <span class='Operator'>= </span><a href="plperl.c.html#LN295"><span class='Ref_to_Proto'>plperl_inline_callback</span></a><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN1817"><span class='Ref_To_Local'>pl_error_context</span></a><span class='Operator'>.</span>previous <span class='Operator'>= </span><a href="../../backend/utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN1817"><span class='Ref_To_Local'>pl_error_context</span></a><span class='Operator'>.</span>arg <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="../../backend/utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a> <span class='Operator'>= &</span><a href="plperl.c.html#LN1817"><span class='Ref_To_Local'>pl_error_context</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set up a fake fcinfo and descriptor with just enough info to satisfy 
     * plperl_call_perl_func().  In particular note that this sets things up 
     * with no arguments passed, and a result type of VOID. 
     */ 
</span>    <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="plperl.c.html#LN1811"><span class='Ref_To_Local'>fake_fcinfo</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN1811"><span class='Ref_To_Local'>fake_fcinfo</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="plperl.c.html#LN1812"><span class='Ref_To_Local'>flinfo</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN1812"><span class='Ref_To_Local'>flinfo</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="plperl.c.html#LN1813"><span class='Ref_To_Local'>desc</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN1813"><span class='Ref_To_Local'>desc</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN1811"><span class='Ref_To_Local'>fake_fcinfo</span></a><span class='Operator'>.</span><a href="../../include/fmgr.h.html#LN78"><span class='Ref_to_Member'>flinfo</span></a> <span class='Operator'>= &</span><a href="plperl.c.html#LN1812"><span class='Ref_To_Local'>flinfo</span></a><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN1812"><span class='Ref_To_Local'>flinfo</span></a><span class='Operator'>.</span><a href="../../include/fmgr.h.html#LN58"><span class='Ref_to_Member'>fn_oid</span></a> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN1812"><span class='Ref_To_Local'>flinfo</span></a><span class='Operator'>.</span><a href="../../include/fmgr.h.html#LN64"><span class='Ref_to_Member'>fn_mcxt</span></a> <span class='Operator'>= </span><a href="../../backend/utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN1813"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>.</span><a href="plperl.c.html#LN107"><span class='Ref_to_Member'>proname</span></a> <span class='Operator'>= </span><span class='String'>"inline_code_block"</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN1813"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>.</span><a href="plperl.c.html#LN114"><span class='Ref_to_Member'>fn_readonly</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN1813"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>.</span><a href="plperl.c.html#LN115"><span class='Ref_to_Member'>lang_oid</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN1810"><span class='Ref_To_Local'>codeblock</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2762"><span class='Ref_to_Member'>langOid</span></a><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN1813"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>.</span><a href="plperl.c.html#LN116"><span class='Ref_to_Member'>trftypes</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN1813"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>.</span><a href="plperl.c.html#LN117"><span class='Ref_to_Member'>lanpltrusted</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN1810"><span class='Ref_To_Local'>codeblock</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2763"><span class='Ref_to_Member'>langIsTrusted</span></a><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN1813"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>.</span><a href="plperl.c.html#LN118"><span class='Ref_to_Member'>fn_retistuple</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN1813"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>.</span><a href="plperl.c.html#LN119"><span class='Ref_to_Member'>fn_retisset</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN1813"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>.</span><a href="plperl.c.html#LN120"><span class='Ref_to_Member'>fn_retisarray</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN1813"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>.</span><a href="plperl.c.html#LN122"><span class='Ref_to_Member'>result_oid</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_type.h.html#LN689"><span class='Ref_to_Const'>VOIDOID</span></a><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN1813"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>.</span><a href="plperl.c.html#LN126"><span class='Ref_to_Member'>nargs</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN1813"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>.</span><a href="plperl.c.html#LN112"><span class='Ref_to_Member'>reference</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN1816"><span class='Ref_To_Local'>this_call_data</span></a><span class='Operator'>.</span><a href="plperl.c.html#LN179"><span class='Ref_to_Member'>fcinfo</span></a> <span class='Operator'>= &</span><a href="plperl.c.html#LN1811"><span class='Ref_To_Local'>fake_fcinfo</span></a><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN1816"><span class='Ref_To_Local'>this_call_data</span></a><span class='Operator'>.</span><a href="plperl.c.html#LN178"><span class='Ref_to_Member'>prodesc</span></a> <span class='Operator'>= &</span><a href="plperl.c.html#LN1813"><span class='Ref_To_Local'>desc</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* we do not bother with refcounting the fake prodesc */ 
</span> 
    <a href="../../include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1860"></a>        SV         <span class='Operator'>*</span><span class='Declare_Local'>perlret</span><span class='Delimiter'>; 
</span> 
        <a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a> <span class='Operator'>= &</span><a href="plperl.c.html#LN1816"><span class='Ref_To_Local'>this_call_data</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/executor/spi.h.html#LN79"><span class='Ref_to_Proto'>SPI_connect</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../include/executor/spi.h.html#LN49"><span class='Ref_to_Const'>SPI_OK_CONNECT</span></a><span class='Parentheses'>)</span> 
            <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not connect to SPI manager"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="plperl.c.html#LN538"><span class='Ref_to_Func'>select_perl_context</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1813"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>.</span><a href="plperl.c.html#LN117"><span class='Ref_to_Member'>lanpltrusted</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="plperl.c.html#LN290"><span class='Ref_to_Proto'>plperl_create_sub</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="plperl.c.html#LN1813"><span class='Ref_To_Local'>desc</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1810"><span class='Ref_To_Local'>codeblock</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2761"><span class='Ref_to_Member'>source_text</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plperl.c.html#LN1813"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>.</span><a href="plperl.c.html#LN112"><span class='Ref_to_Member'>reference</span></a><span class='Parentheses'>)</span>    <span class='Comment_Single_Line'>/* can this happen? */ 
</span>            <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not create internal procedure for anonymous code block"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="plperl.c.html#LN1860"><span class='Ref_To_Local'>perlret</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN291"><span class='Ref_to_Proto'>plperl_call_perl_func</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="plperl.c.html#LN1813"><span class='Ref_To_Local'>desc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN1811"><span class='Ref_To_Local'>fake_fcinfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        SvREFCNT_dec<span class='Parentheses'>(</span><a href="plperl.c.html#LN1860"><span class='Ref_To_Local'>perlret</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/executor/spi.h.html#LN80"><span class='Ref_to_Proto'>SPI_finish</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../include/executor/spi.h.html#LN50"><span class='Ref_to_Const'>SPI_OK_FINISH</span></a><span class='Parentheses'>)</span> 
            <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_finish() failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN1813"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>.</span><a href="plperl.c.html#LN112"><span class='Ref_to_Member'>reference</span></a><span class='Parentheses'>) 
</span>            SvREFCNT_dec<span class='Parentheses'>(</span><a href="plperl.c.html#LN1813"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>.</span><a href="plperl.c.html#LN112"><span class='Ref_to_Member'>reference</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN1814"><span class='Ref_To_Local'>save_call_data</span></a><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN298"><span class='Ref_to_Proto'>activate_interpreter</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1815"><span class='Ref_To_Local'>oldinterp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN310"><span class='Ref_to_Macro'>PG_RE_THROW</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN1813"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>.</span><a href="plperl.c.html#LN112"><span class='Ref_to_Member'>reference</span></a><span class='Parentheses'>) 
</span>        SvREFCNT_dec<span class='Parentheses'>(</span><a href="plperl.c.html#LN1813"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>.</span><a href="plperl.c.html#LN112"><span class='Ref_to_Member'>reference</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN1814"><span class='Ref_To_Local'>save_call_data</span></a><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN298"><span class='Ref_to_Proto'>activate_interpreter</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1815"><span class='Ref_To_Local'>oldinterp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../backend/utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN1817"><span class='Ref_To_Local'>pl_error_context</span></a><span class='Operator'>.</span>previous<span class='Delimiter'>; 
</span> 
    <a href="../../include/fmgr.h.html#LN308"><span class='Ref_to_Macro'>PG_RETURN_VOID</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end plperl_inline_handler &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * The validator is called during CREATE FUNCTION to validate the function 
 * being created/replaced. The precise behavior of the validator may be 
 * modified by the check_function_bodies GUC. 
 */ 
</span><a name="LN1907"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN1909"><span class='Ref_to_Func'>plperl_validator</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1910"></a><span class='Declare_Function'>plperl_validator</span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1912"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>funcoid</span> <span class='Operator'>= </span><a href="../../include/fmgr.h.html#LN239"><span class='Ref_to_Macro'>PG_GETARG_OID</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1913"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN1914"></a>    <a href="../../include/catalog/pg_proc.h.html#LN82"><span class='Ref_to_Typedef'>Form_pg_proc</span></a> <span class='Declare_Local'>proc</span><span class='Delimiter'>; 
</span><a name="LN1915"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>functyptype</span><span class='Delimiter'>; 
</span><a name="LN1916"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>numargs</span><span class='Delimiter'>; 
</span><a name="LN1917"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>argtypes</span><span class='Delimiter'>; 
</span><a name="LN1918"></a>    <span class='Keyword'>char</span>      <span class='Operator'>**</span><span class='Declare_Local'>argnames</span><span class='Delimiter'>; 
</span><a name="LN1919"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>argmodes</span><span class='Delimiter'>; 
</span><a name="LN1920"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>is_trigger</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN1921"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>is_event_trigger</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN1922"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/fmgr.h.html#LN668"><span class='Ref_to_Proto'>CheckFunctionValidatorAccess</span></a><span class='Parentheses'>(</span>fcinfo<span class='Operator'>-&GT;</span>flinfo<span class='Operator'>-&GT;</span>fn_oid<span class='Delimiter'>, </span><a href="plperl.c.html#LN1912"><span class='Ref_To_Local'>funcoid</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/fmgr.h.html#LN308"><span class='Ref_to_Macro'>PG_RETURN_VOID</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Get the new function's pg_proc entry */ 
</span>    <a href="plperl.c.html#LN1913"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN76"><span class='Ref_to_EnumConst'>PROCOID</span></a><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1912"><span class='Ref_To_Local'>funcoid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1913"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span> 
        <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cache lookup failed for function %u"</span><span class='Delimiter'>, </span><a href="plperl.c.html#LN1912"><span class='Ref_To_Local'>funcoid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN1914"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_proc.h.html#LN82"><span class='Ref_to_Typedef'>Form_pg_proc</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1913"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN1915"><span class='Ref_To_Local'>functyptype</span></a> <span class='Operator'>= </span><a href="../../include/utils/lsyscache.h.html#LN149"><span class='Ref_to_Proto'>get_typtype</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1914"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span>prorettype<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Disallow pseudotype result */ 
</span>    <span class='Comment_Multi_Line'>/* except for TRIGGER, EVTTRIGGER, RECORD, or VOID */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN1915"><span class='Ref_To_Local'>functyptype</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_type.h.html#LN723"><span class='Ref_to_Const'>TYPTYPE_PSEUDO</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* we assume OPAQUE with no arguments means a trigger */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN1914"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span>prorettype <span class='Operator'>== </span><a href="../../include/catalog/pg_type.h.html#LN691"><span class='Ref_to_Const'>TRIGGEROID</span></a> <span class='Operator'>|| 
</span>            <span class='Parentheses'>(</span><a href="plperl.c.html#LN1914"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span>prorettype <span class='Operator'>== </span><a href="../../include/catalog/pg_type.h.html#LN699"><span class='Ref_to_Const'>OPAQUEOID</span></a> <span class='Operator'>&& </span><a href="plperl.c.html#LN1914"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span>pronargs <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>))</span> 
            <a href="plperl.c.html#LN1920"><span class='Ref_To_Local'>is_trigger</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN1914"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span>prorettype <span class='Operator'>== </span><a href="../../include/catalog/pg_type.h.html#LN693"><span class='Ref_to_Const'>EVTTRIGGEROID</span></a><span class='Parentheses'>) 
</span>            <a href="plperl.c.html#LN1921"><span class='Ref_To_Local'>is_event_trigger</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN1914"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span>prorettype <span class='Operator'>!= </span><a href="../../include/catalog/pg_type.h.html#LN679"><span class='Ref_to_Const'>RECORDOID</span></a> <span class='Operator'>&& 
</span>                 <a href="plperl.c.html#LN1914"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span>prorettype <span class='Operator'>!= </span><a href="../../include/catalog/pg_type.h.html#LN689"><span class='Ref_to_Const'>VOIDOID</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"PL/Perl functions cannot return type %s"</span><span class='Delimiter'>, 
</span>                            <a href="../../backend/utils/adt/format_type.c.html#LN92"><span class='Ref_to_Func'>format_type_be</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1914"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span>prorettype<span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Disallow pseudotypes in arguments (either IN or OUT) */ 
</span>    <a href="plperl.c.html#LN1916"><span class='Ref_To_Local'>numargs</span></a> <span class='Operator'>= </span><a href="../../include/funcapi.h.html#LN171"><span class='Ref_to_Proto'>get_func_arg_info</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1913"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, 
</span>                                <span class='Operator'>&</span><a href="plperl.c.html#LN1917"><span class='Ref_To_Local'>argtypes</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN1918"><span class='Ref_To_Local'>argnames</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN1919"><span class='Ref_To_Local'>argmodes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN1922"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="plperl.c.html#LN1922"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="plperl.c.html#LN1916"><span class='Ref_To_Local'>numargs</span></a><span class='Delimiter'>; </span><a href="plperl.c.html#LN1922"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/utils/lsyscache.h.html#LN149"><span class='Ref_to_Proto'>get_typtype</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1917"><span class='Ref_To_Local'>argtypes</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN1922"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../include/catalog/pg_type.h.html#LN723"><span class='Ref_to_Const'>TYPTYPE_PSEUDO</span></a> <span class='Operator'>&& 
</span>            <a href="plperl.c.html#LN1917"><span class='Ref_To_Local'>argtypes</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN1922"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><a href="../../include/catalog/pg_type.h.html#LN679"><span class='Ref_to_Const'>RECORDOID</span></a><span class='Parentheses'>)</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"PL/Perl functions cannot accept type %s"</span><span class='Delimiter'>, 
</span>                            <a href="../../backend/utils/adt/format_type.c.html#LN92"><span class='Ref_to_Func'>format_type_be</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1917"><span class='Ref_To_Local'>argtypes</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN1922"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1913"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Postpone body checks if !check_function_bodies */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../backend/utils/misc/guc.c.html#LN446"><span class='Ref_to_Global_Var'>check_function_bodies</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="plperl.c.html#LN261"><span class='Ref_to_Proto'>compile_plperl_function</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN1912"><span class='Ref_To_Local'>funcoid</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1920"><span class='Ref_To_Local'>is_trigger</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN1921"><span class='Ref_To_Local'>is_event_trigger</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* the result of a validator is ignored */ 
</span>    <a href="../../include/fmgr.h.html#LN308"><span class='Ref_to_Macro'>PG_RETURN_VOID</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end plperl_validator &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * plperlu likewise requires three externally visible functions: 
 * plperlu_call_handler, plperlu_inline_handler, and plperlu_validator. 
 * These are currently just aliases that send control to the plperl 
 * handler functions, and we decide whether a particular function is 
 * trusted or not by inspecting the actual pg_language tuple. 
 */ 
</span> 
<a name="LN1987"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN1989"><span class='Ref_to_Func'>plperlu_call_handler</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1990"></a><span class='Declare_Function'>plperlu_call_handler</span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="plperl.c.html#LN1760"><span class='Ref_to_Func'>plperl_call_handler</span></a><span class='Parentheses'>(</span>fcinfo<span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<a name="LN1995"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN1997"><span class='Ref_to_Func'>plperlu_inline_handler</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1998"></a><span class='Declare_Function'>plperlu_inline_handler</span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="plperl.c.html#LN1807"><span class='Ref_to_Func'>plperl_inline_handler</span></a><span class='Parentheses'>(</span>fcinfo<span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<a name="LN2003"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN2005"><span class='Ref_to_Func'>plperlu_validator</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN2006"></a><span class='Declare_Function'>plperlu_validator</span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* call plperl validator with our fcinfo so it gets our oid */ 
</span>    <span class='Control'>return</span> <a href="plperl.c.html#LN1909"><span class='Ref_to_Func'>plperl_validator</span></a><span class='Parentheses'>(</span>fcinfo<span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Uses mksafefunc/mkunsafefunc to create a subroutine whose text is 
 * supplied in s, and returns a reference to it 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2018"></a><span class='Declare_Function'>plperl_create_sub</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN105"><span class='Ref_to_Struct'>plperl_proc_desc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>prodesc</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>s</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>fn_oid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    dSP<span class='Delimiter'>; 
</span><a name="LN2021"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>subname</span><span class='Delimiter'>[</span><a href="../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a> <span class='Operator'>+ </span><span class='Number'>40</span><span class='Delimiter'>]; 
</span><a name="LN2022"></a>    HV         <span class='Operator'>*</span><span class='Declare_Local'>pragma_hv</span> <span class='Operator'>= </span>newHV<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><a name="LN2023"></a>    SV         <span class='Operator'>*</span><span class='Declare_Local'>subref</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN2024"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>count</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2021"><span class='Ref_To_Local'>subname</span></a><span class='Delimiter'>, </span><span class='String'>"%s__%u"</span><span class='Delimiter'>, </span><a href="plperl.c.html#LN2018"><span class='Ref_to_Parameter'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN107"><span class='Ref_to_Member'>proname</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN2018"><span class='Ref_to_Parameter'>fn_oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN233"><span class='Ref_to_Global_Var'>plperl_use_strict</span></a><span class='Parentheses'>) 
</span>        <a href="plperl.c.html#LN288"><span class='Ref_to_Proto'>hv_store_string</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2022"><span class='Ref_To_Local'>pragma_hv</span></a><span class='Delimiter'>, </span><span class='String'>"strict"</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span>SV <span class='Operator'>*</span><span class='Parentheses'>) </span>newAV<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
    ENTER<span class='Delimiter'>; 
</span>    SAVETMPS<span class='Delimiter'>; 
</span>    PUSHMARK<span class='Parentheses'>(</span>SP<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    EXTEND<span class='Parentheses'>(</span>SP<span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    PUSHs<span class='Parentheses'>(</span><a href="ppport.h.html#LN5590"><span class='Ref_to_Proto'>sv_2mortal</span></a><span class='Parentheses'>(</span><a href="plperl_helpers.h.html#LN106"><span class='Ref_to_Func'>cstr2sv</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2021"><span class='Ref_To_Local'>subname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    PUSHs<span class='Parentheses'>(</span><a href="ppport.h.html#LN5590"><span class='Ref_to_Proto'>sv_2mortal</span></a><span class='Parentheses'>(</span><a href="ppport.h.html#LN4455"><span class='Ref_to_Macro'>newRV_noinc</span></a><span class='Parentheses'>((</span>SV <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="plperl.c.html#LN2022"><span class='Ref_To_Local'>pragma_hv</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Use 'false' for $prolog in mkfunc, which is kept for compatibility in 
     * case a module such as PostgreSQL::PLPerl::NYTprof replaces the function 
     * compiler. 
     */ 
</span>    PUSHs<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ppport.h.html#LN4127"><span class='Ref_to_Const'>PL_sv_no</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    PUSHs<span class='Parentheses'>(</span><a href="ppport.h.html#LN5590"><span class='Ref_to_Proto'>sv_2mortal</span></a><span class='Parentheses'>(</span><a href="plperl_helpers.h.html#LN106"><span class='Ref_to_Func'>cstr2sv</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2018"><span class='Ref_to_Parameter'>s</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    PUTBACK<span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * G_KEEPERR seems to be needed here, else we don't recognize compile 
     * errors properly.  Perhaps it's because there's another level of eval 
     * inside mksafefunc? 
     */ 
</span>    <a href="plperl.c.html#LN2024"><span class='Ref_To_Local'>count</span></a> <span class='Operator'>= </span>perl_call_pv<span class='Parentheses'>(</span><span class='String'>"PostgreSQL::InServer::mkfunc"</span><span class='Delimiter'>, 
</span>                         G_SCALAR <span class='Operator'>| </span>G_EVAL <span class='Operator'>| </span>G_KEEPERR<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    SPAGAIN<span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN2024"><span class='Ref_To_Local'>count</span></a> <span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2058"></a>        SV         <span class='Operator'>*</span><span class='Declare_Local'>sub_rv</span> <span class='Operator'>= </span><span class='Parentheses'>(</span>SV <span class='Operator'>*</span><span class='Parentheses'>) </span>POPs<span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN2058"><span class='Ref_To_Local'>sub_rv</span></a> <span class='Operator'>&& </span>SvROK<span class='Parentheses'>(</span><a href="plperl.c.html#LN2058"><span class='Ref_To_Local'>sub_rv</span></a><span class='Parentheses'>)</span> <span class='Operator'>&& </span>SvTYPE<span class='Parentheses'>(</span>SvRV<span class='Parentheses'>(</span><a href="plperl.c.html#LN2058"><span class='Ref_To_Local'>sub_rv</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span>SVt_PVCV<span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="plperl.c.html#LN2023"><span class='Ref_To_Local'>subref</span></a> <span class='Operator'>= </span>newRV_inc<span class='Parentheses'>(</span>SvRV<span class='Parentheses'>(</span><a href="plperl.c.html#LN2058"><span class='Ref_To_Local'>sub_rv</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    PUTBACK<span class='Delimiter'>; 
</span>    FREETMPS<span class='Delimiter'>; 
</span>    LEAVE<span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>SvTRUE<span class='Parentheses'>(</span><a href="ppport.h.html#LN3858"><span class='Ref_to_Const'>ERRSV</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="plperl.c.html#LN296"><span class='Ref_to_Proto'>strip_trailing_ws</span></a><span class='Parentheses'>(</span><a href="plperl_helpers.h.html#LN49"><span class='Ref_to_Func'>sv2cstr</span></a><span class='Parentheses'>(</span><a href="ppport.h.html#LN3858"><span class='Ref_to_Const'>ERRSV</span></a><span class='Parentheses'>)))))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plperl.c.html#LN2023"><span class='Ref_To_Local'>subref</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>         <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"didn't get a CODE reference from compiling function \"%s\""</span><span class='Delimiter'>, 
</span>                <a href="plperl.c.html#LN2018"><span class='Ref_to_Parameter'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN107"><span class='Ref_to_Member'>proname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN2018"><span class='Ref_to_Parameter'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN112"><span class='Ref_to_Member'>reference</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN2023"><span class='Ref_To_Local'>subref</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end plperl_create_sub &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * plperl_init_shared_libs()        - 
 **********************************************************************/ 
</span> 
<span class='Keyword'>static void 
</span><a name="LN2092"></a><span class='Declare_Function'>plperl_init_shared_libs</span><span class='Parentheses'>(</span><a href="ppport.h.html#LN3214"><span class='Ref_to_Const'>pTHX</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2094"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>file</span> <span class='Operator'>= </span>__FILE__<span class='Delimiter'>; 
</span> 
    newXS<span class='Parentheses'>(</span><span class='String'>"DynaLoader::boot_DynaLoader"</span><span class='Delimiter'>, </span><a href="plperl.c.html#LN57"><span class='Ref_to_Proto'>boot_DynaLoader</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN2094"><span class='Ref_To_Local'>file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    newXS<span class='Parentheses'>(</span><span class='String'>"PostgreSQL::InServer::Util::bootstrap"</span><span class='Delimiter'>, 
</span>          <a href="plperl.c.html#LN58"><span class='Ref_to_Proto'>boot_PostgreSQL__InServer__Util</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN2094"><span class='Ref_To_Local'>file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* newXS for...::SPI::bootstrap is in select_perl_context() */ 
</span><span class='Delimiter'>} 
</span> 
 
<span class='Keyword'>static </span>SV  <span class='Operator'>* 
</span><a name="LN2104"></a><span class='Declare_Function'>plperl_call_perl_func</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN105"><span class='Ref_to_Struct'>plperl_proc_desc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>desc</span><span class='Delimiter'>, </span><a href="../../include/fmgr.h.html#LN37"><span class='Ref_to_Typedef'>FunctionCallInfo</span></a> <span class='Declare_Parameter'>fcinfo</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    dSP<span class='Delimiter'>; 
</span><a name="LN2107"></a>    SV         <span class='Operator'>*</span><span class='Declare_Local'>retval</span><span class='Delimiter'>; 
</span><a name="LN2108"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN2109"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>count</span><span class='Delimiter'>; 
</span><a name="LN2110"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>argtypes</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN2111"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nargs</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    ENTER<span class='Delimiter'>; 
</span>    SAVETMPS<span class='Delimiter'>; 
</span> 
    PUSHMARK<span class='Parentheses'>(</span>SP<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    EXTEND<span class='Parentheses'>(</span>sp<span class='Delimiter'>, </span><a href="plperl.c.html#LN2104"><span class='Ref_to_Parameter'>desc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN126"><span class='Ref_to_Member'>nargs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Get signature for true functions; inline blocks have no args. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN2104"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/fmgr.h.html#LN78"><span class='Ref_to_Member'>flinfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/fmgr.h.html#LN58"><span class='Ref_to_Member'>fn_oid</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/lsyscache.h.html#LN114"><span class='Ref_to_Proto'>get_func_signature</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2104"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/fmgr.h.html#LN78"><span class='Ref_to_Member'>flinfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/fmgr.h.html#LN58"><span class='Ref_to_Member'>fn_oid</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN2110"><span class='Ref_To_Local'>argtypes</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN2111"><span class='Ref_To_Local'>nargs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN2111"><span class='Ref_To_Local'>nargs</span></a> <span class='Operator'>== </span><a href="plperl.c.html#LN2104"><span class='Ref_to_Parameter'>desc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN126"><span class='Ref_to_Member'>nargs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN2108"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="plperl.c.html#LN2108"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="plperl.c.html#LN2104"><span class='Ref_to_Parameter'>desc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN126"><span class='Ref_to_Member'>nargs</span></a><span class='Delimiter'>; </span><a href="plperl.c.html#LN2108"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN2104"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/fmgr.h.html#LN85"><span class='Ref_to_Member'>argnull</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN2108"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>            PUSHs<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ppport.h.html#LN4128"><span class='Ref_to_Const'>PL_sv_undef</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN2104"><span class='Ref_to_Parameter'>desc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN128"><span class='Ref_to_Member'>arg_is_rowtype</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN2108"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2130"></a>            SV         <span class='Operator'>*</span><span class='Declare_Local'>sv</span> <span class='Operator'>= </span><a href="plperl.c.html#LN266"><span class='Ref_to_Proto'>plperl_hash_from_datum</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2104"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/fmgr.h.html#LN84"><span class='Ref_to_Member'>arg</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN2108"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            PUSHs<span class='Parentheses'>(</span><a href="ppport.h.html#LN5590"><span class='Ref_to_Proto'>sv_2mortal</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2130"><span class='Ref_To_Local'>sv</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span><a name="LN2136"></a>            SV         <span class='Operator'>*</span><span class='Declare_Local'>sv</span><span class='Delimiter'>; 
</span><a name="LN2137"></a>            <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>funcid</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2104"><span class='Ref_to_Parameter'>desc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN129"><span class='Ref_to_Member'>arg_arraytype</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN2108"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span> 
                <a href="plperl.c.html#LN2136"><span class='Ref_To_Local'>sv</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN267"><span class='Ref_to_Proto'>plperl_ref_from_pg_array</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2104"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/fmgr.h.html#LN84"><span class='Ref_to_Member'>arg</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN2108"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="plperl.c.html#LN2104"><span class='Ref_to_Parameter'>desc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN129"><span class='Ref_to_Member'>arg_arraytype</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN2108"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="plperl.c.html#LN2137"><span class='Ref_To_Local'>funcid</span></a> <span class='Operator'>= </span><a href="../../include/utils/lsyscache.h.html#LN130"><span class='Ref_to_Proto'>get_transform_fromsql</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2110"><span class='Ref_To_Local'>argtypes</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN2108"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN178"><span class='Ref_to_Member'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN115"><span class='Ref_to_Member'>lang_oid</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN178"><span class='Ref_to_Member'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN116"><span class='Ref_to_Member'>trftypes</span></a><span class='Parentheses'>)))</span> 
                <a href="plperl.c.html#LN2136"><span class='Ref_To_Local'>sv</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span>SV <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN621"><span class='Ref_to_Macro'>OidFunctionCall1</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2137"><span class='Ref_To_Local'>funcid</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN2104"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/fmgr.h.html#LN84"><span class='Ref_to_Member'>arg</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN2108"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span><a name="LN2145"></a>                <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>tmp</span><span class='Delimiter'>; 
</span> 
                <a href="plperl.c.html#LN2145"><span class='Ref_To_Local'>tmp</span></a> <span class='Operator'>= </span><a href="../../include/fmgr.h.html#LN646"><span class='Ref_to_Proto'>OutputFunctionCall</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN2104"><span class='Ref_to_Parameter'>desc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN127"><span class='Ref_to_Member'>arg_out_func</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN2108"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                         <a href="plperl.c.html#LN2104"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/fmgr.h.html#LN84"><span class='Ref_to_Member'>arg</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN2108"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="plperl.c.html#LN2136"><span class='Ref_To_Local'>sv</span></a> <span class='Operator'>= </span><a href="plperl_helpers.h.html#LN106"><span class='Ref_to_Func'>cstr2sv</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2145"><span class='Ref_To_Local'>tmp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2145"><span class='Ref_To_Local'>tmp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            PUSHs<span class='Parentheses'>(</span><a href="ppport.h.html#LN5590"><span class='Ref_to_Proto'>sv_2mortal</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2136"><span class='Ref_To_Local'>sv</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;desc-&GT;nargs;i++ &raquo; </span> 
    PUTBACK<span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Do NOT use G_KEEPERR here */ 
</span>    <a href="plperl.c.html#LN2109"><span class='Ref_To_Local'>count</span></a> <span class='Operator'>= </span>perl_call_sv<span class='Parentheses'>(</span><a href="plperl.c.html#LN2104"><span class='Ref_to_Parameter'>desc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN112"><span class='Ref_to_Member'>reference</span></a><span class='Delimiter'>, </span>G_SCALAR <span class='Operator'>| </span>G_EVAL<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    SPAGAIN<span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN2109"><span class='Ref_To_Local'>count</span></a> <span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        PUTBACK<span class='Delimiter'>; 
</span>        FREETMPS<span class='Delimiter'>; 
</span>        LEAVE<span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_EXTERNAL_ROUTINE_EXCEPTION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"didn't get a return item from function"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>SvTRUE<span class='Parentheses'>(</span><a href="ppport.h.html#LN3858"><span class='Ref_to_Const'>ERRSV</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span>POPs<span class='Delimiter'>; 
</span>        PUTBACK<span class='Delimiter'>; 
</span>        FREETMPS<span class='Delimiter'>; 
</span>        LEAVE<span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* XXX need to find a way to determine a better errcode here */ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_EXTERNAL_ROUTINE_EXCEPTION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="plperl.c.html#LN296"><span class='Ref_to_Proto'>strip_trailing_ws</span></a><span class='Parentheses'>(</span><a href="plperl_helpers.h.html#LN49"><span class='Ref_to_Func'>sv2cstr</span></a><span class='Parentheses'>(</span><a href="ppport.h.html#LN3858"><span class='Ref_to_Const'>ERRSV</span></a><span class='Parentheses'>)))))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="plperl.c.html#LN2107"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span>newSVsv<span class='Parentheses'>(</span>POPs<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    PUTBACK<span class='Delimiter'>; 
</span>    FREETMPS<span class='Delimiter'>; 
</span>    LEAVE<span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="plperl.c.html#LN2107"><span class='Ref_To_Local'>retval</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end plperl_call_perl_func &raquo; </span> 
 
 
<span class='Keyword'>static </span>SV  <span class='Operator'>* 
</span><a name="LN2196"></a><span class='Declare_Function'>plperl_call_perl_trigger_func</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN105"><span class='Ref_to_Struct'>plperl_proc_desc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>desc</span><span class='Delimiter'>, </span><a href="../../include/fmgr.h.html#LN37"><span class='Ref_to_Typedef'>FunctionCallInfo</span></a> <span class='Declare_Parameter'>fcinfo</span><span class='Delimiter'>, 
</span><a name="LN2197"></a>                              SV <span class='Operator'>*</span><span class='Declare_Parameter'>td</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    dSP<span class='Delimiter'>; 
</span><a name="LN2200"></a>    SV         <span class='Operator'>*</span><span class='Declare_Local'>retval</span><span class='Delimiter'>, 
</span><a name="LN2201"></a>               <span class='Operator'>*</span><span class='Declare_Local'>TDsv</span><span class='Delimiter'>; 
</span><a name="LN2202"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN2203"></a>                <span class='Declare_Local'>count</span><span class='Delimiter'>; 
</span><a name="LN2204"></a>    <a href="../../include/utils/reltrigger.h.html#LN22"><span class='Ref_to_Struct'>Trigger</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>tg_trigger</span> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="plperl.c.html#LN2196"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/fmgr.h.html#LN79"><span class='Ref_to_Member'>context</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>tg_trigger<span class='Delimiter'>; 
</span> 
    ENTER<span class='Delimiter'>; 
</span>    SAVETMPS<span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN2201"><span class='Ref_To_Local'>TDsv</span></a> <span class='Operator'>= </span><a href="ppport.h.html#LN3877"><span class='Ref_to_Const'>get_sv</span></a><span class='Parentheses'>(</span><span class='String'>"main::_TD"</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plperl.c.html#LN2201"><span class='Ref_To_Local'>TDsv</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_EXTERNAL_ROUTINE_EXCEPTION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"couldn't fetch $_TD"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    save_item<span class='Parentheses'>(</span><a href="plperl.c.html#LN2201"><span class='Ref_To_Local'>TDsv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* local $_TD */ 
</span>    sv_setsv<span class='Parentheses'>(</span><a href="plperl.c.html#LN2201"><span class='Ref_To_Local'>TDsv</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN2197"><span class='Ref_to_Parameter'>td</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    PUSHMARK<span class='Parentheses'>(</span>sp<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    EXTEND<span class='Parentheses'>(</span>sp<span class='Delimiter'>, </span><a href="plperl.c.html#LN2204"><span class='Ref_To_Local'>tg_trigger</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/reltrigger.h.html#LN36"><span class='Ref_to_Member'>tgnargs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN2202"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="plperl.c.html#LN2202"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="plperl.c.html#LN2204"><span class='Ref_To_Local'>tg_trigger</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/reltrigger.h.html#LN36"><span class='Ref_to_Member'>tgnargs</span></a><span class='Delimiter'>; </span><a href="plperl.c.html#LN2202"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        PUSHs<span class='Parentheses'>(</span><a href="ppport.h.html#LN5590"><span class='Ref_to_Proto'>sv_2mortal</span></a><span class='Parentheses'>(</span><a href="plperl_helpers.h.html#LN106"><span class='Ref_to_Func'>cstr2sv</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2204"><span class='Ref_To_Local'>tg_trigger</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/reltrigger.h.html#LN39"><span class='Ref_to_Member'>tgargs</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN2202"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    PUTBACK<span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Do NOT use G_KEEPERR here */ 
</span>    <a href="plperl.c.html#LN2203"><span class='Ref_To_Local'>count</span></a> <span class='Operator'>= </span>perl_call_sv<span class='Parentheses'>(</span><a href="plperl.c.html#LN2196"><span class='Ref_to_Parameter'>desc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN112"><span class='Ref_to_Member'>reference</span></a><span class='Delimiter'>, </span>G_SCALAR <span class='Operator'>| </span>G_EVAL<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    SPAGAIN<span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN2203"><span class='Ref_To_Local'>count</span></a> <span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        PUTBACK<span class='Delimiter'>; 
</span>        FREETMPS<span class='Delimiter'>; 
</span>        LEAVE<span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_EXTERNAL_ROUTINE_EXCEPTION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"didn't get a return item from trigger function"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>SvTRUE<span class='Parentheses'>(</span><a href="ppport.h.html#LN3858"><span class='Ref_to_Const'>ERRSV</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span>POPs<span class='Delimiter'>; 
</span>        PUTBACK<span class='Delimiter'>; 
</span>        FREETMPS<span class='Delimiter'>; 
</span>        LEAVE<span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* XXX need to find a way to determine a better errcode here */ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_EXTERNAL_ROUTINE_EXCEPTION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="plperl.c.html#LN296"><span class='Ref_to_Proto'>strip_trailing_ws</span></a><span class='Parentheses'>(</span><a href="plperl_helpers.h.html#LN49"><span class='Ref_to_Func'>sv2cstr</span></a><span class='Parentheses'>(</span><a href="ppport.h.html#LN3858"><span class='Ref_to_Const'>ERRSV</span></a><span class='Parentheses'>)))))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="plperl.c.html#LN2200"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span>newSVsv<span class='Parentheses'>(</span>POPs<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    PUTBACK<span class='Delimiter'>; 
</span>    FREETMPS<span class='Delimiter'>; 
</span>    LEAVE<span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="plperl.c.html#LN2200"><span class='Ref_To_Local'>retval</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end plperl_call_perl_trigger_func &raquo; </span> 
 
 
<span class='Keyword'>static void 
</span><a name="LN2263"></a><span class='Declare_Function'>plperl_call_perl_event_trigger_func</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN105"><span class='Ref_to_Struct'>plperl_proc_desc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>desc</span><span class='Delimiter'>, 
</span><a name="LN2264"></a>                                    <a href="../../include/fmgr.h.html#LN37"><span class='Ref_to_Typedef'>FunctionCallInfo</span></a> <span class='Declare_Parameter'>fcinfo</span><span class='Delimiter'>, 
</span><a name="LN2265"></a>                                    SV <span class='Operator'>*</span><span class='Declare_Parameter'>td</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    dSP<span class='Delimiter'>; 
</span><a name="LN2268"></a>    SV         <span class='Operator'>*</span><span class='Declare_Local'>retval</span><span class='Delimiter'>, 
</span><a name="LN2269"></a>               <span class='Operator'>*</span><span class='Declare_Local'>TDsv</span><span class='Delimiter'>; 
</span><a name="LN2270"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>count</span><span class='Delimiter'>; 
</span> 
    ENTER<span class='Delimiter'>; 
</span>    SAVETMPS<span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN2269"><span class='Ref_To_Local'>TDsv</span></a> <span class='Operator'>= </span><a href="ppport.h.html#LN3877"><span class='Ref_to_Const'>get_sv</span></a><span class='Parentheses'>(</span><span class='String'>"main::_TD"</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plperl.c.html#LN2269"><span class='Ref_To_Local'>TDsv</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_EXTERNAL_ROUTINE_EXCEPTION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"couldn't fetch $_TD"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    save_item<span class='Parentheses'>(</span><a href="plperl.c.html#LN2269"><span class='Ref_To_Local'>TDsv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* local $_TD */ 
</span>    sv_setsv<span class='Parentheses'>(</span><a href="plperl.c.html#LN2269"><span class='Ref_To_Local'>TDsv</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN2265"><span class='Ref_to_Parameter'>td</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    PUSHMARK<span class='Parentheses'>(</span>sp<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    PUTBACK<span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Do NOT use G_KEEPERR here */ 
</span>    <a href="plperl.c.html#LN2270"><span class='Ref_To_Local'>count</span></a> <span class='Operator'>= </span>perl_call_sv<span class='Parentheses'>(</span><a href="plperl.c.html#LN2263"><span class='Ref_to_Parameter'>desc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN112"><span class='Ref_to_Member'>reference</span></a><span class='Delimiter'>, </span>G_SCALAR <span class='Operator'>| </span>G_EVAL<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    SPAGAIN<span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN2270"><span class='Ref_To_Local'>count</span></a> <span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        PUTBACK<span class='Delimiter'>; 
</span>        FREETMPS<span class='Delimiter'>; 
</span>        LEAVE<span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_EXTERNAL_ROUTINE_EXCEPTION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"didn't get a return item from trigger function"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>SvTRUE<span class='Parentheses'>(</span><a href="ppport.h.html#LN3858"><span class='Ref_to_Const'>ERRSV</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span>POPs<span class='Delimiter'>; 
</span>        PUTBACK<span class='Delimiter'>; 
</span>        FREETMPS<span class='Delimiter'>; 
</span>        LEAVE<span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* XXX need to find a way to determine a better errcode here */ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_EXTERNAL_ROUTINE_EXCEPTION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="plperl.c.html#LN296"><span class='Ref_to_Proto'>strip_trailing_ws</span></a><span class='Parentheses'>(</span><a href="plperl_helpers.h.html#LN49"><span class='Ref_to_Func'>sv2cstr</span></a><span class='Parentheses'>(</span><a href="ppport.h.html#LN3858"><span class='Ref_to_Const'>ERRSV</span></a><span class='Parentheses'>)))))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="plperl.c.html#LN2268"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span>newSVsv<span class='Parentheses'>(</span>POPs<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="plperl.c.html#LN2268"><span class='Ref_To_Local'>retval</span></a><span class='Delimiter'>;</span>              <span class='Comment_Single_Line'>/* silence compiler warning */ 
</span> 
    PUTBACK<span class='Delimiter'>; 
</span>    FREETMPS<span class='Delimiter'>; 
</span>    LEAVE<span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end plperl_call_perl_event_trigger_func &raquo; </span> 
 
<span class='Keyword'>static </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN2325"></a><span class='Declare_Function'>plperl_func_handler</span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2327"></a>    <a href="plperl.c.html#LN105"><span class='Ref_to_Struct'>plperl_proc_desc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>prodesc</span><span class='Delimiter'>; 
</span><a name="LN2328"></a>    SV         <span class='Operator'>*</span><span class='Declare_Local'>perlret</span><span class='Delimiter'>; 
</span><a name="LN2329"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>retval</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN2330"></a>    <a href="../../include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rsi</span><span class='Delimiter'>; 
</span><a name="LN2331"></a>    ErrorContextCallback <span class='Declare_Local'>pl_error_context</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/executor/spi.h.html#LN79"><span class='Ref_to_Proto'>SPI_connect</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../include/executor/spi.h.html#LN49"><span class='Ref_to_Const'>SPI_OK_CONNECT</span></a><span class='Parentheses'>)</span> 
        <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not connect to SPI manager"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN2327"><span class='Ref_To_Local'>prodesc</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN261"><span class='Ref_to_Proto'>compile_plperl_function</span></a><span class='Parentheses'>(</span>fcinfo<span class='Operator'>-&GT;</span>flinfo<span class='Operator'>-&GT;</span>fn_oid<span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN178"><span class='Ref_to_Member'>prodesc</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN2327"><span class='Ref_To_Local'>prodesc</span></a><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN132"><span class='Ref_to_Macro'>increment_prodesc_refcount</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2327"><span class='Ref_To_Local'>prodesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set a callback for error reporting */ 
</span>    <a href="plperl.c.html#LN2331"><span class='Ref_To_Local'>pl_error_context</span></a><span class='Operator'>.</span>callback <span class='Operator'>= </span><a href="plperl.c.html#LN294"><span class='Ref_to_Proto'>plperl_exec_callback</span></a><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN2331"><span class='Ref_To_Local'>pl_error_context</span></a><span class='Operator'>.</span>previous <span class='Operator'>= </span><a href="../../backend/utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN2331"><span class='Ref_To_Local'>pl_error_context</span></a><span class='Operator'>.</span>arg <span class='Operator'>= </span><a href="plperl.c.html#LN2327"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN107"><span class='Ref_to_Member'>proname</span></a><span class='Delimiter'>; 
</span>    <a href="../../backend/utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a> <span class='Operator'>= &</span><a href="plperl.c.html#LN2331"><span class='Ref_To_Local'>pl_error_context</span></a><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN2330"><span class='Ref_To_Local'>rsi</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span>fcinfo<span class='Operator'>-&GT;</span>resultinfo<span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN2327"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN119"><span class='Ref_to_Member'>fn_retisset</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Check context before allowing the call to go through */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plperl.c.html#LN2330"><span class='Ref_To_Local'>rsi</span></a> <span class='Operator'>|| !</span><a href="../../include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2330"><span class='Ref_To_Local'>rsi</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>            <span class='Parentheses'>(</span><a href="plperl.c.html#LN2330"><span class='Ref_To_Local'>rsi</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN267"><span class='Ref_to_Member'>allowedModes</span></a> <span class='Operator'>& </span><a href="../../include/nodes/execnodes.h.html#LN250"><span class='Ref_to_EnumConst'>SFRM_Materialize</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>            <a href="plperl.c.html#LN2330"><span class='Ref_To_Local'>rsi</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN266"><span class='Ref_to_Member'>expectedDesc</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"set-valued function called in context that "</span> 
                            <span class='String'>"cannot accept a set"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="plperl.c.html#LN298"><span class='Ref_to_Proto'>activate_interpreter</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2327"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN113"><span class='Ref_to_Member'>interp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN2328"><span class='Ref_To_Local'>perlret</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN291"><span class='Ref_to_Proto'>plperl_call_perl_func</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2327"><span class='Ref_To_Local'>prodesc</span></a><span class='Delimiter'>, </span>fcinfo<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Disconnect from SPI manager and then create the return 
     * values datum (if the input function does a palloc for it 
     * this must not be allocated in the SPI memory context 
     * because SPI_finish would free it). 
     ************************************************************/ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/executor/spi.h.html#LN80"><span class='Ref_to_Proto'>SPI_finish</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../include/executor/spi.h.html#LN50"><span class='Ref_to_Const'>SPI_OK_FINISH</span></a><span class='Parentheses'>)</span> 
        <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_finish() failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN2327"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN119"><span class='Ref_to_Member'>fn_retisset</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2375"></a>        SV         <span class='Operator'>*</span><span class='Declare_Local'>sav</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If the Perl function returned an arrayref, we pretend that it 
         * called return_next() for each element of the array, to handle old 
         * SRFs that didn't know about return_next(). Any other sort of return 
         * value is an error, except undef which means return an empty set. 
         */ 
</span>        <a href="plperl.c.html#LN2375"><span class='Ref_To_Local'>sav</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN270"><span class='Ref_to_Proto'>get_perl_array_ref</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2328"><span class='Ref_To_Local'>perlret</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN2375"><span class='Ref_To_Local'>sav</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2386"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN2387"></a>            SV        <span class='Operator'>**</span><span class='Declare_Local'>svp</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN2388"></a>            AV         <span class='Operator'>*</span><span class='Declare_Local'>rav</span> <span class='Operator'>= </span><span class='Parentheses'>(</span>AV <span class='Operator'>*</span><span class='Parentheses'>) </span>SvRV<span class='Parentheses'>(</span><a href="plperl.c.html#LN2375"><span class='Ref_To_Local'>sav</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="plperl.c.html#LN2387"><span class='Ref_To_Local'>svp</span></a> <span class='Operator'>= </span>av_fetch<span class='Parentheses'>(</span><a href="plperl.c.html#LN2388"><span class='Ref_To_Local'>rav</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN2386"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><span class='Boolean'>FALSE</span><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="plperl.h.html#LN99"><span class='Ref_to_Proto'>plperl_return_next</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="plperl.c.html#LN2387"><span class='Ref_To_Local'>svp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="plperl.c.html#LN2386"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>SvOK<span class='Parentheses'>(</span><a href="plperl.c.html#LN2328"><span class='Ref_To_Local'>perlret</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATATYPE_MISMATCH<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"set-returning PL/Perl function must return "</span> 
                            <span class='String'>"reference to array or use return_next"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="plperl.c.html#LN2330"><span class='Ref_To_Local'>rsi</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN269"><span class='Ref_to_Member'>returnMode</span></a> <span class='Operator'>= </span><a href="../../include/nodes/execnodes.h.html#LN250"><span class='Ref_to_EnumConst'>SFRM_Materialize</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN180"><span class='Ref_to_Member'>tuple_store</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="plperl.c.html#LN2330"><span class='Ref_To_Local'>rsi</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN272"><span class='Ref_to_Member'>setResult</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN180"><span class='Ref_to_Member'>tuple_store</span></a><span class='Delimiter'>; 
</span>            <a href="plperl.c.html#LN2330"><span class='Ref_To_Local'>rsi</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN273"><span class='Ref_to_Member'>setDesc</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN181"><span class='Ref_to_Member'>ret_tdesc</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="plperl.c.html#LN2329"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if prodesc-&GT;fn_retisset &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="plperl.c.html#LN2329"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN271"><span class='Ref_to_Proto'>plperl_sv_to_datum</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2328"><span class='Ref_To_Local'>perlret</span></a><span class='Delimiter'>, 
</span>                                    <a href="plperl.c.html#LN2327"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN122"><span class='Ref_to_Member'>result_oid</span></a><span class='Delimiter'>, 
</span>                                    <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                                    fcinfo<span class='Delimiter'>, 
</span>                                    <span class='Operator'>&</span><a href="plperl.c.html#LN2327"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN123"><span class='Ref_to_Member'>result_in_func</span></a><span class='Delimiter'>, 
</span>                                    <a href="plperl.c.html#LN2327"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN124"><span class='Ref_to_Member'>result_typioparam</span></a><span class='Delimiter'>, 
</span>                                    <span class='Operator'>&</span>fcinfo<span class='Operator'>-&GT;</span>isnull<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>fcinfo<span class='Operator'>-&GT;</span>isnull <span class='Operator'>&& </span><a href="plperl.c.html#LN2330"><span class='Ref_To_Local'>rsi</span></a> <span class='Operator'>&& </span><a href="../../include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2330"><span class='Ref_To_Local'>rsi</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a><span class='Parentheses'>))</span> 
            <a href="plperl.c.html#LN2330"><span class='Ref_To_Local'>rsi</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN270"><span class='Ref_to_Member'>isDone</span></a> <span class='Operator'>= </span><a href="../../include/nodes/execnodes.h.html#LN238"><span class='Ref_to_EnumConst'>ExprEndResult</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Restore the previous error callback */ 
</span>    <a href="../../backend/utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN2331"><span class='Ref_To_Local'>pl_error_context</span></a><span class='Operator'>.</span>previous<span class='Delimiter'>; 
</span> 
    SvREFCNT_dec<span class='Parentheses'>(</span><a href="plperl.c.html#LN2328"><span class='Ref_To_Local'>perlret</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="plperl.c.html#LN2329"><span class='Ref_To_Local'>retval</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end plperl_func_handler &raquo; </span> 
 
 
<span class='Keyword'>static </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN2436"></a><span class='Declare_Function'>plperl_trigger_handler</span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2438"></a>    <a href="plperl.c.html#LN105"><span class='Ref_to_Struct'>plperl_proc_desc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>prodesc</span><span class='Delimiter'>; 
</span><a name="LN2439"></a>    SV         <span class='Operator'>*</span><span class='Declare_Local'>perlret</span><span class='Delimiter'>; 
</span><a name="LN2440"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>retval</span><span class='Delimiter'>; 
</span><a name="LN2441"></a>    SV         <span class='Operator'>*</span><span class='Declare_Local'>svTD</span><span class='Delimiter'>; 
</span><a name="LN2442"></a>    HV         <span class='Operator'>*</span><span class='Declare_Local'>hvTD</span><span class='Delimiter'>; 
</span><a name="LN2443"></a>    ErrorContextCallback <span class='Declare_Local'>pl_error_context</span><span class='Delimiter'>; 
</span><a name="LN2444"></a>    <a href="../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tdata</span><span class='Delimiter'>; 
</span><a name="LN2445"></a>    <span class='Keyword'>int </span>rc      <span class='Declare_Local'>PG_USED_FOR_ASSERTS_ONLY</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Connect to SPI manager */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/executor/spi.h.html#LN79"><span class='Ref_to_Proto'>SPI_connect</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../include/executor/spi.h.html#LN49"><span class='Ref_to_Const'>SPI_OK_CONNECT</span></a><span class='Parentheses'>)</span> 
        <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not connect to SPI manager"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Make transition tables visible to this SPI connection */ 
</span>    <a href="plperl.c.html#LN2444"><span class='Ref_To_Local'>tdata</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span>fcinfo<span class='Operator'>-&GT;</span>context<span class='Delimiter'>; 
</span>    rc <span class='Operator'>= </span><a href="../../include/executor/spi.h.html#LN156"><span class='Ref_to_Proto'>SPI_register_trigger_data</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2444"><span class='Ref_To_Local'>tdata</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span>rc <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Find or compile the function */ 
</span>    <a href="plperl.c.html#LN2438"><span class='Ref_To_Local'>prodesc</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN261"><span class='Ref_to_Proto'>compile_plperl_function</span></a><span class='Parentheses'>(</span>fcinfo<span class='Operator'>-&GT;</span>flinfo<span class='Operator'>-&GT;</span>fn_oid<span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN178"><span class='Ref_to_Member'>prodesc</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN2438"><span class='Ref_To_Local'>prodesc</span></a><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN132"><span class='Ref_to_Macro'>increment_prodesc_refcount</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2438"><span class='Ref_To_Local'>prodesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set a callback for error reporting */ 
</span>    <a href="plperl.c.html#LN2443"><span class='Ref_To_Local'>pl_error_context</span></a><span class='Operator'>.</span>callback <span class='Operator'>= </span><a href="plperl.c.html#LN294"><span class='Ref_to_Proto'>plperl_exec_callback</span></a><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN2443"><span class='Ref_To_Local'>pl_error_context</span></a><span class='Operator'>.</span>previous <span class='Operator'>= </span><a href="../../backend/utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN2443"><span class='Ref_To_Local'>pl_error_context</span></a><span class='Operator'>.</span>arg <span class='Operator'>= </span><a href="plperl.c.html#LN2438"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN107"><span class='Ref_to_Member'>proname</span></a><span class='Delimiter'>; 
</span>    <a href="../../backend/utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a> <span class='Operator'>= &</span><a href="plperl.c.html#LN2443"><span class='Ref_To_Local'>pl_error_context</span></a><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN298"><span class='Ref_to_Proto'>activate_interpreter</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2438"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN113"><span class='Ref_to_Member'>interp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN2441"><span class='Ref_To_Local'>svTD</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN1554"><span class='Ref_to_Func'>plperl_trigger_build_args</span></a><span class='Parentheses'>(</span>fcinfo<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN2439"><span class='Ref_To_Local'>perlret</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN2195"><span class='Ref_to_Func'>plperl_call_perl_trigger_func</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2438"><span class='Ref_To_Local'>prodesc</span></a><span class='Delimiter'>, </span>fcinfo<span class='Delimiter'>, </span><a href="plperl.c.html#LN2441"><span class='Ref_To_Local'>svTD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN2442"><span class='Ref_To_Local'>hvTD</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span>HV <span class='Operator'>*</span><span class='Parentheses'>) </span>SvRV<span class='Parentheses'>(</span><a href="plperl.c.html#LN2441"><span class='Ref_To_Local'>svTD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
    * Disconnect from SPI manager and then create the return 
    * values datum (if the input function does a palloc for it 
    * this must not be allocated in the SPI memory context 
    * because SPI_finish would free it). 
    ************************************************************/ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/executor/spi.h.html#LN80"><span class='Ref_to_Proto'>SPI_finish</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../include/executor/spi.h.html#LN50"><span class='Ref_to_Const'>SPI_OK_FINISH</span></a><span class='Parentheses'>)</span> 
        <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_finish() failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN2439"><span class='Ref_To_Local'>perlret</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| !</span>SvOK<span class='Parentheses'>(</span><a href="plperl.c.html#LN2439"><span class='Ref_To_Local'>perlret</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* undef result means go ahead with original tuple */ 
</span><a name="LN2485"></a>        <a href="../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>trigdata</span> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span>fcinfo<span class='Operator'>-&GT;</span>context<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN69"><span class='Ref_to_Macro'>TRIGGER_FIRED_BY_INSERT</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2485"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
            <a href="plperl.c.html#LN2440"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><a href="plperl.c.html#LN2485"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN34"><span class='Ref_to_Member'>tg_trigtuple</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN75"><span class='Ref_to_Macro'>TRIGGER_FIRED_BY_UPDATE</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2485"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
            <a href="plperl.c.html#LN2440"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><a href="plperl.c.html#LN2485"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN35"><span class='Ref_to_Member'>tg_newtuple</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN72"><span class='Ref_to_Macro'>TRIGGER_FIRED_BY_DELETE</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2485"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
            <a href="plperl.c.html#LN2440"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><a href="plperl.c.html#LN2485"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN34"><span class='Ref_to_Member'>tg_trigtuple</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN78"><span class='Ref_to_Macro'>TRIGGER_FIRED_BY_TRUNCATE</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2485"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
            <a href="plperl.c.html#LN2440"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><a href="plperl.c.html#LN2485"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN34"><span class='Ref_to_Member'>tg_trigtuple</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="plperl.c.html#LN2440"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* can this happen? */ 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span><a name="LN2500"></a>        <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>trv</span><span class='Delimiter'>; 
</span><a name="LN2501"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>tmp</span><span class='Delimiter'>; 
</span> 
        <a href="plperl.c.html#LN2501"><span class='Ref_To_Local'>tmp</span></a> <span class='Operator'>= </span><a href="plperl_helpers.h.html#LN49"><span class='Ref_to_Func'>sv2cstr</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2439"><span class='Ref_To_Local'>perlret</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../port/pgstrcasecmp.c.html#LN34"><span class='Ref_to_Func'>pg_strcasecmp</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2501"><span class='Ref_To_Local'>tmp</span></a><span class='Delimiter'>, </span><span class='String'>"SKIP"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="plperl.c.html#LN2500"><span class='Ref_To_Local'>trv</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../port/pgstrcasecmp.c.html#LN34"><span class='Ref_to_Func'>pg_strcasecmp</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2501"><span class='Ref_To_Local'>tmp</span></a><span class='Delimiter'>, </span><span class='String'>"MODIFY"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><a name="LN2509"></a>            <a href="../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>trigdata</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span>fcinfo<span class='Operator'>-&GT;</span>context<span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN69"><span class='Ref_to_Macro'>TRIGGER_FIRED_BY_INSERT</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2509"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
                <a href="plperl.c.html#LN2500"><span class='Ref_To_Local'>trv</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN1677"><span class='Ref_to_Func'>plperl_modify_tuple</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2442"><span class='Ref_To_Local'>hvTD</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN2509"><span class='Ref_To_Local'>trigdata</span></a><span class='Delimiter'>, 
</span>                                          <a href="plperl.c.html#LN2509"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN34"><span class='Ref_to_Member'>tg_trigtuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN75"><span class='Ref_to_Macro'>TRIGGER_FIRED_BY_UPDATE</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2509"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
                <a href="plperl.c.html#LN2500"><span class='Ref_To_Local'>trv</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN1677"><span class='Ref_to_Func'>plperl_modify_tuple</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2442"><span class='Ref_To_Local'>hvTD</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN2509"><span class='Ref_To_Local'>trigdata</span></a><span class='Delimiter'>, 
</span>                                          <a href="plperl.c.html#LN2509"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN35"><span class='Ref_to_Member'>tg_newtuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_E_R_I_E_TRIGGER_PROTOCOL_VIOLATED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"ignoring modified row in DELETE trigger"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <a href="plperl.c.html#LN2500"><span class='Ref_To_Local'>trv</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_E_R_I_E_TRIGGER_PROTOCOL_VIOLATED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                  <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"result of PL/Perl trigger function must be undef, "</span> 
                         <span class='String'>"\"SKIP\", or \"MODIFY\""</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="plperl.c.html#LN2500"><span class='Ref_To_Local'>trv</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="plperl.c.html#LN2440"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span><a href="../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2500"><span class='Ref_To_Local'>trv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2501"><span class='Ref_To_Local'>tmp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Restore the previous error callback */ 
</span>    <a href="../../backend/utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN2443"><span class='Ref_To_Local'>pl_error_context</span></a><span class='Operator'>.</span>previous<span class='Delimiter'>; 
</span> 
    SvREFCNT_dec<span class='Parentheses'>(</span><a href="plperl.c.html#LN2441"><span class='Ref_To_Local'>svTD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN2439"><span class='Ref_To_Local'>perlret</span></a><span class='Parentheses'>) 
</span>        SvREFCNT_dec<span class='Parentheses'>(</span><a href="plperl.c.html#LN2439"><span class='Ref_To_Local'>perlret</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="plperl.c.html#LN2440"><span class='Ref_To_Local'>retval</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end plperl_trigger_handler &raquo; </span> 
 
 
<span class='Keyword'>static void 
</span><a name="LN2549"></a><span class='Declare_Function'>plperl_event_trigger_handler</span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2551"></a>    <a href="plperl.c.html#LN105"><span class='Ref_to_Struct'>plperl_proc_desc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>prodesc</span><span class='Delimiter'>; 
</span><a name="LN2552"></a>    SV         <span class='Operator'>*</span><span class='Declare_Local'>svTD</span><span class='Delimiter'>; 
</span><a name="LN2553"></a>    ErrorContextCallback <span class='Declare_Local'>pl_error_context</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Connect to SPI manager */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/executor/spi.h.html#LN79"><span class='Ref_to_Proto'>SPI_connect</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../include/executor/spi.h.html#LN49"><span class='Ref_to_Const'>SPI_OK_CONNECT</span></a><span class='Parentheses'>)</span> 
        <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not connect to SPI manager"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Find or compile the function */ 
</span>    <a href="plperl.c.html#LN2551"><span class='Ref_To_Local'>prodesc</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN261"><span class='Ref_to_Proto'>compile_plperl_function</span></a><span class='Parentheses'>(</span>fcinfo<span class='Operator'>-&GT;</span>flinfo<span class='Operator'>-&GT;</span>fn_oid<span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN178"><span class='Ref_to_Member'>prodesc</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN2551"><span class='Ref_To_Local'>prodesc</span></a><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN132"><span class='Ref_to_Macro'>increment_prodesc_refcount</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2551"><span class='Ref_To_Local'>prodesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set a callback for error reporting */ 
</span>    <a href="plperl.c.html#LN2553"><span class='Ref_To_Local'>pl_error_context</span></a><span class='Operator'>.</span>callback <span class='Operator'>= </span><a href="plperl.c.html#LN294"><span class='Ref_to_Proto'>plperl_exec_callback</span></a><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN2553"><span class='Ref_To_Local'>pl_error_context</span></a><span class='Operator'>.</span>previous <span class='Operator'>= </span><a href="../../backend/utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN2553"><span class='Ref_To_Local'>pl_error_context</span></a><span class='Operator'>.</span>arg <span class='Operator'>= </span><a href="plperl.c.html#LN2551"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN107"><span class='Ref_to_Member'>proname</span></a><span class='Delimiter'>; 
</span>    <a href="../../backend/utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a> <span class='Operator'>= &</span><a href="plperl.c.html#LN2553"><span class='Ref_To_Local'>pl_error_context</span></a><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN298"><span class='Ref_to_Proto'>activate_interpreter</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2551"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN113"><span class='Ref_to_Member'>interp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN2552"><span class='Ref_To_Local'>svTD</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN1660"><span class='Ref_to_Func'>plperl_event_trigger_build_args</span></a><span class='Parentheses'>(</span>fcinfo<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN2262"><span class='Ref_to_Func'>plperl_call_perl_event_trigger_func</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2551"><span class='Ref_To_Local'>prodesc</span></a><span class='Delimiter'>, </span>fcinfo<span class='Delimiter'>, </span><a href="plperl.c.html#LN2552"><span class='Ref_To_Local'>svTD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/executor/spi.h.html#LN80"><span class='Ref_to_Proto'>SPI_finish</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../include/executor/spi.h.html#LN50"><span class='Ref_to_Const'>SPI_OK_FINISH</span></a><span class='Parentheses'>)</span> 
        <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_finish() failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Restore the previous error callback */ 
</span>    <a href="../../backend/utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN2553"><span class='Ref_To_Local'>pl_error_context</span></a><span class='Operator'>.</span>previous<span class='Delimiter'>; 
</span> 
    SvREFCNT_dec<span class='Parentheses'>(</span><a href="plperl.c.html#LN2552"><span class='Ref_To_Local'>svTD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end plperl_event_trigger_handler &raquo; </span> 
 
 
<span class='Keyword'>static bool 
</span><a name="LN2588"></a><span class='Declare_Function'>validate_plperl_function</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN166"><span class='Ref_to_Struct'>plperl_proc_ptr</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proc_ptr</span><span class='Delimiter'>, </span><a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>procTup</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN2588"><span class='Ref_to_Parameter'>proc_ptr</span></a> <span class='Operator'>&& </span><a href="plperl.c.html#LN2588"><span class='Ref_to_Parameter'>proc_ptr</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN169"><span class='Ref_to_Member'>proc_ptr</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2592"></a>        <a href="plperl.c.html#LN105"><span class='Ref_to_Struct'>plperl_proc_desc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>prodesc</span> <span class='Operator'>= </span><a href="plperl.c.html#LN2588"><span class='Ref_to_Parameter'>proc_ptr</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN169"><span class='Ref_to_Member'>proc_ptr</span></a><span class='Delimiter'>; 
</span><a name="LN2593"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>uptodate</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * If it's present, must check whether it's still up to date. 
         * This is needed because CREATE OR REPLACE FUNCTION can modify the 
         * function's pg_proc entry without changing its OID. 
         ************************************************************/ 
</span>        <a href="plperl.c.html#LN2593"><span class='Ref_To_Local'>uptodate</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="plperl.c.html#LN2592"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN110"><span class='Ref_to_Member'>fn_xmin</span></a> <span class='Operator'>== </span><a href="../../include/access/htup_details.h.html#LN301"><span class='Ref_to_Macro'>HeapTupleHeaderGetRawXmin</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2588"><span class='Ref_to_Parameter'>procTup</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>                    <a href="../../backend/storage/page/itemptr.c.html#LN27"><span class='Ref_to_Func'>ItemPointerEquals</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="plperl.c.html#LN2592"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN111"><span class='Ref_to_Member'>fn_tid</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN2588"><span class='Ref_to_Parameter'>procTup</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN2593"><span class='Ref_To_Local'>uptodate</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Otherwise, unlink the obsoleted entry from the hashtable ... */ 
</span>        <a href="plperl.c.html#LN2588"><span class='Ref_to_Parameter'>proc_ptr</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN169"><span class='Ref_to_Member'>proc_ptr</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* ... and release the corresponding refcount, probably deleting it */ 
</span>        <a href="plperl.c.html#LN134"><span class='Ref_to_Macro'>decrement_prodesc_refcount</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2592"><span class='Ref_To_Local'>prodesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if proc_ptr&&proc_ptr-&GT;p... &raquo; </span> 
 
    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end validate_plperl_function &raquo; </span> 
 
 
<span class='Keyword'>static void 
</span><a name="LN2617"></a><span class='Declare_Function'>free_plperl_function</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN105"><span class='Ref_to_Struct'>plperl_proc_desc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>prodesc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN2617"><span class='Ref_to_Parameter'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN109"><span class='Ref_to_Member'>fn_refcount</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Release CODE reference, if we have one, from the appropriate interp */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN2617"><span class='Ref_to_Parameter'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN112"><span class='Ref_to_Member'>reference</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2623"></a>        <a href="plperl.c.html#LN88"><span class='Ref_to_Struct'>plperl_interp_desc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>oldinterp</span> <span class='Operator'>= </span><a href="plperl.c.html#LN227"><span class='Ref_to_Global_Var'>plperl_active_interp</span></a><span class='Delimiter'>; 
</span> 
        <a href="plperl.c.html#LN298"><span class='Ref_to_Proto'>activate_interpreter</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2617"><span class='Ref_to_Parameter'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN113"><span class='Ref_to_Member'>interp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        SvREFCNT_dec<span class='Parentheses'>(</span><a href="plperl.c.html#LN2617"><span class='Ref_to_Parameter'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN112"><span class='Ref_to_Member'>reference</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN298"><span class='Ref_to_Proto'>activate_interpreter</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2623"><span class='Ref_To_Local'>oldinterp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Comment_Multi_Line'>/* Release all PG-owned data for this proc */ 
</span>    <a href="../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2617"><span class='Ref_to_Parameter'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN108"><span class='Ref_to_Member'>fn_cxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Keyword'>static </span><a href="plperl.c.html#LN105"><span class='Ref_to_Struct'>plperl_proc_desc</span></a> <span class='Operator'>* 
</span><a name="LN2635"></a><span class='Declare_Function'>compile_plperl_function</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>fn_oid</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>is_trigger</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>is_event_trigger</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2637"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>procTup</span><span class='Delimiter'>; 
</span><a name="LN2638"></a>    <a href="../../include/catalog/pg_proc.h.html#LN82"><span class='Ref_to_Typedef'>Form_pg_proc</span></a> <span class='Declare_Local'>procStruct</span><span class='Delimiter'>; 
</span><a name="LN2639"></a>    <a href="plperl.c.html#LN154"><span class='Ref_to_Struct'>plperl_proc_key</span></a> <span class='Declare_Local'>proc_key</span><span class='Delimiter'>; 
</span><a name="LN2640"></a>    <a href="plperl.c.html#LN166"><span class='Ref_to_Struct'>plperl_proc_ptr</span></a> <span class='Operator'>*</span><span class='Declare_Local'>proc_ptr</span><span class='Delimiter'>; 
</span><a name="LN2641"></a>    <a href="plperl.c.html#LN105"><span class='Ref_to_Struct'>plperl_proc_desc</span></a> <span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Declare_Local'>prodesc</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN2642"></a>    <span class='Keyword'>volatile </span><a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>proc_cxt</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN2643"></a>    <a href="plperl.c.html#LN88"><span class='Ref_to_Struct'>plperl_interp_desc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>oldinterp</span> <span class='Operator'>= </span><a href="plperl.c.html#LN227"><span class='Ref_to_Global_Var'>plperl_active_interp</span></a><span class='Delimiter'>; 
</span><a name="LN2644"></a>    ErrorContextCallback <span class='Declare_Local'>plperl_error_context</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We'll need the pg_proc tuple in any case... */ 
</span>    <a href="plperl.c.html#LN2637"><span class='Ref_To_Local'>procTup</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN76"><span class='Ref_to_EnumConst'>PROCOID</span></a><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2635"><span class='Ref_to_Parameter'>fn_oid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2637"><span class='Ref_To_Local'>procTup</span></a><span class='Parentheses'>))</span> 
        <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cache lookup failed for function %u"</span><span class='Delimiter'>, </span><a href="plperl.c.html#LN2635"><span class='Ref_to_Parameter'>fn_oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN2638"><span class='Ref_To_Local'>procStruct</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_proc.h.html#LN82"><span class='Ref_to_Typedef'>Form_pg_proc</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2637"><span class='Ref_To_Local'>procTup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Try to find function in plperl_proc_hash.  The reason for this 
     * overcomplicated-seeming lookup procedure is that we don't know whether 
     * it's plperl or plperlu, and don't want to spend a lookup in pg_language 
     * to find out. 
     */ 
</span>    <a href="plperl.c.html#LN2639"><span class='Ref_To_Local'>proc_key</span></a><span class='Operator'>.</span><a href="plperl.c.html#LN156"><span class='Ref_to_Member'>proc_id</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN2635"><span class='Ref_to_Parameter'>fn_oid</span></a><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN2639"><span class='Ref_To_Local'>proc_key</span></a><span class='Operator'>.</span><a href="plperl.c.html#LN162"><span class='Ref_to_Member'>is_trigger</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN2635"><span class='Ref_to_Parameter'>is_trigger</span></a><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN2639"><span class='Ref_To_Local'>proc_key</span></a><span class='Operator'>.</span><a href="plperl.c.html#LN163"><span class='Ref_to_Member'>user_id</span></a> <span class='Operator'>= </span><a href="../../backend/utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN2640"><span class='Ref_To_Local'>proc_ptr</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN226"><span class='Ref_to_Global_Var'>plperl_proc_hash</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN2639"><span class='Ref_To_Local'>proc_key</span></a><span class='Delimiter'>, 
</span>                           <a href="../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN2587"><span class='Ref_to_Func'>validate_plperl_function</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2640"><span class='Ref_To_Local'>proc_ptr</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN2637"><span class='Ref_To_Local'>procTup</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Found valid plperl entry */ 
</span>        <a href="../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2637"><span class='Ref_To_Local'>procTup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="plperl.c.html#LN2640"><span class='Ref_To_Local'>proc_ptr</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN169"><span class='Ref_to_Member'>proc_ptr</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* If not found or obsolete, maybe it's plperlu */ 
</span>    <a href="plperl.c.html#LN2639"><span class='Ref_To_Local'>proc_key</span></a><span class='Operator'>.</span><a href="plperl.c.html#LN163"><span class='Ref_to_Member'>user_id</span></a> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN2640"><span class='Ref_To_Local'>proc_ptr</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN226"><span class='Ref_to_Global_Var'>plperl_proc_hash</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN2639"><span class='Ref_To_Local'>proc_key</span></a><span class='Delimiter'>, 
</span>                           <a href="../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN2587"><span class='Ref_to_Func'>validate_plperl_function</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2640"><span class='Ref_To_Local'>proc_ptr</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN2637"><span class='Ref_To_Local'>procTup</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Found valid plperlu entry */ 
</span>        <a href="../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2637"><span class='Ref_To_Local'>procTup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="plperl.c.html#LN2640"><span class='Ref_To_Local'>proc_ptr</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN169"><span class='Ref_to_Member'>proc_ptr</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * If we haven't found it in the hashtable, we analyze 
     * the function's arguments and return type and store 
     * the in-/out-functions in the prodesc block, 
     * then we load the procedure into the Perl interpreter, 
     * and last we create a new hashtable entry for it. 
     ************************************************************/ 
</span> 
    <span class='Comment_Multi_Line'>/* Set a callback for reporting compilation errors */ 
</span>    <a href="plperl.c.html#LN2644"><span class='Ref_To_Local'>plperl_error_context</span></a><span class='Operator'>.</span>callback <span class='Operator'>= </span><a href="plperl.c.html#LN293"><span class='Ref_to_Proto'>plperl_compile_callback</span></a><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN2644"><span class='Ref_To_Local'>plperl_error_context</span></a><span class='Operator'>.</span>previous <span class='Operator'>= </span><a href="../../backend/utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN2644"><span class='Ref_To_Local'>plperl_error_context</span></a><span class='Operator'>.</span>arg <span class='Operator'>= </span><a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2638"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>proname<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../backend/utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a> <span class='Operator'>= &</span><a href="plperl.c.html#LN2644"><span class='Ref_To_Local'>plperl_error_context</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2697"></a>        <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>langTup</span><span class='Delimiter'>; 
</span><a name="LN2698"></a>        <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>typeTup</span><span class='Delimiter'>; 
</span><a name="LN2699"></a>        <a href="../../include/catalog/pg_language.h.html#LN50"><span class='Ref_to_Typedef'>Form_pg_language</span></a> <span class='Declare_Local'>langStruct</span><span class='Delimiter'>; 
</span><a name="LN2700"></a>        <a href="../../include/catalog/pg_type.h.html#LN232"><span class='Ref_to_Typedef'>Form_pg_type</span></a> <span class='Declare_Local'>typeStruct</span><span class='Delimiter'>; 
</span><a name="LN2701"></a>        <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>protrftypes_datum</span><span class='Delimiter'>; 
</span><a name="LN2702"></a>        <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>prosrcdatum</span><span class='Delimiter'>; 
</span><a name="LN2703"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull</span><span class='Delimiter'>; 
</span><a name="LN2704"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>proc_source</span><span class='Delimiter'>; 
</span><a name="LN2705"></a>        <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * Allocate a context that will hold all PG data for the procedure. 
         ************************************************************/ 
</span>        <a href="plperl.c.html#LN2642"><span class='Ref_To_Local'>proc_cxt</span></a> <span class='Operator'>= </span><a href="../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../../backend/utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, 
</span>                                         <a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2638"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>proname<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                         <a href="../../include/utils/memutils.h.html#LN174"><span class='Ref_to_Const'>ALLOCSET_SMALL_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * Allocate and fill a new procedure description block. 
         * struct prodesc and subsidiary data must all live in proc_cxt. 
         ************************************************************/ 
</span>        <a href="plperl.c.html#LN2705"><span class='Ref_To_Local'>oldcontext</span></a> <span class='Operator'>= </span><a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2642"><span class='Ref_To_Local'>proc_cxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="plperl.c.html#LN105"><span class='Ref_to_Struct'>plperl_proc_desc</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN105"><span class='Ref_to_Struct'>plperl_proc_desc</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN107"><span class='Ref_to_Member'>proname</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2638"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>proname<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN108"><span class='Ref_to_Member'>fn_cxt</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN2642"><span class='Ref_To_Local'>proc_cxt</span></a><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN109"><span class='Ref_to_Member'>fn_refcount</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN110"><span class='Ref_to_Member'>fn_xmin</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN301"><span class='Ref_to_Macro'>HeapTupleHeaderGetRawXmin</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2637"><span class='Ref_To_Local'>procTup</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN111"><span class='Ref_to_Member'>fn_tid</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN2637"><span class='Ref_To_Local'>procTup</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN126"><span class='Ref_to_Member'>nargs</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN2638"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>pronargs<span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN127"><span class='Ref_to_Member'>arg_out_func</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN126"><span class='Ref_to_Member'>nargs</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN128"><span class='Ref_to_Member'>arg_is_rowtype</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN126"><span class='Ref_to_Member'>nargs</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>bool</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN129"><span class='Ref_to_Member'>arg_arraytype</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN126"><span class='Ref_to_Member'>nargs</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2705"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Remember if function is STABLE/IMMUTABLE */ 
</span>        <a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN114"><span class='Ref_to_Member'>fn_readonly</span></a> <span class='Operator'>= 
</span>            <span class='Parentheses'>(</span><a href="plperl.c.html#LN2638"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>provolatile <span class='Operator'>!= </span><a href="../../include/catalog/pg_proc.h.html#LN5484"><span class='Ref_to_Const'>PROVOLATILE_VOLATILE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Fetch protrftypes */ 
</span>        <a href="plperl.c.html#LN2701"><span class='Ref_To_Local'>protrftypes_datum</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN133"><span class='Ref_to_Proto'>SysCacheGetAttr</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN76"><span class='Ref_to_EnumConst'>PROCOID</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN2637"><span class='Ref_To_Local'>procTup</span></a><span class='Delimiter'>, 
</span>                                          <a href="../../include/catalog/pg_proc.h.html#LN113"><span class='Ref_to_Const'>Anum_pg_proc_protrftypes</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN2703"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2642"><span class='Ref_To_Local'>proc_cxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN116"><span class='Ref_to_Member'>trftypes</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN2703"><span class='Ref_To_Local'>isnull</span></a> <span class='Operator'>? </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a> <span class='Operator'>: </span><a href="../../include/catalog/pg_proc_fn.h.html#LN48"><span class='Ref_to_Proto'>oid_array_to_list</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2701"><span class='Ref_To_Local'>protrftypes_datum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2705"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * Lookup the pg_language tuple by Oid 
         ************************************************************/ 
</span>        <a href="plperl.c.html#LN2697"><span class='Ref_To_Local'>langTup</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN67"><span class='Ref_to_EnumConst'>LANGOID</span></a><span class='Delimiter'>, 
</span>                                  <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2638"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>prolang<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2697"><span class='Ref_To_Local'>langTup</span></a><span class='Parentheses'>))</span> 
            <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cache lookup failed for language %u"</span><span class='Delimiter'>, 
</span>                 <a href="plperl.c.html#LN2638"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>prolang<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN2699"><span class='Ref_To_Local'>langStruct</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_language.h.html#LN50"><span class='Ref_to_Typedef'>Form_pg_language</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2697"><span class='Ref_To_Local'>langTup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN115"><span class='Ref_to_Member'>lang_oid</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2697"><span class='Ref_To_Local'>langTup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN117"><span class='Ref_to_Member'>lanpltrusted</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN2699"><span class='Ref_To_Local'>langStruct</span></a><span class='Operator'>-&GT;</span>lanpltrusted<span class='Delimiter'>; 
</span>        <a href="../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2697"><span class='Ref_To_Local'>langTup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * Get the required information for input conversion of the 
         * return value. 
         ************************************************************/ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plperl.c.html#LN2635"><span class='Ref_to_Parameter'>is_trigger</span></a> <span class='Operator'>&& !</span><a href="plperl.c.html#LN2635"><span class='Ref_to_Parameter'>is_event_trigger</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="plperl.c.html#LN2698"><span class='Ref_To_Local'>typeTup</span></a> <span class='Operator'>= 
</span>                <a href="../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN107"><span class='Ref_to_EnumConst'>TYPEOID</span></a><span class='Delimiter'>, 
</span>                                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2638"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>prorettype<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2698"><span class='Ref_To_Local'>typeTup</span></a><span class='Parentheses'>))</span> 
                <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cache lookup failed for type %u"</span><span class='Delimiter'>, 
</span>                     <a href="plperl.c.html#LN2638"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>prorettype<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="plperl.c.html#LN2700"><span class='Ref_To_Local'>typeStruct</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_type.h.html#LN232"><span class='Ref_to_Typedef'>Form_pg_type</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2698"><span class='Ref_To_Local'>typeTup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Disallow pseudotype result, except VOID or RECORD */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN2700"><span class='Ref_To_Local'>typeStruct</span></a><span class='Operator'>-&GT;</span>typtype <span class='Operator'>== </span><a href="../../include/catalog/pg_type.h.html#LN723"><span class='Ref_to_Const'>TYPTYPE_PSEUDO</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN2638"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>prorettype <span class='Operator'>== </span><a href="../../include/catalog/pg_type.h.html#LN689"><span class='Ref_to_Const'>VOIDOID</span></a> <span class='Operator'>|| 
</span>                    <a href="plperl.c.html#LN2638"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>prorettype <span class='Operator'>== </span><a href="../../include/catalog/pg_type.h.html#LN679"><span class='Ref_to_Const'>RECORDOID</span></a><span class='Parentheses'>) 
</span>                     <span class='Comment_Multi_Line'>/* okay */ </span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN2638"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>prorettype <span class='Operator'>== </span><a href="../../include/catalog/pg_type.h.html#LN691"><span class='Ref_to_Const'>TRIGGEROID</span></a> <span class='Operator'>|| 
</span>                         <a href="plperl.c.html#LN2638"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>prorettype <span class='Operator'>== </span><a href="../../include/catalog/pg_type.h.html#LN693"><span class='Ref_to_Const'>EVTTRIGGEROID</span></a><span class='Parentheses'>) 
</span>                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"trigger functions can only be called "</span> 
                                    <span class='String'>"as triggers"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"PL/Perl functions cannot return type %s"</span><span class='Delimiter'>, 
</span>                                    <a href="../../backend/utils/adt/format_type.c.html#LN92"><span class='Ref_to_Func'>format_type_be</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2638"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>prorettype<span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN122"><span class='Ref_to_Member'>result_oid</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN2638"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>prorettype<span class='Delimiter'>; 
</span>            <a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN119"><span class='Ref_to_Member'>fn_retisset</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN2638"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>proretset<span class='Delimiter'>; 
</span>            <a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN118"><span class='Ref_to_Member'>fn_retistuple</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="plperl.c.html#LN2638"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>prorettype <span class='Operator'>== </span><a href="../../include/catalog/pg_type.h.html#LN679"><span class='Ref_to_Const'>RECORDOID</span></a> <span class='Operator'>|| 
</span>                                   <a href="plperl.c.html#LN2700"><span class='Ref_To_Local'>typeStruct</span></a><span class='Operator'>-&GT;</span>typtype <span class='Operator'>== </span><a href="../../include/catalog/pg_type.h.html#LN720"><span class='Ref_to_Const'>TYPTYPE_COMPOSITE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN120"><span class='Ref_to_Member'>fn_retisarray</span></a> <span class='Operator'>= 
</span>                <span class='Parentheses'>(</span><a href="plperl.c.html#LN2700"><span class='Ref_To_Local'>typeStruct</span></a><span class='Operator'>-&GT;</span>typlen <span class='Operator'>== -</span><span class='Number'>1</span> <span class='Operator'>&& </span><a href="plperl.c.html#LN2700"><span class='Ref_To_Local'>typeStruct</span></a><span class='Operator'>-&GT;</span>typelem<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../include/fmgr.h.html#LN99"><span class='Ref_to_Proto'>fmgr_info_cxt</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2700"><span class='Ref_To_Local'>typeStruct</span></a><span class='Operator'>-&GT;</span>typinput<span class='Delimiter'>, 
</span>                          <span class='Operator'>&</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN123"><span class='Ref_to_Member'>result_in_func</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                          <a href="plperl.c.html#LN2642"><span class='Ref_To_Local'>proc_cxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN124"><span class='Ref_to_Member'>result_typioparam</span></a> <span class='Operator'>= </span><a href="../../include/utils/lsyscache.h.html#LN138"><span class='Ref_to_Proto'>getTypeIOParam</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2698"><span class='Ref_To_Local'>typeTup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2698"><span class='Ref_To_Local'>typeTup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !is_trigger&&!is_even... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * Get the required information for output conversion 
         * of all procedure arguments 
         ************************************************************/ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plperl.c.html#LN2635"><span class='Ref_to_Parameter'>is_trigger</span></a> <span class='Operator'>&& !</span><a href="plperl.c.html#LN2635"><span class='Ref_to_Parameter'>is_event_trigger</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2810"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN2810"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="plperl.c.html#LN2810"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN126"><span class='Ref_to_Member'>nargs</span></a><span class='Delimiter'>; </span><a href="plperl.c.html#LN2810"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="plperl.c.html#LN2698"><span class='Ref_To_Local'>typeTup</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN107"><span class='Ref_to_EnumConst'>TYPEOID</span></a><span class='Delimiter'>, 
</span>                        <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2638"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>proargtypes<span class='Operator'>.</span>values<span class='Delimiter'>[</span><a href="plperl.c.html#LN2810"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2698"><span class='Ref_To_Local'>typeTup</span></a><span class='Parentheses'>))</span> 
                    <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cache lookup failed for type %u"</span><span class='Delimiter'>, 
</span>                         <a href="plperl.c.html#LN2638"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>proargtypes<span class='Operator'>.</span>values<span class='Delimiter'>[</span><a href="plperl.c.html#LN2810"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="plperl.c.html#LN2700"><span class='Ref_To_Local'>typeStruct</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_type.h.html#LN232"><span class='Ref_to_Typedef'>Form_pg_type</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2698"><span class='Ref_To_Local'>typeTup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* Disallow pseudotype argument */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN2700"><span class='Ref_To_Local'>typeStruct</span></a><span class='Operator'>-&GT;</span>typtype <span class='Operator'>== </span><a href="../../include/catalog/pg_type.h.html#LN723"><span class='Ref_to_Const'>TYPTYPE_PSEUDO</span></a> <span class='Operator'>&& 
</span>                    <a href="plperl.c.html#LN2638"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>proargtypes<span class='Operator'>.</span>values<span class='Delimiter'>[</span><a href="plperl.c.html#LN2810"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><a href="../../include/catalog/pg_type.h.html#LN679"><span class='Ref_to_Const'>RECORDOID</span></a><span class='Parentheses'>) 
</span>                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"PL/Perl functions cannot accept type %s"</span><span class='Delimiter'>, 
</span>                        <a href="../../backend/utils/adt/format_type.c.html#LN92"><span class='Ref_to_Func'>format_type_be</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2638"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>proargtypes<span class='Operator'>.</span>values<span class='Delimiter'>[</span><a href="plperl.c.html#LN2810"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN2700"><span class='Ref_To_Local'>typeStruct</span></a><span class='Operator'>-&GT;</span>typtype <span class='Operator'>== </span><a href="../../include/catalog/pg_type.h.html#LN720"><span class='Ref_to_Const'>TYPTYPE_COMPOSITE</span></a> <span class='Operator'>|| 
</span>                    <a href="plperl.c.html#LN2638"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>proargtypes<span class='Operator'>.</span>values<span class='Delimiter'>[</span><a href="plperl.c.html#LN2810"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><a href="../../include/catalog/pg_type.h.html#LN679"><span class='Ref_to_Const'>RECORDOID</span></a><span class='Parentheses'>) 
</span>                    <a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN128"><span class='Ref_to_Member'>arg_is_rowtype</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN2810"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN128"><span class='Ref_to_Member'>arg_is_rowtype</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN2810"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                    <a href="../../include/fmgr.h.html#LN99"><span class='Ref_to_Proto'>fmgr_info_cxt</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2700"><span class='Ref_To_Local'>typeStruct</span></a><span class='Operator'>-&GT;</span>typoutput<span class='Delimiter'>, 
</span>                                  <span class='Operator'>&</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN127"><span class='Ref_to_Member'>arg_out_func</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN2810"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                  <a href="plperl.c.html#LN2642"><span class='Ref_To_Local'>proc_cxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <span class='Comment_Multi_Line'>/* Identify array attributes */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN2700"><span class='Ref_To_Local'>typeStruct</span></a><span class='Operator'>-&GT;</span>typelem <span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="plperl.c.html#LN2700"><span class='Ref_To_Local'>typeStruct</span></a><span class='Operator'>-&GT;</span>typlen <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>                    <a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN129"><span class='Ref_to_Member'>arg_arraytype</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN2810"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="plperl.c.html#LN2638"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>proargtypes<span class='Operator'>.</span>values<span class='Delimiter'>[</span><a href="plperl.c.html#LN2810"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>                <span class='Control'>else</span> 
                    <a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN129"><span class='Ref_to_Member'>arg_arraytype</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN2810"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span> 
                <a href="../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2698"><span class='Ref_To_Local'>typeTup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;prodesc-&GT;nargs;... &raquo; </span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !is_trigger&&!is_even... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * create the text of the anonymous subroutine. 
         * we do not use a named subroutine so that we can call directly 
         * through the reference. 
         ************************************************************/ 
</span>        <a href="plperl.c.html#LN2702"><span class='Ref_To_Local'>prosrcdatum</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN133"><span class='Ref_to_Proto'>SysCacheGetAttr</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN76"><span class='Ref_to_EnumConst'>PROCOID</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN2637"><span class='Ref_To_Local'>procTup</span></a><span class='Delimiter'>, 
</span>                                      <a href="../../include/catalog/pg_proc.h.html#LN114"><span class='Ref_to_Const'>Anum_pg_proc_prosrc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN2703"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN2703"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>) 
</span>            <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"null prosrc"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN2704"><span class='Ref_To_Local'>proc_source</span></a> <span class='Operator'>= </span><a href="../../include/utils/builtins.h.html#LN91"><span class='Ref_to_Macro'>TextDatumGetCString</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2702"><span class='Ref_To_Local'>prosrcdatum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * Create the procedure in the appropriate interpreter 
         ************************************************************/ 
</span> 
        <a href="plperl.c.html#LN538"><span class='Ref_to_Func'>select_perl_context</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN117"><span class='Ref_to_Member'>lanpltrusted</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN113"><span class='Ref_to_Member'>interp</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN227"><span class='Ref_to_Global_Var'>plperl_active_interp</span></a><span class='Delimiter'>; 
</span> 
        <a href="plperl.c.html#LN290"><span class='Ref_to_Proto'>plperl_create_sub</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN2704"><span class='Ref_To_Local'>proc_source</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN2635"><span class='Ref_to_Parameter'>fn_oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="plperl.c.html#LN298"><span class='Ref_to_Proto'>activate_interpreter</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2643"><span class='Ref_To_Local'>oldinterp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2704"><span class='Ref_To_Local'>proc_source</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN112"><span class='Ref_to_Member'>reference</span></a><span class='Parentheses'>)</span>    <span class='Comment_Single_Line'>/* can this happen? */ 
</span>            <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not create PL/Perl internal procedure"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * OK, link the procedure into the correct hashtable entry. 
         * Note we assume that the hashtable entry either doesn't exist yet, 
         * or we already cleared its proc_ptr during the validation attempts 
         * above.  So no need to decrement an old refcount here. 
         ************************************************************/ 
</span>        <a href="plperl.c.html#LN2639"><span class='Ref_To_Local'>proc_key</span></a><span class='Operator'>.</span><a href="plperl.c.html#LN163"><span class='Ref_to_Member'>user_id</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN117"><span class='Ref_to_Member'>lanpltrusted</span></a> <span class='Operator'>? </span><a href="../../backend/utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>() </span><span class='Operator'>: </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span> 
        <a href="plperl.c.html#LN2640"><span class='Ref_To_Local'>proc_ptr</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN226"><span class='Ref_to_Global_Var'>plperl_proc_hash</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN2639"><span class='Ref_To_Local'>proc_key</span></a><span class='Delimiter'>, 
</span>                               <a href="../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* We assume these two steps can't throw an error: */ 
</span>        <a href="plperl.c.html#LN2640"><span class='Ref_To_Local'>proc_ptr</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN169"><span class='Ref_to_Member'>proc_ptr</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN132"><span class='Ref_to_Macro'>increment_prodesc_refcount</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * If we got as far as creating a reference, we should be able to use 
         * free_plperl_function() to clean up.  If not, then at most we have 
         * some PG memory resources in proc_cxt, which we can just delete. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a> <span class='Operator'>&& </span><a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN112"><span class='Ref_to_Member'>reference</span></a><span class='Parentheses'>) 
</span>            <a href="plperl.c.html#LN259"><span class='Ref_to_Proto'>free_plperl_function</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN2642"><span class='Ref_To_Local'>proc_cxt</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2642"><span class='Ref_To_Local'>proc_cxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Be sure to restore the previous interpreter, too, for luck */ 
</span>        <a href="plperl.c.html#LN298"><span class='Ref_to_Proto'>activate_interpreter</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2643"><span class='Ref_To_Local'>oldinterp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/utils/elog.h.html#LN310"><span class='Ref_to_Macro'>PG_RE_THROW</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* restore previous error callback */ 
</span>    <a href="../../backend/utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN2644"><span class='Ref_To_Local'>plperl_error_context</span></a><span class='Operator'>.</span>previous<span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2637"><span class='Ref_To_Local'>procTup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="plperl.c.html#LN2641"><span class='Ref_To_Local'>prodesc</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end compile_plperl_function &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* Build a hash from a given composite/row datum */ 
</span><span class='Keyword'>static </span>SV  <span class='Operator'>* 
</span><a name="LN2921"></a><span class='Declare_Function'>plperl_hash_from_datum</span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>attr</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2923"></a>    <a href="../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a> <span class='Declare_Local'>td</span><span class='Delimiter'>; 
</span><a name="LN2924"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>tupType</span><span class='Delimiter'>; 
</span><a name="LN2925"></a>    <a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>tupTypmod</span><span class='Delimiter'>; 
</span><a name="LN2926"></a>    <a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span><span class='Delimiter'>; 
</span><a name="LN2927"></a>    <a href="../../include/access/htup.h.html#LN61"><span class='Ref_to_Struct'>HeapTupleData</span></a> <span class='Declare_Local'>tmptup</span><span class='Delimiter'>; 
</span><a name="LN2928"></a>    SV         <span class='Operator'>*</span><span class='Declare_Local'>sv</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN2923"><span class='Ref_To_Local'>td</span></a> <span class='Operator'>= </span><a href="../../include/fmgr.h.html#LN258"><span class='Ref_to_Macro'>DatumGetHeapTupleHeader</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2921"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Extract rowtype info and find a tupdesc */ 
</span>    <a href="plperl.c.html#LN2924"><span class='Ref_To_Local'>tupType</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN444"><span class='Ref_to_Macro'>HeapTupleHeaderGetTypeId</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2923"><span class='Ref_To_Local'>td</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN2925"><span class='Ref_To_Local'>tupTypmod</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN454"><span class='Ref_to_Macro'>HeapTupleHeaderGetTypMod</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2923"><span class='Ref_To_Local'>td</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN2926"><span class='Ref_To_Local'>tupdesc</span></a> <span class='Operator'>= </span><a href="../../include/utils/typcache.h.html#LN151"><span class='Ref_to_Proto'>lookup_rowtype_tupdesc</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2924"><span class='Ref_To_Local'>tupType</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN2925"><span class='Ref_To_Local'>tupTypmod</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Build a temporary HeapTuple control structure */ 
</span>    <a href="plperl.c.html#LN2927"><span class='Ref_To_Local'>tmptup</span></a><span class='Operator'>.</span><a href="../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN438"><span class='Ref_to_Macro'>HeapTupleHeaderGetDatumLength</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2923"><span class='Ref_To_Local'>td</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN2927"><span class='Ref_To_Local'>tmptup</span></a><span class='Operator'>.</span><a href="../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN2923"><span class='Ref_To_Local'>td</span></a><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN2928"><span class='Ref_To_Local'>sv</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN265"><span class='Ref_to_Proto'>plperl_hash_from_tuple</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="plperl.c.html#LN2927"><span class='Ref_To_Local'>tmptup</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN2926"><span class='Ref_To_Local'>tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/tupdesc.h.html#LN106"><span class='Ref_to_Macro'>ReleaseTupleDesc</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2926"><span class='Ref_To_Local'>tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="plperl.c.html#LN2928"><span class='Ref_To_Local'>sv</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end plperl_hash_from_datum &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* Build a hash from all attributes of a given tuple. */ 
</span><span class='Keyword'>static </span>SV  <span class='Operator'>* 
</span><a name="LN2949"></a><span class='Declare_Function'>plperl_hash_from_tuple</span><span class='Parentheses'>(</span><a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>tuple</span><span class='Delimiter'>, </span><a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>tupdesc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2951"></a>    HV         <span class='Operator'>*</span><span class='Declare_Local'>hv</span><span class='Delimiter'>; 
</span><a name="LN2952"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* since this function recurses, it could be driven to stack overflow */ 
</span>    <a href="../../include/miscadmin.h.html#LN275"><span class='Ref_to_Proto'>check_stack_depth</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN2951"><span class='Ref_To_Local'>hv</span></a> <span class='Operator'>= </span>newHV<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    hv_ksplit<span class='Parentheses'>(</span><a href="plperl.c.html#LN2951"><span class='Ref_To_Local'>hv</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN2949"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* pre-grow the hash */ 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN2952"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="plperl.c.html#LN2952"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="plperl.c.html#LN2949"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; </span><a href="plperl.c.html#LN2952"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2962"></a>        <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>attr</span><span class='Delimiter'>; 
</span><a name="LN2963"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull</span><span class='Delimiter'>, 
</span><a name="LN2964"></a>                    <span class='Declare_Local'>typisvarlena</span><span class='Delimiter'>; 
</span><a name="LN2965"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>attname</span><span class='Delimiter'>; 
</span><a name="LN2966"></a>        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>typoutput</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN2949"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN2952"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attisdropped<span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="plperl.c.html#LN2965"><span class='Ref_To_Local'>attname</span></a> <span class='Operator'>= </span><a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2949"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN2952"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attname<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN2962"><span class='Ref_To_Local'>attr</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN768"><span class='Ref_to_Macro'>heap_getattr</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2949"><span class='Ref_to_Parameter'>tuple</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN2952"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="plperl.c.html#LN2949"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN2963"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN2963"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Store (attname =&GT; undef) and move on.  Note we can't use 
             * &PL_sv_undef here; see "AVs, HVs and undefined values" in 
             * perlguts for an explanation. 
             */ 
</span>            <a href="plperl.c.html#LN288"><span class='Ref_to_Proto'>hv_store_string</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2951"><span class='Ref_To_Local'>hv</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN2965"><span class='Ref_To_Local'>attname</span></a><span class='Delimiter'>, </span>newSV<span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/utils/lsyscache.h.html#LN150"><span class='Ref_to_Proto'>type_is_rowtype</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2949"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN2952"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypid<span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN2987"></a>            SV         <span class='Operator'>*</span><span class='Declare_Local'>sv</span> <span class='Operator'>= </span><a href="plperl.c.html#LN266"><span class='Ref_to_Proto'>plperl_hash_from_datum</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2962"><span class='Ref_To_Local'>attr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="plperl.c.html#LN288"><span class='Ref_to_Proto'>hv_store_string</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2951"><span class='Ref_To_Local'>hv</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN2965"><span class='Ref_To_Local'>attname</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN2987"><span class='Ref_To_Local'>sv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span><a name="LN2993"></a>            SV         <span class='Operator'>*</span><span class='Declare_Local'>sv</span><span class='Delimiter'>; 
</span><a name="LN2994"></a>            <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>funcid</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="../../include/utils/lsyscache.h.html#LN160"><span class='Ref_to_Proto'>get_base_element_type</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2949"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN2952"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypid<span class='Parentheses'>)))</span> 
                <a href="plperl.c.html#LN2993"><span class='Ref_To_Local'>sv</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN267"><span class='Ref_to_Proto'>plperl_ref_from_pg_array</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2962"><span class='Ref_To_Local'>attr</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN2949"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN2952"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypid<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="plperl.c.html#LN2994"><span class='Ref_To_Local'>funcid</span></a> <span class='Operator'>= </span><a href="../../include/utils/lsyscache.h.html#LN130"><span class='Ref_to_Proto'>get_transform_fromsql</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2949"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN2952"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypid<span class='Delimiter'>, </span><a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN178"><span class='Ref_to_Member'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN115"><span class='Ref_to_Member'>lang_oid</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN178"><span class='Ref_to_Member'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN116"><span class='Ref_to_Member'>trftypes</span></a><span class='Parentheses'>)))</span> 
                <a href="plperl.c.html#LN2993"><span class='Ref_To_Local'>sv</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span>SV <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN621"><span class='Ref_to_Macro'>OidFunctionCall1</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2994"><span class='Ref_To_Local'>funcid</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN2962"><span class='Ref_To_Local'>attr</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span><a name="LN3002"></a>                <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>outputstr</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* XXX should have a way to cache these lookups */ 
</span>                <a href="../../include/utils/lsyscache.h.html#LN162"><span class='Ref_to_Proto'>getTypeOutputInfo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2949"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN2952"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypid<span class='Delimiter'>, 
</span>                                  <span class='Operator'>&</span><a href="plperl.c.html#LN2966"><span class='Ref_To_Local'>typoutput</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN2964"><span class='Ref_To_Local'>typisvarlena</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="plperl.c.html#LN3002"><span class='Ref_To_Local'>outputstr</span></a> <span class='Operator'>= </span><a href="../../include/fmgr.h.html#LN647"><span class='Ref_to_Proto'>OidOutputFunctionCall</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2966"><span class='Ref_To_Local'>typoutput</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN2962"><span class='Ref_To_Local'>attr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="plperl.c.html#LN2993"><span class='Ref_To_Local'>sv</span></a> <span class='Operator'>= </span><a href="plperl_helpers.h.html#LN106"><span class='Ref_to_Func'>cstr2sv</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3002"><span class='Ref_To_Local'>outputstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3002"><span class='Ref_To_Local'>outputstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="plperl.c.html#LN288"><span class='Ref_to_Proto'>hv_store_string</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN2951"><span class='Ref_To_Local'>hv</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN2965"><span class='Ref_To_Local'>attname</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN2993"><span class='Ref_To_Local'>sv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;tupdesc-&GT;natts;... &raquo; </span> 
    <span class='Control'>return</span> <a href="ppport.h.html#LN4455"><span class='Ref_to_Macro'>newRV_noinc</span></a><span class='Parentheses'>((</span>SV <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="plperl.c.html#LN2951"><span class='Ref_To_Local'>hv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end plperl_hash_from_tuple &raquo; </span> 
 
 
<span class='Keyword'>static void 
</span><a name="LN3021"></a><span class='Declare_Function'>check_spi_usage_allowed</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* see comment in plperl_fini() */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN238"><span class='Ref_to_Global_Var'>plperl_ending</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* simple croak as we don't want to involve PostgreSQL code */ 
</span>        croak<span class='Parentheses'>(</span><span class='String'>"SPI functions can not be used in END blocks"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
 
HV <span class='Operator'>* 
</span><a name="LN3033"></a><span class='Declare_Function'>plperl_spi_exec</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>query</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>limit</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3035"></a>    HV         <span class='Operator'>*</span><span class='Declare_Local'>ret_hv</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Execute the query inside a sub-transaction, so we can cope with errors 
     * sanely 
     */ 
</span><a name="LN3041"></a>    <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span> <span class='Operator'>= </span><a href="../../backend/utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>; 
</span><a name="LN3042"></a>    <a href="../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Local'>oldowner</span> <span class='Operator'>= </span><a href="../../backend/utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN3020"><span class='Ref_to_Func'>check_spi_usage_allowed</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/xact.h.html#LN358"><span class='Ref_to_Proto'>BeginInternalSubTransaction</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Want to run inside function's memory context */ 
</span>    <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3041"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3052"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>spi_rv</span><span class='Delimiter'>; 
</span> 
        <a href="../../backend/parser/scan.l.html#LN546"><span class='Ref_to_Proto'>pg_verifymbstr</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3033"><span class='Ref_to_Parameter'>query</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="plperl.c.html#LN3033"><span class='Ref_to_Parameter'>query</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="plperl.c.html#LN3052"><span class='Ref_To_Local'>spi_rv</span></a> <span class='Operator'>= </span><a href="../../include/executor/spi.h.html#LN81"><span class='Ref_to_Proto'>SPI_execute</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3033"><span class='Ref_to_Parameter'>query</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN178"><span class='Ref_to_Member'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN114"><span class='Ref_to_Member'>fn_readonly</span></a><span class='Delimiter'>, 
</span>                             <a href="plperl.c.html#LN3033"><span class='Ref_to_Parameter'>limit</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN3035"><span class='Ref_To_Local'>ret_hv</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN286"><span class='Ref_to_Proto'>plperl_spi_execute_fetch_result</span></a><span class='Parentheses'>(</span><a href="../../backend/executor/spi.c.html#LN40"><span class='Ref_to_Global_Var'>SPI_tuptable</span></a><span class='Delimiter'>, </span><a href="../../backend/executor/spi.c.html#LN38"><span class='Ref_to_Global_Var'>SPI_processed</span></a><span class='Delimiter'>, 
</span>                                                 <a href="plperl.c.html#LN3052"><span class='Ref_To_Local'>spi_rv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Commit the inner transaction, return to outer xact context */ 
</span>        <a href="../../include/access/xact.h.html#LN359"><span class='Ref_to_Proto'>ReleaseCurrentSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3041"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../backend/utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN3042"><span class='Ref_To_Local'>oldowner</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3068"></a>        <a href="../../include/utils/elog.h.html#LN328"><span class='Ref_to_Struct'>ErrorData</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>edata</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Save error info */ 
</span>        <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3041"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN3068"><span class='Ref_To_Local'>edata</span></a> <span class='Operator'>= </span><a href="../../include/utils/elog.h.html#LN363"><span class='Ref_to_Proto'>CopyErrorData</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN365"><span class='Ref_to_Proto'>FlushErrorState</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Abort the inner transaction */ 
</span>        <a href="../../include/access/xact.h.html#LN360"><span class='Ref_to_Proto'>RollbackAndReleaseCurrentSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3041"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../backend/utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN3042"><span class='Ref_To_Local'>oldowner</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Punt the error to Perl */ 
</span>        <a href="plperl_helpers.h.html#LN133"><span class='Ref_to_Func'>croak_cstr</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3068"><span class='Ref_To_Local'>edata</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/elog.h.html#LN342"><span class='Ref_to_Member'>message</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Can't get here, but keep compiler quiet */ 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="plperl.c.html#LN3035"><span class='Ref_To_Local'>ret_hv</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end plperl_spi_exec &raquo; </span> 
 
 
<span class='Keyword'>static </span>HV  <span class='Operator'>* 
</span><a name="LN3093"></a><span class='Declare_Function'>plperl_spi_execute_fetch_result</span><span class='Parentheses'>(</span><a href="../../include/executor/spi.h.html#LN21"><span class='Ref_to_Struct'>SPITupleTable</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tuptable</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a> <span class='Declare_Parameter'>processed</span><span class='Delimiter'>, 
</span><a name="LN3094"></a>                                <span class='Keyword'>int </span><span class='Declare_Parameter'>status</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3096"></a>    HV         <span class='Operator'>*</span><span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN3020"><span class='Ref_to_Func'>check_spi_usage_allowed</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN3096"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span>newHV<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN288"><span class='Ref_to_Proto'>hv_store_string</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3096"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><span class='String'>"status"</span><span class='Delimiter'>, 
</span>                    <a href="plperl_helpers.h.html#LN106"><span class='Ref_to_Func'>cstr2sv</span></a><span class='Parentheses'>(</span><a href="../../include/executor/spi.h.html#LN114"><span class='Ref_to_Proto'>SPI_result_code_string</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3094"><span class='Ref_to_Parameter'>status</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN288"><span class='Ref_to_Proto'>hv_store_string</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3096"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><span class='String'>"processed"</span><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="plperl.c.html#LN3093"><span class='Ref_to_Parameter'>processed</span></a> <span class='Operator'>&GT; </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a><span class='Parentheses'>) </span><a href="ppport.h.html#LN3461"><span class='Ref_to_Const'>UV_MAX</span></a><span class='Parentheses'>)</span> <span class='Operator'>? 
</span>                    newSVnv<span class='Parentheses'>((</span><a href="ppport.h.html#LN3753"><span class='Ref_to_Typedef'>NV</span></a><span class='Parentheses'>) </span><a href="plperl.c.html#LN3093"><span class='Ref_to_Parameter'>processed</span></a><span class='Parentheses'>)</span> <span class='Operator'>: 
</span>                    <a href="ppport.h.html#LN3595"><span class='Ref_to_Macro'>newSVuv</span></a><span class='Parentheses'>((</span>UV<span class='Parentheses'>) </span><a href="plperl.c.html#LN3093"><span class='Ref_to_Parameter'>processed</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3094"><span class='Ref_to_Parameter'>status</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="plperl.c.html#LN3093"><span class='Ref_to_Parameter'>tuptable</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3111"></a>        AV         <span class='Operator'>*</span><span class='Declare_Local'>rows</span><span class='Delimiter'>; 
</span><a name="LN3112"></a>        SV         <span class='Operator'>*</span><span class='Declare_Local'>row</span><span class='Delimiter'>; 
</span><a name="LN3113"></a>        <a href="../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a>      <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Prevent overflow in call to av_extend() */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3093"><span class='Ref_to_Parameter'>processed</span></a> <span class='Operator'>&GT; </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a><span class='Parentheses'>) </span><a href="plperl.h.html#LN92"><span class='Ref_to_Const'>AV_SIZE_MAX</span></a><span class='Parentheses'>)</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROGRAM_LIMIT_EXCEEDED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>            <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"query result has too many rows to fit in a Perl array"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="plperl.c.html#LN3111"><span class='Ref_To_Local'>rows</span></a> <span class='Operator'>= </span>newAV<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        av_extend<span class='Parentheses'>(</span><a href="plperl.c.html#LN3111"><span class='Ref_To_Local'>rows</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN3093"><span class='Ref_to_Parameter'>processed</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3113"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="plperl.c.html#LN3113"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="plperl.c.html#LN3093"><span class='Ref_to_Parameter'>processed</span></a><span class='Delimiter'>; </span><a href="plperl.c.html#LN3113"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="plperl.c.html#LN3112"><span class='Ref_To_Local'>row</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN265"><span class='Ref_to_Proto'>plperl_hash_from_tuple</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3093"><span class='Ref_to_Parameter'>tuptable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/spi.h.html#LN27"><span class='Ref_to_Member'>vals</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN3113"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="plperl.c.html#LN3093"><span class='Ref_to_Parameter'>tuptable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/spi.h.html#LN26"><span class='Ref_to_Member'>tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            av_push<span class='Parentheses'>(</span><a href="plperl.c.html#LN3111"><span class='Ref_To_Local'>rows</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN3112"><span class='Ref_To_Local'>row</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="plperl.c.html#LN288"><span class='Ref_to_Proto'>hv_store_string</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3096"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><span class='String'>"rows"</span><span class='Delimiter'>, 
</span>                        <a href="ppport.h.html#LN4455"><span class='Ref_to_Macro'>newRV_noinc</span></a><span class='Parentheses'>((</span>SV <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="plperl.c.html#LN3111"><span class='Ref_To_Local'>rows</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if status&GT;0&&tuptable &raquo; </span> 
 
    <a href="../../include/executor/spi.h.html#LN136"><span class='Ref_to_Proto'>SPI_freetuptable</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3093"><span class='Ref_to_Parameter'>tuptable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="plperl.c.html#LN3096"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end plperl_spi_execute_fetch_result &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Note: plperl_return_next is called both in Postgres and Perl contexts. 
 * We report any errors in Postgres fashion (via ereport).  If called in 
 * Perl context, it is SPI.xs's responsibility to catch the error and 
 * convert to a Perl error.  We assume (perhaps without adequate justification) 
 * that we need not abort the current transaction if the Perl code traps the 
 * error. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN3147"></a><span class='Declare_Function'>plperl_return_next</span><span class='Parentheses'>(</span>SV <span class='Operator'>*</span><span class='Declare_Parameter'>sv</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3149"></a>    <a href="plperl.c.html#LN105"><span class='Ref_to_Struct'>plperl_proc_desc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>prodesc</span><span class='Delimiter'>; 
</span><a name="LN3150"></a>    <a href="../../include/fmgr.h.html#LN37"><span class='Ref_to_Typedef'>FunctionCallInfo</span></a> <span class='Declare_Local'>fcinfo</span><span class='Delimiter'>; 
</span><a name="LN3151"></a>    <a href="../../include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rsi</span><span class='Delimiter'>; 
</span><a name="LN3152"></a>    <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>old_cxt</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plperl.c.html#LN3147"><span class='Ref_to_Parameter'>sv</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN3149"><span class='Ref_To_Local'>prodesc</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN178"><span class='Ref_to_Member'>prodesc</span></a><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN3150"><span class='Ref_To_Local'>fcinfo</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN179"><span class='Ref_to_Member'>fcinfo</span></a><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN3151"><span class='Ref_To_Local'>rsi</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="plperl.c.html#LN3150"><span class='Ref_To_Local'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/fmgr.h.html#LN80"><span class='Ref_to_Member'>resultinfo</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plperl.c.html#LN3149"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN119"><span class='Ref_to_Member'>fn_retisset</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot use return_next in a non-SETOF function"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN181"><span class='Ref_to_Member'>ret_tdesc</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3168"></a>        <a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN180"><span class='Ref_to_Member'>tuple_store</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * This is the first call to return_next in the current PL/Perl 
         * function call, so memoize some lookups 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3149"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN118"><span class='Ref_to_Member'>fn_retistuple</span></a><span class='Parentheses'>) 
</span>            <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../include/funcapi.h.html#LN157"><span class='Ref_to_Proto'>get_call_result_type</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3150"><span class='Ref_To_Local'>fcinfo</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN3168"><span class='Ref_To_Local'>tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="plperl.c.html#LN3168"><span class='Ref_To_Local'>tupdesc</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN3151"><span class='Ref_To_Local'>rsi</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN266"><span class='Ref_to_Member'>expectedDesc</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Make sure the tuple_store and ret_tdesc are sufficiently 
         * long-lived. 
         */ 
</span>        <a href="plperl.c.html#LN3152"><span class='Ref_To_Local'>old_cxt</span></a> <span class='Operator'>= </span><a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3151"><span class='Ref_To_Local'>rsi</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN265"><span class='Ref_to_Member'>econtext</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN201"><span class='Ref_to_Member'>ecxt_per_query_memory</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN181"><span class='Ref_to_Member'>ret_tdesc</span></a> <span class='Operator'>= </span><a href="../../include/access/tupdesc.h.html#LN88"><span class='Ref_to_Proto'>CreateTupleDescCopy</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3168"><span class='Ref_To_Local'>tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN180"><span class='Ref_to_Member'>tuple_store</span></a> <span class='Operator'>= 
</span>            <a href="../../include/utils/tuplestore.h.html#LN46"><span class='Ref_to_Proto'>tuplestore_begin_heap</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3151"><span class='Ref_To_Local'>rsi</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN267"><span class='Ref_to_Member'>allowedModes</span></a> <span class='Operator'>& </span><a href="../../include/nodes/execnodes.h.html#LN251"><span class='Ref_to_EnumConst'>SFRM_Materialize_Random</span></a><span class='Delimiter'>, 
</span>                                  <span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="../../backend/utils/init/globals.c.html#LN112"><span class='Ref_to_Global_Var'>work_mem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3152"><span class='Ref_To_Local'>old_cxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !current_call_data-&GT;r... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Producing the tuple we want to return requires making plenty of 
     * palloc() allocations that are not cleaned up. Since this function can 
     * be called many times before the current memory context is reset, we 
     * need to do those allocations in a temporary context. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN182"><span class='Ref_to_Member'>tmp_cxt</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN182"><span class='Ref_to_Member'>tmp_cxt</span></a> <span class='Operator'>= 
</span>            <a href="../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../../backend/utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>, 
</span>                                  <span class='String'>"PL/Perl return_next temporary cxt"</span><span class='Delimiter'>, 
</span>                                  <a href="../../include/utils/memutils.h.html#LN164"><span class='Ref_to_Const'>ALLOCSET_DEFAULT_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="plperl.c.html#LN3152"><span class='Ref_To_Local'>old_cxt</span></a> <span class='Operator'>= </span><a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN182"><span class='Ref_to_Member'>tmp_cxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3149"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN118"><span class='Ref_to_Member'>fn_retistuple</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3213"></a>        <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span>SvOK<span class='Parentheses'>(</span><a href="plperl.c.html#LN3147"><span class='Ref_to_Parameter'>sv</span></a><span class='Parentheses'>)</span> <span class='Operator'>&& </span>SvROK<span class='Parentheses'>(</span><a href="plperl.c.html#LN3147"><span class='Ref_to_Parameter'>sv</span></a><span class='Parentheses'>)</span> <span class='Operator'>&& </span>SvTYPE<span class='Parentheses'>(</span>SvRV<span class='Parentheses'>(</span><a href="plperl.c.html#LN3147"><span class='Ref_to_Parameter'>sv</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span>SVt_PVHV<span class='Parentheses'>))</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATATYPE_MISMATCH<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"SETOF-composite-returning PL/Perl function "</span> 
                            <span class='String'>"must call return_next with reference to hash"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="plperl.c.html#LN3213"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN1044"><span class='Ref_to_Func'>plperl_build_tuple_result</span></a><span class='Parentheses'>((</span>HV <span class='Operator'>*</span><span class='Parentheses'>) </span>SvRV<span class='Parentheses'>(</span><a href="plperl.c.html#LN3147"><span class='Ref_to_Parameter'>sv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                          <a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN181"><span class='Ref_to_Member'>ret_tdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/tuplestore.h.html#LN54"><span class='Ref_to_Proto'>tuplestore_puttuple</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN180"><span class='Ref_to_Member'>tuple_store</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN3213"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span><a name="LN3227"></a>        <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>ret</span><span class='Delimiter'>; 
</span><a name="LN3228"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>isNull</span><span class='Delimiter'>; 
</span> 
        <a href="plperl.c.html#LN3227"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN271"><span class='Ref_to_Proto'>plperl_sv_to_datum</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3147"><span class='Ref_to_Parameter'>sv</span></a><span class='Delimiter'>, 
</span>                                 <a href="plperl.c.html#LN3149"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN122"><span class='Ref_to_Member'>result_oid</span></a><span class='Delimiter'>, 
</span>                                 <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                                 <a href="plperl.c.html#LN3150"><span class='Ref_To_Local'>fcinfo</span></a><span class='Delimiter'>, 
</span>                                 <span class='Operator'>&</span><a href="plperl.c.html#LN3149"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN123"><span class='Ref_to_Member'>result_in_func</span></a><span class='Delimiter'>, 
</span>                                 <a href="plperl.c.html#LN3149"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN124"><span class='Ref_to_Member'>result_typioparam</span></a><span class='Delimiter'>, 
</span>                                 <span class='Operator'>&</span><a href="plperl.c.html#LN3228"><span class='Ref_To_Local'>isNull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/utils/tuplestore.h.html#LN55"><span class='Ref_to_Proto'>tuplestore_putvalues</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN180"><span class='Ref_to_Member'>tuple_store</span></a><span class='Delimiter'>, 
</span>                             <a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN181"><span class='Ref_to_Member'>ret_tdesc</span></a><span class='Delimiter'>, 
</span>                             <span class='Operator'>&</span><a href="plperl.c.html#LN3227"><span class='Ref_To_Local'>ret</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN3228"><span class='Ref_To_Local'>isNull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3152"><span class='Ref_To_Local'>old_cxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/utils/memutils.h.html#LN73"><span class='Ref_to_Proto'>MemoryContextReset</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN182"><span class='Ref_to_Member'>tmp_cxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end plperl_return_next &raquo; </span> 
 
 
SV <span class='Operator'>* 
</span><a name="LN3249"></a><span class='Declare_Function'>plperl_spi_query</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>query</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3251"></a>    SV         <span class='Operator'>*</span><span class='Declare_Local'>cursor</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Execute the query inside a sub-transaction, so we can cope with errors 
     * sanely 
     */ 
</span><a name="LN3257"></a>    <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span> <span class='Operator'>= </span><a href="../../backend/utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>; 
</span><a name="LN3258"></a>    <a href="../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Local'>oldowner</span> <span class='Operator'>= </span><a href="../../backend/utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN3020"><span class='Ref_to_Func'>check_spi_usage_allowed</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/xact.h.html#LN358"><span class='Ref_to_Proto'>BeginInternalSubTransaction</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Want to run inside function's memory context */ 
</span>    <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3257"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3268"></a>        <a href="../../include/executor/spi.h.html#LN33"><span class='Ref_to_Typedef'>SPIPlanPtr</span></a>  <span class='Declare_Local'>plan</span><span class='Delimiter'>; 
</span><a name="LN3269"></a>        <a href="../../include/utils/portal.h.html#LN111"><span class='Ref_to_Typedef'>Portal</span></a>      <span class='Declare_Local'>portal</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Make sure the query is validly encoded */ 
</span>        <a href="../../backend/parser/scan.l.html#LN546"><span class='Ref_to_Proto'>pg_verifymbstr</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3249"><span class='Ref_to_Parameter'>query</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="plperl.c.html#LN3249"><span class='Ref_to_Parameter'>query</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Create a cursor for the query */ 
</span>        <a href="plperl.c.html#LN3268"><span class='Ref_To_Local'>plan</span></a> <span class='Operator'>= </span><a href="../../include/executor/spi.h.html#LN99"><span class='Ref_to_Proto'>SPI_prepare</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3249"><span class='Ref_to_Parameter'>query</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3268"><span class='Ref_To_Local'>plan</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_prepare() failed:%s"</span><span class='Delimiter'>, 
</span>                 <a href="../../include/executor/spi.h.html#LN114"><span class='Ref_to_Proto'>SPI_result_code_string</span></a><span class='Parentheses'>(</span><a href="../../backend/executor/spi.c.html#LN41"><span class='Ref_to_Global_Var'>SPI_result</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="plperl.c.html#LN3269"><span class='Ref_To_Local'>portal</span></a> <span class='Operator'>= </span><a href="../../include/executor/spi.h.html#LN138"><span class='Ref_to_Proto'>SPI_cursor_open</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="plperl.c.html#LN3268"><span class='Ref_To_Local'>plan</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/executor/spi.h.html#LN108"><span class='Ref_to_Proto'>SPI_freeplan</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3268"><span class='Ref_To_Local'>plan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3269"><span class='Ref_To_Local'>portal</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_cursor_open() failed:%s"</span><span class='Delimiter'>, 
</span>                 <a href="../../include/executor/spi.h.html#LN114"><span class='Ref_to_Proto'>SPI_result_code_string</span></a><span class='Parentheses'>(</span><a href="../../backend/executor/spi.c.html#LN41"><span class='Ref_to_Global_Var'>SPI_result</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN3251"><span class='Ref_To_Local'>cursor</span></a> <span class='Operator'>= </span><a href="plperl_helpers.h.html#LN106"><span class='Ref_to_Func'>cstr2sv</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3269"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/portal.h.html#LN116"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Commit the inner transaction, return to outer xact context */ 
</span>        <a href="../../include/access/xact.h.html#LN359"><span class='Ref_to_Proto'>ReleaseCurrentSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3257"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../backend/utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN3258"><span class='Ref_To_Local'>oldowner</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3294"></a>        <a href="../../include/utils/elog.h.html#LN328"><span class='Ref_to_Struct'>ErrorData</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>edata</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Save error info */ 
</span>        <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3257"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN3294"><span class='Ref_To_Local'>edata</span></a> <span class='Operator'>= </span><a href="../../include/utils/elog.h.html#LN363"><span class='Ref_to_Proto'>CopyErrorData</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN365"><span class='Ref_to_Proto'>FlushErrorState</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Abort the inner transaction */ 
</span>        <a href="../../include/access/xact.h.html#LN360"><span class='Ref_to_Proto'>RollbackAndReleaseCurrentSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3257"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../backend/utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN3258"><span class='Ref_To_Local'>oldowner</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Punt the error to Perl */ 
</span>        <a href="plperl_helpers.h.html#LN133"><span class='Ref_to_Func'>croak_cstr</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3294"><span class='Ref_To_Local'>edata</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/elog.h.html#LN342"><span class='Ref_to_Member'>message</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Can't get here, but keep compiler quiet */ 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="plperl.c.html#LN3251"><span class='Ref_To_Local'>cursor</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end plperl_spi_query &raquo; </span> 
 
 
SV <span class='Operator'>* 
</span><a name="LN3319"></a><span class='Declare_Function'>plperl_spi_fetchrow</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>cursor</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3321"></a>    SV         <span class='Operator'>*</span><span class='Declare_Local'>row</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Execute the FETCH inside a sub-transaction, so we can cope with errors 
     * sanely 
     */ 
</span><a name="LN3327"></a>    <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span> <span class='Operator'>= </span><a href="../../backend/utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>; 
</span><a name="LN3328"></a>    <a href="../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Local'>oldowner</span> <span class='Operator'>= </span><a href="../../backend/utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN3020"><span class='Ref_to_Func'>check_spi_usage_allowed</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/xact.h.html#LN358"><span class='Ref_to_Proto'>BeginInternalSubTransaction</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Want to run inside function's memory context */ 
</span>    <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3327"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3338"></a>        <a href="../../include/utils/portal.h.html#LN111"><span class='Ref_to_Typedef'>Portal</span></a>      <span class='Declare_Local'>p</span> <span class='Operator'>= </span><a href="../../include/executor/spi.h.html#LN147"><span class='Ref_to_Proto'>SPI_cursor_find</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3319"><span class='Ref_to_Parameter'>cursor</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plperl.c.html#LN3338"><span class='Ref_To_Local'>p</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="plperl.c.html#LN3321"><span class='Ref_To_Local'>row</span></a> <span class='Operator'>= &</span><a href="ppport.h.html#LN4128"><span class='Ref_to_Const'>PL_sv_undef</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/executor/spi.h.html#LN148"><span class='Ref_to_Proto'>SPI_cursor_fetch</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3338"><span class='Ref_To_Local'>p</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../backend/executor/spi.c.html#LN38"><span class='Ref_to_Global_Var'>SPI_processed</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../include/executor/spi.h.html#LN152"><span class='Ref_to_Proto'>SPI_cursor_close</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3338"><span class='Ref_To_Local'>p</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="plperl.c.html#LN3321"><span class='Ref_To_Local'>row</span></a> <span class='Operator'>= &</span><a href="ppport.h.html#LN4128"><span class='Ref_to_Const'>PL_sv_undef</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <a href="plperl.c.html#LN3321"><span class='Ref_To_Local'>row</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN265"><span class='Ref_to_Proto'>plperl_hash_from_tuple</span></a><span class='Parentheses'>(</span><a href="../../backend/executor/spi.c.html#LN40"><span class='Ref_to_Global_Var'>SPI_tuptable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/spi.h.html#LN27"><span class='Ref_to_Member'>vals</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                                             <a href="../../backend/executor/spi.c.html#LN40"><span class='Ref_to_Global_Var'>SPI_tuptable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/spi.h.html#LN26"><span class='Ref_to_Member'>tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="../../include/executor/spi.h.html#LN136"><span class='Ref_to_Proto'>SPI_freetuptable</span></a><span class='Parentheses'>(</span><a href="../../backend/executor/spi.c.html#LN40"><span class='Ref_to_Global_Var'>SPI_tuptable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Commit the inner transaction, return to outer xact context */ 
</span>        <a href="../../include/access/xact.h.html#LN359"><span class='Ref_to_Proto'>ReleaseCurrentSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3327"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../backend/utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN3328"><span class='Ref_To_Local'>oldowner</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3367"></a>        <a href="../../include/utils/elog.h.html#LN328"><span class='Ref_to_Struct'>ErrorData</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>edata</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Save error info */ 
</span>        <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3327"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN3367"><span class='Ref_To_Local'>edata</span></a> <span class='Operator'>= </span><a href="../../include/utils/elog.h.html#LN363"><span class='Ref_to_Proto'>CopyErrorData</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN365"><span class='Ref_to_Proto'>FlushErrorState</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Abort the inner transaction */ 
</span>        <a href="../../include/access/xact.h.html#LN360"><span class='Ref_to_Proto'>RollbackAndReleaseCurrentSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3327"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../backend/utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN3328"><span class='Ref_To_Local'>oldowner</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Punt the error to Perl */ 
</span>        <a href="plperl_helpers.h.html#LN133"><span class='Ref_to_Func'>croak_cstr</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3367"><span class='Ref_To_Local'>edata</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/elog.h.html#LN342"><span class='Ref_to_Member'>message</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Can't get here, but keep compiler quiet */ 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="plperl.c.html#LN3321"><span class='Ref_To_Local'>row</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end plperl_spi_fetchrow &raquo; </span> 
 
<span class='Keyword'>void 
</span><a name="LN3391"></a><span class='Declare_Function'>plperl_spi_cursor_close</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>cursor</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3393"></a>    <a href="../../include/utils/portal.h.html#LN111"><span class='Ref_to_Typedef'>Portal</span></a>      <span class='Declare_Local'>p</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN3020"><span class='Ref_to_Func'>check_spi_usage_allowed</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN3393"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>= </span><a href="../../include/executor/spi.h.html#LN147"><span class='Ref_to_Proto'>SPI_cursor_find</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3391"><span class='Ref_to_Parameter'>cursor</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3393"><span class='Ref_To_Local'>p</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/executor/spi.h.html#LN152"><span class='Ref_to_Proto'>SPI_cursor_close</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3393"><span class='Ref_To_Local'>p</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
SV <span class='Operator'>* 
</span><a name="LN3404"></a><span class='Declare_Function'>plperl_spi_prepare</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>query</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>argc</span><span class='Delimiter'>, </span>SV <span class='Operator'>**</span><span class='Declare_Parameter'>argv</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3406"></a>    <span class='Keyword'>volatile </span><a href="../../include/executor/spi.h.html#LN33"><span class='Ref_to_Typedef'>SPIPlanPtr</span></a> <span class='Declare_Local'>plan</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN3407"></a>    <span class='Keyword'>volatile </span><a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>plan_cxt</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN3408"></a>    <a href="plperl.c.html#LN188"><span class='Ref_to_Struct'>plperl_query_desc</span></a> <span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Declare_Local'>qdesc</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN3409"></a>    <a href="plperl.c.html#LN201"><span class='Ref_to_Struct'>plperl_query_entry</span></a> <span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Declare_Local'>hash_entry</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN3410"></a>    <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span> <span class='Operator'>= </span><a href="../../backend/utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>; 
</span><a name="LN3411"></a>    <a href="../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Local'>oldowner</span> <span class='Operator'>= </span><a href="../../backend/utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Delimiter'>; 
</span><a name="LN3412"></a>    <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>work_cxt</span><span class='Delimiter'>; 
</span><a name="LN3413"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span><a name="LN3414"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN3020"><span class='Ref_to_Func'>check_spi_usage_allowed</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/xact.h.html#LN358"><span class='Ref_to_Proto'>BeginInternalSubTransaction</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3410"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * Allocate the new querydesc structure 
         * 
         * The qdesc struct, as well as all its subsidiary data, lives in its 
         * plan_cxt.  But note that the SPIPlan does not. 
         ************************************************************/ 
</span>        <a href="plperl.c.html#LN3407"><span class='Ref_To_Local'>plan_cxt</span></a> <span class='Operator'>= </span><a href="../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../../backend/utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, 
</span>                                         <span class='String'>"PL/Perl spi_prepare query"</span><span class='Delimiter'>, 
</span>                                         <a href="../../include/utils/memutils.h.html#LN174"><span class='Ref_to_Const'>ALLOCSET_SMALL_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3407"><span class='Ref_To_Local'>plan_cxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN3408"><span class='Ref_To_Local'>qdesc</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="plperl.c.html#LN188"><span class='Ref_to_Struct'>plperl_query_desc</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN188"><span class='Ref_to_Struct'>plperl_query_desc</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3408"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN190"><span class='Ref_to_Member'>qname</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN3408"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN190"><span class='Ref_to_Member'>qname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%p"</span><span class='Delimiter'>, </span><a href="plperl.c.html#LN3408"><span class='Ref_To_Local'>qdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN3408"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN191"><span class='Ref_to_Member'>plan_cxt</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN3407"><span class='Ref_To_Local'>plan_cxt</span></a><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN3408"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN193"><span class='Ref_to_Member'>nargs</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN3404"><span class='Ref_to_Parameter'>argc</span></a><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN3408"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN194"><span class='Ref_to_Member'>argtypes</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3404"><span class='Ref_to_Parameter'>argc</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN3408"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN195"><span class='Ref_to_Member'>arginfuncs</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3404"><span class='Ref_to_Parameter'>argc</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN3408"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN196"><span class='Ref_to_Member'>argtypioparams</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3404"><span class='Ref_to_Parameter'>argc</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3410"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * Do the following work in a short-lived context so that we don't 
         * leak a lot of memory in the PL/Perl function's SPI Proc context. 
         ************************************************************/ 
</span>        <a href="plperl.c.html#LN3412"><span class='Ref_To_Local'>work_cxt</span></a> <span class='Operator'>= </span><a href="../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../../backend/utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>, 
</span>                                         <span class='String'>"PL/Perl spi_prepare workspace"</span><span class='Delimiter'>, 
</span>                                         <a href="../../include/utils/memutils.h.html#LN164"><span class='Ref_to_Const'>ALLOCSET_DEFAULT_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3412"><span class='Ref_To_Local'>work_cxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * Resolve argument type names and then look them up by oid 
         * in the system cache, and remember the required information 
         * for input conversion. 
         ************************************************************/ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3414"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="plperl.c.html#LN3414"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="plperl.c.html#LN3404"><span class='Ref_to_Parameter'>argc</span></a><span class='Delimiter'>; </span><a href="plperl.c.html#LN3414"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN3460"></a>            <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>typId</span><span class='Delimiter'>, 
</span><a name="LN3461"></a>                        <span class='Declare_Local'>typInput</span><span class='Delimiter'>, 
</span><a name="LN3462"></a>                        <span class='Declare_Local'>typIOParam</span><span class='Delimiter'>; 
</span><a name="LN3463"></a>            <a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>typmod</span><span class='Delimiter'>; 
</span><a name="LN3464"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>typstr</span><span class='Delimiter'>; 
</span> 
            <a href="plperl.c.html#LN3464"><span class='Ref_To_Local'>typstr</span></a> <span class='Operator'>= </span><a href="plperl_helpers.h.html#LN49"><span class='Ref_to_Func'>sv2cstr</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3404"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN3414"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/parser/parse_type.h.html#LN50"><span class='Ref_to_Proto'>parseTypeString</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3464"><span class='Ref_To_Local'>typstr</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN3460"><span class='Ref_To_Local'>typId</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN3463"><span class='Ref_To_Local'>typmod</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3464"><span class='Ref_To_Local'>typstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../include/utils/lsyscache.h.html#LN161"><span class='Ref_to_Proto'>getTypeInputInfo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3460"><span class='Ref_To_Local'>typId</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN3461"><span class='Ref_To_Local'>typInput</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN3462"><span class='Ref_To_Local'>typIOParam</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="plperl.c.html#LN3408"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN194"><span class='Ref_to_Member'>argtypes</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN3414"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="plperl.c.html#LN3460"><span class='Ref_To_Local'>typId</span></a><span class='Delimiter'>; 
</span>            <a href="../../include/fmgr.h.html#LN99"><span class='Ref_to_Proto'>fmgr_info_cxt</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3461"><span class='Ref_To_Local'>typInput</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="plperl.c.html#LN3408"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN195"><span class='Ref_to_Member'>arginfuncs</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN3414"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="plperl.c.html#LN3407"><span class='Ref_To_Local'>plan_cxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="plperl.c.html#LN3408"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN196"><span class='Ref_to_Member'>argtypioparams</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN3414"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="plperl.c.html#LN3462"><span class='Ref_To_Local'>typIOParam</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Make sure the query is validly encoded */ 
</span>        <a href="../../backend/parser/scan.l.html#LN546"><span class='Ref_to_Proto'>pg_verifymbstr</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3404"><span class='Ref_to_Parameter'>query</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="plperl.c.html#LN3404"><span class='Ref_to_Parameter'>query</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * Prepare the plan and check for errors 
         ************************************************************/ 
</span>        <a href="plperl.c.html#LN3406"><span class='Ref_To_Local'>plan</span></a> <span class='Operator'>= </span><a href="../../include/executor/spi.h.html#LN99"><span class='Ref_to_Proto'>SPI_prepare</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3404"><span class='Ref_to_Parameter'>query</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN3404"><span class='Ref_to_Parameter'>argc</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN3408"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN194"><span class='Ref_to_Member'>argtypes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3406"><span class='Ref_To_Local'>plan</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_prepare() failed:%s"</span><span class='Delimiter'>, 
</span>                 <a href="../../include/executor/spi.h.html#LN114"><span class='Ref_to_Proto'>SPI_result_code_string</span></a><span class='Parentheses'>(</span><a href="../../backend/executor/spi.c.html#LN41"><span class='Ref_to_Global_Var'>SPI_result</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * Save the plan into permanent memory (right now it's in the 
         * SPI procCxt, which will go away at function end). 
         ************************************************************/ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/executor/spi.h.html#LN106"><span class='Ref_to_Proto'>SPI_keepplan</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3406"><span class='Ref_To_Local'>plan</span></a><span class='Parentheses'>))</span> 
            <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_keepplan() failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN3408"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN192"><span class='Ref_to_Member'>plan</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN3406"><span class='Ref_To_Local'>plan</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * Insert a hashtable entry for the plan. 
         ************************************************************/ 
</span>        <a href="plperl.c.html#LN3409"><span class='Ref_To_Local'>hash_entry</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN227"><span class='Ref_to_Global_Var'>plperl_active_interp</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN92"><span class='Ref_to_Member'>query_hash</span></a><span class='Delimiter'>, 
</span>                                 <a href="plperl.c.html#LN3408"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN190"><span class='Ref_to_Member'>qname</span></a><span class='Delimiter'>, 
</span>                                 <a href="../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plperl.c.html#LN3413"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN3409"><span class='Ref_To_Local'>hash_entry</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN204"><span class='Ref_to_Member'>query_data</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN3408"><span class='Ref_To_Local'>qdesc</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Get rid of workspace */ 
</span>        <a href="../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3412"><span class='Ref_To_Local'>work_cxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Commit the inner transaction, return to outer xact context */ 
</span>        <a href="../../include/access/xact.h.html#LN359"><span class='Ref_to_Proto'>ReleaseCurrentSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3410"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../backend/utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN3411"><span class='Ref_To_Local'>oldowner</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3515"></a>        <a href="../../include/utils/elog.h.html#LN328"><span class='Ref_to_Struct'>ErrorData</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>edata</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Save error info */ 
</span>        <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3410"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN3515"><span class='Ref_To_Local'>edata</span></a> <span class='Operator'>= </span><a href="../../include/utils/elog.h.html#LN363"><span class='Ref_to_Proto'>CopyErrorData</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN365"><span class='Ref_to_Proto'>FlushErrorState</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Drop anything we managed to allocate */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3409"><span class='Ref_To_Local'>hash_entry</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN227"><span class='Ref_to_Global_Var'>plperl_active_interp</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN92"><span class='Ref_to_Member'>query_hash</span></a><span class='Delimiter'>, 
</span>                        <a href="plperl.c.html#LN3408"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN190"><span class='Ref_to_Member'>qname</span></a><span class='Delimiter'>, 
</span>                        <a href="../../include/utils/hsearch.h.html#LN106"><span class='Ref_to_EnumConst'>HASH_REMOVE</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3407"><span class='Ref_To_Local'>plan_cxt</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3407"><span class='Ref_To_Local'>plan_cxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3406"><span class='Ref_To_Local'>plan</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/executor/spi.h.html#LN108"><span class='Ref_to_Proto'>SPI_freeplan</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3406"><span class='Ref_To_Local'>plan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Abort the inner transaction */ 
</span>        <a href="../../include/access/xact.h.html#LN360"><span class='Ref_to_Proto'>RollbackAndReleaseCurrentSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3410"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../backend/utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN3411"><span class='Ref_To_Local'>oldowner</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Punt the error to Perl */ 
</span>        <a href="plperl_helpers.h.html#LN133"><span class='Ref_to_Func'>croak_cstr</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3515"><span class='Ref_To_Local'>edata</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/elog.h.html#LN342"><span class='Ref_to_Member'>message</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Can't get here, but keep compiler quiet */ 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Return the query's hash key to the caller. 
     ************************************************************/ 
</span>    <span class='Control'>return</span> <a href="plperl_helpers.h.html#LN106"><span class='Ref_to_Func'>cstr2sv</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3408"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN190"><span class='Ref_to_Member'>qname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end plperl_spi_prepare &raquo; </span> 
 
HV <span class='Operator'>* 
</span><a name="LN3552"></a><span class='Declare_Function'>plperl_spi_exec_prepared</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>query</span><span class='Delimiter'>, </span>HV <span class='Operator'>*</span><span class='Declare_Parameter'>attr</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>argc</span><span class='Delimiter'>, </span>SV <span class='Operator'>**</span><span class='Declare_Parameter'>argv</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3554"></a>    HV         <span class='Operator'>*</span><span class='Declare_Local'>ret_hv</span><span class='Delimiter'>; 
</span><a name="LN3555"></a>    SV        <span class='Operator'>**</span><span class='Declare_Local'>sv</span><span class='Delimiter'>; 
</span><a name="LN3556"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN3557"></a>                <span class='Declare_Local'>limit</span><span class='Delimiter'>, 
</span><a name="LN3558"></a>                <span class='Declare_Local'>spi_rv</span><span class='Delimiter'>; 
</span><a name="LN3559"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>nulls</span><span class='Delimiter'>; 
</span><a name="LN3560"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>argvalues</span><span class='Delimiter'>; 
</span><a name="LN3561"></a>    <a href="plperl.c.html#LN188"><span class='Ref_to_Struct'>plperl_query_desc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>qdesc</span><span class='Delimiter'>; 
</span><a name="LN3562"></a>    <a href="plperl.c.html#LN201"><span class='Ref_to_Struct'>plperl_query_entry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>hash_entry</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Execute the query inside a sub-transaction, so we can cope with errors 
     * sanely 
     */ 
</span><a name="LN3568"></a>    <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span> <span class='Operator'>= </span><a href="../../backend/utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>; 
</span><a name="LN3569"></a>    <a href="../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Local'>oldowner</span> <span class='Operator'>= </span><a href="../../backend/utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN3020"><span class='Ref_to_Func'>check_spi_usage_allowed</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/xact.h.html#LN358"><span class='Ref_to_Proto'>BeginInternalSubTransaction</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Want to run inside function's memory context */ 
</span>    <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3568"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/************************************************************ 
         * Fetch the saved plan descriptor, see if it's o.k. 
         ************************************************************/ 
</span>        <a href="plperl.c.html#LN3562"><span class='Ref_To_Local'>hash_entry</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN227"><span class='Ref_to_Global_Var'>plperl_active_interp</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN92"><span class='Ref_to_Member'>query_hash</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN3552"><span class='Ref_to_Parameter'>query</span></a><span class='Delimiter'>, 
</span>                                 <a href="../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3562"><span class='Ref_To_Local'>hash_entry</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"spi_exec_prepared: Invalid prepared query passed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="plperl.c.html#LN3561"><span class='Ref_To_Local'>qdesc</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN3562"><span class='Ref_To_Local'>hash_entry</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN204"><span class='Ref_to_Member'>query_data</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3561"><span class='Ref_To_Local'>qdesc</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"spi_exec_prepared: plperl query_hash value vanished"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3561"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN193"><span class='Ref_to_Member'>nargs</span></a> <span class='Operator'>!= </span><a href="plperl.c.html#LN3552"><span class='Ref_to_Parameter'>argc</span></a><span class='Parentheses'>) 
</span>            <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"spi_exec_prepared: expected %d argument(s), %d passed"</span><span class='Delimiter'>, 
</span>                 <a href="plperl.c.html#LN3561"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN193"><span class='Ref_to_Member'>nargs</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN3552"><span class='Ref_to_Parameter'>argc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * Parse eventual attributes 
         ************************************************************/ 
</span>        <a href="plperl.c.html#LN3557"><span class='Ref_To_Local'>limit</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3552"><span class='Ref_to_Parameter'>attr</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="plperl.c.html#LN3555"><span class='Ref_To_Local'>sv</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN289"><span class='Ref_to_Proto'>hv_fetch_string</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3552"><span class='Ref_to_Parameter'>attr</span></a><span class='Delimiter'>, </span><span class='String'>"limit"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3555"><span class='Ref_To_Local'>sv</span></a> <span class='Operator'>&& *</span><a href="plperl.c.html#LN3555"><span class='Ref_To_Local'>sv</span></a> <span class='Operator'>&& </span>SvIOK<span class='Parentheses'>(</span><span class='Operator'>*</span><a href="plperl.c.html#LN3555"><span class='Ref_To_Local'>sv</span></a><span class='Parentheses'>))</span> 
                <a href="plperl.c.html#LN3557"><span class='Ref_To_Local'>limit</span></a> <span class='Operator'>= </span>SvIV<span class='Parentheses'>(</span><span class='Operator'>*</span><a href="plperl.c.html#LN3555"><span class='Ref_To_Local'>sv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Comment_Multi_Line'>/************************************************************ 
         * Set up arguments 
         ************************************************************/ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3552"><span class='Ref_to_Parameter'>argc</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="plperl.c.html#LN3559"><span class='Ref_To_Local'>nulls</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3552"><span class='Ref_to_Parameter'>argc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="plperl.c.html#LN3560"><span class='Ref_To_Local'>argvalues</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3552"><span class='Ref_to_Parameter'>argc</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="plperl.c.html#LN3559"><span class='Ref_To_Local'>nulls</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <a href="plperl.c.html#LN3560"><span class='Ref_To_Local'>argvalues</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3556"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="plperl.c.html#LN3556"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="plperl.c.html#LN3552"><span class='Ref_to_Parameter'>argc</span></a><span class='Delimiter'>; </span><a href="plperl.c.html#LN3556"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN3621"></a>            <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull</span><span class='Delimiter'>; 
</span> 
            <a href="plperl.c.html#LN3560"><span class='Ref_To_Local'>argvalues</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN3556"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="plperl.c.html#LN271"><span class='Ref_to_Proto'>plperl_sv_to_datum</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3552"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN3556"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                                              <a href="plperl.c.html#LN3561"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN194"><span class='Ref_to_Member'>argtypes</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN3556"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                                              <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                                              <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                              <span class='Operator'>&</span><a href="plperl.c.html#LN3561"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN195"><span class='Ref_to_Member'>arginfuncs</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN3556"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                                              <a href="plperl.c.html#LN3561"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN196"><span class='Ref_to_Member'>argtypioparams</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN3556"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                                              <span class='Operator'>&</span><a href="plperl.c.html#LN3621"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="plperl.c.html#LN3559"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN3556"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="plperl.c.html#LN3621"><span class='Ref_To_Local'>isnull</span></a> <span class='Operator'>? </span><span class='String'>'n'</span> <span class='Operator'>: </span><span class='String'>' '</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * go 
         ************************************************************/ 
</span>        <a href="plperl.c.html#LN3558"><span class='Ref_To_Local'>spi_rv</span></a> <span class='Operator'>= </span><a href="../../include/executor/spi.h.html#LN82"><span class='Ref_to_Proto'>SPI_execute_plan</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3561"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN192"><span class='Ref_to_Member'>plan</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN3560"><span class='Ref_To_Local'>argvalues</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN3559"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>, 
</span>                             <a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN178"><span class='Ref_to_Member'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN114"><span class='Ref_to_Member'>fn_readonly</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN3557"><span class='Ref_To_Local'>limit</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN3554"><span class='Ref_To_Local'>ret_hv</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN286"><span class='Ref_to_Proto'>plperl_spi_execute_fetch_result</span></a><span class='Parentheses'>(</span><a href="../../backend/executor/spi.c.html#LN40"><span class='Ref_to_Global_Var'>SPI_tuptable</span></a><span class='Delimiter'>, </span><a href="../../backend/executor/spi.c.html#LN38"><span class='Ref_to_Global_Var'>SPI_processed</span></a><span class='Delimiter'>, 
</span>                                                 <a href="plperl.c.html#LN3558"><span class='Ref_To_Local'>spi_rv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3552"><span class='Ref_to_Parameter'>argc</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3560"><span class='Ref_To_Local'>argvalues</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3559"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Commit the inner transaction, return to outer xact context */ 
</span>        <a href="../../include/access/xact.h.html#LN359"><span class='Ref_to_Proto'>ReleaseCurrentSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3568"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../backend/utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN3569"><span class='Ref_To_Local'>oldowner</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3653"></a>        <a href="../../include/utils/elog.h.html#LN328"><span class='Ref_to_Struct'>ErrorData</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>edata</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Save error info */ 
</span>        <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3568"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN3653"><span class='Ref_To_Local'>edata</span></a> <span class='Operator'>= </span><a href="../../include/utils/elog.h.html#LN363"><span class='Ref_to_Proto'>CopyErrorData</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN365"><span class='Ref_to_Proto'>FlushErrorState</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Abort the inner transaction */ 
</span>        <a href="../../include/access/xact.h.html#LN360"><span class='Ref_to_Proto'>RollbackAndReleaseCurrentSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3568"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../backend/utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN3569"><span class='Ref_To_Local'>oldowner</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Punt the error to Perl */ 
</span>        <a href="plperl_helpers.h.html#LN133"><span class='Ref_to_Func'>croak_cstr</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3653"><span class='Ref_To_Local'>edata</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/elog.h.html#LN342"><span class='Ref_to_Member'>message</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Can't get here, but keep compiler quiet */ 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="plperl.c.html#LN3554"><span class='Ref_To_Local'>ret_hv</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end plperl_spi_exec_prepared &raquo; </span> 
 
SV <span class='Operator'>* 
</span><a name="LN3677"></a><span class='Declare_Function'>plperl_spi_query_prepared</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>query</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>argc</span><span class='Delimiter'>, </span>SV <span class='Operator'>**</span><span class='Declare_Parameter'>argv</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3679"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN3680"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>nulls</span><span class='Delimiter'>; 
</span><a name="LN3681"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>argvalues</span><span class='Delimiter'>; 
</span><a name="LN3682"></a>    <a href="plperl.c.html#LN188"><span class='Ref_to_Struct'>plperl_query_desc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>qdesc</span><span class='Delimiter'>; 
</span><a name="LN3683"></a>    <a href="plperl.c.html#LN201"><span class='Ref_to_Struct'>plperl_query_entry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>hash_entry</span><span class='Delimiter'>; 
</span><a name="LN3684"></a>    SV         <span class='Operator'>*</span><span class='Declare_Local'>cursor</span><span class='Delimiter'>; 
</span><a name="LN3685"></a>    <a href="../../include/utils/portal.h.html#LN111"><span class='Ref_to_Typedef'>Portal</span></a>      <span class='Declare_Local'>portal</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Execute the query inside a sub-transaction, so we can cope with errors 
     * sanely 
     */ 
</span><a name="LN3691"></a>    <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span> <span class='Operator'>= </span><a href="../../backend/utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>; 
</span><a name="LN3692"></a>    <a href="../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Local'>oldowner</span> <span class='Operator'>= </span><a href="../../backend/utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN3020"><span class='Ref_to_Func'>check_spi_usage_allowed</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/xact.h.html#LN358"><span class='Ref_to_Proto'>BeginInternalSubTransaction</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Want to run inside function's memory context */ 
</span>    <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3691"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/************************************************************ 
         * Fetch the saved plan descriptor, see if it's o.k. 
         ************************************************************/ 
</span>        <a href="plperl.c.html#LN3683"><span class='Ref_To_Local'>hash_entry</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN227"><span class='Ref_to_Global_Var'>plperl_active_interp</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN92"><span class='Ref_to_Member'>query_hash</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN3677"><span class='Ref_to_Parameter'>query</span></a><span class='Delimiter'>, 
</span>                                 <a href="../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3683"><span class='Ref_To_Local'>hash_entry</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"spi_query_prepared: Invalid prepared query passed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="plperl.c.html#LN3682"><span class='Ref_To_Local'>qdesc</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN3683"><span class='Ref_To_Local'>hash_entry</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN204"><span class='Ref_to_Member'>query_data</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3682"><span class='Ref_To_Local'>qdesc</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"spi_query_prepared: plperl query_hash value vanished"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3682"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN193"><span class='Ref_to_Member'>nargs</span></a> <span class='Operator'>!= </span><a href="plperl.c.html#LN3677"><span class='Ref_to_Parameter'>argc</span></a><span class='Parentheses'>) 
</span>            <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"spi_query_prepared: expected %d argument(s), %d passed"</span><span class='Delimiter'>, 
</span>                 <a href="plperl.c.html#LN3682"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN193"><span class='Ref_to_Member'>nargs</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN3677"><span class='Ref_to_Parameter'>argc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * Set up arguments 
         ************************************************************/ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3677"><span class='Ref_to_Parameter'>argc</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="plperl.c.html#LN3680"><span class='Ref_To_Local'>nulls</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3677"><span class='Ref_to_Parameter'>argc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="plperl.c.html#LN3681"><span class='Ref_To_Local'>argvalues</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3677"><span class='Ref_to_Parameter'>argc</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="plperl.c.html#LN3680"><span class='Ref_To_Local'>nulls</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <a href="plperl.c.html#LN3681"><span class='Ref_To_Local'>argvalues</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3679"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="plperl.c.html#LN3679"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="plperl.c.html#LN3677"><span class='Ref_to_Parameter'>argc</span></a><span class='Delimiter'>; </span><a href="plperl.c.html#LN3679"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN3734"></a>            <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull</span><span class='Delimiter'>; 
</span> 
            <a href="plperl.c.html#LN3681"><span class='Ref_To_Local'>argvalues</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN3679"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="plperl.c.html#LN271"><span class='Ref_to_Proto'>plperl_sv_to_datum</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3677"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN3679"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                                              <a href="plperl.c.html#LN3682"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN194"><span class='Ref_to_Member'>argtypes</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN3679"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                                              <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                                              <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                              <span class='Operator'>&</span><a href="plperl.c.html#LN3682"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN195"><span class='Ref_to_Member'>arginfuncs</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN3679"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                                              <a href="plperl.c.html#LN3682"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN196"><span class='Ref_to_Member'>argtypioparams</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN3679"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                                              <span class='Operator'>&</span><a href="plperl.c.html#LN3734"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="plperl.c.html#LN3680"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>[</span><a href="plperl.c.html#LN3679"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="plperl.c.html#LN3734"><span class='Ref_To_Local'>isnull</span></a> <span class='Operator'>? </span><span class='String'>'n'</span> <span class='Operator'>: </span><span class='String'>' '</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * go 
         ************************************************************/ 
</span>        <a href="plperl.c.html#LN3685"><span class='Ref_To_Local'>portal</span></a> <span class='Operator'>= </span><a href="../../include/executor/spi.h.html#LN138"><span class='Ref_to_Proto'>SPI_cursor_open</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="plperl.c.html#LN3682"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN192"><span class='Ref_to_Member'>plan</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN3681"><span class='Ref_To_Local'>argvalues</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN3680"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>, 
</span>                                 <a href="plperl.c.html#LN243"><span class='Ref_to_Global_Var'>current_call_data</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN178"><span class='Ref_to_Member'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN114"><span class='Ref_to_Member'>fn_readonly</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3677"><span class='Ref_to_Parameter'>argc</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3681"><span class='Ref_To_Local'>argvalues</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3680"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3685"><span class='Ref_To_Local'>portal</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_cursor_open() failed:%s"</span><span class='Delimiter'>, 
</span>                 <a href="../../include/executor/spi.h.html#LN114"><span class='Ref_to_Proto'>SPI_result_code_string</span></a><span class='Parentheses'>(</span><a href="../../backend/executor/spi.c.html#LN41"><span class='Ref_to_Global_Var'>SPI_result</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="plperl.c.html#LN3684"><span class='Ref_To_Local'>cursor</span></a> <span class='Operator'>= </span><a href="plperl_helpers.h.html#LN106"><span class='Ref_to_Func'>cstr2sv</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3685"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/portal.h.html#LN116"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Commit the inner transaction, return to outer xact context */ 
</span>        <a href="../../include/access/xact.h.html#LN359"><span class='Ref_to_Proto'>ReleaseCurrentSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3691"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../backend/utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN3692"><span class='Ref_To_Local'>oldowner</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3769"></a>        <a href="../../include/utils/elog.h.html#LN328"><span class='Ref_to_Struct'>ErrorData</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>edata</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Save error info */ 
</span>        <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3691"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="plperl.c.html#LN3769"><span class='Ref_To_Local'>edata</span></a> <span class='Operator'>= </span><a href="../../include/utils/elog.h.html#LN363"><span class='Ref_to_Proto'>CopyErrorData</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN365"><span class='Ref_to_Proto'>FlushErrorState</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Abort the inner transaction */ 
</span>        <a href="../../include/access/xact.h.html#LN360"><span class='Ref_to_Proto'>RollbackAndReleaseCurrentSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3691"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../backend/utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN3692"><span class='Ref_To_Local'>oldowner</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Punt the error to Perl */ 
</span>        <a href="plperl_helpers.h.html#LN133"><span class='Ref_to_Func'>croak_cstr</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3769"><span class='Ref_To_Local'>edata</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/elog.h.html#LN342"><span class='Ref_to_Member'>message</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Can't get here, but keep compiler quiet */ 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="plperl.c.html#LN3684"><span class='Ref_To_Local'>cursor</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end plperl_spi_query_prepared &raquo; </span> 
 
<span class='Keyword'>void 
</span><a name="LN3793"></a><span class='Declare_Function'>plperl_spi_freeplan</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>query</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3795"></a>    <a href="../../include/executor/spi.h.html#LN33"><span class='Ref_to_Typedef'>SPIPlanPtr</span></a>  <span class='Declare_Local'>plan</span><span class='Delimiter'>; 
</span><a name="LN3796"></a>    <a href="plperl.c.html#LN188"><span class='Ref_to_Struct'>plperl_query_desc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>qdesc</span><span class='Delimiter'>; 
</span><a name="LN3797"></a>    <a href="plperl.c.html#LN201"><span class='Ref_to_Struct'>plperl_query_entry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>hash_entry</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN3020"><span class='Ref_to_Func'>check_spi_usage_allowed</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN3797"><span class='Ref_To_Local'>hash_entry</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN227"><span class='Ref_to_Global_Var'>plperl_active_interp</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN92"><span class='Ref_to_Member'>query_hash</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN3793"><span class='Ref_to_Parameter'>query</span></a><span class='Delimiter'>, 
</span>                             <a href="../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3797"><span class='Ref_To_Local'>hash_entry</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"spi_freeplan: Invalid prepared query passed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN3796"><span class='Ref_To_Local'>qdesc</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN3797"><span class='Ref_To_Local'>hash_entry</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN204"><span class='Ref_to_Member'>query_data</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3796"><span class='Ref_To_Local'>qdesc</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"spi_freeplan: plperl query_hash value vanished"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN3795"><span class='Ref_To_Local'>plan</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN3796"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN192"><span class='Ref_to_Member'>plan</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * free all memory before SPI_freeplan, so if it dies, nothing will be 
     * left over 
     */ 
</span>    <a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN227"><span class='Ref_to_Global_Var'>plperl_active_interp</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN92"><span class='Ref_to_Member'>query_hash</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN3793"><span class='Ref_to_Parameter'>query</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/utils/hsearch.h.html#LN106"><span class='Ref_to_EnumConst'>HASH_REMOVE</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3796"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="plperl.c.html#LN191"><span class='Ref_to_Member'>plan_cxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/executor/spi.h.html#LN108"><span class='Ref_to_Proto'>SPI_freeplan</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3795"><span class='Ref_To_Local'>plan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end plperl_spi_freeplan &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Store an SV into a hash table under a key that is a string assumed to be 
 * in the current database's encoding. 
 */ 
</span><span class='Keyword'>static </span>SV <span class='Operator'>** 
</span><a name="LN3828"></a><span class='Declare_Function'>hv_store_string</span><span class='Parentheses'>(</span>HV <span class='Operator'>*</span><span class='Declare_Parameter'>hv</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>key</span><span class='Delimiter'>, </span>SV <span class='Operator'>*</span><span class='Declare_Parameter'>val</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3830"></a>    <a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>hlen</span><span class='Delimiter'>; 
</span><a name="LN3831"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>hkey</span><span class='Delimiter'>; 
</span><a name="LN3832"></a>    SV        <span class='Operator'>**</span><span class='Declare_Local'>ret</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN3831"><span class='Ref_To_Local'>hkey</span></a> <span class='Operator'>= </span><a href="../../include/mb/pg_wchar.h.html#LN567"><span class='Ref_to_Proto'>pg_server_to_any</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3828"><span class='Ref_to_Parameter'>key</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="plperl.c.html#LN3828"><span class='Ref_to_Parameter'>key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../fe_utils/mbprint.c.html#LN42"><span class='Ref_to_Const'>PG_UTF8</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * hv_store() recognizes a negative klen parameter as meaning a UTF-8 
     * encoded key. 
     */ 
</span>    <a href="plperl.c.html#LN3830"><span class='Ref_To_Local'>hlen</span></a> <span class='Operator'>= -</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span>strlen<span class='Parentheses'>(</span><a href="plperl.c.html#LN3831"><span class='Ref_To_Local'>hkey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN3832"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span>hv_store<span class='Parentheses'>(</span><a href="plperl.c.html#LN3828"><span class='Ref_to_Parameter'>hv</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN3831"><span class='Ref_To_Local'>hkey</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN3830"><span class='Ref_To_Local'>hlen</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN3828"><span class='Ref_to_Parameter'>val</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3831"><span class='Ref_To_Local'>hkey</span></a> <span class='Operator'>!= </span><a href="plperl.c.html#LN3828"><span class='Ref_to_Parameter'>key</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3831"><span class='Ref_To_Local'>hkey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="plperl.c.html#LN3832"><span class='Ref_To_Local'>ret</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end hv_store_string &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Fetch an SV from a hash table under a key that is a string assumed to be 
 * in the current database's encoding. 
 */ 
</span><span class='Keyword'>static </span>SV <span class='Operator'>** 
</span><a name="LN3854"></a><span class='Declare_Function'>hv_fetch_string</span><span class='Parentheses'>(</span>HV <span class='Operator'>*</span><span class='Declare_Parameter'>hv</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>key</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3856"></a>    <a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>hlen</span><span class='Delimiter'>; 
</span><a name="LN3857"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>hkey</span><span class='Delimiter'>; 
</span><a name="LN3858"></a>    SV        <span class='Operator'>**</span><span class='Declare_Local'>ret</span><span class='Delimiter'>; 
</span> 
    <a href="plperl.c.html#LN3857"><span class='Ref_To_Local'>hkey</span></a> <span class='Operator'>= </span><a href="../../include/mb/pg_wchar.h.html#LN567"><span class='Ref_to_Proto'>pg_server_to_any</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3854"><span class='Ref_to_Parameter'>key</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="plperl.c.html#LN3854"><span class='Ref_to_Parameter'>key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../fe_utils/mbprint.c.html#LN42"><span class='Ref_to_Const'>PG_UTF8</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* See notes in hv_store_string */ 
</span>    <a href="plperl.c.html#LN3856"><span class='Ref_To_Local'>hlen</span></a> <span class='Operator'>= -</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span>strlen<span class='Parentheses'>(</span><a href="plperl.c.html#LN3857"><span class='Ref_To_Local'>hkey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plperl.c.html#LN3858"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span>hv_fetch<span class='Parentheses'>(</span><a href="plperl.c.html#LN3854"><span class='Ref_to_Parameter'>hv</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN3857"><span class='Ref_To_Local'>hkey</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN3856"><span class='Ref_To_Local'>hlen</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3857"><span class='Ref_To_Local'>hkey</span></a> <span class='Operator'>!= </span><a href="plperl.c.html#LN3854"><span class='Ref_to_Parameter'>key</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3857"><span class='Ref_To_Local'>hkey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="plperl.c.html#LN3858"><span class='Ref_To_Local'>ret</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Provide function name for PL/Perl execution errors 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN3876"></a><span class='Declare_Function'>plperl_exec_callback</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3878"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>procname</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="plperl.c.html#LN3876"><span class='Ref_to_Parameter'>arg</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3878"><span class='Ref_To_Local'>procname</span></a><span class='Parentheses'>) 
</span>        errcontext<span class='Parentheses'>(</span><span class='String'>"PL/Perl function \"%s\""</span><span class='Delimiter'>, </span><a href="plperl.c.html#LN3878"><span class='Ref_To_Local'>procname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Provide function name for PL/Perl compilation errors 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN3888"></a><span class='Declare_Function'>plperl_compile_callback</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3890"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>procname</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="plperl.c.html#LN3888"><span class='Ref_to_Parameter'>arg</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3890"><span class='Ref_To_Local'>procname</span></a><span class='Parentheses'>) 
</span>        errcontext<span class='Parentheses'>(</span><span class='String'>"compilation of PL/Perl function \"%s\""</span><span class='Delimiter'>, </span><a href="plperl.c.html#LN3890"><span class='Ref_To_Local'>procname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Provide error context for the inline handler 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN3900"></a><span class='Declare_Function'>plperl_inline_callback</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    errcontext<span class='Parentheses'>(</span><span class='String'>"PL/Perl anonymous code block"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Perl's own setlocale(), copied from POSIX.xs 
 * (needed because of the calls to new_*()) 
 */ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN3912"></a><span class='Declare_Function'>setlocale_perl</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>category</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>locale</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3914"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>RETVAL</span> <span class='Operator'>= </span><a href="../../include/port.h.html#LN201"><span class='Ref_to_Macro'>setlocale</span></a><span class='Parentheses'>(</span><a href="plperl.c.html#LN3912"><span class='Ref_to_Parameter'>category</span></a><span class='Delimiter'>, </span><a href="plperl.c.html#LN3912"><span class='Ref_to_Parameter'>locale</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3914"><span class='Ref_To_Local'>RETVAL</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> USE_LOCALE_CTYPE 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3912"><span class='Ref_to_Parameter'>category</span></a> <span class='Operator'>== </span>LC_CTYPE 
<span class='Directive'>#ifdef</span> LC_ALL 
            <span class='Operator'>|| </span><a href="plperl.c.html#LN3912"><span class='Ref_to_Parameter'>category</span></a> <span class='Operator'>== </span>LC_ALL 
<span class='Directive'>#endif</span> 
            <span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN3925"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>newctype</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> LC_ALL 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3912"><span class='Ref_to_Parameter'>category</span></a> <span class='Operator'>== </span>LC_ALL<span class='Parentheses'>) 
</span>                <a href="plperl.c.html#LN3925"><span class='Ref_To_Local'>newctype</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN201"><span class='Ref_to_Macro'>setlocale</span></a><span class='Parentheses'>(</span>LC_CTYPE<span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
<span class='Directive'>#endif</span> 
                <a href="plperl.c.html#LN3925"><span class='Ref_To_Local'>newctype</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN3914"><span class='Ref_To_Local'>RETVAL</span></a><span class='Delimiter'>; 
</span>            new_ctype<span class='Parentheses'>(</span><a href="plperl.c.html#LN3925"><span class='Ref_To_Local'>newctype</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* USE_LOCALE_CTYPE */ 
</span><span class='Directive'>#ifdef</span> USE_LOCALE_COLLATE 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3912"><span class='Ref_to_Parameter'>category</span></a> <span class='Operator'>== </span>LC_COLLATE 
<span class='Directive'>#ifdef</span> LC_ALL 
            <span class='Operator'>|| </span><a href="plperl.c.html#LN3912"><span class='Ref_to_Parameter'>category</span></a> <span class='Operator'>== </span>LC_ALL 
<span class='Directive'>#endif</span> 
            <span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN3943"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>newcoll</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> LC_ALL 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3912"><span class='Ref_to_Parameter'>category</span></a> <span class='Operator'>== </span>LC_ALL<span class='Parentheses'>) 
</span>                <a href="plperl.c.html#LN3943"><span class='Ref_To_Local'>newcoll</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN201"><span class='Ref_to_Macro'>setlocale</span></a><span class='Parentheses'>(</span>LC_COLLATE<span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
<span class='Directive'>#endif</span> 
                <a href="plperl.c.html#LN3943"><span class='Ref_To_Local'>newcoll</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN3914"><span class='Ref_To_Local'>RETVAL</span></a><span class='Delimiter'>; 
</span>            new_collate<span class='Parentheses'>(</span><a href="plperl.c.html#LN3943"><span class='Ref_To_Local'>newcoll</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* USE_LOCALE_COLLATE */ 
</span> 
<span class='Directive'>#ifdef</span> USE_LOCALE_NUMERIC 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3912"><span class='Ref_to_Parameter'>category</span></a> <span class='Operator'>== </span>LC_NUMERIC 
<span class='Directive'>#ifdef</span> LC_ALL 
            <span class='Operator'>|| </span><a href="plperl.c.html#LN3912"><span class='Ref_to_Parameter'>category</span></a> <span class='Operator'>== </span>LC_ALL 
<span class='Directive'>#endif</span> 
            <span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN3962"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>newnum</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> LC_ALL 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plperl.c.html#LN3912"><span class='Ref_to_Parameter'>category</span></a> <span class='Operator'>== </span>LC_ALL<span class='Parentheses'>) 
</span>                <a href="plperl.c.html#LN3962"><span class='Ref_To_Local'>newnum</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN201"><span class='Ref_to_Macro'>setlocale</span></a><span class='Parentheses'>(</span>LC_NUMERIC<span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
<span class='Directive'>#endif</span> 
                <a href="plperl.c.html#LN3962"><span class='Ref_To_Local'>newnum</span></a> <span class='Operator'>= </span><a href="plperl.c.html#LN3914"><span class='Ref_To_Local'>RETVAL</span></a><span class='Delimiter'>; 
</span>            new_numeric<span class='Parentheses'>(</span><a href="plperl.c.html#LN3962"><span class='Ref_To_Local'>newnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* USE_LOCALE_NUMERIC */ 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if RETVAL &raquo; </span> 
 
    <span class='Control'>return</span> <a href="plperl.c.html#LN3914"><span class='Ref_To_Local'>RETVAL</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end setlocale_perl &raquo; </span> 
 
<span class='Directive'>#endif</span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>