<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\pl\plperl\plperl_opmask.pl</title>
<LINK REL=StyleSheet HREF="../../../Perl_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\pl\plperl\plperl_opmask.pl</b></p></td>
<td align='right'>
Wed Jun 14 08:26:12 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
</span><span class='Operator'>#!</span>perl <span class='Operator'>-</span>w 
 
<span class='Control'>use</span> strict<span class='Delimiter'>; 
</span><span class='Control'>use</span> warnings<span class='Delimiter'>; 
</span> 
<span class='Control'>use</span> Opcode <span class='Keyword'>qw</span><span class='String'>(opset opset_to_ops opdesc)</span><span class='Delimiter'>; 
</span> 
<span class='Keyword'>my </span>$plperl_opmask_h <span class='Operator'>= </span><span class='Keyword'>shift 
</span>  or <span class='Control'>die</span> <span class='String'>"Usage: $0 &LT;output_filename.h&GT;\n"</span><span class='Delimiter'>; 
</span> 
<span class='Keyword'>my </span>$plperl_opmask_tmp <span class='Operator'>= </span>$plperl_opmask_h <span class='Operator'>. </span><span class='String'>"tmp"</span><span class='Delimiter'>; 
</span>END <span class='Delimiter'>{ </span><span class='Keyword'>unlink </span>$plperl_opmask_tmp <span class='Delimiter'>} 
</span> 
<span class='Keyword'>open my </span>$fh<span class='Delimiter'>, </span><span class='String'>"&GT;"</span><span class='Delimiter'>, </span><span class='String'>"$plperl_opmask_tmp"</span> 
  or <span class='Control'>die</span> <span class='String'>"Could not write to $plperl_opmask_tmp: $!"</span><span class='Delimiter'>; 
</span> 
<span class='Keyword'>printf </span>$fh <span class='String'>"#define PLPERL_SET_OPMASK(opmask) \\\n"</span><span class='Delimiter'>; 
</span><span class='Keyword'>printf </span>$fh <span class='String'>"  memset(opmask, 1, MAXO);\t/* disable all */ \\\n"</span><span class='Delimiter'>; 
</span><span class='Keyword'>printf </span>$fh <span class='String'>"  /* then allow some... */                       \\\n"</span><span class='Delimiter'>; 
</span> 
<span class='Keyword'>my </span>@allowed_ops <span class='Operator'>= </span><span class='Parentheses'>( 
</span> 
    <span class='Comment_Single_Line'># basic set of opcodes 
</span>    <span class='Keyword'>qw</span><span class='String'>[:default :base_math !:base_io sort time]</span><span class='Delimiter'>, 
</span> 
    <span class='Comment_Single_Line'># require is safe because we redirect the opcode 
</span>    <span class='Comment_Single_Line'># entereval is safe as the opmask is now permanently set 
</span>    <span class='Comment_Single_Line'># caller is safe because the entire interpreter is locked down 
</span>    <span class='Keyword'>qw</span><span class='String'>[require entereval caller]</span><span class='Delimiter'>, 
</span> 
    <span class='Comment_Single_Line'># These are needed for utf8_heavy.pl: 
</span>    <span class='Comment_Single_Line'># dofile is safe because we redirect the opcode like require above 
</span>    <span class='Comment_Single_Line'># print is safe because the only writable filehandles are STDOUT & STDERR 
</span>    <span class='Comment_Single_Line'># prtf (printf) is safe as it's the same as print + sprintf 
</span>    <span class='Keyword'>qw</span><span class='String'>[dofile print prtf]</span><span class='Delimiter'>, 
</span> 
    <span class='Comment_Single_Line'># Disallow these opcodes that are in the :base_orig optag 
</span>    <span class='Comment_Single_Line'># (included in :default) but aren't considered sufficiently safe 
</span>    <span class='Keyword'>qw</span><span class='String'>[!dbmopen !setpgrp !setpriority]</span><span class='Delimiter'>, 
</span> 
   <span class='Comment_Single_Line'># custom is not deemed a likely security risk as it can't be generated from 
</span>   <span class='Comment_Single_Line'># perl so would only be seen if the DBA had chosen to load a module that 
</span>   <span class='Comment_Single_Line'># used it. Even then it's unlikely to be seen because it's typically 
</span>   <span class='Comment_Single_Line'># generated by compiler plugins that operate after PL_op_mask checks. 
</span>   <span class='Comment_Single_Line'># But we err on the side of caution and disable it 
</span>    <span class='Keyword'>qw</span><span class='String'>[!custom]</span><span class='Delimiter'>,</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Keyword'>printf </span>$fh <span class='String'>"  /* ALLOWED: @allowed_ops */ \\\n"</span><span class='Delimiter'>; 
</span> 
<span class='Control'>foreach</span> <span class='Keyword'>my </span>$opname <span class='Parentheses'>(</span>opset_to_ops<span class='Parentheses'>(</span>opset<span class='Parentheses'>(</span>@allowed_ops<span class='Parentheses'>)))</span> 
<span class='Delimiter'>{ 
</span>    <span class='Keyword'>printf </span>$fh <span class='Operator'>qq</span><span class='String'>{  opmask[OP_%-12s] = 0;\t/* %s */ \\\n}</span><span class='Delimiter'>, 
</span>      <span class='Keyword'>uc</span><span class='Parentheses'>(</span>$opname<span class='Parentheses'>)</span><span class='Delimiter'>, </span>opdesc<span class='Parentheses'>(</span>$opname<span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span><span class='Keyword'>printf </span>$fh <span class='String'>"  /* end */ \n"</span><span class='Delimiter'>; 
</span> 
<span class='Keyword'>close </span>$fh 
  or <span class='Control'>die</span> <span class='String'>"Error closing $plperl_opmask_tmp: $!"</span><span class='Delimiter'>; 
</span> 
<span class='Keyword'>rename </span>$plperl_opmask_tmp<span class='Delimiter'>, </span>$plperl_opmask_h 
  or <span class='Control'>die</span> <span class='String'>"Error renaming $plperl_opmask_tmp to $plperl_opmask_h: $!"</span><span class='Delimiter'>; 
</span> 
<span class='Control'>exit</span> 0<span class='Delimiter'>; 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>