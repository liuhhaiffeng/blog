<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\pl\plpython\plpy_exec.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\pl\plpython\plpy_exec.c</b></p></td>
<td align='right'>
Wed Jun 14 08:26:13 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
</span><span class='Comment_Multi_Line'>/* 
 * executing Python code 
 * 
 * src/pl/plpython/plpy_exec.c 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/htup_details.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_type.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/trigger.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"executor/spi.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"funcapi.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/rel.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/typcache.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"plpython.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"plpy_exec.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"plpy_elog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"plpy_main.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"plpy_procedure.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"plpy_subxactobject.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* saved state for a set-returning function */ 
</span><a name="LN29"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>PLySRFState</span> 
<span class='Delimiter'>{ 
</span><a name="LN31"></a>    PyObject   <span class='Operator'>*</span><span class='Declare_Member'>iter</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* Python iterator producing results */ 
</span><a name="LN32"></a>    <a href="plpy_procedure.h.html#LN14"><span class='Ref_to_Struct'>PLySavedArgs</span></a> <span class='Operator'>*</span><span class='Declare_Member'>savedargs</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* function argument values */ 
</span><a name="LN33"></a>    <a href="../../include/utils/palloc.h.html#LN46"><span class='Ref_to_Struct'>MemoryContextCallback</span></a> <span class='Declare_Member'>callback</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* for releasing refcounts when done */ 
</span><a name="LN34"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>PLySRFState</span><span class='Delimiter'>; 
</span> 
<a name="LN36"></a><span class='Keyword'>static </span>PyObject <span class='Operator'>*</span><span class='Declare_Prototype'>PLy_function_build_args</span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN37"><span class='Ref_to_Typedef'>FunctionCallInfo</span></a> <span class='Declare_Parameter'>fcinfo</span><span class='Delimiter'>, </span><a href="plpy_procedure.h.html#LN23"><span class='Ref_to_Struct'>PLyProcedure</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proc</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN37"></a><span class='Keyword'>static </span><a href="plpy_procedure.h.html#LN14"><span class='Ref_to_Struct'>PLySavedArgs</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>PLy_function_save_args</span><span class='Parentheses'>(</span><a href="plpy_procedure.h.html#LN23"><span class='Ref_to_Struct'>PLyProcedure</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proc</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN38"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>PLy_function_restore_args</span><span class='Parentheses'>(</span><a href="plpy_procedure.h.html#LN23"><span class='Ref_to_Struct'>PLyProcedure</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proc</span><span class='Delimiter'>, </span><a href="plpy_procedure.h.html#LN14"><span class='Ref_to_Struct'>PLySavedArgs</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>savedargs</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN39"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>PLy_function_drop_args</span><span class='Parentheses'>(</span><a href="plpy_procedure.h.html#LN14"><span class='Ref_to_Struct'>PLySavedArgs</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>savedargs</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN40"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>PLy_global_args_push</span><span class='Parentheses'>(</span><a href="plpy_procedure.h.html#LN23"><span class='Ref_to_Struct'>PLyProcedure</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proc</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN41"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>PLy_global_args_pop</span><span class='Parentheses'>(</span><a href="plpy_procedure.h.html#LN23"><span class='Ref_to_Struct'>PLyProcedure</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proc</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN42"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>plpython_srf_cleanup_callback</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN43"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>plpython_return_error_callback</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN45"></a><span class='Keyword'>static </span>PyObject <span class='Operator'>*</span><span class='Declare_Prototype'>PLy_trigger_build_args</span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN37"><span class='Ref_to_Typedef'>FunctionCallInfo</span></a> <span class='Declare_Parameter'>fcinfo</span><span class='Delimiter'>, </span><a href="plpy_procedure.h.html#LN23"><span class='Ref_to_Struct'>PLyProcedure</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proc</span><span class='Delimiter'>, 
</span><a name="LN46"></a>                       <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rv</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN47"></a><span class='Keyword'>static </span><a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Prototype'>PLy_modify_tuple</span><span class='Parentheses'>(</span><a href="plpy_procedure.h.html#LN23"><span class='Ref_to_Struct'>PLyProcedure</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proc</span><span class='Delimiter'>, </span>PyObject <span class='Operator'>*</span><span class='Declare_Parameter'>pltd</span><span class='Delimiter'>, 
</span><a name="LN48"></a>                 <a href="../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tdata</span><span class='Delimiter'>, </span><a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>otup</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN49"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>plpython_trigger_error_callback</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN51"></a><span class='Keyword'>static </span>PyObject <span class='Operator'>*</span><span class='Declare_Prototype'>PLy_procedure_call</span><span class='Parentheses'>(</span><a href="plpy_procedure.h.html#LN23"><span class='Ref_to_Struct'>PLyProcedure</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proc</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>kargs</span><span class='Delimiter'>, </span>PyObject <span class='Operator'>*</span><span class='Declare_Parameter'>vargs</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN52"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>PLy_abort_open_subtransactions</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>save_subxact_level</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* function subhandler */ 
</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN57"></a><span class='Declare_Function'>PLy_exec_function</span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN37"><span class='Ref_to_Typedef'>FunctionCallInfo</span></a> <span class='Declare_Parameter'>fcinfo</span><span class='Delimiter'>, </span><a href="plpy_procedure.h.html#LN23"><span class='Ref_to_Struct'>PLyProcedure</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN59"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>rv</span><span class='Delimiter'>; 
</span><a name="LN60"></a>    PyObject   <span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Declare_Local'>plargs</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN61"></a>    PyObject   <span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Declare_Local'>plrv</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN62"></a>    <a href="../../include/funcapi.h.html#LN56"><span class='Ref_to_Struct'>FuncCallContext</span></a> <span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Declare_Local'>funcctx</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN63"></a>    <a href="plpy_exec.c.html#LN29"><span class='Ref_to_Struct'>PLySRFState</span></a> <span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Declare_Local'>srfstate</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN64"></a>    ErrorContextCallback <span class='Declare_Local'>plerrcontext</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the function is called recursively, we must push outer-level 
     * arguments into the stack.  This must be immediately before the PG_TRY 
     * to ensure that the corresponding pop happens. 
     */ 
</span>    <a href="plpy_exec.c.html#LN40"><span class='Ref_to_Proto'>PLy_global_args_push</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN57"><span class='Ref_to_Parameter'>proc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN57"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN32"><span class='Ref_to_Member'>is_setof</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* First Call setup */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/funcapi.h.html#LN284"><span class='Ref_to_Macro'>SRF_IS_FIRSTCALL</span></a><span class='Parentheses'>())</span> 
            <span class='Delimiter'>{ 
</span>                <a href="plpy_exec.c.html#LN62"><span class='Ref_To_Local'>funcctx</span></a> <span class='Operator'>= </span><a href="../../include/funcapi.h.html#LN286"><span class='Ref_to_Macro'>SRF_FIRSTCALL_INIT</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>                <a href="plpy_exec.c.html#LN63"><span class='Ref_To_Local'>srfstate</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN29"><span class='Ref_to_Struct'>PLySRFState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>                    <a href="../../include/utils/palloc.h.html#LN71"><span class='Ref_to_Proto'>MemoryContextAllocZero</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN62"><span class='Ref_To_Local'>funcctx</span></a><span class='Operator'>-&GT;</span><a href="../../include/funcapi.h.html#LN108"><span class='Ref_to_Member'>multi_call_memory_ctx</span></a><span class='Delimiter'>, 
</span>                                           <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN29"><span class='Ref_to_Struct'>PLySRFState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* Immediately register cleanup callback */ 
</span>                <a href="plpy_exec.c.html#LN63"><span class='Ref_To_Local'>srfstate</span></a><span class='Operator'>-&GT;</span><a href="plpy_exec.c.html#LN33"><span class='Ref_to_Member'>callback</span></a><span class='Operator'>.</span><a href="../../include/utils/palloc.h.html#LN48"><span class='Ref_to_Member'>func</span></a> <span class='Operator'>= </span><a href="plpy_exec.c.html#LN42"><span class='Ref_to_Proto'>plpython_srf_cleanup_callback</span></a><span class='Delimiter'>; 
</span>                <a href="plpy_exec.c.html#LN63"><span class='Ref_To_Local'>srfstate</span></a><span class='Operator'>-&GT;</span><a href="plpy_exec.c.html#LN33"><span class='Ref_to_Member'>callback</span></a><span class='Operator'>.</span><a href="../../include/utils/palloc.h.html#LN49"><span class='Ref_to_Member'>arg</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="plpy_exec.c.html#LN63"><span class='Ref_To_Local'>srfstate</span></a><span class='Delimiter'>; 
</span>                <a href="../../include/utils/palloc.h.html#LN118"><span class='Ref_to_Proto'>MemoryContextRegisterResetCallback</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN62"><span class='Ref_To_Local'>funcctx</span></a><span class='Operator'>-&GT;</span><a href="../../include/funcapi.h.html#LN108"><span class='Ref_to_Member'>multi_call_memory_ctx</span></a><span class='Delimiter'>, 
</span>                                                   <span class='Operator'>&</span><a href="plpy_exec.c.html#LN63"><span class='Ref_To_Local'>srfstate</span></a><span class='Operator'>-&GT;</span><a href="plpy_exec.c.html#LN33"><span class='Ref_to_Member'>callback</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="plpy_exec.c.html#LN62"><span class='Ref_To_Local'>funcctx</span></a><span class='Operator'>-&GT;</span><a href="../../include/funcapi.h.html#LN89"><span class='Ref_to_Member'>user_fctx</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="plpy_exec.c.html#LN63"><span class='Ref_To_Local'>srfstate</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Comment_Multi_Line'>/* Every call setup */ 
</span>            <a href="plpy_exec.c.html#LN62"><span class='Ref_To_Local'>funcctx</span></a> <span class='Operator'>= </span><a href="../../include/funcapi.h.html#LN288"><span class='Ref_to_Macro'>SRF_PERCALL_SETUP</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN62"><span class='Ref_To_Local'>funcctx</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="plpy_exec.c.html#LN63"><span class='Ref_To_Local'>srfstate</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN29"><span class='Ref_to_Struct'>PLySRFState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="plpy_exec.c.html#LN62"><span class='Ref_To_Local'>funcctx</span></a><span class='Operator'>-&GT;</span><a href="../../include/funcapi.h.html#LN89"><span class='Ref_to_Member'>user_fctx</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if proc-&GT;is_setof &raquo; </span> 
 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN63"><span class='Ref_To_Local'>srfstate</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><a href="plpy_exec.c.html#LN63"><span class='Ref_To_Local'>srfstate</span></a><span class='Operator'>-&GT;</span><a href="plpy_exec.c.html#LN31"><span class='Ref_to_Member'>iter</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Non-SETOF function or first time for SETOF function: build 
             * args, then actually execute the function. 
             */ 
</span>            <a href="plpy_exec.c.html#LN60"><span class='Ref_To_Local'>plargs</span></a> <span class='Operator'>= </span><a href="plpy_exec.c.html#LN36"><span class='Ref_to_Proto'>PLy_function_build_args</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN57"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN57"><span class='Ref_to_Parameter'>proc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="plpy_exec.c.html#LN61"><span class='Ref_To_Local'>plrv</span></a> <span class='Operator'>= </span><a href="plpy_exec.c.html#LN51"><span class='Ref_to_Proto'>PLy_procedure_call</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN57"><span class='Ref_to_Parameter'>proc</span></a><span class='Delimiter'>, </span><span class='String'>"args"</span><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN60"><span class='Ref_To_Local'>plargs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN61"><span class='Ref_To_Local'>plrv</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Second or later call for a SETOF function: restore arguments in 
             * globals dict to what they were when we left off.  We must do 
             * this in case multiple evaluations of the same SETOF function 
             * are interleaved.  It's a bit annoying, since the iterator may 
             * not look at the arguments at all, but we have no way to know 
             * that.  Fortunately this isn't terribly expensive. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN63"><span class='Ref_To_Local'>srfstate</span></a><span class='Operator'>-&GT;</span><a href="plpy_exec.c.html#LN32"><span class='Ref_to_Member'>savedargs</span></a><span class='Parentheses'>) 
</span>                <a href="plpy_exec.c.html#LN38"><span class='Ref_to_Proto'>PLy_function_restore_args</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN57"><span class='Ref_to_Parameter'>proc</span></a><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN63"><span class='Ref_To_Local'>srfstate</span></a><span class='Operator'>-&GT;</span><a href="plpy_exec.c.html#LN32"><span class='Ref_to_Member'>savedargs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="plpy_exec.c.html#LN63"><span class='Ref_To_Local'>srfstate</span></a><span class='Operator'>-&GT;</span><a href="plpy_exec.c.html#LN32"><span class='Ref_to_Member'>savedargs</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* deleted by restore_args */ 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If it returns a set, call the iterator to get the next return item. 
         * We stay in the SPI context while doing this, because PyIter_Next() 
         * calls back into Python code which might contain SPI calls. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN57"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN32"><span class='Ref_to_Member'>is_setof</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN63"><span class='Ref_To_Local'>srfstate</span></a><span class='Operator'>-&GT;</span><a href="plpy_exec.c.html#LN31"><span class='Ref_to_Member'>iter</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* first time -- do checks and setup */ 
</span><a name="LN132"></a>                <a href="../../include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rsi</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="plpy_exec.c.html#LN57"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/fmgr.h.html#LN80"><span class='Ref_to_Member'>resultinfo</span></a><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plpy_exec.c.html#LN132"><span class='Ref_To_Local'>rsi</span></a> <span class='Operator'>|| !</span><a href="../../include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN132"><span class='Ref_To_Local'>rsi</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>                    <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN132"><span class='Ref_To_Local'>rsi</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN267"><span class='Ref_to_Member'>allowedModes</span></a> <span class='Operator'>& </span><a href="../../include/nodes/execnodes.h.html#LN249"><span class='Ref_to_EnumConst'>SFRM_ValuePerCall</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"unsupported set function return mode"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../../backend/utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"PL/Python set-returning functions only support returning one value per call."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <a href="plpy_exec.c.html#LN132"><span class='Ref_To_Local'>rsi</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN269"><span class='Ref_to_Member'>returnMode</span></a> <span class='Operator'>= </span><a href="../../include/nodes/execnodes.h.html#LN249"><span class='Ref_to_EnumConst'>SFRM_ValuePerCall</span></a><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* Make iterator out of returned object */ 
</span>                <a href="plpy_exec.c.html#LN63"><span class='Ref_To_Local'>srfstate</span></a><span class='Operator'>-&GT;</span><a href="plpy_exec.c.html#LN31"><span class='Ref_to_Member'>iter</span></a> <span class='Operator'>= </span>PyObject_GetIter<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN61"><span class='Ref_To_Local'>plrv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                Py_DECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN61"><span class='Ref_To_Local'>plrv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="plpy_exec.c.html#LN61"><span class='Ref_To_Local'>plrv</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN63"><span class='Ref_To_Local'>srfstate</span></a><span class='Operator'>-&GT;</span><a href="plpy_exec.c.html#LN31"><span class='Ref_to_Member'>iter</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATATYPE_MISMATCH<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"returned object cannot be iterated"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../../backend/utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"PL/Python set-returning functions must return an iterable object."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if srfstate-&GT;iter==NULL &raquo; </span> 
 
            <span class='Comment_Multi_Line'>/* Fetch next from iterator */ 
</span>            <a href="plpy_exec.c.html#LN61"><span class='Ref_To_Local'>plrv</span></a> <span class='Operator'>= </span>PyIter_Next<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN63"><span class='Ref_To_Local'>srfstate</span></a><span class='Operator'>-&GT;</span><a href="plpy_exec.c.html#LN31"><span class='Ref_to_Member'>iter</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN61"><span class='Ref_To_Local'>plrv</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Iterator is exhausted or error happened */ 
</span><a name="LN162"></a>                <span class='Keyword'>bool</span>        <span class='Declare_Local'>has_error</span> <span class='Operator'>= </span><span class='Parentheses'>(</span>PyErr_Occurred<span class='Parentheses'>() </span><span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                Py_DECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN63"><span class='Ref_To_Local'>srfstate</span></a><span class='Operator'>-&GT;</span><a href="plpy_exec.c.html#LN31"><span class='Ref_to_Member'>iter</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="plpy_exec.c.html#LN63"><span class='Ref_To_Local'>srfstate</span></a><span class='Operator'>-&GT;</span><a href="plpy_exec.c.html#LN31"><span class='Ref_to_Member'>iter</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN162"><span class='Ref_To_Local'>has_error</span></a><span class='Parentheses'>) 
</span>                    <a href="plpy_elog.c.html#LN45"><span class='Ref_to_Func'>PLy_elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"error fetching next item from iterator"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* Pass a null through the data-returning steps below */ 
</span>                Py_INCREF<span class='Parentheses'>(</span>Py_None<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="plpy_exec.c.html#LN61"><span class='Ref_To_Local'>plrv</span></a> <span class='Operator'>= </span>Py_None<span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * This won't be last call, so save argument values.  We do 
                 * this again each time in case the iterator is changing those 
                 * values. 
                 */ 
</span>                <a href="plpy_exec.c.html#LN63"><span class='Ref_To_Local'>srfstate</span></a><span class='Operator'>-&GT;</span><a href="plpy_exec.c.html#LN32"><span class='Ref_to_Member'>savedargs</span></a> <span class='Operator'>= </span><a href="plpy_exec.c.html#LN37"><span class='Ref_to_Proto'>PLy_function_save_args</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN57"><span class='Ref_to_Parameter'>proc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if proc-&GT;is_setof &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Disconnect from SPI manager and then create the return values datum 
         * (if the input function does a palloc for it this must not be 
         * allocated in the SPI memory context because SPI_finish would free 
         * it). 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/executor/spi.h.html#LN80"><span class='Ref_to_Proto'>SPI_finish</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../include/executor/spi.h.html#LN50"><span class='Ref_to_Const'>SPI_OK_FINISH</span></a><span class='Parentheses'>)</span> 
            <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_finish failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="plpy_exec.c.html#LN64"><span class='Ref_To_Local'>plerrcontext</span></a><span class='Operator'>.</span>callback <span class='Operator'>= </span><a href="plpy_exec.c.html#LN43"><span class='Ref_to_Proto'>plpython_return_error_callback</span></a><span class='Delimiter'>; 
</span>        <a href="plpy_exec.c.html#LN64"><span class='Ref_To_Local'>plerrcontext</span></a><span class='Operator'>.</span>previous <span class='Operator'>= </span><a href="../../backend/utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a><span class='Delimiter'>; 
</span>        <a href="../../backend/utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a> <span class='Operator'>= &</span><a href="plpy_exec.c.html#LN64"><span class='Ref_To_Local'>plerrcontext</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If the function is declared to return void, the Python return value 
         * must be None. For void-returning functions, we also treat a None 
         * return value as a special "void datum" rather than NULL (as is the 
         * case for non-void-returning functions). 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN57"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN33"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN86"><span class='Ref_to_Member'>out</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN76"><span class='Ref_to_Member'>d</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN59"><span class='Ref_to_Member'>typoid</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_type.h.html#LN689"><span class='Ref_to_Const'>VOIDOID</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN61"><span class='Ref_To_Local'>plrv</span></a> <span class='Operator'>!= </span>Py_None<span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATATYPE_MISMATCH<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"PL/Python function with return type \"void\" did not return None"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
            <a href="plpy_exec.c.html#LN57"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/fmgr.h.html#LN82"><span class='Ref_to_Member'>isnull</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <a href="plpy_exec.c.html#LN59"><span class='Ref_To_Local'>rv</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN61"><span class='Ref_To_Local'>plrv</span></a> <span class='Operator'>== </span>Py_None<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="plpy_exec.c.html#LN57"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/fmgr.h.html#LN82"><span class='Ref_to_Member'>isnull</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * In a SETOF function, the iteration-ending null isn't a real 
             * value; don't pass it through the input function, which might 
             * complain. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN63"><span class='Ref_To_Local'>srfstate</span></a> <span class='Operator'>&& </span><a href="plpy_exec.c.html#LN63"><span class='Ref_To_Local'>srfstate</span></a><span class='Operator'>-&GT;</span><a href="plpy_exec.c.html#LN31"><span class='Ref_to_Member'>iter</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <a href="plpy_exec.c.html#LN59"><span class='Ref_To_Local'>rv</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN57"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN33"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN92"><span class='Ref_to_Member'>is_rowtype</span></a> <span class='Operator'>&LT; </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>                <a href="plpy_exec.c.html#LN59"><span class='Ref_To_Local'>rv</span></a> <span class='Operator'>= </span><a href="../../include/fmgr.h.html#LN642"><span class='Ref_to_Proto'>InputFunctionCall</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="plpy_exec.c.html#LN57"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN33"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN86"><span class='Ref_to_Member'>out</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN76"><span class='Ref_to_Member'>d</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN57"><span class='Ref_to_Member'>typfunc</span></a><span class='Delimiter'>, 
</span>                                       <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                       <a href="plpy_exec.c.html#LN57"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN33"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN86"><span class='Ref_to_Member'>out</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN76"><span class='Ref_to_Member'>d</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN61"><span class='Ref_to_Member'>typioparam</span></a><span class='Delimiter'>, 
</span>                                       <span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <span class='Comment_Multi_Line'>/* Tuple as None */ 
</span>                <a href="plpy_exec.c.html#LN59"><span class='Ref_To_Local'>rv</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if plrv==Py_None &raquo; </span> 
        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN57"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN33"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN92"><span class='Ref_to_Member'>is_rowtype</span></a> <span class='Operator'>&GT;= </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN236"></a>            <a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>desc</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* make sure it's not an unnamed record */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>((</span><a href="plpy_exec.c.html#LN57"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN33"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN86"><span class='Ref_to_Member'>out</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN76"><span class='Ref_to_Member'>d</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN59"><span class='Ref_to_Member'>typoid</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_type.h.html#LN679"><span class='Ref_to_Const'>RECORDOID</span></a> <span class='Operator'>&& 
</span>                    <a href="plpy_exec.c.html#LN57"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN33"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN86"><span class='Ref_to_Member'>out</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN76"><span class='Ref_to_Member'>d</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN60"><span class='Ref_to_Member'>typmod</span></a> <span class='Operator'>!= -</span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>                   <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN57"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN33"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN86"><span class='Ref_to_Member'>out</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN76"><span class='Ref_to_Member'>d</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN59"><span class='Ref_to_Member'>typoid</span></a> <span class='Operator'>!= </span><a href="../../include/catalog/pg_type.h.html#LN679"><span class='Ref_to_Const'>RECORDOID</span></a> <span class='Operator'>&& 
</span>                    <a href="plpy_exec.c.html#LN57"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN33"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN86"><span class='Ref_to_Member'>out</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN76"><span class='Ref_to_Member'>d</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN60"><span class='Ref_to_Member'>typmod</span></a> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <a href="plpy_exec.c.html#LN236"><span class='Ref_To_Local'>desc</span></a> <span class='Operator'>= </span><a href="../../include/utils/typcache.h.html#LN151"><span class='Ref_to_Proto'>lookup_rowtype_tupdesc</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN57"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN33"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN86"><span class='Ref_to_Member'>out</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN76"><span class='Ref_to_Member'>d</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN59"><span class='Ref_to_Member'>typoid</span></a><span class='Delimiter'>, 
</span>                                          <a href="plpy_exec.c.html#LN57"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN33"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN86"><span class='Ref_to_Member'>out</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN76"><span class='Ref_to_Member'>d</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN60"><span class='Ref_to_Member'>typmod</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="plpy_exec.c.html#LN59"><span class='Ref_To_Local'>rv</span></a> <span class='Operator'>= </span><a href="plpy_typeio.h.html#LN113"><span class='Ref_to_Proto'>PLyObject_ToCompositeDatum</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="plpy_exec.c.html#LN57"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN33"><span class='Ref_to_Member'>result</span></a><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN236"><span class='Ref_To_Local'>desc</span></a><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN61"><span class='Ref_To_Local'>plrv</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="plpy_exec.c.html#LN57"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/fmgr.h.html#LN82"><span class='Ref_to_Member'>isnull</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN59"><span class='Ref_To_Local'>rv</span></a> <span class='Operator'>== </span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../include/access/tupdesc.h.html#LN106"><span class='Ref_to_Macro'>ReleaseTupleDesc</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN236"><span class='Ref_To_Local'>desc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="plpy_exec.c.html#LN57"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/fmgr.h.html#LN82"><span class='Ref_to_Member'>isnull</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <a href="plpy_exec.c.html#LN59"><span class='Ref_To_Local'>rv</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN57"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN33"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN86"><span class='Ref_to_Member'>out</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN76"><span class='Ref_to_Member'>d</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN56"><span class='Ref_to_Member'>func</span></a><span class='Parentheses'>) (</span><span class='Operator'>&</span><a href="plpy_exec.c.html#LN57"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN33"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN86"><span class='Ref_to_Member'>out</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN76"><span class='Ref_to_Member'>d</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN61"><span class='Ref_To_Local'>plrv</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Pop old arguments from the stack if they were pushed above */ 
</span>        <a href="plpy_exec.c.html#LN41"><span class='Ref_to_Proto'>PLy_global_args_pop</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN57"><span class='Ref_to_Parameter'>proc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        Py_XDECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN60"><span class='Ref_To_Local'>plargs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        Py_XDECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN61"><span class='Ref_To_Local'>plrv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If there was an error within a SRF, the iterator might not have 
         * been exhausted yet.  Clear it so the next invocation of the 
         * function will start the iteration again.  (This code is probably 
         * unnecessary now; plpython_srf_cleanup_callback should take care of 
         * cleanup.  But it doesn't hurt anything to do it here.) 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN63"><span class='Ref_To_Local'>srfstate</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            Py_XDECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN63"><span class='Ref_To_Local'>srfstate</span></a><span class='Operator'>-&GT;</span><a href="plpy_exec.c.html#LN31"><span class='Ref_to_Member'>iter</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="plpy_exec.c.html#LN63"><span class='Ref_To_Local'>srfstate</span></a><span class='Operator'>-&GT;</span><a href="plpy_exec.c.html#LN31"><span class='Ref_to_Member'>iter</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* And drop any saved args; we won't need them */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN63"><span class='Ref_To_Local'>srfstate</span></a><span class='Operator'>-&GT;</span><a href="plpy_exec.c.html#LN32"><span class='Ref_to_Member'>savedargs</span></a><span class='Parentheses'>) 
</span>                <a href="plpy_exec.c.html#LN39"><span class='Ref_to_Proto'>PLy_function_drop_args</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN63"><span class='Ref_To_Local'>srfstate</span></a><span class='Operator'>-&GT;</span><a href="plpy_exec.c.html#LN32"><span class='Ref_to_Member'>savedargs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="plpy_exec.c.html#LN63"><span class='Ref_To_Local'>srfstate</span></a><span class='Operator'>-&GT;</span><a href="plpy_exec.c.html#LN32"><span class='Ref_to_Member'>savedargs</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../include/utils/elog.h.html#LN310"><span class='Ref_to_Macro'>PG_RE_THROW</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../backend/utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a> <span class='Operator'>= </span><a href="plpy_exec.c.html#LN64"><span class='Ref_To_Local'>plerrcontext</span></a><span class='Operator'>.</span>previous<span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Pop old arguments from the stack if they were pushed above */ 
</span>    <a href="plpy_exec.c.html#LN41"><span class='Ref_to_Proto'>PLy_global_args_pop</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN57"><span class='Ref_to_Parameter'>proc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    Py_XDECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN60"><span class='Ref_To_Local'>plargs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    Py_DECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN61"><span class='Ref_To_Local'>plrv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN63"><span class='Ref_To_Local'>srfstate</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* We're in a SRF, exit appropriately */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN63"><span class='Ref_To_Local'>srfstate</span></a><span class='Operator'>-&GT;</span><a href="plpy_exec.c.html#LN31"><span class='Ref_to_Member'>iter</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Iterator exhausted, so we're done */ 
</span>            <a href="../../include/funcapi.h.html#LN308"><span class='Ref_to_Macro'>SRF_RETURN_DONE</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN62"><span class='Ref_To_Local'>funcctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN57"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/fmgr.h.html#LN82"><span class='Ref_to_Member'>isnull</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/funcapi.h.html#LN299"><span class='Ref_to_Macro'>SRF_RETURN_NEXT_NULL</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN62"><span class='Ref_To_Local'>funcctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../../include/funcapi.h.html#LN290"><span class='Ref_to_Macro'>SRF_RETURN_NEXT</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN62"><span class='Ref_To_Local'>funcctx</span></a><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN59"><span class='Ref_To_Local'>rv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Plain function, just return the Datum value (possibly null) */ 
</span>    <span class='Control'>return</span> <a href="plpy_exec.c.html#LN59"><span class='Ref_To_Local'>rv</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PLy_exec_function &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* trigger subhandler 
 * 
 * the python function is expected to return Py_None if the tuple is 
 * acceptable and unmodified.  Otherwise it should return a PyString 
 * object who's value is SKIP, or MODIFY.  SKIP means don't perform 
 * this action.  MODIFY means the tuple has been modified, so update 
 * tuple and perform action.  SKIP and MODIFY assume the trigger fires 
 * BEFORE the event and is ROW level.  postgres expects the function 
 * to take no arguments and return an argument of type trigger. 
 */ 
</span><a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> 
<a name="LN324"></a><span class='Declare_Function'>PLy_exec_trigger</span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN37"><span class='Ref_to_Typedef'>FunctionCallInfo</span></a> <span class='Declare_Parameter'>fcinfo</span><span class='Delimiter'>, </span><a href="plpy_procedure.h.html#LN23"><span class='Ref_to_Struct'>PLyProcedure</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN326"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>rv</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN327"></a>    PyObject   <span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Declare_Local'>plargs</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN328"></a>    PyObject   <span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Declare_Local'>plrv</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN329"></a>    <a href="../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tdata</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN24"><span class='Ref_to_Macro'>CALLED_AS_TRIGGER</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN324"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Input/output conversion for trigger tuples.  Use the result TypeInfo 
     * variable to store the tuple conversion info.  We do this over again on 
     * each call to cover the possibility that the relation's tupdesc changed 
     * since the trigger was last called. PLy_input_tuple_funcs and 
     * PLy_output_tuple_funcs are responsible for not doing repetitive work. 
     */ 
</span>    <a href="plpy_exec.c.html#LN329"><span class='Ref_To_Local'>tdata</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="plpy_exec.c.html#LN324"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/fmgr.h.html#LN79"><span class='Ref_to_Member'>context</span></a><span class='Delimiter'>; 
</span> 
    <a href="plpy_typeio.c.html#LN103"><span class='Ref_to_Func'>PLy_input_tuple_funcs</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN324"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN33"><span class='Ref_to_Member'>result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN329"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plpy_typeio.h.html#LN108"><span class='Ref_to_Proto'>PLy_output_tuple_funcs</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN324"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN33"><span class='Ref_to_Member'>result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN329"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span><a name="LN347"></a>        <span class='Keyword'>int </span>rc      <span class='Declare_Local'>PG_USED_FOR_ASSERTS_ONLY</span><span class='Delimiter'>; 
</span> 
        rc <span class='Operator'>= </span><a href="../../include/executor/spi.h.html#LN156"><span class='Ref_to_Proto'>SPI_register_trigger_data</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN329"><span class='Ref_To_Local'>tdata</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span>rc <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="plpy_exec.c.html#LN327"><span class='Ref_To_Local'>plargs</span></a> <span class='Operator'>= </span><a href="plpy_exec.c.html#LN45"><span class='Ref_to_Proto'>PLy_trigger_build_args</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN324"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN324"><span class='Ref_to_Parameter'>proc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plpy_exec.c.html#LN326"><span class='Ref_To_Local'>rv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="plpy_exec.c.html#LN328"><span class='Ref_To_Local'>plrv</span></a> <span class='Operator'>= </span><a href="plpy_exec.c.html#LN51"><span class='Ref_to_Proto'>PLy_procedure_call</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN324"><span class='Ref_to_Parameter'>proc</span></a><span class='Delimiter'>, </span><span class='String'>"TD"</span><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN327"><span class='Ref_To_Local'>plargs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN328"><span class='Ref_To_Local'>plrv</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Disconnect from SPI manager 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/executor/spi.h.html#LN80"><span class='Ref_to_Proto'>SPI_finish</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../include/executor/spi.h.html#LN50"><span class='Ref_to_Const'>SPI_OK_FINISH</span></a><span class='Parentheses'>)</span> 
            <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_finish failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * return of None means we're happy with the tuple 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN328"><span class='Ref_To_Local'>plrv</span></a> <span class='Operator'>!= </span>Py_None<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN368"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>srv</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpython.h.html#LN90"><span class='Ref_to_Macro'>PyString_Check</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN328"><span class='Ref_To_Local'>plrv</span></a><span class='Parentheses'>))</span> 
                <a href="plpy_exec.c.html#LN368"><span class='Ref_To_Local'>srv</span></a> <span class='Operator'>= </span><a href="plpython.h.html#LN91"><span class='Ref_to_Macro'>PyString_AsString</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN328"><span class='Ref_To_Local'>plrv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>PyUnicode_Check<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN328"><span class='Ref_To_Local'>plrv</span></a><span class='Parentheses'>))</span> 
                <a href="plpy_exec.c.html#LN368"><span class='Ref_To_Local'>srv</span></a> <span class='Operator'>= </span><a href="plpy_util.h.html#LN9"><span class='Ref_to_Proto'>PLyUnicode_AsString</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN328"><span class='Ref_To_Local'>plrv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATA_EXCEPTION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"unexpected return value from trigger procedure"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../backend/utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Expected None or a string."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <a href="plpy_exec.c.html#LN368"><span class='Ref_To_Local'>srv</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* keep compiler quiet */ 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../port/pgstrcasecmp.c.html#LN34"><span class='Ref_to_Func'>pg_strcasecmp</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN368"><span class='Ref_To_Local'>srv</span></a><span class='Delimiter'>, </span><span class='String'>"SKIP"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <a href="plpy_exec.c.html#LN326"><span class='Ref_To_Local'>rv</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../port/pgstrcasecmp.c.html#LN34"><span class='Ref_to_Func'>pg_strcasecmp</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN368"><span class='Ref_To_Local'>srv</span></a><span class='Delimiter'>, </span><span class='String'>"MODIFY"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span><a name="LN387"></a>                <a href="../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tdata</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="plpy_exec.c.html#LN324"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/fmgr.h.html#LN79"><span class='Ref_to_Member'>context</span></a><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN69"><span class='Ref_to_Macro'>TRIGGER_FIRED_BY_INSERT</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN387"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>                    <a href="../../include/commands/trigger.h.html#LN75"><span class='Ref_to_Macro'>TRIGGER_FIRED_BY_UPDATE</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN387"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
                    <a href="plpy_exec.c.html#LN326"><span class='Ref_To_Local'>rv</span></a> <span class='Operator'>= </span><a href="plpy_exec.c.html#LN47"><span class='Ref_to_Proto'>PLy_modify_tuple</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN324"><span class='Ref_to_Parameter'>proc</span></a><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN327"><span class='Ref_To_Local'>plargs</span></a><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN387"><span class='Ref_To_Local'>tdata</span></a><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN326"><span class='Ref_To_Local'>rv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"PL/Python trigger function returned \"MODIFY\" in a DELETE trigger -- ignored"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../port/pgstrcasecmp.c.html#LN34"><span class='Ref_to_Func'>pg_strcasecmp</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN368"><span class='Ref_To_Local'>srv</span></a><span class='Delimiter'>, </span><span class='String'>"OK"</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * accept "OK" as an alternative to None; otherwise, raise an 
                 * error 
                 */ 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATA_EXCEPTION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"unexpected return value from trigger procedure"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../backend/utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Expected None, \"OK\", \"SKIP\", or \"MODIFY\"."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if plrv!=Py_None &raquo; </span> 
    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        Py_XDECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN327"><span class='Ref_To_Local'>plargs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        Py_XDECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN328"><span class='Ref_To_Local'>plrv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/utils/elog.h.html#LN310"><span class='Ref_to_Macro'>PG_RE_THROW</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    Py_DECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN327"><span class='Ref_To_Local'>plargs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    Py_DECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN328"><span class='Ref_To_Local'>plrv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="plpy_exec.c.html#LN326"><span class='Ref_To_Local'>rv</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PLy_exec_trigger &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* helper functions for Python code execution */ 
</span> 
<span class='Keyword'>static </span>PyObject <span class='Operator'>* 
</span><a name="LN427"></a><span class='Declare_Function'>PLy_function_build_args</span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN37"><span class='Ref_to_Typedef'>FunctionCallInfo</span></a> <span class='Declare_Parameter'>fcinfo</span><span class='Delimiter'>, </span><a href="plpy_procedure.h.html#LN23"><span class='Ref_to_Struct'>PLyProcedure</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN429"></a>    PyObject   <span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Declare_Local'>arg</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN430"></a>    PyObject   <span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Declare_Local'>args</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN431"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <a href="plpy_exec.c.html#LN430"><span class='Ref_To_Local'>args</span></a> <span class='Operator'>= </span>PyList_New<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN427"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN38"><span class='Ref_to_Member'>nargs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN431"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="plpy_exec.c.html#LN431"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="plpy_exec.c.html#LN427"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN38"><span class='Ref_to_Member'>nargs</span></a><span class='Delimiter'>; </span><a href="plpy_exec.c.html#LN431"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN427"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN37"><span class='Ref_to_Member'>args</span></a><span class='Delimiter'>[</span><a href="plpy_exec.c.html#LN431"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN92"><span class='Ref_to_Member'>is_rowtype</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN427"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/fmgr.h.html#LN85"><span class='Ref_to_Member'>argnull</span></a><span class='Delimiter'>[</span><a href="plpy_exec.c.html#LN431"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>                    <a href="plpy_exec.c.html#LN429"><span class='Ref_To_Local'>arg</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span><a name="LN444"></a>                    <a href="../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a> <span class='Declare_Local'>td</span><span class='Delimiter'>; 
</span><a name="LN445"></a>                    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>tupType</span><span class='Delimiter'>; 
</span><a name="LN446"></a>                    <a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>tupTypmod</span><span class='Delimiter'>; 
</span><a name="LN447"></a>                    <a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span><span class='Delimiter'>; 
</span><a name="LN448"></a>                    <a href="../../include/access/htup.h.html#LN61"><span class='Ref_to_Struct'>HeapTupleData</span></a> <span class='Declare_Local'>tmptup</span><span class='Delimiter'>; 
</span> 
                    <a href="plpy_exec.c.html#LN444"><span class='Ref_To_Local'>td</span></a> <span class='Operator'>= </span><a href="../../include/fmgr.h.html#LN258"><span class='Ref_to_Macro'>DatumGetHeapTupleHeader</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN427"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/fmgr.h.html#LN84"><span class='Ref_to_Member'>arg</span></a><span class='Delimiter'>[</span><a href="plpy_exec.c.html#LN431"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Comment_Multi_Line'>/* Extract rowtype info and find a tupdesc */ 
</span>                    <a href="plpy_exec.c.html#LN445"><span class='Ref_To_Local'>tupType</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN444"><span class='Ref_to_Macro'>HeapTupleHeaderGetTypeId</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN444"><span class='Ref_To_Local'>td</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="plpy_exec.c.html#LN446"><span class='Ref_To_Local'>tupTypmod</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN454"><span class='Ref_to_Macro'>HeapTupleHeaderGetTypMod</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN444"><span class='Ref_To_Local'>td</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="plpy_exec.c.html#LN447"><span class='Ref_To_Local'>tupdesc</span></a> <span class='Operator'>= </span><a href="../../include/utils/typcache.h.html#LN151"><span class='Ref_to_Proto'>lookup_rowtype_tupdesc</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN445"><span class='Ref_To_Local'>tupType</span></a><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN446"><span class='Ref_To_Local'>tupTypmod</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* Set up I/O funcs if not done yet */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN427"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN37"><span class='Ref_to_Member'>args</span></a><span class='Delimiter'>[</span><a href="plpy_exec.c.html#LN431"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN92"><span class='Ref_to_Member'>is_rowtype</span></a> <span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>                        <a href="plpy_typeio.c.html#LN103"><span class='Ref_to_Func'>PLy_input_tuple_funcs</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN427"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN37"><span class='Ref_to_Member'>args</span></a><span class='Delimiter'>[</span><a href="plpy_exec.c.html#LN431"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN447"><span class='Ref_To_Local'>tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* Build a temporary HeapTuple control structure */ 
</span>                    <a href="plpy_exec.c.html#LN448"><span class='Ref_To_Local'>tmptup</span></a><span class='Operator'>.</span><a href="../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN438"><span class='Ref_to_Macro'>HeapTupleHeaderGetDatumLength</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN444"><span class='Ref_To_Local'>td</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="plpy_exec.c.html#LN448"><span class='Ref_To_Local'>tmptup</span></a><span class='Operator'>.</span><a href="../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>= </span><a href="plpy_exec.c.html#LN444"><span class='Ref_To_Local'>td</span></a><span class='Delimiter'>; 
</span> 
                    <a href="plpy_exec.c.html#LN429"><span class='Ref_To_Local'>arg</span></a> <span class='Operator'>= </span><a href="plpy_typeio.h.html#LN116"><span class='Ref_to_Proto'>PLyDict_FromTuple</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN427"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN37"><span class='Ref_to_Member'>args</span></a><span class='Delimiter'>[</span><a href="plpy_exec.c.html#LN431"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plpy_exec.c.html#LN448"><span class='Ref_To_Local'>tmptup</span></a><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN447"><span class='Ref_To_Local'>tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../include/access/tupdesc.h.html#LN106"><span class='Ref_to_Macro'>ReleaseTupleDesc</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN447"><span class='Ref_To_Local'>tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if proc-&GT;args[i].is_rowt... &raquo; </span> 
            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN427"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/fmgr.h.html#LN85"><span class='Ref_to_Member'>argnull</span></a><span class='Delimiter'>[</span><a href="plpy_exec.c.html#LN431"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>                    <a href="plpy_exec.c.html#LN429"><span class='Ref_To_Local'>arg</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="plpy_exec.c.html#LN429"><span class='Ref_To_Local'>arg</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN427"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN37"><span class='Ref_to_Member'>args</span></a><span class='Delimiter'>[</span><a href="plpy_exec.c.html#LN431"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN85"><span class='Ref_to_Member'>in</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN40"><span class='Ref_to_Member'>d</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN56"><span class='Ref_to_Member'>func</span></a><span class='Parentheses'>) (</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN427"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN37"><span class='Ref_to_Member'>args</span></a><span class='Delimiter'>[</span><a href="plpy_exec.c.html#LN431"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN85"><span class='Ref_to_Member'>in</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN40"><span class='Ref_to_Member'>d</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                                     <a href="plpy_exec.c.html#LN427"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/fmgr.h.html#LN84"><span class='Ref_to_Member'>arg</span></a><span class='Delimiter'>[</span><a href="plpy_exec.c.html#LN431"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN429"><span class='Ref_To_Local'>arg</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                Py_INCREF<span class='Parentheses'>(</span>Py_None<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="plpy_exec.c.html#LN429"><span class='Ref_To_Local'>arg</span></a> <span class='Operator'>= </span>Py_None<span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span>PyList_SetItem<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN430"><span class='Ref_To_Local'>args</span></a><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN431"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN429"><span class='Ref_To_Local'>arg</span></a><span class='Parentheses'>) </span><span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
                <a href="plpy_elog.c.html#LN45"><span class='Ref_to_Func'>PLy_elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"PyList_SetItem() failed, while setting up arguments"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN427"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN36"><span class='Ref_to_Member'>argnames</span></a> <span class='Operator'>&& </span><a href="plpy_exec.c.html#LN427"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN36"><span class='Ref_to_Member'>argnames</span></a><span class='Delimiter'>[</span><a href="plpy_exec.c.html#LN431"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>&& 
</span>            PyDict_SetItemString<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN427"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN43"><span class='Ref_to_Member'>globals</span></a><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN427"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN36"><span class='Ref_to_Member'>argnames</span></a><span class='Delimiter'>[</span><a href="plpy_exec.c.html#LN431"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="plpy_exec.c.html#LN429"><span class='Ref_To_Local'>arg</span></a><span class='Parentheses'>) </span><span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
                <a href="plpy_elog.c.html#LN45"><span class='Ref_to_Func'>PLy_elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"PyDict_SetItemString() failed, while setting up arguments"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="plpy_exec.c.html#LN429"><span class='Ref_To_Local'>arg</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;proc-&GT;nargs;i++ &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* Set up output conversion for functions returning RECORD */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN427"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN33"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN86"><span class='Ref_to_Member'>out</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN76"><span class='Ref_to_Member'>d</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN59"><span class='Ref_to_Member'>typoid</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_type.h.html#LN679"><span class='Ref_to_Const'>RECORDOID</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN497"></a>            <a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>desc</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/funcapi.h.html#LN157"><span class='Ref_to_Proto'>get_call_result_type</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN427"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="plpy_exec.c.html#LN497"><span class='Ref_To_Local'>desc</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../include/funcapi.h.html#LN152"><span class='Ref_to_EnumConst'>TYPEFUNC_COMPOSITE</span></a><span class='Parentheses'>)</span> 
                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"function returning record called in context "</span> 
                                <span class='String'>"that cannot accept type record"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* cache the output conversion functions */ 
</span>            <a href="plpy_typeio.h.html#LN110"><span class='Ref_to_Proto'>PLy_output_record_funcs</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN427"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN33"><span class='Ref_to_Member'>result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN497"><span class='Ref_To_Local'>desc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        Py_XDECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN429"><span class='Ref_To_Local'>arg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        Py_XDECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN430"><span class='Ref_To_Local'>args</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/utils/elog.h.html#LN310"><span class='Ref_to_Macro'>PG_RE_THROW</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="plpy_exec.c.html#LN430"><span class='Ref_To_Local'>args</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PLy_function_build_args &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Construct a PLySavedArgs struct representing the current values of the 
 * procedure's arguments in its globals dict.  This can be used to restore 
 * those values when exiting a recursive call level or returning control to a 
 * set-returning function. 
 * 
 * This would not be necessary except for an ancient decision to make args 
 * available via the proc's globals :-( ... but we're stuck with that now. 
 */ 
</span><span class='Keyword'>static </span><a href="plpy_procedure.h.html#LN14"><span class='Ref_to_Struct'>PLySavedArgs</span></a> <span class='Operator'>* 
</span><a name="LN531"></a><span class='Declare_Function'>PLy_function_save_args</span><span class='Parentheses'>(</span><a href="plpy_procedure.h.html#LN23"><span class='Ref_to_Struct'>PLyProcedure</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN533"></a>    <a href="plpy_procedure.h.html#LN14"><span class='Ref_to_Struct'>PLySavedArgs</span></a> <span class='Operator'>*</span><span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* saved args are always allocated in procedure's context */ 
</span>    <a href="plpy_exec.c.html#LN533"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="plpy_procedure.h.html#LN14"><span class='Ref_to_Struct'>PLySavedArgs</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../include/utils/palloc.h.html#LN71"><span class='Ref_to_Proto'>MemoryContextAllocZero</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN531"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN25"><span class='Ref_to_Member'>mcxt</span></a><span class='Delimiter'>, 
</span>                               <a href="../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="plpy_procedure.h.html#LN14"><span class='Ref_to_Struct'>PLySavedArgs</span></a><span class='Delimiter'>, </span>namedargs<span class='Parentheses'>) </span><span class='Operator'>+ 
</span>                               <a href="plpy_exec.c.html#LN531"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN38"><span class='Ref_to_Member'>nargs</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span>PyObject <span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="plpy_exec.c.html#LN533"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN18"><span class='Ref_to_Member'>nargs</span></a> <span class='Operator'>= </span><a href="plpy_exec.c.html#LN531"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN38"><span class='Ref_to_Member'>nargs</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Fetch the "args" list */ 
</span>    <a href="plpy_exec.c.html#LN533"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN17"><span class='Ref_to_Member'>args</span></a> <span class='Operator'>= </span>PyDict_GetItemString<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN531"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN43"><span class='Ref_to_Member'>globals</span></a><span class='Delimiter'>, </span><span class='String'>"args"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    Py_XINCREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN533"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN17"><span class='Ref_to_Member'>args</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Fetch all the named arguments */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN531"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN36"><span class='Ref_to_Member'>argnames</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN549"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN549"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="plpy_exec.c.html#LN549"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="plpy_exec.c.html#LN533"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN18"><span class='Ref_to_Member'>nargs</span></a><span class='Delimiter'>; </span><a href="plpy_exec.c.html#LN549"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN531"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN36"><span class='Ref_to_Member'>argnames</span></a><span class='Delimiter'>[</span><a href="plpy_exec.c.html#LN549"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="plpy_exec.c.html#LN533"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN19"><span class='Ref_to_Member'>namedargs</span></a><span class='Delimiter'>[</span><a href="plpy_exec.c.html#LN549"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span>PyDict_GetItemString<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN531"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN43"><span class='Ref_to_Member'>globals</span></a><span class='Delimiter'>, 
</span>                                                          <a href="plpy_exec.c.html#LN531"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN36"><span class='Ref_to_Member'>argnames</span></a><span class='Delimiter'>[</span><a href="plpy_exec.c.html#LN549"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                Py_XINCREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN533"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN19"><span class='Ref_to_Member'>namedargs</span></a><span class='Delimiter'>[</span><a href="plpy_exec.c.html#LN549"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="plpy_exec.c.html#LN533"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PLy_function_save_args &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Restore procedure's arguments from a PLySavedArgs struct, 
 * then free the struct. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN570"></a><span class='Declare_Function'>PLy_function_restore_args</span><span class='Parentheses'>(</span><a href="plpy_procedure.h.html#LN23"><span class='Ref_to_Struct'>PLyProcedure</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proc</span><span class='Delimiter'>, </span><a href="plpy_procedure.h.html#LN14"><span class='Ref_to_Struct'>PLySavedArgs</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>savedargs</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Restore named arguments into their slots in the globals dict */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN570"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN36"><span class='Ref_to_Member'>argnames</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN575"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN575"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="plpy_exec.c.html#LN575"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="plpy_exec.c.html#LN570"><span class='Ref_to_Parameter'>savedargs</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN18"><span class='Ref_to_Member'>nargs</span></a><span class='Delimiter'>; </span><a href="plpy_exec.c.html#LN575"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN570"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN36"><span class='Ref_to_Member'>argnames</span></a><span class='Delimiter'>[</span><a href="plpy_exec.c.html#LN575"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>&& </span><a href="plpy_exec.c.html#LN570"><span class='Ref_to_Parameter'>savedargs</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN19"><span class='Ref_to_Member'>namedargs</span></a><span class='Delimiter'>[</span><a href="plpy_exec.c.html#LN575"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                PyDict_SetItemString<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN570"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN43"><span class='Ref_to_Member'>globals</span></a><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN570"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN36"><span class='Ref_to_Member'>argnames</span></a><span class='Delimiter'>[</span><a href="plpy_exec.c.html#LN575"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                                     <a href="plpy_exec.c.html#LN570"><span class='Ref_to_Parameter'>savedargs</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN19"><span class='Ref_to_Member'>namedargs</span></a><span class='Delimiter'>[</span><a href="plpy_exec.c.html#LN575"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                Py_DECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN570"><span class='Ref_to_Parameter'>savedargs</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN19"><span class='Ref_to_Member'>namedargs</span></a><span class='Delimiter'>[</span><a href="plpy_exec.c.html#LN575"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Restore the "args" object, too */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN570"><span class='Ref_to_Parameter'>savedargs</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN17"><span class='Ref_to_Member'>args</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        PyDict_SetItemString<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN570"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN43"><span class='Ref_to_Member'>globals</span></a><span class='Delimiter'>, </span><span class='String'>"args"</span><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN570"><span class='Ref_to_Parameter'>savedargs</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN17"><span class='Ref_to_Member'>args</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        Py_DECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN570"><span class='Ref_to_Parameter'>savedargs</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN17"><span class='Ref_to_Member'>args</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* And free the PLySavedArgs struct */ 
</span>    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN570"><span class='Ref_to_Parameter'>savedargs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PLy_function_restore_args &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Free a PLySavedArgs struct without restoring the values. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN603"></a><span class='Declare_Function'>PLy_function_drop_args</span><span class='Parentheses'>(</span><a href="plpy_procedure.h.html#LN14"><span class='Ref_to_Struct'>PLySavedArgs</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>savedargs</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN605"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Drop references for named args */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN605"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="plpy_exec.c.html#LN605"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="plpy_exec.c.html#LN603"><span class='Ref_to_Parameter'>savedargs</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN18"><span class='Ref_to_Member'>nargs</span></a><span class='Delimiter'>; </span><a href="plpy_exec.c.html#LN605"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        Py_XDECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN603"><span class='Ref_to_Parameter'>savedargs</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN19"><span class='Ref_to_Member'>namedargs</span></a><span class='Delimiter'>[</span><a href="plpy_exec.c.html#LN605"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Drop ref to the "args" object, too */ 
</span>    Py_XDECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN603"><span class='Ref_to_Parameter'>savedargs</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN17"><span class='Ref_to_Member'>args</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* And free the PLySavedArgs struct */ 
</span>    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN603"><span class='Ref_to_Parameter'>savedargs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Save away any existing arguments for the given procedure, so that we can 
 * install new values for a recursive call.  This should be invoked before 
 * doing PLy_function_build_args(). 
 * 
 * NB: caller must ensure that PLy_global_args_pop gets invoked once, and 
 * only once, per successful completion of PLy_global_args_push.  Otherwise 
 * we'll end up out-of-sync between the actual call stack and the contents 
 * of proc-&GT;argstack. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN631"></a><span class='Declare_Function'>PLy_global_args_push</span><span class='Parentheses'>(</span><a href="plpy_procedure.h.html#LN23"><span class='Ref_to_Struct'>PLyProcedure</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* We only need to push if we are already inside some active call */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN631"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN44"><span class='Ref_to_Member'>calldepth</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN636"></a>        <a href="plpy_procedure.h.html#LN14"><span class='Ref_to_Struct'>PLySavedArgs</span></a> <span class='Operator'>*</span><span class='Declare_Local'>node</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Build a struct containing current argument values */ 
</span>        <a href="plpy_exec.c.html#LN636"><span class='Ref_To_Local'>node</span></a> <span class='Operator'>= </span><a href="plpy_exec.c.html#LN37"><span class='Ref_to_Proto'>PLy_function_save_args</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN631"><span class='Ref_to_Parameter'>proc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Push the saved argument values into the procedure's stack.  Once we 
         * modify either proc-&GT;argstack or proc-&GT;calldepth, we had better 
         * return without the possibility of error. 
         */ 
</span>        <a href="plpy_exec.c.html#LN636"><span class='Ref_To_Local'>node</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN16"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><a href="plpy_exec.c.html#LN631"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN45"><span class='Ref_to_Member'>argstack</span></a><span class='Delimiter'>; 
</span>        <a href="plpy_exec.c.html#LN631"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN45"><span class='Ref_to_Member'>argstack</span></a> <span class='Operator'>= </span><a href="plpy_exec.c.html#LN636"><span class='Ref_To_Local'>node</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="plpy_exec.c.html#LN631"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN44"><span class='Ref_to_Member'>calldepth</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PLy_global_args_push &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Pop old arguments when exiting a recursive call. 
 * 
 * Note: the idea here is to adjust the proc's callstack state before doing 
 * anything that could possibly fail.  In event of any error, we want the 
 * callstack to look like we've done the pop.  Leaking a bit of memory is 
 * tolerable. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN661"></a><span class='Declare_Function'>PLy_global_args_pop</span><span class='Parentheses'>(</span><a href="plpy_procedure.h.html#LN23"><span class='Ref_to_Struct'>PLyProcedure</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN661"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN44"><span class='Ref_to_Member'>calldepth</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* We only need to pop if we were already inside some active call */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN661"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN44"><span class='Ref_to_Member'>calldepth</span></a> <span class='Operator'>&GT; </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN667"></a>        <a href="plpy_procedure.h.html#LN14"><span class='Ref_to_Struct'>PLySavedArgs</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ptr</span> <span class='Operator'>= </span><a href="plpy_exec.c.html#LN661"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN45"><span class='Ref_to_Member'>argstack</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Pop the callstack */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN667"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="plpy_exec.c.html#LN661"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN45"><span class='Ref_to_Member'>argstack</span></a> <span class='Operator'>= </span><a href="plpy_exec.c.html#LN667"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN16"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span>        <a href="plpy_exec.c.html#LN661"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN44"><span class='Ref_to_Member'>calldepth</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Restore argument values, then free ptr */ 
</span>        <a href="plpy_exec.c.html#LN38"><span class='Ref_to_Proto'>PLy_function_restore_args</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN661"><span class='Ref_to_Parameter'>proc</span></a><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN667"><span class='Ref_To_Local'>ptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Exiting call depth 1 */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN661"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN45"><span class='Ref_to_Member'>argstack</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="plpy_exec.c.html#LN661"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN44"><span class='Ref_to_Member'>calldepth</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We used to delete the named arguments (but not "args") from the 
         * proc's globals dict when exiting the outermost call level for a 
         * function.  This seems rather pointless though: nothing can see the 
         * dict until the function is called again, at which time we'll 
         * overwrite those dict entries.  So don't bother with that. 
         */ 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end PLy_global_args_pop &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Memory context deletion callback for cleaning up a PLySRFState. 
 * We need this in case execution of the SRF is terminated early, 
 * due to error or the caller simply not running it to completion. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN699"></a><span class='Declare_Function'>plpython_srf_cleanup_callback</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN701"></a>    <a href="plpy_exec.c.html#LN29"><span class='Ref_to_Struct'>PLySRFState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>srfstate</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN29"><span class='Ref_to_Struct'>PLySRFState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="plpy_exec.c.html#LN699"><span class='Ref_to_Parameter'>arg</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Release refcount on the iter, if we still have one */ 
</span>    Py_XDECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN701"><span class='Ref_To_Local'>srfstate</span></a><span class='Operator'>-&GT;</span><a href="plpy_exec.c.html#LN31"><span class='Ref_to_Member'>iter</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plpy_exec.c.html#LN701"><span class='Ref_To_Local'>srfstate</span></a><span class='Operator'>-&GT;</span><a href="plpy_exec.c.html#LN31"><span class='Ref_to_Member'>iter</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* And drop any saved args; we won't need them */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN701"><span class='Ref_To_Local'>srfstate</span></a><span class='Operator'>-&GT;</span><a href="plpy_exec.c.html#LN32"><span class='Ref_to_Member'>savedargs</span></a><span class='Parentheses'>) 
</span>        <a href="plpy_exec.c.html#LN39"><span class='Ref_to_Proto'>PLy_function_drop_args</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN701"><span class='Ref_To_Local'>srfstate</span></a><span class='Operator'>-&GT;</span><a href="plpy_exec.c.html#LN32"><span class='Ref_to_Member'>savedargs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plpy_exec.c.html#LN701"><span class='Ref_To_Local'>srfstate</span></a><span class='Operator'>-&GT;</span><a href="plpy_exec.c.html#LN32"><span class='Ref_to_Member'>savedargs</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN713"></a><span class='Declare_Function'>plpython_return_error_callback</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN715"></a>    <a href="plpy_main.h.html#LN17"><span class='Ref_to_Struct'>PLyExecutionContext</span></a> <span class='Operator'>*</span><span class='Declare_Local'>exec_ctx</span> <span class='Operator'>= </span><a href="plpy_main.h.html#LN25"><span class='Ref_to_Proto'>PLy_current_execution_context</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN715"><span class='Ref_To_Local'>exec_ctx</span></a><span class='Operator'>-&GT;</span><a href="plpy_main.h.html#LN19"><span class='Ref_to_Member'>curr_proc</span></a><span class='Parentheses'>) 
</span>        errcontext<span class='Parentheses'>(</span><span class='String'>"while creating return value"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static </span>PyObject <span class='Operator'>* 
</span><a name="LN722"></a><span class='Declare_Function'>PLy_trigger_build_args</span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN37"><span class='Ref_to_Typedef'>FunctionCallInfo</span></a> <span class='Declare_Parameter'>fcinfo</span><span class='Delimiter'>, </span><a href="plpy_procedure.h.html#LN23"><span class='Ref_to_Struct'>PLyProcedure</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proc</span><span class='Delimiter'>, </span><a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rv</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN724"></a>    <a href="../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tdata</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="plpy_exec.c.html#LN722"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/fmgr.h.html#LN79"><span class='Ref_to_Member'>context</span></a><span class='Delimiter'>; 
</span><a name="LN725"></a>    PyObject   <span class='Operator'>*</span><span class='Declare_Local'>pltname</span><span class='Delimiter'>, 
</span><a name="LN726"></a>               <span class='Operator'>*</span><span class='Declare_Local'>pltevent</span><span class='Delimiter'>, 
</span><a name="LN727"></a>               <span class='Operator'>*</span><span class='Declare_Local'>pltwhen</span><span class='Delimiter'>, 
</span><a name="LN728"></a>               <span class='Operator'>*</span><span class='Declare_Local'>pltlevel</span><span class='Delimiter'>, 
</span><a name="LN729"></a>               <span class='Operator'>*</span><span class='Declare_Local'>pltrelid</span><span class='Delimiter'>, 
</span><a name="LN730"></a>               <span class='Operator'>*</span><span class='Declare_Local'>plttablename</span><span class='Delimiter'>, 
</span><a name="LN731"></a>               <span class='Operator'>*</span><span class='Declare_Local'>plttableschema</span><span class='Delimiter'>; 
</span><a name="LN732"></a>    PyObject   <span class='Operator'>*</span><span class='Declare_Local'>pltargs</span><span class='Delimiter'>, 
</span><a name="LN733"></a>               <span class='Operator'>*</span><span class='Declare_Local'>pytnew</span><span class='Delimiter'>, 
</span><a name="LN734"></a>               <span class='Operator'>*</span><span class='Declare_Local'>pytold</span><span class='Delimiter'>; 
</span><a name="LN735"></a>    PyObject   <span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Declare_Local'>pltdata</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN736"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>stroid</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <a href="plpy_exec.c.html#LN735"><span class='Ref_To_Local'>pltdata</span></a> <span class='Operator'>= </span>PyDict_New<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plpy_exec.c.html#LN735"><span class='Ref_To_Local'>pltdata</span></a><span class='Parentheses'>) 
</span>            <a href="plpy_elog.c.html#LN45"><span class='Ref_to_Func'>PLy_elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not create new dictionary while building trigger arguments"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="plpy_exec.c.html#LN725"><span class='Ref_To_Local'>pltname</span></a> <span class='Operator'>= </span><a href="plpython.h.html#LN92"><span class='Ref_to_Macro'>PyString_FromString</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN724"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN36"><span class='Ref_to_Member'>tg_trigger</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/reltrigger.h.html#LN26"><span class='Ref_to_Member'>tgname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        PyDict_SetItemString<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN735"><span class='Ref_To_Local'>pltdata</span></a><span class='Delimiter'>, </span><span class='String'>"name"</span><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN725"><span class='Ref_To_Local'>pltname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        Py_DECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN725"><span class='Ref_To_Local'>pltname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="plpy_exec.c.html#LN736"><span class='Ref_To_Local'>stroid</span></a> <span class='Operator'>= </span><a href="../../include/postgres.h.html#LN571"><span class='Ref_to_Macro'>DatumGetCString</span></a><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN583"><span class='Ref_to_Macro'>DirectFunctionCall1</span></a><span class='Parentheses'>(</span><a href="../../backend/utils/adt/oid.c.html#LN125"><span class='Ref_to_Func'>oidout</span></a><span class='Delimiter'>, 
</span>                               <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN724"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN115"><span class='Ref_to_Member'>rd_id</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="plpy_exec.c.html#LN729"><span class='Ref_To_Local'>pltrelid</span></a> <span class='Operator'>= </span><a href="plpython.h.html#LN92"><span class='Ref_to_Macro'>PyString_FromString</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN736"><span class='Ref_To_Local'>stroid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        PyDict_SetItemString<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN735"><span class='Ref_To_Local'>pltdata</span></a><span class='Delimiter'>, </span><span class='String'>"relid"</span><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN729"><span class='Ref_To_Local'>pltrelid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        Py_DECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN729"><span class='Ref_To_Local'>pltrelid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN736"><span class='Ref_To_Local'>stroid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="plpy_exec.c.html#LN736"><span class='Ref_To_Local'>stroid</span></a> <span class='Operator'>= </span><a href="../../include/executor/spi.h.html#LN129"><span class='Ref_to_Proto'>SPI_getrelname</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN724"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="plpy_exec.c.html#LN730"><span class='Ref_To_Local'>plttablename</span></a> <span class='Operator'>= </span><a href="plpython.h.html#LN92"><span class='Ref_to_Macro'>PyString_FromString</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN736"><span class='Ref_To_Local'>stroid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        PyDict_SetItemString<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN735"><span class='Ref_To_Local'>pltdata</span></a><span class='Delimiter'>, </span><span class='String'>"table_name"</span><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN730"><span class='Ref_To_Local'>plttablename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        Py_DECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN730"><span class='Ref_To_Local'>plttablename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN736"><span class='Ref_To_Local'>stroid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="plpy_exec.c.html#LN736"><span class='Ref_To_Local'>stroid</span></a> <span class='Operator'>= </span><a href="../../include/executor/spi.h.html#LN130"><span class='Ref_to_Proto'>SPI_getnspname</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN724"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="plpy_exec.c.html#LN731"><span class='Ref_To_Local'>plttableschema</span></a> <span class='Operator'>= </span><a href="plpython.h.html#LN92"><span class='Ref_to_Macro'>PyString_FromString</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN736"><span class='Ref_To_Local'>stroid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        PyDict_SetItemString<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN735"><span class='Ref_To_Local'>pltdata</span></a><span class='Delimiter'>, </span><span class='String'>"table_schema"</span><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN731"><span class='Ref_To_Local'>plttableschema</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        Py_DECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN731"><span class='Ref_To_Local'>plttableschema</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN736"><span class='Ref_To_Local'>stroid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN87"><span class='Ref_to_Macro'>TRIGGER_FIRED_BEFORE</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN724"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
            <a href="plpy_exec.c.html#LN727"><span class='Ref_To_Local'>pltwhen</span></a> <span class='Operator'>= </span><a href="plpython.h.html#LN92"><span class='Ref_to_Macro'>PyString_FromString</span></a><span class='Parentheses'>(</span><span class='String'>"BEFORE"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN90"><span class='Ref_to_Macro'>TRIGGER_FIRED_AFTER</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN724"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
            <a href="plpy_exec.c.html#LN727"><span class='Ref_To_Local'>pltwhen</span></a> <span class='Operator'>= </span><a href="plpython.h.html#LN92"><span class='Ref_to_Macro'>PyString_FromString</span></a><span class='Parentheses'>(</span><span class='String'>"AFTER"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN93"><span class='Ref_to_Macro'>TRIGGER_FIRED_INSTEAD</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN724"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
            <a href="plpy_exec.c.html#LN727"><span class='Ref_To_Local'>pltwhen</span></a> <span class='Operator'>= </span><a href="plpython.h.html#LN92"><span class='Ref_to_Macro'>PyString_FromString</span></a><span class='Parentheses'>(</span><span class='String'>"INSTEAD OF"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized WHEN tg_event: %u"</span><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN724"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="plpy_exec.c.html#LN727"><span class='Ref_To_Local'>pltwhen</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* keep compiler quiet */ 
</span>        <span class='Delimiter'>} 
</span>        PyDict_SetItemString<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN735"><span class='Ref_To_Local'>pltdata</span></a><span class='Delimiter'>, </span><span class='String'>"when"</span><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN727"><span class='Ref_To_Local'>pltwhen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        Py_DECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN727"><span class='Ref_To_Local'>pltwhen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN81"><span class='Ref_to_Macro'>TRIGGER_FIRED_FOR_ROW</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN724"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="plpy_exec.c.html#LN728"><span class='Ref_To_Local'>pltlevel</span></a> <span class='Operator'>= </span><a href="plpython.h.html#LN92"><span class='Ref_to_Macro'>PyString_FromString</span></a><span class='Parentheses'>(</span><span class='String'>"ROW"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            PyDict_SetItemString<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN735"><span class='Ref_To_Local'>pltdata</span></a><span class='Delimiter'>, </span><span class='String'>"level"</span><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN728"><span class='Ref_To_Local'>pltlevel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            Py_DECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN728"><span class='Ref_To_Local'>pltlevel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN69"><span class='Ref_to_Macro'>TRIGGER_FIRED_BY_INSERT</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN724"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="plpy_exec.c.html#LN726"><span class='Ref_To_Local'>pltevent</span></a> <span class='Operator'>= </span><a href="plpython.h.html#LN92"><span class='Ref_to_Macro'>PyString_FromString</span></a><span class='Parentheses'>(</span><span class='String'>"INSERT"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                PyDict_SetItemString<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN735"><span class='Ref_To_Local'>pltdata</span></a><span class='Delimiter'>, </span><span class='String'>"old"</span><span class='Delimiter'>, </span>Py_None<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="plpy_exec.c.html#LN733"><span class='Ref_To_Local'>pytnew</span></a> <span class='Operator'>= </span><a href="plpy_typeio.h.html#LN116"><span class='Ref_to_Proto'>PLyDict_FromTuple</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN722"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN33"><span class='Ref_to_Member'>result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN724"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN34"><span class='Ref_to_Member'>tg_trigtuple</span></a><span class='Delimiter'>, 
</span>                                           <a href="plpy_exec.c.html#LN724"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                PyDict_SetItemString<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN735"><span class='Ref_To_Local'>pltdata</span></a><span class='Delimiter'>, </span><span class='String'>"new"</span><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN733"><span class='Ref_To_Local'>pytnew</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                Py_DECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN733"><span class='Ref_To_Local'>pytnew</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Operator'>*</span><a href="plpy_exec.c.html#LN722"><span class='Ref_to_Parameter'>rv</span></a> <span class='Operator'>= </span><a href="plpy_exec.c.html#LN724"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN34"><span class='Ref_to_Member'>tg_trigtuple</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN72"><span class='Ref_to_Macro'>TRIGGER_FIRED_BY_DELETE</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN724"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="plpy_exec.c.html#LN726"><span class='Ref_To_Local'>pltevent</span></a> <span class='Operator'>= </span><a href="plpython.h.html#LN92"><span class='Ref_to_Macro'>PyString_FromString</span></a><span class='Parentheses'>(</span><span class='String'>"DELETE"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                PyDict_SetItemString<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN735"><span class='Ref_To_Local'>pltdata</span></a><span class='Delimiter'>, </span><span class='String'>"new"</span><span class='Delimiter'>, </span>Py_None<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="plpy_exec.c.html#LN734"><span class='Ref_To_Local'>pytold</span></a> <span class='Operator'>= </span><a href="plpy_typeio.h.html#LN116"><span class='Ref_to_Proto'>PLyDict_FromTuple</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN722"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN33"><span class='Ref_to_Member'>result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN724"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN34"><span class='Ref_to_Member'>tg_trigtuple</span></a><span class='Delimiter'>, 
</span>                                           <a href="plpy_exec.c.html#LN724"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                PyDict_SetItemString<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN735"><span class='Ref_To_Local'>pltdata</span></a><span class='Delimiter'>, </span><span class='String'>"old"</span><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN734"><span class='Ref_To_Local'>pytold</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                Py_DECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN734"><span class='Ref_To_Local'>pytold</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Operator'>*</span><a href="plpy_exec.c.html#LN722"><span class='Ref_to_Parameter'>rv</span></a> <span class='Operator'>= </span><a href="plpy_exec.c.html#LN724"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN34"><span class='Ref_to_Member'>tg_trigtuple</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN75"><span class='Ref_to_Macro'>TRIGGER_FIRED_BY_UPDATE</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN724"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="plpy_exec.c.html#LN726"><span class='Ref_To_Local'>pltevent</span></a> <span class='Operator'>= </span><a href="plpython.h.html#LN92"><span class='Ref_to_Macro'>PyString_FromString</span></a><span class='Parentheses'>(</span><span class='String'>"UPDATE"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="plpy_exec.c.html#LN733"><span class='Ref_To_Local'>pytnew</span></a> <span class='Operator'>= </span><a href="plpy_typeio.h.html#LN116"><span class='Ref_to_Proto'>PLyDict_FromTuple</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN722"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN33"><span class='Ref_to_Member'>result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN724"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN35"><span class='Ref_to_Member'>tg_newtuple</span></a><span class='Delimiter'>, 
</span>                                           <a href="plpy_exec.c.html#LN724"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                PyDict_SetItemString<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN735"><span class='Ref_To_Local'>pltdata</span></a><span class='Delimiter'>, </span><span class='String'>"new"</span><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN733"><span class='Ref_To_Local'>pytnew</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                Py_DECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN733"><span class='Ref_To_Local'>pytnew</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="plpy_exec.c.html#LN734"><span class='Ref_To_Local'>pytold</span></a> <span class='Operator'>= </span><a href="plpy_typeio.h.html#LN116"><span class='Ref_to_Proto'>PLyDict_FromTuple</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN722"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN33"><span class='Ref_to_Member'>result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN724"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN34"><span class='Ref_to_Member'>tg_trigtuple</span></a><span class='Delimiter'>, 
</span>                                           <a href="plpy_exec.c.html#LN724"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                PyDict_SetItemString<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN735"><span class='Ref_To_Local'>pltdata</span></a><span class='Delimiter'>, </span><span class='String'>"old"</span><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN734"><span class='Ref_To_Local'>pytold</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                Py_DECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN734"><span class='Ref_To_Local'>pytold</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Operator'>*</span><a href="plpy_exec.c.html#LN722"><span class='Ref_to_Parameter'>rv</span></a> <span class='Operator'>= </span><a href="plpy_exec.c.html#LN724"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN35"><span class='Ref_to_Member'>tg_newtuple</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized OP tg_event: %u"</span><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN724"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="plpy_exec.c.html#LN726"><span class='Ref_To_Local'>pltevent</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* keep compiler quiet */ 
</span>            <span class='Delimiter'>} 
</span> 
            PyDict_SetItemString<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN735"><span class='Ref_To_Local'>pltdata</span></a><span class='Delimiter'>, </span><span class='String'>"event"</span><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN726"><span class='Ref_To_Local'>pltevent</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            Py_DECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN726"><span class='Ref_To_Local'>pltevent</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if TRIGGER_FIRED_FOR_ROW... &raquo; </span> 
        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN84"><span class='Ref_to_Macro'>TRIGGER_FIRED_FOR_STATEMENT</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN724"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="plpy_exec.c.html#LN728"><span class='Ref_To_Local'>pltlevel</span></a> <span class='Operator'>= </span><a href="plpython.h.html#LN92"><span class='Ref_to_Macro'>PyString_FromString</span></a><span class='Parentheses'>(</span><span class='String'>"STATEMENT"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            PyDict_SetItemString<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN735"><span class='Ref_To_Local'>pltdata</span></a><span class='Delimiter'>, </span><span class='String'>"level"</span><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN728"><span class='Ref_To_Local'>pltlevel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            Py_DECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN728"><span class='Ref_To_Local'>pltlevel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            PyDict_SetItemString<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN735"><span class='Ref_To_Local'>pltdata</span></a><span class='Delimiter'>, </span><span class='String'>"old"</span><span class='Delimiter'>, </span>Py_None<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            PyDict_SetItemString<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN735"><span class='Ref_To_Local'>pltdata</span></a><span class='Delimiter'>, </span><span class='String'>"new"</span><span class='Delimiter'>, </span>Py_None<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Operator'>*</span><a href="plpy_exec.c.html#LN722"><span class='Ref_to_Parameter'>rv</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN69"><span class='Ref_to_Macro'>TRIGGER_FIRED_BY_INSERT</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN724"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
                <a href="plpy_exec.c.html#LN726"><span class='Ref_To_Local'>pltevent</span></a> <span class='Operator'>= </span><a href="plpython.h.html#LN92"><span class='Ref_to_Macro'>PyString_FromString</span></a><span class='Parentheses'>(</span><span class='String'>"INSERT"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN72"><span class='Ref_to_Macro'>TRIGGER_FIRED_BY_DELETE</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN724"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
                <a href="plpy_exec.c.html#LN726"><span class='Ref_To_Local'>pltevent</span></a> <span class='Operator'>= </span><a href="plpython.h.html#LN92"><span class='Ref_to_Macro'>PyString_FromString</span></a><span class='Parentheses'>(</span><span class='String'>"DELETE"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN75"><span class='Ref_to_Macro'>TRIGGER_FIRED_BY_UPDATE</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN724"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
                <a href="plpy_exec.c.html#LN726"><span class='Ref_To_Local'>pltevent</span></a> <span class='Operator'>= </span><a href="plpython.h.html#LN92"><span class='Ref_to_Macro'>PyString_FromString</span></a><span class='Parentheses'>(</span><span class='String'>"UPDATE"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN78"><span class='Ref_to_Macro'>TRIGGER_FIRED_BY_TRUNCATE</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN724"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
                <a href="plpy_exec.c.html#LN726"><span class='Ref_To_Local'>pltevent</span></a> <span class='Operator'>= </span><a href="plpython.h.html#LN92"><span class='Ref_to_Macro'>PyString_FromString</span></a><span class='Parentheses'>(</span><span class='String'>"TRUNCATE"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized OP tg_event: %u"</span><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN724"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="plpy_exec.c.html#LN726"><span class='Ref_To_Local'>pltevent</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* keep compiler quiet */ 
</span>            <span class='Delimiter'>} 
</span> 
            PyDict_SetItemString<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN735"><span class='Ref_To_Local'>pltdata</span></a><span class='Delimiter'>, </span><span class='String'>"event"</span><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN726"><span class='Ref_To_Local'>pltevent</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            Py_DECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN726"><span class='Ref_To_Local'>pltevent</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if TRIGGER_FIRED_FOR_STA... &raquo; </span> 
        <span class='Control'>else</span> 
            <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized LEVEL tg_event: %u"</span><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN724"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN724"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN36"><span class='Ref_to_Member'>tg_trigger</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/reltrigger.h.html#LN36"><span class='Ref_to_Member'>tgnargs</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * all strings... 
             */ 
</span><a name="LN867"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN868"></a>            PyObject   <span class='Operator'>*</span><span class='Declare_Local'>pltarg</span><span class='Delimiter'>; 
</span> 
            <a href="plpy_exec.c.html#LN732"><span class='Ref_To_Local'>pltargs</span></a> <span class='Operator'>= </span>PyList_New<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN724"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN36"><span class='Ref_to_Member'>tg_trigger</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/reltrigger.h.html#LN36"><span class='Ref_to_Member'>tgnargs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN867"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="plpy_exec.c.html#LN867"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="plpy_exec.c.html#LN724"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN36"><span class='Ref_to_Member'>tg_trigger</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/reltrigger.h.html#LN36"><span class='Ref_to_Member'>tgnargs</span></a><span class='Delimiter'>; </span><a href="plpy_exec.c.html#LN867"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="plpy_exec.c.html#LN868"><span class='Ref_To_Local'>pltarg</span></a> <span class='Operator'>= </span><a href="plpython.h.html#LN92"><span class='Ref_to_Macro'>PyString_FromString</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN724"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN36"><span class='Ref_to_Member'>tg_trigger</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/reltrigger.h.html#LN39"><span class='Ref_to_Member'>tgargs</span></a><span class='Delimiter'>[</span><a href="plpy_exec.c.html#LN867"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * stolen, don't Py_DECREF 
                 */ 
</span>                PyList_SetItem<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN732"><span class='Ref_To_Local'>pltargs</span></a><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN867"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN868"><span class='Ref_To_Local'>pltarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            Py_INCREF<span class='Parentheses'>(</span>Py_None<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="plpy_exec.c.html#LN732"><span class='Ref_To_Local'>pltargs</span></a> <span class='Operator'>= </span>Py_None<span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        PyDict_SetItemString<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN735"><span class='Ref_To_Local'>pltdata</span></a><span class='Delimiter'>, </span><span class='String'>"args"</span><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN732"><span class='Ref_To_Local'>pltargs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        Py_DECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN732"><span class='Ref_To_Local'>pltargs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        Py_XDECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN735"><span class='Ref_To_Local'>pltdata</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN310"><span class='Ref_to_Macro'>PG_RE_THROW</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="plpy_exec.c.html#LN735"><span class='Ref_To_Local'>pltdata</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PLy_trigger_build_args &raquo; </span> 
 
<span class='Keyword'>static </span><a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> 
<a name="LN900"></a><span class='Declare_Function'>PLy_modify_tuple</span><span class='Parentheses'>(</span><a href="plpy_procedure.h.html#LN23"><span class='Ref_to_Struct'>PLyProcedure</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proc</span><span class='Delimiter'>, </span>PyObject <span class='Operator'>*</span><span class='Declare_Parameter'>pltd</span><span class='Delimiter'>, </span><a href="../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tdata</span><span class='Delimiter'>, 
</span><a name="LN901"></a>                 <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>otup</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN903"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>rtup</span><span class='Delimiter'>; 
</span><a name="LN904"></a>    PyObject   <span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Declare_Local'>plntup</span><span class='Delimiter'>; 
</span><a name="LN905"></a>    PyObject   <span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Declare_Local'>plkeys</span><span class='Delimiter'>; 
</span><a name="LN906"></a>    PyObject   <span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Declare_Local'>plval</span><span class='Delimiter'>; 
</span><a name="LN907"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>      <span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Declare_Local'>modvalues</span><span class='Delimiter'>; 
</span><a name="LN908"></a>    <span class='Keyword'>bool</span>       <span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Declare_Local'>modnulls</span><span class='Delimiter'>; 
</span><a name="LN909"></a>    <span class='Keyword'>bool</span>       <span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Declare_Local'>modrepls</span><span class='Delimiter'>; 
</span><a name="LN910"></a>    ErrorContextCallback <span class='Declare_Local'>plerrcontext</span><span class='Delimiter'>; 
</span> 
    <a href="plpy_exec.c.html#LN910"><span class='Ref_To_Local'>plerrcontext</span></a><span class='Operator'>.</span>callback <span class='Operator'>= </span><a href="plpy_exec.c.html#LN49"><span class='Ref_to_Proto'>plpython_trigger_error_callback</span></a><span class='Delimiter'>; 
</span>    <a href="plpy_exec.c.html#LN910"><span class='Ref_To_Local'>plerrcontext</span></a><span class='Operator'>.</span>previous <span class='Operator'>= </span><a href="../../backend/utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a><span class='Delimiter'>; 
</span>    <a href="../../backend/utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a> <span class='Operator'>= &</span><a href="plpy_exec.c.html#LN910"><span class='Ref_To_Local'>plerrcontext</span></a><span class='Delimiter'>; 
</span> 
    <a href="plpy_exec.c.html#LN904"><span class='Ref_To_Local'>plntup</span></a> <span class='Operator'>= </span><a href="plpy_exec.c.html#LN905"><span class='Ref_To_Local'>plkeys</span></a> <span class='Operator'>= </span><a href="plpy_exec.c.html#LN906"><span class='Ref_To_Local'>plval</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="plpy_exec.c.html#LN907"><span class='Ref_To_Local'>modvalues</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="plpy_exec.c.html#LN908"><span class='Ref_To_Local'>modnulls</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="plpy_exec.c.html#LN909"><span class='Ref_To_Local'>modrepls</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span><a name="LN923"></a>        <a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span><span class='Delimiter'>; 
</span><a name="LN924"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>nkeys</span><span class='Delimiter'>, 
</span><a name="LN925"></a>                    <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="plpy_exec.c.html#LN904"><span class='Ref_To_Local'>plntup</span></a> <span class='Operator'>= </span>PyDict_GetItemString<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN900"><span class='Ref_to_Parameter'>pltd</span></a><span class='Delimiter'>, </span><span class='String'>"new"</span><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_OBJECT<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"TD[\"new\"] deleted, cannot modify row"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        Py_INCREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN904"><span class='Ref_To_Local'>plntup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>PyDict_Check<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN904"><span class='Ref_To_Local'>plntup</span></a><span class='Parentheses'>))</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATATYPE_MISMATCH<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"TD[\"new\"] is not a dictionary"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="plpy_exec.c.html#LN905"><span class='Ref_To_Local'>plkeys</span></a> <span class='Operator'>= </span>PyDict_Keys<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN904"><span class='Ref_To_Local'>plntup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="plpy_exec.c.html#LN924"><span class='Ref_To_Local'>nkeys</span></a> <span class='Operator'>= </span>PyList_Size<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN905"><span class='Ref_To_Local'>plkeys</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="plpy_exec.c.html#LN923"><span class='Ref_To_Local'>tupdesc</span></a> <span class='Operator'>= </span><a href="plpy_exec.c.html#LN900"><span class='Ref_to_Parameter'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Delimiter'>; 
</span> 
        <a href="plpy_exec.c.html#LN907"><span class='Ref_To_Local'>modvalues</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN923"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="plpy_exec.c.html#LN908"><span class='Ref_To_Local'>modnulls</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN923"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>bool</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="plpy_exec.c.html#LN909"><span class='Ref_To_Local'>modrepls</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN923"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>bool</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN925"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="plpy_exec.c.html#LN925"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="plpy_exec.c.html#LN924"><span class='Ref_To_Local'>nkeys</span></a><span class='Delimiter'>; </span><a href="plpy_exec.c.html#LN925"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN948"></a>            PyObject   <span class='Operator'>*</span><span class='Declare_Local'>platt</span><span class='Delimiter'>; 
</span><a name="LN949"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>plattstr</span><span class='Delimiter'>; 
</span><a name="LN950"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>attn</span><span class='Delimiter'>; 
</span><a name="LN951"></a>            <a href="plpy_typeio.h.html#LN54"><span class='Ref_to_Struct'>PLyObToDatum</span></a> <span class='Operator'>*</span><span class='Declare_Local'>att</span><span class='Delimiter'>; 
</span> 
            <a href="plpy_exec.c.html#LN948"><span class='Ref_To_Local'>platt</span></a> <span class='Operator'>= </span>PyList_GetItem<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN905"><span class='Ref_To_Local'>plkeys</span></a><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN925"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpython.h.html#LN90"><span class='Ref_to_Macro'>PyString_Check</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN948"><span class='Ref_To_Local'>platt</span></a><span class='Parentheses'>))</span> 
                <a href="plpy_exec.c.html#LN949"><span class='Ref_To_Local'>plattstr</span></a> <span class='Operator'>= </span><a href="plpython.h.html#LN91"><span class='Ref_to_Macro'>PyString_AsString</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN948"><span class='Ref_To_Local'>platt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>PyUnicode_Check<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN948"><span class='Ref_To_Local'>platt</span></a><span class='Parentheses'>))</span> 
                <a href="plpy_exec.c.html#LN949"><span class='Ref_To_Local'>plattstr</span></a> <span class='Operator'>= </span><a href="plpy_util.h.html#LN9"><span class='Ref_to_Proto'>PLyUnicode_AsString</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN948"><span class='Ref_To_Local'>platt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATATYPE_MISMATCH<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"TD[\"new\"] dictionary key at ordinal position %d is not a string"</span><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN925"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <a href="plpy_exec.c.html#LN949"><span class='Ref_To_Local'>plattstr</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* keep compiler quiet */ 
</span>            <span class='Delimiter'>} 
</span>            <a href="plpy_exec.c.html#LN950"><span class='Ref_To_Local'>attn</span></a> <span class='Operator'>= </span><a href="../../include/executor/spi.h.html#LN123"><span class='Ref_to_Proto'>SPI_fnumber</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN923"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN949"><span class='Ref_To_Local'>plattstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN950"><span class='Ref_To_Local'>attn</span></a> <span class='Operator'>== </span><a href="../../include/executor/spi.h.html#LN43"><span class='Ref_to_Const'>SPI_ERROR_NOATTRIBUTE</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_COLUMN<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"key \"%s\" found in TD[\"new\"] does not exist as a column in the triggering row"</span><span class='Delimiter'>, 
</span>                                <a href="plpy_exec.c.html#LN949"><span class='Ref_To_Local'>plattstr</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN950"><span class='Ref_To_Local'>attn</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot set system attribute \"%s\""</span><span class='Delimiter'>, 
</span>                                <a href="plpy_exec.c.html#LN949"><span class='Ref_To_Local'>plattstr</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="plpy_exec.c.html#LN951"><span class='Ref_To_Local'>att</span></a> <span class='Operator'>= &</span><a href="plpy_exec.c.html#LN900"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN33"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN86"><span class='Ref_to_Member'>out</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN77"><span class='Ref_to_Member'>r</span></a><span class='Operator'>.</span><a href="plpy_typeio.h.html#LN70"><span class='Ref_to_Member'>atts</span></a><span class='Delimiter'>[</span><a href="plpy_exec.c.html#LN950"><span class='Ref_To_Local'>attn</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span> 
            <a href="plpy_exec.c.html#LN906"><span class='Ref_To_Local'>plval</span></a> <span class='Operator'>= </span>PyDict_GetItem<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN904"><span class='Ref_To_Local'>plntup</span></a><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN948"><span class='Ref_To_Local'>platt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN906"><span class='Ref_To_Local'>plval</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"Python interpreter is probably corrupted"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            Py_INCREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN906"><span class='Ref_To_Local'>plval</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN906"><span class='Ref_To_Local'>plval</span></a> <span class='Operator'>!= </span>Py_None<span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="plpy_exec.c.html#LN907"><span class='Ref_To_Local'>modvalues</span></a><span class='Delimiter'>[</span><a href="plpy_exec.c.html#LN950"><span class='Ref_To_Local'>attn</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= 
</span>                    <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN951"><span class='Ref_To_Local'>att</span></a><span class='Operator'>-&GT;</span><a href="plpy_typeio.h.html#LN56"><span class='Ref_to_Member'>func</span></a><span class='Parentheses'>) (</span><a href="plpy_exec.c.html#LN951"><span class='Ref_To_Local'>att</span></a><span class='Delimiter'>, 
</span>                                 <a href="plpy_exec.c.html#LN923"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="plpy_exec.c.html#LN950"><span class='Ref_To_Local'>attn</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypmod<span class='Delimiter'>, 
</span>                                 <a href="plpy_exec.c.html#LN906"><span class='Ref_To_Local'>plval</span></a><span class='Delimiter'>, 
</span>                                 <span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="plpy_exec.c.html#LN908"><span class='Ref_To_Local'>modnulls</span></a><span class='Delimiter'>[</span><a href="plpy_exec.c.html#LN950"><span class='Ref_To_Local'>attn</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <a href="plpy_exec.c.html#LN907"><span class='Ref_To_Local'>modvalues</span></a><span class='Delimiter'>[</span><a href="plpy_exec.c.html#LN950"><span class='Ref_To_Local'>attn</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= 
</span>                    <a href="../../include/fmgr.h.html#LN642"><span class='Ref_to_Proto'>InputFunctionCall</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="plpy_exec.c.html#LN951"><span class='Ref_To_Local'>att</span></a><span class='Operator'>-&GT;</span><a href="plpy_typeio.h.html#LN57"><span class='Ref_to_Member'>typfunc</span></a><span class='Delimiter'>, 
</span>                                      <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                      <a href="plpy_exec.c.html#LN951"><span class='Ref_To_Local'>att</span></a><span class='Operator'>-&GT;</span><a href="plpy_typeio.h.html#LN61"><span class='Ref_to_Member'>typioparam</span></a><span class='Delimiter'>, 
</span>                                      <a href="plpy_exec.c.html#LN923"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="plpy_exec.c.html#LN950"><span class='Ref_To_Local'>attn</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypmod<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="plpy_exec.c.html#LN908"><span class='Ref_To_Local'>modnulls</span></a><span class='Delimiter'>[</span><a href="plpy_exec.c.html#LN950"><span class='Ref_To_Local'>attn</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="plpy_exec.c.html#LN909"><span class='Ref_To_Local'>modrepls</span></a><span class='Delimiter'>[</span><a href="plpy_exec.c.html#LN950"><span class='Ref_To_Local'>attn</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
            Py_DECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN906"><span class='Ref_To_Local'>plval</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="plpy_exec.c.html#LN906"><span class='Ref_To_Local'>plval</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;nkeys;i++ &raquo; </span> 
 
        <a href="plpy_exec.c.html#LN903"><span class='Ref_To_Local'>rtup</span></a> <span class='Operator'>= </span><a href="../../backend/access/common/heaptuple.c.html#LN789"><span class='Ref_to_Func'>heap_modify_tuple</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN901"><span class='Ref_to_Parameter'>otup</span></a><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN923"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN907"><span class='Ref_To_Local'>modvalues</span></a><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN908"><span class='Ref_To_Local'>modnulls</span></a><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN909"><span class='Ref_To_Local'>modrepls</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        Py_XDECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN904"><span class='Ref_To_Local'>plntup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        Py_XDECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN905"><span class='Ref_To_Local'>plkeys</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        Py_XDECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN906"><span class='Ref_To_Local'>plval</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN907"><span class='Ref_To_Local'>modvalues</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN907"><span class='Ref_To_Local'>modvalues</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN908"><span class='Ref_To_Local'>modnulls</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN908"><span class='Ref_To_Local'>modnulls</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN909"><span class='Ref_To_Local'>modrepls</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN909"><span class='Ref_To_Local'>modrepls</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/utils/elog.h.html#LN310"><span class='Ref_to_Macro'>PG_RE_THROW</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    Py_DECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN904"><span class='Ref_To_Local'>plntup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    Py_DECREF<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN905"><span class='Ref_To_Local'>plkeys</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN907"><span class='Ref_To_Local'>modvalues</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN908"><span class='Ref_To_Local'>modnulls</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN909"><span class='Ref_To_Local'>modrepls</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../backend/utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a> <span class='Operator'>= </span><a href="plpy_exec.c.html#LN910"><span class='Ref_To_Local'>plerrcontext</span></a><span class='Operator'>.</span>previous<span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="plpy_exec.c.html#LN903"><span class='Ref_To_Local'>rtup</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PLy_modify_tuple &raquo; </span> 
 
<span class='Keyword'>static void 
</span><a name="LN1040"></a><span class='Declare_Function'>plpython_trigger_error_callback</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1042"></a>    <a href="plpy_main.h.html#LN17"><span class='Ref_to_Struct'>PLyExecutionContext</span></a> <span class='Operator'>*</span><span class='Declare_Local'>exec_ctx</span> <span class='Operator'>= </span><a href="plpy_main.h.html#LN25"><span class='Ref_to_Proto'>PLy_current_execution_context</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN1042"><span class='Ref_To_Local'>exec_ctx</span></a><span class='Operator'>-&GT;</span><a href="plpy_main.h.html#LN19"><span class='Ref_to_Member'>curr_proc</span></a><span class='Parentheses'>) 
</span>        errcontext<span class='Parentheses'>(</span><span class='String'>"while modifying trigger row"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* execute Python code, propagate Python errors to the backend */ 
</span><span class='Keyword'>static </span>PyObject <span class='Operator'>* 
</span><a name="LN1050"></a><span class='Declare_Function'>PLy_procedure_call</span><span class='Parentheses'>(</span><a href="plpy_procedure.h.html#LN23"><span class='Ref_to_Struct'>PLyProcedure</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proc</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>kargs</span><span class='Delimiter'>, </span>PyObject <span class='Operator'>*</span><span class='Declare_Parameter'>vargs</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1052"></a>    PyObject   <span class='Operator'>*</span><span class='Declare_Local'>rv</span><span class='Delimiter'>; 
</span><a name="LN1053"></a>    <span class='Keyword'>int volatile </span><span class='Declare_Local'>save_subxact_level</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="plpy_subxactobject.c.html#LN18"><span class='Ref_to_Global_Var'>explicit_subtransactions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    PyDict_SetItemString<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN1050"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN43"><span class='Ref_to_Member'>globals</span></a><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN1050"><span class='Ref_to_Parameter'>kargs</span></a><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN1050"><span class='Ref_to_Parameter'>vargs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span><span class='Directive'>#if</span> PY_VERSION_HEX <span class='Operator'>&GT;= </span><span class='Number'>0x03020000</span> 
        <a href="plpy_exec.c.html#LN1052"><span class='Ref_To_Local'>rv</span></a> <span class='Operator'>= </span>PyEval_EvalCode<span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN1050"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN41"><span class='Ref_to_Member'>code</span></a><span class='Delimiter'>, 
</span>                             <a href="plpy_exec.c.html#LN1050"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN43"><span class='Ref_to_Member'>globals</span></a><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN1050"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN43"><span class='Ref_to_Member'>globals</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
        <a href="plpy_exec.c.html#LN1052"><span class='Ref_To_Local'>rv</span></a> <span class='Operator'>= </span>PyEval_EvalCode<span class='Parentheses'>((</span>PyCodeObject <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="plpy_exec.c.html#LN1050"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN41"><span class='Ref_to_Member'>code</span></a><span class='Delimiter'>, 
</span>                             <a href="plpy_exec.c.html#LN1050"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN43"><span class='Ref_to_Member'>globals</span></a><span class='Delimiter'>, </span><a href="plpy_exec.c.html#LN1050"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="plpy_procedure.h.html#LN43"><span class='Ref_to_Member'>globals</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Since plpy will only let you close subtransactions that you 
         * started, you cannot *unnest* subtransactions, only *nest* them 
         * without closing. 
         */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="plpy_subxactobject.c.html#LN18"><span class='Ref_to_Global_Var'>explicit_subtransactions</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><a href="plpy_exec.c.html#LN1053"><span class='Ref_To_Local'>save_subxact_level</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <a href="plpy_exec.c.html#LN52"><span class='Ref_to_Proto'>PLy_abort_open_subtransactions</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN1053"><span class='Ref_To_Local'>save_subxact_level</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN310"><span class='Ref_to_Macro'>PG_RE_THROW</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="plpy_exec.c.html#LN52"><span class='Ref_to_Proto'>PLy_abort_open_subtransactions</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN1053"><span class='Ref_To_Local'>save_subxact_level</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If the Python code returned an error, propagate it */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN1052"><span class='Ref_To_Local'>rv</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="plpy_elog.c.html#LN45"><span class='Ref_to_Func'>PLy_elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="plpy_exec.c.html#LN1052"><span class='Ref_To_Local'>rv</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PLy_procedure_call &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Abort lingering subtransactions that have been explicitly started 
 * by plpy.subtransaction().start() and not properly closed. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1095"></a><span class='Declare_Function'>PLy_abort_open_subtransactions</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>save_subxact_level</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN1095"><span class='Ref_to_Parameter'>save_subxact_level</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="plpy_subxactobject.c.html#LN18"><span class='Ref_to_Global_Var'>explicit_subtransactions</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><a href="plpy_exec.c.html#LN1095"><span class='Ref_to_Parameter'>save_subxact_level</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1101"></a>        <a href="plpy_subxactobject.h.html#LN22"><span class='Ref_to_Struct'>PLySubtransactionData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>subtransactiondata</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plpy_subxactobject.c.html#LN18"><span class='Ref_to_Global_Var'>explicit_subtransactions</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"forcibly aborting a subtransaction that has not been exited"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/access/xact.h.html#LN360"><span class='Ref_to_Proto'>RollbackAndReleaseCurrentSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="plpy_exec.c.html#LN1101"><span class='Ref_To_Local'>subtransactiondata</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="plpy_subxactobject.h.html#LN22"><span class='Ref_to_Struct'>PLySubtransactionData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN110"><span class='Ref_to_Macro'>linitial</span></a><span class='Parentheses'>(</span><a href="plpy_subxactobject.c.html#LN18"><span class='Ref_to_Global_Var'>explicit_subtransactions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="plpy_subxactobject.c.html#LN18"><span class='Ref_to_Global_Var'>explicit_subtransactions</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN237"><span class='Ref_to_Proto'>list_delete_first</span></a><span class='Parentheses'>(</span><a href="plpy_subxactobject.c.html#LN18"><span class='Ref_to_Global_Var'>explicit_subtransactions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN1101"><span class='Ref_To_Local'>subtransactiondata</span></a><span class='Operator'>-&GT;</span><a href="plpy_subxactobject.h.html#LN24"><span class='Ref_to_Member'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../backend/utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="plpy_exec.c.html#LN1101"><span class='Ref_To_Local'>subtransactiondata</span></a><span class='Operator'>-&GT;</span><a href="plpy_subxactobject.h.html#LN25"><span class='Ref_to_Member'>oldowner</span></a><span class='Delimiter'>; 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="plpy_exec.c.html#LN1101"><span class='Ref_To_Local'>subtransactiondata</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end PLy_abort_open_subtransactions &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>