<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\pl\tcl\pltcl.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\pl\tcl\pltcl.c</b></p></td>
<td align='right'>
Wed Jun 14 08:26:13 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/********************************************************************** 
 * pltcl.c      - PostgreSQL support for Tcl as 
 *                procedural language (PL) 
 * 
 *    src/pl/tcl/pltcl.c 
 * 
 **********************************************************************/ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;tcl.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;fcntl.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/htup_details.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/objectaccess.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_proc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_type.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/event_trigger.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/trigger.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"executor/spi.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"fmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"funcapi.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"mb/pg_wchar.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"nodes/makefuncs.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"parser/parse_func.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"parser/parse_type.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pgstat.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"tcop/tcopprot.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/lsyscache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/regproc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/rel.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/syscache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/typcache.h"</span> 
 
 
<a href="../../include/fmgr.h.html#LN442"><span class='Ref_to_Const'>PG_MODULE_MAGIC</span></a><span class='Delimiter'>; 
</span> 
<a name="LN43"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>HAVE_TCL_VERSION</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>maj</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>min</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Parentheses'>((</span>TCL_MAJOR_VERSION <span class='Operator'>&GT; </span><a href="pltcl.c.html#LN43"><span class='Ref_to_Parameter'>maj</span></a><span class='Parentheses'>) </span><span class='Operator'>|| \ 
</span>     <span class='Parentheses'>(</span>TCL_MAJOR_VERSION <span class='Operator'>== </span><a href="pltcl.c.html#LN43"><span class='Ref_to_Parameter'>maj</span></a> <span class='Operator'>&& </span>TCL_MINOR_VERSION <span class='Operator'>&GT;= </span><a href="pltcl.c.html#LN43"><span class='Ref_to_Parameter'>min</span></a><span class='Parentheses'>))</span> 
 
<span class='Comment_Multi_Line'>/* Insist on Tcl &GT;= 8.4 */ 
</span><span class='Directive'>#if</span> <span class='Operator'>!</span><a href="pltcl.c.html#LN43"><span class='Ref_to_Macro'>HAVE_TCL_VERSION</span></a><span class='Parentheses'>(</span><span class='Number'>8</span><span class='Delimiter'>,</span><span class='Number'>4</span><span class='Parentheses'>) 
</span>#error PostgreSQL only supports Tcl <span class='Number'>8</span><span class='Operator'>.</span><span class='Number'>4</span> or later<span class='Operator'>. 
</span><span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* Hack to deal with Tcl 8.6 const-ification without losing compatibility */ 
</span><span class='Directive'>#ifndef</span> <a href="pltcl.c.html#LN54"><span class='Ref_to_Const'>CONST86</span></a> 
<a name="LN54"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>CONST86</span> 
<span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* define our text domain for translations */ 
</span><span class='Keyword'>#undef </span><a href="../plpgsql/src/plpgsql.h.html#LN29"><span class='Ref_to_Const'>TEXTDOMAIN</span></a> 
<a name="LN59"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>TEXTDOMAIN</span> <a href="../../include/c.h.html#LN1009"><span class='Ref_to_Macro'>PG_TEXTDOMAIN</span></a><span class='Parentheses'>(</span><span class='String'>"pltcl"</span><span class='Parentheses'>) 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Support for converting between UTF8 (which is what all strings going into 
 * or out of Tcl should be) and the database encoding. 
 * 
 * If you just use utf_u2e() or utf_e2u() directly, they will leak some 
 * palloc'd space when doing a conversion.  This is not worth worrying about 
 * if it only happens, say, once per PL/Tcl function call.  If it does seem 
 * worth worrying about, use the wrapper macros. 
 */ 
</span> 
<span class='Keyword'>static inline char </span><span class='Operator'>* 
</span><a name="LN73"></a><span class='Declare_Function'>utf_u2e</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>src</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="../../include/mb/pg_wchar.h.html#LN566"><span class='Ref_to_Proto'>pg_any_to_server</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN73"><span class='Ref_to_Parameter'>src</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="pltcl.c.html#LN73"><span class='Ref_to_Parameter'>src</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../fe_utils/mbprint.c.html#LN42"><span class='Ref_to_Const'>PG_UTF8</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static inline char </span><span class='Operator'>* 
</span><a name="LN79"></a><span class='Declare_Function'>utf_e2u</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>src</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="../../include/mb/pg_wchar.h.html#LN567"><span class='Ref_to_Proto'>pg_server_to_any</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN79"><span class='Ref_to_Parameter'>src</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="pltcl.c.html#LN79"><span class='Ref_to_Parameter'>src</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../fe_utils/mbprint.c.html#LN42"><span class='Ref_to_Const'>PG_UTF8</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<a name="LN84"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>UTF_BEGIN</span> <span class='Operator'>\ 
</span>    <span class='Control'>do</span> <span class='Delimiter'>{ </span><span class='Operator'>\ 
</span>        <span class='Keyword'>const char </span><span class='Operator'>*</span>_pltcl_utf_src <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>        <span class='Keyword'>char </span><span class='Operator'>*</span>_pltcl_utf_dst <span class='Operator'>= </span><span class='Null_Value'>NULL 
</span> 
<a name="LN89"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>UTF_END</span> <span class='Operator'>\ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>_pltcl_utf_src <span class='Operator'>!= </span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Parentheses'>) </span>_pltcl_utf_dst<span class='Parentheses'>)</span> <span class='Operator'>\ 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span>_pltcl_utf_dst<span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>    <span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>) 
</span> 
<a name="LN94"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>UTF_U2E</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>x</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Parentheses'>(</span>_pltcl_utf_dst <span class='Operator'>= </span><a href="../plperl/plperl_helpers.h.html#LN10"><span class='Ref_to_Func'>utf_u2e</span></a><span class='Parentheses'>(</span>_pltcl_utf_src <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN94"><span class='Ref_to_Parameter'>x</span></a><span class='Parentheses'>)))</span> 
 
<a name="LN97"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>UTF_E2U</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>x</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Parentheses'>(</span>_pltcl_utf_dst <span class='Operator'>= </span><a href="../plperl/plperl_helpers.h.html#LN29"><span class='Ref_to_Func'>utf_e2u</span></a><span class='Parentheses'>(</span>_pltcl_utf_src <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN97"><span class='Ref_to_Parameter'>x</span></a><span class='Parentheses'>)))</span> 
 
 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * Information associated with a Tcl interpreter.  We have one interpreter 
 * that is used for all pltclu (untrusted) functions.  For pltcl (trusted) 
 * functions, there is a separate interpreter for each effective SQL userid. 
 * (This is needed to ensure that an unprivileged user can't inject Tcl code 
 * that'll be executed with the privileges of some other SQL user.) 
 * 
 * The pltcl_interp_desc structs are kept in a Postgres hash table indexed 
 * by userid OID, with OID 0 used for the single untrusted interpreter. 
 **********************************************************************/ 
</span><a name="LN111"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>pltcl_interp_desc</span> 
<span class='Delimiter'>{ 
</span><a name="LN113"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>user_id</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* Hash key (must be first!) */ 
</span><a name="LN114"></a>    Tcl_Interp <span class='Operator'>*</span><span class='Declare_Member'>interp</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* The interpreter */ 
</span><a name="LN115"></a>    Tcl_HashTable <span class='Declare_Member'>query_hash</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* pltcl_query_desc structs */ 
</span><a name="LN116"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>pltcl_interp_desc</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * The information we cache about loaded procedures 
 * 
 * The pltcl_proc_desc struct itself, as well as all subsidiary data, 
 * is stored in the memory context identified by the fn_cxt field. 
 * We can reclaim all the data by deleting that context, and should do so 
 * when the fn_refcount goes to zero.  (But note that we do not bother 
 * trying to clean up Tcl's copy of the procedure definition: it's Tcl's 
 * problem to manage its memory when we replace a proc definition.  We do 
 * not clean up pltcl_proc_descs when a pg_proc row is deleted, only when 
 * it is updated, and the same policy applies to Tcl's copy as well.) 
 * 
 * Note that the data in this struct is shared across all active calls; 
 * nothing except the fn_refcount should be changed by a call instance. 
 **********************************************************************/ 
</span><a name="LN134"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>pltcl_proc_desc</span> 
<span class='Delimiter'>{ 
</span><a name="LN136"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Member'>user_proname</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* user's name (from pg_proc.proname) */ 
</span><a name="LN137"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Member'>internal_proname</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* Tcl name (based on function OID) */ 
</span><a name="LN138"></a>    <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Member'>fn_cxt</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* memory context for this procedure */ 
</span><a name="LN139"></a>    <span class='Keyword'>unsigned long </span><span class='Declare_Member'>fn_refcount</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* number of active references */ 
</span><a name="LN140"></a>    <a href="../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Member'>fn_xmin</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* xmin of pg_proc row */ 
</span><a name="LN141"></a>    <a href="../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a> <span class='Declare_Member'>fn_tid</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* TID of pg_proc row */ 
</span><a name="LN142"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>fn_readonly</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* is function readonly? */ 
</span><a name="LN143"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>lanpltrusted</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* is it pltcl (vs. pltclu)? */ 
</span><a name="LN144"></a>    <a href="pltcl.c.html#LN111"><span class='Ref_to_Struct'>pltcl_interp_desc</span></a> <span class='Operator'>*</span><span class='Declare_Member'>interp_desc</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* interpreter to use */ 
</span><a name="LN145"></a>    <a href="../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a>    <span class='Declare_Member'>result_in_func</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* input function for fn's result type */ 
</span><a name="LN146"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>result_typioparam</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* param to pass to same */ 
</span><a name="LN147"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>fn_retisset</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* true if function returns a set */ 
</span><a name="LN148"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>fn_retistuple</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* true if function returns composite */ 
</span><a name="LN149"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>nargs</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* number of arguments */ 
</span>    <span class='Comment_Multi_Line'>/* these arrays have nargs entries: */ 
</span><a name="LN151"></a>    <a href="../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a>   <span class='Operator'>*</span><span class='Declare_Member'>arg_out_func</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* output fns for arg types */ 
</span><a name="LN152"></a>    <span class='Keyword'>bool</span>       <span class='Operator'>*</span><span class='Declare_Member'>arg_is_rowtype</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* is each arg composite? */ 
</span><a name="LN153"></a><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end pltcl_proc_desc &raquo; </span> <span class='Declare_Typedef'>pltcl_proc_desc</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * The information we cache about prepared and saved plans 
 **********************************************************************/ 
</span><a name="LN159"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>pltcl_query_desc</span> 
<span class='Delimiter'>{ 
</span><a name="LN161"></a>    <span class='Keyword'>char</span>        <span class='Declare_Member'>qname</span><span class='Delimiter'>[</span><span class='Number'>20</span><span class='Delimiter'>]; 
</span><a name="LN162"></a>    <a href="../../include/executor/spi.h.html#LN33"><span class='Ref_to_Typedef'>SPIPlanPtr</span></a>  <span class='Declare_Member'>plan</span><span class='Delimiter'>; 
</span><a name="LN163"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>nargs</span><span class='Delimiter'>; 
</span><a name="LN164"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>        <span class='Operator'>*</span><span class='Declare_Member'>argtypes</span><span class='Delimiter'>; 
</span><a name="LN165"></a>    <a href="../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a>   <span class='Operator'>*</span><span class='Declare_Member'>arginfuncs</span><span class='Delimiter'>; 
</span><a name="LN166"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>        <span class='Operator'>*</span><span class='Declare_Member'>argtypioparams</span><span class='Delimiter'>; 
</span><a name="LN167"></a>} <span class='Declare_Typedef'>pltcl_query_desc</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * For speedy lookup, we maintain a hash table mapping from 
 * function OID + trigger flag + user OID to pltcl_proc_desc pointers. 
 * The reason the pltcl_proc_desc struct isn't directly part of the hash 
 * entry is to simplify recovery from errors during compile_pltcl_function. 
 * 
 * Note: if the same function is called by multiple userIDs within a session, 
 * there will be a separate pltcl_proc_desc entry for each userID in the case 
 * of pltcl functions, but only one entry for pltclu functions, because we 
 * set user_id = 0 for that case. 
 **********************************************************************/ 
</span><a name="LN181"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>pltcl_proc_key</span> 
<span class='Delimiter'>{ 
</span><a name="LN183"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>proc_id</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* Function OID */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * is_trigger is really a bool, but declare as Oid to ensure this struct 
     * contains no padding 
     */ 
</span><a name="LN189"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>is_trigger</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* is it a trigger function? */ 
</span><a name="LN190"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>user_id</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* User calling the function, or 0 */ 
</span><a name="LN191"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>pltcl_proc_key</span><span class='Delimiter'>; 
</span> 
<a name="LN193"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>pltcl_proc_ptr</span> 
<span class='Delimiter'>{ 
</span><a name="LN195"></a>    <a href="pltcl.c.html#LN181"><span class='Ref_to_Struct'>pltcl_proc_key</span></a> <span class='Declare_Member'>proc_key</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* Hash key (must be first!) */ 
</span><a name="LN196"></a>    <a href="pltcl.c.html#LN134"><span class='Ref_to_Struct'>pltcl_proc_desc</span></a> <span class='Operator'>*</span><span class='Declare_Member'>proc_ptr</span><span class='Delimiter'>; 
</span><a name="LN197"></a>} <span class='Declare_Typedef'>pltcl_proc_ptr</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * Per-call state 
 **********************************************************************/ 
</span><a name="LN203"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>pltcl_call_state</span> 
<span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Call info struct, or NULL in a trigger */ 
</span><a name="LN206"></a>    <a href="../../include/fmgr.h.html#LN37"><span class='Ref_to_Typedef'>FunctionCallInfo</span></a> <span class='Declare_Member'>fcinfo</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Trigger data, if we're in a normal (not event) trigger; else NULL */ 
</span><a name="LN209"></a>    <a href="../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Declare_Member'>trigdata</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Function we're executing (NULL if not yet identified) */ 
</span><a name="LN212"></a>    <a href="pltcl.c.html#LN134"><span class='Ref_to_Struct'>pltcl_proc_desc</span></a> <span class='Operator'>*</span><span class='Declare_Member'>prodesc</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Information for SRFs and functions returning composite types. 
     * ret_tupdesc and attinmeta are set up if either fn_retistuple or 
     * fn_retisset, since even a scalar-returning SRF needs a tuplestore. 
     */ 
</span><a name="LN219"></a>    <a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Member'>ret_tupdesc</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* return rowtype, if retistuple or retisset */ 
</span><a name="LN220"></a>    <a href="../../include/funcapi.h.html#LN34"><span class='Ref_to_Struct'>AttInMetadata</span></a> <span class='Operator'>*</span><span class='Declare_Member'>attinmeta</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* metadata for building tuples of that type */ 
</span> 
<a name="LN222"></a>    <a href="../../include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a> <span class='Operator'>*</span><span class='Declare_Member'>rsi</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* passed-in ReturnSetInfo, if any */ 
</span><a name="LN223"></a>    <a href="../../backend/utils/sort/tuplestore.c.html#LN102"><span class='Ref_to_Struct'>Tuplestorestate</span></a> <span class='Operator'>*</span><span class='Declare_Member'>tuple_store</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* SRFs accumulate result here */ 
</span><a name="LN224"></a>    <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Member'>tuple_store_cxt</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* context and resowner for tuplestore */ 
</span><a name="LN225"></a>    <a href="../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Member'>tuple_store_owner</span><span class='Delimiter'>; 
</span><a name="LN226"></a>}<span class='Auto_Annotations'> &laquo; end pltcl_call_state &raquo; </span> <span class='Declare_Typedef'>pltcl_call_state</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * Global data 
 **********************************************************************/ 
</span><a name="LN232"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Var'>pltcl_start_proc</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN233"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Var'>pltclu_start_proc</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN234"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>pltcl_pm_init_done</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN235"></a><span class='Keyword'>static </span>Tcl_Interp <span class='Operator'>*</span><span class='Declare_Var'>pltcl_hold_interp</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN236"></a><span class='Keyword'>static </span><a href="../../backend/utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Var'>pltcl_interp_htab</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN237"></a><span class='Keyword'>static </span><a href="../../backend/utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Var'>pltcl_proc_htab</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* this is saved and restored by pltcl_handler */ 
</span><a name="LN240"></a><span class='Keyword'>static </span><a href="pltcl.c.html#LN203"><span class='Ref_to_Struct'>pltcl_call_state</span></a> <span class='Operator'>*</span><span class='Declare_Var'>pltcl_current_call_state</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * Lookup table for SQLSTATE condition names 
 **********************************************************************/ 
</span><span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN247"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Member'>label</span><span class='Delimiter'>; 
</span><a name="LN248"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>sqlerrstate</span><span class='Delimiter'>; 
</span><a name="LN249"></a>} <span class='Declare_Typedef'>TclExceptionNameMap</span><span class='Delimiter'>; 
</span> 
<a name="LN251"></a><span class='Keyword'>static const </span><a href="pltcl.c.html#LN245"><span class='Ref_to_Typedef'>TclExceptionNameMap</span></a> <span class='Declare_Var'>exception_name_map</span><span class='Delimiter'>[] </span><span class='Operator'>= </span><span class='Delimiter'>{ 
</span><span class='Keyword'>#include </span><span class='String'>"pltclerrcodes.h"</span>      <span class='Comment_Single_Line'>/* pgrminclude ignore */ 
</span>    <span class='Delimiter'>{</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>} 
}; 
</span> 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * Forward declarations 
 **********************************************************************/ 
</span><a name="LN259"></a><span class='Keyword'>void</span>        <span class='Declare_Prototype'>_PG_init</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN261"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pltcl_init_interp</span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN111"><span class='Ref_to_Struct'>pltcl_interp_desc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>interp_desc</span><span class='Delimiter'>, 
</span><a name="LN262"></a>                  <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>prolang</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>pltrusted</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN263"></a><span class='Keyword'>static </span><a href="pltcl.c.html#LN111"><span class='Ref_to_Struct'>pltcl_interp_desc</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>pltcl_fetch_interp</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>prolang</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>pltrusted</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN264"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>call_pltcl_start_proc</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>prolang</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>pltrusted</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN265"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>start_proc_error_callback</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN267"></a><span class='Keyword'>static </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Prototype'>pltcl_handler</span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>pltrusted</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN269"></a><span class='Keyword'>static </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Prototype'>pltcl_func_handler</span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN203"><span class='Ref_to_Struct'>pltcl_call_state</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>call_state</span><span class='Delimiter'>, 
</span><a name="LN270"></a>                   <span class='Keyword'>bool </span><span class='Declare_Parameter'>pltrusted</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN271"></a><span class='Keyword'>static </span><a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Prototype'>pltcl_trigger_handler</span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN203"><span class='Ref_to_Struct'>pltcl_call_state</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>call_state</span><span class='Delimiter'>, 
</span><a name="LN272"></a>                      <span class='Keyword'>bool </span><span class='Declare_Parameter'>pltrusted</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN273"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pltcl_event_trigger_handler</span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN203"><span class='Ref_to_Struct'>pltcl_call_state</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>call_state</span><span class='Delimiter'>, 
</span><a name="LN274"></a>                            <span class='Keyword'>bool </span><span class='Declare_Parameter'>pltrusted</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN276"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>throw_tcl_error</span><span class='Parentheses'>(</span>Tcl_Interp <span class='Operator'>*</span><span class='Declare_Parameter'>interp</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>proname</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN278"></a><span class='Keyword'>static </span><a href="pltcl.c.html#LN134"><span class='Ref_to_Struct'>pltcl_proc_desc</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>compile_pltcl_function</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>fn_oid</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>tgreloid</span><span class='Delimiter'>, 
</span><a name="LN279"></a>                       <span class='Keyword'>bool </span><span class='Declare_Parameter'>is_event_trigger</span><span class='Delimiter'>, 
</span><a name="LN280"></a>                       <span class='Keyword'>bool </span><span class='Declare_Parameter'>pltrusted</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN282"></a><span class='Keyword'>static int </span><span class='Declare_Prototype'>pltcl_elog</span><span class='Parentheses'>(</span>ClientData <span class='Declare_Parameter'>cdata</span><span class='Delimiter'>, </span>Tcl_Interp <span class='Operator'>*</span><span class='Declare_Parameter'>interp</span><span class='Delimiter'>, 
</span><a name="LN283"></a>           <span class='Keyword'>int </span><span class='Declare_Parameter'>objc</span><span class='Delimiter'>, </span>Tcl_Obj <span class='Operator'>*</span><span class='Keyword'>const </span><span class='Declare_Parameter'>objv</span><span class='Delimiter'>[]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN284"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pltcl_construct_errorCode</span><span class='Parentheses'>(</span>Tcl_Interp <span class='Operator'>*</span><span class='Declare_Parameter'>interp</span><span class='Delimiter'>, </span><a href="../../include/utils/elog.h.html#LN328"><span class='Ref_to_Struct'>ErrorData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>edata</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN285"></a><span class='Keyword'>static const char </span><span class='Operator'>*</span><span class='Declare_Prototype'>pltcl_get_condition_name</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>sqlstate</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN286"></a><span class='Keyword'>static int </span><span class='Declare_Prototype'>pltcl_quote</span><span class='Parentheses'>(</span>ClientData <span class='Declare_Parameter'>cdata</span><span class='Delimiter'>, </span>Tcl_Interp <span class='Operator'>*</span><span class='Declare_Parameter'>interp</span><span class='Delimiter'>, 
</span><a name="LN287"></a>            <span class='Keyword'>int </span><span class='Declare_Parameter'>objc</span><span class='Delimiter'>, </span>Tcl_Obj <span class='Operator'>*</span><span class='Keyword'>const </span><span class='Declare_Parameter'>objv</span><span class='Delimiter'>[]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN288"></a><span class='Keyword'>static int </span><span class='Declare_Prototype'>pltcl_argisnull</span><span class='Parentheses'>(</span>ClientData <span class='Declare_Parameter'>cdata</span><span class='Delimiter'>, </span>Tcl_Interp <span class='Operator'>*</span><span class='Declare_Parameter'>interp</span><span class='Delimiter'>, 
</span><a name="LN289"></a>                <span class='Keyword'>int </span><span class='Declare_Parameter'>objc</span><span class='Delimiter'>, </span>Tcl_Obj <span class='Operator'>*</span><span class='Keyword'>const </span><span class='Declare_Parameter'>objv</span><span class='Delimiter'>[]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN290"></a><span class='Keyword'>static int </span><span class='Declare_Prototype'>pltcl_returnnull</span><span class='Parentheses'>(</span>ClientData <span class='Declare_Parameter'>cdata</span><span class='Delimiter'>, </span>Tcl_Interp <span class='Operator'>*</span><span class='Declare_Parameter'>interp</span><span class='Delimiter'>, 
</span><a name="LN291"></a>                 <span class='Keyword'>int </span><span class='Declare_Parameter'>objc</span><span class='Delimiter'>, </span>Tcl_Obj <span class='Operator'>*</span><span class='Keyword'>const </span><span class='Declare_Parameter'>objv</span><span class='Delimiter'>[]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN292"></a><span class='Keyword'>static int </span><span class='Declare_Prototype'>pltcl_returnnext</span><span class='Parentheses'>(</span>ClientData <span class='Declare_Parameter'>cdata</span><span class='Delimiter'>, </span>Tcl_Interp <span class='Operator'>*</span><span class='Declare_Parameter'>interp</span><span class='Delimiter'>, 
</span><a name="LN293"></a>                 <span class='Keyword'>int </span><span class='Declare_Parameter'>objc</span><span class='Delimiter'>, </span>Tcl_Obj <span class='Operator'>*</span><span class='Keyword'>const </span><span class='Declare_Parameter'>objv</span><span class='Delimiter'>[]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN294"></a><span class='Keyword'>static int </span><span class='Declare_Prototype'>pltcl_SPI_execute</span><span class='Parentheses'>(</span>ClientData <span class='Declare_Parameter'>cdata</span><span class='Delimiter'>, </span>Tcl_Interp <span class='Operator'>*</span><span class='Declare_Parameter'>interp</span><span class='Delimiter'>, 
</span><a name="LN295"></a>                  <span class='Keyword'>int </span><span class='Declare_Parameter'>objc</span><span class='Delimiter'>, </span>Tcl_Obj <span class='Operator'>*</span><span class='Keyword'>const </span><span class='Declare_Parameter'>objv</span><span class='Delimiter'>[]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN296"></a><span class='Keyword'>static int </span><span class='Declare_Prototype'>pltcl_process_SPI_result</span><span class='Parentheses'>(</span>Tcl_Interp <span class='Operator'>*</span><span class='Declare_Parameter'>interp</span><span class='Delimiter'>, 
</span><a name="LN297"></a>                         <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>arrayname</span><span class='Delimiter'>, 
</span><a name="LN298"></a>                         Tcl_Obj <span class='Operator'>*</span><span class='Declare_Parameter'>loop_body</span><span class='Delimiter'>, 
</span><a name="LN299"></a>                         <span class='Keyword'>int </span><span class='Declare_Parameter'>spi_rc</span><span class='Delimiter'>, 
</span><a name="LN300"></a>                         <a href="../../include/executor/spi.h.html#LN21"><span class='Ref_to_Struct'>SPITupleTable</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tuptable</span><span class='Delimiter'>, 
</span><a name="LN301"></a>                         <a href="../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a> <span class='Declare_Parameter'>ntuples</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN302"></a><span class='Keyword'>static int </span><span class='Declare_Prototype'>pltcl_SPI_prepare</span><span class='Parentheses'>(</span>ClientData <span class='Declare_Parameter'>cdata</span><span class='Delimiter'>, </span>Tcl_Interp <span class='Operator'>*</span><span class='Declare_Parameter'>interp</span><span class='Delimiter'>, 
</span><a name="LN303"></a>                  <span class='Keyword'>int </span><span class='Declare_Parameter'>objc</span><span class='Delimiter'>, </span>Tcl_Obj <span class='Operator'>*</span><span class='Keyword'>const </span><span class='Declare_Parameter'>objv</span><span class='Delimiter'>[]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN304"></a><span class='Keyword'>static int </span><span class='Declare_Prototype'>pltcl_SPI_execute_plan</span><span class='Parentheses'>(</span>ClientData <span class='Declare_Parameter'>cdata</span><span class='Delimiter'>, </span>Tcl_Interp <span class='Operator'>*</span><span class='Declare_Parameter'>interp</span><span class='Delimiter'>, 
</span><a name="LN305"></a>                       <span class='Keyword'>int </span><span class='Declare_Parameter'>objc</span><span class='Delimiter'>, </span>Tcl_Obj <span class='Operator'>*</span><span class='Keyword'>const </span><span class='Declare_Parameter'>objv</span><span class='Delimiter'>[]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN306"></a><span class='Keyword'>static int </span><span class='Declare_Prototype'>pltcl_SPI_lastoid</span><span class='Parentheses'>(</span>ClientData <span class='Declare_Parameter'>cdata</span><span class='Delimiter'>, </span>Tcl_Interp <span class='Operator'>*</span><span class='Declare_Parameter'>interp</span><span class='Delimiter'>, 
</span><a name="LN307"></a>                  <span class='Keyword'>int </span><span class='Declare_Parameter'>objc</span><span class='Delimiter'>, </span>Tcl_Obj <span class='Operator'>*</span><span class='Keyword'>const </span><span class='Declare_Parameter'>objv</span><span class='Delimiter'>[]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN308"></a><span class='Keyword'>static int </span><span class='Declare_Prototype'>pltcl_subtransaction</span><span class='Parentheses'>(</span>ClientData <span class='Declare_Parameter'>cdata</span><span class='Delimiter'>, </span>Tcl_Interp <span class='Operator'>*</span><span class='Declare_Parameter'>interp</span><span class='Delimiter'>, 
</span><a name="LN309"></a>                     <span class='Keyword'>int </span><span class='Declare_Parameter'>objc</span><span class='Delimiter'>, </span>Tcl_Obj <span class='Operator'>*</span><span class='Keyword'>const </span><span class='Declare_Parameter'>objv</span><span class='Delimiter'>[]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN311"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pltcl_subtrans_begin</span><span class='Parentheses'>(</span><a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>oldcontext</span><span class='Delimiter'>, 
</span><a name="LN312"></a>                     <a href="../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Parameter'>oldowner</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN313"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pltcl_subtrans_commit</span><span class='Parentheses'>(</span><a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>oldcontext</span><span class='Delimiter'>, 
</span><a name="LN314"></a>                      <a href="../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Parameter'>oldowner</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN315"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pltcl_subtrans_abort</span><span class='Parentheses'>(</span>Tcl_Interp <span class='Operator'>*</span><span class='Declare_Parameter'>interp</span><span class='Delimiter'>, 
</span><a name="LN316"></a>                     <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>oldcontext</span><span class='Delimiter'>, 
</span><a name="LN317"></a>                     <a href="../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Parameter'>oldowner</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN319"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pltcl_set_tuple_values</span><span class='Parentheses'>(</span>Tcl_Interp <span class='Operator'>*</span><span class='Declare_Parameter'>interp</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>arrayname</span><span class='Delimiter'>, 
</span><a name="LN320"></a>                       <a href="../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a> <span class='Declare_Parameter'>tupno</span><span class='Delimiter'>, </span><a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>tuple</span><span class='Delimiter'>, </span><a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>tupdesc</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN321"></a><span class='Keyword'>static </span>Tcl_Obj <span class='Operator'>*</span><span class='Declare_Prototype'>pltcl_build_tuple_argument</span><span class='Parentheses'>(</span><a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>tuple</span><span class='Delimiter'>, </span><a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>tupdesc</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN322"></a><span class='Keyword'>static </span><a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Prototype'>pltcl_build_tuple_result</span><span class='Parentheses'>(</span>Tcl_Interp <span class='Operator'>*</span><span class='Declare_Parameter'>interp</span><span class='Delimiter'>, 
</span><a name="LN323"></a>                         Tcl_Obj <span class='Operator'>**</span><span class='Declare_Parameter'>kvObjv</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>kvObjc</span><span class='Delimiter'>, 
</span><a name="LN324"></a>                         <a href="pltcl.c.html#LN203"><span class='Ref_to_Struct'>pltcl_call_state</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>call_state</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN325"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pltcl_init_tuple_store</span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN203"><span class='Ref_to_Struct'>pltcl_call_state</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>call_state</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Hack to override Tcl's builtin Notifier subsystem.  This prevents the 
 * backend from becoming multithreaded, which breaks all sorts of things. 
 * That happens in the default version of Tcl_InitNotifier if the TCL library 
 * has been compiled with multithreading support (i.e. when TCL_THREADS is 
 * defined under Unix, and in all cases under Windows). 
 * It's okay to disable the notifier because we never enter the Tcl event loop 
 * from Postgres, so the notifier capabilities are initialized, but never 
 * used.  Only InitNotifier and DeleteFileHandler ever seem to get called 
 * within Postgres, but we implement all the functions for completeness. 
 */ 
</span><span class='Keyword'>static </span>ClientData 
<a name="LN340"></a><span class='Declare_Function'>pltcl_InitNotifier</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN342"></a>    <span class='Keyword'>static int</span>  <span class='Declare_Local'>fakeThreadKey</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* To give valid address for ClientData */ 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span>ClientData<span class='Parentheses'>) </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN342"><span class='Ref_To_Local'>fakeThreadKey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN348"></a><span class='Declare_Function'>pltcl_FinalizeNotifier</span><span class='Parentheses'>(</span>ClientData <span class='Declare_Parameter'>clientData</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN353"></a><span class='Declare_Function'>pltcl_SetTimer</span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN54"><span class='Ref_to_Const'>CONST86</span></a> Tcl_Time <span class='Operator'>*</span><span class='Declare_Parameter'>timePtr</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN358"></a><span class='Declare_Function'>pltcl_AlertNotifier</span><span class='Parentheses'>(</span>ClientData <span class='Declare_Parameter'>clientData</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN363"></a><span class='Declare_Function'>pltcl_CreateFileHandler</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>fd</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>mask</span><span class='Delimiter'>, 
</span><a name="LN364"></a>                        Tcl_FileProc <span class='Operator'>*</span><span class='Declare_Parameter'>proc</span><span class='Delimiter'>, </span>ClientData <span class='Declare_Parameter'>clientData</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN369"></a><span class='Declare_Function'>pltcl_DeleteFileHandler</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>fd</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN374"></a><span class='Declare_Function'>pltcl_ServiceModeHook</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>mode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
} 
</span> 
<span class='Keyword'>static int 
</span><a name="LN379"></a><span class='Declare_Function'>pltcl_WaitForEvent</span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN54"><span class='Ref_to_Const'>CONST86</span></a> Tcl_Time <span class='Operator'>*</span><span class='Declare_Parameter'>timePtr</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * _PG_init()           - library load-time initialization 
 * 
 * DO NOT make this static nor change its name! 
 * 
 * The work done here must be safe to do in the postmaster process, 
 * in case the pltcl library is preloaded in the postmaster. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN394"></a><span class='Declare_Function'>_PG_init</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN396"></a>    Tcl_NotifierProcs <span class='Declare_Local'>notifier</span><span class='Delimiter'>; 
</span><a name="LN397"></a>    <a href="../../include/utils/hsearch.h.html#LN64"><span class='Ref_to_Struct'>HASHCTL</span></a>     <span class='Declare_Local'>hash_ctl</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Be sure we do initialization only once (should be redundant now) */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN234"><span class='Ref_to_Global_Var'>pltcl_pm_init_done</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/miscadmin.h.html#LN467"><span class='Ref_to_Proto'>pg_bindtextdomain</span></a><span class='Parentheses'>(</span><a href="../plpgsql/src/plpgsql.h.html#LN29"><span class='Ref_to_Const'>TEXTDOMAIN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <span class='Comment_Multi_Line'>/* Required on win32 to prevent error loading init.tcl */ 
</span>    Tcl_FindExecutable<span class='Parentheses'>(</span><span class='String'>""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Override the functions in the Notifier subsystem.  See comments above. 
     */ 
</span>    <a href="pltcl.c.html#LN396"><span class='Ref_To_Local'>notifier</span></a><span class='Operator'>.</span>setTimerProc <span class='Operator'>= </span><a href="pltcl.c.html#LN352"><span class='Ref_to_Func'>pltcl_SetTimer</span></a><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN396"><span class='Ref_To_Local'>notifier</span></a><span class='Operator'>.</span>waitForEventProc <span class='Operator'>= </span><a href="pltcl.c.html#LN378"><span class='Ref_to_Func'>pltcl_WaitForEvent</span></a><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN396"><span class='Ref_To_Local'>notifier</span></a><span class='Operator'>.</span>createFileHandlerProc <span class='Operator'>= </span><a href="pltcl.c.html#LN362"><span class='Ref_to_Func'>pltcl_CreateFileHandler</span></a><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN396"><span class='Ref_To_Local'>notifier</span></a><span class='Operator'>.</span>deleteFileHandlerProc <span class='Operator'>= </span><a href="pltcl.c.html#LN368"><span class='Ref_to_Func'>pltcl_DeleteFileHandler</span></a><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN396"><span class='Ref_To_Local'>notifier</span></a><span class='Operator'>.</span>initNotifierProc <span class='Operator'>= </span><a href="pltcl.c.html#LN339"><span class='Ref_to_Func'>pltcl_InitNotifier</span></a><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN396"><span class='Ref_To_Local'>notifier</span></a><span class='Operator'>.</span>finalizeNotifierProc <span class='Operator'>= </span><a href="pltcl.c.html#LN347"><span class='Ref_to_Func'>pltcl_FinalizeNotifier</span></a><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN396"><span class='Ref_To_Local'>notifier</span></a><span class='Operator'>.</span>alertNotifierProc <span class='Operator'>= </span><a href="pltcl.c.html#LN357"><span class='Ref_to_Func'>pltcl_AlertNotifier</span></a><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN396"><span class='Ref_To_Local'>notifier</span></a><span class='Operator'>.</span>serviceModeHookProc <span class='Operator'>= </span><a href="pltcl.c.html#LN373"><span class='Ref_to_Func'>pltcl_ServiceModeHook</span></a><span class='Delimiter'>; 
</span>    Tcl_SetNotifier<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pltcl.c.html#LN396"><span class='Ref_To_Local'>notifier</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Create the dummy hold interpreter to prevent close of 
     * stdout and stderr on DeleteInterp 
     ************************************************************/ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="pltcl.c.html#LN235"><span class='Ref_to_Global_Var'>pltcl_hold_interp</span></a> <span class='Operator'>= </span>Tcl_CreateInterp<span class='Parentheses'>())</span> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not create master Tcl interpreter"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>Tcl_Init<span class='Parentheses'>(</span><a href="pltcl.c.html#LN235"><span class='Ref_to_Global_Var'>pltcl_hold_interp</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span>TCL_ERROR<span class='Parentheses'>)</span> 
        <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not initialize master Tcl interpreter"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Create the hash table for working interpreters 
     ************************************************************/ 
</span>    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pltcl.c.html#LN397"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN397"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN397"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN397"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN111"><span class='Ref_to_Struct'>pltcl_interp_desc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN236"><span class='Ref_to_Global_Var'>pltcl_interp_htab</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN121"><span class='Ref_to_Proto'>hash_create</span></a><span class='Parentheses'>(</span><span class='String'>"PL/Tcl interpreters"</span><span class='Delimiter'>, 
</span>                                    <span class='Number'>8</span><span class='Delimiter'>, 
</span>                                    <span class='Operator'>&</span><a href="pltcl.c.html#LN397"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Delimiter'>, 
</span>                                    <a href="../../include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a> <span class='Operator'>| </span><a href="../../include/utils/hsearch.h.html#LN87"><span class='Ref_to_Const'>HASH_BLOBS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Create the hash table for function lookup 
     ************************************************************/ 
</span>    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pltcl.c.html#LN397"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN397"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN397"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN181"><span class='Ref_to_Struct'>pltcl_proc_key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN397"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN193"><span class='Ref_to_Struct'>pltcl_proc_ptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN237"><span class='Ref_to_Global_Var'>pltcl_proc_htab</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN121"><span class='Ref_to_Proto'>hash_create</span></a><span class='Parentheses'>(</span><span class='String'>"PL/Tcl functions"</span><span class='Delimiter'>, 
</span>                                  <span class='Number'>100</span><span class='Delimiter'>, 
</span>                                  <span class='Operator'>&</span><a href="pltcl.c.html#LN397"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Delimiter'>, 
</span>                                  <a href="../../include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a> <span class='Operator'>| </span><a href="../../include/utils/hsearch.h.html#LN87"><span class='Ref_to_Const'>HASH_BLOBS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Define PL/Tcl's custom GUCs 
     ************************************************************/ 
</span>    <a href="../../include/utils/guc.h.html#LN319"><span class='Ref_to_Proto'>DefineCustomStringVariable</span></a><span class='Parentheses'>(</span><span class='String'>"pltcl.start_proc"</span><span class='Delimiter'>, 
</span>      <a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"PL/Tcl function to call once when pltcl is first used."</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                               <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                               <span class='Operator'>&</span><a href="pltcl.c.html#LN232"><span class='Ref_to_Global_Var'>pltcl_start_proc</span></a><span class='Delimiter'>, 
</span>                               <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                               <a href="../../include/utils/guc.h.html#LN74"><span class='Ref_to_EnumConst'>PGC_SUSET</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                               <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/utils/guc.h.html#LN319"><span class='Ref_to_Proto'>DefineCustomStringVariable</span></a><span class='Parentheses'>(</span><span class='String'>"pltclu.start_proc"</span><span class='Delimiter'>, 
</span>    <a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"PL/TclU function to call once when pltclu is first used."</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                               <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                               <span class='Operator'>&</span><a href="pltcl.c.html#LN233"><span class='Ref_to_Global_Var'>pltclu_start_proc</span></a><span class='Delimiter'>, 
</span>                               <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                               <a href="../../include/utils/guc.h.html#LN74"><span class='Ref_to_EnumConst'>PGC_SUSET</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                               <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pltcl.c.html#LN234"><span class='Ref_to_Global_Var'>pltcl_pm_init_done</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _PG_init &raquo; </span> 
 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * pltcl_init_interp() - initialize a new Tcl interpreter 
 **********************************************************************/ 
</span><span class='Keyword'>static void 
</span><a name="LN479"></a><span class='Declare_Function'>pltcl_init_interp</span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN111"><span class='Ref_to_Struct'>pltcl_interp_desc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>interp_desc</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>prolang</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>pltrusted</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN481"></a>    Tcl_Interp <span class='Operator'>*</span><span class='Declare_Local'>interp</span><span class='Delimiter'>; 
</span><a name="LN482"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>interpname</span><span class='Delimiter'>[</span><span class='Number'>32</span><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Create the Tcl interpreter as a slave of pltcl_hold_interp. 
     * Note: Tcl automatically does Tcl_Init in the untrusted case, 
     * and it's not wanted in the trusted case. 
     ************************************************************/ 
</span>    <a href="../plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN482"><span class='Ref_To_Local'>interpname</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN482"><span class='Ref_To_Local'>interpname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"slave_%u"</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN479"><span class='Ref_to_Parameter'>interp_desc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN113"><span class='Ref_to_Member'>user_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="pltcl.c.html#LN481"><span class='Ref_To_Local'>interp</span></a> <span class='Operator'>= </span>Tcl_CreateSlave<span class='Parentheses'>(</span><a href="pltcl.c.html#LN235"><span class='Ref_to_Global_Var'>pltcl_hold_interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN482"><span class='Ref_To_Local'>interpname</span></a><span class='Delimiter'>, 
</span>                                  <a href="pltcl.c.html#LN479"><span class='Ref_to_Parameter'>pltrusted</span></a> <span class='Operator'>? </span><span class='Number'>1</span> <span class='Operator'>: </span><span class='Number'>0</span><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not create slave Tcl interpreter"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Initialize the query hash table associated with interpreter 
     ************************************************************/ 
</span>    Tcl_InitHashTable<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pltcl.c.html#LN479"><span class='Ref_to_Parameter'>interp_desc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN115"><span class='Ref_to_Member'>query_hash</span></a><span class='Delimiter'>, </span>TCL_STRING_KEYS<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Install the commands for SPI support in the interpreter 
     ************************************************************/ 
</span>    Tcl_CreateObjCommand<span class='Parentheses'>(</span><a href="pltcl.c.html#LN481"><span class='Ref_To_Local'>interp</span></a><span class='Delimiter'>, </span><span class='String'>"elog"</span><span class='Delimiter'>, 
</span>                         <a href="pltcl.c.html#LN282"><span class='Ref_to_Proto'>pltcl_elog</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    Tcl_CreateObjCommand<span class='Parentheses'>(</span><a href="pltcl.c.html#LN481"><span class='Ref_To_Local'>interp</span></a><span class='Delimiter'>, </span><span class='String'>"quote"</span><span class='Delimiter'>, 
</span>                         <a href="pltcl.c.html#LN286"><span class='Ref_to_Proto'>pltcl_quote</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    Tcl_CreateObjCommand<span class='Parentheses'>(</span><a href="pltcl.c.html#LN481"><span class='Ref_To_Local'>interp</span></a><span class='Delimiter'>, </span><span class='String'>"argisnull"</span><span class='Delimiter'>, 
</span>                         <a href="pltcl.c.html#LN288"><span class='Ref_to_Proto'>pltcl_argisnull</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    Tcl_CreateObjCommand<span class='Parentheses'>(</span><a href="pltcl.c.html#LN481"><span class='Ref_To_Local'>interp</span></a><span class='Delimiter'>, </span><span class='String'>"return_null"</span><span class='Delimiter'>, 
</span>                         <a href="pltcl.c.html#LN290"><span class='Ref_to_Proto'>pltcl_returnnull</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    Tcl_CreateObjCommand<span class='Parentheses'>(</span><a href="pltcl.c.html#LN481"><span class='Ref_To_Local'>interp</span></a><span class='Delimiter'>, </span><span class='String'>"return_next"</span><span class='Delimiter'>, 
</span>                         <a href="pltcl.c.html#LN292"><span class='Ref_to_Proto'>pltcl_returnnext</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    Tcl_CreateObjCommand<span class='Parentheses'>(</span><a href="pltcl.c.html#LN481"><span class='Ref_To_Local'>interp</span></a><span class='Delimiter'>, </span><span class='String'>"spi_exec"</span><span class='Delimiter'>, 
</span>                         <a href="pltcl.c.html#LN294"><span class='Ref_to_Proto'>pltcl_SPI_execute</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    Tcl_CreateObjCommand<span class='Parentheses'>(</span><a href="pltcl.c.html#LN481"><span class='Ref_To_Local'>interp</span></a><span class='Delimiter'>, </span><span class='String'>"spi_prepare"</span><span class='Delimiter'>, 
</span>                         <a href="pltcl.c.html#LN302"><span class='Ref_to_Proto'>pltcl_SPI_prepare</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    Tcl_CreateObjCommand<span class='Parentheses'>(</span><a href="pltcl.c.html#LN481"><span class='Ref_To_Local'>interp</span></a><span class='Delimiter'>, </span><span class='String'>"spi_execp"</span><span class='Delimiter'>, 
</span>                         <a href="pltcl.c.html#LN304"><span class='Ref_to_Proto'>pltcl_SPI_execute_plan</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    Tcl_CreateObjCommand<span class='Parentheses'>(</span><a href="pltcl.c.html#LN481"><span class='Ref_To_Local'>interp</span></a><span class='Delimiter'>, </span><span class='String'>"spi_lastoid"</span><span class='Delimiter'>, 
</span>                         <a href="pltcl.c.html#LN306"><span class='Ref_to_Proto'>pltcl_SPI_lastoid</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    Tcl_CreateObjCommand<span class='Parentheses'>(</span><a href="pltcl.c.html#LN481"><span class='Ref_To_Local'>interp</span></a><span class='Delimiter'>, </span><span class='String'>"subtransaction"</span><span class='Delimiter'>, 
</span>                         <a href="pltcl.c.html#LN308"><span class='Ref_to_Proto'>pltcl_subtransaction</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Call the appropriate start_proc, if there is one. 
     * 
     * We must set interp_desc-&GT;interp before the call, else the start_proc 
     * won't find the interpreter it's supposed to use.  But, if the 
     * start_proc fails, we want to abandon use of the interpreter. 
     ************************************************************/ 
</span>    <a href="../../include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pltcl.c.html#LN479"><span class='Ref_to_Parameter'>interp_desc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN114"><span class='Ref_to_Member'>interp</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN481"><span class='Ref_To_Local'>interp</span></a><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN264"><span class='Ref_to_Proto'>call_pltcl_start_proc</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN479"><span class='Ref_to_Parameter'>prolang</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN479"><span class='Ref_to_Parameter'>pltrusted</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pltcl.c.html#LN479"><span class='Ref_to_Parameter'>interp_desc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN114"><span class='Ref_to_Member'>interp</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        Tcl_DeleteInterp<span class='Parentheses'>(</span><a href="pltcl.c.html#LN481"><span class='Ref_To_Local'>interp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN310"><span class='Ref_to_Macro'>PG_RE_THROW</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pltcl_init_interp &raquo; </span> 
 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * pltcl_fetch_interp() - fetch the Tcl interpreter to use for a function 
 * 
 * This also takes care of any on-first-use initialization required. 
 **********************************************************************/ 
</span><span class='Keyword'>static </span><a href="pltcl.c.html#LN111"><span class='Ref_to_Struct'>pltcl_interp_desc</span></a> <span class='Operator'>* 
</span><a name="LN550"></a><span class='Declare_Function'>pltcl_fetch_interp</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>prolang</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>pltrusted</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN552"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>user_id</span><span class='Delimiter'>; 
</span><a name="LN553"></a>    <a href="pltcl.c.html#LN111"><span class='Ref_to_Struct'>pltcl_interp_desc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>interp_desc</span><span class='Delimiter'>; 
</span><a name="LN554"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Find or create the interpreter hashtable entry for this userid */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN550"><span class='Ref_to_Parameter'>pltrusted</span></a><span class='Parentheses'>) 
</span>        <a href="pltcl.c.html#LN552"><span class='Ref_To_Local'>user_id</span></a> <span class='Operator'>= </span><a href="../../backend/utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="pltcl.c.html#LN552"><span class='Ref_To_Local'>user_id</span></a> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span> 
    <a href="pltcl.c.html#LN553"><span class='Ref_To_Local'>interp_desc</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN236"><span class='Ref_to_Global_Var'>pltcl_interp_htab</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pltcl.c.html#LN552"><span class='Ref_To_Local'>user_id</span></a><span class='Delimiter'>, 
</span>                              <a href="../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a><span class='Delimiter'>, 
</span>                              <span class='Operator'>&</span><a href="pltcl.c.html#LN554"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pltcl.c.html#LN554"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>        <a href="pltcl.c.html#LN553"><span class='Ref_To_Local'>interp_desc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN114"><span class='Ref_to_Member'>interp</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If we haven't yet successfully made an interpreter, try to do that */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pltcl.c.html#LN553"><span class='Ref_To_Local'>interp_desc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN114"><span class='Ref_to_Member'>interp</span></a><span class='Parentheses'>) 
</span>        <a href="pltcl.c.html#LN261"><span class='Ref_to_Proto'>pltcl_init_interp</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN553"><span class='Ref_To_Local'>interp_desc</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN550"><span class='Ref_to_Parameter'>prolang</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN550"><span class='Ref_to_Parameter'>pltrusted</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="pltcl.c.html#LN553"><span class='Ref_To_Local'>interp_desc</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pltcl_fetch_interp &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * call_pltcl_start_proc()   - Call user-defined initialization proc, if any 
 **********************************************************************/ 
</span><span class='Keyword'>static void 
</span><a name="LN580"></a><span class='Declare_Function'>call_pltcl_start_proc</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>prolang</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>pltrusted</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN582"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>start_proc</span><span class='Delimiter'>; 
</span><a name="LN583"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>gucname</span><span class='Delimiter'>; 
</span><a name="LN584"></a>    ErrorContextCallback <span class='Declare_Local'>errcallback</span><span class='Delimiter'>; 
</span><a name="LN585"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>namelist</span><span class='Delimiter'>; 
</span><a name="LN586"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>fargtypes</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>];</span>   <span class='Comment_Single_Line'>/* dummy */ 
</span><a name="LN587"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>procOid</span><span class='Delimiter'>; 
</span><a name="LN588"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>procTup</span><span class='Delimiter'>; 
</span><a name="LN589"></a>    <a href="../../include/catalog/pg_proc.h.html#LN82"><span class='Ref_to_Typedef'>Form_pg_proc</span></a> <span class='Declare_Local'>procStruct</span><span class='Delimiter'>; 
</span><a name="LN590"></a>    <a href="../../include/utils/acl.h.html#LN169"><span class='Ref_to_Typedef'>AclResult</span></a>   <span class='Declare_Local'>aclresult</span><span class='Delimiter'>; 
</span><a name="LN591"></a>    <a href="../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a>    <span class='Declare_Local'>finfo</span><span class='Delimiter'>; 
</span><a name="LN592"></a>    <a href="../../include/fmgr.h.html#LN76"><span class='Ref_to_Struct'>FunctionCallInfoData</span></a> <span class='Declare_Local'>fcinfo</span><span class='Delimiter'>; 
</span><a name="LN593"></a>    <a href="../../include/pgstat.h.html#LN1086"><span class='Ref_to_Struct'>PgStat_FunctionCallUsage</span></a> <span class='Declare_Local'>fcusage</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* select appropriate GUC */ 
</span>    <a href="pltcl.c.html#LN582"><span class='Ref_To_Local'>start_proc</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN580"><span class='Ref_to_Parameter'>pltrusted</span></a> <span class='Operator'>? </span><a href="pltcl.c.html#LN232"><span class='Ref_to_Global_Var'>pltcl_start_proc</span></a> <span class='Operator'>: </span><a href="pltcl.c.html#LN233"><span class='Ref_to_Global_Var'>pltclu_start_proc</span></a><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN583"><span class='Ref_To_Local'>gucname</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN580"><span class='Ref_to_Parameter'>pltrusted</span></a> <span class='Operator'>? </span><span class='String'>"pltcl.start_proc"</span> <span class='Operator'>: </span><span class='String'>"pltclu.start_proc"</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Nothing to do if it's empty or unset */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN582"><span class='Ref_To_Local'>start_proc</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><a href="pltcl.c.html#LN582"><span class='Ref_To_Local'>start_proc</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set up errcontext callback to make errors more helpful */ 
</span>    <a href="pltcl.c.html#LN584"><span class='Ref_To_Local'>errcallback</span></a><span class='Operator'>.</span>callback <span class='Operator'>= </span><a href="pltcl.c.html#LN265"><span class='Ref_to_Proto'>start_proc_error_callback</span></a><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN584"><span class='Ref_To_Local'>errcallback</span></a><span class='Operator'>.</span>arg <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="pltcl.c.html#LN583"><span class='Ref_To_Local'>gucname</span></a><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN584"><span class='Ref_To_Local'>errcallback</span></a><span class='Operator'>.</span>previous <span class='Operator'>= </span><a href="../../backend/utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a><span class='Delimiter'>; 
</span>    <a href="../../backend/utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a> <span class='Operator'>= &</span><a href="pltcl.c.html#LN584"><span class='Ref_To_Local'>errcallback</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Parse possibly-qualified identifier and look up the function */ 
</span>    <a href="pltcl.c.html#LN585"><span class='Ref_To_Local'>namelist</span></a> <span class='Operator'>= </span><a href="../../include/utils/regproc.h.html#LN17"><span class='Ref_to_Proto'>stringToQualifiedNameList</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN582"><span class='Ref_To_Local'>start_proc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN587"><span class='Ref_To_Local'>procOid</span></a> <span class='Operator'>= </span><a href="../../include/parser/parse_func.h.html#LN62"><span class='Ref_to_Proto'>LookupFuncName</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN585"><span class='Ref_To_Local'>namelist</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN586"><span class='Ref_To_Local'>fargtypes</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Current user must have permission to call function */ 
</span>    <a href="pltcl.c.html#LN590"><span class='Ref_To_Local'>aclresult</span></a> <span class='Operator'>= </span><a href="../../include/utils/acl.h.html#LN285"><span class='Ref_to_Proto'>pg_proc_aclcheck</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN587"><span class='Ref_To_Local'>procOid</span></a><span class='Delimiter'>, </span><a href="../../backend/utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, </span><a href="../../include/nodes/parsenodes.h.html#LN78"><span class='Ref_to_Const'>ACL_EXECUTE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN590"><span class='Ref_To_Local'>aclresult</span></a> <span class='Operator'>!= </span><a href="../../include/utils/acl.h.html#LN171"><span class='Ref_to_EnumConst'>ACLCHECK_OK</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/acl.h.html#LN295"><span class='Ref_to_Proto'>aclcheck_error</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN590"><span class='Ref_To_Local'>aclresult</span></a><span class='Delimiter'>, </span><a href="../../include/utils/acl.h.html#LN184"><span class='Ref_to_EnumConst'>ACL_KIND_PROC</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN582"><span class='Ref_To_Local'>start_proc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Get the function's pg_proc entry */ 
</span>    <a href="pltcl.c.html#LN588"><span class='Ref_To_Local'>procTup</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN76"><span class='Ref_to_EnumConst'>PROCOID</span></a><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN587"><span class='Ref_To_Local'>procOid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN588"><span class='Ref_To_Local'>procTup</span></a><span class='Parentheses'>))</span> 
        <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cache lookup failed for function %u"</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN587"><span class='Ref_To_Local'>procOid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN589"><span class='Ref_To_Local'>procStruct</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_proc.h.html#LN82"><span class='Ref_to_Typedef'>Form_pg_proc</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN588"><span class='Ref_To_Local'>procTup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* It must be same language as the function we're currently calling */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN589"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>prolang <span class='Operator'>!= </span><a href="pltcl.c.html#LN580"><span class='Ref_to_Parameter'>prolang</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"function \"%s\" is in the wrong language"</span><span class='Delimiter'>, 
</span>                        <a href="pltcl.c.html#LN582"><span class='Ref_To_Local'>start_proc</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * It must not be SECURITY DEFINER, either.  This together with the 
     * language match check ensures that the function will execute in the same 
     * Tcl interpreter we just finished initializing. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN589"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>prosecdef<span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"function \"%s\" must not be SECURITY DEFINER"</span><span class='Delimiter'>, 
</span>                        <a href="pltcl.c.html#LN582"><span class='Ref_To_Local'>start_proc</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* A-OK */ 
</span>    <a href="../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN588"><span class='Ref_To_Local'>procTup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Call the function using the normal SQL function call mechanism.  We 
     * could perhaps cheat and jump directly to pltcl_handler(), but it seems 
     * better to do it this way so that the call is exposed to, eg, call 
     * statistics collection. 
     */ 
</span>    <a href="../../include/catalog/objectaccess.h.html#LN178"><span class='Ref_to_Macro'>InvokeFunctionExecuteHook</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN587"><span class='Ref_To_Local'>procOid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/fmgr.h.html#LN92"><span class='Ref_to_Proto'>fmgr_info</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN587"><span class='Ref_To_Local'>procOid</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pltcl.c.html#LN591"><span class='Ref_To_Local'>finfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/fmgr.h.html#LN119"><span class='Ref_to_Macro'>InitFunctionCallInfoData</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN592"><span class='Ref_To_Local'>fcinfo</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pltcl.c.html#LN591"><span class='Ref_To_Local'>finfo</span></a><span class='Delimiter'>, 
</span>                             <span class='Number'>0</span><span class='Delimiter'>, 
</span>                             <a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/pgstat.h.html#LN1293"><span class='Ref_to_Proto'>pgstat_init_function_usage</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pltcl.c.html#LN592"><span class='Ref_To_Local'>fcinfo</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pltcl.c.html#LN593"><span class='Ref_To_Local'>fcusage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../include/fmgr.h.html#LN136"><span class='Ref_to_Macro'>FunctionCallInvoke</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pltcl.c.html#LN592"><span class='Ref_To_Local'>fcinfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/pgstat.h.html#LN1295"><span class='Ref_to_Proto'>pgstat_end_function_usage</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pltcl.c.html#LN593"><span class='Ref_To_Local'>fcusage</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Pop the error context stack */ 
</span>    <a href="../../backend/utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN584"><span class='Ref_To_Local'>errcallback</span></a><span class='Operator'>.</span>previous<span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end call_pltcl_start_proc &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Error context callback for errors occurring during start_proc processing. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN668"></a><span class='Declare_Function'>start_proc_error_callback</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN670"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>gucname</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="pltcl.c.html#LN668"><span class='Ref_to_Parameter'>arg</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* translator: %s is "pltcl.start_proc" or "pltclu.start_proc" */ 
</span>    errcontext<span class='Parentheses'>(</span><span class='String'>"processing %s parameter"</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN670"><span class='Ref_To_Local'>gucname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * pltcl_call_handler       - This is the only visible function 
 *                of the PL interpreter. The PostgreSQL 
 *                function manager and trigger manager 
 *                call this function for execution of 
 *                PL/Tcl procedures. 
 **********************************************************************/ 
</span><a name="LN684"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN687"><span class='Ref_to_Func'>pltcl_call_handler</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* keep non-static */ 
</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN688"></a><span class='Declare_Function'>pltcl_call_handler</span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="pltcl.c.html#LN267"><span class='Ref_to_Proto'>pltcl_handler</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Alternative handler for unsafe functions 
 */ 
</span><a name="LN696"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN699"><span class='Ref_to_Func'>pltclu_call_handler</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* keep non-static */ 
</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN700"></a><span class='Declare_Function'>pltclu_call_handler</span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="pltcl.c.html#LN267"><span class='Ref_to_Proto'>pltcl_handler</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * pltcl_handler()      - Handler for function and trigger calls, for 
 *                        both trusted and untrusted interpreters. 
 **********************************************************************/ 
</span><span class='Keyword'>static </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN711"></a><span class='Declare_Function'>pltcl_handler</span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>pltrusted</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN713"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>retval</span><span class='Delimiter'>; 
</span><a name="LN714"></a>    <a href="pltcl.c.html#LN203"><span class='Ref_to_Struct'>pltcl_call_state</span></a> <span class='Declare_Local'>current_call_state</span><span class='Delimiter'>; 
</span><a name="LN715"></a>    <a href="pltcl.c.html#LN203"><span class='Ref_to_Struct'>pltcl_call_state</span></a> <span class='Operator'>*</span><span class='Declare_Local'>save_call_state</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Initialize current_call_state to nulls/zeroes; in particular, set its 
     * prodesc pointer to null.  Anything that sets it non-null should 
     * increase the prodesc's fn_refcount at the same time.  We'll decrease 
     * the refcount, and then delete the prodesc if it's no longer referenced, 
     * on the way out of this function.  This ensures that prodescs live as 
     * long as needed even if somebody replaces the originating pg_proc row 
     * while they're executing. 
     */ 
</span>    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pltcl.c.html#LN714"><span class='Ref_To_Local'>current_call_state</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN714"><span class='Ref_To_Local'>current_call_state</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Ensure that static pointer is saved/restored properly 
     */ 
</span>    <a href="pltcl.c.html#LN715"><span class='Ref_To_Local'>save_call_state</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN240"><span class='Ref_to_Global_Var'>pltcl_current_call_state</span></a><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN240"><span class='Ref_to_Global_Var'>pltcl_current_call_state</span></a> <span class='Operator'>= &</span><a href="pltcl.c.html#LN714"><span class='Ref_To_Local'>current_call_state</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Determine if called as function or trigger and call appropriate 
         * subhandler 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN24"><span class='Ref_to_Macro'>CALLED_AS_TRIGGER</span></a><span class='Parentheses'>(</span>fcinfo<span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* invoke the trigger handler */ 
</span>            <a href="pltcl.c.html#LN713"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span><a href="../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN271"><span class='Ref_to_Proto'>pltcl_trigger_handler</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, 
</span>                                                         <span class='Operator'>&</span><a href="pltcl.c.html#LN714"><span class='Ref_To_Local'>current_call_state</span></a><span class='Delimiter'>, 
</span>                                                           <a href="pltcl.c.html#LN711"><span class='Ref_to_Parameter'>pltrusted</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/event_trigger.h.html#LN39"><span class='Ref_to_Macro'>CALLED_AS_EVENT_TRIGGER</span></a><span class='Parentheses'>(</span>fcinfo<span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* invoke the event trigger handler */ 
</span>            <a href="pltcl.c.html#LN273"><span class='Ref_to_Proto'>pltcl_event_trigger_handler</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pltcl.c.html#LN714"><span class='Ref_To_Local'>current_call_state</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN711"><span class='Ref_to_Parameter'>pltrusted</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pltcl.c.html#LN713"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* invoke the regular function handler */ 
</span>            <a href="pltcl.c.html#LN714"><span class='Ref_To_Local'>current_call_state</span></a><span class='Operator'>.</span><a href="pltcl.c.html#LN206"><span class='Ref_to_Member'>fcinfo</span></a> <span class='Operator'>= </span>fcinfo<span class='Delimiter'>; 
</span>            <a href="pltcl.c.html#LN713"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN269"><span class='Ref_to_Proto'>pltcl_func_handler</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pltcl.c.html#LN714"><span class='Ref_To_Local'>current_call_state</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN711"><span class='Ref_to_Parameter'>pltrusted</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Restore static pointer, then clean up the prodesc refcount if any */ 
</span>        <a href="pltcl.c.html#LN240"><span class='Ref_to_Global_Var'>pltcl_current_call_state</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN715"><span class='Ref_To_Local'>save_call_state</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN714"><span class='Ref_To_Local'>current_call_state</span></a><span class='Operator'>.</span><a href="pltcl.c.html#LN212"><span class='Ref_to_Member'>prodesc</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN714"><span class='Ref_To_Local'>current_call_state</span></a><span class='Operator'>.</span><a href="pltcl.c.html#LN212"><span class='Ref_to_Member'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN139"><span class='Ref_to_Member'>fn_refcount</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>--</span><a href="pltcl.c.html#LN714"><span class='Ref_To_Local'>current_call_state</span></a><span class='Operator'>.</span><a href="pltcl.c.html#LN212"><span class='Ref_to_Member'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN139"><span class='Ref_to_Member'>fn_refcount</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN714"><span class='Ref_To_Local'>current_call_state</span></a><span class='Operator'>.</span><a href="pltcl.c.html#LN212"><span class='Ref_to_Member'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN138"><span class='Ref_to_Member'>fn_cxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../include/utils/elog.h.html#LN310"><span class='Ref_to_Macro'>PG_RE_THROW</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Restore static pointer, then clean up the prodesc refcount if any */ 
</span>    <span class='Comment_Multi_Line'>/* (We're being paranoid in case an error is thrown in context deletion) */ 
</span>    <a href="pltcl.c.html#LN240"><span class='Ref_to_Global_Var'>pltcl_current_call_state</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN715"><span class='Ref_To_Local'>save_call_state</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN714"><span class='Ref_To_Local'>current_call_state</span></a><span class='Operator'>.</span><a href="pltcl.c.html#LN212"><span class='Ref_to_Member'>prodesc</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN714"><span class='Ref_To_Local'>current_call_state</span></a><span class='Operator'>.</span><a href="pltcl.c.html#LN212"><span class='Ref_to_Member'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN139"><span class='Ref_to_Member'>fn_refcount</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>--</span><a href="pltcl.c.html#LN714"><span class='Ref_To_Local'>current_call_state</span></a><span class='Operator'>.</span><a href="pltcl.c.html#LN212"><span class='Ref_to_Member'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN139"><span class='Ref_to_Member'>fn_refcount</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN714"><span class='Ref_To_Local'>current_call_state</span></a><span class='Operator'>.</span><a href="pltcl.c.html#LN212"><span class='Ref_to_Member'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN138"><span class='Ref_to_Member'>fn_cxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="pltcl.c.html#LN713"><span class='Ref_To_Local'>retval</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pltcl_handler &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * pltcl_func_handler()     - Handler for regular function calls 
 **********************************************************************/ 
</span><span class='Keyword'>static </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN792"></a><span class='Declare_Function'>pltcl_func_handler</span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN203"><span class='Ref_to_Struct'>pltcl_call_state</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>call_state</span><span class='Delimiter'>, 
</span><a name="LN793"></a>                   <span class='Keyword'>bool </span><span class='Declare_Parameter'>pltrusted</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN795"></a>    <a href="pltcl.c.html#LN134"><span class='Ref_to_Struct'>pltcl_proc_desc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>prodesc</span><span class='Delimiter'>; 
</span><a name="LN796"></a>    Tcl_Interp <span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Declare_Local'>interp</span><span class='Delimiter'>; 
</span><a name="LN797"></a>    Tcl_Obj    <span class='Operator'>*</span><span class='Declare_Local'>tcl_cmd</span><span class='Delimiter'>; 
</span><a name="LN798"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN799"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>tcl_rc</span><span class='Delimiter'>; 
</span><a name="LN800"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>retval</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Connect to SPI manager */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/executor/spi.h.html#LN79"><span class='Ref_to_Proto'>SPI_connect</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../include/executor/spi.h.html#LN49"><span class='Ref_to_Const'>SPI_OK_CONNECT</span></a><span class='Parentheses'>)</span> 
        <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not connect to SPI manager"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Find or compile the function */ 
</span>    <a href="pltcl.c.html#LN795"><span class='Ref_To_Local'>prodesc</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN278"><span class='Ref_to_Proto'>compile_pltcl_function</span></a><span class='Parentheses'>(</span>fcinfo<span class='Operator'>-&GT;</span>flinfo<span class='Operator'>-&GT;</span>fn_oid<span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, 
</span>                                     <span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN793"><span class='Ref_to_Parameter'>pltrusted</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pltcl.c.html#LN792"><span class='Ref_to_Parameter'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN212"><span class='Ref_to_Member'>prodesc</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN795"><span class='Ref_To_Local'>prodesc</span></a><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN795"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN139"><span class='Ref_to_Member'>fn_refcount</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
    <a href="pltcl.c.html#LN796"><span class='Ref_To_Local'>interp</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN795"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN144"><span class='Ref_to_Member'>interp_desc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN114"><span class='Ref_to_Member'>interp</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we're a SRF, check caller can handle materialize mode, and save 
     * relevant info into call_state.  We must ensure that the returned 
     * tuplestore is owned by the caller's context, even if we first create it 
     * inside a subtransaction. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN795"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN147"><span class='Ref_to_Member'>fn_retisset</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN823"></a>        <a href="../../include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rsi</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span>fcinfo<span class='Operator'>-&GT;</span>resultinfo<span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pltcl.c.html#LN823"><span class='Ref_To_Local'>rsi</span></a> <span class='Operator'>|| !</span><a href="../../include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN823"><span class='Ref_To_Local'>rsi</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>            <span class='Parentheses'>(</span><a href="pltcl.c.html#LN823"><span class='Ref_To_Local'>rsi</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN267"><span class='Ref_to_Member'>allowedModes</span></a> <span class='Operator'>& </span><a href="../../include/nodes/execnodes.h.html#LN250"><span class='Ref_to_EnumConst'>SFRM_Materialize</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"set-valued function called in context that cannot accept a set"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="pltcl.c.html#LN792"><span class='Ref_to_Parameter'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN222"><span class='Ref_to_Member'>rsi</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN823"><span class='Ref_To_Local'>rsi</span></a><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN792"><span class='Ref_to_Parameter'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN224"><span class='Ref_to_Member'>tuple_store_cxt</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN823"><span class='Ref_To_Local'>rsi</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN265"><span class='Ref_to_Member'>econtext</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN201"><span class='Ref_to_Member'>ecxt_per_query_memory</span></a><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN792"><span class='Ref_to_Parameter'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN225"><span class='Ref_to_Member'>tuple_store_owner</span></a> <span class='Operator'>= </span><a href="../../backend/utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Create the tcl command to call the internal 
     * proc in the Tcl interpreter 
     ************************************************************/ 
</span>    <a href="pltcl.c.html#LN797"><span class='Ref_To_Local'>tcl_cmd</span></a> <span class='Operator'>= </span>Tcl_NewObj<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN797"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, 
</span>                             Tcl_NewStringObj<span class='Parentheses'>(</span><a href="pltcl.c.html#LN795"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN137"><span class='Ref_to_Member'>internal_proname</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We hold a refcount on tcl_cmd just to be sure it stays around */ 
</span>    Tcl_IncrRefCount<span class='Parentheses'>(</span><a href="pltcl.c.html#LN797"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Add all call arguments to the command 
     ************************************************************/ 
</span>    <a href="../../include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN798"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pltcl.c.html#LN798"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="pltcl.c.html#LN795"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN149"><span class='Ref_to_Member'>nargs</span></a><span class='Delimiter'>; </span><a href="pltcl.c.html#LN798"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN795"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN152"><span class='Ref_to_Member'>arg_is_rowtype</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN798"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/************************************************** 
                 * For tuple values, add a list for 'array set ...' 
                 **************************************************/ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span>fcinfo<span class='Operator'>-&GT;</span>argnull<span class='Delimiter'>[</span><a href="pltcl.c.html#LN798"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>                    Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN797"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, </span>Tcl_NewObj<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span><a name="LN863"></a>                    <a href="../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a> <span class='Declare_Local'>td</span><span class='Delimiter'>; 
</span><a name="LN864"></a>                    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>tupType</span><span class='Delimiter'>; 
</span><a name="LN865"></a>                    <a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>tupTypmod</span><span class='Delimiter'>; 
</span><a name="LN866"></a>                    <a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span><span class='Delimiter'>; 
</span><a name="LN867"></a>                    <a href="../../include/access/htup.h.html#LN61"><span class='Ref_to_Struct'>HeapTupleData</span></a> <span class='Declare_Local'>tmptup</span><span class='Delimiter'>; 
</span><a name="LN868"></a>                    Tcl_Obj    <span class='Operator'>*</span><span class='Declare_Local'>list_tmp</span><span class='Delimiter'>; 
</span> 
                    <a href="pltcl.c.html#LN863"><span class='Ref_To_Local'>td</span></a> <span class='Operator'>= </span><a href="../../include/fmgr.h.html#LN258"><span class='Ref_to_Macro'>DatumGetHeapTupleHeader</span></a><span class='Parentheses'>(</span>fcinfo<span class='Operator'>-&GT;</span>arg<span class='Delimiter'>[</span><a href="pltcl.c.html#LN798"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Comment_Multi_Line'>/* Extract rowtype info and find a tupdesc */ 
</span>                    <a href="pltcl.c.html#LN864"><span class='Ref_To_Local'>tupType</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN444"><span class='Ref_to_Macro'>HeapTupleHeaderGetTypeId</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN863"><span class='Ref_To_Local'>td</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="pltcl.c.html#LN865"><span class='Ref_To_Local'>tupTypmod</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN454"><span class='Ref_to_Macro'>HeapTupleHeaderGetTypMod</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN863"><span class='Ref_To_Local'>td</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="pltcl.c.html#LN866"><span class='Ref_To_Local'>tupdesc</span></a> <span class='Operator'>= </span><a href="../../include/utils/typcache.h.html#LN151"><span class='Ref_to_Proto'>lookup_rowtype_tupdesc</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN864"><span class='Ref_To_Local'>tupType</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN865"><span class='Ref_To_Local'>tupTypmod</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Comment_Multi_Line'>/* Build a temporary HeapTuple control structure */ 
</span>                    <a href="pltcl.c.html#LN867"><span class='Ref_To_Local'>tmptup</span></a><span class='Operator'>.</span><a href="../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN438"><span class='Ref_to_Macro'>HeapTupleHeaderGetDatumLength</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN863"><span class='Ref_To_Local'>td</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="pltcl.c.html#LN867"><span class='Ref_To_Local'>tmptup</span></a><span class='Operator'>.</span><a href="../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN863"><span class='Ref_To_Local'>td</span></a><span class='Delimiter'>; 
</span> 
                    <a href="pltcl.c.html#LN868"><span class='Ref_To_Local'>list_tmp</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN321"><span class='Ref_to_Proto'>pltcl_build_tuple_argument</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pltcl.c.html#LN867"><span class='Ref_To_Local'>tmptup</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN866"><span class='Ref_To_Local'>tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN797"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN868"><span class='Ref_To_Local'>list_tmp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <a href="../../include/access/tupdesc.h.html#LN106"><span class='Ref_to_Macro'>ReleaseTupleDesc</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN866"><span class='Ref_To_Local'>tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if prodesc-&GT;arg_is_rowty... &raquo; </span> 
            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/************************************************** 
                 * Single values are added as string element 
                 * of their external representation 
                 **************************************************/ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span>fcinfo<span class='Operator'>-&GT;</span>argnull<span class='Delimiter'>[</span><a href="pltcl.c.html#LN798"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>                    Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN797"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, </span>Tcl_NewObj<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span><a name="LN895"></a>                    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>tmp</span><span class='Delimiter'>; 
</span> 
                    <a href="pltcl.c.html#LN895"><span class='Ref_To_Local'>tmp</span></a> <span class='Operator'>= </span><a href="../../include/fmgr.h.html#LN646"><span class='Ref_to_Proto'>OutputFunctionCall</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pltcl.c.html#LN795"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN151"><span class='Ref_to_Member'>arg_out_func</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN798"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                                             fcinfo<span class='Operator'>-&GT;</span>arg<span class='Delimiter'>[</span><a href="pltcl.c.html#LN798"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="pltcl.c.html#LN84"><span class='Ref_to_Const'>UTF_BEGIN</span></a><span class='Delimiter'>; 
</span>                    Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN797"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, 
</span>                                         Tcl_NewStringObj<span class='Parentheses'>(</span><a href="pltcl.c.html#LN97"><span class='Ref_to_Macro'>UTF_E2U</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN895"><span class='Ref_To_Local'>tmp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                    <a href="pltcl.c.html#LN89"><span class='Ref_to_Const'>UTF_END</span></a><span class='Delimiter'>; 
</span>                    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN895"><span class='Ref_To_Local'>tmp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;prodesc-&GT;nargs;... &raquo; </span> 
    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Release refcount to free tcl_cmd */ 
</span>        Tcl_DecrRefCount<span class='Parentheses'>(</span><a href="pltcl.c.html#LN797"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN310"><span class='Ref_to_Macro'>PG_RE_THROW</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Call the Tcl function 
     * 
     * We assume no PG error can be thrown directly from this call. 
     ************************************************************/ 
</span>    <a href="pltcl.c.html#LN799"><span class='Ref_To_Local'>tcl_rc</span></a> <span class='Operator'>= </span>Tcl_EvalObjEx<span class='Parentheses'>(</span><a href="pltcl.c.html#LN796"><span class='Ref_To_Local'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN797"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span>TCL_EVAL_DIRECT <span class='Operator'>| </span>TCL_EVAL_GLOBAL<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Release refcount to free tcl_cmd (and all subsidiary objects) */ 
</span>    Tcl_DecrRefCount<span class='Parentheses'>(</span><a href="pltcl.c.html#LN797"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Check for errors reported by Tcl. 
     ************************************************************/ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN799"><span class='Ref_To_Local'>tcl_rc</span></a> <span class='Operator'>!= </span>TCL_OK<span class='Parentheses'>) 
</span>        <a href="pltcl.c.html#LN276"><span class='Ref_to_Proto'>throw_tcl_error</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN796"><span class='Ref_To_Local'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN795"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN136"><span class='Ref_to_Member'>user_proname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Disconnect from SPI manager and then create the return 
     * value datum (if the input function does a palloc for it 
     * this must not be allocated in the SPI memory context 
     * because SPI_finish would free it).  But don't try to call 
     * the result_in_func if we've been told to return a NULL; 
     * the Tcl result may not be a valid value of the result type 
     * in that case. 
     ************************************************************/ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/executor/spi.h.html#LN80"><span class='Ref_to_Proto'>SPI_finish</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../include/executor/spi.h.html#LN50"><span class='Ref_to_Const'>SPI_OK_FINISH</span></a><span class='Parentheses'>)</span> 
        <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_finish() failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN795"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN147"><span class='Ref_to_Member'>fn_retisset</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN946"></a>        <a href="../../include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rsi</span> <span class='Operator'>= </span><a href="pltcl.c.html#LN792"><span class='Ref_to_Parameter'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN222"><span class='Ref_to_Member'>rsi</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* We already checked this is OK */ 
</span>        <a href="pltcl.c.html#LN946"><span class='Ref_To_Local'>rsi</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN269"><span class='Ref_to_Member'>returnMode</span></a> <span class='Operator'>= </span><a href="../../include/nodes/execnodes.h.html#LN250"><span class='Ref_to_EnumConst'>SFRM_Materialize</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* If we produced any tuples, send back the result */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN792"><span class='Ref_to_Parameter'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN223"><span class='Ref_to_Member'>tuple_store</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="pltcl.c.html#LN946"><span class='Ref_To_Local'>rsi</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN272"><span class='Ref_to_Member'>setResult</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN792"><span class='Ref_to_Parameter'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN223"><span class='Ref_to_Member'>tuple_store</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN792"><span class='Ref_to_Parameter'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN219"><span class='Ref_to_Member'>ret_tupdesc</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN957"></a>                <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcxt</span><span class='Delimiter'>; 
</span> 
                <a href="pltcl.c.html#LN957"><span class='Ref_To_Local'>oldcxt</span></a> <span class='Operator'>= </span><a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN792"><span class='Ref_to_Parameter'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN224"><span class='Ref_to_Member'>tuple_store_cxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="pltcl.c.html#LN946"><span class='Ref_To_Local'>rsi</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN273"><span class='Ref_to_Member'>setDesc</span></a> <span class='Operator'>= </span><a href="../../include/access/tupdesc.h.html#LN88"><span class='Ref_to_Proto'>CreateTupleDescCopy</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN792"><span class='Ref_to_Parameter'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN219"><span class='Ref_to_Member'>ret_tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN957"><span class='Ref_To_Local'>oldcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <a href="pltcl.c.html#LN800"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        fcinfo<span class='Operator'>-&GT;</span>isnull <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if prodesc-&GT;fn_retisset &raquo; </span> 
    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>fcinfo<span class='Operator'>-&GT;</span>isnull<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pltcl.c.html#LN800"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span><a href="../../include/fmgr.h.html#LN642"><span class='Ref_to_Proto'>InputFunctionCall</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pltcl.c.html#LN795"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN145"><span class='Ref_to_Member'>result_in_func</span></a><span class='Delimiter'>, 
</span>                                   <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                   <a href="pltcl.c.html#LN795"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN146"><span class='Ref_to_Member'>result_typioparam</span></a><span class='Delimiter'>, 
</span>                                   <span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN795"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN148"><span class='Ref_to_Member'>fn_retistuple</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN976"></a>        <a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>td</span><span class='Delimiter'>; 
</span><a name="LN977"></a>        <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tup</span><span class='Delimiter'>; 
</span><a name="LN978"></a>        Tcl_Obj    <span class='Operator'>*</span><span class='Declare_Local'>resultObj</span><span class='Delimiter'>; 
</span><a name="LN979"></a>        Tcl_Obj   <span class='Operator'>**</span><span class='Declare_Local'>resultObjv</span><span class='Delimiter'>; 
</span><a name="LN980"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>resultObjc</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Set up data about result type.  XXX it's tempting to consider 
         * caching this in the prodesc, in the common case where the rowtype 
         * is determined by the function not the calling query.  But we'd have 
         * to be able to deal with ADD/DROP/ALTER COLUMN events when the 
         * result type is a named composite type, so it's not exactly trivial. 
         * Maybe worth improving someday. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/funcapi.h.html#LN157"><span class='Ref_to_Proto'>get_call_result_type</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pltcl.c.html#LN976"><span class='Ref_To_Local'>td</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../include/funcapi.h.html#LN152"><span class='Ref_to_EnumConst'>TYPEFUNC_COMPOSITE</span></a><span class='Parentheses'>)</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"function returning record called in context "</span> 
                            <span class='String'>"that cannot accept type record"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pltcl.c.html#LN792"><span class='Ref_to_Parameter'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN219"><span class='Ref_to_Member'>ret_tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pltcl.c.html#LN792"><span class='Ref_to_Parameter'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN220"><span class='Ref_to_Member'>attinmeta</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN792"><span class='Ref_to_Parameter'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN219"><span class='Ref_to_Member'>ret_tupdesc</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN976"><span class='Ref_To_Local'>td</span></a><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN792"><span class='Ref_to_Parameter'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN220"><span class='Ref_to_Member'>attinmeta</span></a> <span class='Operator'>= </span><a href="../../include/funcapi.h.html#LN230"><span class='Ref_to_Proto'>TupleDescGetAttInMetadata</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN976"><span class='Ref_To_Local'>td</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Convert function result to tuple */ 
</span>        <a href="pltcl.c.html#LN978"><span class='Ref_To_Local'>resultObj</span></a> <span class='Operator'>= </span>Tcl_GetObjResult<span class='Parentheses'>(</span><a href="pltcl.c.html#LN796"><span class='Ref_To_Local'>interp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>Tcl_ListObjGetElements<span class='Parentheses'>(</span><a href="pltcl.c.html#LN796"><span class='Ref_To_Local'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN978"><span class='Ref_To_Local'>resultObj</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pltcl.c.html#LN980"><span class='Ref_To_Local'>resultObjc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pltcl.c.html#LN979"><span class='Ref_To_Local'>resultObjv</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span>TCL_ERROR<span class='Parentheses'>)</span> 
            <a href="pltcl.c.html#LN276"><span class='Ref_to_Proto'>throw_tcl_error</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN796"><span class='Ref_To_Local'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN795"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN136"><span class='Ref_to_Member'>user_proname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="pltcl.c.html#LN977"><span class='Ref_To_Local'>tup</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN322"><span class='Ref_to_Proto'>pltcl_build_tuple_result</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN796"><span class='Ref_To_Local'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN979"><span class='Ref_To_Local'>resultObjv</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN980"><span class='Ref_To_Local'>resultObjc</span></a><span class='Delimiter'>, 
</span>                                       <a href="pltcl.c.html#LN792"><span class='Ref_to_Parameter'>call_state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN800"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span><a href="../../include/funcapi.h.html#LN221"><span class='Ref_to_Macro'>HeapTupleGetDatum</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN977"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if prodesc-&GT;fn_retistupl... &raquo; </span> 
    <span class='Control'>else</span> 
        <a href="pltcl.c.html#LN800"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span><a href="../../include/fmgr.h.html#LN642"><span class='Ref_to_Proto'>InputFunctionCall</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pltcl.c.html#LN795"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN145"><span class='Ref_to_Member'>result_in_func</span></a><span class='Delimiter'>, 
</span>                                   <a href="../plperl/plperl_helpers.h.html#LN10"><span class='Ref_to_Func'>utf_u2e</span></a><span class='Parentheses'>(</span>Tcl_GetStringResult<span class='Parentheses'>(</span><a href="pltcl.c.html#LN796"><span class='Ref_To_Local'>interp</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                                   <a href="pltcl.c.html#LN795"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN146"><span class='Ref_to_Member'>result_typioparam</span></a><span class='Delimiter'>, 
</span>                                   <span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="pltcl.c.html#LN800"><span class='Ref_To_Local'>retval</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pltcl_func_handler &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * pltcl_trigger_handler()  - Handler for trigger calls 
 **********************************************************************/ 
</span><span class='Keyword'>static </span><a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> 
<a name="LN1024"></a><span class='Declare_Function'>pltcl_trigger_handler</span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN203"><span class='Ref_to_Struct'>pltcl_call_state</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>call_state</span><span class='Delimiter'>, 
</span><a name="LN1025"></a>                      <span class='Keyword'>bool </span><span class='Declare_Parameter'>pltrusted</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1027"></a>    <a href="pltcl.c.html#LN134"><span class='Ref_to_Struct'>pltcl_proc_desc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>prodesc</span><span class='Delimiter'>; 
</span><a name="LN1028"></a>    Tcl_Interp <span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Declare_Local'>interp</span><span class='Delimiter'>; 
</span><a name="LN1029"></a>    <a href="../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>trigdata</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span>fcinfo<span class='Operator'>-&GT;</span>context<span class='Delimiter'>; 
</span><a name="LN1030"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>stroid</span><span class='Delimiter'>; 
</span><a name="LN1031"></a>    <a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span><span class='Delimiter'>; 
</span><a name="LN1032"></a>    <span class='Keyword'>volatile </span><a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Local'>rettup</span><span class='Delimiter'>; 
</span><a name="LN1033"></a>    Tcl_Obj    <span class='Operator'>*</span><span class='Declare_Local'>tcl_cmd</span><span class='Delimiter'>; 
</span><a name="LN1034"></a>    Tcl_Obj    <span class='Operator'>*</span><span class='Declare_Local'>tcl_trigtup</span><span class='Delimiter'>; 
</span><a name="LN1035"></a>    Tcl_Obj    <span class='Operator'>*</span><span class='Declare_Local'>tcl_newtup</span><span class='Delimiter'>; 
</span><a name="LN1036"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>tcl_rc</span><span class='Delimiter'>; 
</span><a name="LN1037"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1038"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN1039"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>result_Objc</span><span class='Delimiter'>; 
</span><a name="LN1040"></a>    Tcl_Obj   <span class='Operator'>**</span><span class='Declare_Local'>result_Objv</span><span class='Delimiter'>; 
</span><a name="LN1041"></a>    <span class='Keyword'>int </span>rc      <span class='Declare_Local'>PG_USED_FOR_ASSERTS_ONLY</span><span class='Delimiter'>; 
</span> 
    <a href="pltcl.c.html#LN1024"><span class='Ref_to_Parameter'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN209"><span class='Ref_to_Member'>trigdata</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN1029"><span class='Ref_To_Local'>trigdata</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Connect to SPI manager */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/executor/spi.h.html#LN79"><span class='Ref_to_Proto'>SPI_connect</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../include/executor/spi.h.html#LN49"><span class='Ref_to_Const'>SPI_OK_CONNECT</span></a><span class='Parentheses'>)</span> 
        <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not connect to SPI manager"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Make transition tables visible to this SPI connection */ 
</span>    rc <span class='Operator'>= </span><a href="../../include/executor/spi.h.html#LN156"><span class='Ref_to_Proto'>SPI_register_trigger_data</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1029"><span class='Ref_To_Local'>trigdata</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span>rc <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Find or compile the function */ 
</span>    <a href="pltcl.c.html#LN1027"><span class='Ref_To_Local'>prodesc</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN278"><span class='Ref_to_Proto'>compile_pltcl_function</span></a><span class='Parentheses'>(</span>fcinfo<span class='Operator'>-&GT;</span>flinfo<span class='Operator'>-&GT;</span>fn_oid<span class='Delimiter'>, 
</span>                                     <a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1029"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                     <span class='Boolean'>false</span><span class='Delimiter'>,</span>     <span class='Comment_Single_Line'>/* not an event trigger */ 
</span>                                     <a href="pltcl.c.html#LN1025"><span class='Ref_to_Parameter'>pltrusted</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pltcl.c.html#LN1024"><span class='Ref_to_Parameter'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN212"><span class='Ref_to_Member'>prodesc</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN1027"><span class='Ref_To_Local'>prodesc</span></a><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN1027"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN139"><span class='Ref_to_Member'>fn_refcount</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
    <a href="pltcl.c.html#LN1028"><span class='Ref_To_Local'>interp</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN1027"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN144"><span class='Ref_to_Member'>interp_desc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN114"><span class='Ref_to_Member'>interp</span></a><span class='Delimiter'>; 
</span> 
    <a href="pltcl.c.html#LN1031"><span class='Ref_To_Local'>tupdesc</span></a> <span class='Operator'>= </span><a href="../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1029"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Create the tcl command to call the internal 
     * proc in the interpreter 
     ************************************************************/ 
</span>    <a href="pltcl.c.html#LN1033"><span class='Ref_To_Local'>tcl_cmd</span></a> <span class='Operator'>= </span>Tcl_NewObj<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    Tcl_IncrRefCount<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1033"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* The procedure name (note this is all ASCII, so no utf_e2u) */ 
</span>        Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1033"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, 
</span>                            Tcl_NewStringObj<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1027"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN137"><span class='Ref_to_Member'>internal_proname</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* The trigger name for argument TG_name */ 
</span>        Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1033"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, 
</span>                Tcl_NewStringObj<span class='Parentheses'>(</span><a href="../plperl/plperl_helpers.h.html#LN29"><span class='Ref_to_Func'>utf_e2u</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1029"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN36"><span class='Ref_to_Member'>tg_trigger</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/reltrigger.h.html#LN26"><span class='Ref_to_Member'>tgname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* The oid of the trigger relation for argument TG_relid */ 
</span>        <span class='Comment_Multi_Line'>/* Consider not converting to a string for more performance? */ 
</span>        <a href="pltcl.c.html#LN1030"><span class='Ref_To_Local'>stroid</span></a> <span class='Operator'>= </span><a href="../../include/postgres.h.html#LN571"><span class='Ref_to_Macro'>DatumGetCString</span></a><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN583"><span class='Ref_to_Macro'>DirectFunctionCall1</span></a><span class='Parentheses'>(</span><a href="../../backend/utils/adt/oid.c.html#LN125"><span class='Ref_to_Func'>oidout</span></a><span class='Delimiter'>, 
</span>                            <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1029"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN115"><span class='Ref_to_Member'>rd_id</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1033"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, 
</span>                                 Tcl_NewStringObj<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1030"><span class='Ref_To_Local'>stroid</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1030"><span class='Ref_To_Local'>stroid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* The name of the table the trigger is acting on: TG_table_name */ 
</span>        <a href="pltcl.c.html#LN1030"><span class='Ref_To_Local'>stroid</span></a> <span class='Operator'>= </span><a href="../../include/executor/spi.h.html#LN129"><span class='Ref_to_Proto'>SPI_getrelname</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1029"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1033"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, 
</span>                                 Tcl_NewStringObj<span class='Parentheses'>(</span><a href="../plperl/plperl_helpers.h.html#LN29"><span class='Ref_to_Func'>utf_e2u</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1030"><span class='Ref_To_Local'>stroid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1030"><span class='Ref_To_Local'>stroid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* The schema of the table the trigger is acting on: TG_table_schema */ 
</span>        <a href="pltcl.c.html#LN1030"><span class='Ref_To_Local'>stroid</span></a> <span class='Operator'>= </span><a href="../../include/executor/spi.h.html#LN130"><span class='Ref_to_Proto'>SPI_getnspname</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1029"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1033"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, 
</span>                                 Tcl_NewStringObj<span class='Parentheses'>(</span><a href="../plperl/plperl_helpers.h.html#LN29"><span class='Ref_to_Func'>utf_e2u</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1030"><span class='Ref_To_Local'>stroid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1030"><span class='Ref_To_Local'>stroid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* A list of attribute names for argument TG_relatts */ 
</span>        <a href="pltcl.c.html#LN1034"><span class='Ref_To_Local'>tcl_trigtup</span></a> <span class='Operator'>= </span>Tcl_NewObj<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1034"><span class='Ref_To_Local'>tcl_trigtup</span></a><span class='Delimiter'>, </span>Tcl_NewObj<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1037"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pltcl.c.html#LN1037"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="pltcl.c.html#LN1031"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; </span><a href="pltcl.c.html#LN1037"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1031"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN1037"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attisdropped<span class='Parentheses'>) 
</span>                Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1034"><span class='Ref_To_Local'>tcl_trigtup</span></a><span class='Delimiter'>, </span>Tcl_NewObj<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1034"><span class='Ref_To_Local'>tcl_trigtup</span></a><span class='Delimiter'>, 
</span>                                         Tcl_NewStringObj<span class='Parentheses'>(</span><a href="../plperl/plperl_helpers.h.html#LN29"><span class='Ref_to_Func'>utf_e2u</span></a><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1031"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN1037"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attname<span class='Parentheses'>))</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1033"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1034"><span class='Ref_To_Local'>tcl_trigtup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* The when part of the event for TG_when */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN87"><span class='Ref_to_Macro'>TRIGGER_FIRED_BEFORE</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1029"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
            Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1033"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, 
</span>                                     Tcl_NewStringObj<span class='Parentheses'>(</span><span class='String'>"BEFORE"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN90"><span class='Ref_to_Macro'>TRIGGER_FIRED_AFTER</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1029"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
            Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1033"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, 
</span>                                     Tcl_NewStringObj<span class='Parentheses'>(</span><span class='String'>"AFTER"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN93"><span class='Ref_to_Macro'>TRIGGER_FIRED_INSTEAD</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1029"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
            Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1033"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, 
</span>                                     Tcl_NewStringObj<span class='Parentheses'>(</span><span class='String'>"INSTEAD OF"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized WHEN tg_event: %u"</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1029"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* The level part of the event for TG_level */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN81"><span class='Ref_to_Macro'>TRIGGER_FIRED_FOR_ROW</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1029"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1033"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, 
</span>                                     Tcl_NewStringObj<span class='Parentheses'>(</span><span class='String'>"ROW"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Build the data list for the trigtuple */ 
</span>            <a href="pltcl.c.html#LN1034"><span class='Ref_To_Local'>tcl_trigtup</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN321"><span class='Ref_to_Proto'>pltcl_build_tuple_argument</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1029"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN34"><span class='Ref_to_Member'>tg_trigtuple</span></a><span class='Delimiter'>, 
</span>                                                     <a href="pltcl.c.html#LN1031"><span class='Ref_To_Local'>tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Now the command part of the event for TG_op and data for NEW 
             * and OLD 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN69"><span class='Ref_to_Macro'>TRIGGER_FIRED_BY_INSERT</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1029"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1033"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, 
</span>                                         Tcl_NewStringObj<span class='Parentheses'>(</span><span class='String'>"INSERT"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
                Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1033"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1034"><span class='Ref_To_Local'>tcl_trigtup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1033"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, </span>Tcl_NewObj<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
                <a href="pltcl.c.html#LN1032"><span class='Ref_To_Local'>rettup</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN1029"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN34"><span class='Ref_to_Member'>tg_trigtuple</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN72"><span class='Ref_to_Macro'>TRIGGER_FIRED_BY_DELETE</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1029"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1033"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, 
</span>                                         Tcl_NewStringObj<span class='Parentheses'>(</span><span class='String'>"DELETE"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
                Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1033"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, </span>Tcl_NewObj<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>                Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1033"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1034"><span class='Ref_To_Local'>tcl_trigtup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="pltcl.c.html#LN1032"><span class='Ref_To_Local'>rettup</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN1029"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN34"><span class='Ref_to_Member'>tg_trigtuple</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN75"><span class='Ref_to_Macro'>TRIGGER_FIRED_BY_UPDATE</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1029"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1033"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, 
</span>                                         Tcl_NewStringObj<span class='Parentheses'>(</span><span class='String'>"UPDATE"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
                <a href="pltcl.c.html#LN1035"><span class='Ref_To_Local'>tcl_newtup</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN321"><span class='Ref_to_Proto'>pltcl_build_tuple_argument</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1029"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN35"><span class='Ref_to_Member'>tg_newtuple</span></a><span class='Delimiter'>, 
</span>                                                        <a href="pltcl.c.html#LN1031"><span class='Ref_To_Local'>tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1033"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1035"><span class='Ref_To_Local'>tcl_newtup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1033"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1034"><span class='Ref_To_Local'>tcl_trigtup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="pltcl.c.html#LN1032"><span class='Ref_To_Local'>rettup</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN1029"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN35"><span class='Ref_to_Member'>tg_newtuple</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
                <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized OP tg_event: %u"</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1029"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if TRIGGER_FIRED_FOR_ROW... &raquo; </span> 
        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN84"><span class='Ref_to_Macro'>TRIGGER_FIRED_FOR_STATEMENT</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1029"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1033"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, 
</span>                                     Tcl_NewStringObj<span class='Parentheses'>(</span><span class='String'>"STATEMENT"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN69"><span class='Ref_to_Macro'>TRIGGER_FIRED_BY_INSERT</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1029"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
                Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1033"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, 
</span>                                         Tcl_NewStringObj<span class='Parentheses'>(</span><span class='String'>"INSERT"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN72"><span class='Ref_to_Macro'>TRIGGER_FIRED_BY_DELETE</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1029"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
                Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1033"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, 
</span>                                         Tcl_NewStringObj<span class='Parentheses'>(</span><span class='String'>"DELETE"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN75"><span class='Ref_to_Macro'>TRIGGER_FIRED_BY_UPDATE</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1029"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
                Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1033"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, 
</span>                                         Tcl_NewStringObj<span class='Parentheses'>(</span><span class='String'>"UPDATE"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/trigger.h.html#LN78"><span class='Ref_to_Macro'>TRIGGER_FIRED_BY_TRUNCATE</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1029"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
                Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1033"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, 
</span>                                         Tcl_NewStringObj<span class='Parentheses'>(</span><span class='String'>"TRUNCATE"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized OP tg_event: %u"</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1029"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1033"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, </span>Tcl_NewObj<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>            Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1033"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, </span>Tcl_NewObj<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
            <a href="pltcl.c.html#LN1032"><span class='Ref_To_Local'>rettup</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a><span class='Parentheses'>) </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if TRIGGER_FIRED_FOR_STA... &raquo; </span> 
        <span class='Control'>else</span> 
            <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized LEVEL tg_event: %u"</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1029"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Finally append the arguments from CREATE TRIGGER */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1037"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pltcl.c.html#LN1037"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="pltcl.c.html#LN1029"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN36"><span class='Ref_to_Member'>tg_trigger</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/reltrigger.h.html#LN36"><span class='Ref_to_Member'>tgnargs</span></a><span class='Delimiter'>; </span><a href="pltcl.c.html#LN1037"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1033"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, 
</span>             Tcl_NewStringObj<span class='Parentheses'>(</span><a href="../plperl/plperl_helpers.h.html#LN29"><span class='Ref_to_Func'>utf_e2u</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1029"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN36"><span class='Ref_to_Member'>tg_trigger</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/reltrigger.h.html#LN39"><span class='Ref_to_Member'>tgargs</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN1037"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        Tcl_DecrRefCount<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1033"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN310"><span class='Ref_to_Macro'>PG_RE_THROW</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Call the Tcl function 
     * 
     * We assume no PG error can be thrown directly from this call. 
     ************************************************************/ 
</span>    <a href="pltcl.c.html#LN1036"><span class='Ref_To_Local'>tcl_rc</span></a> <span class='Operator'>= </span>Tcl_EvalObjEx<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1028"><span class='Ref_To_Local'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1033"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span>TCL_EVAL_DIRECT <span class='Operator'>| </span>TCL_EVAL_GLOBAL<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Release refcount to free tcl_cmd (and all subsidiary objects) */ 
</span>    Tcl_DecrRefCount<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1033"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Check for errors reported by Tcl. 
     ************************************************************/ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1036"><span class='Ref_To_Local'>tcl_rc</span></a> <span class='Operator'>!= </span>TCL_OK<span class='Parentheses'>) 
</span>        <a href="pltcl.c.html#LN276"><span class='Ref_to_Proto'>throw_tcl_error</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1028"><span class='Ref_To_Local'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1027"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN136"><span class='Ref_to_Member'>user_proname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Exit SPI environment. 
     ************************************************************/ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/executor/spi.h.html#LN80"><span class='Ref_to_Proto'>SPI_finish</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../include/executor/spi.h.html#LN50"><span class='Ref_to_Const'>SPI_OK_FINISH</span></a><span class='Parentheses'>)</span> 
        <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_finish() failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * The return value from the procedure might be one of 
     * the magic strings OK or SKIP, or a list from array get. 
     * We can check for OK or SKIP without worrying about encoding. 
     ************************************************************/ 
</span>    <a href="pltcl.c.html#LN1038"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span>Tcl_GetStringResult<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1028"><span class='Ref_To_Local'>interp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1038"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><span class='String'>"OK"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <a href="pltcl.c.html#LN1032"><span class='Ref_To_Local'>rettup</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1038"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><span class='String'>"SKIP"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a><span class='Parentheses'>) </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Otherwise, the return value should be a column name/value list 
     * specifying the modified tuple to return. 
     ************************************************************/ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>Tcl_ListObjGetElements<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1028"><span class='Ref_To_Local'>interp</span></a><span class='Delimiter'>, </span>Tcl_GetObjResult<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1028"><span class='Ref_To_Local'>interp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                               <span class='Operator'>&</span><a href="pltcl.c.html#LN1039"><span class='Ref_To_Local'>result_Objc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pltcl.c.html#LN1040"><span class='Ref_To_Local'>result_Objv</span></a><span class='Parentheses'>)</span> <span class='Operator'>!= </span>TCL_OK<span class='Parentheses'>)</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_E_R_I_E_TRIGGER_PROTOCOL_VIOLATED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not split return value from trigger: %s"</span><span class='Delimiter'>, 
</span>                        <a href="../plperl/plperl_helpers.h.html#LN10"><span class='Ref_to_Func'>utf_u2e</span></a><span class='Parentheses'>(</span>Tcl_GetStringResult<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1028"><span class='Ref_To_Local'>interp</span></a><span class='Parentheses'>)))))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Convert function result to tuple */ 
</span>    <a href="pltcl.c.html#LN1032"><span class='Ref_To_Local'>rettup</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN322"><span class='Ref_to_Proto'>pltcl_build_tuple_result</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1028"><span class='Ref_To_Local'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1040"><span class='Ref_To_Local'>result_Objv</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1039"><span class='Ref_To_Local'>result_Objc</span></a><span class='Delimiter'>, 
</span>                                      <a href="pltcl.c.html#LN1024"><span class='Ref_to_Parameter'>call_state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="pltcl.c.html#LN1032"><span class='Ref_To_Local'>rettup</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pltcl_trigger_handler &raquo; </span> 
 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * pltcl_event_trigger_handler()    - Handler for event trigger calls 
 **********************************************************************/ 
</span><span class='Keyword'>static void 
</span><a name="LN1276"></a><span class='Declare_Function'>pltcl_event_trigger_handler</span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN203"><span class='Ref_to_Struct'>pltcl_call_state</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>call_state</span><span class='Delimiter'>, 
</span><a name="LN1277"></a>                            <span class='Keyword'>bool </span><span class='Declare_Parameter'>pltrusted</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1279"></a>    <a href="pltcl.c.html#LN134"><span class='Ref_to_Struct'>pltcl_proc_desc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>prodesc</span><span class='Delimiter'>; 
</span><a name="LN1280"></a>    Tcl_Interp <span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Declare_Local'>interp</span><span class='Delimiter'>; 
</span><a name="LN1281"></a>    <a href="../../include/commands/event_trigger.h.html#LN22"><span class='Ref_to_Struct'>EventTriggerData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tdata</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/commands/event_trigger.h.html#LN22"><span class='Ref_to_Struct'>EventTriggerData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span>fcinfo<span class='Operator'>-&GT;</span>context<span class='Delimiter'>; 
</span><a name="LN1282"></a>    Tcl_Obj    <span class='Operator'>*</span><span class='Declare_Local'>tcl_cmd</span><span class='Delimiter'>; 
</span><a name="LN1283"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>tcl_rc</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Connect to SPI manager */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/executor/spi.h.html#LN79"><span class='Ref_to_Proto'>SPI_connect</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../include/executor/spi.h.html#LN49"><span class='Ref_to_Const'>SPI_OK_CONNECT</span></a><span class='Parentheses'>)</span> 
        <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not connect to SPI manager"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Find or compile the function */ 
</span>    <a href="pltcl.c.html#LN1279"><span class='Ref_To_Local'>prodesc</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN278"><span class='Ref_to_Proto'>compile_pltcl_function</span></a><span class='Parentheses'>(</span>fcinfo<span class='Operator'>-&GT;</span>flinfo<span class='Operator'>-&GT;</span>fn_oid<span class='Delimiter'>, 
</span>                                     <a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1277"><span class='Ref_to_Parameter'>pltrusted</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pltcl.c.html#LN1276"><span class='Ref_to_Parameter'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN212"><span class='Ref_to_Member'>prodesc</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN1279"><span class='Ref_To_Local'>prodesc</span></a><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN1279"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN139"><span class='Ref_to_Member'>fn_refcount</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
    <a href="pltcl.c.html#LN1280"><span class='Ref_To_Local'>interp</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN1279"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN144"><span class='Ref_to_Member'>interp_desc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN114"><span class='Ref_to_Member'>interp</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Create the tcl command and call the internal proc */ 
</span>    <a href="pltcl.c.html#LN1282"><span class='Ref_To_Local'>tcl_cmd</span></a> <span class='Operator'>= </span>Tcl_NewObj<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    Tcl_IncrRefCount<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1282"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1282"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, 
</span>                             Tcl_NewStringObj<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1279"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN137"><span class='Ref_to_Member'>internal_proname</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1282"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, 
</span>                             Tcl_NewStringObj<span class='Parentheses'>(</span><a href="../plperl/plperl_helpers.h.html#LN29"><span class='Ref_to_Func'>utf_e2u</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1281"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/event_trigger.h.html#LN25"><span class='Ref_to_Member'>event</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1282"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, 
</span>                             Tcl_NewStringObj<span class='Parentheses'>(</span><a href="../plperl/plperl_helpers.h.html#LN29"><span class='Ref_to_Func'>utf_e2u</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1281"><span class='Ref_To_Local'>tdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/event_trigger.h.html#LN27"><span class='Ref_to_Member'>tag</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="pltcl.c.html#LN1283"><span class='Ref_To_Local'>tcl_rc</span></a> <span class='Operator'>= </span>Tcl_EvalObjEx<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1280"><span class='Ref_To_Local'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1282"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span>TCL_EVAL_DIRECT <span class='Operator'>| </span>TCL_EVAL_GLOBAL<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Release refcount to free tcl_cmd (and all subsidiary objects) */ 
</span>    Tcl_DecrRefCount<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1282"><span class='Ref_To_Local'>tcl_cmd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Check for errors reported by Tcl. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1283"><span class='Ref_To_Local'>tcl_rc</span></a> <span class='Operator'>!= </span>TCL_OK<span class='Parentheses'>) 
</span>        <a href="pltcl.c.html#LN276"><span class='Ref_to_Proto'>throw_tcl_error</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1280"><span class='Ref_To_Local'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1279"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN136"><span class='Ref_to_Member'>user_proname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/executor/spi.h.html#LN80"><span class='Ref_to_Proto'>SPI_finish</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../include/executor/spi.h.html#LN50"><span class='Ref_to_Const'>SPI_OK_FINISH</span></a><span class='Parentheses'>)</span> 
        <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_finish() failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pltcl_event_trigger_handler &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * throw_tcl_error  - ereport an error returned from the Tcl interpreter 
 **********************************************************************/ 
</span><span class='Keyword'>static void 
</span><a name="LN1326"></a><span class='Declare_Function'>throw_tcl_error</span><span class='Parentheses'>(</span>Tcl_Interp <span class='Operator'>*</span><span class='Declare_Parameter'>interp</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>proname</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Caution is needed here because Tcl_GetVar could overwrite the 
     * interpreter result (even though it's not really supposed to), and we 
     * can't control the order of evaluation of ereport arguments. Hence, make 
     * real sure we have our own copy of the result string before invoking 
     * Tcl_GetVar. 
     */ 
</span><a name="LN1335"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>emsg</span><span class='Delimiter'>; 
</span><a name="LN1336"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>econtext</span><span class='Delimiter'>; 
</span> 
    <a href="pltcl.c.html#LN1335"><span class='Ref_To_Local'>emsg</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="../plperl/plperl_helpers.h.html#LN10"><span class='Ref_to_Func'>utf_u2e</span></a><span class='Parentheses'>(</span>Tcl_GetStringResult<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1326"><span class='Ref_to_Parameter'>interp</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN1336"><span class='Ref_To_Local'>econtext</span></a> <span class='Operator'>= </span><a href="../plperl/plperl_helpers.h.html#LN10"><span class='Ref_to_Func'>utf_u2e</span></a><span class='Parentheses'>(</span>Tcl_GetVar<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1326"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><span class='String'>"errorInfo"</span><span class='Delimiter'>, </span>TCL_GLOBAL_ONLY<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_EXTERNAL_ROUTINE_EXCEPTION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1335"><span class='Ref_To_Local'>emsg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             errcontext<span class='Parentheses'>(</span><span class='String'>"%s\nin PL/Tcl function \"%s\""</span><span class='Delimiter'>, 
</span>                        <a href="pltcl.c.html#LN1336"><span class='Ref_To_Local'>econtext</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1326"><span class='Ref_to_Parameter'>proname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end throw_tcl_error &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * compile_pltcl_function   - compile (or hopefully just look up) function 
 * 
 * tgreloid is the OID of the relation when compiling a trigger, or zero 
 * (InvalidOid) when compiling a plain function. 
 **********************************************************************/ 
</span><span class='Keyword'>static </span><a href="pltcl.c.html#LN134"><span class='Ref_to_Struct'>pltcl_proc_desc</span></a> <span class='Operator'>* 
</span><a name="LN1355"></a><span class='Declare_Function'>compile_pltcl_function</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>fn_oid</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>tgreloid</span><span class='Delimiter'>, 
</span><a name="LN1356"></a>                       <span class='Keyword'>bool </span><span class='Declare_Parameter'>is_event_trigger</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>pltrusted</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1358"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>procTup</span><span class='Delimiter'>; 
</span><a name="LN1359"></a>    <a href="../../include/catalog/pg_proc.h.html#LN82"><span class='Ref_to_Typedef'>Form_pg_proc</span></a> <span class='Declare_Local'>procStruct</span><span class='Delimiter'>; 
</span><a name="LN1360"></a>    <a href="pltcl.c.html#LN181"><span class='Ref_to_Struct'>pltcl_proc_key</span></a> <span class='Declare_Local'>proc_key</span><span class='Delimiter'>; 
</span><a name="LN1361"></a>    <a href="pltcl.c.html#LN193"><span class='Ref_to_Struct'>pltcl_proc_ptr</span></a> <span class='Operator'>*</span><span class='Declare_Local'>proc_ptr</span><span class='Delimiter'>; 
</span><a name="LN1362"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span><a name="LN1363"></a>    <a href="pltcl.c.html#LN134"><span class='Ref_to_Struct'>pltcl_proc_desc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>prodesc</span><span class='Delimiter'>; 
</span><a name="LN1364"></a>    <a href="pltcl.c.html#LN134"><span class='Ref_to_Struct'>pltcl_proc_desc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>old_prodesc</span><span class='Delimiter'>; 
</span><a name="LN1365"></a>    <span class='Keyword'>volatile </span><a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>proc_cxt</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1366"></a>    Tcl_DString <span class='Declare_Local'>proc_internal_def</span><span class='Delimiter'>; 
</span><a name="LN1367"></a>    Tcl_DString <span class='Declare_Local'>proc_internal_body</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We'll need the pg_proc tuple in any case... */ 
</span>    <a href="pltcl.c.html#LN1358"><span class='Ref_To_Local'>procTup</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN76"><span class='Ref_to_EnumConst'>PROCOID</span></a><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1355"><span class='Ref_to_Parameter'>fn_oid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1358"><span class='Ref_To_Local'>procTup</span></a><span class='Parentheses'>))</span> 
        <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cache lookup failed for function %u"</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1355"><span class='Ref_to_Parameter'>fn_oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN1359"><span class='Ref_To_Local'>procStruct</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_proc.h.html#LN82"><span class='Ref_to_Typedef'>Form_pg_proc</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1358"><span class='Ref_To_Local'>procTup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Look up function in pltcl_proc_htab; if it's not there, create an entry 
     * and set the entry's proc_ptr to NULL. 
     */ 
</span>    <a href="pltcl.c.html#LN1360"><span class='Ref_To_Local'>proc_key</span></a><span class='Operator'>.</span><a href="pltcl.c.html#LN183"><span class='Ref_to_Member'>proc_id</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN1355"><span class='Ref_to_Parameter'>fn_oid</span></a><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN1360"><span class='Ref_To_Local'>proc_key</span></a><span class='Operator'>.</span><a href="pltcl.c.html#LN189"><span class='Ref_to_Member'>is_trigger</span></a> <span class='Operator'>= </span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1355"><span class='Ref_to_Parameter'>tgreloid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN1360"><span class='Ref_To_Local'>proc_key</span></a><span class='Operator'>.</span><a href="pltcl.c.html#LN190"><span class='Ref_to_Member'>user_id</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN1356"><span class='Ref_to_Parameter'>pltrusted</span></a> <span class='Operator'>? </span><a href="../../backend/utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>() </span><span class='Operator'>: </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span> 
    <a href="pltcl.c.html#LN1361"><span class='Ref_To_Local'>proc_ptr</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN237"><span class='Ref_to_Global_Var'>pltcl_proc_htab</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pltcl.c.html#LN1360"><span class='Ref_To_Local'>proc_key</span></a><span class='Delimiter'>, 
</span>                           <a href="../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a><span class='Delimiter'>, 
</span>                           <span class='Operator'>&</span><a href="pltcl.c.html#LN1362"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pltcl.c.html#LN1362"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>        <a href="pltcl.c.html#LN1361"><span class='Ref_To_Local'>proc_ptr</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN196"><span class='Ref_to_Member'>proc_ptr</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="pltcl.c.html#LN1363"><span class='Ref_To_Local'>prodesc</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN1361"><span class='Ref_To_Local'>proc_ptr</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN196"><span class='Ref_to_Member'>proc_ptr</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * If it's present, must check whether it's still up to date. 
     * This is needed because CREATE OR REPLACE FUNCTION can modify the 
     * function's pg_proc entry without changing its OID. 
     ************************************************************/ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1363"><span class='Ref_To_Local'>prodesc</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& 
</span>        <a href="pltcl.c.html#LN1363"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN140"><span class='Ref_to_Member'>fn_xmin</span></a> <span class='Operator'>== </span><a href="../../include/access/htup_details.h.html#LN301"><span class='Ref_to_Macro'>HeapTupleHeaderGetRawXmin</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1358"><span class='Ref_To_Local'>procTup</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>        <a href="../../backend/storage/page/itemptr.c.html#LN27"><span class='Ref_to_Func'>ItemPointerEquals</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pltcl.c.html#LN1363"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN141"><span class='Ref_to_Member'>fn_tid</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pltcl.c.html#LN1358"><span class='Ref_To_Local'>procTup</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* It's still up-to-date, so we can use it */ 
</span>        <a href="../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1358"><span class='Ref_To_Local'>procTup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="pltcl.c.html#LN1363"><span class='Ref_To_Local'>prodesc</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * If we haven't found it in the hashtable, we analyze 
     * the functions arguments and returntype and store 
     * the in-/out-functions in the prodesc block and create 
     * a new hashtable entry for it. 
     * 
     * Then we load the procedure into the Tcl interpreter. 
     ************************************************************/ 
</span>    Tcl_DStringInit<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pltcl.c.html#LN1366"><span class='Ref_To_Local'>proc_internal_def</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    Tcl_DStringInit<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pltcl.c.html#LN1367"><span class='Ref_To_Local'>proc_internal_body</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1417"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>is_trigger</span> <span class='Operator'>= </span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1355"><span class='Ref_to_Parameter'>tgreloid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1418"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>internal_proname</span><span class='Delimiter'>[</span><span class='Number'>128</span><span class='Delimiter'>]; 
</span><a name="LN1419"></a>        <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>typeTup</span><span class='Delimiter'>; 
</span><a name="LN1420"></a>        <a href="../../include/catalog/pg_type.h.html#LN232"><span class='Ref_to_Typedef'>Form_pg_type</span></a> <span class='Declare_Local'>typeStruct</span><span class='Delimiter'>; 
</span><a name="LN1421"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>proc_internal_args</span><span class='Delimiter'>[</span><span class='Number'>33</span> <span class='Operator'>* </span><a href="../../include/pg_config_manual.h.html#LN36"><span class='Ref_to_Const'>FUNC_MAX_ARGS</span></a><span class='Delimiter'>]; 
</span><a name="LN1422"></a>        <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>prosrcdatum</span><span class='Delimiter'>; 
</span><a name="LN1423"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull</span><span class='Delimiter'>; 
</span><a name="LN1424"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>proc_source</span><span class='Delimiter'>; 
</span><a name="LN1425"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>buf</span><span class='Delimiter'>[</span><span class='Number'>32</span><span class='Delimiter'>]; 
</span><a name="LN1426"></a>        Tcl_Interp <span class='Operator'>*</span><span class='Declare_Local'>interp</span><span class='Delimiter'>; 
</span><a name="LN1427"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1428"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>tcl_rc</span><span class='Delimiter'>; 
</span><a name="LN1429"></a>        <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * Build our internal proc name from the function's Oid.  Append 
         * "_trigger" when appropriate to ensure the normal and trigger 
         * cases are kept separate.  Note name must be all-ASCII. 
         ************************************************************/ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1356"><span class='Ref_to_Parameter'>is_event_trigger</span></a><span class='Parentheses'>) 
</span>            <a href="../plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1418"><span class='Ref_To_Local'>internal_proname</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1418"><span class='Ref_To_Local'>internal_proname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <span class='String'>"__PLTcl_proc_%u_evttrigger"</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1355"><span class='Ref_to_Parameter'>fn_oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1417"><span class='Ref_To_Local'>is_trigger</span></a><span class='Parentheses'>) 
</span>            <a href="../plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1418"><span class='Ref_To_Local'>internal_proname</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1418"><span class='Ref_To_Local'>internal_proname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <span class='String'>"__PLTcl_proc_%u_trigger"</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1355"><span class='Ref_to_Parameter'>fn_oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1418"><span class='Ref_To_Local'>internal_proname</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1418"><span class='Ref_To_Local'>internal_proname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <span class='String'>"__PLTcl_proc_%u"</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1355"><span class='Ref_to_Parameter'>fn_oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * Allocate a context that will hold all PG data for the procedure. 
         * We use the internal proc name as the context name. 
         ************************************************************/ 
</span>        <a href="pltcl.c.html#LN1365"><span class='Ref_To_Local'>proc_cxt</span></a> <span class='Operator'>= </span><a href="../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../../backend/utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, 
</span>                                         <a href="pltcl.c.html#LN1418"><span class='Ref_To_Local'>internal_proname</span></a><span class='Delimiter'>, 
</span>                                         <a href="../../include/utils/memutils.h.html#LN174"><span class='Ref_to_Const'>ALLOCSET_SMALL_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * Allocate and fill a new procedure description block. 
         * struct prodesc and subsidiary data must all live in proc_cxt. 
         ************************************************************/ 
</span>        <a href="pltcl.c.html#LN1429"><span class='Ref_To_Local'>oldcontext</span></a> <span class='Operator'>= </span><a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1365"><span class='Ref_To_Local'>proc_cxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN1363"><span class='Ref_To_Local'>prodesc</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN134"><span class='Ref_to_Struct'>pltcl_proc_desc</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN134"><span class='Ref_to_Struct'>pltcl_proc_desc</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN1363"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN136"><span class='Ref_to_Member'>user_proname</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1359"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>proname<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN1363"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN137"><span class='Ref_to_Member'>internal_proname</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1418"><span class='Ref_To_Local'>internal_proname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN1363"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN138"><span class='Ref_to_Member'>fn_cxt</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN1365"><span class='Ref_To_Local'>proc_cxt</span></a><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN1363"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN139"><span class='Ref_to_Member'>fn_refcount</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN1363"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN140"><span class='Ref_to_Member'>fn_xmin</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN301"><span class='Ref_to_Macro'>HeapTupleHeaderGetRawXmin</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1358"><span class='Ref_To_Local'>procTup</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN1363"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN141"><span class='Ref_to_Member'>fn_tid</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN1358"><span class='Ref_To_Local'>procTup</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN1363"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN149"><span class='Ref_to_Member'>nargs</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN1359"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>pronargs<span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN1363"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN151"><span class='Ref_to_Member'>arg_out_func</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1363"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN149"><span class='Ref_to_Member'>nargs</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN1363"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN152"><span class='Ref_to_Member'>arg_is_rowtype</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1363"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN149"><span class='Ref_to_Member'>nargs</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>bool</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1429"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Remember if function is STABLE/IMMUTABLE */ 
</span>        <a href="pltcl.c.html#LN1363"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN142"><span class='Ref_to_Member'>fn_readonly</span></a> <span class='Operator'>= 
</span>            <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1359"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>provolatile <span class='Operator'>!= </span><a href="../../include/catalog/pg_proc.h.html#LN5484"><span class='Ref_to_Const'>PROVOLATILE_VOLATILE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* And whether it is trusted */ 
</span>        <a href="pltcl.c.html#LN1363"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN143"><span class='Ref_to_Member'>lanpltrusted</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN1356"><span class='Ref_to_Parameter'>pltrusted</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * Identify the interpreter to use for the function 
         ************************************************************/ 
</span>        <a href="pltcl.c.html#LN1363"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN144"><span class='Ref_to_Member'>interp_desc</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN263"><span class='Ref_to_Proto'>pltcl_fetch_interp</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1359"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>prolang<span class='Delimiter'>, 
</span>                                                  <a href="pltcl.c.html#LN1363"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN143"><span class='Ref_to_Member'>lanpltrusted</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN1426"><span class='Ref_To_Local'>interp</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN1363"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN144"><span class='Ref_to_Member'>interp_desc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN114"><span class='Ref_to_Member'>interp</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * Get the required information for input conversion of the 
         * return value. 
         ************************************************************/ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pltcl.c.html#LN1417"><span class='Ref_To_Local'>is_trigger</span></a> <span class='Operator'>&& !</span><a href="pltcl.c.html#LN1356"><span class='Ref_to_Parameter'>is_event_trigger</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="pltcl.c.html#LN1419"><span class='Ref_To_Local'>typeTup</span></a> <span class='Operator'>= 
</span>                <a href="../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN107"><span class='Ref_to_EnumConst'>TYPEOID</span></a><span class='Delimiter'>, 
</span>                                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1359"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>prorettype<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1419"><span class='Ref_To_Local'>typeTup</span></a><span class='Parentheses'>))</span> 
                <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cache lookup failed for type %u"</span><span class='Delimiter'>, 
</span>                     <a href="pltcl.c.html#LN1359"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>prorettype<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pltcl.c.html#LN1420"><span class='Ref_To_Local'>typeStruct</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_type.h.html#LN232"><span class='Ref_to_Typedef'>Form_pg_type</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1419"><span class='Ref_To_Local'>typeTup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Disallow pseudotype result, except VOID and RECORD */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1420"><span class='Ref_To_Local'>typeStruct</span></a><span class='Operator'>-&GT;</span>typtype <span class='Operator'>== </span><a href="../../include/catalog/pg_type.h.html#LN723"><span class='Ref_to_Const'>TYPTYPE_PSEUDO</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1359"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>prorettype <span class='Operator'>== </span><a href="../../include/catalog/pg_type.h.html#LN689"><span class='Ref_to_Const'>VOIDOID</span></a> <span class='Operator'>|| 
</span>                    <a href="pltcl.c.html#LN1359"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>prorettype <span class='Operator'>== </span><a href="../../include/catalog/pg_type.h.html#LN679"><span class='Ref_to_Const'>RECORDOID</span></a><span class='Parentheses'>) 
</span>                     <span class='Comment_Multi_Line'>/* okay */ </span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1359"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>prorettype <span class='Operator'>== </span><a href="../../include/catalog/pg_type.h.html#LN691"><span class='Ref_to_Const'>TRIGGEROID</span></a> <span class='Operator'>|| 
</span>                         <a href="pltcl.c.html#LN1359"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>prorettype <span class='Operator'>== </span><a href="../../include/catalog/pg_type.h.html#LN693"><span class='Ref_to_Const'>EVTTRIGGEROID</span></a><span class='Parentheses'>) 
</span>                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"trigger functions can only be called as triggers"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"PL/Tcl functions cannot return type %s"</span><span class='Delimiter'>, 
</span>                                    <a href="../../backend/utils/adt/format_type.c.html#LN92"><span class='Ref_to_Func'>format_type_be</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1359"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>prorettype<span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="../../include/fmgr.h.html#LN99"><span class='Ref_to_Proto'>fmgr_info_cxt</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1420"><span class='Ref_To_Local'>typeStruct</span></a><span class='Operator'>-&GT;</span>typinput<span class='Delimiter'>, 
</span>                          <span class='Operator'>&</span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1363"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN145"><span class='Ref_to_Member'>result_in_func</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                          <a href="pltcl.c.html#LN1365"><span class='Ref_To_Local'>proc_cxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pltcl.c.html#LN1363"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN146"><span class='Ref_to_Member'>result_typioparam</span></a> <span class='Operator'>= </span><a href="../../include/utils/lsyscache.h.html#LN138"><span class='Ref_to_Proto'>getTypeIOParam</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1419"><span class='Ref_To_Local'>typeTup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="pltcl.c.html#LN1363"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN147"><span class='Ref_to_Member'>fn_retisset</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN1359"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>proretset<span class='Delimiter'>; 
</span>            <a href="pltcl.c.html#LN1363"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN148"><span class='Ref_to_Member'>fn_retistuple</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1359"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>prorettype <span class='Operator'>== </span><a href="../../include/catalog/pg_type.h.html#LN679"><span class='Ref_to_Const'>RECORDOID</span></a> <span class='Operator'>|| 
</span>                                   <a href="pltcl.c.html#LN1420"><span class='Ref_To_Local'>typeStruct</span></a><span class='Operator'>-&GT;</span>typtype <span class='Operator'>== </span><a href="../../include/catalog/pg_type.h.html#LN720"><span class='Ref_to_Const'>TYPTYPE_COMPOSITE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1419"><span class='Ref_To_Local'>typeTup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !is_trigger&&!is_even... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * Get the required information for output conversion 
         * of all procedure arguments, and set up argument naming info. 
         ************************************************************/ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pltcl.c.html#LN1417"><span class='Ref_To_Local'>is_trigger</span></a> <span class='Operator'>&& !</span><a href="pltcl.c.html#LN1356"><span class='Ref_to_Parameter'>is_event_trigger</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="pltcl.c.html#LN1421"><span class='Ref_To_Local'>proc_internal_args</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1427"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pltcl.c.html#LN1427"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="pltcl.c.html#LN1363"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN149"><span class='Ref_to_Member'>nargs</span></a><span class='Delimiter'>; </span><a href="pltcl.c.html#LN1427"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="pltcl.c.html#LN1419"><span class='Ref_To_Local'>typeTup</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN107"><span class='Ref_to_EnumConst'>TYPEOID</span></a><span class='Delimiter'>, 
</span>                        <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1359"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>proargtypes<span class='Operator'>.</span>values<span class='Delimiter'>[</span><a href="pltcl.c.html#LN1427"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1419"><span class='Ref_To_Local'>typeTup</span></a><span class='Parentheses'>))</span> 
                    <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cache lookup failed for type %u"</span><span class='Delimiter'>, 
</span>                         <a href="pltcl.c.html#LN1359"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>proargtypes<span class='Operator'>.</span>values<span class='Delimiter'>[</span><a href="pltcl.c.html#LN1427"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="pltcl.c.html#LN1420"><span class='Ref_To_Local'>typeStruct</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_type.h.html#LN232"><span class='Ref_to_Typedef'>Form_pg_type</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1419"><span class='Ref_To_Local'>typeTup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* Disallow pseudotype argument */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1420"><span class='Ref_To_Local'>typeStruct</span></a><span class='Operator'>-&GT;</span>typtype <span class='Operator'>== </span><a href="../../include/catalog/pg_type.h.html#LN723"><span class='Ref_to_Const'>TYPTYPE_PSEUDO</span></a><span class='Parentheses'>) 
</span>                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"PL/Tcl functions cannot accept type %s"</span><span class='Delimiter'>, 
</span>                        <a href="../../backend/utils/adt/format_type.c.html#LN92"><span class='Ref_to_Func'>format_type_be</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1359"><span class='Ref_To_Local'>procStruct</span></a><span class='Operator'>-&GT;</span>proargtypes<span class='Operator'>.</span>values<span class='Delimiter'>[</span><a href="pltcl.c.html#LN1427"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1420"><span class='Ref_To_Local'>typeStruct</span></a><span class='Operator'>-&GT;</span>typtype <span class='Operator'>== </span><a href="../../include/catalog/pg_type.h.html#LN720"><span class='Ref_to_Const'>TYPTYPE_COMPOSITE</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="pltcl.c.html#LN1363"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN152"><span class='Ref_to_Member'>arg_is_rowtype</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN1427"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                    <a href="../plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1425"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1425"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"__PLTcl_Tup_%d"</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1427"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="pltcl.c.html#LN1363"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN152"><span class='Ref_to_Member'>arg_is_rowtype</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN1427"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                    <a href="../../include/fmgr.h.html#LN99"><span class='Ref_to_Proto'>fmgr_info_cxt</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1420"><span class='Ref_To_Local'>typeStruct</span></a><span class='Operator'>-&GT;</span>typoutput<span class='Delimiter'>, 
</span>                                  <span class='Operator'>&</span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1363"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN151"><span class='Ref_to_Member'>arg_out_func</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN1427"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                  <a href="pltcl.c.html#LN1365"><span class='Ref_To_Local'>proc_cxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1425"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1425"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%d"</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1427"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1427"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                    strcat<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1421"><span class='Ref_To_Local'>proc_internal_args</span></a><span class='Delimiter'>, </span><span class='String'>" "</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                strcat<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1421"><span class='Ref_To_Local'>proc_internal_args</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1425"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1419"><span class='Ref_To_Local'>typeTup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;prodesc-&GT;nargs;... &raquo; </span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !is_trigger&&!is_even... &raquo; </span> 
        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1417"><span class='Ref_To_Local'>is_trigger</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* trigger procedure has fixed args */ 
</span>            <a href="../../../contrib/cube/cubeparse.y.html#LN150"><span class='Ref_to_Proto'>strcpy</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1421"><span class='Ref_To_Local'>proc_internal_args</span></a><span class='Delimiter'>, 
</span>                   <span class='String'>"TG_name TG_relid TG_table_name TG_table_schema TG_relatts TG_when TG_level TG_op __PLTcl_Tup_NEW __PLTcl_Tup_OLD args"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1356"><span class='Ref_to_Parameter'>is_event_trigger</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* event trigger procedure has fixed args */ 
</span>            <a href="../../../contrib/cube/cubeparse.y.html#LN150"><span class='Ref_to_Proto'>strcpy</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1421"><span class='Ref_To_Local'>proc_internal_args</span></a><span class='Delimiter'>, </span><span class='String'>"TG_event TG_tag"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * Create the tcl command to define the internal 
         * procedure 
         * 
         * Leave this code as DString - performance is not critical here, 
         * and we don't want to duplicate the knowledge of the Tcl quoting 
         * rules that's embedded in Tcl_DStringAppendElement. 
         ************************************************************/ 
</span>        Tcl_DStringAppendElement<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pltcl.c.html#LN1366"><span class='Ref_To_Local'>proc_internal_def</span></a><span class='Delimiter'>, </span><span class='String'>"proc"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        Tcl_DStringAppendElement<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pltcl.c.html#LN1366"><span class='Ref_To_Local'>proc_internal_def</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1418"><span class='Ref_To_Local'>internal_proname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        Tcl_DStringAppendElement<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pltcl.c.html#LN1366"><span class='Ref_To_Local'>proc_internal_def</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1421"><span class='Ref_To_Local'>proc_internal_args</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * prefix procedure body with 
         * upvar #0 &LT;internal_procname&GT; GD 
         * and with appropriate setting of arguments 
         ************************************************************/ 
</span>        Tcl_DStringAppend<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pltcl.c.html#LN1367"><span class='Ref_To_Local'>proc_internal_body</span></a><span class='Delimiter'>, </span><span class='String'>"upvar #0 "</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        Tcl_DStringAppend<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pltcl.c.html#LN1367"><span class='Ref_To_Local'>proc_internal_body</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1418"><span class='Ref_To_Local'>internal_proname</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        Tcl_DStringAppend<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pltcl.c.html#LN1367"><span class='Ref_To_Local'>proc_internal_body</span></a><span class='Delimiter'>, </span><span class='String'>" GD\n"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1417"><span class='Ref_To_Local'>is_trigger</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            Tcl_DStringAppend<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pltcl.c.html#LN1367"><span class='Ref_To_Local'>proc_internal_body</span></a><span class='Delimiter'>, 
</span>                              <span class='String'>"array set NEW $__PLTcl_Tup_NEW\n"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            Tcl_DStringAppend<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pltcl.c.html#LN1367"><span class='Ref_To_Local'>proc_internal_body</span></a><span class='Delimiter'>, 
</span>                              <span class='String'>"array set OLD $__PLTcl_Tup_OLD\n"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            Tcl_DStringAppend<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pltcl.c.html#LN1367"><span class='Ref_To_Local'>proc_internal_body</span></a><span class='Delimiter'>, 
</span>                              <span class='String'>"set i 0\n"</span> 
                              <span class='String'>"set v 0\n"</span> 
                              <span class='String'>"foreach v $args {\n"</span> 
                              <span class='String'>"  incr i\n"</span> 
                              <span class='String'>"  set $i $v\n"</span> 
                              <span class='String'>"}\n"</span> 
                              <span class='String'>"unset i v\n\n"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1356"><span class='Ref_to_Parameter'>is_event_trigger</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* no argument support for event triggers */ 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1427"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pltcl.c.html#LN1427"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="pltcl.c.html#LN1363"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN149"><span class='Ref_to_Member'>nargs</span></a><span class='Delimiter'>; </span><a href="pltcl.c.html#LN1427"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1363"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN152"><span class='Ref_to_Member'>arg_is_rowtype</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN1427"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="../plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1425"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1425"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <span class='String'>"array set %d $__PLTcl_Tup_%d\n"</span><span class='Delimiter'>, 
</span>                             <a href="pltcl.c.html#LN1427"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1427"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    Tcl_DStringAppend<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pltcl.c.html#LN1367"><span class='Ref_To_Local'>proc_internal_body</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1425"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * Add user's function definition to proc body 
         ************************************************************/ 
</span>        <a href="pltcl.c.html#LN1422"><span class='Ref_To_Local'>prosrcdatum</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN133"><span class='Ref_to_Proto'>SysCacheGetAttr</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN76"><span class='Ref_to_EnumConst'>PROCOID</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1358"><span class='Ref_To_Local'>procTup</span></a><span class='Delimiter'>, 
</span>                                      <a href="../../include/catalog/pg_proc.h.html#LN114"><span class='Ref_to_Const'>Anum_pg_proc_prosrc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pltcl.c.html#LN1423"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1423"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>) 
</span>            <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"null prosrc"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN1424"><span class='Ref_To_Local'>proc_source</span></a> <span class='Operator'>= </span><a href="../../include/utils/builtins.h.html#LN91"><span class='Ref_to_Macro'>TextDatumGetCString</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1422"><span class='Ref_To_Local'>prosrcdatum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN84"><span class='Ref_to_Const'>UTF_BEGIN</span></a><span class='Delimiter'>; 
</span>        Tcl_DStringAppend<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pltcl.c.html#LN1367"><span class='Ref_To_Local'>proc_internal_body</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN97"><span class='Ref_to_Macro'>UTF_E2U</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1424"><span class='Ref_To_Local'>proc_source</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN89"><span class='Ref_to_Const'>UTF_END</span></a><span class='Delimiter'>; 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1424"><span class='Ref_To_Local'>proc_source</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        Tcl_DStringAppendElement<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pltcl.c.html#LN1366"><span class='Ref_To_Local'>proc_internal_def</span></a><span class='Delimiter'>, 
</span>                                 Tcl_DStringValue<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pltcl.c.html#LN1367"><span class='Ref_To_Local'>proc_internal_body</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * Create the procedure in the interpreter 
         ************************************************************/ 
</span>        <a href="pltcl.c.html#LN1428"><span class='Ref_To_Local'>tcl_rc</span></a> <span class='Operator'>= </span>Tcl_EvalEx<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1426"><span class='Ref_To_Local'>interp</span></a><span class='Delimiter'>, 
</span>                            Tcl_DStringValue<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pltcl.c.html#LN1366"><span class='Ref_To_Local'>proc_internal_def</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                            Tcl_DStringLength<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pltcl.c.html#LN1366"><span class='Ref_To_Local'>proc_internal_def</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                            TCL_EVAL_GLOBAL<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1428"><span class='Ref_To_Local'>tcl_rc</span></a> <span class='Operator'>!= </span>TCL_OK<span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_EXTERNAL_ROUTINE_EXCEPTION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not create internal procedure \"%s\": %s"</span><span class='Delimiter'>, 
</span>                            <a href="pltcl.c.html#LN1418"><span class='Ref_To_Local'>internal_proname</span></a><span class='Delimiter'>, 
</span>                            <a href="../plperl/plperl_helpers.h.html#LN10"><span class='Ref_to_Func'>utf_u2e</span></a><span class='Parentheses'>(</span>Tcl_GetStringResult<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1426"><span class='Ref_To_Local'>interp</span></a><span class='Parentheses'>)))))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * If we failed anywhere above, clean up whatever got allocated.  It 
         * should all be in the proc_cxt, except for the DStrings. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1365"><span class='Ref_To_Local'>proc_cxt</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1365"><span class='Ref_To_Local'>proc_cxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        Tcl_DStringFree<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pltcl.c.html#LN1366"><span class='Ref_To_Local'>proc_internal_def</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        Tcl_DStringFree<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pltcl.c.html#LN1367"><span class='Ref_To_Local'>proc_internal_body</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN310"><span class='Ref_to_Macro'>PG_RE_THROW</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Install the new proc description block in the hashtable, incrementing 
     * its refcount (the hashtable link counts as a reference).  Then, if 
     * there was a previous definition of the function, decrement that one's 
     * refcount, and delete it if no longer referenced.  The order of 
     * operations here is important: if something goes wrong during the 
     * MemoryContextDelete, leaking some memory for the old definition is OK, 
     * but we don't want to corrupt the live hashtable entry.  (Likewise, 
     * freeing the DStrings is pretty low priority if that happens.) 
     */ 
</span>    <a href="pltcl.c.html#LN1364"><span class='Ref_To_Local'>old_prodesc</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN1361"><span class='Ref_To_Local'>proc_ptr</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN196"><span class='Ref_to_Member'>proc_ptr</span></a><span class='Delimiter'>; 
</span> 
    <a href="pltcl.c.html#LN1361"><span class='Ref_To_Local'>proc_ptr</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN196"><span class='Ref_to_Member'>proc_ptr</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN1363"><span class='Ref_To_Local'>prodesc</span></a><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN1363"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN139"><span class='Ref_to_Member'>fn_refcount</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1364"><span class='Ref_To_Local'>old_prodesc</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1364"><span class='Ref_To_Local'>old_prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN139"><span class='Ref_to_Member'>fn_refcount</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>--</span><a href="pltcl.c.html#LN1364"><span class='Ref_To_Local'>old_prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN139"><span class='Ref_to_Member'>fn_refcount</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1364"><span class='Ref_To_Local'>old_prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN138"><span class='Ref_to_Member'>fn_cxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    Tcl_DStringFree<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pltcl.c.html#LN1366"><span class='Ref_To_Local'>proc_internal_def</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    Tcl_DStringFree<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pltcl.c.html#LN1367"><span class='Ref_To_Local'>proc_internal_body</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1358"><span class='Ref_To_Local'>procTup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="pltcl.c.html#LN1363"><span class='Ref_To_Local'>prodesc</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end compile_pltcl_function &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * pltcl_elog()     - elog() support for PLTcl 
 **********************************************************************/ 
</span><span class='Keyword'>static int 
</span><a name="LN1715"></a><span class='Declare_Function'>pltcl_elog</span><span class='Parentheses'>(</span>ClientData <span class='Declare_Parameter'>cdata</span><span class='Delimiter'>, </span>Tcl_Interp <span class='Operator'>*</span><span class='Declare_Parameter'>interp</span><span class='Delimiter'>, 
</span><a name="LN1716"></a>           <span class='Keyword'>int </span><span class='Declare_Parameter'>objc</span><span class='Delimiter'>, </span>Tcl_Obj <span class='Operator'>*</span><span class='Keyword'>const </span><span class='Declare_Parameter'>objv</span><span class='Delimiter'>[]</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1718"></a>    <span class='Keyword'>volatile int </span><span class='Declare_Local'>level</span><span class='Delimiter'>; 
</span><a name="LN1719"></a>    <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span><span class='Delimiter'>; 
</span><a name="LN1720"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>priIndex</span><span class='Delimiter'>; 
</span> 
<a name="LN1722"></a>    <span class='Keyword'>static const char </span><span class='Operator'>*</span><span class='Declare_Local'>logpriorities</span><span class='Delimiter'>[] </span><span class='Operator'>= </span><span class='Delimiter'>{ 
</span>        <span class='String'>"DEBUG"</span><span class='Delimiter'>, </span><span class='String'>"LOG"</span><span class='Delimiter'>, </span><span class='String'>"INFO"</span><span class='Delimiter'>, </span><span class='String'>"NOTICE"</span><span class='Delimiter'>, 
</span>        <span class='String'>"WARNING"</span><span class='Delimiter'>, </span><span class='String'>"ERROR"</span><span class='Delimiter'>, </span><span class='String'>"FATAL"</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Null_Value'>NULL 
</span>    <span class='Delimiter'>}; 
</span> 
<a name="LN1727"></a>    <span class='Keyword'>static const int </span><span class='Declare_Local'>loglevels</span><span class='Delimiter'>[] </span><span class='Operator'>= </span><span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><a href="../../include/utils/elog.h.html#LN32"><span class='Ref_to_Const'>INFO</span></a><span class='Delimiter'>, </span><a href="../../include/utils/elog.h.html#LN36"><span class='Ref_to_Const'>NOTICE</span></a><span class='Delimiter'>, 
</span>        <a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a> 
    <span class='Delimiter'>}; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1716"><span class='Ref_to_Parameter'>objc</span></a> <span class='Operator'>!= </span><span class='Number'>3</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        Tcl_WrongNumArgs<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1715"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1716"><span class='Ref_to_Parameter'>objv</span></a><span class='Delimiter'>, </span><span class='String'>"level msg"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> TCL_ERROR<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>Tcl_GetIndexFromObj<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1715"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1716"><span class='Ref_to_Parameter'>objv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><a href="pltcl.c.html#LN1722"><span class='Ref_To_Local'>logpriorities</span></a><span class='Delimiter'>, </span><span class='String'>"priority"</span><span class='Delimiter'>, 
</span>                            TCL_EXACT<span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pltcl.c.html#LN1720"><span class='Ref_To_Local'>priIndex</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span>TCL_OK<span class='Parentheses'>)</span> 
        <span class='Control'>return</span> TCL_ERROR<span class='Delimiter'>; 
</span> 
    <a href="pltcl.c.html#LN1718"><span class='Ref_To_Local'>level</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN1727"><span class='Ref_To_Local'>loglevels</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN1720"><span class='Ref_To_Local'>priIndex</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1718"><span class='Ref_To_Local'>level</span></a> <span class='Operator'>== </span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * We just pass the error back to Tcl.  If it's not caught, it'll 
         * eventually get converted to a PG error when we reach the call 
         * handler. 
         */ 
</span>        Tcl_SetObjResult<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1715"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1716"><span class='Ref_to_Parameter'>objv</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> TCL_ERROR<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * For non-error messages, just pass 'em to ereport().  We do not expect 
     * that this will fail, but just on the off chance it does, report the 
     * error back to Tcl.  Note we are assuming that ereport() can't have any 
     * internal failures that are so bad as to require a transaction abort. 
     * 
     * This path is also used for FATAL errors, which aren't going to come 
     * back to us at all. 
     */ 
</span>    <a href="pltcl.c.html#LN1719"><span class='Ref_To_Local'>oldcontext</span></a> <span class='Operator'>= </span><a href="../../backend/utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>; 
</span>    <a href="../../include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pltcl.c.html#LN84"><span class='Ref_to_Const'>UTF_BEGIN</span></a><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1718"><span class='Ref_To_Local'>level</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_EXTERNAL_ROUTINE_EXCEPTION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN94"><span class='Ref_to_Macro'>UTF_U2E</span></a><span class='Parentheses'>(</span>Tcl_GetString<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1716"><span class='Ref_to_Parameter'>objv</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]</span><span class='Parentheses'>)))))</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN89"><span class='Ref_to_Const'>UTF_END</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1775"></a>        <a href="../../include/utils/elog.h.html#LN328"><span class='Ref_to_Struct'>ErrorData</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>edata</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Must reset elog.c's state */ 
</span>        <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1719"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN1775"><span class='Ref_To_Local'>edata</span></a> <span class='Operator'>= </span><a href="../../include/utils/elog.h.html#LN363"><span class='Ref_to_Proto'>CopyErrorData</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN365"><span class='Ref_to_Proto'>FlushErrorState</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Pass the error data to Tcl */ 
</span>        <a href="pltcl.c.html#LN284"><span class='Ref_to_Proto'>pltcl_construct_errorCode</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1715"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1775"><span class='Ref_To_Local'>edata</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN84"><span class='Ref_to_Const'>UTF_BEGIN</span></a><span class='Delimiter'>; 
</span>        Tcl_SetObjResult<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1715"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span>Tcl_NewStringObj<span class='Parentheses'>(</span><a href="pltcl.c.html#LN97"><span class='Ref_to_Macro'>UTF_E2U</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1775"><span class='Ref_To_Local'>edata</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/elog.h.html#LN342"><span class='Ref_to_Member'>message</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN89"><span class='Ref_to_Const'>UTF_END</span></a><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN364"><span class='Ref_to_Proto'>FreeErrorData</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1775"><span class='Ref_To_Local'>edata</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> TCL_ERROR<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> TCL_OK<span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pltcl_elog &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * pltcl_construct_errorCode()      - construct a Tcl errorCode 
 *      list with detailed information from the PostgreSQL server 
 **********************************************************************/ 
</span><span class='Keyword'>static void 
</span><a name="LN1802"></a><span class='Declare_Function'>pltcl_construct_errorCode</span><span class='Parentheses'>(</span>Tcl_Interp <span class='Operator'>*</span><span class='Declare_Parameter'>interp</span><span class='Delimiter'>, </span><a href="../../include/utils/elog.h.html#LN328"><span class='Ref_to_Struct'>ErrorData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>edata</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1804"></a>    Tcl_Obj    <span class='Operator'>*</span><span class='Declare_Local'>obj</span> <span class='Operator'>= </span>Tcl_NewObj<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    Tcl_ListObjAppendElement<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1804"><span class='Ref_To_Local'>obj</span></a><span class='Delimiter'>, 
</span>                             Tcl_NewStringObj<span class='Parentheses'>(</span><span class='String'>"POSTGRES"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    Tcl_ListObjAppendElement<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1804"><span class='Ref_To_Local'>obj</span></a><span class='Delimiter'>, 
</span>                             Tcl_NewStringObj<span class='Parentheses'>(</span>PG_VERSION<span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    Tcl_ListObjAppendElement<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1804"><span class='Ref_To_Local'>obj</span></a><span class='Delimiter'>, 
</span>                             Tcl_NewStringObj<span class='Parentheses'>(</span><span class='String'>"SQLSTATE"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    Tcl_ListObjAppendElement<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1804"><span class='Ref_To_Local'>obj</span></a><span class='Delimiter'>, 
</span>                  Tcl_NewStringObj<span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN401"><span class='Ref_to_Proto'>unpack_sql_state</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>edata</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/elog.h.html#LN341"><span class='Ref_to_Member'>sqlerrcode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    Tcl_ListObjAppendElement<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1804"><span class='Ref_To_Local'>obj</span></a><span class='Delimiter'>, 
</span>                             Tcl_NewStringObj<span class='Parentheses'>(</span><span class='String'>"condition"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    Tcl_ListObjAppendElement<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1804"><span class='Ref_To_Local'>obj</span></a><span class='Delimiter'>, 
</span>          Tcl_NewStringObj<span class='Parentheses'>(</span><a href="pltcl.c.html#LN285"><span class='Ref_to_Proto'>pltcl_get_condition_name</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>edata</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/elog.h.html#LN341"><span class='Ref_to_Member'>sqlerrcode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    Tcl_ListObjAppendElement<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1804"><span class='Ref_To_Local'>obj</span></a><span class='Delimiter'>, 
</span>                             Tcl_NewStringObj<span class='Parentheses'>(</span><span class='String'>"message"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN84"><span class='Ref_to_Const'>UTF_BEGIN</span></a><span class='Delimiter'>; 
</span>    Tcl_ListObjAppendElement<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1804"><span class='Ref_To_Local'>obj</span></a><span class='Delimiter'>, 
</span>                             Tcl_NewStringObj<span class='Parentheses'>(</span><a href="pltcl.c.html#LN97"><span class='Ref_to_Macro'>UTF_E2U</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>edata</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/elog.h.html#LN342"><span class='Ref_to_Member'>message</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN89"><span class='Ref_to_Const'>UTF_END</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>edata</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/elog.h.html#LN343"><span class='Ref_to_Member'>detail</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        Tcl_ListObjAppendElement<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1804"><span class='Ref_To_Local'>obj</span></a><span class='Delimiter'>, 
</span>                                 Tcl_NewStringObj<span class='Parentheses'>(</span><span class='String'>"detail"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN84"><span class='Ref_to_Const'>UTF_BEGIN</span></a><span class='Delimiter'>; 
</span>        Tcl_ListObjAppendElement<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1804"><span class='Ref_To_Local'>obj</span></a><span class='Delimiter'>, 
</span>                               Tcl_NewStringObj<span class='Parentheses'>(</span><a href="pltcl.c.html#LN97"><span class='Ref_to_Macro'>UTF_E2U</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>edata</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/elog.h.html#LN343"><span class='Ref_to_Member'>detail</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN89"><span class='Ref_to_Const'>UTF_END</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>edata</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/elog.h.html#LN345"><span class='Ref_to_Member'>hint</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        Tcl_ListObjAppendElement<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1804"><span class='Ref_To_Local'>obj</span></a><span class='Delimiter'>, 
</span>                                 Tcl_NewStringObj<span class='Parentheses'>(</span><span class='String'>"hint"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN84"><span class='Ref_to_Const'>UTF_BEGIN</span></a><span class='Delimiter'>; 
</span>        Tcl_ListObjAppendElement<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1804"><span class='Ref_To_Local'>obj</span></a><span class='Delimiter'>, 
</span>                                 Tcl_NewStringObj<span class='Parentheses'>(</span><a href="pltcl.c.html#LN97"><span class='Ref_to_Macro'>UTF_E2U</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>edata</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/elog.h.html#LN345"><span class='Ref_to_Member'>hint</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN89"><span class='Ref_to_Const'>UTF_END</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>edata</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/elog.h.html#LN346"><span class='Ref_to_Member'>context</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        Tcl_ListObjAppendElement<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1804"><span class='Ref_To_Local'>obj</span></a><span class='Delimiter'>, 
</span>                                 Tcl_NewStringObj<span class='Parentheses'>(</span><span class='String'>"context"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN84"><span class='Ref_to_Const'>UTF_BEGIN</span></a><span class='Delimiter'>; 
</span>        Tcl_ListObjAppendElement<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1804"><span class='Ref_To_Local'>obj</span></a><span class='Delimiter'>, 
</span>                              Tcl_NewStringObj<span class='Parentheses'>(</span><a href="pltcl.c.html#LN97"><span class='Ref_to_Macro'>UTF_E2U</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>edata</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/elog.h.html#LN346"><span class='Ref_to_Member'>context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN89"><span class='Ref_to_Const'>UTF_END</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>edata</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/elog.h.html#LN348"><span class='Ref_to_Member'>schema_name</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        Tcl_ListObjAppendElement<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1804"><span class='Ref_To_Local'>obj</span></a><span class='Delimiter'>, 
</span>                                 Tcl_NewStringObj<span class='Parentheses'>(</span><span class='String'>"schema"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN84"><span class='Ref_to_Const'>UTF_BEGIN</span></a><span class='Delimiter'>; 
</span>        Tcl_ListObjAppendElement<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1804"><span class='Ref_To_Local'>obj</span></a><span class='Delimiter'>, 
</span>                          Tcl_NewStringObj<span class='Parentheses'>(</span><a href="pltcl.c.html#LN97"><span class='Ref_to_Macro'>UTF_E2U</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>edata</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/elog.h.html#LN348"><span class='Ref_to_Member'>schema_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN89"><span class='Ref_to_Const'>UTF_END</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>edata</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/elog.h.html#LN349"><span class='Ref_to_Member'>table_name</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        Tcl_ListObjAppendElement<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1804"><span class='Ref_To_Local'>obj</span></a><span class='Delimiter'>, 
</span>                                 Tcl_NewStringObj<span class='Parentheses'>(</span><span class='String'>"table"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN84"><span class='Ref_to_Const'>UTF_BEGIN</span></a><span class='Delimiter'>; 
</span>        Tcl_ListObjAppendElement<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1804"><span class='Ref_To_Local'>obj</span></a><span class='Delimiter'>, 
</span>                           Tcl_NewStringObj<span class='Parentheses'>(</span><a href="pltcl.c.html#LN97"><span class='Ref_to_Macro'>UTF_E2U</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>edata</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/elog.h.html#LN349"><span class='Ref_to_Member'>table_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN89"><span class='Ref_to_Const'>UTF_END</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>edata</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/elog.h.html#LN350"><span class='Ref_to_Member'>column_name</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        Tcl_ListObjAppendElement<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1804"><span class='Ref_To_Local'>obj</span></a><span class='Delimiter'>, 
</span>                                 Tcl_NewStringObj<span class='Parentheses'>(</span><span class='String'>"column"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN84"><span class='Ref_to_Const'>UTF_BEGIN</span></a><span class='Delimiter'>; 
</span>        Tcl_ListObjAppendElement<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1804"><span class='Ref_To_Local'>obj</span></a><span class='Delimiter'>, 
</span>                          Tcl_NewStringObj<span class='Parentheses'>(</span><a href="pltcl.c.html#LN97"><span class='Ref_to_Macro'>UTF_E2U</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>edata</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/elog.h.html#LN350"><span class='Ref_to_Member'>column_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN89"><span class='Ref_to_Const'>UTF_END</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>edata</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/elog.h.html#LN351"><span class='Ref_to_Member'>datatype_name</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        Tcl_ListObjAppendElement<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1804"><span class='Ref_To_Local'>obj</span></a><span class='Delimiter'>, 
</span>                                 Tcl_NewStringObj<span class='Parentheses'>(</span><span class='String'>"datatype"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN84"><span class='Ref_to_Const'>UTF_BEGIN</span></a><span class='Delimiter'>; 
</span>        Tcl_ListObjAppendElement<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1804"><span class='Ref_To_Local'>obj</span></a><span class='Delimiter'>, 
</span>                        Tcl_NewStringObj<span class='Parentheses'>(</span><a href="pltcl.c.html#LN97"><span class='Ref_to_Macro'>UTF_E2U</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>edata</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/elog.h.html#LN351"><span class='Ref_to_Member'>datatype_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN89"><span class='Ref_to_Const'>UTF_END</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>edata</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/elog.h.html#LN352"><span class='Ref_to_Member'>constraint_name</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        Tcl_ListObjAppendElement<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1804"><span class='Ref_To_Local'>obj</span></a><span class='Delimiter'>, 
</span>                                 Tcl_NewStringObj<span class='Parentheses'>(</span><span class='String'>"constraint"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN84"><span class='Ref_to_Const'>UTF_BEGIN</span></a><span class='Delimiter'>; 
</span>        Tcl_ListObjAppendElement<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1804"><span class='Ref_To_Local'>obj</span></a><span class='Delimiter'>, 
</span>                      Tcl_NewStringObj<span class='Parentheses'>(</span><a href="pltcl.c.html#LN97"><span class='Ref_to_Macro'>UTF_E2U</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>edata</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/elog.h.html#LN352"><span class='Ref_to_Member'>constraint_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN89"><span class='Ref_to_Const'>UTF_END</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Comment_Multi_Line'>/* cursorpos is never interesting here; report internal query/pos */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>edata</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/elog.h.html#LN355"><span class='Ref_to_Member'>internalquery</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        Tcl_ListObjAppendElement<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1804"><span class='Ref_To_Local'>obj</span></a><span class='Delimiter'>, 
</span>                                 Tcl_NewStringObj<span class='Parentheses'>(</span><span class='String'>"statement"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN84"><span class='Ref_to_Const'>UTF_BEGIN</span></a><span class='Delimiter'>; 
</span>        Tcl_ListObjAppendElement<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1804"><span class='Ref_To_Local'>obj</span></a><span class='Delimiter'>, 
</span>                        Tcl_NewStringObj<span class='Parentheses'>(</span><a href="pltcl.c.html#LN97"><span class='Ref_to_Macro'>UTF_E2U</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>edata</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/elog.h.html#LN355"><span class='Ref_to_Member'>internalquery</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN89"><span class='Ref_to_Const'>UTF_END</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>edata</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/elog.h.html#LN354"><span class='Ref_to_Member'>internalpos</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        Tcl_ListObjAppendElement<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1804"><span class='Ref_To_Local'>obj</span></a><span class='Delimiter'>, 
</span>                                 Tcl_NewStringObj<span class='Parentheses'>(</span><span class='String'>"cursor_position"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        Tcl_ListObjAppendElement<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1804"><span class='Ref_To_Local'>obj</span></a><span class='Delimiter'>, 
</span>                                 Tcl_NewIntObj<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>edata</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/elog.h.html#LN354"><span class='Ref_to_Member'>internalpos</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>edata</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/elog.h.html#LN336"><span class='Ref_to_Member'>filename</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        Tcl_ListObjAppendElement<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1804"><span class='Ref_To_Local'>obj</span></a><span class='Delimiter'>, 
</span>                                 Tcl_NewStringObj<span class='Parentheses'>(</span><span class='String'>"filename"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN84"><span class='Ref_to_Const'>UTF_BEGIN</span></a><span class='Delimiter'>; 
</span>        Tcl_ListObjAppendElement<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1804"><span class='Ref_To_Local'>obj</span></a><span class='Delimiter'>, 
</span>                             Tcl_NewStringObj<span class='Parentheses'>(</span><a href="pltcl.c.html#LN97"><span class='Ref_to_Macro'>UTF_E2U</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>edata</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/elog.h.html#LN336"><span class='Ref_to_Member'>filename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN89"><span class='Ref_to_Const'>UTF_END</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>edata</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/elog.h.html#LN337"><span class='Ref_to_Member'>lineno</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        Tcl_ListObjAppendElement<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1804"><span class='Ref_To_Local'>obj</span></a><span class='Delimiter'>, 
</span>                                 Tcl_NewStringObj<span class='Parentheses'>(</span><span class='String'>"lineno"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        Tcl_ListObjAppendElement<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1804"><span class='Ref_To_Local'>obj</span></a><span class='Delimiter'>, 
</span>                                 Tcl_NewIntObj<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>edata</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/elog.h.html#LN337"><span class='Ref_to_Member'>lineno</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>edata</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/elog.h.html#LN338"><span class='Ref_to_Member'>funcname</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        Tcl_ListObjAppendElement<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1804"><span class='Ref_To_Local'>obj</span></a><span class='Delimiter'>, 
</span>                                 Tcl_NewStringObj<span class='Parentheses'>(</span><span class='String'>"funcname"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN84"><span class='Ref_to_Const'>UTF_BEGIN</span></a><span class='Delimiter'>; 
</span>        Tcl_ListObjAppendElement<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1804"><span class='Ref_To_Local'>obj</span></a><span class='Delimiter'>, 
</span>                             Tcl_NewStringObj<span class='Parentheses'>(</span><a href="pltcl.c.html#LN97"><span class='Ref_to_Macro'>UTF_E2U</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>edata</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/elog.h.html#LN338"><span class='Ref_to_Member'>funcname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN89"><span class='Ref_to_Const'>UTF_END</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    Tcl_SetObjErrorCode<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1802"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1804"><span class='Ref_To_Local'>obj</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pltcl_construct_errorCode &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * pltcl_get_condition_name()   - find name for SQLSTATE 
 **********************************************************************/ 
</span><span class='Keyword'>static const char </span><span class='Operator'>* 
</span><a name="LN1947"></a><span class='Declare_Function'>pltcl_get_condition_name</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>sqlstate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1949"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1949"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pltcl.c.html#LN251"><span class='Ref_to_Global_Var'>exception_name_map</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN1949"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="pltcl.c.html#LN247"><span class='Ref_to_Member'>label</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; </span><a href="pltcl.c.html#LN1949"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN251"><span class='Ref_to_Global_Var'>exception_name_map</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN1949"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="pltcl.c.html#LN248"><span class='Ref_to_Member'>sqlerrstate</span></a> <span class='Operator'>== </span><a href="pltcl.c.html#LN1947"><span class='Ref_to_Parameter'>sqlstate</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <a href="pltcl.c.html#LN251"><span class='Ref_to_Global_Var'>exception_name_map</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN1949"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="pltcl.c.html#LN247"><span class='Ref_to_Member'>label</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <span class='String'>"unrecognized_sqlstate"</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * pltcl_quote()    - quote literal strings that are to 
 *            be used in SPI_execute query strings 
 **********************************************************************/ 
</span><span class='Keyword'>static int 
</span><a name="LN1965"></a><span class='Declare_Function'>pltcl_quote</span><span class='Parentheses'>(</span>ClientData <span class='Declare_Parameter'>cdata</span><span class='Delimiter'>, </span>Tcl_Interp <span class='Operator'>*</span><span class='Declare_Parameter'>interp</span><span class='Delimiter'>, 
</span><a name="LN1966"></a>            <span class='Keyword'>int </span><span class='Declare_Parameter'>objc</span><span class='Delimiter'>, </span>Tcl_Obj <span class='Operator'>*</span><span class='Keyword'>const </span><span class='Declare_Parameter'>objv</span><span class='Delimiter'>[]</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1968"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>tmp</span><span class='Delimiter'>; 
</span><a name="LN1969"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>cp1</span><span class='Delimiter'>; 
</span><a name="LN1970"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>cp2</span><span class='Delimiter'>; 
</span><a name="LN1971"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>length</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Check call syntax 
     ************************************************************/ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN1966"><span class='Ref_to_Parameter'>objc</span></a> <span class='Operator'>!= </span><span class='Number'>2</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        Tcl_WrongNumArgs<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1965"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN1966"><span class='Ref_to_Parameter'>objv</span></a><span class='Delimiter'>, </span><span class='String'>"string"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> TCL_ERROR<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Allocate space for the maximum the string can 
     * grow to and initialize pointers 
     ************************************************************/ 
</span>    <a href="pltcl.c.html#LN1969"><span class='Ref_To_Local'>cp1</span></a> <span class='Operator'>= </span>Tcl_GetStringFromObj<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1966"><span class='Ref_to_Parameter'>objv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='Operator'>&</span><a href="pltcl.c.html#LN1971"><span class='Ref_To_Local'>length</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN1968"><span class='Ref_To_Local'>tmp</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1971"><span class='Ref_To_Local'>length</span></a> <span class='Operator'>* </span><span class='Number'>2</span> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN1970"><span class='Ref_To_Local'>cp2</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN1968"><span class='Ref_To_Local'>tmp</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Walk through string and double every quote and backslash 
     ************************************************************/ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="pltcl.c.html#LN1969"><span class='Ref_To_Local'>cp1</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="pltcl.c.html#LN1969"><span class='Ref_To_Local'>cp1</span></a> <span class='Operator'>== </span><span class='String'>'\''</span><span class='Parentheses'>) 
</span>            <span class='Operator'>*</span><a href="pltcl.c.html#LN1970"><span class='Ref_To_Local'>cp2</span></a><span class='Operator'>++ = </span><span class='String'>'\''</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="pltcl.c.html#LN1969"><span class='Ref_To_Local'>cp1</span></a> <span class='Operator'>== </span><span class='String'>'\\'</span><span class='Parentheses'>) 
</span>                <span class='Operator'>*</span><a href="pltcl.c.html#LN1970"><span class='Ref_To_Local'>cp2</span></a><span class='Operator'>++ = </span><span class='String'>'\\'</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Operator'>*</span><a href="pltcl.c.html#LN1970"><span class='Ref_To_Local'>cp2</span></a><span class='Operator'>++ = *</span><a href="pltcl.c.html#LN1969"><span class='Ref_To_Local'>cp1</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Terminate the string and set it as result 
     ************************************************************/ 
</span>    <span class='Operator'>*</span><a href="pltcl.c.html#LN1970"><span class='Ref_To_Local'>cp2</span></a> <span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>    Tcl_SetObjResult<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1965"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span>Tcl_NewStringObj<span class='Parentheses'>(</span><a href="pltcl.c.html#LN1968"><span class='Ref_To_Local'>tmp</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN1968"><span class='Ref_To_Local'>tmp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> TCL_OK<span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pltcl_quote &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * pltcl_argisnull()    - determine if a specific argument is NULL 
 **********************************************************************/ 
</span><span class='Keyword'>static int 
</span><a name="LN2019"></a><span class='Declare_Function'>pltcl_argisnull</span><span class='Parentheses'>(</span>ClientData <span class='Declare_Parameter'>cdata</span><span class='Delimiter'>, </span>Tcl_Interp <span class='Operator'>*</span><span class='Declare_Parameter'>interp</span><span class='Delimiter'>, 
</span><a name="LN2020"></a>                <span class='Keyword'>int </span><span class='Declare_Parameter'>objc</span><span class='Delimiter'>, </span>Tcl_Obj <span class='Operator'>*</span><span class='Keyword'>const </span><span class='Declare_Parameter'>objv</span><span class='Delimiter'>[]</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2022"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>argno</span><span class='Delimiter'>; 
</span><a name="LN2023"></a>    <a href="../../include/fmgr.h.html#LN37"><span class='Ref_to_Typedef'>FunctionCallInfo</span></a> <span class='Declare_Local'>fcinfo</span> <span class='Operator'>= </span><a href="pltcl.c.html#LN240"><span class='Ref_to_Global_Var'>pltcl_current_call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN206"><span class='Ref_to_Member'>fcinfo</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Check call syntax 
     ************************************************************/ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2020"><span class='Ref_to_Parameter'>objc</span></a> <span class='Operator'>!= </span><span class='Number'>2</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        Tcl_WrongNumArgs<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2019"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2020"><span class='Ref_to_Parameter'>objv</span></a><span class='Delimiter'>, </span><span class='String'>"argno"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> TCL_ERROR<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Check that we're called as a normal function 
     ************************************************************/ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2023"><span class='Ref_To_Local'>fcinfo</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        Tcl_SetObjResult<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2019"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, 
</span>               Tcl_NewStringObj<span class='Parentheses'>(</span><span class='String'>"argisnull cannot be used in triggers"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> TCL_ERROR<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Get the argument number 
     ************************************************************/ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>Tcl_GetIntFromObj<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2019"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2020"><span class='Ref_to_Parameter'>objv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='Operator'>&</span><a href="pltcl.c.html#LN2022"><span class='Ref_To_Local'>argno</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span>TCL_OK<span class='Parentheses'>)</span> 
        <span class='Control'>return</span> TCL_ERROR<span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Check that the argno is valid 
     ************************************************************/ 
</span>    <a href="pltcl.c.html#LN2022"><span class='Ref_To_Local'>argno</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2022"><span class='Ref_To_Local'>argno</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="pltcl.c.html#LN2022"><span class='Ref_To_Local'>argno</span></a> <span class='Operator'>&GT;= </span><a href="pltcl.c.html#LN2023"><span class='Ref_To_Local'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/fmgr.h.html#LN83"><span class='Ref_to_Member'>nargs</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        Tcl_SetObjResult<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2019"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, 
</span>                         Tcl_NewStringObj<span class='Parentheses'>(</span><span class='String'>"argno out of range"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> TCL_ERROR<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Get the requested NULL state 
     ************************************************************/ 
</span>    Tcl_SetObjResult<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2019"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span>Tcl_NewBooleanObj<span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN173"><span class='Ref_to_Macro'>PG_ARGISNULL</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2022"><span class='Ref_To_Local'>argno</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> TCL_OK<span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pltcl_argisnull &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * pltcl_returnnull()   - Cause a NULL return from the current function 
 **********************************************************************/ 
</span><span class='Keyword'>static int 
</span><a name="LN2073"></a><span class='Declare_Function'>pltcl_returnnull</span><span class='Parentheses'>(</span>ClientData <span class='Declare_Parameter'>cdata</span><span class='Delimiter'>, </span>Tcl_Interp <span class='Operator'>*</span><span class='Declare_Parameter'>interp</span><span class='Delimiter'>, 
</span><a name="LN2074"></a>                 <span class='Keyword'>int </span><span class='Declare_Parameter'>objc</span><span class='Delimiter'>, </span>Tcl_Obj <span class='Operator'>*</span><span class='Keyword'>const </span><span class='Declare_Parameter'>objv</span><span class='Delimiter'>[]</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2076"></a>    <a href="../../include/fmgr.h.html#LN37"><span class='Ref_to_Typedef'>FunctionCallInfo</span></a> <span class='Declare_Local'>fcinfo</span> <span class='Operator'>= </span><a href="pltcl.c.html#LN240"><span class='Ref_to_Global_Var'>pltcl_current_call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN206"><span class='Ref_to_Member'>fcinfo</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Check call syntax 
     ************************************************************/ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2074"><span class='Ref_to_Parameter'>objc</span></a> <span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        Tcl_WrongNumArgs<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2073"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2074"><span class='Ref_to_Parameter'>objv</span></a><span class='Delimiter'>, </span><span class='String'>""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> TCL_ERROR<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Check that we're called as a normal function 
     ************************************************************/ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2076"><span class='Ref_To_Local'>fcinfo</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        Tcl_SetObjResult<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2073"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, 
</span>             Tcl_NewStringObj<span class='Parentheses'>(</span><span class='String'>"return_null cannot be used in triggers"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> TCL_ERROR<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Set the NULL return flag and cause Tcl to return from the 
     * procedure. 
     ************************************************************/ 
</span>    <a href="pltcl.c.html#LN2076"><span class='Ref_To_Local'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/fmgr.h.html#LN82"><span class='Ref_to_Member'>isnull</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> TCL_RETURN<span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pltcl_returnnull &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * pltcl_returnnext()   - Add a row to the result tuplestore in a SRF. 
 **********************************************************************/ 
</span><span class='Keyword'>static int 
</span><a name="LN2111"></a><span class='Declare_Function'>pltcl_returnnext</span><span class='Parentheses'>(</span>ClientData <span class='Declare_Parameter'>cdata</span><span class='Delimiter'>, </span>Tcl_Interp <span class='Operator'>*</span><span class='Declare_Parameter'>interp</span><span class='Delimiter'>, 
</span><a name="LN2112"></a>                 <span class='Keyword'>int </span><span class='Declare_Parameter'>objc</span><span class='Delimiter'>, </span>Tcl_Obj <span class='Operator'>*</span><span class='Keyword'>const </span><span class='Declare_Parameter'>objv</span><span class='Delimiter'>[]</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2114"></a>    <a href="pltcl.c.html#LN203"><span class='Ref_to_Struct'>pltcl_call_state</span></a> <span class='Operator'>*</span><span class='Declare_Local'>call_state</span> <span class='Operator'>= </span><a href="pltcl.c.html#LN240"><span class='Ref_to_Global_Var'>pltcl_current_call_state</span></a><span class='Delimiter'>; 
</span><a name="LN2115"></a>    <a href="../../include/fmgr.h.html#LN37"><span class='Ref_to_Typedef'>FunctionCallInfo</span></a> <span class='Declare_Local'>fcinfo</span> <span class='Operator'>= </span><a href="pltcl.c.html#LN2114"><span class='Ref_To_Local'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN206"><span class='Ref_to_Member'>fcinfo</span></a><span class='Delimiter'>; 
</span><a name="LN2116"></a>    <a href="pltcl.c.html#LN134"><span class='Ref_to_Struct'>pltcl_proc_desc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>prodesc</span> <span class='Operator'>= </span><a href="pltcl.c.html#LN2114"><span class='Ref_To_Local'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN212"><span class='Ref_to_Member'>prodesc</span></a><span class='Delimiter'>; 
</span><a name="LN2117"></a>    <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span> <span class='Operator'>= </span><a href="../../backend/utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>; 
</span><a name="LN2118"></a>    <a href="../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Local'>oldowner</span> <span class='Operator'>= </span><a href="../../backend/utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Delimiter'>; 
</span><a name="LN2119"></a>    <span class='Keyword'>volatile int </span><span class='Declare_Local'>result</span> <span class='Operator'>= </span>TCL_OK<span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check that we're called as a set-returning function 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2115"><span class='Ref_To_Local'>fcinfo</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        Tcl_SetObjResult<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2111"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, 
</span>             Tcl_NewStringObj<span class='Parentheses'>(</span><span class='String'>"return_next cannot be used in triggers"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> TCL_ERROR<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pltcl.c.html#LN2116"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN147"><span class='Ref_to_Member'>fn_retisset</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        Tcl_SetObjResult<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2111"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, 
</span>                         Tcl_NewStringObj<span class='Parentheses'>(</span><span class='String'>"return_next cannot be used in non-set-returning functions"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> TCL_ERROR<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check call syntax 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2112"><span class='Ref_to_Parameter'>objc</span></a> <span class='Operator'>!= </span><span class='Number'>2</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        Tcl_WrongNumArgs<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2111"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2112"><span class='Ref_to_Parameter'>objv</span></a><span class='Delimiter'>, </span><span class='String'>"result"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> TCL_ERROR<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The rest might throw elog(ERROR), so must run in a subtransaction. 
     * 
     * A small advantage of using a subtransaction is that it provides a 
     * short-lived memory context for free, so we needn't worry about leaking 
     * memory here.  To use that context, call BeginInternalSubTransaction 
     * directly instead of going through pltcl_subtrans_begin. 
     */ 
</span>    <a href="../../include/access/xact.h.html#LN358"><span class='Ref_to_Proto'>BeginInternalSubTransaction</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Set up tuple store if first output row */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2114"><span class='Ref_To_Local'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN223"><span class='Ref_to_Member'>tuple_store</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="pltcl.c.html#LN325"><span class='Ref_to_Proto'>pltcl_init_tuple_store</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2114"><span class='Ref_To_Local'>call_state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2116"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN148"><span class='Ref_to_Member'>fn_retistuple</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2164"></a>            Tcl_Obj   <span class='Operator'>**</span><span class='Declare_Local'>rowObjv</span><span class='Delimiter'>; 
</span><a name="LN2165"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>rowObjc</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* result should be a list, so break it down */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>Tcl_ListObjGetElements<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2111"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2112"><span class='Ref_to_Parameter'>objv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='Operator'>&</span><a href="pltcl.c.html#LN2165"><span class='Ref_To_Local'>rowObjc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pltcl.c.html#LN2164"><span class='Ref_To_Local'>rowObjv</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span>TCL_ERROR<span class='Parentheses'>)</span> 
                <a href="pltcl.c.html#LN2119"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span>TCL_ERROR<span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span><a name="LN2172"></a>                <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span> 
                <a href="pltcl.c.html#LN2172"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN322"><span class='Ref_to_Proto'>pltcl_build_tuple_result</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2111"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2164"><span class='Ref_To_Local'>rowObjv</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2165"><span class='Ref_To_Local'>rowObjc</span></a><span class='Delimiter'>, 
</span>                                                 <a href="pltcl.c.html#LN2114"><span class='Ref_To_Local'>call_state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../include/utils/tuplestore.h.html#LN54"><span class='Ref_to_Proto'>tuplestore_puttuple</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2114"><span class='Ref_To_Local'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN223"><span class='Ref_to_Member'>tuple_store</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2172"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span><a name="LN2181"></a>            <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>retval</span><span class='Delimiter'>; 
</span><a name="LN2182"></a>            <span class='Keyword'>bool</span>        <span class='Declare_Local'>isNull</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* for paranoia's sake, check that tupdesc has exactly one column */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2114"><span class='Ref_To_Local'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN219"><span class='Ref_to_Member'>ret_tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a> <span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>                <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"wrong result type supplied in return_next"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="pltcl.c.html#LN2181"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span><a href="../../include/fmgr.h.html#LN642"><span class='Ref_to_Proto'>InputFunctionCall</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pltcl.c.html#LN2116"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN145"><span class='Ref_to_Member'>result_in_func</span></a><span class='Delimiter'>, 
</span>                                    <a href="../plperl/plperl_helpers.h.html#LN10"><span class='Ref_to_Func'>utf_u2e</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span>Tcl_GetString<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2112"><span class='Ref_to_Parameter'>objv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                                       <a href="pltcl.c.html#LN2116"><span class='Ref_To_Local'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN146"><span class='Ref_to_Member'>result_typioparam</span></a><span class='Delimiter'>, 
</span>                                       <span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/utils/tuplestore.h.html#LN55"><span class='Ref_to_Proto'>tuplestore_putvalues</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2114"><span class='Ref_To_Local'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN223"><span class='Ref_to_Member'>tuple_store</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2114"><span class='Ref_To_Local'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN219"><span class='Ref_to_Member'>ret_tupdesc</span></a><span class='Delimiter'>, 
</span>                                 <span class='Operator'>&</span><a href="pltcl.c.html#LN2181"><span class='Ref_To_Local'>retval</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pltcl.c.html#LN2182"><span class='Ref_To_Local'>isNull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="pltcl.c.html#LN313"><span class='Ref_to_Proto'>pltcl_subtrans_commit</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2117"><span class='Ref_To_Local'>oldcontext</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2118"><span class='Ref_To_Local'>oldowner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pltcl.c.html#LN315"><span class='Ref_to_Proto'>pltcl_subtrans_abort</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2111"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2117"><span class='Ref_To_Local'>oldcontext</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2118"><span class='Ref_To_Local'>oldowner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> TCL_ERROR<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="pltcl.c.html#LN2119"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pltcl_returnnext &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/*---------- 
 * Support for running SPI operations inside subtransactions 
 * 
 * Intended usage pattern is: 
 * 
 *  MemoryContext oldcontext = CurrentMemoryContext; 
 *  ResourceOwner oldowner = CurrentResourceOwner; 
 * 
 *  ... 
 *  pltcl_subtrans_begin(oldcontext, oldowner); 
 *  PG_TRY(); 
 *  { 
 *      do something risky; 
 *      pltcl_subtrans_commit(oldcontext, oldowner); 
 *  } 
 *  PG_CATCH(); 
 *  { 
 *      pltcl_subtrans_abort(interp, oldcontext, oldowner); 
 *      return TCL_ERROR; 
 *  } 
 *  PG_END_TRY(); 
 *  return TCL_OK; 
 *---------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2234"></a><span class='Declare_Function'>pltcl_subtrans_begin</span><span class='Parentheses'>(</span><a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>oldcontext</span><span class='Delimiter'>, </span><a href="../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Parameter'>oldowner</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../include/access/xact.h.html#LN358"><span class='Ref_to_Proto'>BeginInternalSubTransaction</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Want to run inside function's memory context */ 
</span>    <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2234"><span class='Ref_to_Parameter'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN2243"></a><span class='Declare_Function'>pltcl_subtrans_commit</span><span class='Parentheses'>(</span><a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>oldcontext</span><span class='Delimiter'>, </span><a href="../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Parameter'>oldowner</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Commit the inner transaction, return to outer xact context */ 
</span>    <a href="../../include/access/xact.h.html#LN359"><span class='Ref_to_Proto'>ReleaseCurrentSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2243"><span class='Ref_to_Parameter'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../backend/utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN2243"><span class='Ref_to_Parameter'>oldowner</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN2252"></a><span class='Declare_Function'>pltcl_subtrans_abort</span><span class='Parentheses'>(</span>Tcl_Interp <span class='Operator'>*</span><span class='Declare_Parameter'>interp</span><span class='Delimiter'>, 
</span><a name="LN2253"></a>                     <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>oldcontext</span><span class='Delimiter'>, </span><a href="../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Parameter'>oldowner</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2255"></a>    <a href="../../include/utils/elog.h.html#LN328"><span class='Ref_to_Struct'>ErrorData</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>edata</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Save error info */ 
</span>    <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2253"><span class='Ref_to_Parameter'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN2255"><span class='Ref_To_Local'>edata</span></a> <span class='Operator'>= </span><a href="../../include/utils/elog.h.html#LN363"><span class='Ref_to_Proto'>CopyErrorData</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../include/utils/elog.h.html#LN365"><span class='Ref_to_Proto'>FlushErrorState</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Abort the inner transaction */ 
</span>    <a href="../../include/access/xact.h.html#LN360"><span class='Ref_to_Proto'>RollbackAndReleaseCurrentSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2253"><span class='Ref_to_Parameter'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../backend/utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN2253"><span class='Ref_to_Parameter'>oldowner</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Pass the error data to Tcl */ 
</span>    <a href="pltcl.c.html#LN284"><span class='Ref_to_Proto'>pltcl_construct_errorCode</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2252"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2255"><span class='Ref_To_Local'>edata</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN84"><span class='Ref_to_Const'>UTF_BEGIN</span></a><span class='Delimiter'>; 
</span>    Tcl_SetObjResult<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2252"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span>Tcl_NewStringObj<span class='Parentheses'>(</span><a href="pltcl.c.html#LN97"><span class='Ref_to_Macro'>UTF_E2U</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2255"><span class='Ref_To_Local'>edata</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/elog.h.html#LN342"><span class='Ref_to_Member'>message</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN89"><span class='Ref_to_Const'>UTF_END</span></a><span class='Delimiter'>; 
</span>    <a href="../../include/utils/elog.h.html#LN364"><span class='Ref_to_Proto'>FreeErrorData</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2255"><span class='Ref_To_Local'>edata</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pltcl_subtrans_abort &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * pltcl_SPI_execute()      - The builtin SPI_execute command 
 *                for the Tcl interpreter 
 **********************************************************************/ 
</span><span class='Keyword'>static int 
</span><a name="LN2281"></a><span class='Declare_Function'>pltcl_SPI_execute</span><span class='Parentheses'>(</span>ClientData <span class='Declare_Parameter'>cdata</span><span class='Delimiter'>, </span>Tcl_Interp <span class='Operator'>*</span><span class='Declare_Parameter'>interp</span><span class='Delimiter'>, 
</span><a name="LN2282"></a>                  <span class='Keyword'>int </span><span class='Declare_Parameter'>objc</span><span class='Delimiter'>, </span>Tcl_Obj <span class='Operator'>*</span><span class='Keyword'>const </span><span class='Declare_Parameter'>objv</span><span class='Delimiter'>[]</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2284"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>my_rc</span><span class='Delimiter'>; 
</span><a name="LN2285"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>spi_rc</span><span class='Delimiter'>; 
</span><a name="LN2286"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>query_idx</span><span class='Delimiter'>; 
</span><a name="LN2287"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN2288"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>optIndex</span><span class='Delimiter'>; 
</span><a name="LN2289"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>count</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN2290"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Declare_Local'>arrayname</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN2291"></a>    Tcl_Obj    <span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Declare_Local'>loop_body</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN2292"></a>    <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span> <span class='Operator'>= </span><a href="../../backend/utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>; 
</span><a name="LN2293"></a>    <a href="../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Local'>oldowner</span> <span class='Operator'>= </span><a href="../../backend/utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Delimiter'>; 
</span> 
<a name="LN2295"></a>    <span class='Control'>enum</span> <span class='Declare_Local'>options</span> 
    <span class='Delimiter'>{ 
</span><a name="LN2297"></a>        <span class='Declare_Local'>OPT_ARRAY</span><span class='Delimiter'>, </span><span class='Declare_Local'>OPT_COUNT</span> 
    <span class='Delimiter'>}; 
</span> 
<a name="LN2300"></a>    <span class='Keyword'>static const char </span><span class='Operator'>*</span><span class='Declare_Local'>options</span><span class='Delimiter'>[] </span><span class='Operator'>= </span><span class='Delimiter'>{ 
</span>        <span class='String'>"-array"</span><span class='Delimiter'>, </span><span class='String'>"-count"</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Null_Value'>NULL 
</span>    <span class='Delimiter'>}; 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Check the call syntax and get the options 
     ************************************************************/ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2282"><span class='Ref_to_Parameter'>objc</span></a> <span class='Operator'>&LT; </span><span class='Number'>2</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        Tcl_WrongNumArgs<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2281"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2282"><span class='Ref_to_Parameter'>objv</span></a><span class='Delimiter'>, 
</span>                         <span class='String'>"?-count n? ?-array name? query ?loop body?"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> TCL_ERROR<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="pltcl.c.html#LN2287"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2287"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="pltcl.c.html#LN2282"><span class='Ref_to_Parameter'>objc</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>Tcl_GetIndexFromObj<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2282"><span class='Ref_to_Parameter'>objv</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN2287"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="pltcl.c.html#LN2295"><span class='Ref_to_Enum'>options</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                TCL_EXACT<span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pltcl.c.html#LN2288"><span class='Ref_To_Local'>optIndex</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span>TCL_OK<span class='Parentheses'>)</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>++</span><a href="pltcl.c.html#LN2287"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT;= </span><a href="pltcl.c.html#LN2282"><span class='Ref_to_Parameter'>objc</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            Tcl_SetObjResult<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2281"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, 
</span>               Tcl_NewStringObj<span class='Parentheses'>(</span><span class='String'>"missing argument to -count or -array"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> TCL_ERROR<span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>switch</span> <span class='Parentheses'>((</span><span class='Control'>enum</span> <a href="pltcl.c.html#LN2295"><span class='Ref_to_Enum'>options</span></a><span class='Parentheses'>) </span><a href="pltcl.c.html#LN2288"><span class='Ref_To_Local'>optIndex</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <a href="pltcl.c.html#LN2297"><span class='Ref_to_EnumConst'>OPT_ARRAY</span></a><span class='Operator'>: 
</span>                <a href="pltcl.c.html#LN2290"><span class='Ref_To_Local'>arrayname</span></a> <span class='Operator'>= </span>Tcl_GetString<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2282"><span class='Ref_to_Parameter'>objv</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN2287"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <a href="pltcl.c.html#LN2297"><span class='Ref_to_EnumConst'>OPT_COUNT</span></a><span class='Operator'>: 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span>Tcl_GetIntFromObj<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2281"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2282"><span class='Ref_to_Parameter'>objv</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN2287"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Delimiter'>], </span><span class='Operator'>&</span><a href="pltcl.c.html#LN2289"><span class='Ref_To_Local'>count</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span>TCL_OK<span class='Parentheses'>)</span> 
                    <span class='Control'>return</span> TCL_ERROR<span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while i&LT;objc &raquo; </span> 
 
    <a href="pltcl.c.html#LN2286"><span class='Ref_To_Local'>query_idx</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN2287"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2286"><span class='Ref_To_Local'>query_idx</span></a> <span class='Operator'>&GT;= </span><a href="pltcl.c.html#LN2282"><span class='Ref_to_Parameter'>objc</span></a> <span class='Operator'>|| </span><a href="pltcl.c.html#LN2286"><span class='Ref_To_Local'>query_idx</span></a> <span class='Operator'>+ </span><span class='Number'>2</span> <span class='Operator'>&LT; </span><a href="pltcl.c.html#LN2282"><span class='Ref_to_Parameter'>objc</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        Tcl_WrongNumArgs<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2281"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2286"><span class='Ref_To_Local'>query_idx</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2282"><span class='Ref_to_Parameter'>objv</span></a><span class='Delimiter'>, </span><span class='String'>"query ?loop body?"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> TCL_ERROR<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2286"><span class='Ref_To_Local'>query_idx</span></a> <span class='Operator'>+ </span><span class='Number'>1</span> <span class='Operator'>&LT; </span><a href="pltcl.c.html#LN2282"><span class='Ref_to_Parameter'>objc</span></a><span class='Parentheses'>) 
</span>        <a href="pltcl.c.html#LN2291"><span class='Ref_To_Local'>loop_body</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN2282"><span class='Ref_to_Parameter'>objv</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN2286"><span class='Ref_To_Local'>query_idx</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Execute the query inside a sub-transaction, so we can cope with 
     * errors sanely 
     ************************************************************/ 
</span> 
    <a href="pltcl.c.html#LN311"><span class='Ref_to_Proto'>pltcl_subtrans_begin</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2292"><span class='Ref_To_Local'>oldcontext</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2293"><span class='Ref_To_Local'>oldowner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pltcl.c.html#LN84"><span class='Ref_to_Const'>UTF_BEGIN</span></a><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN2285"><span class='Ref_To_Local'>spi_rc</span></a> <span class='Operator'>= </span><a href="../../include/executor/spi.h.html#LN81"><span class='Ref_to_Proto'>SPI_execute</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN94"><span class='Ref_to_Macro'>UTF_U2E</span></a><span class='Parentheses'>(</span>Tcl_GetString<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2282"><span class='Ref_to_Parameter'>objv</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN2286"><span class='Ref_To_Local'>query_idx</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                      <a href="pltcl.c.html#LN240"><span class='Ref_to_Global_Var'>pltcl_current_call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN212"><span class='Ref_to_Member'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN142"><span class='Ref_to_Member'>fn_readonly</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2289"><span class='Ref_To_Local'>count</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN89"><span class='Ref_to_Const'>UTF_END</span></a><span class='Delimiter'>; 
</span> 
        <a href="pltcl.c.html#LN2284"><span class='Ref_To_Local'>my_rc</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN296"><span class='Ref_to_Proto'>pltcl_process_SPI_result</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2281"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, 
</span>                                         <a href="pltcl.c.html#LN2290"><span class='Ref_To_Local'>arrayname</span></a><span class='Delimiter'>, 
</span>                                         <a href="pltcl.c.html#LN2291"><span class='Ref_To_Local'>loop_body</span></a><span class='Delimiter'>, 
</span>                                         <a href="pltcl.c.html#LN2285"><span class='Ref_To_Local'>spi_rc</span></a><span class='Delimiter'>, 
</span>                                         <a href="../../backend/executor/spi.c.html#LN40"><span class='Ref_to_Global_Var'>SPI_tuptable</span></a><span class='Delimiter'>, 
</span>                                         <a href="../../backend/executor/spi.c.html#LN38"><span class='Ref_to_Global_Var'>SPI_processed</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="pltcl.c.html#LN313"><span class='Ref_to_Proto'>pltcl_subtrans_commit</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2292"><span class='Ref_To_Local'>oldcontext</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2293"><span class='Ref_To_Local'>oldowner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pltcl.c.html#LN315"><span class='Ref_to_Proto'>pltcl_subtrans_abort</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2281"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2292"><span class='Ref_To_Local'>oldcontext</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2293"><span class='Ref_To_Local'>oldowner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> TCL_ERROR<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="pltcl.c.html#LN2284"><span class='Ref_To_Local'>my_rc</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pltcl_SPI_execute &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Process the result from SPI_execute or SPI_execute_plan 
 * 
 * Shared code between pltcl_SPI_execute and pltcl_SPI_execute_plan 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN2390"></a><span class='Declare_Function'>pltcl_process_SPI_result</span><span class='Parentheses'>(</span>Tcl_Interp <span class='Operator'>*</span><span class='Declare_Parameter'>interp</span><span class='Delimiter'>, 
</span><a name="LN2391"></a>                         <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>arrayname</span><span class='Delimiter'>, 
</span><a name="LN2392"></a>                         Tcl_Obj <span class='Operator'>*</span><span class='Declare_Parameter'>loop_body</span><span class='Delimiter'>, 
</span><a name="LN2393"></a>                         <span class='Keyword'>int </span><span class='Declare_Parameter'>spi_rc</span><span class='Delimiter'>, 
</span><a name="LN2394"></a>                         <a href="../../include/executor/spi.h.html#LN21"><span class='Ref_to_Struct'>SPITupleTable</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tuptable</span><span class='Delimiter'>, 
</span><a name="LN2395"></a>                         <a href="../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a> <span class='Declare_Parameter'>ntuples</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2397"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>my_rc</span> <span class='Operator'>= </span>TCL_OK<span class='Delimiter'>; 
</span><a name="LN2398"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>loop_rc</span><span class='Delimiter'>; 
</span><a name="LN2399"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>tuples</span><span class='Delimiter'>; 
</span><a name="LN2400"></a>    <a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2393"><span class='Ref_to_Parameter'>spi_rc</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../include/executor/spi.h.html#LN54"><span class='Ref_to_Const'>SPI_OK_SELINTO</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../include/executor/spi.h.html#LN55"><span class='Ref_to_Const'>SPI_OK_INSERT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../include/executor/spi.h.html#LN56"><span class='Ref_to_Const'>SPI_OK_DELETE</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../include/executor/spi.h.html#LN57"><span class='Ref_to_Const'>SPI_OK_UPDATE</span></a><span class='Operator'>: 
</span>            Tcl_SetObjResult<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2390"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span>Tcl_NewWideIntObj<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2395"><span class='Ref_to_Parameter'>ntuples</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../include/executor/spi.h.html#LN52"><span class='Ref_to_Const'>SPI_OK_UTILITY</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../include/executor/spi.h.html#LN62"><span class='Ref_to_Const'>SPI_OK_REWRITTEN</span></a><span class='Operator'>: 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2394"><span class='Ref_to_Parameter'>tuptable</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                Tcl_SetObjResult<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2390"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span>Tcl_NewIntObj<span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Comment_Multi_Line'>/* FALL THRU for utility returning tuples */ 
</span> 
        <span class='Control'>case</span> <a href="../../include/executor/spi.h.html#LN53"><span class='Ref_to_Const'>SPI_OK_SELECT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../include/executor/spi.h.html#LN59"><span class='Ref_to_Const'>SPI_OK_INSERT_RETURNING</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../include/executor/spi.h.html#LN60"><span class='Ref_to_Const'>SPI_OK_DELETE_RETURNING</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../include/executor/spi.h.html#LN61"><span class='Ref_to_Const'>SPI_OK_UPDATE_RETURNING</span></a><span class='Operator'>: 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Process the tuples we got 
             */ 
</span>            <a href="pltcl.c.html#LN2399"><span class='Ref_To_Local'>tuples</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN2394"><span class='Ref_to_Parameter'>tuptable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/spi.h.html#LN27"><span class='Ref_to_Member'>vals</span></a><span class='Delimiter'>; 
</span>            <a href="pltcl.c.html#LN2400"><span class='Ref_To_Local'>tupdesc</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN2394"><span class='Ref_to_Parameter'>tuptable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/spi.h.html#LN26"><span class='Ref_to_Member'>tupdesc</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2392"><span class='Ref_to_Parameter'>loop_body</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * If there is no loop body given, just set the variables from 
                 * the first tuple (if any) 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2395"><span class='Ref_to_Parameter'>ntuples</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                    <a href="pltcl.c.html#LN319"><span class='Ref_to_Proto'>pltcl_set_tuple_values</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2390"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2391"><span class='Ref_to_Parameter'>arrayname</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                                           <a href="pltcl.c.html#LN2399"><span class='Ref_To_Local'>tuples</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], </span><a href="pltcl.c.html#LN2400"><span class='Ref_To_Local'>tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * There is a loop body - process all tuples and evaluate the 
                 * body on each 
                 */ 
</span><a name="LN2447"></a>                <a href="../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a>      <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2447"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pltcl.c.html#LN2447"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="pltcl.c.html#LN2395"><span class='Ref_to_Parameter'>ntuples</span></a><span class='Delimiter'>; </span><a href="pltcl.c.html#LN2447"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="pltcl.c.html#LN319"><span class='Ref_to_Proto'>pltcl_set_tuple_values</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2390"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2391"><span class='Ref_to_Parameter'>arrayname</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2447"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, 
</span>                                           <a href="pltcl.c.html#LN2399"><span class='Ref_To_Local'>tuples</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN2447"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="pltcl.c.html#LN2400"><span class='Ref_To_Local'>tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <a href="pltcl.c.html#LN2398"><span class='Ref_To_Local'>loop_rc</span></a> <span class='Operator'>= </span>Tcl_EvalObjEx<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2390"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2392"><span class='Ref_to_Parameter'>loop_body</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2398"><span class='Ref_To_Local'>loop_rc</span></a> <span class='Operator'>== </span>TCL_OK<span class='Parentheses'>) 
</span>                        <span class='Control'>continue</span><span class='Delimiter'>; 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2398"><span class='Ref_To_Local'>loop_rc</span></a> <span class='Operator'>== </span>TCL_CONTINUE<span class='Parentheses'>) 
</span>                        <span class='Control'>continue</span><span class='Delimiter'>; 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2398"><span class='Ref_To_Local'>loop_rc</span></a> <span class='Operator'>== </span>TCL_RETURN<span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span>                        <a href="pltcl.c.html#LN2397"><span class='Ref_To_Local'>my_rc</span></a> <span class='Operator'>= </span>TCL_RETURN<span class='Delimiter'>; 
</span>                        <span class='Control'>break</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2398"><span class='Ref_To_Local'>loop_rc</span></a> <span class='Operator'>== </span>TCL_BREAK<span class='Parentheses'>) 
</span>                        <span class='Control'>break</span><span class='Delimiter'>; 
</span>                    <a href="pltcl.c.html#LN2397"><span class='Ref_To_Local'>my_rc</span></a> <span class='Operator'>= </span>TCL_ERROR<span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;ntuples;i++ &raquo; </span> 
            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2397"><span class='Ref_To_Local'>my_rc</span></a> <span class='Operator'>== </span>TCL_OK<span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                Tcl_SetObjResult<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2390"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span>Tcl_NewWideIntObj<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2395"><span class='Ref_to_Parameter'>ntuples</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>default</span><span class='Operator'>: 
</span>            Tcl_AppendResult<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2390"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><span class='String'>"pltcl: SPI_execute failed: "</span><span class='Delimiter'>, 
</span>                             <a href="../../include/executor/spi.h.html#LN114"><span class='Ref_to_Proto'>SPI_result_code_string</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2393"><span class='Ref_to_Parameter'>spi_rc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pltcl.c.html#LN2397"><span class='Ref_To_Local'>my_rc</span></a> <span class='Operator'>= </span>TCL_ERROR<span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch spi_rc &raquo; </span> 
 
    <a href="../../include/executor/spi.h.html#LN136"><span class='Ref_to_Proto'>SPI_freetuptable</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2394"><span class='Ref_to_Parameter'>tuptable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="pltcl.c.html#LN2397"><span class='Ref_To_Local'>my_rc</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pltcl_process_SPI_result &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * pltcl_SPI_prepare()      - Builtin support for prepared plans 
 *                The Tcl command SPI_prepare 
 *                always saves the plan using 
 *                SPI_keepplan and returns a key for 
 *                access. There is no chance to prepare 
 *                and not save the plan currently. 
 **********************************************************************/ 
</span><span class='Keyword'>static int 
</span><a name="LN2500"></a><span class='Declare_Function'>pltcl_SPI_prepare</span><span class='Parentheses'>(</span>ClientData <span class='Declare_Parameter'>cdata</span><span class='Delimiter'>, </span>Tcl_Interp <span class='Operator'>*</span><span class='Declare_Parameter'>interp</span><span class='Delimiter'>, 
</span><a name="LN2501"></a>                  <span class='Keyword'>int </span><span class='Declare_Parameter'>objc</span><span class='Delimiter'>, </span>Tcl_Obj <span class='Operator'>*</span><span class='Keyword'>const </span><span class='Declare_Parameter'>objv</span><span class='Delimiter'>[]</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2503"></a>    <span class='Keyword'>volatile </span><a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>plan_cxt</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN2504"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nargs</span><span class='Delimiter'>; 
</span><a name="LN2505"></a>    Tcl_Obj   <span class='Operator'>**</span><span class='Declare_Local'>argsObj</span><span class='Delimiter'>; 
</span><a name="LN2506"></a>    <a href="pltcl.c.html#LN159"><span class='Ref_to_Struct'>pltcl_query_desc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>qdesc</span><span class='Delimiter'>; 
</span><a name="LN2507"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN2508"></a>    Tcl_HashEntry <span class='Operator'>*</span><span class='Declare_Local'>hashent</span><span class='Delimiter'>; 
</span><a name="LN2509"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>hashnew</span><span class='Delimiter'>; 
</span><a name="LN2510"></a>    Tcl_HashTable <span class='Operator'>*</span><span class='Declare_Local'>query_hash</span><span class='Delimiter'>; 
</span><a name="LN2511"></a>    <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span> <span class='Operator'>= </span><a href="../../backend/utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>; 
</span><a name="LN2512"></a>    <a href="../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Local'>oldowner</span> <span class='Operator'>= </span><a href="../../backend/utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Check the call syntax 
     ************************************************************/ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2501"><span class='Ref_to_Parameter'>objc</span></a> <span class='Operator'>!= </span><span class='Number'>3</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        Tcl_WrongNumArgs<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2500"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2501"><span class='Ref_to_Parameter'>objv</span></a><span class='Delimiter'>, </span><span class='String'>"query argtypes"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> TCL_ERROR<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Split the argument type list 
     ************************************************************/ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>Tcl_ListObjGetElements<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2500"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2501"><span class='Ref_to_Parameter'>objv</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>], </span><span class='Operator'>&</span><a href="pltcl.c.html#LN2504"><span class='Ref_To_Local'>nargs</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pltcl.c.html#LN2505"><span class='Ref_To_Local'>argsObj</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span>TCL_OK<span class='Parentheses'>)</span> 
        <span class='Control'>return</span> TCL_ERROR<span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Allocate the new querydesc structure 
     * 
     * struct qdesc and subsidiary data all live in plan_cxt.  Note that if the 
     * function is recompiled for whatever reason, permanent memory leaks 
     * occur.  FIXME someday. 
     ************************************************************/ 
</span>    <a href="pltcl.c.html#LN2503"><span class='Ref_To_Local'>plan_cxt</span></a> <span class='Operator'>= </span><a href="../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../../backend/utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, 
</span>                                     <span class='String'>"PL/Tcl spi_prepare query"</span><span class='Delimiter'>, 
</span>                                     <a href="../../include/utils/memutils.h.html#LN174"><span class='Ref_to_Const'>ALLOCSET_SMALL_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2503"><span class='Ref_To_Local'>plan_cxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN2506"><span class='Ref_To_Local'>qdesc</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN159"><span class='Ref_to_Struct'>pltcl_query_desc</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN159"><span class='Ref_to_Struct'>pltcl_query_desc</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2506"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN161"><span class='Ref_to_Member'>qname</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2506"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN161"><span class='Ref_to_Member'>qname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%p"</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2506"><span class='Ref_To_Local'>qdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN2506"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN163"><span class='Ref_to_Member'>nargs</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN2504"><span class='Ref_To_Local'>nargs</span></a><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN2506"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN164"><span class='Ref_to_Member'>argtypes</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2504"><span class='Ref_To_Local'>nargs</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN2506"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN165"><span class='Ref_to_Member'>arginfuncs</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2504"><span class='Ref_To_Local'>nargs</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN2506"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN166"><span class='Ref_to_Member'>argtypioparams</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2504"><span class='Ref_To_Local'>nargs</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2511"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Execute the prepare inside a sub-transaction, so we can cope with 
     * errors sanely 
     ************************************************************/ 
</span> 
    <a href="pltcl.c.html#LN311"><span class='Ref_to_Proto'>pltcl_subtrans_begin</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2511"><span class='Ref_To_Local'>oldcontext</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2512"><span class='Ref_To_Local'>oldowner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/************************************************************ 
         * Resolve argument type names and then look them up by oid 
         * in the system cache, and remember the required information 
         * for input conversion. 
         ************************************************************/ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2507"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pltcl.c.html#LN2507"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="pltcl.c.html#LN2504"><span class='Ref_To_Local'>nargs</span></a><span class='Delimiter'>; </span><a href="pltcl.c.html#LN2507"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2564"></a>            <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>typId</span><span class='Delimiter'>, 
</span><a name="LN2565"></a>                        <span class='Declare_Local'>typInput</span><span class='Delimiter'>, 
</span><a name="LN2566"></a>                        <span class='Declare_Local'>typIOParam</span><span class='Delimiter'>; 
</span><a name="LN2567"></a>            <a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>typmod</span><span class='Delimiter'>; 
</span> 
            <a href="../../include/parser/parse_type.h.html#LN50"><span class='Ref_to_Proto'>parseTypeString</span></a><span class='Parentheses'>(</span>Tcl_GetString<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2505"><span class='Ref_To_Local'>argsObj</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN2507"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pltcl.c.html#LN2564"><span class='Ref_To_Local'>typId</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pltcl.c.html#LN2567"><span class='Ref_To_Local'>typmod</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../include/utils/lsyscache.h.html#LN161"><span class='Ref_to_Proto'>getTypeInputInfo</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2564"><span class='Ref_To_Local'>typId</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pltcl.c.html#LN2565"><span class='Ref_To_Local'>typInput</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pltcl.c.html#LN2566"><span class='Ref_To_Local'>typIOParam</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="pltcl.c.html#LN2506"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN164"><span class='Ref_to_Member'>argtypes</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN2507"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="pltcl.c.html#LN2564"><span class='Ref_To_Local'>typId</span></a><span class='Delimiter'>; 
</span>            <a href="../../include/fmgr.h.html#LN99"><span class='Ref_to_Proto'>fmgr_info_cxt</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2565"><span class='Ref_To_Local'>typInput</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2506"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN165"><span class='Ref_to_Member'>arginfuncs</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN2507"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2503"><span class='Ref_To_Local'>plan_cxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pltcl.c.html#LN2506"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN166"><span class='Ref_to_Member'>argtypioparams</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN2507"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="pltcl.c.html#LN2566"><span class='Ref_To_Local'>typIOParam</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * Prepare the plan and check for errors 
         ************************************************************/ 
</span>        <a href="pltcl.c.html#LN84"><span class='Ref_to_Const'>UTF_BEGIN</span></a><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN2506"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN162"><span class='Ref_to_Member'>plan</span></a> <span class='Operator'>= </span><a href="../../include/executor/spi.h.html#LN99"><span class='Ref_to_Proto'>SPI_prepare</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN94"><span class='Ref_to_Macro'>UTF_U2E</span></a><span class='Parentheses'>(</span>Tcl_GetString<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2501"><span class='Ref_to_Parameter'>objv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                                  <a href="pltcl.c.html#LN2504"><span class='Ref_To_Local'>nargs</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2506"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN164"><span class='Ref_to_Member'>argtypes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN89"><span class='Ref_to_Const'>UTF_END</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2506"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN162"><span class='Ref_to_Member'>plan</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_prepare() failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * Save the plan into permanent memory (right now it's in the 
         * SPI procCxt, which will go away at function end). 
         ************************************************************/ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/executor/spi.h.html#LN106"><span class='Ref_to_Proto'>SPI_keepplan</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2506"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN162"><span class='Ref_to_Member'>plan</span></a><span class='Parentheses'>))</span> 
            <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_keepplan() failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="pltcl.c.html#LN313"><span class='Ref_to_Proto'>pltcl_subtrans_commit</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2511"><span class='Ref_To_Local'>oldcontext</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2512"><span class='Ref_To_Local'>oldowner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pltcl.c.html#LN315"><span class='Ref_to_Proto'>pltcl_subtrans_abort</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2500"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2511"><span class='Ref_To_Local'>oldcontext</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2512"><span class='Ref_To_Local'>oldowner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2503"><span class='Ref_To_Local'>plan_cxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> TCL_ERROR<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Insert a hashtable entry for the plan and return 
     * the key to the caller 
     ************************************************************/ 
</span>    <a href="pltcl.c.html#LN2510"><span class='Ref_To_Local'>query_hash</span></a> <span class='Operator'>= &</span><a href="pltcl.c.html#LN240"><span class='Ref_to_Global_Var'>pltcl_current_call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN212"><span class='Ref_to_Member'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN144"><span class='Ref_to_Member'>interp_desc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN115"><span class='Ref_to_Member'>query_hash</span></a><span class='Delimiter'>; 
</span> 
    <a href="pltcl.c.html#LN2508"><span class='Ref_To_Local'>hashent</span></a> <span class='Operator'>= </span>Tcl_CreateHashEntry<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2510"><span class='Ref_To_Local'>query_hash</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2506"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN161"><span class='Ref_to_Member'>qname</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pltcl.c.html#LN2509"><span class='Ref_To_Local'>hashnew</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    Tcl_SetHashValue<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2508"><span class='Ref_To_Local'>hashent</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span>ClientData<span class='Parentheses'>) </span><a href="pltcl.c.html#LN2506"><span class='Ref_To_Local'>qdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* qname is ASCII, so no need for encoding conversion */ 
</span>    Tcl_SetObjResult<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2500"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span>Tcl_NewStringObj<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2506"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN161"><span class='Ref_to_Member'>qname</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> TCL_OK<span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pltcl_SPI_prepare &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * pltcl_SPI_execute_plan()     - Execute a prepared plan 
 **********************************************************************/ 
</span><span class='Keyword'>static int 
</span><a name="LN2627"></a><span class='Declare_Function'>pltcl_SPI_execute_plan</span><span class='Parentheses'>(</span>ClientData <span class='Declare_Parameter'>cdata</span><span class='Delimiter'>, </span>Tcl_Interp <span class='Operator'>*</span><span class='Declare_Parameter'>interp</span><span class='Delimiter'>, 
</span><a name="LN2628"></a>                       <span class='Keyword'>int </span><span class='Declare_Parameter'>objc</span><span class='Delimiter'>, </span>Tcl_Obj <span class='Operator'>*</span><span class='Keyword'>const </span><span class='Declare_Parameter'>objv</span><span class='Delimiter'>[]</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2630"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>my_rc</span><span class='Delimiter'>; 
</span><a name="LN2631"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>spi_rc</span><span class='Delimiter'>; 
</span><a name="LN2632"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN2633"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>j</span><span class='Delimiter'>; 
</span><a name="LN2634"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>optIndex</span><span class='Delimiter'>; 
</span><a name="LN2635"></a>    Tcl_HashEntry <span class='Operator'>*</span><span class='Declare_Local'>hashent</span><span class='Delimiter'>; 
</span><a name="LN2636"></a>    <a href="pltcl.c.html#LN159"><span class='Ref_to_Struct'>pltcl_query_desc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>qdesc</span><span class='Delimiter'>; 
</span><a name="LN2637"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>nulls</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN2638"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>arrayname</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN2639"></a>    Tcl_Obj    <span class='Operator'>*</span><span class='Declare_Local'>loop_body</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN2640"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>count</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN2641"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>callObjc</span><span class='Delimiter'>; 
</span><a name="LN2642"></a>    Tcl_Obj   <span class='Operator'>**</span><span class='Declare_Local'>callObjv</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN2643"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>argvalues</span><span class='Delimiter'>; 
</span><a name="LN2644"></a>    <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span> <span class='Operator'>= </span><a href="../../backend/utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>; 
</span><a name="LN2645"></a>    <a href="../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Local'>oldowner</span> <span class='Operator'>= </span><a href="../../backend/utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Delimiter'>; 
</span><a name="LN2646"></a>    Tcl_HashTable <span class='Operator'>*</span><span class='Declare_Local'>query_hash</span><span class='Delimiter'>; 
</span> 
<a name="LN2648"></a>    <span class='Control'>enum</span> <span class='Declare_Local'>options</span> 
    <span class='Delimiter'>{ 
</span><a name="LN2650"></a>        <span class='Declare_Local'>OPT_ARRAY</span><span class='Delimiter'>, </span><span class='Declare_Local'>OPT_COUNT</span><span class='Delimiter'>, </span><span class='Declare_Local'>OPT_NULLS</span> 
    <span class='Delimiter'>}; 
</span> 
<a name="LN2653"></a>    <span class='Keyword'>static const char </span><span class='Operator'>*</span><span class='Declare_Local'>options</span><span class='Delimiter'>[] </span><span class='Operator'>= </span><span class='Delimiter'>{ 
</span>        <span class='String'>"-array"</span><span class='Delimiter'>, </span><span class='String'>"-count"</span><span class='Delimiter'>, </span><span class='String'>"-nulls"</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Null_Value'>NULL 
</span>    <span class='Delimiter'>}; 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Get the options and check syntax 
     ************************************************************/ 
</span>    <a href="pltcl.c.html#LN2632"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2632"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="pltcl.c.html#LN2628"><span class='Ref_to_Parameter'>objc</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>Tcl_GetIndexFromObj<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2628"><span class='Ref_to_Parameter'>objv</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN2632"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="pltcl.c.html#LN2648"><span class='Ref_to_Enum'>options</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                TCL_EXACT<span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pltcl.c.html#LN2634"><span class='Ref_To_Local'>optIndex</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span>TCL_OK<span class='Parentheses'>)</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>++</span><a href="pltcl.c.html#LN2632"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT;= </span><a href="pltcl.c.html#LN2628"><span class='Ref_to_Parameter'>objc</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            Tcl_SetObjResult<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2627"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, 
</span>                             Tcl_NewStringObj<span class='Parentheses'>(</span><span class='String'>"missing argument to -array, -count or -nulls"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> TCL_ERROR<span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>switch</span> <span class='Parentheses'>((</span><span class='Control'>enum</span> <a href="pltcl.c.html#LN2648"><span class='Ref_to_Enum'>options</span></a><span class='Parentheses'>) </span><a href="pltcl.c.html#LN2634"><span class='Ref_To_Local'>optIndex</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <a href="pltcl.c.html#LN2650"><span class='Ref_to_EnumConst'>OPT_ARRAY</span></a><span class='Operator'>: 
</span>                <a href="pltcl.c.html#LN2638"><span class='Ref_To_Local'>arrayname</span></a> <span class='Operator'>= </span>Tcl_GetString<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2628"><span class='Ref_to_Parameter'>objv</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN2632"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <a href="pltcl.c.html#LN2650"><span class='Ref_to_EnumConst'>OPT_COUNT</span></a><span class='Operator'>: 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span>Tcl_GetIntFromObj<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2627"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2628"><span class='Ref_to_Parameter'>objv</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN2632"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Delimiter'>], </span><span class='Operator'>&</span><a href="pltcl.c.html#LN2640"><span class='Ref_To_Local'>count</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span>TCL_OK<span class='Parentheses'>)</span> 
                    <span class='Control'>return</span> TCL_ERROR<span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <a href="pltcl.c.html#LN2650"><span class='Ref_to_EnumConst'>OPT_NULLS</span></a><span class='Operator'>: 
</span>                <a href="pltcl.c.html#LN2637"><span class='Ref_To_Local'>nulls</span></a> <span class='Operator'>= </span>Tcl_GetString<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2628"><span class='Ref_to_Parameter'>objv</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN2632"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while i&LT;objc &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Get the prepared plan descriptor by its key 
     ************************************************************/ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2632"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT;= </span><a href="pltcl.c.html#LN2628"><span class='Ref_to_Parameter'>objc</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        Tcl_SetObjResult<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2627"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, 
</span>               Tcl_NewStringObj<span class='Parentheses'>(</span><span class='String'>"missing argument to -count or -array"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> TCL_ERROR<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="pltcl.c.html#LN2646"><span class='Ref_To_Local'>query_hash</span></a> <span class='Operator'>= &</span><a href="pltcl.c.html#LN240"><span class='Ref_to_Global_Var'>pltcl_current_call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN212"><span class='Ref_to_Member'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN144"><span class='Ref_to_Member'>interp_desc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN115"><span class='Ref_to_Member'>query_hash</span></a><span class='Delimiter'>; 
</span> 
    <a href="pltcl.c.html#LN2635"><span class='Ref_To_Local'>hashent</span></a> <span class='Operator'>= </span>Tcl_FindHashEntry<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2646"><span class='Ref_To_Local'>query_hash</span></a><span class='Delimiter'>, </span>Tcl_GetString<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2628"><span class='Ref_to_Parameter'>objv</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN2632"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2635"><span class='Ref_To_Local'>hashent</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        Tcl_AppendResult<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2627"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><span class='String'>"invalid queryid '"</span><span class='Delimiter'>, </span>Tcl_GetString<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2628"><span class='Ref_to_Parameter'>objv</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN2632"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"'"</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> TCL_ERROR<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="pltcl.c.html#LN2636"><span class='Ref_To_Local'>qdesc</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN159"><span class='Ref_to_Struct'>pltcl_query_desc</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span>Tcl_GetHashValue<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2635"><span class='Ref_To_Local'>hashent</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN2632"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * If a nulls string is given, check for correct length 
     ************************************************************/ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2637"><span class='Ref_To_Local'>nulls</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2637"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="pltcl.c.html#LN2636"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN163"><span class='Ref_to_Member'>nargs</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            Tcl_SetObjResult<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2627"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, 
</span>                             Tcl_NewStringObj<span class='Parentheses'>( 
</span>                  <span class='String'>"length of nulls string doesn't match number of arguments"</span><span class='Delimiter'>, 
</span>                                              <span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> TCL_ERROR<span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * If there was a argtype list on preparation, we need 
     * an argument value list now 
     ************************************************************/ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2636"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN163"><span class='Ref_to_Member'>nargs</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2632"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT;= </span><a href="pltcl.c.html#LN2628"><span class='Ref_to_Parameter'>objc</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            Tcl_SetObjResult<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2627"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, 
</span>                             Tcl_NewStringObj<span class='Parentheses'>( 
</span>            <span class='String'>"argument list length doesn't match number of arguments for query"</span> 
                                              <span class='Delimiter'>,</span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> TCL_ERROR<span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * Split the argument values 
         ************************************************************/ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>Tcl_ListObjGetElements<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2627"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2628"><span class='Ref_to_Parameter'>objv</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN2632"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Delimiter'>], </span><span class='Operator'>&</span><a href="pltcl.c.html#LN2641"><span class='Ref_To_Local'>callObjc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pltcl.c.html#LN2642"><span class='Ref_To_Local'>callObjv</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span>TCL_OK<span class='Parentheses'>)</span> 
            <span class='Control'>return</span> TCL_ERROR<span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * Check that the number of arguments matches 
         ************************************************************/ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2641"><span class='Ref_To_Local'>callObjc</span></a> <span class='Operator'>!= </span><a href="pltcl.c.html#LN2636"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN163"><span class='Ref_to_Member'>nargs</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            Tcl_SetObjResult<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2627"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, 
</span>                             Tcl_NewStringObj<span class='Parentheses'>( 
</span>            <span class='String'>"argument list length doesn't match number of arguments for query"</span> 
                                              <span class='Delimiter'>,</span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> TCL_ERROR<span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if qdesc-&GT;nargs&GT;0 &raquo; </span> 
    <span class='Control'>else</span> 
        <a href="pltcl.c.html#LN2641"><span class='Ref_To_Local'>callObjc</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Get loop body if present 
     ************************************************************/ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2632"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="pltcl.c.html#LN2628"><span class='Ref_to_Parameter'>objc</span></a><span class='Parentheses'>) 
</span>        <a href="pltcl.c.html#LN2639"><span class='Ref_To_Local'>loop_body</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN2628"><span class='Ref_to_Parameter'>objv</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN2632"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Delimiter'>]; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2632"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>!= </span><a href="pltcl.c.html#LN2628"><span class='Ref_to_Parameter'>objc</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        Tcl_WrongNumArgs<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2627"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2628"><span class='Ref_to_Parameter'>objv</span></a><span class='Delimiter'>, 
</span>                         <span class='String'>"?-count n? ?-array name? ?-nulls string? "</span> 
                         <span class='String'>"query ?args? ?loop body?"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> TCL_ERROR<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Execute the plan inside a sub-transaction, so we can cope with 
     * errors sanely 
     ************************************************************/ 
</span> 
    <a href="pltcl.c.html#LN311"><span class='Ref_to_Proto'>pltcl_subtrans_begin</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2644"><span class='Ref_To_Local'>oldcontext</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2645"><span class='Ref_To_Local'>oldowner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/************************************************************ 
         * Setup the value array for SPI_execute_plan() using 
         * the type specific input functions 
         ************************************************************/ 
</span>        <a href="pltcl.c.html#LN2643"><span class='Ref_To_Local'>argvalues</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2641"><span class='Ref_To_Local'>callObjc</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2633"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pltcl.c.html#LN2633"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><a href="pltcl.c.html#LN2641"><span class='Ref_To_Local'>callObjc</span></a><span class='Delimiter'>; </span><a href="pltcl.c.html#LN2633"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2637"><span class='Ref_To_Local'>nulls</span></a> <span class='Operator'>&& </span><a href="pltcl.c.html#LN2637"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN2633"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'n'</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="pltcl.c.html#LN2643"><span class='Ref_To_Local'>argvalues</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN2633"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/fmgr.h.html#LN642"><span class='Ref_to_Proto'>InputFunctionCall</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pltcl.c.html#LN2636"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN165"><span class='Ref_to_Member'>arginfuncs</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN2633"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>], 
</span>                                                 <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                                 <a href="pltcl.c.html#LN2636"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN166"><span class='Ref_to_Member'>argtypioparams</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN2633"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>], 
</span>                                                 <span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <a href="pltcl.c.html#LN84"><span class='Ref_to_Const'>UTF_BEGIN</span></a><span class='Delimiter'>; 
</span>                <a href="pltcl.c.html#LN2643"><span class='Ref_To_Local'>argvalues</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN2633"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/fmgr.h.html#LN642"><span class='Ref_to_Proto'>InputFunctionCall</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pltcl.c.html#LN2636"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN165"><span class='Ref_to_Member'>arginfuncs</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN2633"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>], 
</span>                                         <a href="pltcl.c.html#LN94"><span class='Ref_to_Macro'>UTF_U2E</span></a><span class='Parentheses'>(</span>Tcl_GetString<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2642"><span class='Ref_To_Local'>callObjv</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN2633"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                                                 <a href="pltcl.c.html#LN2636"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN166"><span class='Ref_to_Member'>argtypioparams</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN2633"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>], 
</span>                                                 <span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="pltcl.c.html#LN89"><span class='Ref_to_Const'>UTF_END</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * Execute the plan 
         ************************************************************/ 
</span>        <a href="pltcl.c.html#LN2631"><span class='Ref_To_Local'>spi_rc</span></a> <span class='Operator'>= </span><a href="../../include/executor/spi.h.html#LN82"><span class='Ref_to_Proto'>SPI_execute_plan</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2636"><span class='Ref_To_Local'>qdesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN162"><span class='Ref_to_Member'>plan</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2643"><span class='Ref_To_Local'>argvalues</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2637"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>, 
</span>                              <a href="pltcl.c.html#LN240"><span class='Ref_to_Global_Var'>pltcl_current_call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN212"><span class='Ref_to_Member'>prodesc</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN142"><span class='Ref_to_Member'>fn_readonly</span></a><span class='Delimiter'>, 
</span>                                  <a href="pltcl.c.html#LN2640"><span class='Ref_To_Local'>count</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="pltcl.c.html#LN2630"><span class='Ref_To_Local'>my_rc</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN296"><span class='Ref_to_Proto'>pltcl_process_SPI_result</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2627"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, 
</span>                                         <a href="pltcl.c.html#LN2638"><span class='Ref_To_Local'>arrayname</span></a><span class='Delimiter'>, 
</span>                                         <a href="pltcl.c.html#LN2639"><span class='Ref_To_Local'>loop_body</span></a><span class='Delimiter'>, 
</span>                                         <a href="pltcl.c.html#LN2631"><span class='Ref_To_Local'>spi_rc</span></a><span class='Delimiter'>, 
</span>                                         <a href="../../backend/executor/spi.c.html#LN40"><span class='Ref_to_Global_Var'>SPI_tuptable</span></a><span class='Delimiter'>, 
</span>                                         <a href="../../backend/executor/spi.c.html#LN38"><span class='Ref_to_Global_Var'>SPI_processed</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="pltcl.c.html#LN313"><span class='Ref_to_Proto'>pltcl_subtrans_commit</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2644"><span class='Ref_To_Local'>oldcontext</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2645"><span class='Ref_To_Local'>oldowner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pltcl.c.html#LN315"><span class='Ref_to_Proto'>pltcl_subtrans_abort</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2627"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2644"><span class='Ref_To_Local'>oldcontext</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2645"><span class='Ref_To_Local'>oldowner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> TCL_ERROR<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="pltcl.c.html#LN2630"><span class='Ref_To_Local'>my_rc</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pltcl_SPI_execute_plan &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * pltcl_SPI_lastoid()  - return the last oid. To 
 *        be used after insert queries 
 **********************************************************************/ 
</span><span class='Keyword'>static int 
</span><a name="LN2844"></a><span class='Declare_Function'>pltcl_SPI_lastoid</span><span class='Parentheses'>(</span>ClientData <span class='Declare_Parameter'>cdata</span><span class='Delimiter'>, </span>Tcl_Interp <span class='Operator'>*</span><span class='Declare_Parameter'>interp</span><span class='Delimiter'>, 
</span><a name="LN2845"></a>                  <span class='Keyword'>int </span><span class='Declare_Parameter'>objc</span><span class='Delimiter'>, </span>Tcl_Obj <span class='Operator'>*</span><span class='Keyword'>const </span><span class='Declare_Parameter'>objv</span><span class='Delimiter'>[]</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Check call syntax 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2845"><span class='Ref_to_Parameter'>objc</span></a> <span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        Tcl_WrongNumArgs<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2844"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2845"><span class='Ref_to_Parameter'>objv</span></a><span class='Delimiter'>, </span><span class='String'>""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> TCL_ERROR<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    Tcl_SetObjResult<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2844"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span>Tcl_NewWideIntObj<span class='Parentheses'>(</span><a href="../../backend/executor/spi.c.html#LN39"><span class='Ref_to_Global_Var'>SPI_lastoid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> TCL_OK<span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * pltcl_subtransaction()   - Execute some Tcl code in a subtransaction 
 * 
 * The subtransaction is aborted if the Tcl code fragment returns TCL_ERROR, 
 * otherwise it's subcommitted. 
 **********************************************************************/ 
</span><span class='Keyword'>static int 
</span><a name="LN2868"></a><span class='Declare_Function'>pltcl_subtransaction</span><span class='Parentheses'>(</span>ClientData <span class='Declare_Parameter'>cdata</span><span class='Delimiter'>, </span>Tcl_Interp <span class='Operator'>*</span><span class='Declare_Parameter'>interp</span><span class='Delimiter'>, 
</span><a name="LN2869"></a>                     <span class='Keyword'>int </span><span class='Declare_Parameter'>objc</span><span class='Delimiter'>, </span>Tcl_Obj <span class='Operator'>*</span><span class='Keyword'>const </span><span class='Declare_Parameter'>objv</span><span class='Delimiter'>[]</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2871"></a>    <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span> <span class='Operator'>= </span><a href="../../backend/utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>; 
</span><a name="LN2872"></a>    <a href="../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Local'>oldowner</span> <span class='Operator'>= </span><a href="../../backend/utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Delimiter'>; 
</span><a name="LN2873"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>retcode</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2869"><span class='Ref_to_Parameter'>objc</span></a> <span class='Operator'>!= </span><span class='Number'>2</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        Tcl_WrongNumArgs<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2868"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2869"><span class='Ref_to_Parameter'>objv</span></a><span class='Delimiter'>, </span><span class='String'>"command"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> TCL_ERROR<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Note: we don't use pltcl_subtrans_begin and friends here because we 
     * don't want the error handling in pltcl_subtrans_abort.  But otherwise 
     * the processing should be about the same as in those functions. 
     */ 
</span>    <a href="../../include/access/xact.h.html#LN358"><span class='Ref_to_Proto'>BeginInternalSubTransaction</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2871"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pltcl.c.html#LN2873"><span class='Ref_To_Local'>retcode</span></a> <span class='Operator'>= </span>Tcl_EvalObjEx<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2868"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2869"><span class='Ref_to_Parameter'>objv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2873"><span class='Ref_To_Local'>retcode</span></a> <span class='Operator'>== </span>TCL_ERROR<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Rollback the subtransaction */ 
</span>        <a href="../../include/access/xact.h.html#LN360"><span class='Ref_to_Proto'>RollbackAndReleaseCurrentSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Commit the subtransaction */ 
</span>        <a href="../../include/access/xact.h.html#LN359"><span class='Ref_to_Proto'>ReleaseCurrentSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* In either case, restore previous memory context and resource owner */ 
</span>    <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2871"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../backend/utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN2872"><span class='Ref_To_Local'>oldowner</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="pltcl.c.html#LN2873"><span class='Ref_To_Local'>retcode</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pltcl_subtransaction &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * pltcl_set_tuple_values() - Set variables for all attributes 
 *                of a given tuple 
 * 
 * Note: arrayname is presumed to be UTF8; it usually came from Tcl 
 **********************************************************************/ 
</span><span class='Keyword'>static void 
</span><a name="LN2917"></a><span class='Declare_Function'>pltcl_set_tuple_values</span><span class='Parentheses'>(</span>Tcl_Interp <span class='Operator'>*</span><span class='Declare_Parameter'>interp</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>arrayname</span><span class='Delimiter'>, 
</span><a name="LN2918"></a>                       <a href="../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a> <span class='Declare_Parameter'>tupno</span><span class='Delimiter'>, </span><a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>tuple</span><span class='Delimiter'>, </span><a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>tupdesc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2920"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN2921"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>outputstr</span><span class='Delimiter'>; 
</span><a name="LN2922"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>attr</span><span class='Delimiter'>; 
</span><a name="LN2923"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull</span><span class='Delimiter'>; 
</span><a name="LN2924"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>attname</span><span class='Delimiter'>; 
</span><a name="LN2925"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>typoutput</span><span class='Delimiter'>; 
</span><a name="LN2926"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>typisvarlena</span><span class='Delimiter'>; 
</span><a name="LN2927"></a>    <span class='Keyword'>const char </span><span class='Operator'>**</span><span class='Declare_Local'>arrptr</span><span class='Delimiter'>; 
</span><a name="LN2928"></a>    <span class='Keyword'>const char </span><span class='Operator'>**</span><span class='Declare_Local'>nameptr</span><span class='Delimiter'>; 
</span><a name="LN2929"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>nullname</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/************************************************************ 
     * Prepare pointers for Tcl_SetVar2() below 
     ************************************************************/ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2917"><span class='Ref_to_Parameter'>arrayname</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pltcl.c.html#LN2927"><span class='Ref_To_Local'>arrptr</span></a> <span class='Operator'>= &</span><a href="pltcl.c.html#LN2924"><span class='Ref_To_Local'>attname</span></a><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN2928"><span class='Ref_To_Local'>nameptr</span></a> <span class='Operator'>= &</span><a href="pltcl.c.html#LN2929"><span class='Ref_To_Local'>nullname</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="pltcl.c.html#LN2927"><span class='Ref_To_Local'>arrptr</span></a> <span class='Operator'>= &</span><a href="pltcl.c.html#LN2917"><span class='Ref_to_Parameter'>arrayname</span></a><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN2928"><span class='Ref_To_Local'>nameptr</span></a> <span class='Operator'>= &</span><a href="pltcl.c.html#LN2924"><span class='Ref_To_Local'>attname</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * When outputting to an array, fill the ".tupno" element with the 
         * current tuple number.  This will be overridden below if ".tupno" is 
         * in use as an actual field name in the rowtype. 
         */ 
</span>        Tcl_SetVar2Ex<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2917"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2917"><span class='Ref_to_Parameter'>arrayname</span></a><span class='Delimiter'>, </span><span class='String'>".tupno"</span><span class='Delimiter'>, </span>Tcl_NewWideIntObj<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2918"><span class='Ref_to_Parameter'>tupno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2920"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pltcl.c.html#LN2920"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="pltcl.c.html#LN2918"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; </span><a href="pltcl.c.html#LN2920"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* ignore dropped attributes */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN2918"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN2920"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attisdropped<span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * Get the attribute name 
         ************************************************************/ 
</span>        <a href="pltcl.c.html#LN84"><span class='Ref_to_Const'>UTF_BEGIN</span></a><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN2924"><span class='Ref_To_Local'>attname</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN97"><span class='Ref_to_Macro'>UTF_E2U</span></a><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2918"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN2920"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attname<span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN89"><span class='Ref_to_Const'>UTF_END</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * Get the attributes value 
         ************************************************************/ 
</span>        <a href="pltcl.c.html#LN2922"><span class='Ref_To_Local'>attr</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN768"><span class='Ref_to_Macro'>heap_getattr</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2918"><span class='Ref_to_Parameter'>tuple</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2920"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2918"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pltcl.c.html#LN2923"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * If there is a value, set the variable 
         * If not, unset it 
         * 
         * Hmmm - Null attributes will cause functions to 
         *        crash if they don't expect them - need something 
         *        smarter here. 
         ************************************************************/ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pltcl.c.html#LN2923"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/lsyscache.h.html#LN162"><span class='Ref_to_Proto'>getTypeOutputInfo</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2918"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN2920"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypid<span class='Delimiter'>, 
</span>                              <span class='Operator'>&</span><a href="pltcl.c.html#LN2925"><span class='Ref_To_Local'>typoutput</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pltcl.c.html#LN2926"><span class='Ref_To_Local'>typisvarlena</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pltcl.c.html#LN2921"><span class='Ref_To_Local'>outputstr</span></a> <span class='Operator'>= </span><a href="../../include/fmgr.h.html#LN647"><span class='Ref_to_Proto'>OidOutputFunctionCall</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2925"><span class='Ref_To_Local'>typoutput</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN2922"><span class='Ref_To_Local'>attr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pltcl.c.html#LN84"><span class='Ref_to_Const'>UTF_BEGIN</span></a><span class='Delimiter'>; 
</span>            Tcl_SetVar2Ex<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2917"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="pltcl.c.html#LN2927"><span class='Ref_To_Local'>arrptr</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="pltcl.c.html#LN2928"><span class='Ref_To_Local'>nameptr</span></a><span class='Delimiter'>, 
</span>                          Tcl_NewStringObj<span class='Parentheses'>(</span><a href="pltcl.c.html#LN97"><span class='Ref_to_Macro'>UTF_E2U</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2921"><span class='Ref_To_Local'>outputstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pltcl.c.html#LN89"><span class='Ref_to_Const'>UTF_END</span></a><span class='Delimiter'>; 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN2921"><span class='Ref_To_Local'>outputstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            Tcl_UnsetVar2<span class='Parentheses'>(</span><a href="pltcl.c.html#LN2917"><span class='Ref_to_Parameter'>interp</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="pltcl.c.html#LN2927"><span class='Ref_To_Local'>arrptr</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="pltcl.c.html#LN2928"><span class='Ref_To_Local'>nameptr</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="pltcl.c.html#LN2924"><span class='Ref_To_Local'>attname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;tupdesc-&GT;natts;... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end pltcl_set_tuple_values &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * pltcl_build_tuple_argument() - Build a list object usable for 'array set' 
 *                from all attributes of a given tuple 
 **********************************************************************/ 
</span><span class='Keyword'>static </span>Tcl_Obj <span class='Operator'>* 
</span><a name="LN3002"></a><span class='Declare_Function'>pltcl_build_tuple_argument</span><span class='Parentheses'>(</span><a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>tuple</span><span class='Delimiter'>, </span><a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>tupdesc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3004"></a>    Tcl_Obj    <span class='Operator'>*</span><span class='Declare_Local'>retobj</span> <span class='Operator'>= </span>Tcl_NewObj<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><a name="LN3005"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN3006"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>outputstr</span><span class='Delimiter'>; 
</span><a name="LN3007"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>attr</span><span class='Delimiter'>; 
</span><a name="LN3008"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull</span><span class='Delimiter'>; 
</span><a name="LN3009"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>attname</span><span class='Delimiter'>; 
</span><a name="LN3010"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>typoutput</span><span class='Delimiter'>; 
</span><a name="LN3011"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>typisvarlena</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN3005"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pltcl.c.html#LN3005"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="pltcl.c.html#LN3002"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; </span><a href="pltcl.c.html#LN3005"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* ignore dropped attributes */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN3002"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN3005"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attisdropped<span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * Get the attribute name 
         ************************************************************/ 
</span>        <a href="pltcl.c.html#LN3009"><span class='Ref_To_Local'>attname</span></a> <span class='Operator'>= </span><a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN3002"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN3005"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attname<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * Get the attributes value 
         ************************************************************/ 
</span>        <a href="pltcl.c.html#LN3007"><span class='Ref_To_Local'>attr</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN768"><span class='Ref_to_Macro'>heap_getattr</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN3002"><span class='Ref_to_Parameter'>tuple</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN3005"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN3002"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pltcl.c.html#LN3008"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/************************************************************ 
         * If there is a value, append the attribute name and the 
         * value to the list 
         * 
         * Hmmm - Null attributes will cause functions to 
         *        crash if they don't expect them - need something 
         *        smarter here. 
         ************************************************************/ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pltcl.c.html#LN3008"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/lsyscache.h.html#LN162"><span class='Ref_to_Proto'>getTypeOutputInfo</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN3002"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN3005"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypid<span class='Delimiter'>, 
</span>                              <span class='Operator'>&</span><a href="pltcl.c.html#LN3010"><span class='Ref_To_Local'>typoutput</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pltcl.c.html#LN3011"><span class='Ref_To_Local'>typisvarlena</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pltcl.c.html#LN3006"><span class='Ref_To_Local'>outputstr</span></a> <span class='Operator'>= </span><a href="../../include/fmgr.h.html#LN647"><span class='Ref_to_Proto'>OidOutputFunctionCall</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN3010"><span class='Ref_To_Local'>typoutput</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN3007"><span class='Ref_To_Local'>attr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pltcl.c.html#LN84"><span class='Ref_to_Const'>UTF_BEGIN</span></a><span class='Delimiter'>; 
</span>            Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN3004"><span class='Ref_To_Local'>retobj</span></a><span class='Delimiter'>, 
</span>                                     Tcl_NewStringObj<span class='Parentheses'>(</span><a href="pltcl.c.html#LN97"><span class='Ref_to_Macro'>UTF_E2U</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN3009"><span class='Ref_To_Local'>attname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="pltcl.c.html#LN89"><span class='Ref_to_Const'>UTF_END</span></a><span class='Delimiter'>; 
</span>            <a href="pltcl.c.html#LN84"><span class='Ref_to_Const'>UTF_BEGIN</span></a><span class='Delimiter'>; 
</span>            Tcl_ListObjAppendElement<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pltcl.c.html#LN3004"><span class='Ref_To_Local'>retobj</span></a><span class='Delimiter'>, 
</span>                                   Tcl_NewStringObj<span class='Parentheses'>(</span><a href="pltcl.c.html#LN97"><span class='Ref_to_Macro'>UTF_E2U</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN3006"><span class='Ref_To_Local'>outputstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="pltcl.c.html#LN89"><span class='Ref_to_Const'>UTF_END</span></a><span class='Delimiter'>; 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN3006"><span class='Ref_To_Local'>outputstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;tupdesc-&GT;natts;... &raquo; </span> 
 
    <span class='Control'>return</span> <a href="pltcl.c.html#LN3004"><span class='Ref_To_Local'>retobj</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pltcl_build_tuple_argument &raquo; </span> 
 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * pltcl_build_tuple_result() - Build a tuple of function's result rowtype 
 *                from a Tcl list of column names and values 
 * 
 * In a trigger function, we build a tuple of the trigger table's rowtype. 
 * 
 * Note: this function leaks memory.  Even if we made it clean up its own 
 * mess, there's no way to prevent the datatype input functions it calls 
 * from leaking.  Run it in a short-lived context, unless we're about to 
 * exit the procedure anyway. 
 **********************************************************************/ 
</span><span class='Keyword'>static </span><a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> 
<a name="LN3069"></a><span class='Declare_Function'>pltcl_build_tuple_result</span><span class='Parentheses'>(</span>Tcl_Interp <span class='Operator'>*</span><span class='Declare_Parameter'>interp</span><span class='Delimiter'>, </span>Tcl_Obj <span class='Operator'>**</span><span class='Declare_Parameter'>kvObjv</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>kvObjc</span><span class='Delimiter'>, 
</span><a name="LN3070"></a>                         <a href="pltcl.c.html#LN203"><span class='Ref_to_Struct'>pltcl_call_state</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>call_state</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3072"></a>    <a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span><span class='Delimiter'>; 
</span><a name="LN3073"></a>    <a href="../../include/funcapi.h.html#LN34"><span class='Ref_to_Struct'>AttInMetadata</span></a> <span class='Operator'>*</span><span class='Declare_Local'>attinmeta</span><span class='Delimiter'>; 
</span><a name="LN3074"></a>    <span class='Keyword'>char</span>      <span class='Operator'>**</span><span class='Declare_Local'>values</span><span class='Delimiter'>; 
</span><a name="LN3075"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN3070"><span class='Ref_to_Parameter'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN219"><span class='Ref_to_Member'>ret_tupdesc</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pltcl.c.html#LN3072"><span class='Ref_To_Local'>tupdesc</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN3070"><span class='Ref_to_Parameter'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN219"><span class='Ref_to_Member'>ret_tupdesc</span></a><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN3073"><span class='Ref_To_Local'>attinmeta</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN3070"><span class='Ref_to_Parameter'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN220"><span class='Ref_to_Member'>attinmeta</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN3070"><span class='Ref_to_Parameter'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN209"><span class='Ref_to_Member'>trigdata</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pltcl.c.html#LN3072"><span class='Ref_To_Local'>tupdesc</span></a> <span class='Operator'>= </span><a href="../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN3070"><span class='Ref_to_Parameter'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN209"><span class='Ref_to_Member'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN3073"><span class='Ref_To_Local'>attinmeta</span></a> <span class='Operator'>= </span><a href="../../include/funcapi.h.html#LN230"><span class='Ref_to_Proto'>TupleDescGetAttInMetadata</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN3072"><span class='Ref_To_Local'>tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"PL/Tcl function does not return a tuple"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pltcl.c.html#LN3072"><span class='Ref_To_Local'>tupdesc</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* keep compiler quiet */ 
</span>        <a href="pltcl.c.html#LN3073"><span class='Ref_To_Local'>attinmeta</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="pltcl.c.html#LN3074"><span class='Ref_To_Local'>values</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN3072"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN3069"><span class='Ref_to_Parameter'>kvObjc</span></a> <span class='Operator'>% </span><span class='Number'>2</span> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>        <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"column name/value list must have even number of elements"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN3075"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pltcl.c.html#LN3075"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="pltcl.c.html#LN3069"><span class='Ref_to_Parameter'>kvObjc</span></a><span class='Delimiter'>; </span><a href="pltcl.c.html#LN3075"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+= </span><span class='Number'>2</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3103"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>fieldName</span> <span class='Operator'>= </span><a href="../plperl/plperl_helpers.h.html#LN10"><span class='Ref_to_Func'>utf_u2e</span></a><span class='Parentheses'>(</span>Tcl_GetString<span class='Parentheses'>(</span><a href="pltcl.c.html#LN3069"><span class='Ref_to_Parameter'>kvObjv</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN3075"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><a name="LN3104"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>attn</span> <span class='Operator'>= </span><a href="../../include/executor/spi.h.html#LN123"><span class='Ref_to_Proto'>SPI_fnumber</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN3072"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN3103"><span class='Ref_To_Local'>fieldName</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We silently ignore ".tupno", if it's present but doesn't match any 
         * actual output column.  This allows direct use of a row returned by 
         * pltcl_set_tuple_values(). 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN3104"><span class='Ref_To_Local'>attn</span></a> <span class='Operator'>== </span><a href="../../include/executor/spi.h.html#LN43"><span class='Ref_to_Const'>SPI_ERROR_NOATTRIBUTE</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="pltcl.c.html#LN3103"><span class='Ref_To_Local'>fieldName</span></a><span class='Delimiter'>, </span><span class='String'>".tupno"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_COLUMN<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"column name/value list contains nonexistent column name \"%s\""</span><span class='Delimiter'>, 
</span>                            <a href="pltcl.c.html#LN3103"><span class='Ref_To_Local'>fieldName</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pltcl.c.html#LN3104"><span class='Ref_To_Local'>attn</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot set system attribute \"%s\""</span><span class='Delimiter'>, 
</span>                            <a href="pltcl.c.html#LN3103"><span class='Ref_To_Local'>fieldName</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="pltcl.c.html#LN3074"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN3104"><span class='Ref_To_Local'>attn</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../plperl/plperl_helpers.h.html#LN10"><span class='Ref_to_Func'>utf_u2e</span></a><span class='Parentheses'>(</span>Tcl_GetString<span class='Parentheses'>(</span><a href="pltcl.c.html#LN3069"><span class='Ref_to_Parameter'>kvObjv</span></a><span class='Delimiter'>[</span><a href="pltcl.c.html#LN3075"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;kvObjc;i+=2 &raquo; </span> 
 
    <span class='Control'>return</span> <a href="../../include/funcapi.h.html#LN231"><span class='Ref_to_Proto'>BuildTupleFromCStrings</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN3073"><span class='Ref_To_Local'>attinmeta</span></a><span class='Delimiter'>, </span><a href="pltcl.c.html#LN3074"><span class='Ref_To_Local'>values</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pltcl_build_tuple_result &raquo; </span> 
 
<span class='Comment_Multi_Line'>/********************************************************************** 
 * pltcl_init_tuple_store() - Initialize the result tuplestore for a SRF 
 **********************************************************************/ 
</span><span class='Keyword'>static void 
</span><a name="LN3137"></a><span class='Declare_Function'>pltcl_init_tuple_store</span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN203"><span class='Ref_to_Struct'>pltcl_call_state</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>call_state</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3139"></a>    <a href="../../include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rsi</span> <span class='Operator'>= </span><a href="pltcl.c.html#LN3137"><span class='Ref_to_Parameter'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN222"><span class='Ref_to_Member'>rsi</span></a><span class='Delimiter'>; 
</span><a name="LN3140"></a>    <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcxt</span><span class='Delimiter'>; 
</span><a name="LN3141"></a>    <a href="../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Local'>oldowner</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Should be in a SRF */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN3139"><span class='Ref_To_Local'>rsi</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Should be first time through */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pltcl.c.html#LN3137"><span class='Ref_to_Parameter'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN223"><span class='Ref_to_Member'>tuple_store</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pltcl.c.html#LN3137"><span class='Ref_to_Parameter'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN220"><span class='Ref_to_Member'>attinmeta</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We expect caller to provide an appropriate result tupdesc */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pltcl.c.html#LN3139"><span class='Ref_To_Local'>rsi</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN266"><span class='Ref_to_Member'>expectedDesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN3137"><span class='Ref_to_Parameter'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN219"><span class='Ref_to_Member'>ret_tupdesc</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN3139"><span class='Ref_To_Local'>rsi</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN266"><span class='Ref_to_Member'>expectedDesc</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Switch to the right memory context and resource owner for storing the 
     * tuplestore. If we're within a subtransaction opened for an exception 
     * block, for example, we must still create the tuplestore in the resource 
     * owner that was active when this function was entered, and not in the 
     * subtransaction's resource owner. 
     */ 
</span>    <a href="pltcl.c.html#LN3140"><span class='Ref_To_Local'>oldcxt</span></a> <span class='Operator'>= </span><a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN3137"><span class='Ref_to_Parameter'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN224"><span class='Ref_to_Member'>tuple_store_cxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pltcl.c.html#LN3141"><span class='Ref_To_Local'>oldowner</span></a> <span class='Operator'>= </span><a href="../../backend/utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Delimiter'>; 
</span>    <a href="../../backend/utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN3137"><span class='Ref_to_Parameter'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN225"><span class='Ref_to_Member'>tuple_store_owner</span></a><span class='Delimiter'>; 
</span> 
    <a href="pltcl.c.html#LN3137"><span class='Ref_to_Parameter'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN223"><span class='Ref_to_Member'>tuple_store</span></a> <span class='Operator'>= 
</span>        <a href="../../include/utils/tuplestore.h.html#LN46"><span class='Ref_to_Proto'>tuplestore_begin_heap</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN3139"><span class='Ref_To_Local'>rsi</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN267"><span class='Ref_to_Member'>allowedModes</span></a> <span class='Operator'>& </span><a href="../../include/nodes/execnodes.h.html#LN251"><span class='Ref_to_EnumConst'>SFRM_Materialize_Random</span></a><span class='Delimiter'>, 
</span>                              <span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="../../backend/utils/init/globals.c.html#LN112"><span class='Ref_to_Global_Var'>work_mem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Build attinmeta in this context, too */ 
</span>    <a href="pltcl.c.html#LN3137"><span class='Ref_to_Parameter'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN220"><span class='Ref_to_Member'>attinmeta</span></a> <span class='Operator'>= </span><a href="../../include/funcapi.h.html#LN230"><span class='Ref_to_Proto'>TupleDescGetAttInMetadata</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN3137"><span class='Ref_to_Parameter'>call_state</span></a><span class='Operator'>-&GT;</span><a href="pltcl.c.html#LN219"><span class='Ref_to_Member'>ret_tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../backend/utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="pltcl.c.html#LN3141"><span class='Ref_To_Local'>oldowner</span></a><span class='Delimiter'>; 
</span>    <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="pltcl.c.html#LN3140"><span class='Ref_To_Local'>oldcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pltcl_init_tuple_store &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>