<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\test\isolation\isolationtester.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\test\isolation\isolationtester.c</b></p></td>
<td align='right'>
Wed Jun 14 08:26:14 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/* 
 * src/test/isolation/isolationtester.c 
 * 
 * isolationtester.c 
 *      Runs an isolation test specified by a spec file. 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres_fe.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/time.h&GT;</span> 
<span class='Directive'>#ifdef</span> HAVE_SYS_SELECT_H 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/select.h&GT;</span> 
<span class='Directive'>#endif</span> 
 
<span class='Keyword'>#include </span><span class='String'>"datatype/timestamp.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"libpq-fe.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pqexpbuffer.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pg_getopt.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"isolationtester.h"</span> 
 
<a name="LN21"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PREP_WAITING</span> <span class='String'>"isolationtester_waiting"</span> 
 
<span class='Comment_Multi_Line'>/* 
 * conns[0] is the global setup, teardown, and watchdog connection.  Additional 
 * connections represent spec-defined sessions. 
 */ 
</span><a name="LN27"></a><span class='Keyword'>static </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>**</span><span class='Declare_Var'>conns</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN28"></a><span class='Keyword'>static const char </span><span class='Operator'>**</span><span class='Declare_Var'>backend_pids</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN29"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>nconns</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* In dry run only output permutations to be run by the tester. */ 
</span><a name="LN32"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>dry_run</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<a name="LN34"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>run_testspec</span><span class='Parentheses'>(</span><a href="isolationtester.h.html#LN42"><span class='Ref_to_Typedef'>TestSpec</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>testspec</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN35"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>run_all_permutations</span><span class='Parentheses'>(</span><a href="isolationtester.h.html#LN42"><span class='Ref_to_Typedef'>TestSpec</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>testspec</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN36"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>run_all_permutations_recurse</span><span class='Parentheses'>(</span><a href="isolationtester.h.html#LN42"><span class='Ref_to_Typedef'>TestSpec</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>testspec</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nsteps</span><span class='Delimiter'>, 
</span><a name="LN37"></a>                             <a href="isolationtester.h.html#LN28"><span class='Ref_to_Struct'>Step</span></a> <span class='Operator'>**</span><span class='Declare_Parameter'>steps</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN38"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>run_named_permutations</span><span class='Parentheses'>(</span><a href="isolationtester.h.html#LN42"><span class='Ref_to_Typedef'>TestSpec</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>testspec</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN39"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>run_permutation</span><span class='Parentheses'>(</span><a href="isolationtester.h.html#LN42"><span class='Ref_to_Typedef'>TestSpec</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>testspec</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nsteps</span><span class='Delimiter'>, </span><a href="isolationtester.h.html#LN28"><span class='Ref_to_Struct'>Step</span></a> <span class='Operator'>**</span><span class='Declare_Parameter'>steps</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN41"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>STEP_NONBLOCK</span>   <span class='Number'>0x1</span>     <span class='Comment_Single_Line'>/* return 0 as soon as cmd waits for a lock */ 
</span><a name="LN42"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>STEP_RETRY</span>      <span class='Number'>0x2</span>     <span class='Comment_Single_Line'>/* this is a retry of a previously-waiting cmd */ 
</span><a name="LN43"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>try_complete_step</span><span class='Parentheses'>(</span><a href="isolationtester.h.html#LN28"><span class='Ref_to_Struct'>Step</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>step</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>flags</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN45"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>step_qsort_cmp</span><span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>a</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>b</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN46"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>step_bsearch_cmp</span><span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>a</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>b</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN48"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>printResultSet</span><span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>res</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* close all connections and exit */ 
</span><span class='Keyword'>static void 
</span><a name="LN52"></a><span class='Declare_Function'>exit_nicely</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN54"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN54"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN54"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="isolationtester.c.html#LN29"><span class='Ref_to_Global_Var'>nconns</span></a><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN54"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="../../interfaces/libpq/libpq-fe.h.html#LN272"><span class='Ref_to_Proto'>PQfinish</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN27"><span class='Ref_to_Global_Var'>conns</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN54"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>int 
</span><a name="LN62"></a><span class='Declare_Function'>main</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>argc</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>argv</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN64"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>conninfo</span><span class='Delimiter'>; 
</span><a name="LN65"></a>    <a href="isolationtester.h.html#LN42"><span class='Ref_to_Typedef'>TestSpec</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>testspec</span><span class='Delimiter'>; 
</span><a name="LN66"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN67"></a>                <span class='Declare_Local'>j</span><span class='Delimiter'>; 
</span><a name="LN68"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>n</span><span class='Delimiter'>; 
</span><a name="LN69"></a>    <a href="../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span><a name="LN70"></a>    <a href="../../interfaces/libpq/pqexpbuffer.h.html#LN43"><span class='Ref_to_Struct'>PQExpBufferData</span></a> <span class='Declare_Local'>wait_query</span><span class='Delimiter'>; 
</span><a name="LN71"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>opt</span><span class='Delimiter'>; 
</span><a name="LN72"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nallsteps</span><span class='Delimiter'>; 
</span><a name="LN73"></a>    <a href="isolationtester.h.html#LN28"><span class='Ref_to_Struct'>Step</span></a>      <span class='Operator'>**</span><span class='Declare_Local'>allsteps</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="isolationtester.c.html#LN71"><span class='Ref_To_Local'>opt</span></a> <span class='Operator'>= </span><a href="../../include/pg_getopt.h.html#LN42"><span class='Ref_to_Proto'>getopt</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN62"><span class='Ref_to_Parameter'>argc</span></a><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN62"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>, </span><span class='String'>"nV"</span><span class='Parentheses'>))</span> <span class='Operator'>!= -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN71"><span class='Ref_To_Local'>opt</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <span class='String'>'n'</span><span class='Operator'>: 
</span>                <a href="isolationtester.c.html#LN32"><span class='Ref_to_Global_Var'>dry_run</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'V'</span><span class='Operator'>: 
</span>                puts<span class='Parentheses'>(</span><span class='String'>"isolationtester (PostgreSQL) "</span> PG_VERSION<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>default</span><span class='Operator'>: 
</span>                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"Usage: isolationtester [-n] [CONNINFO]\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <a href="../../bin/psql/settings.h.html#LN150"><span class='Ref_to_Const'>EXIT_FAILURE</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Make stdout unbuffered to match stderr; and ensure stderr is unbuffered 
     * too, which it should already be everywhere except sometimes in Windows. 
     */ 
</span>    setbuf<span class='Parentheses'>(</span>stdout<span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    setbuf<span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the user supplies a non-option parameter on the command line, use it 
     * as the conninfo string; otherwise default to setting dbname=postgres 
     * and using environment variables or defaults for all other connection 
     * parameters. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN62"><span class='Ref_to_Parameter'>argc</span></a> <span class='Operator'>&GT; </span><a href="../../port/getopt.c.html#LN50"><span class='Ref_to_Global_Var'>optind</span></a><span class='Parentheses'>) 
</span>        <a href="isolationtester.c.html#LN64"><span class='Ref_To_Local'>conninfo</span></a> <span class='Operator'>= </span><a href="isolationtester.c.html#LN62"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><a href="../../port/getopt.c.html#LN50"><span class='Ref_to_Global_Var'>optind</span></a><span class='Delimiter'>]; 
</span>    <span class='Control'>else</span> 
        <a href="isolationtester.c.html#LN64"><span class='Ref_To_Local'>conninfo</span></a> <span class='Operator'>= </span><span class='String'>"dbname = postgres"</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Read the test spec from stdin */ 
</span>    <a href="isolationtester.h.html#LN57"><span class='Ref_to_Proto'>spec_yyparse</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="isolationtester.c.html#LN65"><span class='Ref_To_Local'>testspec</span></a> <span class='Operator'>= &</span><a href="specparse.y.html#LN17"><span class='Ref_to_Global_Var'>parseresult</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Create a lookup table of all steps. */ 
</span>    <a href="isolationtester.c.html#LN72"><span class='Ref_To_Local'>nallsteps</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="isolationtester.c.html#LN65"><span class='Ref_To_Local'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN48"><span class='Ref_to_Member'>nsessions</span></a><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="isolationtester.c.html#LN72"><span class='Ref_To_Local'>nallsteps</span></a> <span class='Operator'>+= </span><a href="isolationtester.c.html#LN65"><span class='Ref_To_Local'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN47"><span class='Ref_to_Member'>sessions</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN25"><span class='Ref_to_Member'>nsteps</span></a><span class='Delimiter'>; 
</span> 
    <a href="isolationtester.c.html#LN73"><span class='Ref_To_Local'>allsteps</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN25"><span class='Ref_to_Proto'>pg_malloc</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN72"><span class='Ref_To_Local'>nallsteps</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="isolationtester.h.html#LN28"><span class='Ref_to_Struct'>Step</span></a> <span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="isolationtester.c.html#LN68"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="isolationtester.c.html#LN65"><span class='Ref_To_Local'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN48"><span class='Ref_to_Member'>nsessions</span></a><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN67"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN67"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><a href="isolationtester.c.html#LN65"><span class='Ref_To_Local'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN47"><span class='Ref_to_Member'>sessions</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN25"><span class='Ref_to_Member'>nsteps</span></a><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN67"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <a href="isolationtester.c.html#LN73"><span class='Ref_To_Local'>allsteps</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN68"><span class='Ref_To_Local'>n</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="isolationtester.c.html#LN65"><span class='Ref_To_Local'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN47"><span class='Ref_to_Member'>sessions</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN24"><span class='Ref_to_Member'>steps</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN67"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/port.h.html#LN439"><span class='Ref_to_Macro'>qsort</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN73"><span class='Ref_To_Local'>allsteps</span></a><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN72"><span class='Ref_To_Local'>nallsteps</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="isolationtester.h.html#LN28"><span class='Ref_to_Struct'>Step</span></a> <span class='Operator'>*</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="isolationtester.c.html#LN45"><span class='Ref_to_Proto'>step_qsort_cmp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="isolationtester.c.html#LN65"><span class='Ref_To_Local'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN52"><span class='Ref_to_Member'>nallsteps</span></a> <span class='Operator'>= </span><a href="isolationtester.c.html#LN72"><span class='Ref_To_Local'>nallsteps</span></a><span class='Delimiter'>; 
</span>    <a href="isolationtester.c.html#LN65"><span class='Ref_To_Local'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN51"><span class='Ref_to_Member'>allsteps</span></a> <span class='Operator'>= </span><a href="isolationtester.c.html#LN73"><span class='Ref_To_Local'>allsteps</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Verify that all step names are unique */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="isolationtester.c.html#LN65"><span class='Ref_To_Local'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN52"><span class='Ref_to_Member'>nallsteps</span></a><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="isolationtester.c.html#LN65"><span class='Ref_To_Local'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN51"><span class='Ref_to_Member'>allsteps</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN31"><span class='Ref_to_Member'>name</span></a><span class='Delimiter'>, 
</span>                   <a href="isolationtester.c.html#LN65"><span class='Ref_To_Local'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN51"><span class='Ref_to_Member'>allsteps</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN31"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"duplicate step name: %s\n"</span><span class='Delimiter'>, 
</span>                    <a href="isolationtester.c.html#LN65"><span class='Ref_To_Local'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN51"><span class='Ref_to_Member'>allsteps</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN31"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../examples/testlibpq.c.html#LN12"><span class='Ref_to_Func'>exit_nicely</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * In dry-run mode, just print the permutations that would be run, and 
     * exit. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN32"><span class='Ref_to_Global_Var'>dry_run</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="isolationtester.c.html#LN34"><span class='Ref_to_Proto'>run_testspec</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN65"><span class='Ref_To_Local'>testspec</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"Parsed test spec with %d sessions\n"</span><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN65"><span class='Ref_To_Local'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN48"><span class='Ref_to_Member'>nsessions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Establish connections to the database, one for each session and an 
     * extra for lock wait detection and global work. 
     */ 
</span>    <a href="isolationtester.c.html#LN29"><span class='Ref_to_Global_Var'>nconns</span></a> <span class='Operator'>= </span><span class='Number'>1</span> <span class='Operator'>+ </span><a href="isolationtester.c.html#LN65"><span class='Ref_To_Local'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN48"><span class='Ref_to_Member'>nsessions</span></a><span class='Delimiter'>; 
</span>    <a href="isolationtester.c.html#LN27"><span class='Ref_to_Global_Var'>conns</span></a> <span class='Operator'>= </span><a href="../../include/snowball/header.h.html#LN54"><span class='Ref_to_Macro'>calloc</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN29"><span class='Ref_to_Global_Var'>nconns</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="isolationtester.c.html#LN28"><span class='Ref_to_Global_Var'>backend_pids</span></a> <span class='Operator'>= </span><a href="../../include/snowball/header.h.html#LN54"><span class='Ref_to_Macro'>calloc</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN29"><span class='Ref_to_Global_Var'>nconns</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="isolationtester.c.html#LN28"><span class='Ref_to_Global_Var'>backend_pids</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="isolationtester.c.html#LN29"><span class='Ref_to_Global_Var'>nconns</span></a><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="isolationtester.c.html#LN27"><span class='Ref_to_Global_Var'>conns</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN260"><span class='Ref_to_Proto'>PQconnectdb</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN64"><span class='Ref_To_Local'>conninfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN317"><span class='Ref_to_Proto'>PQstatus</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN27"><span class='Ref_to_Global_Var'>conns</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN48"><span class='Ref_to_EnumConst'>CONNECTION_OK</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"Connection %d to database failed: %s"</span><span class='Delimiter'>, 
</span>                    <a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN27"><span class='Ref_to_Global_Var'>conns</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="../examples/testlibpq.c.html#LN12"><span class='Ref_to_Func'>exit_nicely</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Suppress NOTIFY messages, which otherwise pop into results at odd 
         * places. 
         */ 
</span>        <a href="isolationtester.c.html#LN69"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN380"><span class='Ref_to_Proto'>PQexec</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN27"><span class='Ref_to_Global_Var'>conns</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><span class='String'>"SET client_min_messages = warning;"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN69"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN84"><span class='Ref_to_EnumConst'>PGRES_COMMAND_OK</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"message level setup failed: %s"</span><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN27"><span class='Ref_to_Global_Var'>conns</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="../examples/testlibpq.c.html#LN12"><span class='Ref_to_Func'>exit_nicely</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN69"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Get the backend pid for lock wait checking. */ 
</span>        <a href="isolationtester.c.html#LN69"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN380"><span class='Ref_to_Proto'>PQexec</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN27"><span class='Ref_to_Global_Var'>conns</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><span class='String'>"SELECT pg_backend_pid()"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN69"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN87"><span class='Ref_to_EnumConst'>PGRES_TUPLES_OK</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN473"><span class='Ref_to_Proto'>PQntuples</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN69"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>1</span> <span class='Operator'>&& </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN474"><span class='Ref_to_Proto'>PQnfields</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN69"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
                <a href="isolationtester.c.html#LN28"><span class='Ref_to_Global_Var'>backend_pids</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN24"><span class='Ref_to_Proto'>pg_strdup</span></a><span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN488"><span class='Ref_to_Proto'>PQgetvalue</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN69"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"backend pid query returned %d rows and %d columns, expected 1 row and 1 column"</span><span class='Delimiter'>, 
</span>                        <a href="../../interfaces/libpq/libpq-fe.h.html#LN473"><span class='Ref_to_Proto'>PQntuples</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN69"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN474"><span class='Ref_to_Proto'>PQnfields</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN69"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="../examples/testlibpq.c.html#LN12"><span class='Ref_to_Func'>exit_nicely</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"backend pid query failed: %s"</span><span class='Delimiter'>, 
</span>                    <a href="../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN27"><span class='Ref_to_Global_Var'>conns</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="../examples/testlibpq.c.html#LN12"><span class='Ref_to_Func'>exit_nicely</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN69"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;nconns;i++ &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Set the session index fields in steps. */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="isolationtester.c.html#LN65"><span class='Ref_To_Local'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN48"><span class='Ref_to_Member'>nsessions</span></a><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN209"></a>        <a href="isolationtester.h.html#LN19"><span class='Ref_to_Struct'>Session</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>session</span> <span class='Operator'>= </span><a href="isolationtester.c.html#LN65"><span class='Ref_To_Local'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN47"><span class='Ref_to_Member'>sessions</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span><a name="LN210"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>stepindex</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN210"><span class='Ref_To_Local'>stepindex</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN210"><span class='Ref_To_Local'>stepindex</span></a> <span class='Operator'>&LT; </span><a href="isolationtester.c.html#LN209"><span class='Ref_To_Local'>session</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN25"><span class='Ref_to_Member'>nsteps</span></a><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN210"><span class='Ref_To_Local'>stepindex</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <a href="isolationtester.c.html#LN209"><span class='Ref_To_Local'>session</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN24"><span class='Ref_to_Member'>steps</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN210"><span class='Ref_To_Local'>stepindex</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN30"><span class='Ref_to_Member'>session</span></a> <span class='Operator'>= </span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Build the query we'll use to detect lock contention among sessions in 
     * the test specification.  Most of the time, we could get away with 
     * simply checking whether a session is waiting for *any* lock: we don't 
     * exactly expect concurrent use of test tables.  However, autovacuum will 
     * occasionally take AccessExclusiveLock to truncate a table, and we must 
     * ignore that transient wait. 
     */ 
</span>    <a href="../../interfaces/libpq/pqexpbuffer.c.html#LN87"><span class='Ref_to_Func'>initPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="isolationtester.c.html#LN70"><span class='Ref_To_Local'>wait_query</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../interfaces/libpq/pqexpbuffer.h.html#LN164"><span class='Ref_to_Proto'>appendPQExpBufferStr</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="isolationtester.c.html#LN70"><span class='Ref_To_Local'>wait_query</span></a><span class='Delimiter'>, 
</span>            <span class='String'>"SELECT pg_catalog.pg_isolation_test_session_is_blocked($1, '{"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* The spec syntax requires at least one session; assume that here. */ 
</span>    <a href="../../interfaces/libpq/pqexpbuffer.h.html#LN164"><span class='Ref_to_Proto'>appendPQExpBufferStr</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="isolationtester.c.html#LN70"><span class='Ref_To_Local'>wait_query</span></a><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN28"><span class='Ref_to_Global_Var'>backend_pids</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>2</span><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="isolationtester.c.html#LN29"><span class='Ref_to_Global_Var'>nconns</span></a><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="../../interfaces/libpq/pqexpbuffer.c.html#LN260"><span class='Ref_to_Func'>appendPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="isolationtester.c.html#LN70"><span class='Ref_To_Local'>wait_query</span></a><span class='Delimiter'>, </span><span class='String'>",%s"</span><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN28"><span class='Ref_to_Global_Var'>backend_pids</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../interfaces/libpq/pqexpbuffer.h.html#LN164"><span class='Ref_to_Proto'>appendPQExpBufferStr</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="isolationtester.c.html#LN70"><span class='Ref_To_Local'>wait_query</span></a><span class='Delimiter'>, </span><span class='String'>"}')"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="isolationtester.c.html#LN69"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN389"><span class='Ref_to_Proto'>PQprepare</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN27"><span class='Ref_to_Global_Var'>conns</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], </span><a href="isolationtester.c.html#LN21"><span class='Ref_to_Const'>PREP_WAITING</span></a><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN70"><span class='Ref_To_Local'>wait_query</span></a><span class='Operator'>.</span><a href="../../interfaces/libpq/pqexpbuffer.h.html#LN45"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN69"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN84"><span class='Ref_to_EnumConst'>PGRES_COMMAND_OK</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"prepare of lock wait query failed: %s"</span><span class='Delimiter'>, 
</span>                <a href="../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN27"><span class='Ref_to_Global_Var'>conns</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../examples/testlibpq.c.html#LN12"><span class='Ref_to_Func'>exit_nicely</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN69"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../interfaces/libpq/pqexpbuffer.h.html#LN121"><span class='Ref_to_Proto'>termPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="isolationtester.c.html#LN70"><span class='Ref_To_Local'>wait_query</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Run the permutations specified in the spec, or all if none were 
     * explicitly specified. 
     */ 
</span>    <a href="isolationtester.c.html#LN34"><span class='Ref_to_Proto'>run_testspec</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN65"><span class='Ref_To_Local'>testspec</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Clean up and exit */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="isolationtester.c.html#LN29"><span class='Ref_to_Global_Var'>nconns</span></a><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="../../interfaces/libpq/libpq-fe.h.html#LN272"><span class='Ref_to_Proto'>PQfinish</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN27"><span class='Ref_to_Global_Var'>conns</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN66"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end main &raquo; </span> 
 
<a name="LN255"></a><span class='Keyword'>static int </span><span class='Operator'>*</span><span class='Declare_Var'>piles</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Run the permutations specified in the spec, or all if none were 
 * explicitly specified. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN262"></a><span class='Declare_Function'>run_testspec</span><span class='Parentheses'>(</span><a href="isolationtester.h.html#LN42"><span class='Ref_to_Typedef'>TestSpec</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>testspec</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN262"><span class='Ref_to_Parameter'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN49"><span class='Ref_to_Member'>permutations</span></a><span class='Parentheses'>) 
</span>        <a href="isolationtester.c.html#LN38"><span class='Ref_to_Proto'>run_named_permutations</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN262"><span class='Ref_to_Parameter'>testspec</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="isolationtester.c.html#LN35"><span class='Ref_to_Proto'>run_all_permutations</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN262"><span class='Ref_to_Parameter'>testspec</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Run all permutations of the steps and sessions. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN274"></a><span class='Declare_Function'>run_all_permutations</span><span class='Parentheses'>(</span><a href="isolationtester.h.html#LN42"><span class='Ref_to_Typedef'>TestSpec</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>testspec</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN276"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nsteps</span><span class='Delimiter'>; 
</span><a name="LN277"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN278"></a>    <a href="isolationtester.h.html#LN28"><span class='Ref_to_Struct'>Step</span></a>      <span class='Operator'>**</span><span class='Declare_Local'>steps</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Count the total number of steps in all sessions */ 
</span>    <a href="isolationtester.c.html#LN276"><span class='Ref_To_Local'>nsteps</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN277"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN277"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="isolationtester.c.html#LN274"><span class='Ref_to_Parameter'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN48"><span class='Ref_to_Member'>nsessions</span></a><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN277"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="isolationtester.c.html#LN276"><span class='Ref_To_Local'>nsteps</span></a> <span class='Operator'>+= </span><a href="isolationtester.c.html#LN274"><span class='Ref_to_Parameter'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN47"><span class='Ref_to_Member'>sessions</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN277"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN25"><span class='Ref_to_Member'>nsteps</span></a><span class='Delimiter'>; 
</span> 
    <a href="isolationtester.c.html#LN278"><span class='Ref_To_Local'>steps</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN25"><span class='Ref_to_Proto'>pg_malloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="isolationtester.h.html#LN28"><span class='Ref_to_Struct'>Step</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="isolationtester.c.html#LN276"><span class='Ref_To_Local'>nsteps</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * To generate the permutations, we conceptually put the steps of each 
     * session on a pile. To generate a permutation, we pick steps from the 
     * piles until all piles are empty. By picking steps from piles in 
     * different order, we get different permutations. 
     * 
     * A pile is actually just an integer which tells how many steps we've 
     * already picked from this pile. 
     */ 
</span>    <a href="isolationtester.c.html#LN255"><span class='Ref_to_Global_Var'>piles</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN25"><span class='Ref_to_Proto'>pg_malloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="isolationtester.c.html#LN274"><span class='Ref_to_Parameter'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN48"><span class='Ref_to_Member'>nsessions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN277"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN277"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="isolationtester.c.html#LN274"><span class='Ref_to_Parameter'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN48"><span class='Ref_to_Member'>nsessions</span></a><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN277"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="isolationtester.c.html#LN255"><span class='Ref_to_Global_Var'>piles</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN277"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="isolationtester.c.html#LN36"><span class='Ref_to_Proto'>run_all_permutations_recurse</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN274"><span class='Ref_to_Parameter'>testspec</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN278"><span class='Ref_To_Local'>steps</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end run_all_permutations &raquo; </span> 
 
<span class='Keyword'>static void 
</span><a name="LN304"></a><span class='Declare_Function'>run_all_permutations_recurse</span><span class='Parentheses'>(</span><a href="isolationtester.h.html#LN42"><span class='Ref_to_Typedef'>TestSpec</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>testspec</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nsteps</span><span class='Delimiter'>, </span><a href="isolationtester.h.html#LN28"><span class='Ref_to_Struct'>Step</span></a> <span class='Operator'>**</span><span class='Declare_Parameter'>steps</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN306"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN307"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>found</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN306"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN306"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="isolationtester.c.html#LN304"><span class='Ref_to_Parameter'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN48"><span class='Ref_to_Member'>nsessions</span></a><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN306"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* If there's any more steps in this pile, pick it and recurse */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN255"><span class='Ref_to_Global_Var'>piles</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN306"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>&LT; </span><a href="isolationtester.c.html#LN304"><span class='Ref_to_Parameter'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN47"><span class='Ref_to_Member'>sessions</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN306"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN25"><span class='Ref_to_Member'>nsteps</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="isolationtester.c.html#LN304"><span class='Ref_to_Parameter'>steps</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN304"><span class='Ref_to_Parameter'>nsteps</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="isolationtester.c.html#LN304"><span class='Ref_to_Parameter'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN47"><span class='Ref_to_Member'>sessions</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN306"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN24"><span class='Ref_to_Member'>steps</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN255"><span class='Ref_to_Global_Var'>piles</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN306"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]]; 
</span>            <a href="isolationtester.c.html#LN255"><span class='Ref_to_Global_Var'>piles</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN306"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
            <a href="isolationtester.c.html#LN36"><span class='Ref_to_Proto'>run_all_permutations_recurse</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN304"><span class='Ref_to_Parameter'>testspec</span></a><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN304"><span class='Ref_to_Parameter'>nsteps</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN304"><span class='Ref_to_Parameter'>steps</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="isolationtester.c.html#LN255"><span class='Ref_to_Global_Var'>piles</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN306"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>--</span><span class='Delimiter'>; 
</span> 
            <a href="isolationtester.c.html#LN307"><span class='Ref_To_Local'>found</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* If all the piles were empty, this permutation is completed. Run it */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="isolationtester.c.html#LN307"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>        <a href="isolationtester.c.html#LN39"><span class='Ref_to_Proto'>run_permutation</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN304"><span class='Ref_to_Parameter'>testspec</span></a><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN304"><span class='Ref_to_Parameter'>nsteps</span></a><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN304"><span class='Ref_to_Parameter'>steps</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end run_all_permutations_recurse &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Run permutations given in the test spec 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN334"></a><span class='Declare_Function'>run_named_permutations</span><span class='Parentheses'>(</span><a href="isolationtester.h.html#LN42"><span class='Ref_to_Typedef'>TestSpec</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>testspec</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN336"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN337"></a>                <span class='Declare_Local'>j</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN336"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN336"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="isolationtester.c.html#LN334"><span class='Ref_to_Parameter'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN50"><span class='Ref_to_Member'>npermutations</span></a><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN336"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN341"></a>        <a href="isolationtester.h.html#LN36"><span class='Ref_to_Typedef'>Permutation</span></a> <span class='Operator'>*</span><span class='Declare_Local'>p</span> <span class='Operator'>= </span><a href="isolationtester.c.html#LN334"><span class='Ref_to_Parameter'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN49"><span class='Ref_to_Member'>permutations</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN336"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span><a name="LN342"></a>        <a href="isolationtester.h.html#LN28"><span class='Ref_to_Struct'>Step</span></a>      <span class='Operator'>**</span><span class='Declare_Local'>steps</span><span class='Delimiter'>; 
</span> 
        <a href="isolationtester.c.html#LN342"><span class='Ref_To_Local'>steps</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN25"><span class='Ref_to_Proto'>pg_malloc</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN341"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN38"><span class='Ref_to_Member'>nsteps</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="isolationtester.h.html#LN28"><span class='Ref_to_Struct'>Step</span></a> <span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Find all the named steps using the lookup table */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN337"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN337"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><a href="isolationtester.c.html#LN341"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN38"><span class='Ref_to_Member'>nsteps</span></a><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN337"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN349"></a>            <a href="isolationtester.h.html#LN28"><span class='Ref_to_Struct'>Step</span></a>      <span class='Operator'>**</span><span class='Declare_Local'>this</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="isolationtester.h.html#LN28"><span class='Ref_to_Struct'>Step</span></a> <span class='Operator'>**</span><span class='Parentheses'>) </span>bsearch<span class='Parentheses'>(</span><a href="isolationtester.c.html#LN341"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN39"><span class='Ref_to_Member'>stepnames</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN337"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>], 
</span>                                                 <a href="isolationtester.c.html#LN334"><span class='Ref_to_Parameter'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN51"><span class='Ref_to_Member'>allsteps</span></a><span class='Delimiter'>, 
</span>                                                 <a href="isolationtester.c.html#LN334"><span class='Ref_to_Parameter'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN52"><span class='Ref_to_Member'>nallsteps</span></a><span class='Delimiter'>, 
</span>                                                 <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="isolationtester.h.html#LN28"><span class='Ref_to_Struct'>Step</span></a> <span class='Operator'>*</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                                 <span class='Operator'>&</span><a href="isolationtester.c.html#LN46"><span class='Ref_to_Proto'>step_bsearch_cmp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Keyword'>this </span><span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"undefined step \"%s\" specified in permutation\n"</span><span class='Delimiter'>, 
</span>                        <a href="isolationtester.c.html#LN341"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN39"><span class='Ref_to_Member'>stepnames</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN337"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../examples/testlibpq.c.html#LN12"><span class='Ref_to_Func'>exit_nicely</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="isolationtester.c.html#LN342"><span class='Ref_To_Local'>steps</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN337"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>] </span><span class='Operator'>= *</span><span class='Keyword'>this</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* And run them */ 
</span>        <a href="isolationtester.c.html#LN39"><span class='Ref_to_Proto'>run_permutation</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN334"><span class='Ref_to_Parameter'>testspec</span></a><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN341"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN38"><span class='Ref_to_Member'>nsteps</span></a><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN342"><span class='Ref_To_Local'>steps</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN342"><span class='Ref_To_Local'>steps</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;testspec-&GT;nperm... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end run_named_permutations &raquo; </span> 
 
<span class='Keyword'>static int 
</span><a name="LN372"></a><span class='Declare_Function'>step_qsort_cmp</span><span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>a</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>b</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN374"></a>    <a href="isolationtester.h.html#LN28"><span class='Ref_to_Struct'>Step</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>stepa</span> <span class='Operator'>= *</span><span class='Parentheses'>((</span><a href="isolationtester.h.html#LN28"><span class='Ref_to_Struct'>Step</span></a> <span class='Operator'>**</span><span class='Parentheses'>) </span><a href="isolationtester.c.html#LN372"><span class='Ref_to_Parameter'>a</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN375"></a>    <a href="isolationtester.h.html#LN28"><span class='Ref_to_Struct'>Step</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>stepb</span> <span class='Operator'>= *</span><span class='Parentheses'>((</span><a href="isolationtester.h.html#LN28"><span class='Ref_to_Struct'>Step</span></a> <span class='Operator'>**</span><span class='Parentheses'>) </span><a href="isolationtester.c.html#LN372"><span class='Ref_to_Parameter'>b</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> strcmp<span class='Parentheses'>(</span><a href="isolationtester.c.html#LN374"><span class='Ref_To_Local'>stepa</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN31"><span class='Ref_to_Member'>name</span></a><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN375"><span class='Ref_To_Local'>stepb</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN31"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static int 
</span><a name="LN381"></a><span class='Declare_Function'>step_bsearch_cmp</span><span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>a</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>b</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN383"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>stepname</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="isolationtester.c.html#LN381"><span class='Ref_to_Parameter'>a</span></a><span class='Delimiter'>; 
</span><a name="LN384"></a>    <a href="isolationtester.h.html#LN28"><span class='Ref_to_Struct'>Step</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>step</span> <span class='Operator'>= *</span><span class='Parentheses'>((</span><a href="isolationtester.h.html#LN28"><span class='Ref_to_Struct'>Step</span></a> <span class='Operator'>**</span><span class='Parentheses'>) </span><a href="isolationtester.c.html#LN381"><span class='Ref_to_Parameter'>b</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> strcmp<span class='Parentheses'>(</span><a href="isolationtester.c.html#LN383"><span class='Ref_To_Local'>stepname</span></a><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN384"><span class='Ref_To_Local'>step</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN31"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * If a step caused an error to be reported, print it out and clear it. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN393"></a><span class='Declare_Function'>report_error_message</span><span class='Parentheses'>(</span><a href="isolationtester.h.html#LN28"><span class='Ref_to_Struct'>Step</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>step</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN393"><span class='Ref_to_Parameter'>step</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN33"><span class='Ref_to_Member'>errormsg</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stdout<span class='Delimiter'>, </span><span class='String'>"%s\n"</span><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN393"><span class='Ref_to_Parameter'>step</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN33"><span class='Ref_to_Member'>errormsg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN393"><span class='Ref_to_Parameter'>step</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN33"><span class='Ref_to_Member'>errormsg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="isolationtester.c.html#LN393"><span class='Ref_to_Parameter'>step</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN33"><span class='Ref_to_Member'>errormsg</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * As above, but reports messages possibly emitted by multiple steps.  This is 
 * useful when we have a blocked command awakened by another one; we want to 
 * report all messages identically, for the case where we don't care which 
 * one fails due to a timeout such as deadlock timeout. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN410"></a><span class='Declare_Function'>report_multiple_error_messages</span><span class='Parentheses'>(</span><a href="isolationtester.h.html#LN28"><span class='Ref_to_Struct'>Step</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>step</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nextra</span><span class='Delimiter'>, </span><a href="isolationtester.h.html#LN28"><span class='Ref_to_Struct'>Step</span></a> <span class='Operator'>**</span><span class='Declare_Parameter'>extrastep</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN412"></a>    <a href="../../interfaces/libpq/pqexpbuffer.h.html#LN43"><span class='Ref_to_Struct'>PQExpBufferData</span></a> <span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span><a name="LN413"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>n</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN410"><span class='Ref_to_Parameter'>nextra</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="isolationtester.c.html#LN392"><span class='Ref_to_Func'>report_error_message</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN410"><span class='Ref_to_Parameter'>step</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../interfaces/libpq/pqexpbuffer.c.html#LN87"><span class='Ref_to_Func'>initPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="isolationtester.c.html#LN412"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../interfaces/libpq/pqexpbuffer.h.html#LN164"><span class='Ref_to_Proto'>appendPQExpBufferStr</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="isolationtester.c.html#LN412"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN410"><span class='Ref_to_Parameter'>step</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN31"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN413"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN413"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>&LT; </span><a href="isolationtester.c.html#LN410"><span class='Ref_to_Parameter'>nextra</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="isolationtester.c.html#LN413"><span class='Ref_To_Local'>n</span></a><span class='Parentheses'>) 
</span>        <a href="../../interfaces/libpq/pqexpbuffer.c.html#LN260"><span class='Ref_to_Func'>appendPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="isolationtester.c.html#LN412"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><span class='String'>" %s"</span><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN410"><span class='Ref_to_Parameter'>extrastep</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN413"><span class='Ref_To_Local'>n</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN31"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN410"><span class='Ref_to_Parameter'>step</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN33"><span class='Ref_to_Member'>errormsg</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stdout<span class='Delimiter'>, </span><span class='String'>"error in steps %s: %s\n"</span><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN412"><span class='Ref_To_Local'>buffer</span></a><span class='Operator'>.</span><a href="../../interfaces/libpq/pqexpbuffer.h.html#LN45"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, 
</span>                <a href="isolationtester.c.html#LN410"><span class='Ref_to_Parameter'>step</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN33"><span class='Ref_to_Member'>errormsg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN410"><span class='Ref_to_Parameter'>step</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN33"><span class='Ref_to_Member'>errormsg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="isolationtester.c.html#LN410"><span class='Ref_to_Parameter'>step</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN33"><span class='Ref_to_Member'>errormsg</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN413"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN413"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>&LT; </span><a href="isolationtester.c.html#LN410"><span class='Ref_to_Parameter'>nextra</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="isolationtester.c.html#LN413"><span class='Ref_To_Local'>n</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN410"><span class='Ref_to_Parameter'>extrastep</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN413"><span class='Ref_To_Local'>n</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN33"><span class='Ref_to_Member'>errormsg</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stdout<span class='Delimiter'>, </span><span class='String'>"error in steps %s: %s\n"</span><span class='Delimiter'>, 
</span>                <a href="isolationtester.c.html#LN412"><span class='Ref_To_Local'>buffer</span></a><span class='Operator'>.</span><a href="../../interfaces/libpq/pqexpbuffer.h.html#LN45"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN410"><span class='Ref_to_Parameter'>extrastep</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN413"><span class='Ref_To_Local'>n</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN33"><span class='Ref_to_Member'>errormsg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN410"><span class='Ref_to_Parameter'>extrastep</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN413"><span class='Ref_To_Local'>n</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN33"><span class='Ref_to_Member'>errormsg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="isolationtester.c.html#LN410"><span class='Ref_to_Parameter'>extrastep</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN413"><span class='Ref_To_Local'>n</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN33"><span class='Ref_to_Member'>errormsg</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../interfaces/libpq/pqexpbuffer.h.html#LN121"><span class='Ref_to_Proto'>termPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="isolationtester.c.html#LN412"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end report_multiple_error_messages &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Run one permutation 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN452"></a><span class='Declare_Function'>run_permutation</span><span class='Parentheses'>(</span><a href="isolationtester.h.html#LN42"><span class='Ref_to_Typedef'>TestSpec</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>testspec</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nsteps</span><span class='Delimiter'>, </span><a href="isolationtester.h.html#LN28"><span class='Ref_to_Struct'>Step</span></a> <span class='Operator'>**</span><span class='Declare_Parameter'>steps</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN454"></a>    <a href="../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span><a name="LN455"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN456"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>w</span><span class='Delimiter'>; 
</span><a name="LN457"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nwaiting</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN458"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nerrorstep</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN459"></a>    <a href="isolationtester.h.html#LN28"><span class='Ref_to_Struct'>Step</span></a>      <span class='Operator'>**</span><span class='Declare_Local'>waiting</span><span class='Delimiter'>; 
</span><a name="LN460"></a>    <a href="isolationtester.h.html#LN28"><span class='Ref_to_Struct'>Step</span></a>      <span class='Operator'>**</span><span class='Declare_Local'>errorstep</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * In dry run mode, just display the permutation in the same format used 
     * by spec files, and return. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN32"><span class='Ref_to_Global_Var'>dry_run</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"permutation"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN455"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN455"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="isolationtester.c.html#LN452"><span class='Ref_to_Parameter'>nsteps</span></a><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN455"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>" \"%s\""</span><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN452"><span class='Ref_to_Parameter'>steps</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN455"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN31"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="isolationtester.c.html#LN459"><span class='Ref_To_Local'>waiting</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN25"><span class='Ref_to_Proto'>pg_malloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="isolationtester.h.html#LN28"><span class='Ref_to_Struct'>Step</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="isolationtester.c.html#LN452"><span class='Ref_to_Parameter'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN48"><span class='Ref_to_Member'>nsessions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="isolationtester.c.html#LN460"><span class='Ref_To_Local'>errorstep</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN25"><span class='Ref_to_Proto'>pg_malloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="isolationtester.h.html#LN28"><span class='Ref_to_Struct'>Step</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="isolationtester.c.html#LN452"><span class='Ref_to_Parameter'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN48"><span class='Ref_to_Member'>nsessions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"\nstarting permutation:"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN455"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN455"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="isolationtester.c.html#LN452"><span class='Ref_to_Parameter'>nsteps</span></a><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN455"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>" %s"</span><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN452"><span class='Ref_to_Parameter'>steps</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN455"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN31"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Perform setup */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN455"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN455"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="isolationtester.c.html#LN452"><span class='Ref_to_Parameter'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN45"><span class='Ref_to_Member'>nsetupsqls</span></a><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN455"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="isolationtester.c.html#LN454"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN380"><span class='Ref_to_Proto'>PQexec</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN27"><span class='Ref_to_Global_Var'>conns</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], </span><a href="isolationtester.c.html#LN452"><span class='Ref_to_Parameter'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN44"><span class='Ref_to_Member'>setupsqls</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN455"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN454"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN87"><span class='Ref_to_EnumConst'>PGRES_TUPLES_OK</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="isolationtester.c.html#LN48"><span class='Ref_to_Proto'>printResultSet</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN454"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN454"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN84"><span class='Ref_to_EnumConst'>PGRES_COMMAND_OK</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"setup failed: %s"</span><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN27"><span class='Ref_to_Global_Var'>conns</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="../examples/testlibpq.c.html#LN12"><span class='Ref_to_Func'>exit_nicely</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN454"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Perform per-session setup */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN455"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN455"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="isolationtester.c.html#LN452"><span class='Ref_to_Parameter'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN48"><span class='Ref_to_Member'>nsessions</span></a><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN455"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN452"><span class='Ref_to_Parameter'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN47"><span class='Ref_to_Member'>sessions</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN455"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN22"><span class='Ref_to_Member'>setupsql</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="isolationtester.c.html#LN454"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN380"><span class='Ref_to_Proto'>PQexec</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN27"><span class='Ref_to_Global_Var'>conns</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN455"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>], </span><a href="isolationtester.c.html#LN452"><span class='Ref_to_Parameter'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN47"><span class='Ref_to_Member'>sessions</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN455"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN22"><span class='Ref_to_Member'>setupsql</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN454"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN87"><span class='Ref_to_EnumConst'>PGRES_TUPLES_OK</span></a><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="isolationtester.c.html#LN48"><span class='Ref_to_Proto'>printResultSet</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN454"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN454"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN84"><span class='Ref_to_EnumConst'>PGRES_COMMAND_OK</span></a><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"setup of session %s failed: %s"</span><span class='Delimiter'>, 
</span>                        <a href="isolationtester.c.html#LN452"><span class='Ref_to_Parameter'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN47"><span class='Ref_to_Member'>sessions</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN455"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN21"><span class='Ref_to_Member'>name</span></a><span class='Delimiter'>, 
</span>                        <a href="../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN27"><span class='Ref_to_Global_Var'>conns</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN455"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="../examples/testlibpq.c.html#LN12"><span class='Ref_to_Func'>exit_nicely</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN454"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Perform steps */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN455"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN455"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="isolationtester.c.html#LN452"><span class='Ref_to_Parameter'>nsteps</span></a><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN455"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN523"></a>        <a href="isolationtester.h.html#LN28"><span class='Ref_to_Struct'>Step</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>step</span> <span class='Operator'>= </span><a href="isolationtester.c.html#LN452"><span class='Ref_to_Parameter'>steps</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN455"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span><a name="LN524"></a>        <a href="../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>conn</span> <span class='Operator'>= </span><a href="isolationtester.c.html#LN27"><span class='Ref_to_Global_Var'>conns</span></a><span class='Delimiter'>[</span><span class='Number'>1</span> <span class='Operator'>+ </span><a href="isolationtester.c.html#LN523"><span class='Ref_To_Local'>step</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN30"><span class='Ref_to_Member'>session</span></a><span class='Delimiter'>]; 
</span><a name="LN525"></a>        <a href="isolationtester.h.html#LN28"><span class='Ref_to_Struct'>Step</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>oldstep</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN526"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>mustwait</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Check whether the session that needs to perform the next step is 
         * still blocked on an earlier step.  If so, wait for it to finish. 
         * 
         * (In older versions of this tool, we allowed precisely one session 
         * to be waiting at a time.  If we reached a step that required that 
         * session to execute the next command, we would declare the whole 
         * permutation invalid, cancel everything, and move on to the next 
         * one.  Unfortunately, that made it impossible to test the deadlock 
         * detector using this framework, unless the number of processes 
         * involved in the deadlock was precisely two.  We now assume that if 
         * we reach a step that is still blocked, we need to wait for it to 
         * unblock itself.) 
         */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN456"><span class='Ref_To_Local'>w</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN456"><span class='Ref_To_Local'>w</span></a> <span class='Operator'>&LT; </span><a href="isolationtester.c.html#LN457"><span class='Ref_To_Local'>nwaiting</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="isolationtester.c.html#LN456"><span class='Ref_To_Local'>w</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN523"><span class='Ref_To_Local'>step</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN30"><span class='Ref_to_Member'>session</span></a> <span class='Operator'>== </span><a href="isolationtester.c.html#LN459"><span class='Ref_To_Local'>waiting</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN456"><span class='Ref_To_Local'>w</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN30"><span class='Ref_to_Member'>session</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="isolationtester.c.html#LN525"><span class='Ref_To_Local'>oldstep</span></a> <span class='Operator'>= </span><a href="isolationtester.c.html#LN459"><span class='Ref_To_Local'>waiting</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN456"><span class='Ref_To_Local'>w</span></a><span class='Delimiter'>]; 
</span> 
                <span class='Comment_Multi_Line'>/* Wait for previous step on this connection. */ 
</span>                <a href="isolationtester.c.html#LN43"><span class='Ref_to_Proto'>try_complete_step</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN525"><span class='Ref_To_Local'>oldstep</span></a><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN42"><span class='Ref_to_Const'>STEP_RETRY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* Remove that step from the waiting[] array. */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN456"><span class='Ref_To_Local'>w</span></a> <span class='Operator'>+ </span><span class='Number'>1</span> <span class='Operator'>&LT; </span><a href="isolationtester.c.html#LN457"><span class='Ref_To_Local'>nwaiting</span></a><span class='Parentheses'>) 
</span>                    <a href="../../include/c.h.html#LN1057"><span class='Ref_to_Macro'>memmove</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="isolationtester.c.html#LN459"><span class='Ref_To_Local'>waiting</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN456"><span class='Ref_To_Local'>w</span></a><span class='Delimiter'>], </span><span class='Operator'>&</span><a href="isolationtester.c.html#LN459"><span class='Ref_To_Local'>waiting</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN456"><span class='Ref_To_Local'>w</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>], 
</span>                            <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN457"><span class='Ref_To_Local'>nwaiting</span></a> <span class='Operator'>- </span><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN456"><span class='Ref_To_Local'>w</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>))</span> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="isolationtester.h.html#LN28"><span class='Ref_to_Struct'>Step</span></a> <span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="isolationtester.c.html#LN457"><span class='Ref_To_Local'>nwaiting</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN525"><span class='Ref_To_Local'>oldstep</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Check for completion of any steps that were previously waiting. 
             * Remove any that have completed from waiting[], and include them 
             * in the list for report_multiple_error_messages(). 
             */ 
</span>            <a href="isolationtester.c.html#LN456"><span class='Ref_To_Local'>w</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="isolationtester.c.html#LN458"><span class='Ref_To_Local'>nerrorstep</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN456"><span class='Ref_To_Local'>w</span></a> <span class='Operator'>&LT; </span><a href="isolationtester.c.html#LN457"><span class='Ref_To_Local'>nwaiting</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN43"><span class='Ref_to_Proto'>try_complete_step</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN459"><span class='Ref_To_Local'>waiting</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN456"><span class='Ref_To_Local'>w</span></a><span class='Delimiter'>], </span><a href="isolationtester.c.html#LN41"><span class='Ref_to_Const'>STEP_NONBLOCK</span></a> <span class='Operator'>| </span><a href="isolationtester.c.html#LN42"><span class='Ref_to_Const'>STEP_RETRY</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* Still blocked on a lock, leave it alone. */ 
</span>                    <a href="isolationtester.c.html#LN456"><span class='Ref_To_Local'>w</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* This one finished, too! */ 
</span>                    <a href="isolationtester.c.html#LN460"><span class='Ref_To_Local'>errorstep</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN458"><span class='Ref_To_Local'>nerrorstep</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="isolationtester.c.html#LN459"><span class='Ref_To_Local'>waiting</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN456"><span class='Ref_To_Local'>w</span></a><span class='Delimiter'>]; 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN456"><span class='Ref_To_Local'>w</span></a> <span class='Operator'>+ </span><span class='Number'>1</span> <span class='Operator'>&LT; </span><a href="isolationtester.c.html#LN457"><span class='Ref_To_Local'>nwaiting</span></a><span class='Parentheses'>) 
</span>                        <a href="../../include/c.h.html#LN1057"><span class='Ref_to_Macro'>memmove</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="isolationtester.c.html#LN459"><span class='Ref_To_Local'>waiting</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN456"><span class='Ref_To_Local'>w</span></a><span class='Delimiter'>], </span><span class='Operator'>&</span><a href="isolationtester.c.html#LN459"><span class='Ref_To_Local'>waiting</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN456"><span class='Ref_To_Local'>w</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>], 
</span>                                <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN457"><span class='Ref_To_Local'>nwaiting</span></a> <span class='Operator'>- </span><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN456"><span class='Ref_To_Local'>w</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>))</span> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="isolationtester.h.html#LN28"><span class='Ref_to_Struct'>Step</span></a> <span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                    <a href="isolationtester.c.html#LN457"><span class='Ref_To_Local'>nwaiting</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* Report all errors together. */ 
</span>            <a href="isolationtester.c.html#LN409"><span class='Ref_to_Func'>report_multiple_error_messages</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN525"><span class='Ref_To_Local'>oldstep</span></a><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN458"><span class='Ref_To_Local'>nerrorstep</span></a><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN460"><span class='Ref_To_Local'>errorstep</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if oldstep!=NULL &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* Send the query for this step. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN401"><span class='Ref_to_Proto'>PQsendQuery</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN524"><span class='Ref_To_Local'>conn</span></a><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN523"><span class='Ref_To_Local'>step</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN32"><span class='Ref_to_Member'>sql</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stdout<span class='Delimiter'>, </span><span class='String'>"failed to send query for step %s: %s\n"</span><span class='Delimiter'>, 
</span>                    <a href="isolationtester.c.html#LN523"><span class='Ref_To_Local'>step</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN31"><span class='Ref_to_Member'>name</span></a><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN27"><span class='Ref_to_Global_Var'>conns</span></a><span class='Delimiter'>[</span><span class='Number'>1</span> <span class='Operator'>+ </span><a href="isolationtester.c.html#LN523"><span class='Ref_To_Local'>step</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN30"><span class='Ref_to_Member'>session</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="../examples/testlibpq.c.html#LN12"><span class='Ref_to_Func'>exit_nicely</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Try to complete this step without blocking.  */ 
</span>        <a href="isolationtester.c.html#LN526"><span class='Ref_To_Local'>mustwait</span></a> <span class='Operator'>= </span><a href="isolationtester.c.html#LN43"><span class='Ref_to_Proto'>try_complete_step</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN523"><span class='Ref_To_Local'>step</span></a><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN41"><span class='Ref_to_Const'>STEP_NONBLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Check for completion of any steps that were previously waiting. */ 
</span>        <a href="isolationtester.c.html#LN456"><span class='Ref_To_Local'>w</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="isolationtester.c.html#LN458"><span class='Ref_To_Local'>nerrorstep</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN456"><span class='Ref_To_Local'>w</span></a> <span class='Operator'>&LT; </span><a href="isolationtester.c.html#LN457"><span class='Ref_To_Local'>nwaiting</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN43"><span class='Ref_to_Proto'>try_complete_step</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN459"><span class='Ref_To_Local'>waiting</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN456"><span class='Ref_To_Local'>w</span></a><span class='Delimiter'>], </span><a href="isolationtester.c.html#LN41"><span class='Ref_to_Const'>STEP_NONBLOCK</span></a> <span class='Operator'>| </span><a href="isolationtester.c.html#LN42"><span class='Ref_to_Const'>STEP_RETRY</span></a><span class='Parentheses'>))</span> 
                <a href="isolationtester.c.html#LN456"><span class='Ref_To_Local'>w</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <a href="isolationtester.c.html#LN460"><span class='Ref_To_Local'>errorstep</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN458"><span class='Ref_To_Local'>nerrorstep</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="isolationtester.c.html#LN459"><span class='Ref_To_Local'>waiting</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN456"><span class='Ref_To_Local'>w</span></a><span class='Delimiter'>]; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN456"><span class='Ref_To_Local'>w</span></a> <span class='Operator'>+ </span><span class='Number'>1</span> <span class='Operator'>&LT; </span><a href="isolationtester.c.html#LN457"><span class='Ref_To_Local'>nwaiting</span></a><span class='Parentheses'>) 
</span>                    <a href="../../include/c.h.html#LN1057"><span class='Ref_to_Macro'>memmove</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="isolationtester.c.html#LN459"><span class='Ref_To_Local'>waiting</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN456"><span class='Ref_To_Local'>w</span></a><span class='Delimiter'>], </span><span class='Operator'>&</span><a href="isolationtester.c.html#LN459"><span class='Ref_To_Local'>waiting</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN456"><span class='Ref_To_Local'>w</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>], 
</span>                            <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN457"><span class='Ref_To_Local'>nwaiting</span></a> <span class='Operator'>- </span><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN456"><span class='Ref_To_Local'>w</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>))</span> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="isolationtester.h.html#LN28"><span class='Ref_to_Struct'>Step</span></a> <span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="isolationtester.c.html#LN457"><span class='Ref_To_Local'>nwaiting</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Report any error from this step, and any steps that it unblocked. */ 
</span>        <a href="isolationtester.c.html#LN409"><span class='Ref_to_Func'>report_multiple_error_messages</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN523"><span class='Ref_To_Local'>step</span></a><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN458"><span class='Ref_To_Local'>nerrorstep</span></a><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN460"><span class='Ref_To_Local'>errorstep</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* If this step is waiting, add it to the array of waiters. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN526"><span class='Ref_To_Local'>mustwait</span></a><span class='Parentheses'>) 
</span>            <a href="isolationtester.c.html#LN459"><span class='Ref_To_Local'>waiting</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN457"><span class='Ref_To_Local'>nwaiting</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="isolationtester.c.html#LN523"><span class='Ref_To_Local'>step</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;nsteps;i++ &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Wait for any remaining queries. */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN456"><span class='Ref_To_Local'>w</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN456"><span class='Ref_To_Local'>w</span></a> <span class='Operator'>&LT; </span><a href="isolationtester.c.html#LN457"><span class='Ref_To_Local'>nwaiting</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="isolationtester.c.html#LN456"><span class='Ref_To_Local'>w</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="isolationtester.c.html#LN43"><span class='Ref_to_Proto'>try_complete_step</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN459"><span class='Ref_To_Local'>waiting</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN456"><span class='Ref_To_Local'>w</span></a><span class='Delimiter'>], </span><a href="isolationtester.c.html#LN42"><span class='Ref_to_Const'>STEP_RETRY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="isolationtester.c.html#LN392"><span class='Ref_to_Func'>report_error_message</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN459"><span class='Ref_To_Local'>waiting</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN456"><span class='Ref_To_Local'>w</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Perform per-session teardown */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN455"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN455"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="isolationtester.c.html#LN452"><span class='Ref_to_Parameter'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN48"><span class='Ref_to_Member'>nsessions</span></a><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN455"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN452"><span class='Ref_to_Parameter'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN47"><span class='Ref_to_Member'>sessions</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN455"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN23"><span class='Ref_to_Member'>teardownsql</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="isolationtester.c.html#LN454"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN380"><span class='Ref_to_Proto'>PQexec</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN27"><span class='Ref_to_Global_Var'>conns</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN455"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>], </span><a href="isolationtester.c.html#LN452"><span class='Ref_to_Parameter'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN47"><span class='Ref_to_Member'>sessions</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN455"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN23"><span class='Ref_to_Member'>teardownsql</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN454"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN87"><span class='Ref_to_EnumConst'>PGRES_TUPLES_OK</span></a><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="isolationtester.c.html#LN48"><span class='Ref_to_Proto'>printResultSet</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN454"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN454"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN84"><span class='Ref_to_EnumConst'>PGRES_COMMAND_OK</span></a><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"teardown of session %s failed: %s"</span><span class='Delimiter'>, 
</span>                        <a href="isolationtester.c.html#LN452"><span class='Ref_to_Parameter'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN47"><span class='Ref_to_Member'>sessions</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN455"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN21"><span class='Ref_to_Member'>name</span></a><span class='Delimiter'>, 
</span>                        <a href="../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN27"><span class='Ref_to_Global_Var'>conns</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN455"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* don't exit on teardown failure */ 
</span>            <span class='Delimiter'>} 
</span>            <a href="../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN454"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Perform teardown */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN452"><span class='Ref_to_Parameter'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN46"><span class='Ref_to_Member'>teardownsql</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="isolationtester.c.html#LN454"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN380"><span class='Ref_to_Proto'>PQexec</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN27"><span class='Ref_to_Global_Var'>conns</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], </span><a href="isolationtester.c.html#LN452"><span class='Ref_to_Parameter'>testspec</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN46"><span class='Ref_to_Member'>teardownsql</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN454"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN87"><span class='Ref_to_EnumConst'>PGRES_TUPLES_OK</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="isolationtester.c.html#LN48"><span class='Ref_to_Proto'>printResultSet</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN454"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN454"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN84"><span class='Ref_to_EnumConst'>PGRES_COMMAND_OK</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"teardown failed: %s"</span><span class='Delimiter'>, 
</span>                    <a href="../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN27"><span class='Ref_to_Global_Var'>conns</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* don't exit on teardown failure */ 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN454"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN459"><span class='Ref_To_Local'>waiting</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN460"><span class='Ref_To_Local'>errorstep</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end run_permutation &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Our caller already sent the query associated with this step.  Wait for it 
 * to either complete or (if given the STEP_NONBLOCK flag) to block while 
 * waiting for a lock.  We assume that any lock wait will persist until we 
 * have executed additional steps in the permutation. 
 * 
 * When calling this function on behalf of a given step for a second or later 
 * time, pass the STEP_RETRY flag.  This only affects the messages printed. 
 * 
 * If the query returns an error, the message is saved in step-&GT;errormsg. 
 * Caller should call report_error_message shortly after this, to have it 
 * printed and cleared. 
 * 
 * If the STEP_NONBLOCK flag was specified and the query is waiting to acquire 
 * a lock, returns true.  Otherwise, returns false. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN693"></a><span class='Declare_Function'>try_complete_step</span><span class='Parentheses'>(</span><a href="isolationtester.h.html#LN28"><span class='Ref_to_Struct'>Step</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>step</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>flags</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN695"></a>    <a href="../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>conn</span> <span class='Operator'>= </span><a href="isolationtester.c.html#LN27"><span class='Ref_to_Global_Var'>conns</span></a><span class='Delimiter'>[</span><span class='Number'>1</span> <span class='Operator'>+ </span><a href="isolationtester.c.html#LN693"><span class='Ref_to_Parameter'>step</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN30"><span class='Ref_to_Member'>session</span></a><span class='Delimiter'>]; 
</span><a name="LN696"></a>    fd_set      <span class='Declare_Local'>read_set</span><span class='Delimiter'>; 
</span><a name="LN697"></a>    <span class='Control'>struct</span> timeval <span class='Declare_Local'>start_time</span><span class='Delimiter'>; 
</span><a name="LN698"></a>    <span class='Control'>struct</span> timeval <span class='Declare_Local'>timeout</span><span class='Delimiter'>; 
</span><a name="LN699"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>sock</span> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN324"><span class='Ref_to_Proto'>PQsocket</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN695"><span class='Ref_To_Local'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN700"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ret</span><span class='Delimiter'>; 
</span><a name="LN701"></a>    <a href="../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span><a name="LN702"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>canceled</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN699"><span class='Ref_To_Local'>sock</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"invalid socket: %s"</span><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN695"><span class='Ref_To_Local'>conn</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../examples/testlibpq.c.html#LN12"><span class='Ref_to_Func'>exit_nicely</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../port/gettimeofday.c.html#LN103"><span class='Ref_to_Func'>gettimeofday</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="isolationtester.c.html#LN697"><span class='Ref_To_Local'>start_time</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    FD_ZERO<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="isolationtester.c.html#LN696"><span class='Ref_To_Local'>read_set</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN424"><span class='Ref_to_Proto'>PQisBusy</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN695"><span class='Ref_To_Local'>conn</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        FD_SET<span class='Parentheses'>(</span><a href="isolationtester.c.html#LN699"><span class='Ref_To_Local'>sock</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="isolationtester.c.html#LN696"><span class='Ref_To_Local'>read_set</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="isolationtester.c.html#LN698"><span class='Ref_To_Local'>timeout</span></a><span class='Operator'>.</span>tv_sec <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="isolationtester.c.html#LN698"><span class='Ref_To_Local'>timeout</span></a><span class='Operator'>.</span>tv_usec <span class='Operator'>= </span><span class='Number'>10000</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* Check for lock waits every 10ms. */ 
</span> 
        <a href="isolationtester.c.html#LN700"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><a href="../../include/port/win32.h.html#LN373"><span class='Ref_to_Macro'>select</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN699"><span class='Ref_To_Local'>sock</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="isolationtester.c.html#LN696"><span class='Ref_To_Local'>read_set</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="isolationtester.c.html#LN698"><span class='Ref_To_Local'>timeout</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN700"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span>            <span class='Comment_Single_Line'>/* error in select() */ 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span><a href="../../interfaces/libpq/win32.h.html#LN17"><span class='Ref_to_Const'>EINTR</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"select failed: %s\n"</span><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="../examples/testlibpq.c.html#LN12"><span class='Ref_to_Func'>exit_nicely</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN700"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span>      <span class='Comment_Single_Line'>/* select() timeout: check for lock wait */ 
</span>        <span class='Delimiter'>{ 
</span><a name="LN729"></a>            <span class='Control'>struct</span> timeval <span class='Declare_Local'>current_time</span><span class='Delimiter'>; 
</span><a name="LN730"></a>            <a href="../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Local'>td</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* If it's OK for the step to block, check whether it has. */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN693"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>& </span><a href="isolationtester.c.html#LN41"><span class='Ref_to_Const'>STEP_NONBLOCK</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN735"></a>                <span class='Keyword'>bool</span>        <span class='Declare_Local'>waiting</span><span class='Delimiter'>; 
</span> 
                <a href="isolationtester.c.html#LN701"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN392"><span class='Ref_to_Proto'>PQexecPrepared</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN27"><span class='Ref_to_Global_Var'>conns</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], </span><a href="isolationtester.c.html#LN21"><span class='Ref_to_Const'>PREP_WAITING</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                                     <span class='Operator'>&</span><a href="isolationtester.c.html#LN28"><span class='Ref_to_Global_Var'>backend_pids</span></a><span class='Delimiter'>[</span><a href="isolationtester.c.html#LN693"><span class='Ref_to_Parameter'>step</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN30"><span class='Ref_to_Member'>session</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>], 
</span>                                     <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN701"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN87"><span class='Ref_to_EnumConst'>PGRES_TUPLES_OK</span></a> <span class='Operator'>|| 
</span>                    <a href="../../interfaces/libpq/libpq-fe.h.html#LN473"><span class='Ref_to_Proto'>PQntuples</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN701"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"lock wait query failed: %s"</span><span class='Delimiter'>, 
</span>                            <a href="../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN695"><span class='Ref_To_Local'>conn</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                    <a href="../examples/testlibpq.c.html#LN12"><span class='Ref_to_Func'>exit_nicely</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <a href="isolationtester.c.html#LN735"><span class='Ref_To_Local'>waiting</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN488"><span class='Ref_to_Proto'>PQgetvalue</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN701"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'t'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN701"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN735"><span class='Ref_To_Local'>waiting</span></a><span class='Parentheses'>)</span>    <span class='Comment_Single_Line'>/* waiting to acquire a lock */ 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN693"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>& </span><a href="isolationtester.c.html#LN42"><span class='Ref_to_Const'>STEP_RETRY</span></a><span class='Parentheses'>))</span> 
                        <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"step %s: %s &LT;waiting ...&GT;\n"</span><span class='Delimiter'>, 
</span>                               <a href="isolationtester.c.html#LN693"><span class='Ref_to_Parameter'>step</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN31"><span class='Ref_to_Member'>name</span></a><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN693"><span class='Ref_to_Parameter'>step</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN32"><span class='Ref_to_Member'>sql</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Comment_Multi_Line'>/* else, not waiting */ 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if flags&STEP_NONBLOCK &raquo; </span> 
 
            <span class='Comment_Multi_Line'>/* Figure out how long we've been waiting for this step. */ 
</span>            <a href="../../port/gettimeofday.c.html#LN103"><span class='Ref_to_Func'>gettimeofday</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="isolationtester.c.html#LN729"><span class='Ref_To_Local'>current_time</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="isolationtester.c.html#LN730"><span class='Ref_To_Local'>td</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a><span class='Parentheses'>) </span><a href="isolationtester.c.html#LN729"><span class='Ref_To_Local'>current_time</span></a><span class='Operator'>.</span>tv_sec <span class='Operator'>- </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a><span class='Parentheses'>) </span><a href="isolationtester.c.html#LN697"><span class='Ref_To_Local'>start_time</span></a><span class='Operator'>.</span>tv_sec<span class='Delimiter'>; 
</span>            <a href="isolationtester.c.html#LN730"><span class='Ref_To_Local'>td</span></a> <span class='Operator'>*= </span><a href="../../include/datatype/timestamp.h.html#LN93"><span class='Ref_to_Const'>USECS_PER_SEC</span></a><span class='Delimiter'>; 
</span>            <a href="isolationtester.c.html#LN730"><span class='Ref_To_Local'>td</span></a> <span class='Operator'>+= </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a><span class='Parentheses'>) </span><a href="isolationtester.c.html#LN729"><span class='Ref_To_Local'>current_time</span></a><span class='Operator'>.</span>tv_usec <span class='Operator'>- </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a><span class='Parentheses'>) </span><a href="isolationtester.c.html#LN697"><span class='Ref_To_Local'>start_time</span></a><span class='Operator'>.</span>tv_usec<span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * After 60 seconds, try to cancel the query. 
             * 
             * If the user tries to test an invalid permutation, we don't want 
             * to hang forever, especially when this is running in the 
             * buildfarm.  So try to cancel it after a minute.  This will 
             * presumably lead to this permutation failing, but remaining 
             * permutations and tests should still be OK. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN730"><span class='Ref_To_Local'>td</span></a> <span class='Operator'>&GT; </span><span class='Number'>60</span> <span class='Operator'>* </span><a href="../../include/datatype/timestamp.h.html#LN93"><span class='Ref_to_Const'>USECS_PER_SEC</span></a> <span class='Operator'>&& !</span><a href="isolationtester.c.html#LN702"><span class='Ref_To_Local'>canceled</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN777"></a>                <a href="../../interfaces/libpq/libpq-fe.h.html#LN152"><span class='Ref_to_Typedef'>PGcancel</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>cancel</span> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN298"><span class='Ref_to_Proto'>PQgetCancel</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN695"><span class='Ref_To_Local'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN777"><span class='Ref_To_Local'>cancel</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span><a name="LN781"></a>                    <span class='Keyword'>char</span>        <span class='Declare_Local'>buf</span><span class='Delimiter'>[</span><span class='Number'>256</span><span class='Delimiter'>]; 
</span> 
                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN304"><span class='Ref_to_Proto'>PQcancel</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN777"><span class='Ref_To_Local'>cancel</span></a><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN781"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN781"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)))</span> 
                        <a href="isolationtester.c.html#LN702"><span class='Ref_To_Local'>canceled</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                    <span class='Control'>else</span> 
                        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"PQcancel failed: %s\n"</span><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN781"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../interfaces/libpq/libpq-fe.h.html#LN301"><span class='Ref_to_Proto'>PQfreeCancel</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN777"><span class='Ref_To_Local'>cancel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * After 75 seconds, just give up and die. 
             * 
             * Since cleanup steps won't be run in this case, this may cause 
             * later tests to fail.  That stinks, but it's better than waiting 
             * forever for the server to respond to the cancel. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN730"><span class='Ref_To_Local'>td</span></a> <span class='Operator'>&GT; </span><span class='Number'>75</span> <span class='Operator'>* </span><a href="../../include/datatype/timestamp.h.html#LN93"><span class='Ref_to_Const'>USECS_PER_SEC</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"step %s timed out after 75 seconds\n"</span><span class='Delimiter'>, 
</span>                        <a href="isolationtester.c.html#LN693"><span class='Ref_to_Parameter'>step</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN31"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../examples/testlibpq.c.html#LN12"><span class='Ref_to_Func'>exit_nicely</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if ret==0 &raquo; </span> 
        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN425"><span class='Ref_to_Proto'>PQconsumeInput</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN695"><span class='Ref_To_Local'>conn</span></a><span class='Parentheses'>))</span> <span class='Comment_Single_Line'>/* select(): data available */ 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"PQconsumeInput failed: %s\n"</span><span class='Delimiter'>, 
</span>                    <a href="../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN695"><span class='Ref_To_Local'>conn</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="../examples/testlibpq.c.html#LN12"><span class='Ref_to_Func'>exit_nicely</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while PQisBusy(conn) &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN693"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>& </span><a href="isolationtester.c.html#LN42"><span class='Ref_to_Const'>STEP_RETRY</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"step %s: &LT;... completed&GT;\n"</span><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN693"><span class='Ref_to_Parameter'>step</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN31"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"step %s: %s\n"</span><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN693"><span class='Ref_to_Parameter'>step</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN31"><span class='Ref_to_Member'>name</span></a><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN693"><span class='Ref_to_Parameter'>step</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN32"><span class='Ref_to_Member'>sql</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="isolationtester.c.html#LN701"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN421"><span class='Ref_to_Proto'>PQgetResult</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN695"><span class='Ref_To_Local'>conn</span></a><span class='Parentheses'>)))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN701"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <a href="../../interfaces/libpq/libpq-fe.h.html#LN84"><span class='Ref_to_EnumConst'>PGRES_COMMAND_OK</span></a><span class='Operator'>: 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../interfaces/libpq/libpq-fe.h.html#LN87"><span class='Ref_to_EnumConst'>PGRES_TUPLES_OK</span></a><span class='Operator'>: 
</span>                <a href="isolationtester.c.html#LN48"><span class='Ref_to_Proto'>printResultSet</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN701"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../interfaces/libpq/libpq-fe.h.html#LN95"><span class='Ref_to_EnumConst'>PGRES_FATAL_ERROR</span></a><span class='Operator'>: 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN693"><span class='Ref_to_Parameter'>step</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN33"><span class='Ref_to_Member'>errormsg</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"WARNING: this step had a leftover error message\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"%s\n"</span><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN693"><span class='Ref_to_Parameter'>step</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN33"><span class='Ref_to_Member'>errormsg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * Detail may contain XID values, so we want to just show 
                 * primary.  Beware however that libpq-generated error results 
                 * may not contain subfields, only an old-style message. 
                 */ 
</span>                <span class='Delimiter'>{ 
</span><a name="LN840"></a>                    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>sev</span> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN472"><span class='Ref_to_Proto'>PQresultErrorField</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN701"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, 
</span>                                                         <a href="../../include/postgres_ext.h.html#LN54"><span class='Ref_to_Const'>PG_DIAG_SEVERITY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN842"></a>                    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>msg</span> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN472"><span class='Ref_to_Proto'>PQresultErrorField</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN701"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, 
</span>                                                    <a href="../../include/postgres_ext.h.html#LN57"><span class='Ref_to_Const'>PG_DIAG_MESSAGE_PRIMARY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN840"><span class='Ref_To_Local'>sev</span></a> <span class='Operator'>&& </span><a href="isolationtester.c.html#LN842"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>) 
</span>                        <a href="isolationtester.c.html#LN693"><span class='Ref_to_Parameter'>step</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN33"><span class='Ref_to_Member'>errormsg</span></a> <span class='Operator'>= </span><a href="../../common/psprintf.c.html#LN44"><span class='Ref_to_Func'>psprintf</span></a><span class='Parentheses'>(</span><span class='String'>"%s:  %s"</span><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN840"><span class='Ref_To_Local'>sev</span></a><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN842"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>else</span> 
                        <a href="isolationtester.c.html#LN693"><span class='Ref_to_Parameter'>step</span></a><span class='Operator'>-&GT;</span><a href="isolationtester.h.html#LN33"><span class='Ref_to_Member'>errormsg</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN24"><span class='Ref_to_Proto'>pg_strdup</span></a><span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN468"><span class='Ref_to_Proto'>PQresultErrorMessage</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN701"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>default</span><span class='Operator'>: 
</span>                <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"unexpected result status: %s\n"</span><span class='Delimiter'>, 
</span>                       <a href="../../interfaces/libpq/libpq-fe.h.html#LN467"><span class='Ref_to_Proto'>PQresStatus</span></a><span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN701"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch PQresultStatus(res) &raquo; </span> 
        <a href="../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN701"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (res=PQgetResult(conn... &raquo; </span> 
 
    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end try_complete_step &raquo; </span> 
 
<span class='Keyword'>static void 
</span><a name="LN862"></a><span class='Declare_Function'>printResultSet</span><span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>res</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN864"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nFields</span><span class='Delimiter'>; 
</span><a name="LN865"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN866"></a>                <span class='Declare_Local'>j</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* first, print out the attribute names */ 
</span>    <a href="isolationtester.c.html#LN864"><span class='Ref_To_Local'>nFields</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN474"><span class='Ref_to_Proto'>PQnfields</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN862"><span class='Ref_to_Parameter'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN865"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN865"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="isolationtester.c.html#LN864"><span class='Ref_To_Local'>nFields</span></a><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN865"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"%-15s"</span><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN476"><span class='Ref_to_Proto'>PQfname</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN862"><span class='Ref_to_Parameter'>res</span></a><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN865"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"\n\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* next, print out the rows */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN865"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN865"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN473"><span class='Ref_to_Proto'>PQntuples</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN862"><span class='Ref_to_Parameter'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN865"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="isolationtester.c.html#LN866"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN866"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><a href="isolationtester.c.html#LN864"><span class='Ref_To_Local'>nFields</span></a><span class='Delimiter'>; </span><a href="isolationtester.c.html#LN866"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"%-15s"</span><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN488"><span class='Ref_to_Proto'>PQgetvalue</span></a><span class='Parentheses'>(</span><a href="isolationtester.c.html#LN862"><span class='Ref_to_Parameter'>res</span></a><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN865"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><a href="isolationtester.c.html#LN866"><span class='Ref_To_Local'>j</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end printResultSet &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>