<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\timezone\pgtz.c</title>
<LINK REL=StyleSheet HREF="../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\timezone\pgtz.c</b></p></td>
<td align='right'>
Wed Jun 14 08:26:15 2017
</td></tr>
<tr><td><a href='../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * pgtz.c 
 *    Timezone Library Integration Functions 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * 
 * IDENTIFICATION 
 *    src/timezone/pgtz.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;ctype.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;fcntl.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/stat.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;time.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"datatype/timestamp.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pgtz.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/fd.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/hsearch.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* Current session timezone (controlled by TimeZone GUC) */ 
</span><a name="LN27"></a><a href="pgtz.h.html#LN58"><span class='Ref_to_Struct'>pg_tz</span></a>      <span class='Operator'>*</span><span class='Declare_Var'>session_timezone</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Current log timezone (controlled by log_timezone GUC) */ 
</span><a name="LN30"></a><a href="pgtz.h.html#LN58"><span class='Ref_to_Struct'>pg_tz</span></a>      <span class='Operator'>*</span><span class='Declare_Var'>log_timezone</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
 
<a name="LN33"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>scan_directory_ci</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dirname</span><span class='Delimiter'>, 
</span><a name="LN34"></a>                  <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>fname</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>fnamelen</span><span class='Delimiter'>, 
</span><a name="LN35"></a>                  <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>canonname</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>canonnamelen</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Return full pathname of timezone data directory 
 */ 
</span><span class='Keyword'>static const char </span><span class='Operator'>* 
</span><a name="LN42"></a><span class='Declare_Function'>pg_TZDIR</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifndef</span> SYSTEMTZDIR 
    <span class='Comment_Multi_Line'>/* normal case: timezone stuff is under our share dir */ 
</span><a name="LN46"></a>    <span class='Keyword'>static bool </span><span class='Declare_Local'>done_tzdir</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN47"></a>    <span class='Keyword'>static char </span><span class='Declare_Local'>tzdir</span><span class='Delimiter'>[</span><a href="../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgtz.c.html#LN46"><span class='Ref_To_Local'>done_tzdir</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="pgtz.c.html#LN47"><span class='Ref_To_Local'>tzdir</span></a><span class='Delimiter'>; 
</span> 
    <a href="../include/port.h.html#LN50"><span class='Ref_to_Proto'>get_share_path</span></a><span class='Parentheses'>(</span><a href="../backend/utils/init/globals.c.html#LN63"><span class='Ref_to_Global_Var'>my_exec_path</span></a><span class='Delimiter'>, </span><a href="pgtz.c.html#LN47"><span class='Ref_To_Local'>tzdir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN47"><span class='Ref_To_Local'>tzdir</span></a> <span class='Operator'>+ </span>strlen<span class='Parentheses'>(</span><a href="pgtz.c.html#LN47"><span class='Ref_To_Local'>tzdir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"/timezone"</span><span class='Delimiter'>, </span><a href="../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a> <span class='Operator'>- </span>strlen<span class='Parentheses'>(</span><a href="pgtz.c.html#LN47"><span class='Ref_To_Local'>tzdir</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="pgtz.c.html#LN46"><span class='Ref_To_Local'>done_tzdir</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="pgtz.c.html#LN47"><span class='Ref_To_Local'>tzdir</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
    <span class='Comment_Multi_Line'>/* we're configured to use system's timezone database */ 
</span>    <span class='Control'>return</span> SYSTEMTZDIR<span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end pg_TZDIR &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Given a timezone name, open() the timezone data file.  Return the 
 * file descriptor if successful, -1 if not. 
 * 
 * The input name is searched for case-insensitively (we assume that the 
 * timezone database does not contain case-equivalent names). 
 * 
 * If "canonname" is not NULL, then on success the canonical spelling of the 
 * given name is stored there (the buffer must be &GT; TZ_STRLEN_MAX bytes!). 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN75"></a><span class='Declare_Function'>pg_open_tzfile</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>canonname</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN77"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>fname</span><span class='Delimiter'>; 
</span><a name="LN78"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>fullname</span><span class='Delimiter'>[</span><a href="../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN79"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>fullnamelen</span><span class='Delimiter'>; 
</span><a name="LN80"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>orignamelen</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize fullname with base name of tzdata directory */ 
</span>    <a href="../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN78"><span class='Ref_To_Local'>fullname</span></a><span class='Delimiter'>, </span><a href="../bin/initdb/findtimezone.c.html#LN34"><span class='Ref_to_Func'>pg_TZDIR</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgtz.c.html#LN78"><span class='Ref_To_Local'>fullname</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="pgtz.c.html#LN80"><span class='Ref_To_Local'>orignamelen</span></a> <span class='Operator'>= </span><a href="pgtz.c.html#LN79"><span class='Ref_To_Local'>fullnamelen</span></a> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="pgtz.c.html#LN78"><span class='Ref_To_Local'>fullname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgtz.c.html#LN79"><span class='Ref_To_Local'>fullnamelen</span></a> <span class='Operator'>+ </span><span class='Number'>1</span> <span class='Operator'>+ </span>strlen<span class='Parentheses'>(</span><a href="pgtz.c.html#LN75"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><a href="../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>;</span>              <span class='Comment_Single_Line'>/* not gonna fit */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the caller doesn't need the canonical spelling, first just try to 
     * open the name as-is.  This can be expected to succeed if the given name 
     * is already case-correct, or if the filesystem is case-insensitive; and 
     * we don't need to distinguish those situations if we aren't tasked with 
     * reporting the canonical spelling. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgtz.c.html#LN75"><span class='Ref_to_Parameter'>canonname</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN98"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
        <a href="pgtz.c.html#LN78"><span class='Ref_To_Local'>fullname</span></a><span class='Delimiter'>[</span><a href="pgtz.c.html#LN79"><span class='Ref_To_Local'>fullnamelen</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'/'</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* test above ensured this will fit: */ 
</span>        <a href="../../contrib/cube/cubeparse.y.html#LN150"><span class='Ref_to_Proto'>strcpy</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN78"><span class='Ref_To_Local'>fullname</span></a> <span class='Operator'>+ </span><a href="pgtz.c.html#LN79"><span class='Ref_To_Local'>fullnamelen</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="pgtz.c.html#LN75"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pgtz.c.html#LN98"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../include/port.h.html#LN289"><span class='Ref_to_Macro'>open</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN78"><span class='Ref_To_Local'>fullname</span></a><span class='Delimiter'>, </span>O_RDONLY <span class='Operator'>| </span><a href="../include/c.h.html#LN1032"><span class='Ref_to_Const'>PG_BINARY</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgtz.c.html#LN98"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <a href="pgtz.c.html#LN98"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* If that didn't work, fall through to do it the hard way */ 
</span>        <a href="pgtz.c.html#LN78"><span class='Ref_To_Local'>fullname</span></a><span class='Delimiter'>[</span><a href="pgtz.c.html#LN79"><span class='Ref_To_Local'>fullnamelen</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Loop to split the given name into directory levels; for each level, 
     * search using scan_directory_ci(). 
     */ 
</span>    <a href="pgtz.c.html#LN77"><span class='Ref_To_Local'>fname</span></a> <span class='Operator'>= </span><a href="pgtz.c.html#LN75"><span class='Ref_to_Parameter'>name</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN117"></a>        <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>slashptr</span><span class='Delimiter'>; 
</span><a name="LN118"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>fnamelen</span><span class='Delimiter'>; 
</span> 
        <a href="pgtz.c.html#LN117"><span class='Ref_To_Local'>slashptr</span></a> <span class='Operator'>= </span>strchr<span class='Parentheses'>(</span><a href="pgtz.c.html#LN77"><span class='Ref_To_Local'>fname</span></a><span class='Delimiter'>, </span><span class='String'>'/'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgtz.c.html#LN117"><span class='Ref_To_Local'>slashptr</span></a><span class='Parentheses'>) 
</span>            <a href="pgtz.c.html#LN118"><span class='Ref_To_Local'>fnamelen</span></a> <span class='Operator'>= </span><a href="pgtz.c.html#LN117"><span class='Ref_To_Local'>slashptr</span></a> <span class='Operator'>- </span><a href="pgtz.c.html#LN77"><span class='Ref_To_Local'>fname</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="pgtz.c.html#LN118"><span class='Ref_To_Local'>fnamelen</span></a> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="pgtz.c.html#LN77"><span class='Ref_To_Local'>fname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgtz.c.html#LN33"><span class='Ref_to_Proto'>scan_directory_ci</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN78"><span class='Ref_To_Local'>fullname</span></a><span class='Delimiter'>, </span><a href="pgtz.c.html#LN77"><span class='Ref_To_Local'>fname</span></a><span class='Delimiter'>, </span><a href="pgtz.c.html#LN118"><span class='Ref_To_Local'>fnamelen</span></a><span class='Delimiter'>, 
</span>                               <a href="pgtz.c.html#LN78"><span class='Ref_To_Local'>fullname</span></a> <span class='Operator'>+ </span><a href="pgtz.c.html#LN79"><span class='Ref_To_Local'>fullnamelen</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                               <a href="../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a> <span class='Operator'>- </span><a href="pgtz.c.html#LN79"><span class='Ref_To_Local'>fullnamelen</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <a href="pgtz.c.html#LN78"><span class='Ref_To_Local'>fullname</span></a><span class='Delimiter'>[</span><a href="pgtz.c.html#LN79"><span class='Ref_To_Local'>fullnamelen</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'/'</span><span class='Delimiter'>; 
</span>        <a href="pgtz.c.html#LN79"><span class='Ref_To_Local'>fullnamelen</span></a> <span class='Operator'>+= </span>strlen<span class='Parentheses'>(</span><a href="pgtz.c.html#LN78"><span class='Ref_To_Local'>fullname</span></a> <span class='Operator'>+ </span><a href="pgtz.c.html#LN79"><span class='Ref_To_Local'>fullnamelen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgtz.c.html#LN117"><span class='Ref_To_Local'>slashptr</span></a><span class='Parentheses'>) 
</span>            <a href="pgtz.c.html#LN77"><span class='Ref_To_Local'>fname</span></a> <span class='Operator'>= </span><a href="pgtz.c.html#LN117"><span class='Ref_To_Local'>slashptr</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgtz.c.html#LN75"><span class='Ref_to_Parameter'>canonname</span></a><span class='Parentheses'>) 
</span>        <a href="../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN75"><span class='Ref_to_Parameter'>canonname</span></a><span class='Delimiter'>, </span><a href="pgtz.c.html#LN78"><span class='Ref_To_Local'>fullname</span></a> <span class='Operator'>+ </span><a href="pgtz.c.html#LN80"><span class='Ref_To_Local'>orignamelen</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="../include/pgtime.h.html#LN43"><span class='Ref_to_Const'>TZ_STRLEN_MAX</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../include/port.h.html#LN289"><span class='Ref_to_Macro'>open</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN78"><span class='Ref_To_Local'>fullname</span></a><span class='Delimiter'>, </span>O_RDONLY <span class='Operator'>| </span><a href="../include/c.h.html#LN1032"><span class='Ref_to_Const'>PG_BINARY</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pg_open_tzfile &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Scan specified directory for a case-insensitive match to fname 
 * (of length fnamelen --- fname may not be null terminated!).  If found, 
 * copy the actual filename into canonname and return true. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN150"></a><span class='Declare_Function'>scan_directory_ci</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dirname</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>fname</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>fnamelen</span><span class='Delimiter'>, 
</span><a name="LN151"></a>                  <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>canonname</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>canonnamelen</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN153"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN154"></a>    <a href="../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>dirdesc</span><span class='Delimiter'>; 
</span><a name="LN155"></a>    <span class='Control'>struct</span> <a href="../include/port/win32_msvc/dirent.h.html#LN8"><span class='Ref_to_Struct'>dirent</span></a> <span class='Operator'>*</span><span class='Declare_Local'>direntry</span><span class='Delimiter'>; 
</span> 
    <a href="pgtz.c.html#LN154"><span class='Ref_To_Local'>dirdesc</span></a> <span class='Operator'>= </span><a href="../include/storage/fd.h.html#LN91"><span class='Ref_to_Proto'>AllocateDir</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN150"><span class='Ref_to_Parameter'>dirname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgtz.c.html#LN154"><span class='Ref_To_Local'>dirdesc</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open directory \"%s\": %m"</span><span class='Delimiter'>, </span><a href="pgtz.c.html#LN150"><span class='Ref_to_Parameter'>dirname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="pgtz.c.html#LN155"><span class='Ref_To_Local'>direntry</span></a> <span class='Operator'>= </span><a href="../include/storage/fd.h.html#LN92"><span class='Ref_to_Proto'>ReadDir</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN154"><span class='Ref_To_Local'>dirdesc</span></a><span class='Delimiter'>, </span><a href="pgtz.c.html#LN150"><span class='Ref_to_Parameter'>dirname</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Ignore . and .., plus any other "hidden" files.  This is a security 
         * measure to prevent access to files outside the timezone directory. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgtz.c.html#LN155"><span class='Ref_To_Local'>direntry</span></a><span class='Operator'>-&GT;</span><a href="../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'.'</span><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="pgtz.c.html#LN155"><span class='Ref_To_Local'>direntry</span></a><span class='Operator'>-&GT;</span><a href="../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="pgtz.c.html#LN150"><span class='Ref_to_Parameter'>fnamelen</span></a> <span class='Operator'>&& 
</span>            <a href="../port/pgstrcasecmp.c.html#LN67"><span class='Ref_to_Func'>pg_strncasecmp</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN155"><span class='Ref_To_Local'>direntry</span></a><span class='Operator'>-&GT;</span><a href="../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><a href="pgtz.c.html#LN150"><span class='Ref_to_Parameter'>fname</span></a><span class='Delimiter'>, </span><a href="pgtz.c.html#LN150"><span class='Ref_to_Parameter'>fnamelen</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Found our match */ 
</span>            <a href="../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN151"><span class='Ref_to_Parameter'>canonname</span></a><span class='Delimiter'>, </span><a href="pgtz.c.html#LN155"><span class='Ref_To_Local'>direntry</span></a><span class='Operator'>-&GT;</span><a href="../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><a href="pgtz.c.html#LN151"><span class='Ref_to_Parameter'>canonnamelen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pgtz.c.html#LN153"><span class='Ref_To_Local'>found</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../include/storage/fd.h.html#LN93"><span class='Ref_to_Proto'>FreeDir</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN154"><span class='Ref_To_Local'>dirdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="pgtz.c.html#LN153"><span class='Ref_To_Local'>found</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end scan_directory_ci &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * We keep loaded timezones in a hashtable so we don't have to 
 * load and parse the TZ definition file every time one is selected. 
 * Because we want timezone names to be found case-insensitively, 
 * the hash key is the uppercased name of the zone. 
 */ 
</span><span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* tznameupper contains the all-upper-case name of the timezone */ 
</span><a name="LN200"></a>    <span class='Keyword'>char</span>        <span class='Declare_Member'>tznameupper</span><span class='Delimiter'>[</span><a href="../include/pgtime.h.html#LN43"><span class='Ref_to_Const'>TZ_STRLEN_MAX</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN201"></a>    <a href="pgtz.h.html#LN58"><span class='Ref_to_Struct'>pg_tz</span></a>       <span class='Declare_Member'>tz</span><span class='Delimiter'>; 
</span><a name="LN202"></a>} <span class='Declare_Typedef'>pg_tz_cache</span><span class='Delimiter'>; 
</span> 
<a name="LN204"></a><span class='Keyword'>static </span><a href="../backend/utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Var'>timezone_cache</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
 
<span class='Keyword'>static bool 
</span><a name="LN208"></a><span class='Declare_Function'>init_timezone_hashtable</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN210"></a>    <a href="../include/utils/hsearch.h.html#LN64"><span class='Ref_to_Struct'>HASHCTL</span></a>     <span class='Declare_Local'>hash_ctl</span><span class='Delimiter'>; 
</span> 
    <a href="../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgtz.c.html#LN210"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgtz.c.html#LN210"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="pgtz.c.html#LN210"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><a href="../include/pgtime.h.html#LN43"><span class='Ref_to_Const'>TZ_STRLEN_MAX</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="pgtz.c.html#LN210"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgtz.c.html#LN197"><span class='Ref_to_Typedef'>pg_tz_cache</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pgtz.c.html#LN204"><span class='Ref_to_Global_Var'>timezone_cache</span></a> <span class='Operator'>= </span><a href="../include/utils/hsearch.h.html#LN121"><span class='Ref_to_Proto'>hash_create</span></a><span class='Parentheses'>(</span><span class='String'>"Timezones"</span><span class='Delimiter'>, 
</span>                                 <span class='Number'>4</span><span class='Delimiter'>, 
</span>                                 <span class='Operator'>&</span><a href="pgtz.c.html#LN210"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Delimiter'>, 
</span>                                 <a href="../include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgtz.c.html#LN204"><span class='Ref_to_Global_Var'>timezone_cache</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Load a timezone from file or from cache. 
 * Does not verify that the timezone is acceptable! 
 * 
 * "GMT" is always interpreted as the tzparse() definition, without attempting 
 * to load a definition from the filesystem.  This has a number of benefits: 
 * 1. It's guaranteed to succeed, so we don't have the failure mode wherein 
 * the bootstrap default timezone setting doesn't work (as could happen if 
 * the OS attempts to supply a leap-second-aware version of "GMT"). 
 * 2. Because we aren't accessing the filesystem, we can safely initialize 
 * the "GMT" zone definition before my_exec_path is known. 
 * 3. It's quick enough that we don't waste much time when the bootstrap 
 * default timezone setting is later overridden from postgresql.conf. 
 */ 
</span><a href="pgtz.h.html#LN58"><span class='Ref_to_Struct'>pg_tz</span></a> <span class='Operator'>* 
</span><a name="LN242"></a><span class='Declare_Function'>pg_tzset</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN244"></a>    <a href="pgtz.c.html#LN197"><span class='Ref_to_Typedef'>pg_tz_cache</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tzp</span><span class='Delimiter'>; 
</span><a name="LN245"></a>    <span class='Control'>struct</span> <a href="pgtz.h.html#LN40"><span class='Ref_to_Struct'>state</span></a> <span class='Declare_Local'>tzstate</span><span class='Delimiter'>; 
</span><a name="LN246"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>uppername</span><span class='Delimiter'>[</span><a href="../include/pgtime.h.html#LN43"><span class='Ref_to_Const'>TZ_STRLEN_MAX</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN247"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>canonname</span><span class='Delimiter'>[</span><a href="../include/pgtime.h.html#LN43"><span class='Ref_to_Const'>TZ_STRLEN_MAX</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN248"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>p</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="pgtz.c.html#LN242"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><a href="../include/pgtime.h.html#LN43"><span class='Ref_to_Const'>TZ_STRLEN_MAX</span></a><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* not going to fit */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgtz.c.html#LN204"><span class='Ref_to_Global_Var'>timezone_cache</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgtz.c.html#LN207"><span class='Ref_to_Func'>init_timezone_hashtable</span></a><span class='Parentheses'>())</span> 
            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Upcase the given name to perform a case-insensitive hashtable search. 
     * (We could alternatively downcase it, but we prefer upcase so that we 
     * can get consistently upcased results from tzparse() in case the name is 
     * a POSIX-style timezone spec.) 
     */ 
</span>    <a href="pgtz.c.html#LN248"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>= </span><a href="pgtz.c.html#LN246"><span class='Ref_To_Local'>uppername</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="pgtz.c.html#LN242"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>*</span><a href="pgtz.c.html#LN248"><span class='Ref_To_Local'>p</span></a><span class='Operator'>++ = </span><a href="../port/pgstrcasecmp.c.html#LN103"><span class='Ref_to_Func'>pg_toupper</span></a><span class='Parentheses'>((</span><span class='Keyword'>unsigned char</span><span class='Parentheses'>) </span><span class='Operator'>*</span><a href="pgtz.c.html#LN242"><span class='Ref_to_Parameter'>name</span></a><span class='Operator'>++</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="pgtz.c.html#LN248"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span> 
    <a href="pgtz.c.html#LN244"><span class='Ref_To_Local'>tzp</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pgtz.c.html#LN197"><span class='Ref_to_Typedef'>pg_tz_cache</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN204"><span class='Ref_to_Global_Var'>timezone_cache</span></a><span class='Delimiter'>, 
</span>                                      <a href="pgtz.c.html#LN246"><span class='Ref_To_Local'>uppername</span></a><span class='Delimiter'>, 
</span>                                      <a href="../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, 
</span>                                      <span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgtz.c.html#LN244"><span class='Ref_To_Local'>tzp</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Timezone found in cache, nothing more to do */ 
</span>        <span class='Control'>return</span> <span class='Operator'>&</span><a href="pgtz.c.html#LN244"><span class='Ref_To_Local'>tzp</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN201"><span class='Ref_to_Member'>tz</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * "GMT" is always sent to tzparse(), as per discussion above. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="pgtz.c.html#LN246"><span class='Ref_To_Local'>uppername</span></a><span class='Delimiter'>, </span><span class='String'>"GMT"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgtz.h.html#LN72"><span class='Ref_to_Proto'>tzparse</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN246"><span class='Ref_To_Local'>uppername</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgtz.c.html#LN245"><span class='Ref_To_Local'>tzstate</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* This really, really should not happen ... */ 
</span>            <a href="../backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not initialize GMT time zone"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Comment_Multi_Line'>/* Use uppercase name as canonical */ 
</span>        <a href="../../contrib/cube/cubeparse.y.html#LN150"><span class='Ref_to_Proto'>strcpy</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN247"><span class='Ref_To_Local'>canonname</span></a><span class='Delimiter'>, </span><a href="pgtz.c.html#LN246"><span class='Ref_To_Local'>uppername</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgtz.h.html#LN70"><span class='Ref_to_Proto'>tzload</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN246"><span class='Ref_To_Local'>uppername</span></a><span class='Delimiter'>, </span><a href="pgtz.c.html#LN247"><span class='Ref_To_Local'>canonname</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgtz.c.html#LN245"><span class='Ref_To_Local'>tzstate</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgtz.c.html#LN246"><span class='Ref_To_Local'>uppername</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>':'</span> <span class='Operator'>|| !</span><a href="pgtz.h.html#LN72"><span class='Ref_to_Proto'>tzparse</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN246"><span class='Ref_To_Local'>uppername</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgtz.c.html#LN245"><span class='Ref_To_Local'>tzstate</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Unknown timezone. Fail our call instead of loading GMT! */ 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Comment_Multi_Line'>/* For POSIX timezone specs, use uppercase name as canonical */ 
</span>        <a href="../../contrib/cube/cubeparse.y.html#LN150"><span class='Ref_to_Proto'>strcpy</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN247"><span class='Ref_To_Local'>canonname</span></a><span class='Delimiter'>, </span><a href="pgtz.c.html#LN246"><span class='Ref_To_Local'>uppername</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Save timezone in the cache */ 
</span>    <a href="pgtz.c.html#LN244"><span class='Ref_To_Local'>tzp</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pgtz.c.html#LN197"><span class='Ref_to_Typedef'>pg_tz_cache</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN204"><span class='Ref_to_Global_Var'>timezone_cache</span></a><span class='Delimiter'>, 
</span>                                      <a href="pgtz.c.html#LN246"><span class='Ref_To_Local'>uppername</span></a><span class='Delimiter'>, 
</span>                                      <a href="../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a><span class='Delimiter'>, 
</span>                                      <span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* hash_search already copied uppername into the hash key */ 
</span>    <a href="../../contrib/cube/cubeparse.y.html#LN150"><span class='Ref_to_Proto'>strcpy</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN244"><span class='Ref_To_Local'>tzp</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN201"><span class='Ref_to_Member'>tz</span></a><span class='Operator'>.</span><a href="pgtz.h.html#LN61"><span class='Ref_to_Member'>TZname</span></a><span class='Delimiter'>, </span><a href="pgtz.c.html#LN247"><span class='Ref_To_Local'>canonname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgtz.c.html#LN244"><span class='Ref_To_Local'>tzp</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN201"><span class='Ref_to_Member'>tz</span></a><span class='Operator'>.</span><a href="pgtz.h.html#LN62"><span class='Ref_to_Member'>state</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgtz.c.html#LN245"><span class='Ref_To_Local'>tzstate</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgtz.c.html#LN245"><span class='Ref_To_Local'>tzstate</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Operator'>&</span><a href="pgtz.c.html#LN244"><span class='Ref_To_Local'>tzp</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN201"><span class='Ref_to_Member'>tz</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pg_tzset &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Load a fixed-GMT-offset timezone. 
 * This is used for SQL-spec SET TIME ZONE INTERVAL 'foo' cases. 
 * It's otherwise equivalent to pg_tzset(). 
 * 
 * The GMT offset is specified in seconds, positive values meaning west of 
 * Greenwich (ie, POSIX not ISO sign convention).  However, we use ISO 
 * sign convention in the displayable abbreviation for the zone. 
 * 
 * Caution: this can fail (return NULL) if the specified offset is outside 
 * the range allowed by the zic library. 
 */ 
</span><a href="pgtz.h.html#LN58"><span class='Ref_to_Struct'>pg_tz</span></a> <span class='Operator'>* 
</span><a name="LN328"></a><span class='Declare_Function'>pg_tzset_offset</span><span class='Parentheses'>(</span><span class='Keyword'>long </span><span class='Declare_Parameter'>gmtoffset</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN330"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>absoffset</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pgtz.c.html#LN328"><span class='Ref_to_Parameter'>gmtoffset</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>? -</span><a href="pgtz.c.html#LN328"><span class='Ref_to_Parameter'>gmtoffset</span></a> <span class='Operator'>: </span><a href="pgtz.c.html#LN328"><span class='Ref_to_Parameter'>gmtoffset</span></a><span class='Delimiter'>; 
</span><a name="LN331"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>offsetstr</span><span class='Delimiter'>[</span><span class='Number'>64</span><span class='Delimiter'>]; 
</span><a name="LN332"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>tzname</span><span class='Delimiter'>[</span><span class='Number'>128</span><span class='Delimiter'>]; 
</span> 
    <a href="../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN331"><span class='Ref_To_Local'>offsetstr</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgtz.c.html#LN331"><span class='Ref_To_Local'>offsetstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <span class='String'>"%02ld"</span><span class='Delimiter'>, </span><a href="pgtz.c.html#LN330"><span class='Ref_To_Local'>absoffset</span></a> <span class='Operator'>/ </span><a href="../include/datatype/timestamp.h.html#LN86"><span class='Ref_to_Const'>SECS_PER_HOUR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgtz.c.html#LN330"><span class='Ref_To_Local'>absoffset</span></a> <span class='Operator'>%= </span><a href="../include/datatype/timestamp.h.html#LN86"><span class='Ref_to_Const'>SECS_PER_HOUR</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgtz.c.html#LN330"><span class='Ref_To_Local'>absoffset</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN331"><span class='Ref_To_Local'>offsetstr</span></a> <span class='Operator'>+ </span>strlen<span class='Parentheses'>(</span><a href="pgtz.c.html#LN331"><span class='Ref_To_Local'>offsetstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgtz.c.html#LN331"><span class='Ref_To_Local'>offsetstr</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span>strlen<span class='Parentheses'>(</span><a href="pgtz.c.html#LN331"><span class='Ref_To_Local'>offsetstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <span class='String'>":%02ld"</span><span class='Delimiter'>, </span><a href="pgtz.c.html#LN330"><span class='Ref_To_Local'>absoffset</span></a> <span class='Operator'>/ </span><a href="../include/datatype/timestamp.h.html#LN87"><span class='Ref_to_Const'>SECS_PER_MINUTE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pgtz.c.html#LN330"><span class='Ref_To_Local'>absoffset</span></a> <span class='Operator'>%= </span><a href="../include/datatype/timestamp.h.html#LN87"><span class='Ref_to_Const'>SECS_PER_MINUTE</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgtz.c.html#LN330"><span class='Ref_To_Local'>absoffset</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN331"><span class='Ref_To_Local'>offsetstr</span></a> <span class='Operator'>+ </span>strlen<span class='Parentheses'>(</span><a href="pgtz.c.html#LN331"><span class='Ref_To_Local'>offsetstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgtz.c.html#LN331"><span class='Ref_To_Local'>offsetstr</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span>strlen<span class='Parentheses'>(</span><a href="pgtz.c.html#LN331"><span class='Ref_To_Local'>offsetstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <span class='String'>":%02ld"</span><span class='Delimiter'>, </span><a href="pgtz.c.html#LN330"><span class='Ref_To_Local'>absoffset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgtz.c.html#LN328"><span class='Ref_to_Parameter'>gmtoffset</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN332"><span class='Ref_To_Local'>tzname</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgtz.c.html#LN332"><span class='Ref_To_Local'>tzname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"&LT;-%s&GT;+%s"</span><span class='Delimiter'>, 
</span>                 <a href="pgtz.c.html#LN331"><span class='Ref_To_Local'>offsetstr</span></a><span class='Delimiter'>, </span><a href="pgtz.c.html#LN331"><span class='Ref_To_Local'>offsetstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN332"><span class='Ref_To_Local'>tzname</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgtz.c.html#LN332"><span class='Ref_To_Local'>tzname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"&LT;+%s&GT;-%s"</span><span class='Delimiter'>, 
</span>                 <a href="pgtz.c.html#LN331"><span class='Ref_To_Local'>offsetstr</span></a><span class='Delimiter'>, </span><a href="pgtz.c.html#LN331"><span class='Ref_To_Local'>offsetstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../include/pgtime.h.html#LN76"><span class='Ref_to_Proto'>pg_tzset</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN332"><span class='Ref_To_Local'>tzname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pg_tzset_offset &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Initialize timezone library 
 * 
 * This is called before GUC variable initialization begins.  Its purpose 
 * is to ensure that log_timezone has a valid value before any logging GUC 
 * variables could become set to values that require elog.c to provide 
 * timestamps (e.g., log_line_prefix).  We may as well initialize 
 * session_timestamp to something valid, too. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN369"></a><span class='Declare_Function'>pg_timezone_initialize</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * We may not yet know where PGSHAREDIR is (in particular this is true in 
     * an EXEC_BACKEND subprocess).  So use "GMT", which pg_tzset forces to be 
     * interpreted without reference to the filesystem.  This corresponds to 
     * the bootstrap default for these variables in guc.c, although in 
     * principle it could be different. 
     */ 
</span>    <a href="pgtz.c.html#LN27"><span class='Ref_to_Global_Var'>session_timezone</span></a> <span class='Operator'>= </span><a href="../include/pgtime.h.html#LN76"><span class='Ref_to_Proto'>pg_tzset</span></a><span class='Parentheses'>(</span><span class='String'>"GMT"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgtz.c.html#LN30"><span class='Ref_to_Global_Var'>log_timezone</span></a> <span class='Operator'>= </span><a href="pgtz.c.html#LN27"><span class='Ref_to_Global_Var'>session_timezone</span></a><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Functions to enumerate available timezones 
 * 
 * Note that pg_tzenumerate_next() will return a pointer into the pg_tzenum 
 * structure, so the data is only valid up to the next call. 
 * 
 * All data is allocated using palloc in the current context. 
 */ 
</span><a name="LN391"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MAX_TZDIR_DEPTH</span> <span class='Number'>10</span> 
 
<a name="LN393"></a><span class='Control'>struct</span> <span class='Declare_Struct'>pg_tzenum</span> 
<span class='Delimiter'>{ 
</span><a name="LN395"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>baselen</span><span class='Delimiter'>; 
</span><a name="LN396"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>depth</span><span class='Delimiter'>; 
</span><a name="LN397"></a>    <a href="../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a>        <span class='Operator'>*</span><span class='Declare_Member'>dirdesc</span><span class='Delimiter'>[</span><a href="pgtz.c.html#LN391"><span class='Ref_to_Const'>MAX_TZDIR_DEPTH</span></a><span class='Delimiter'>]; 
</span><a name="LN398"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Member'>dirname</span><span class='Delimiter'>[</span><a href="pgtz.c.html#LN391"><span class='Ref_to_Const'>MAX_TZDIR_DEPTH</span></a><span class='Delimiter'>]; 
</span><a name="LN399"></a>    <span class='Control'>struct</span> <a href="pgtz.h.html#LN58"><span class='Ref_to_Struct'>pg_tz</span></a> <span class='Declare_Member'>tz</span><span class='Delimiter'>; 
}; 
</span> 
<span class='Comment_Multi_Line'>/* typedef pg_tzenum is declared in pgtime.h */ 
</span> 
<a href="pgtz.c.html#LN393"><span class='Ref_to_Struct'>pg_tzenum</span></a> <span class='Operator'>* 
</span><a name="LN405"></a><span class='Declare_Function'>pg_tzenumerate_start</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN407"></a>    <a href="pgtz.c.html#LN393"><span class='Ref_to_Struct'>pg_tzenum</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>ret</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pgtz.c.html#LN393"><span class='Ref_to_Struct'>pg_tzenum</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgtz.c.html#LN393"><span class='Ref_to_Struct'>pg_tzenum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><a name="LN408"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>startdir</span> <span class='Operator'>= </span><a href="../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="../bin/initdb/findtimezone.c.html#LN34"><span class='Ref_to_Func'>pg_TZDIR</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
    <a href="pgtz.c.html#LN407"><span class='Ref_To_Local'>ret</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN395"><span class='Ref_to_Member'>baselen</span></a> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="pgtz.c.html#LN408"><span class='Ref_To_Local'>startdir</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="pgtz.c.html#LN407"><span class='Ref_To_Local'>ret</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN396"><span class='Ref_to_Member'>depth</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="pgtz.c.html#LN407"><span class='Ref_To_Local'>ret</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN398"><span class='Ref_to_Member'>dirname</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="pgtz.c.html#LN408"><span class='Ref_To_Local'>startdir</span></a><span class='Delimiter'>; 
</span>    <a href="pgtz.c.html#LN407"><span class='Ref_To_Local'>ret</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN397"><span class='Ref_to_Member'>dirdesc</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../include/storage/fd.h.html#LN91"><span class='Ref_to_Proto'>AllocateDir</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN408"><span class='Ref_To_Local'>startdir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgtz.c.html#LN407"><span class='Ref_To_Local'>ret</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN397"><span class='Ref_to_Member'>dirdesc</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>        <a href="../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open directory \"%s\": %m"</span><span class='Delimiter'>, </span><a href="pgtz.c.html#LN408"><span class='Ref_To_Local'>startdir</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="pgtz.c.html#LN407"><span class='Ref_To_Local'>ret</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>void 
</span><a name="LN422"></a><span class='Declare_Function'>pg_tzenumerate_end</span><span class='Parentheses'>(</span><a href="pgtz.c.html#LN393"><span class='Ref_to_Struct'>pg_tzenum</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>dir</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="pgtz.c.html#LN422"><span class='Ref_to_Parameter'>dir</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN396"><span class='Ref_to_Member'>depth</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../include/storage/fd.h.html#LN93"><span class='Ref_to_Proto'>FreeDir</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN422"><span class='Ref_to_Parameter'>dir</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN397"><span class='Ref_to_Member'>dirdesc</span></a><span class='Delimiter'>[</span><a href="pgtz.c.html#LN422"><span class='Ref_to_Parameter'>dir</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN396"><span class='Ref_to_Member'>depth</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN422"><span class='Ref_to_Parameter'>dir</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN398"><span class='Ref_to_Member'>dirname</span></a><span class='Delimiter'>[</span><a href="pgtz.c.html#LN422"><span class='Ref_to_Parameter'>dir</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN396"><span class='Ref_to_Member'>depth</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pgtz.c.html#LN422"><span class='Ref_to_Parameter'>dir</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN396"><span class='Ref_to_Member'>depth</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN422"><span class='Ref_to_Parameter'>dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<a href="pgtz.h.html#LN58"><span class='Ref_to_Struct'>pg_tz</span></a> <span class='Operator'>* 
</span><a name="LN434"></a><span class='Declare_Function'>pg_tzenumerate_next</span><span class='Parentheses'>(</span><a href="pgtz.c.html#LN393"><span class='Ref_to_Struct'>pg_tzenum</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>dir</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="pgtz.c.html#LN434"><span class='Ref_to_Parameter'>dir</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN396"><span class='Ref_to_Member'>depth</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN438"></a>        <span class='Control'>struct</span> <a href="../include/port/win32_msvc/dirent.h.html#LN8"><span class='Ref_to_Struct'>dirent</span></a> <span class='Operator'>*</span><span class='Declare_Local'>direntry</span><span class='Delimiter'>; 
</span><a name="LN439"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>fullname</span><span class='Delimiter'>[</span><a href="../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a> <span class='Operator'>* </span><span class='Number'>2</span><span class='Delimiter'>]; 
</span><a name="LN440"></a>        <span class='Control'>struct</span> <a href="../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>statbuf</span><span class='Delimiter'>; 
</span> 
        <a href="pgtz.c.html#LN438"><span class='Ref_To_Local'>direntry</span></a> <span class='Operator'>= </span><a href="../include/storage/fd.h.html#LN92"><span class='Ref_to_Proto'>ReadDir</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN434"><span class='Ref_to_Parameter'>dir</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN397"><span class='Ref_to_Member'>dirdesc</span></a><span class='Delimiter'>[</span><a href="pgtz.c.html#LN434"><span class='Ref_to_Parameter'>dir</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN396"><span class='Ref_to_Member'>depth</span></a><span class='Delimiter'>], </span><a href="pgtz.c.html#LN434"><span class='Ref_to_Parameter'>dir</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN398"><span class='Ref_to_Member'>dirname</span></a><span class='Delimiter'>[</span><a href="pgtz.c.html#LN434"><span class='Ref_to_Parameter'>dir</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN396"><span class='Ref_to_Member'>depth</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgtz.c.html#LN438"><span class='Ref_To_Local'>direntry</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* End of this directory */ 
</span>            <a href="../include/storage/fd.h.html#LN93"><span class='Ref_to_Proto'>FreeDir</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN434"><span class='Ref_to_Parameter'>dir</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN397"><span class='Ref_to_Member'>dirdesc</span></a><span class='Delimiter'>[</span><a href="pgtz.c.html#LN434"><span class='Ref_to_Parameter'>dir</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN396"><span class='Ref_to_Member'>depth</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN434"><span class='Ref_to_Parameter'>dir</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN398"><span class='Ref_to_Member'>dirname</span></a><span class='Delimiter'>[</span><a href="pgtz.c.html#LN434"><span class='Ref_to_Parameter'>dir</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN396"><span class='Ref_to_Member'>depth</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pgtz.c.html#LN434"><span class='Ref_to_Parameter'>dir</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN396"><span class='Ref_to_Member'>depth</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgtz.c.html#LN438"><span class='Ref_To_Local'>direntry</span></a><span class='Operator'>-&GT;</span><a href="../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'.'</span><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN439"><span class='Ref_To_Local'>fullname</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgtz.c.html#LN439"><span class='Ref_To_Local'>fullname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/%s"</span><span class='Delimiter'>, 
</span>                 <a href="pgtz.c.html#LN434"><span class='Ref_to_Parameter'>dir</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN398"><span class='Ref_to_Member'>dirname</span></a><span class='Delimiter'>[</span><a href="pgtz.c.html#LN434"><span class='Ref_to_Parameter'>dir</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN396"><span class='Ref_to_Member'>depth</span></a><span class='Delimiter'>], </span><a href="pgtz.c.html#LN438"><span class='Ref_To_Local'>direntry</span></a><span class='Operator'>-&GT;</span><a href="../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN439"><span class='Ref_To_Local'>fullname</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgtz.c.html#LN440"><span class='Ref_To_Local'>statbuf</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not stat \"%s\": %m"</span><span class='Delimiter'>, </span><a href="pgtz.c.html#LN439"><span class='Ref_To_Local'>fullname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../include/port/win32.h.html#LN429"><span class='Ref_to_Macro'>S_ISDIR</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN440"><span class='Ref_To_Local'>statbuf</span></a><span class='Operator'>.</span>st_mode<span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Step into the subdirectory */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgtz.c.html#LN434"><span class='Ref_to_Parameter'>dir</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN396"><span class='Ref_to_Member'>depth</span></a> <span class='Operator'>&GT;= </span><a href="pgtz.c.html#LN391"><span class='Ref_to_Const'>MAX_TZDIR_DEPTH</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>                <a href="../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                     <span class='Parentheses'>(</span><a href="../backend/utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"timezone directory stack overflow"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="pgtz.c.html#LN434"><span class='Ref_to_Parameter'>dir</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN396"><span class='Ref_to_Member'>depth</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <a href="pgtz.c.html#LN434"><span class='Ref_to_Parameter'>dir</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN398"><span class='Ref_to_Member'>dirname</span></a><span class='Delimiter'>[</span><a href="pgtz.c.html#LN434"><span class='Ref_to_Parameter'>dir</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN396"><span class='Ref_to_Member'>depth</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN439"><span class='Ref_To_Local'>fullname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pgtz.c.html#LN434"><span class='Ref_to_Parameter'>dir</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN397"><span class='Ref_to_Member'>dirdesc</span></a><span class='Delimiter'>[</span><a href="pgtz.c.html#LN434"><span class='Ref_to_Parameter'>dir</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN396"><span class='Ref_to_Member'>depth</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../include/storage/fd.h.html#LN91"><span class='Ref_to_Proto'>AllocateDir</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN439"><span class='Ref_To_Local'>fullname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgtz.c.html#LN434"><span class='Ref_to_Parameter'>dir</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN397"><span class='Ref_to_Member'>dirdesc</span></a><span class='Delimiter'>[</span><a href="pgtz.c.html#LN434"><span class='Ref_to_Parameter'>dir</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN396"><span class='Ref_to_Member'>depth</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>                <a href="../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                         <a href="../backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open directory \"%s\": %m"</span><span class='Delimiter'>, 
</span>                                <a href="pgtz.c.html#LN439"><span class='Ref_To_Local'>fullname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Start over reading in the new directory */ 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Load this timezone using tzload() not pg_tzset(), so we don't fill 
         * the cache.  Also, don't ask for the canonical spelling: we already 
         * know it, and pg_open_tzfile's way of finding it out is pretty 
         * inefficient. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgtz.h.html#LN70"><span class='Ref_to_Proto'>tzload</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN439"><span class='Ref_To_Local'>fullname</span></a> <span class='Operator'>+ </span><a href="pgtz.c.html#LN434"><span class='Ref_to_Parameter'>dir</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN395"><span class='Ref_to_Member'>baselen</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgtz.c.html#LN434"><span class='Ref_to_Parameter'>dir</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN399"><span class='Ref_to_Member'>tz</span></a><span class='Operator'>.</span><a href="pgtz.h.html#LN62"><span class='Ref_to_Member'>state</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Zone could not be loaded, ignore it */ 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../include/pgtime.h.html#LN63"><span class='Ref_to_Proto'>pg_tz_acceptable</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgtz.c.html#LN434"><span class='Ref_to_Parameter'>dir</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN399"><span class='Ref_to_Member'>tz</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Ignore leap-second zones */ 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* OK, return the canonical zone name spelling. */ 
</span>        <a href="../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="pgtz.c.html#LN434"><span class='Ref_to_Parameter'>dir</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN399"><span class='Ref_to_Member'>tz</span></a><span class='Operator'>.</span><a href="pgtz.h.html#LN61"><span class='Ref_to_Member'>TZname</span></a><span class='Delimiter'>, </span><a href="pgtz.c.html#LN439"><span class='Ref_To_Local'>fullname</span></a> <span class='Operator'>+ </span><a href="pgtz.c.html#LN434"><span class='Ref_to_Parameter'>dir</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN395"><span class='Ref_to_Member'>baselen</span></a><span class='Delimiter'>, 
</span>                <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgtz.c.html#LN434"><span class='Ref_to_Parameter'>dir</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN399"><span class='Ref_to_Member'>tz</span></a><span class='Operator'>.</span><a href="pgtz.h.html#LN61"><span class='Ref_to_Member'>TZname</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Timezone loaded OK. */ 
</span>        <span class='Control'>return</span> <span class='Operator'>&</span><a href="pgtz.c.html#LN434"><span class='Ref_to_Parameter'>dir</span></a><span class='Operator'>-&GT;</span><a href="pgtz.c.html#LN399"><span class='Ref_to_Member'>tz</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while dir-&GT;depth&GT;=0 &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Nothing more found */ 
</span>    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pg_tzenumerate_next &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>